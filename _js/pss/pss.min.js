//Activate dropdown & tab 
$(".ui.pssdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();
$(".changenego").dropdown({
  selectOnKeydown: false,
});
moment().format();

// Global Variable
const NonceValue = "rdsystem2020";
const ColorOwner = "#00139f";
const ColorSHD = "#3b81ff";
const ColorFinish = "#5d5d5d";
const ColorCancel = "#7c0000";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocpss = decodeURIComponent(getCookie("restlocpss"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Sdecrypt = Ucrypt.decrypt(EncS, NonceValue);
var SHDdecr = Ucrypt.decrypt(EncN, NonceValue);


function TableListFunc(FSearch, FYear, FNama, FJenis, FProgress, FStatus) {
  $("#PSSList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    scrollX     : true,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[1, "desc"]],
    columns: [
      { data: null,
        render: function (data, type, row) {
          if (data['id_pss'] != "") {
            if ( data['pic'] == Udecrypt ) {
              if (data['status_ps'] !== "FINISH" && data['status_ps'] !== "CLOSE") {
                return `<span class="itempam editpssheader clicklink" eid="${data['id_pss']}" edesc="${data['judul_ps']}" data-tooltip="Edit PSS" data-inverted="" data-position="right center"><i class="pencil alternate link editpssheader circular teal icon"></i></span>`;
              } else {
                return `<span data-tooltip="re-Active PSS" data-inverted="" data-position="right center"><i class="counterclockwise rotated share square circular violet link icon reactivepss" eid="${data['id_pss']}" edesc="${data['judul_ps']}"></span>`;
              }
            } else if (data['rnd_bagian'] == Sdecrypt && (data['progress'] == "HEAD OF" || data['progress'] == "DESIGNER")){
              
              // if HEAD OF
              if(SHDdecr){
                if (data['status_ps'] !== "FINISH" && data['status_ps'] !== "CLOSE") {
                  return `<span class="editpssheader clicklink" eid="${data['id_pss']}" edesc="${data['judul_ps']}" data-tooltip="View Detail PSS" data-inverted="" data-position="right center"><i class="pencil alternate link editpssheader teal icon"></i></span>`;
                } else {
                  return "";
                }
              } else {
                return `<span class="editpssheader clicklink" eid="${data['id_pss']}" edesc="${data['judul_ps']}" data-tooltip="View Detail PSS" data-inverted="" data-position="right center"><i class="tasks link circular grey icon "></i></span>`;
              }
            } else {
              return `<span class="editpssheader clicklink" eid="${data['id_pss']}" edesc="${data['judul_ps']}" data-tooltip="View Detail PSS" data-inverted="" data-position="right center"><i class="tasks link circular grey icon "></i></span>`;
            }
          } else {
            return "";
          }
        },
      },
      { data: 'created_date' },
      { data: null,
        render: function (data, type, row) {
          if (data['ps_no']) {
            return data['ps_no'];
          } else {
            return data['draft_no'];
          }
        },
      },
      { data: 'judul_ps' },
      { data: 'jenis_project' },
      { data: 'negosiator' },
      { data: 'pic' },
      { data: 'pic_designer' },
      { data: 'section_head' },
      { data: 'status_ps' },
      { data: null,
        render: function (data, type, row) {
          if (data['status_ps'] == "FINISH" || data['status_ps'] == "CLOSE") {
            return "--";
          } else {
            return data['progress'];
          }
        },
      },
      
    ],
    columnDefs: [
      { className: "center aligned", targets: [0] },
      { orderable: false , targets: [0] },
      { className: "right aligned", targets: [1] },
      { targets: [1],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YYYY');
          } else {
            return '';
          }
        }
      }
    ],

    createdRow: function (row, data, index) {

      //WARNA OWNER & STATUS ACTIVE/DRAFT
      if ((data['pic'] == Udecrypt || data['section_head'] == Udecrypt) &&
          (data['status_ps'] == "ACTIVE" ||
           data['status_ps'] == "DRAFT"  ||
           data['status_ps'] == "REQ-CLOSE" ||
           data['status_ps'] == "REQ-FINISH")) 
      {
        $(row).find("td").css("color", ColorOwner);
      }

      //WARNA SECTIONHEAD
      if ((data['progress'] == "HEAD OF" && data['pic'] == Udecrypt) ||
          (data['progress'] == "HEAD OF" && data['section_head'] == Udecrypt)) 
      {
        $(row).find("td").css("color", ColorSHD);
      }

      //WARNA FINISH & CLOSE
      if (data['status_ps'] == "FINISH" || data['status_ps'] == "CLOSE") {
        $(row).find("td").css("color", ColorFinish);
      }

      //WARNA CANCEL
      if (data['status_ps'] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }
    },

    ajax: {
      url: `${restlocpss}table_pss`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FYear: FYear,
        FNama: FNama,
        FJenis: FJenis,
        FProgress: FProgress,
        FStatus: FStatus,
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    },
  });
}

  //Click Icon Edit -- Edit PSS header
  $("#PSSList").on("click", ".editpssheader", function () {
    var eid = $(this).attr("eid");
    let encryption = new Encryption();
    var eidENC = encryption.encrypt(eid, NonceValue);
    window.location.href = "./?link=pssitem&i=" + eidENC;
  });

  //Click Icon reactive
  $("#PSSList").on("click", ".reactivepss", function () {
    var eid = $(this).attr("eid");
    console.log(eid);
    Swal.fire({
      title: "<h3>Re-Active PSS?</h3>",
      html: "PSS ini sudah Finish dan akan di-AKTIVE-kan kembali..<br><br><sub><i>Setelah Aktive, segera tambahkan ITEM BARU, jika tidak ada penambahan item baru maka PSS ini akan segera berubah menjadi Finish lagi seperti kondisi sebelumnya.</i></sub>",
      icon: "warning",
      confirmButtonText: "Ya",
      cancelButtonColor: "#8b9da4",
      cancelButtonText: "Tidak",
      showCancelButton: true,
      allowEnterKey: false,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpss}reactive_pss`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            idpss: eid,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (isEmpty(obj)) {
              console.log("Gagal Re-activated, data kosong");
            } else if (obj) {
              if (obj.status == false) {
                Swal.fire({
                  text: obj.message,
                  timer: 1500,
                  icon: "warning",
                  showConfirmButton: false,
                });
              } else {
                Swal.fire({
                  text: "PSS berhasil di-ACTIVE-kan lagi.",
                  icon: "success",
                  showConfirmButton: true,
                }).then((result) => {
                  if (result.value) {
                    window.location.href = "./?link=pss";
                  }
                });
              }
            } else {
              Swal.fire("Error", "Data Error ?.", "error");
            }
          },
          error: function () {
            //window.location.href = "./?link=loclogout";
            console.log(
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
            );
          },
        });
      }
    });
  });

$(document).ready(function () {
  //Tab Action Link
  $("#tabregpss").on("click", function () {
    window.location.href = "./?link=pssheader";
  });
  $("#addnewpss").on("click", function () {
    window.location.href = "./?link=pssheader";
  });
  $("#tabihp").on("click", function () {
    window.location.href = "./?link=ihp";
  });
  $("#tabihpeval").on("click", function () {
    window.location.href = "./?link=ihpevaluation";
  });
  $("#tabtabelan").on("click", function () {
    window.location.href = "./?link=an";
  });
  $("#tabchangepic").on("click", function () {
    window.location.href = "./?link=changepic";
  });
  $('.tabuserguide').on('click', function() {
    window.location.href = "./?link=guidepss";
  });
  $('.tabsuratgolive').on('click', function() {
    window.location.href = "./?link=golivepss";
  });
  $('.tabhasilmonitoring').on('click', function() {
    window.location.href = "./?link=monitorpss";
  });
  $('.tabversion').on('click', function() {
    window.location.href = "./?link=versionhistory&app=PSS";
  });
  $("#tabpssreport").on("click", function () {
    window.location.href = "./?link=reportingpss";
  });
  //Download xls base on filter
  $("#dwnldxls").on("click", function () {
    var iddownload= "PSSDESIGNER";
    var search   	= $('#filtercari').val();
    var thnfilter = $('#filtertahun').val();
    var picfilter = $('#filtermine').val();
    var prjfilter = $('#filterjenis').val();
    var prgfilter = $('#filterprogress').val();
    var stsfilter = $('#filterstatus').val();

    $.redirect(
      "./?link=pssdwnldxls",
      { 
        id: iddownload,
        search: search, 
        thnfilter: thnfilter,
        picfilter: picfilter,
        prjfilter: prjfilter,
        prgfilter: prgfilter,
        stsfilter: stsfilter
      },
      "POST",
      "_blank"
    );
  });
});

// Open Modal Change PIC
$('#PSSList').on("click", ".nego-note", function() {
  $('.ui.dropdown.fullsearch').dropdown( {fullTextSearch:'exact', sortSelect: true, match:'text'} );
  var eid = $(this).attr("eid")
  $('.ui.modal').modal('show');
  ChangePIC(eid);



})


function ChangePIC(idpssnotice) {

  // Save Negosiator Note
  $("#savenote").on("click", function() {
    var changepic = $("#changepic").val()
    console.log(changepic);
    $.ajax({
      url: `${restlocpss}change_picdesg`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        id_pss: idpssnotice,
        pic : changepic
      },
      success: function (rsp) {
        var obj = JSON.parse(rsp);
        // console.log(obj);
            if (isEmpty(obj)) {
              console.log("Data Kosong");
            } else if (obj) {
              if (obj.status == false) {
                Swal.fire({
                  text: obj.message,
                  timer: 1500,
                  icon: "warning",
                  showConfirmButton: false,
                });
              } else {
                Swal.fire({
                  text: "Berhasil ganti PIC PSS.",
                  icon: "success",
                  showConfirmButton: true,
                }).then((result) => {
                  if (result.value) {
                    $('.ui.modal').modal('hide');
                    location.reload();
                  }
                });
              }
            } else {
              Swal.fire("Error", "Data Error ?.", "error");
            }
        
        
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    })
  })
}



//Function untuk copy ke clipboard
function copyToClipboard(element) {
  var $temp = $("<input>");
  $("body").append($temp);
  $temp.val($(element).text()).select();
  document.execCommand("copy");
  $temp.remove();
  console.log("copied");
  Swal.fire({
    text: "Item yang anda maksud sudah tersalin di clipboard",
    timer: 1500,
    position: "bottom-left",
    toast: true,
    showConfirmButton: false,
  });
}

//Read Filter Cookies
var d = new Date();
var yearnow = d.getFullYear();
var sfilter = getCookie("sfilpss");
var tfilter = getCookie("tfilpss");
var mfilter = getCookie("mfilpss");
var jfilter = getCookie("jfilpss");
var pfilter = getCookie("pfilpss");
var stfilter = getCookie("stfilpss");
if (sfilter) {
  $("#filtercari").val(sfilter);
  var sfilterstart = sfilter;
} else {
  setCookie("sfilpss", "", 5);
  var sfilterstart = "";
}
if (tfilter) {
  $("#filtertahun").dropdown("set selected", tfilter);
  var tfilterstart = tfilter;
} else {
  setCookie("tfilpss", yearnow, 5);
  var tfilterstart = yearnow;
}
if (mfilter) {
  $("#filtermine").dropdown("set selected", mfilter);
  var mfilterstart = mfilter;
} else {
  setCookie("mfilpss", "ALL", 5);
  var mfilterstart = "ALL";
}
if (jfilter) {
  $("#filterjenis").dropdown("set selected", jfilter);
  var jfilterstart = jfilter;
} else {
  setCookie("jfilpss", "ALL", 5);
  var jfilterstart = "ALL";
}
if (pfilter) {
  $("#filterprogress").dropdown("set selected", pfilter);
  var pfilterstart = pfilter;
} else {
  setCookie("pfilpss", "ALL", 5);
  var pfilterstart = "ALL";
}
if (stfilter) {
  $("#filterstatus").dropdown("set selected", stfilter);
  var stfilterstart = stfilter;
} else {
  setCookie("stfilpss", "ALL", 5);
  var stfilterstart = "ALL";
}
//Load Table
TableListFunc(
  sfilterstart,
  tfilterstart,
  mfilterstart,
  jfilterstart,
  pfilterstart,
  stfilterstart
);

//Showing input filter when !All
if (jfilter !== "ALL" || pfilter !== "ALL" || stfilter !== "ALL") {
  $(".morefilter").show();
  $(".morefiltertd").show();
} else {
  $(".morefilter").hide();
  $(".morefiltertd").hide();
}

//Toggle More Filter
$("#morefilter").on("click", function () {
  $(".morefilter").toggle(100);
  $(".morefiltertd").toggle();
});

//RESPON KETIKA INPUT PENCARIAN DI KETIK
$("#filtercari").on("keyup", function () {
  var FilterCari = $("#filtercari").val();
  var FilterTahun = $("#filtertahun").val();
  var FilterNama = $("#filtermine").val();
  var FilterJenis = $("#filterjenis").val();
  var FilterProgress = $("#filterprogress").val();
  var FilterStatus = $("#filterstatus").val();
  setCookie("sfilpss", FilterCari, 5);
  setCookie("tfilpss", FilterTahun, 5);
  setCookie("mfilpss", FilterNama, 5);
  setCookie("jfilpss", FilterJenis, 5);
  setCookie("pfilpss", FilterProgress, 5);
  setCookie("stfilpss", FilterStatus, 5);
  $("#PSSList").DataTable().destroy();
  TableListFunc(
    FilterCari,
    FilterTahun,
    FilterNama,
    FilterJenis,
    FilterProgress,
    FilterStatus
  );
});

//RESPON KETIKA FILTER TAHUN DI RUBAH
$("#filtertahun, #filterjenis, #filtermine, #filterprogress, #filterstatus").on(
  "change",
  function () {
    var FilterCari = $("#filtercari").val();
    var FilterTahun = $("#filtertahun").val();
    var FilterNama = $("#filtermine").val();
    var FilterJenis = $("#filterjenis").val();
    var FilterProgress = $("#filterprogress").val();
    var FilterStatus = $("#filterstatus").val();
    setCookie("sfilpss", FilterCari, 5);
    setCookie("tfilpss", FilterTahun, 5);
    setCookie("mfilpss", FilterNama, 5);
    setCookie("jfilpss", FilterJenis, 5);
    setCookie("pfilpss", FilterProgress, 5);
    setCookie("stfilpss", FilterStatus, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc(
      FilterCari,
      FilterTahun,
      FilterNama,
      FilterJenis,
      FilterProgress,
      FilterStatus
    );
  }
);

//RESET FILTER
$(".resetfilter").on("click", function () {
  var d = new Date();
  var yearnow = d.getFullYear();
  $("#filtercari").val("");
  $("#filtertahun").dropdown("set selected", yearnow);
  $("#filtermine").dropdown("set selected", "ALL");
  $("#filterjenis").dropdown("set selected", "ALL");
  $("#filterprogress").dropdown("set selected", "ALL");
  $("#filterstatus").dropdown("set selected", "ALL");
  setCookie("sfilpss", "", 5);
  setCookie("tfilpss", yearnow, 5);
  setCookie("mfilpss", "ALL", 5);
  setCookie("jfilpss", "ALL", 5);
  setCookie("pfilpss", "ALL", 5);
  setCookie("stfilpss", "ALL", 5);
  $("#PSSList").DataTable().destroy();
  TableListFunc("", yearnow, "ALL", "ALL", "ALL", "ALL");
  $(".morefilter").hide();
  $(".morefiltertd").hide();
});

