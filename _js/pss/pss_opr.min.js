//Activate dropdown & tab
$(".ui.pssdropdown").dropdown(); 
$(".ui.dropdown").dropdown();
$(".menu .item").tab();
$(".changenego").dropdown({
  selectOnKeydown: false,
});
moment().format(); 

// Global Variable for Header Authorization
const NonceValue = "rdsystem2020";
const ColorOwner = "#00139f";
//const ColorActivity = '#7d7d7d';
const ColorActivity = "#555";
const ColorFinish = "#5d5d5d";
const ColorCancel = "#7c0000";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocpssopr = decodeURIComponent(getCookie("restlocpssopr"));
var restlocpssihp = decodeURIComponent(getCookie("restlocpssihp"));
var restlocemail  = decodeURIComponent(getCookie("restlocemail"));


let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);

function TableListFunc(FSearch, FYear, FNama, FOperator, FProgress, FStatus) {
  $("#PSSList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "5",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(5).draw();
        },
      },
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    scrollX     : true,
    pageLength: 5,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[11, "desc"]],
    columns: [
      {
        data: null,
        render: function (data) {
          // return `<i class="tasks circular detailpss link teal icon" idpss="${data['id_pss']}" iditem="${data['id_item']}">`;
          return `<span class="detailpss" idpss="${data['id_pss']}" iditem="${data['id_item']}" data-tooltip="View Detail IHP" data-inverted="" data-position="right center"><i class="tasks link circular grey icon "></i></span>`;
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          if (data['no_ihp'] != "") {
            if (data['operator'] == Udecrypt) {
              // return `<i class="edit outline circular editpss link teal icon" pssid="${data['id_pss']}" iditem="${data['id_item']}" stsitem="${data['status_item']}">`;

              return `<span class="editpss" pssid="${data['id_pss']}" iditem="${data['id_item']}" stsitem="${data['status_item']}" data-tooltip="Edit IHP" data-inverted="" data-position="right center"><i class="edit outline link circular teal icon "></i></span>`;
            } else {
              return "";
            }
          } else {
            return "";
          }
        },
      },
      { data: 'description_item' },
      { data: 'vendor_material_number' },
      { data: 'vendor' },
      {
        data: null,
        render: function (data, type, row) {
          if (data['product'] == "HOME APPLIANCES") {
            return `HA`;
          } else if (data['product'] == "AUDIO") {
            return `AUD`;
          } else if (data['product'] == "VIDEO") {
            return `VID`;
          } else if (data['product'] == "SPECIAL PRODUCT") {
            return `SPP`;
          } else {
            return `${data['product']}`;
          }
        },
      },
      { data: 'chasis' },
      { data: 'note' },
      { data: 'tahap' },
      { data: 'req_pinbl' },
      { data: 'designer' },
      { data: 'negosiator' },
      { data: 'operator' },
      { data: 'no_ihp' },
      { data: 'tanggal_ihp' },
      { data: 'final_result' },
      { data: 'status_item' },
      { data: 'progress' },
      
    ],
    columnDefs: [
      { className: "center aligned", targets: [0, 1, 5, 6, 8, 9] },
      { targets: [0, 1], orderable: false },
      { targets: [14],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YYYY');
          } else {
            return '';
          }
        }
      }
    ],

    createdRow: function (row, data, index) {
     

      //WARNA IHP
      if (
        (data['progress'] == "IHP" && data['operator'] == Udecrypt) ||
        (data['progress'] == "IHP KEMBALI" && data['operator'] == Udecrypt)
      ) {
        $(row).find("td").css("color", ColorOwner);
      }

      //WARNA ON ACTIVITY
      // if (
      //   data['progress'] == "PLACE-IN" ||
      //   data['progress'] == "DESIGNER" ||
      //   data['progress'] == "REQ-APPROVAL" ||
      //   data['progress'] == "APPROVED"
      // ) {
      //   $(row).find("td").css("color", ColorActivity);
      // }

      //WARNA FINISH & CLOSE
      if (data['status_item'] == "FINISH" || data['status_item'] == "CLOSE") {
        $(row).find("td").css("color", ColorFinish);
      }

      //WARNA CANCEL
      if (data['status_item'] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }
    },

    ajax: {
      url: `${restlocpssopr}table_operator`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FYear: FYear,
        FNama: FNama,
        FOperator: FOperator,
        FProgress: FProgress,
        FStatus: FStatus,
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    },
  });
}



function TableListFunc_G(FSearch) {
  $("#PSSList_G").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "5",
        action: function (e, dt, node, config) {
          $("#PSSList_G").DataTable().page.len(5).draw();
        },
      },
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#PSSList_G").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#PSSList_G").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#PSSList_G").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#PSSList_G").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#PSSList_G").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    // scrollX     : true,
    pageLength: 5,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[1, "desc"]],
    columns: [
      {
        data: null,
        render: function (data) {
          return `<span class="editgroupihp" grpid="${data['id_grupopr']}" grpdec="${data['desc_group']}" grpnoihp="${data['no_ihp']}" gprnote="${data['note_group']}" data-tooltip="Edit group IHP" data-inverted="" data-position="top left"><i class="edit outline link circular teal icon "></i></span>`;
        },
      },
      { data: 'desc_group' },
      {
        data: null,
        render: function (data) {
          return `<span class="editvalueihp" grpida="${data['id_grupopr']}" grpdeca="${data['desc_group']}" grpnoihpa="${data['no_ihp']}" data-tooltip="Edit Value IHP" data-inverted="" data-position="top left"><i class="pencil link circular blue icon "></i></span>`;
        },
      },
      // { data: 'no_ihp' },
      { data  : 'no_ihp',
          render: function ( data, type, row ) {
            if (data){
              return data.replace(/\;/g, ",<br>");
            } else {
              return '';
            }
          }
      },
      { data: 'note_group' },
     
      
    ],
    columnDefs: [
      // { className: "center aligned", targets: [0, 1, 5, 6, 8, 9] },
      { targets: [0, 2], orderable: false },
      // { targets: [14],
      //   render: function (data, type, row) {
      //     var dateObj = new Date(data);
      //     var momentObj = moment(dateObj);
      //     if (data){
      //       return momentObj.format('ddd, DD MMM YYYY');
      //     } else {
      //       return '';
      //     }
      //   }
      // }
    ],

    // createdRow: function (row, data, index) {
     

    //   //WARNA IHP
    //   if (
    //     (data['progress'] == "IHP" && data['operator'] == Udecrypt) ||
    //     (data['progress'] == "IHP KEMBALI" && data['operator'] == Udecrypt)
    //   ) {
    //     $(row).find("td").css("color", ColorOwner);
    //   }

      
    //   //WARNA FINISH & CLOSE
    //   if (data['status_item'] == "FINISH" || data['status_item'] == "CLOSE") {
    //     $(row).find("td").css("color", ColorFinish);
    //   }

    //   //WARNA CANCEL
    //   if (data['status_item'] == "CANCEL") {
    //     $(row).find("td").css("color", ColorCancel);
    //   }
    // },

    ajax: {
      url: `${restlocpssopr}table_groupopr`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FNama: vusrnm,
      },
      error: function () {
        // window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    },
  });
}

//Click Icon Edit item IHP
$("#PSSList").on("click", ".editpss", function () {
  var pssid = $(this).attr("pssid");
  var iditem = $(this).attr("iditem");
  var stsitem = $(this).attr("stsitem");
  $("#OprUpload").val("");

  //vendor autocomplete
  $(".ui.search.vendor").search({
    minCharacters: 1,
    apiSettings: {
      url: "2_psonline/_autocompleteDNSN.php?q={query}",
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
  });

  $(".ui.search.vendorname").search({
    minCharacters: 1,
    apiSettings: {
      url: "2_psonline/_autocompletevendorname.php?q={query}",
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
  });

  $(".ui.search.manufacture").search({
    minCharacters: 1,
    apiSettings: {
      url: "2_psonline/_autocompletemanufacture.php?q={query}",
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
  });

  $.ajax({
    type: "POST",
    url: `${restlocpssopr}load_itemihpev`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: { iditem: iditem, idpss: pssid },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);

      if (!obj["read_item"][0]["no_ihp"]) {
        $("#OprLabelMat").addClass("disabled");
        $("#OprLabelAcc").addClass("disabled");
      } else {
        $("#OprLabelMat").removeClass("disabled");
        $("#OprLabelAcc").removeClass("disabled");
      }

      if (!obj["read_item"][0]["vendor"] || obj["read_item"][0]["no_ihp"] || !obj["read_item"][0]["tanggal_ihp_kembali"]) {
        $("#OprCreateIHP").addClass("disabled");
      } else {
        $("#OprCreateIHP").removeClass("disabled");
      }

      if (obj["read_item"][0]["file_upload"] == null) {
        var file = "<i>Belum ada spec yang diupload</i>";
      } else {
        var file =
          '<a target="_blank" href="./?link=filespecpss&f=' +
          obj["read_item"][0]["file_upload"] +
          '">' +
          obj["read_item"][0]["file_upload"] +
          "</a>";
      }



              jmlData = obj["read_spec"].length;
                $("#SpecList").empty();
                for (a = 0; a < jmlData; a++) {
                  b = a + 1;
                  if (jmlData == b ) {
                    var icon = "<span class='iconedit' id='delfilespec' iid='"+obj["read_spec"][a]["id_upload"]+"'><i class='trash red icon'></i></span>";
                  } else {
                    var icon = "";
                  }
                    var filelink = "<a target='_blank' href='../RND_Upload/SpecOperator/"+obj["read_spec"][a]["file"]+"'>";
                    var namafile = "File Spec "+b;

                    if (obj["read_spec"][a]["note_spec"] == "" || obj["read_spec"][a]["note_spec"]==null){
                      var note ="";
                    } else {
                      var note = obj["read_spec"][a]["note_spec"];
                    }
                  $("#FileSpecList").find("tbody").append(
                    "<tr>"+
                      "<td class='center uploadihp'>"+moment(obj["read_spec"][a]["created_date"]).format('ddd, DD MMM YYYY')+"</td>"+
                      "<td class='center uploadihp'>"+filelink+namafile+"</a>"+"</td>"+
                      "<td class='center uploadihp'>"+note+"</td>"+
                      "<td class='center uploadihp'>"+icon+"</td>"+
                    "</tr>"
                  );
                }

                // $("#FileSpecList").find("tbody").append(
                //   "<tr>"+
                //     "<td colspan='4'>&nbsp;</td>"+
                //   "</tr>"
                // );

                $("#delfilespec").on("click", function () {
                  var id = $(this).attr("iid");
                  Swal.fire({
                    title: "<h3>Delete File Spec ?</h3>",
                    text: "Ketika berhasil hapus maka file tidak bisa dipulihkan lagi.",
                    icon: "warning",
                    confirmButtonText: "Ya",
                    showCancelButton: true,
                  }).then((result) => {
                    if (result.value) {
                      $.ajax({
                        type: "POST",
                        url: `${restlocpssopr}delete_spec`,
                        headers: {
                          user: vusrnm,
                          token: vtoken,
                        },
                        data: {
                          id: id,
                        },
                        cache: false,
                        success: function (response) {
                          var obj = JSON.parse(response);
                          if (obj.status == false) {
                            Swal.fire(
                              "Error",
                              "Ada kendal di koneksi/database, data tidak tersimpan !",
                              "error"
                            );
                          } else {
                            Swal.fire({
                              text: "Deleted",
                              timer: 2000,
                              toast: true,
                              showConfirmButton: false,
                            });
                            //reload table 
                            $(".windoweditihp").modal("hide");
                          }
                        },
                        error: function () {
                          window.location.href = "./?link=loclogout";
                          Swal.fire(
                            "Error",
                            "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
                            "error"
                          );
                        },
                      });
                    }
                  });
                });

      if (obj["read_item"][0]["no_ihp"]) {
        if (obj["read_item"][0]["progress_item"] == "IHP") {
          // if (
          //   (obj["read_item"][0]["req_pinbl"] == "BL" &&
          //     obj["read_item"][0]["status_pin"] == "APPROVED") ||
          //   obj["read_item"][0]["req_pinbl"] !== "BL"
          // ) {
            $("#OprSendDesg").removeClass("basic red disabled");
            $("#OprSendDesg").html(
              '<i class="paper plane icon"></i>Send to Designer'
            );
          // } else {
          //   $("#OprSendDesg").addClass("basic red disabled");
          //   $("#OprSendDesg").html(
          //     '<i class="stop icon"></i>Wait PIN BL Approval'
          //   );
          // }
        } else {
          $("#OprSendDesg").removeClass("basic red");
          $("#OprSendDesg").addClass("disabled");
          $("#OprSendDesg").html('<i class="paper plane icon"></i>Sent');
        }
      } else {
        $("#OprSendDesg").removeClass("basic red");
        $("#OprSendDesg").addClass("disabled");
        $("#OprSendDesg").html(
          '<i class="paper plane icon"></i>Send to Designer'
        );
      }
      if (isEmpty(obj["read_item"])) {
        console.log("Gagal load tabel, data kosong");
      } else if (obj["read_item"]) {
        if (obj.status == false) {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data gagal diload !",
            "error"
          );
        } else {
          //console.log(obj["read_item"])
          if (
            obj["read_item"][0]["progress_item"] == "IHP KEMBALI" &&
            obj["read_item"][0]["progress_item"] !== "MSC OPR"
          ) {
            $(".IHPKembaliArea").show();
            $(".IHPFinalNoteArea").hide();
          } else if (
            obj["read_item"][0]["progress_item"] !== "IHP KEMBALI" &&
            obj["read_item"][0]["progress_item"] == "MSC OPR"
          ) {
            $(".IHPKembaliArea").hide();
            $(".IHPFinalNoteArea").show();
          } else {
            $(".IHPFinalNoteArea").hide();
            $(".IHPKembaliArea").hide();
          }

          if(obj["read_item"][0]["link"] && obj["read_item"][0]["link"]!==""){
            var ldoc = obj["read_item"][0]["link"].length > 40
                ? obj["read_item"][0]["link"].substring(0, 40) + "..."
                :  obj["read_item"][0]["link"];
            var linkdoc = "link : <a target='_blank' href='"+obj["read_item"][0]["link"]+"'>"+ldoc+"</a>";
          } else {
            var linkdoc = "link : - -";
          }

          if(obj["read_item"][0]["file_drawing"] && obj["read_item"][0]["file_drawing"]!==""){
            
            
            var fname = obj["read_item"][0]["file_drawing"].split('_');
            var filen = fname[2];
            var fdoc = filen.length > 40 ? filen.substring(0, 40) + "..." :  filen;
            var filedoc = "file : <a target='_blank' href='../RND_Upload/"+obj["read_item"][0]["file_drawing"]+"'>"+fdoc+"</a>";
          } else {
            var filedoc = "file : - -";
          }

          $(".windoweditihp").modal("show");
          $("#OprNoIHP").text(obj["read_item"][0]["no_ihp"]);
          $("#OprDateIHP").html(DateIHPEval(obj["read_item"][0]["tanggal_ihp"]));
          $("#OprNoPSS").text(obj["read_item"][0]["ps_no"]);
          $("#OprChassis").text(obj["read_item"][0]["chasis"]);
          $("#OprType").text(obj["read_item"][0]["type"]);
          $("#OprNegoName").text(obj["read_item"][0]["negosiator"]);
          $("#OprCategory").text(obj["read_item"][0]["jenis_project"]);
          $("#OprDesgName").text(obj["read_item"][0]["designer"]);
          $("#OprDescription").val(obj["read_item"][0]["description_item"]);
          $("#OprPartNum").val(obj["read_item"][0]["vendor_material_number"]);
          $("#OprVendorName").val(obj["read_item"][0]["vendor"]);
          $("#OprManufacture").val(obj["read_item"][0]["manufacture"]);
          $("#OprNoGudang").val(obj["read_item"][0]["no_gudang"]);
          $("#OprQtySample").val(obj["read_item"][0]["qty_confirm"]);
          $("#OprVendorInHouse").val(obj["read_item"][0]["pic_vendor_inhouse"]);
          $("#OprPlant").val(obj["read_item"][0]["plant"]);
          $("#OprSLOC").val(obj["read_item"][0]["sloc"]);
          $("#OprBaseUnit").val(obj["read_item"][0]["base_unit"]);
          $("#OprFinalNote").val(obj["read_item"][0]["note_ihpkembali"]);

          $("#OprPINBL").text(obj["read_item"][0]["req_pinbl"]);
          $("#OprTargetPIN").html(DateIHPEval(obj["read_item"][0]["target_pin"]));
          $("#OprPINPeluasan").html(DateIHPEval(obj["read_item"][0]["target_pelunasan"]));


          $("#OprDrawingLink").html(linkdoc);
          $("#OprDrawingFile").html(filedoc);


          $("#OprTahap").dropdown("set selected", obj["read_item"][0]["tahap"]);
          $("#OprNote").val(obj["read_item"][0]["note_ihp"]);
          $("#OprIHPKembali").val(obj["read_item"][0]["tanggal_ihp_kembali"]);
          $("#FinalResult").text(obj["read_item"][0]["final_result"]);

          $("#OprIdPSS").val(pssid);
          $("#OprIdItem").val(iditem);
          $("#OprStatus").val(stsitem);
          $("#filespec").html(file);
          DatePicker("#CalIHPkembali");

          var stsel = obj["read_ihpev"][0]["status_electronic"];
          var stscy = obj["read_ihpev"][0]["status_cycle"];
          var stsme = obj["read_ihpev"][0]["status_mechanic"];
          var stsid = obj["read_ihpev"][0]["status_ind"];
          var stsso = obj["read_ihpev"][0]["status_software"];
          var stspc = obj["read_ihpev"][0]["status_pcb"];
          var stsmq = obj["read_ihpev"][0]["status_mqa"];
          var stsdq = obj["read_ihpev"][0]["status_dqa"];
          var stsat = obj["read_ihpev"][0]["status_autrans"];
          var stsot = obj["read_ihpev"][0]["status_others"];
          var stso1 = obj["read_ihpev"][0]["status_others1"];
          var stso2 = obj["read_ihpev"][0]["status_others2"];

          var docel = obj["read_ihpev"][0]["acuan_electronic"];
          var doccy = obj["read_ihpev"][0]["acuan_cycle"];
          var docme = obj["read_ihpev"][0]["acuan_mechanic"];
          var docid = obj["read_ihpev"][0]["acuan_ind"];
          var docso = obj["read_ihpev"][0]["acuan_software"];
          var docpc = obj["read_ihpev"][0]["acuan_pcb"];
          var docmq = obj["read_ihpev"][0]["acuan_mqa"];
          var docdq = obj["read_ihpev"][0]["acuan_dqa"];
          var docat = obj["read_ihpev"][0]["acuan_autrans"];
          var docot = obj["read_ihpev"][0]["acuan_others"];
          var doco1 = obj["read_ihpev"][0]["acuan_others1"];
          var doco2 = obj["read_ihpev"][0]["acuan_others2"];

          var lnkel = obj["read_ihpev"][0]["link_electronic"];
          var lnkcy = obj["read_ihpev"][0]["link_cycle"];
          var lnkme = obj["read_ihpev"][0]["link_mechanic"];
          var lnkid = obj["read_ihpev"][0]["link_ind"];
          var lnkso = obj["read_ihpev"][0]["link_software"];
          var lnkpc = obj["read_ihpev"][0]["link_pcb"];
          var lnkmq = obj["read_ihpev"][0]["link_mqa"];
          var lnkdq = obj["read_ihpev"][0]["link_dqa"];
          var lnkat = obj["read_ihpev"][0]["link_autrans"];
          var lnkot = obj["read_ihpev"][0]["link_others"];
          var lnko1 = obj["read_ihpev"][0]["link_others1"];
          var lnko2 = obj["read_ihpev"][0]["link_others2"];

          var picel = obj["read_ihpev"][0]["pic_confirm_electronic"];
          var piccy = obj["read_ihpev"][0]["pic_confirm_cycle"];
          var picme = obj["read_ihpev"][0]["pic_confirm_mechanic"];
          var picid = obj["read_ihpev"][0]["pic_confirm_ind"];
          var picso = obj["read_ihpev"][0]["pic_confirm_software"];
          var picpc = obj["read_ihpev"][0]["pic_confirm_pcb"];
          var picmq = obj["read_ihpev"][0]["pic_confirm_mqa"];
          var picdq = obj["read_ihpev"][0]["pic_confirm_dqa"];
          var picat = obj["read_ihpev"][0]["pic_confirm_autrans"];
          var picot = obj["read_ihpev"][0]["pic_confirm_others"];
          var pico1 = obj["read_ihpev"][0]["pic_confirm_others1"];
          var pico2 = obj["read_ihpev"][0]["pic_confirm_others2"];

          // if (lnkel) {
          //   var linkel =
          //     '<a target="_blank" href="' + lnkel + '">' + docel + "</a>";
          // } else {
          //   var linkel = lnkel;
          // }
          // if (lnkcy) {
          //   var linkcy =
          //     '<a target="_blank" href="' + lnkcy + '">' + doccy + "</a>";
          // } else {
          //   var linkcy = lnkcy;
          // }
          // if (lnkme) {
          //   var linkme =
          //     '<a target="_blank" href="' + lnkme + '">' + docme + "</a>";
          // } else {
          //   var linkme = lnkme;
          // }
          // if (lnkid) {
          //   var linkid =
          //     '<a target="_blank" href="' + lnkid + '">' + docid + "</a>";
          // } else {
          //   var linkid = lnkid;
          // }
          // if (lnkso) {
          //   var linkso =
          //     '<a target="_blank" href="' + lnkso + '">' + docso + "</a>";
          // } else {
          //   var linkso = lnkso;
          // }
          // if (lnkpc) {
          //   var linkpc =
          //     '<a target="_blank" href="' + lnkpc + '">' + docpc + "</a>";
          // } else {
          //   var linkpc = lnkpc;
          // }
          // if (lnkmq) {
          //   var linkmq =
          //     '<a target="_blank" href="' + lnkmq + '">' + docmq + "</a>";
          // } else {
          //   var linkmq = lnkmq;
          // }
          // if (lnkdq) {
          //   var linkdq =
          //     '<a target="_blank" href="' + lnkdq + '">' + docdq + "</a>";
          // } else {
          //   var linkdq = lnkdq;
          // }
          // if (lnkat) {
          //   var linkat =
          //     '<a target="_blank" href="' + lnkat + '">' + docat + "</a>";
          // } else {
          //   var linkat = lnkat;
          // }
          // if (lnkot) {
          //   var linkot =
          //     '<a target="_blank" href="' + lnkot + '">' + docot + "</a>";
          // } else {
          //   var linkot = lnkot;
          // }
          // if (lnko1) {
          //   var linko1 =
          //     '<a target="_blank" href="' + lnko1 + '">' + doco1 + "</a>";
          // } else {
          //   var linko1 = lnko1;
          // }
          // if (lnko2) {
          //   var linko2 =
          //     '<a target="_blank" href="' + lnko2 + '">' + doco2 + "</a>";
          // } else {
          //   var linko2 = lnko2;
          // }

          if (lnkel && lnkel!==null) {
            if(!docel){ var docel = "Dokumen Electronic"; }
            var linkel =
              '<a target="_blank" href="../RND_Upload/' + lnkel + '">' + ShortText(docel) + "</a>";
          } else {
            var linkel = ShortText(docel);
          }

          if (lnkcy) {
            if(!doccy){ var doccy = "Dokumen Energy Conversion"; }
            var linkcy =
              '<a target="_blank" href="../RND_Upload/' + lnkcy + '">' + ShortText(doccy) + "</a>";
          } else {
            var linkcy = ShortText(doccy);
          }
          if (lnkme) {
            if(!docme){ var docme = "Dokumen Mechanic"; }
            var linkme =
              '<a target="_blank" href="../RND_Upload/' + lnkme + '">' + ShortText(docme) + "</a>";
          } else {
            var linkme = ShortText(docme);
          }
          if (lnkid) {
            if(!docid){ var docid = "Dokumen Industrial Design"; }
            var linkid =
              '<a target="_blank" href="../RND_Upload/' + lnkid + '">' + ShortText(docid) + "</a>";
          } else {
            var linkid = ShortText(docid);
          }
          if (lnkso) {
            if(!docso){ var docso = "Dokumen Software"; }
            var linkso =
              '<a target="_blank" href="../RND_Upload/' + lnkso + '">' + ShortText(docso) + "</a>";
          } else {
            var linkso = ShortText(docso);
          }
          if (lnkpc) {
            if(!docpc){ var docpc = "Dokumen PCB"; }
            var linkpc =
              '<a target="_blank" href="../RND_Upload/' + lnkpc + '">' + ShortText(docpc) + "</a>";
          } else {
            var linkpc = ShortText(docpc);
          }
          if (lnkmq) {
            if(!docmq){ var docmq = "Dokumen MQA"; }
            var linkmq =
              '<a target="_blank" href="../RND_Upload/' + lnkmq + '">' + ShortText(docmq) + "</a>";
          } else {
            var linkmq = ShortText(docmq);
          }
          if (lnkdq) {
            if(!docdq){ var docdq = "Dokumen DQA"; }
            var linkdq =
              '<a target="_blank" href="../RND_Upload/' + lnkdq + '">' + ShortText(docdq) + "</a>";
          } else {
            var linkdq = ShortText(docdq);
          }
          if (lnkat) {
            if(!docat){ var docat = "Dokumen Autrans"; }
            var linkat =
              '<a target="_blank" href="../RND_Upload/' + lnkat + '">' + ShortText(docat) + "</a>";
          } else {
            var linkat = ShortText(docat);
          }
          if (lnkot) {
            if(!docot){ var docot = "Dokumen Others"; }
            var linkot =
              '<a target="_blank" href="../RND_Upload/' + lnkot + '">' + ShortText(docot) + "</a>";
          } else {
            var linkot = ShortText(docot);
          }
          if (lnko1) {
            if(!doco1){ var doco1 = "Dokumen Others 1"; }
            var linko1 =
              '<a target="_blank" href="../RND_Upload/' + lnko1 + '">' + ShortText(doco1) + "</a>";
          } else {
            var linko1 = ShortText(doco1);
          }
          if (lnko2) {
            if(!doco2){ var doco2 = "Dokumen Others 2"; }
            var linko2 =
              '<a target="_blank" href="../RND_Upload/' + lnko2 + '">' + ShortText(doco2) + "</a>";
          } else {
            var linko2 = ShortText(doco2);
          }

          $("#ElectResult").text(stsel);
          $("#HAResult").text(stscy);
          $("#MechResult").text(stsme);
          $("#IDeResult").text(stsid);
          $("#SoftResult").text(stsso);
          $("#PCBResult").text(stspc);
          $("#MQAResult").text(stsmq);
          $("#DQAResult").text(stsdq);
          $("#AuTResult").text(stsat);
          $("#OthResult").text(stsot);
          $("#Oth1Result").text(stso1);
          $("#Oth2Result").text(stso2);

          $("#ElectReff").html(linkel);
          $("#HAReff").html(linkcy);
          $("#MechReff").html(linkme);
          $("#IDReff").html(linkid);
          $("#SoftReff").html(linkso);
          $("#PCBReff").html(linkpc);
          $("#MQAReff").html(linkmq);
          $("#DQAReff").html(linkdq);
          $("#AuTReff").html(linkat);
          $("#OthReff").html(linkot);
          $("#Oth1Reff").html(linko1);
          $("#Oth2Reff").html(linko2);

          $("#ElectPIC").text(picel);
          $("#HAPIC").text(piccy);
          $("#MechPIC").text(picme);
          $("#IDePIC").text(picid);
          $("#SoftPIC").text(picso);
          $("#PCBPIC").text(picpc);
          $("#MQAPIC").text(picmq);
          $("#DQAPIC").text(picdq);
          $("#AuTPIC").text(picat);
          $("#OthPIC").text(picot);
          $("#Oth1PIC").text(pico1);
          $("#Oth2PIC").text(pico2);

          if (
            stsitem == "FINISH" ||
            stsitem == "CLOSE" ||
            stsitem == "CANCEL"
          ) {
            $("#tdOprTahap").addClass("disabled");
            $("#OprDescription").attr("disabled", true);
            $("#OprDescription").removeClass("mandatoryclass");
            $("#OprPartNum").attr("disabled", true);
            $("#OprVendorName").attr("disabled", true);
            $("#OprVendorName").removeClass("mandatoryclass");
            $("#OprManufacture").attr("disabled", true);
            $("#OprManufacture").removeClass("mandatoryclass");
            $("#OprVendorInHouse").attr("disabled", true);
            $("#OprQtySample").attr("disabled", true);
            $("#OprNoGudang").attr("disabled", true);
            $("#OprUpload").attr("disabled", true);
            $("#OprNote").attr("disabled", true);
            $("#OprIHPKembali").attr("disabled", true);
            $("#OprSave, #OprCreateIHP, #OprSendDesg, #AddFileSpec, #delfilespec").hide();
          } else {
            $("#tdOprTahap").removeClass("disabled");
            $("#OprDescription").attr("disabled", false);
            $("#OprDescription").addClass("mandatoryclass");
            $("#OprPartNum").attr("disabled", false);
            $("#OprVendorName").attr("disabled", false);
            $("#OprVendorName").addClass("mandatoryclass");
            $("#OprManufacture").attr("disabled", false);
            $("#OprManufacture").addClass("mandatoryclass");
            $("#OprVendorInHouse").attr("disabled", false);
            $("#OprQtySample").attr("disabled", true);
            $("#OprNoGudang").attr("disabled", false);
            $("#OprUpload").attr("disabled", false);
            $("#OprNote").attr("disabled", false);
            $("#OprIHPKembali").attr("disabled", false);
            $("#OprSave, #OprCreateIHP, #OprSendDesg, #AddFileSpec, #delfilespec").show();
          }

          //ref-material autocomplete base-on plant
          $("#OprNoGudang").focus(function () {
            var plant = obj["read_item"][0]["plant"];
            var splant = plant.toString();
            $(".ui.search.refmat").search({
              minCharacters: 2,
              apiSettings: {
                url: "2_psonline/_autocompletematerial.php?q={query}&p=" + splant,
              },
              fields: {
                results: "data",
                title: "MATNR",
                description: "MAKTX"
              },
            });
          });
        }
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
});



//Fuction Create IHP
function CreateIHP() {
  var idpss = $("#OprIdPSS").val();
  var iditem = $("#OprIdItem").val();
  $.ajax({
    type: "POST",
    url: `${restlocpssopr}create_ihp`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      idpss: idpss,
      iditem: iditem,
      user: Udecrypt,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(JSON.parse(response));
      if (isEmpty(obj)) {
        console.log("Gagal Simpan mas brooo, data error");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "warning",
            showConfirmButton: false,
          });
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "success",
            showConfirmButton: false,
          });
          $(".windoweditihp").modal("hide");
          LoadTableList();
          //TableListFunc();
        }
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
}

//Fuction Save IHP
function SaveIHP() {
  var idpss = $("#OprIdPSS").val();
  var iditem = $("#OprIdItem").val();

  // var file_data = $("#OprUpload").prop("files")[0];
  var ihpdesc = $("#OprDescription").val();
  var vendormatnum = $("#OprPartNum").val();
  var ihpvendor = $("#OprVendorName").val();
  var ihpmanu = $("#OprManufacture").val();
  var ihppicvendor = $("#OprVendorInHouse").val();
  var nogudang = $("#OprNoGudang").val();
  var tahap = $("#OprTahap").val();
  var note = $("#OprNote").val();
  var ihpkembali = $("#OprIHPKembali").val();
  var user = $("#OprUsername").val();
  var form_data = new FormData();
  // form_data.append("file", file_data);
  form_data.append("ihpdesc", ihpdesc);
  form_data.append("vmatnum", vendormatnum);
  form_data.append("ihpvendor", ihpvendor);
  form_data.append("ihpmanu", ihpmanu);
  form_data.append("picvendor", ihppicvendor);
  form_data.append("nogudang", nogudang);
  form_data.append("tahap", tahap);
  form_data.append("note", note);
  form_data.append("ihpkembali", ihpkembali);
  form_data.append("idpss", idpss);
  form_data.append("iditem", iditem);

  form_data.append("user", user);

  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `${restlocpssopr}update_itemoperator`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(JSON.parse(response));
      if (isEmpty(obj)) {
        console.log("Gagal Simpan mas brooo, data error");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "warning",
            showConfirmButton: false,
          });
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "success",
            showConfirmButton: false,
          });
          $(".windoweditihp").modal("hide");
          LoadTableList();
        }
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
}


$("#UploadFileSpec").on("click", function () {
  var file_data = $("#fileupload").prop("files")[0];
  var idpss = $("#PSSid").val();
  var iditem = $("#IHPid").val();
  var note = $("#note").val();
  var form_data = new FormData();

  form_data.append("file", file_data);
  form_data.append("idpss", idpss);
  form_data.append("iditem", iditem);
  form_data.append("note", note);
  form_data.append("user", Udecrypt);

  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `${restlocpssopr}save_uploadspec`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire({
          text: obj.message,
          timer: 1500,
          icon: "warning",
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          text: "Saved !",
          timer: 2000,
          toast: true,
          showConfirmButton: false,
        });

        $(".windowaddspec").modal("hide");
        LoadTableList();
      }
    },
    error: function () {
      // window.location.href = "./?link=loclogout";
      Swal.fire(
        "Error",
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
        "error"
      );
    },
  });
});


//Fuction Save Final Note IHP
function SaveFNote() {
  var idpss = $("#OprIdPSS").val();
  var iditem = $("#OprIdItem").val();
  var fnote = $("#OprFinalNote").val();
  $.ajax({
    type: "POST",
    url: `${restlocpssihp}save_fnote`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      idpss: idpss,
      iditem: iditem,
      fnote: fnote,
      user: Udecrypt,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(JSON.parse(response));
      if (isEmpty(obj)) {
        console.log("Gagal Simpan mas brooo, data error");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data tidak tersimpan !",
            "error"
          );
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "success",
            showConfirmButton: false,
          });
          $(".windoweditihp").modal("hide");
          LoadTableList();
        }
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
}

function SaveAddGroupIHP() {
  var desc  =  $("#IHPGrpDesc").val();
  var note  = $("#IHPGrpNote").val();
  var idgrp = $("#IHPGrpId").val();
  $.ajax({
    type: "POST",
    url: `${restlocpssopr}save_groupopr`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      desc: desc,
      note: note,
      user: vusrnm,
      idgrp: idgrp,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        console.log("Gagal Simpan mas brooo, data error");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data tidak tersimpan !",
            "error"
          );
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "success",
            showConfirmButton: false,
          });
          $(".windowaddgroup").modal("hide");
          LoadTableList_G();
        }
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
      // window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
}

//Function untuk copy ke clipboard
function copyToClipboard(element) {
  var $temp = $("<input>");
  $("body").append($temp);
  $temp.val($(element).text()).select();
  document.execCommand("copy");
  $temp.remove();
  console.log("copied");
  Swal.fire({
    text: "Item yang anda maksud sudah tersalin di clipboard",
    timer: 1500,
    position: "bottom-left",
    toast: true,
    showConfirmButton: false,
  });
}

//Datepicker
function DatePicker(IdTanggal) {
  var today = new Date();
  $(IdTanggal).calendar({
    type: "date",
    //monthFirst: false,
    minDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return year + "-" + month + "-" + day;
      },
    },
  });
}

function DeleteGroup(){
    var idgrp = $("#IHPGrpId").val();
    Swal.fire({
      title: "<h3>Delete Group?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpssopr}delete_group`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            idgrp: idgrp,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                text: "Deleted",
                timer: 2000,
                toast: true,
                showConfirmButton: false,
              });
              //reload table 
              $(".windowaddgroup").modal("hide");
              LoadTableList_G();
            }
          },
          error: function () {
            // window.location.href = "./?link=loclogout";
            Swal.fire(
              "Error",
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
              "error"
            );
          },
        });
      }
    });
}

$("#PSSList").on("click", ".detailpss", function () {
  var idpss = $(this).attr("idpss");
  var iditem = $(this).attr("iditem");
  $.ajax({
    type: "POST",
    url: `${restlocpssihp}load_itemihp`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      idpss: idpss,
      iditem: iditem,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);

      if (isEmpty(obj)) {
        console.log("-Empty-");
        $("#ItemListPSStbody").empty();
        return false;
      } else if (obj) {
        $("#ItemListPSStbody").empty();
        $("#IHPNo").text(obj["read_item"][0]["no_ihp"]);
        $("#IHPDate").text(obj["read_item"][0]["tanggal_ihp"]);
        $("#IHPNoPSS").text(obj["read_item"][0]["ps_no"]);
        $("#IHPChassis").text(obj["read_item"][0]["chasis"]);
        $("#IHPType").text(obj["read_item"][0]["type"]);
        $("#IHPNegoName").text(obj["read_item"][0]["negosiator"]);
        $("#IHPDesgName").text(obj["read_item"][0]["designer"]);
        $("#IHPDescription").text(obj["read_item"][0]["description_item"]);
        $("#IHPCategory").text(obj["read_item"][0]["jenis_project"]);
        $("#IHPVendorMatNum").text(obj["read_item"][0]["vendor_material_number"]);
        $("#IHPVendor").text(obj["read_item"][0]["vendor"]);
        $("#IHPManufacture").text(obj["read_item"][0]["manufacture"]);
        $("#IHPNoGudang").text(obj["read_item"][0]["no_gudang"]);
        $("#ReqPIN").text(obj["read_item"][0]["req_pinbl"]);
        $("#IHPIdItem").val(iditem);

        jmlData = obj["read_history_ihp"].length;
        $("#HistoryProgressTable").empty();
        for (a = 0; a < jmlData; a++) {
          $("#DetailHistoryProgress")
            .find("tbody")
            .append(
              "<tr>"+
                "<td>"+moment(obj["read_history_ihp"][a]["date"]).format('ddd, DD MMM YYYY')+"</td>"+
                "<td class='center'>"+obj["read_history_ihp"][a]["progress"]+"</td>"+
                "<td class='center'>"+obj["read_history_ihp"][a]["user"]+"</td>"+
              "</tr>"
            );
        }


      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
  $(".windowdetailitem").modal("show");
});

$("#PSSList_G").on("click", ".editgroupihp", function () {
  var grpid = $(this).attr("grpid");
  var grpdec = $(this).attr("grpdec");
  var grpnoihp = $(this).attr("grpnoihp");
  var gprnote = $(this).attr("gprnote");
  var usr  = getCookie('usrnm');
  $("#DeleteGroupIHP").show();

  $("#IHPGrpId").val(grpid);
  $("#IHPGrpDesc").val(grpdec);
  $("#IHPGrpNote").val(gprnote);
  

  $.ajax({
    type: "POST",
    url: `${restlocpssopr}edit_tempihp`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      noihps: grpnoihp,
      usr   : usr,
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal load IHP Grouping, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire('',obj.message,'')
        } else {
          LoadIHPListGrp('VIEW');
        }
      } else {
        Swal.fire('Error','','error')
      }
    },
    error: function () {
      // window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });

  $(".windowaddgroup").modal("show");
});

$("#PSSList_G").on("click", ".editvalueihp", function () {
  var grpid = $(this).attr("grpida");
  var grpdec = $(this).attr("grpdeca");
  var grpnoihp = $(this).attr("grpnoihpa");
  var usr  = getCookie('usrnm');

  $("#EditGrpDescIHP").text(grpdec);
  $("#EditGrpNoIHP").html(grpnoihp.replace(/\;/g, ",<br>"));

  $("#ME_IHPGrpId").val(grpid);


  //vendor autocomplete
  $(".ui.search.vendor").search({
    minCharacters: 1,
    apiSettings: {
      url: "2_psonline/_autocompleteDNSN.php?q={query}",
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
  });

  $(".ui.search.vendorname").search({
    minCharacters: 1,
    apiSettings: {
      url: "2_psonline/_autocompletevendorname.php?q={query}",
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
  });

  $(".ui.search.manufacture").search({
    minCharacters: 1,
    apiSettings: {
      url: "2_psonline/_autocompletemanufacture.php?q={query}",
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
  });


  $("#ME_OprNoGudang").focus(function () {
    var splant = $("#ME_Plant").val();
    // var splant = 1200;
    $(".ui.search.refmat").search({
      minCharacters: 2,
      apiSettings: {
        url: "2_psonline/_autocompletematerial.php?q={query}&p=" + splant,
      },
      fields: {
        results: "data",
        title: "MATNR",
        description: "MAKTX"
      },
    });
  });



  

  // $.ajax({
  //   type: "POST",
  //   url: `${restlocpssopr}edit_tempihp`,
  //   headers: {
  //     user: vusrnm,
  //     token: vtoken,
  //   },
  //   data: {
  //     noihps: grpnoihp,
  //     usr   : usr,
  //   },
  //   cache: false,
  //   success: function (response){
  //     var obj = JSON.parse(JSON.parse(response));
  //     if(isEmpty(obj)) {
  //       console.log('Gagal load IHP Grouping, data kosong');
  //     } else if(obj) {
  //       if (obj.status == false){
  //         Swal.fire('',obj.message,'')
  //       } else {
  //         LoadIHPListGrp();
  //       }
  //     } else {
  //       Swal.fire('Error','','error')
  //     }
  //   },
  //   error: function () {
  //     // window.location.href = "./?link=loclogout";
  //     console.log(
  //       "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
  //     );
  //   },
  // });

  $(".windoweditmasalihp").modal("show");
  DatePicker("#CalIHPkembali2");






});


function LoadTableList() {
  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();
  var sfilter = getCookie("sfilpss");
  var tfilter = getCookie("tfilpss");
  var mfilter = getCookie("mfilpss");
  var ofilter = getCookie("ofilpss");
  var pfilter = getCookie("pfilpss");
  var stfilter = getCookie("stfilpss");
  if (sfilter) {
    $("#filtercari").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    setCookie("sfilpss", "", 5);
    var sfilterstart = "";
  }
  if (tfilter) {
    $("#filtertahun").dropdown("set selected", tfilter);
    var tfilterstart = tfilter;
  } else {
    setCookie("tfilpss", yearnow, 5);
    var tfilterstart = yearnow;
  }
  if (mfilter) {
    $("#filtermine").val(mfilter);
    var mfilterstart = mfilter;
  } else {
    setCookie("mfilpss", "ALL", 5);
    var mfilterstart = "ALL";
  }
  if (ofilter) {
    $("#filteroperator").dropdown("set selected", ofilter);
    var ofilterstart = ofilter;
  } else {
    setCookie("ofilpss", "ALL", 5);
    var ofilterstart = "ALL";
  }
  if (pfilter) {
    $("#filterprogress").dropdown("set selected", pfilter);
    var pfilterstart = pfilter;
  } else {
    setCookie("pfilpss", "ALL", 5);
    var pfilterstart = "ALL";
  }
  if (stfilter) {
    $("#filterstatus").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    setCookie("stfilpss", "ALL", 5);
    var stfilterstart = "ALL";
  }
  //Load Table
  // TableListFunc(
  //   sfilterstart,
  //   tfilterstart,
  //   mfilterstart,
  //   ofilterstart,
  //   pfilterstart,
  //   stfilterstart
  // );

  if(LinkDesc){
    TableListFunc(LinkDesc, "ALL", "ALL", "ALL", "ALL", "ALL");
    $("#filtercari").val(LinkDesc);
    $("#filtermine").dropdown("set selected", "ALL");
    $("#filtertahun").dropdown("set selected", "ALL");
    $("#filteroperator").dropdown("set selected", "ALL");
    $("#filterprogress").dropdown("set selected", "ALL");
    $("#filterstatus").dropdown("set selected", "ALL");
  } else {
    TableListFunc(
      sfilterstart,
      tfilterstart,
      mfilterstart,
      ofilterstart,
      pfilterstart,
      stfilterstart
    );
  
  }


  //Showing input filter when !All
  if (pfilter !== "ALL" || stfilter !== "ALL") {
    $(".morefilter").show();
    $(".morefiltertd").show();
  } else {
    $(".morefilter").hide();
    $(".morefiltertd").hide();
  }
}


function LoadTableList_G() {
  //Read Filter Cookies
  var sfilterG = getCookie("sfilpss_G");
  
  if (sfilterG) {
    $("#filtercari_G").val(sfilterG);
    var sfilterstartG = sfilterG;
  } else {
    setCookie("sfilpss_G", "", 5);
    var sfilterstartG = "";
  }
  
  //Load Table
  TableListFunc_G(sfilterstartG );

}



function ReloadVendor(){
  var vusrnm  = getCookie('usrnm');
  var vtoken  = getCookie('token');
  var user    = $("#PSSUser").val();
    $('.canvas').dimmer('show');
    $(".windoweditihp").modal("hide");
  $.ajax({
    type: "GET",
    url: `${restlocemail}insert_vendor`,
    headers: {
      user  : vusrnm,
      token : vtoken
    },
    cache: false,
    success: function (response){
      $('.canvas').dimmer('hide');
        let timerInterval
        Swal.fire({
          text: 'Reload & Sync Vendor',
          timer: 2000,
          showConfirmButton: false,
          willClose: () => {
            clearInterval(timerInterval)
          }
        }).then((result) => {
          if (result.dismiss === Swal.DismissReason.timer) {
            Swal.fire({
              text: 'Done',
              timer: 1000,
              showConfirmButton: false
            });
          }
        })
    },
    error: function(){
      //window.location.href = "./?link=loclogout";
      console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
    }
  });
}

//Toggle More Filter
$("#morefilter").on("click", function () {
  $(".morefilter").toggle(100);
  $(".morefiltertd").toggle();
});

//RESPON KETIKA INPUT PENCARIAN DI KETIK
$("#filtercari").on("keyup", function () {
  var FilterCari = $("#filtercari").val();
  var FilterTahun = $("#filtertahun").val();
  var FilterNama = $("#filtermine").val();
  var FilterOperator = $("#filteroperator").val();
  var FilterProgress = $("#filterprogress").val();
  var FilterStatus = $("#filterstatus").val();
  setCookie("sfilpss", FilterCari, 5);
  setCookie("tfilpss", FilterTahun, 5);
  setCookie("mfilpss", FilterNama, 5);
  setCookie("ofilpss", FilterOperator, 5);
  setCookie("pfilpss", FilterProgress, 5);
  setCookie("stfilpss", FilterStatus, 5);
  $("#PSSList").DataTable().destroy();
  TableListFunc(
    FilterCari,
    FilterTahun,
    FilterNama,
    FilterOperator,
    FilterProgress,
    FilterStatus
  );
});

//RESPON KETIKA FILTER TAHUN DI RUBAH
$("#filtertahun, #filteroperator, #filterprogress, #filterstatus").on(
  "change",
  function () {
    var FilterCari = $("#filtercari").val();
    var FilterTahun = $("#filtertahun").val();
    var FilterNama = $("#filtermine").val();
    var FilterOperator = $("#filteroperator").val();
    var FilterProgress = $("#filterprogress").val();
    var FilterStatus = $("#filterstatus").val();
    setCookie("sfilpss", FilterCari, 5);
    setCookie("tfilpss", FilterTahun, 5);
    setCookie("mfilpss", FilterNama, 5);
    setCookie("ofilpss", FilterOperator, 5);
    setCookie("pfilpss", FilterProgress, 5);
    setCookie("stfilpss", FilterStatus, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc(
      FilterCari,
      FilterTahun,
      FilterNama,
      FilterOperator,
      FilterProgress,
      FilterStatus
    );
  }
);

//RESET FILTER
$(".resetfilter").on("click", function () {
  var d = new Date();
  var yearnow = d.getFullYear();
  $("#filtercari").val("");
  $("#filtertahun").dropdown("set selected", yearnow);
  $("#filteroperator").dropdown("set selected", "ALL");
  $("#filterprogress").dropdown("set selected", "ALL");
  $("#filterstatus").dropdown("set selected", "ALL");
  setCookie("sfilpss", "", 5);
  setCookie("tfilpss", yearnow, 5);
  setCookie("mfilpss", "ALL", 5);
  setCookie("ofilpss", "ALL", 5);
  setCookie("pfilpss", "ALL", 5);
  setCookie("stfilpss", "ALL", 5);
  $("#PSSList").DataTable().destroy();
  TableListFunc("", yearnow, "ALL", "ALL", "ALL", "ALL");
  $(".morefilter").hide();
  $(".morefiltertd").hide();
});


$("#filtercari_G").on("keyup", function () {
  var FilterCariG = $("#filtercari_G").val();
  setCookie("sfilpss_G", FilterCariG, 5);
  $("#PSSList_G").DataTable().destroy();
  TableListFunc_G(FilterCariG);
});

function ShortText(t){
  if(t){
    var lennamafile = t.length;
    return lennamafile > 40 ? t.substring(0, 40).concat('...') : t;
  } else {
    return '';
  }
}

function DateIHPEval(d){
  if(d){
    return moment(d).format('ddd, DD MMM YYYY');
  } else {
    return '<i>Tanggal tidak ditentukan</i>';
  }
}

function LoadIHPListGrp(act){
  var vusrnm  = getCookie('usrnm');
  var vtoken  = getCookie('token');
  var usr     = getCookie('usrnm');
  $('#Tb_IHPGrp').find('tbody').empty();
  $.ajax({
    type: "POST",
    url: `${restlocpssopr}list_itemihp`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      usr: usr,
      act: act
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal load tabel, data kosong');
      } else if(obj) {
        if (obj.code == 'error8'){
          $('#Tb_IHPGrp').find('tbody').append(
            "<tr><td width='400px'>&nbsp;"+
            "</td><td class='center' >"+
            "</td><td class='center'></td></tr>");
        } else {
          jmlData = obj.length;
          for(a = 0; a < jmlData; a++){
            $('#Tb_IHPGrp').find('tbody').append(
            "<tr id='"+a+"'><td>"+obj[a]["no_ihp"]+
            "</td><td class='center' width='400px'>"+obj[a]["descript_item"]+
            "</td><td class='center'><i class='trash alternate outline ActDelIHPGrp red link icon' nm='"+obj[a]["descript_item"]+"' id='"+obj[a]["id_temp"]+"' nom='"+obj[a]["no_ihp"]+"'></i></td></tr>");
          }
        }
      }
      DeleteItemIHPListGrp();
    },
    error: function(){
      window.location.href = "./?link=loclogout";
      console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
    }
  });
}

function DeleteItemIHPListGrp(){
  $('.ActDelIHPGrp').on('click', function(e){
    var idx  = $(this).attr('id');
    var nom  = $(this).attr('nom');
    var enm  = $(this).attr('nm');
    var usr  = getCookie('usrnm');
    Swal.fire({
      title: '<h3>Hapus Item ini dari IHP Grup ?</h3>',
      text: nom+" - "+enm,
      showCancelButton: true,
      confirmButtonText: 'Ya'
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpssopr}delete_tempihp`,
          headers: {
            user  : vusrnm,
            token : vtoken
          },
          data: {
            idx : idx,
            usr : usr
          },
          cache: false,
          success: function (response){
            var obj = JSON.parse(JSON.parse(response));
            if (obj.code == 'error9'){
              Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
            } else if (obj.code == 'error10'){
              Swal.fire('Error','Item yang dimaksud tidak ada !','error')
            }  else {
              LoadIHPListGrp('VIEW');
            }
          },
          error: function(){
            window.location.href = "./?link=loclogout";
            console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
          }
        });
      }
    })
  });
}

$(document).ready(function () {
  //Load Table List IHP
  LoadTableList();
  LoadTableList_G();

  //Tab Action Link
  $("#tabregpss").on("click", function () {
    window.location.href = "./?link=pssheader";
  });
  $("#addnewpss").on("click", function () {
    window.location.href = "./?link=pssheader";
  });
  $('.tabuserguide').on('click', function() {
    window.location.href = "./?link=guidepss";
  });
  $('.tabsuratgolive').on('click', function() {
    window.location.href = "./?link=golivepss";
  });
  $('.tabhasilmonitoring').on('click', function() {
    window.location.href = "./?link=monitorpss";
  });
  $('.tabversion').on('click', function() {
    window.location.href = "./?link=versionhistory&app=PSS";
  });

  $("#tabpssreport").on("click", function () {
    window.location.href = "./?link=reportingpss";
  });

  //Download xls base on filter
  $("#dwnldxls").on("click", function () {
    //var SER_filter   	= $('input[type=search]').val();
    //window.location.href = "./?link=dndwnldxls&c=3&s="+SER_filter;
  });

  //Save IHP
  $("#OprSave").on("click", function (e) {
    SaveIHP();
  });

  //Save Final Note
  $("#FNoteSave").on("click", function (e) {
    SaveFNote();
  });

  //Create IHP
  $("#OprCreateIHP").on("click", function (e) {
    CreateIHP();
  });

  $('#ButtonReload').on('click', function(e){
    ReloadVendor();
  });

  $("#BackIHP").on("click", function (e) {
    $(".windowaddspec").modal("hide");
  });

  $(".CloseModal").on("click", function (e) {
    $(".windoweditihp").modal("hide");
    $(".windowdetailitem").modal("hide");
    $(".windowaddspec").modal("hide");
    $(".windowaddgroup").modal("hide");
    $(".windoweditmasalihp").modal("hide");
  });

  $("#AddFileSpec").on("click", function (e) {
    var a = $("#OprIdPSS").val();
    var b = $("#OprIdItem").val();
    $(".windowaddspec").modal("show");
    $("#PSSid").val(a);
    $("#IHPid").val(b);
  });

  $("#AddIHPGrouping").on("click", function (e) {
    $(".windowaddgroup").modal("show");
    $("#IHPGrpId").val('');
    $("#IHPGrpDesc").val('');
    $("#IHPGrpNote").val('');
    $("#DeleteGroupIHP").hide();
    LoadIHPListGrp('DEL');
    
  });
  

  $("#IHPGrpSearch").on('keyup', function(){
    var src = $('#IHPGrpSearch').val();
    var usr  = getCookie('usrnm');
    $.ajax({
      type: "POST",
      url: `${restlocpssopr}list_noihp`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: { 
        src :  src,
        usr :  usr,
        pic :  Udecrypt
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        console.log(obj);
        if(isEmpty(obj)) {
          $('#Tb_SrcResult').empty();
          console.log('Gagal load tabel, data kosong');
        } else if(obj) {
          jmlData = obj.length;
          $('#Tb_SrcResult').empty();
          for(a = 0; a < jmlData; a++){
            if(obj[a]["no_ihp"] === null){
              var noihp ='- - -';
            } else {
              var noihp = obj[a]["no_ihp"];
            }
            $('#Tb_SrcResult').append(
              "<tr class='hoveradd addiconpenyusun' id='"+obj[a]["id_item"]+"' de='"+obj[a]["description_item"]+"'><td class='addgroup'><i class='icon plus teal circle link'></i></td><td class='addgroup' width='130px'>"+noihp+"</td><td class='addgroup' width='460px'>"+obj[a]["description_item"]+"</td></tr>");
          }
          AddGroupIHP();
        }
      },
      error: function(){
        window.location.href = "./?link=loclogout";
        console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
      }
    });
  });

  function AddGroupIHP(){
    $(".hoveradd").click(function(){
      var idx  = $(this).attr('id');
      var dec  = $(this).attr('de');
      var usr  = getCookie('usrnm');
      // console.log(idx);
      // $('#Tb_SrcResult').empty();
      // $('#IHPGrpSearch').val('');
              
      $.ajax({
        type: "POST",
        url: `${restlocpssopr}save_tempihp`,
        headers: {
          user: vusrnm,
          token: vtoken,
        },
        data: {
          idx: idx,
          dec: dec,
          usr: usr,
        },
        cache: false,
        success: function (response){
          var obj = JSON.parse(JSON.parse(response));
          if(isEmpty(obj)) {
            console.log('Gagal save IHP Grouping, data kosong');
          } else if(obj) {
            if (obj.status == false){
              Swal.fire('',obj.message,'')
            } else {
              Swal.fire({
                text: 'Item berhasil ditambahkan di daftar IHP Grouping',
                timer: 1000,
                position: 'top-right',
                toast: true,
                showConfirmButton: false
              })
              LoadIHPListGrp('VIEW');
            }
          } else {
            Swal.fire('Error','','error')
          }
        },
        error: function(){
          window.location.href = "./?link=loclogout";
          console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
        }
      });
    });
  }

  

   //Print Label Acc
  $("#SaveAddGroupIHP").on("click", function (e) {
    SaveAddGroupIHP();
  });

  $("#DeleteGroupIHP").on("click", function (e) {
    DeleteGroup();
  });

  //Print IHP in PDF
  $("#PrintIHPPDF").on("click", function (e) {
    var idpss = $("#OprIdPSS").val();
    var iditem = $("#OprIdItem").val();
    $.redirect(
      "./?link=viewihppdf",
      { idpss: idpss, iditem: iditem },
      "POST",
      "_blank"
    );
  });

  //Back Close Modal
  $("#OprBack").on("click", function (e) {
    $(".windoweditihp").modal("hide");
  });

  //Print Label Material
  $("#OprLabelMat").on("click", function (e) {
    var iditem = $("#OprIdItem").val();
    var idpss = $("#OprIdPSS").val();
    (async () => {
      const { value: cetak } = await Swal.fire({
        title: "Jumlah cetak Label Material",
        input: "select",
        inputOptions: {
          "1": "1",
          "2": "2",
          "3": "3",
          "4": "4",
          "5": "5",
          "6": "6",
          "7": "7",
          "8": "8",
        },
        showCancelButton: true,
      });
      if (cetak) {
        //menggunakan plugin tambahan redirect
        $.redirect(
          "./?link=cetaklabelmat",
          { jumlah: cetak, idpss: idpss, iditem: iditem },
          "POST",
          "_blank"
        );
      }
    })();
  });

  //Print Label Acc
  $("#OprLabelAcc").on("click", function (e) {
    var iditem = $("#OprIdItem").val();
    var idpss = $("#OprIdPSS").val();
    (async () => {
      const { value: cetak } = await Swal.fire({
        title: "Jumlah cetak Label Acc",
        input: "select",
        inputOptions: {
          "1": "1",
          "2": "2",
          "3": "3",
          "4": "4",
        },
        showCancelButton: true,
      });
      if (cetak) {
        //menggunakan plugin tambahan redirect
        $.redirect(
          "./?link=cetaklabelacc",
          { jumlah: cetak, idpss: idpss, iditem: iditem },
          "POST",
          "_blank"
        );
      }
    })();
  });

  $("#ihpgrouping").on("click", function (e) {
    LoadTableList_G();
  });

  //Send to Designer
  $("#OprSendDesg").on("click", function (e) {
    var iditem = $("#OprIdItem").val();
    var user = $("#OprUsername").val();
    Swal.fire({
      title: "<h3>Send IHP to Designer?</h3>",
      icon: "warning",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpssopr}set_placein`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            iditem: iditem,
            user: user,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                title: "Send !",
                text: "Lembar IHP telah terkirim ke Designer",
                timer: 1500,
                position: "top-end",
                icon: "success",
                showConfirmButton: false,
              });
              $(".windoweditihp").modal("hide");
              //TableListFunc();
              LoadTableList();
            }
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            Swal.fire(
              "Error",
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
              "error"
            );
          },
        });
      }
    });
  });

  $("#OprIHPKembaliBtn").on("click", function (e) {
    var idpss = $("#OprIdPSS").val();
    var iditem = $("#OprIdItem").val();
    var status = $("#OprStatus").val();
    Swal.fire({
      title: "<h3>Terima IHP Kembali dari Designer ?</h3>",
      icon: "warning",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpssihp}confirm_ihpkembali`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            iditem: iditem,
            idpss: idpss,
            status: status,
            user: Udecrypt,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                title: "Confirmed",
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              LoadTableList();
              $(".windoweditihp").modal("hide");
            }
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            Swal.fire(
              "Error",
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
              "error"
            );
          },
        });
        $(".windoweditihp").modal("hide");
      }
    });
  });

  $("#IHPDone").on("click", function (e) {
    var idpss = $("#OprIdPSS").val();
    var iditem = $("#OprIdItem").val();
    Swal.fire({
      title: "<h3>Set IHP menjadi DONE ?</h3>",
      text: "Note IHP kembali akan dihapus.",
      icon: "warning",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpssihp}set_ihpdone`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            iditem: iditem,
            idpss: idpss,
            user: Udecrypt,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendala di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                title: "IHP DONE !",
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              LoadTableList();
              $(".windoweditihp").modal("hide");
            }
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            Swal.fire(
              "Error",
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
              "error"
            );
          },
        });
        $(".windoweditihp").modal("hide");
      }
    });
  });



  $(".SaveMassEdit").on("click", function (e) {
    var idx = $(this).attr('idx');
    var idgrp = $("#ME_IHPGrpId").val();
    console.log(idx);
    console.log(idgrp);
    if(idx==="VMatNum"){
      var ihpval = $("#ME_OprPartNum").val();
    }
    if(idx==="VName"){
      var ihpval = $("#ME_OprVendorName").val();
    }
    if(idx==="Manufacture"){
      var ihpval = $("#ME_OprManufacture").val();
    }
    if(idx==="PICVendor"){
      var ihpval = $("#ME_OprVendorInHouse").val();
    }
    if(idx==="ReffPIN"){
      var ihpval = $("#ME_OprNoGudang").val();
    }
    if(idx==="MSCNote"){
      var ihpval = $("#ME_OprNote").val();
    }
    if(idx==="IHPKembali"){
      var ihpval = $("#ME_OprIHPKembali").val();
    }
    console.log(ihpval);

    $.ajax({
      type: "POST",
      url: `${restlocpssopr}save_editmassal`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        idx: idx,
        idgrp: idgrp,
        ihpval: ihpval,
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(response);
        if (obj.status == false) {
          Swal.fire(
            "Error",
            obj.message,
            "error"
          );
        } else {
          Swal.fire({
            title: "Saved",
            timer: 100,
            showConfirmButton: false,
          });
        }
      },
      error: function () {
        // window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    });
  });


  //Modal Window Control
  $(".windoweditihp").modal({
    autofocus: false,
  });

  //Download xls base on filter
  $("#dwnldxls").on("click", function () {
    var iddownload= "IHPOPERATOR";
    var search   	= $('#filtercari').val();
    var thnfilter = $('#filtertahun').val();
    var oprfilter = $('#filteroperator').val();
    var prgfilter = $('#filterprogress').val();
    var stsfilter = $('#filterstatus').val();

    $.redirect(
      "./?link=ihpdwnldxls",
      { 
        id: iddownload,
        search: search, 
        thnfilter: thnfilter,
        oprfilter: oprfilter,
        prgfilter: prgfilter,
        stsfilter: stsfilter
      },
      "POST",
      "_blank"
    );
  });
});
