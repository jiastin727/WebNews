//Activate dropdown & tab
$(".ui.pssdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();
$(".changenego").dropdown({
  selectOnKeydown: false,
});
moment().format();

// Global Variable
const NonceValue = "rdsystem2020";
const ColorProgNego = "#00139f";
const ColorWaitFinish = "#b77703";
const ColorFinish = "#5d5d5d";
const ColorCancel = "#7c0000";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocpssneg = decodeURIComponent(getCookie("restlocpssneg"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);

function TableListFunc(FSearch, FYear, FNama, FJenis, FProgress, FStatus) {
  $("#PSSList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#PSSList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    scrollX     : true,
    // scrollCollapse: true,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[1, "desc"]],
    columns: [
      { data: null,
        render: function (data, type, row) {
          if (data[0] != "") {
            if (data[18] !== "FINISH" && data[18] !== "CLOSE") {
              // return `<i class="tasks detailpss iconcoloredit icon" eid="${data[0]}" edesc="${data[6]}">`;

              return `<span class="tasks detailpss" eid="${data[0]}" edesc="${data[6]}" data-tooltip="View detail PSS" data-inverted="" data-position="right center"><i class="tasks link editpssheader circular teal icon"></i></span>`;
            } else {
              return "";
            }
          } else {
            return "";
          }
        },
      },
      { data: 20 },
      { data: null,
        render: function (data) {
          if (data[23] == "NO_DATA") {
            return data[23];
          } else {
            return data[1];
          }
        },
      },
      // {
      //   data: null,
      //   render: function (data, type, row) {
      //     return `<span class="detailpss clicklink" eid="${data[0]}" edesc="${data[6]}">${data[6]}</span>`;
      //   },
      // },
      { data: 6 },
      { data: 2 },
      { data: 17 },
      { data: 15 },
      { data: 12 },
      { data: 19 },
      { data: 14 },
      { data: 18 },
      { data: null,
        render: function (data, type, row) {
          
          if ((data[21] == null) || (!data[21])) {
            return `<span class="edit outline nego-note" data-tooltip="Tambahkan catatan" data-inverted="" data-position="left center" eid="${data[0]}"><i class="sticky note outline teal icon"></i></span>`;
          } else {
            return  data[21].length > 25 ? '<span class="edit outline nego-note" data-tooltip="Ubah catatan" data-inverted="" data-position="left center" eid="'+data[0]+'">'+data[21].substr( 0, 25 )+'...</span>' : '<span class="edit outline nego-note" data-tooltip="Ubah catatan" data-inverted="" data-position="left center" eid="'+data[0]+'">'+data[21]+'</span>';
          }
        }
      },
      
    ],
    columnDefs: [
      { className: "center aligned", targets: [0] },
      { orderable: false , targets: [0] },
      { className: "right aligned", targets: [1] },
      { targets: [1],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YYYY');
          } else {
            return '';
          }
        }
      }
    ],

    createdRow: function (row, data, index) {
      //WARNA NULL / DATA TIDAK DITEMUKAN
      // if (data[23] == "NO_DATA") {
      //   $(row).addClass("errorhilite");
      // }

      //WARNA PROCESS
      if (data[17] == "PROCESS") {
        $(row).find("td").css("color", ColorProgNego);
      }

      //WARNA WAIT FINISH
      if (data[18] == "WAIT FINISH") {
        $(row).find("td").css("color", ColorWaitFinish);
      }

      //WARNA FINISH & CLOSE
      if (data[18] == "FINISH" || data[18] == "CLOSE") {
        $(row).find("td").css("color", ColorFinish);
      }
    },

    ajax: {
      url: `${restlocpssneg}table_pss`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FYear: FYear,
        FNama: FNama,
        FJenis: FJenis,
        FProgress: FProgress,
        FStatus: FStatus,
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    },
  });

  
  // Open Modal Note Negosiator
  $('#PSSList').on("click", ".nego-note", function() {
    var eid = $(this).attr("eid")
    $('.ui.modal').modal('show');
    SaveNotice(eid);
    // Show autofill note
    $.ajax({
      url: `${restlocpssneg}autofill_note_negosiator`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        id_pss: eid
      },
      success: function (rsp) {
        var obj = JSON.parse(JSON.parse(rsp))
        $("#negotiator_note").val(obj[0].note_negosiator)
      }
    })


  })



  function SaveNotice(idpssnotice) {

      // Save Negosiator Note
      $("#savenote").on("click", function() {
        var note = $("#negotiator_note").val()
        $.ajax({
          url: `${restlocpssneg}note_negosiator`, 
          type: "POST",
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            id_pss: idpssnotice,
            note: note
          },
          success: function (rsp) {
            // var sfilter = getCookie("sfilpss");
            // var tfilter = getCookie("tfilpss");
            // var mfilter = getCookie("mfilpss");
            // var jfilter = getCookie("jfilpss");
            // var pfilter = getCookie("pfilpss");
            // var stfilter = getCookie("stfilpss");
            // TableListFunc(
            //   sfilter,
            //   tfilter,
            //   mfilter,
            //   jfilter,
            //   pfilter,
            //   stfilter
            // );
            $('.ui.modal').modal('hide');
            location.reload();
            // console.log(rsp)
            // Swal.fire("Note berhasil disimpan!").then((result) => {
              // location.reload()
            // })
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            Swal.fire(
              "Error",
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
              "error"
            );
          },
        })
      })
    }


  // Clear Note Input
  $(".clearnote").on("click", function() {
    $("#negotiator_note").val("")
  })


  //Click Icon Edit -- Edit PSS header
  $("#PSSList").on("click", ".detailpss", function () {
    var eid = $(this).attr("eid");
    let encryption = new Encryption();
    var eidENC = encryption.encrypt(eid, NonceValue);
    window.location.href = "./?link=pssdetail&i=" + eidENC;
  });

  //IHP List
  $("#tabihplist").on("click", function () {
    window.location.href = "./?link=ihpnegosiatorshd";
  });

  $("#tabpssreport").on("click", function () {
    window.location.href = "./?link=reportingpss";
  });
  

}

$(document).ready(function () {
  //Download xls base on filter
  $("#dwnldxls").on("click", function () {
    var iddownload= "PSSNEGOTIATOR";
    var search    = $('#filtercari').val();
    var thnfilter = $('#filtertahun').val();
    var picfilter = $('#filtermine').val();
    var prjfilter = $('#filterjenis').val();
    var prgfilter = $('#filterprogress').val();
    var stsfilter = $('#filterstatus').val();

    $.redirect(
      "./?link=pssdwnldxls",
      { 
        id: iddownload,
        search: search, 
        thnfilter: thnfilter,
        picfilter: picfilter,
        prjfilter: prjfilter,
        prgfilter: prgfilter,
        stsfilter: stsfilter
      },
      "POST",
      "_blank"
    );
  });
  
});

//Function untuk copy ke clipboard
function copyToClipboard(element) {
  var $temp = $("<input>");
  $("body").append($temp);
  $temp.val($(element).text()).select();
  document.execCommand("copy");
  $temp.remove();
  console.log("copied");
  Swal.fire({
    text: "Item yang anda maksud sudah tersalin di clipboard",
    timer: 1500,
    position: "bottom-left",
    toast: true,
    showConfirmButton: false,
  });
}

//Read Filter Cookies
var d = new Date();
var yearnow = d.getFullYear();
var sfilter = getCookie("sfilpss");
var tfilter = getCookie("tfilpss");
var mfilter = getCookie("mfilpss");
var jfilter = getCookie("jfilpss");
var pfilter = getCookie("pfilpss");
var stfilter = getCookie("stfilpss");
if (sfilter) {
  $("#filtercari").val(sfilter);
  var sfilterstart = sfilter;
} else {
  setCookie("sfilpss", "", 5);
  var sfilterstart = "";
}
if (tfilter) {
  $("#filtertahun").dropdown("set selected", tfilter);
  var tfilterstart = tfilter;
} else {
  setCookie("tfilpss", yearnow, 5);
  var tfilterstart = yearnow;
}
if (mfilter) {
  $("#filtermine").dropdown("set selected", mfilter);
  var mfilterstart = mfilter;
} else {
  setCookie("mfilpss", "ALL", 5);
  var mfilterstart = "ALL";
}
if (jfilter) {
  $("#filterjenis").dropdown("set selected", jfilter);
  var jfilterstart = jfilter;
} else {
  setCookie("jfilpss", "ALL", 5);
  var jfilterstart = "ALL";
}
if (pfilter) {
  $("#filterprogress").dropdown("set selected", pfilter);
  var pfilterstart = pfilter;
} else {
  setCookie("pfilpss", "ALL", 5);
  var pfilterstart = "ALL";
}
if (stfilter) {
  $("#filterstatus").dropdown("set selected", stfilter);
  var stfilterstart = stfilter;
} else {
  setCookie("stfilpss", "ALL", 5);
  var stfilterstart = "ALL";
}
//Load Table
TableListFunc(
  sfilterstart,
  tfilterstart,
  mfilterstart,
  jfilterstart,
  pfilterstart,
  stfilterstart
);

//Showing input filter when !All
if (jfilter !== "ALL" || pfilter !== "ALL" || stfilter !== "ALL") {
  $(".morefilter").show();
  $(".morefiltertd").show();
} else {
  $(".morefilter").hide();
  $(".morefiltertd").hide();
}

//Toggle More Filter
$("#morefilter").on("click", function () {
  $(".morefilter").toggle(100);
  $(".morefiltertd").toggle();
});

//RESPON KETIKA INPUT PENCARIAN DI KETIK
$("#filtercari").on("keyup", function () {
  var FilterCari = $("#filtercari").val();
  var FilterTahun = $("#filtertahun").val();
  var FilterNama = $("#filtermine").val();
  var FilterJenis = $("#filterjenis").val();
  var FilterProgress = $("#filterprogress").val();
  var FilterStatus = $("#filterstatus").val();
  setCookie("sfilpss", FilterCari, 5);
  setCookie("tfilpss", FilterTahun, 5);
  setCookie("mfilpss", FilterNama, 5);
  setCookie("jfilpss", FilterJenis, 5);
  setCookie("pfilpss", FilterProgress, 5);
  setCookie("stfilpss", FilterStatus, 5);
  $("#PSSList").DataTable().destroy();
  TableListFunc(
    FilterCari,
    FilterTahun,
    FilterNama,
    FilterJenis,
    FilterProgress,
    FilterStatus
  );
});

//RESPON KETIKA FILTER TAHUN DI RUBAH
$("#filtertahun, #filterjenis, #filterprogress, #filterstatus").on(
  "change",
  function () {
    var FilterCari = $("#filtercari").val();
    var FilterTahun = $("#filtertahun").val();
    var FilterNama = $("#filtermine").val();
    var FilterJenis = $("#filterjenis").val();
    var FilterProgress = $("#filterprogress").val();
    var FilterStatus = $("#filterstatus").val();
    setCookie("sfilpss", FilterCari, 5);
    setCookie("tfilpss", FilterTahun, 5);
    setCookie("mfilpss", FilterNama, 5);
    setCookie("jfilpss", FilterJenis, 5);
    setCookie("pfilpss", FilterProgress, 5);
    setCookie("stfilpss", FilterStatus, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc(
      FilterCari,
      FilterTahun,
      FilterNama,
      FilterJenis,
      FilterProgress,
      FilterStatus
    );
  }
);

//RESET FILTER
$(".resetfilter").on("click", function () {
  var d = new Date();
  var yearnow = d.getFullYear();
  $("#filtercari").val("");
  $("#filtertahun").dropdown("set selected", yearnow);
  $("#filtermine").dropdown("set selected", "ALL");
  $("#filterjenis").dropdown("set selected", "ALL");
  $("#filterprogress").dropdown("set selected", "ALL");
  $("#filterstatus").dropdown("set selected", "ALL");
  setCookie("sfilpss", "", 5);
  setCookie("tfilpss", yearnow, 5);
  setCookie("mfilpss", "ALL", 5);
  setCookie("jfilpss", "ALL", 5);
  setCookie("pfilpss", "ALL", 5);
  setCookie("stfilpss", "ALL", 5);
  $("#PSSList").DataTable().destroy();
  TableListFunc("", yearnow, "ALL", "ALL", "ALL", "ALL");
  $(".morefilter").hide();
  $(".morefiltertd").hide();
});

$(".CloseModal").on("click", function () {
  $('.NegoNotice').modal('hide');
});
