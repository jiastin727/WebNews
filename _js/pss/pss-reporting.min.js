$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorFinish= "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocmkg = decodeURIComponent(getCookie("restlocmkg"));
var restlocpssihp = decodeURIComponent(getCookie("restlocpssihp"));
var restlocpssopr = decodeURIComponent(getCookie("restlocpssopr"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);




function TableListFunc() {

  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();

  var json_str = getCookie('FilterReportPSSRequest');
  var arr = JSON.parse(json_str);
  if(json_str){
    var sfilter = arr[0];
    var mfilter = arr[1];
    var tfilter = arr[2];
    var stfilter = arr[3];
    var pgfilter = arr[4];
    var ngfilter = arr[5];
    var stpsfilter = arr[6];
    var pgpsfilter = arr[7];
    var oprfilter = arr[8];
    var sctfilter = arr[9];
  } else {
    var sfilter = "";
    var mfilter = "ALL";
    var tfilter = yearnow;
    var stfilter = "ALL";
    var pgfilter = "ALL";
    var ngfilter = "ALL";
    var stpsfilter = "ALL";
    var pgpsfilter = "ALL";
    var oprfilter = "ALL";
    var sctfilter = "ALL";
  }

  if (sfilter) {
    $("#fcari_report").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (mfilter) {
    $("#fpic_reportpss").dropdown("set selected", mfilter);
    var mfilterstart = mfilter;
  } else {
    var mfilterstart = "ALL PIC";
  }
  if (tfilter) {
    $("#fthn_reportpss").dropdown("set selected", tfilter);
    var tfilterstart = tfilter;
  } else {
    var tfilterstart = yearnow;
  }
  if (stfilter) {
    $("#fsts_reportpss").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    var stfilterstart = "ALL Status IHP";
  }
  if (pgfilter) {
    $("#fprg_reportpss").dropdown("set selected", pgfilter);
    var pgfilterstart = pgfilter;
  } else {
    var pgfilterstart = "ALL Progress IHP";
  }
  if (ngfilter) {
    $("#fnego_reportpss").dropdown("set selected", ngfilter);
    var ngfilterstart = ngfilter;
  } else {
    var ngfilterstart = "ALL Negosiator";
  }
  if (oprfilter) {
    $("#fopr_reportpss").dropdown("set selected", oprfilter);
    var oprfilterstart = oprfilter;
  } else {
    var oprfilterstart = "ALL Operator";
  }

  if (stpsfilter) {
    $("#fstsps_reportpss").dropdown("set selected", stpsfilter);
    var stpsfilterstart = stpsfilter;
  } else {
    var stpsfilterstart = "ALL Status PSS";
  }
  if (pgpsfilter) {
    $("#fprgps_reportpss").dropdown("set selected", pgpsfilter);
    var pgpsfilterstart = pgpsfilter;
  } else {
    var pgpsfilterstart = "ALL Progress PSS";
  }

  if (sctfilter) {
    $("#fsect_reportpss").dropdown("set selected", sctfilter);
    var sctfilterstart = sctfilter;
  } else {
    var sctfilterstart = "ALL Section";
  }

  var FiterArry = [sfilterstart, mfilterstart, tfilterstart, stfilterstart, pgfilterstart, ngfilterstart, stpsfilterstart, pgpsfilterstart, oprfilterstart,sctfilterstart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterReportPSSRequest", JsonFilter, 5);

  $("#CustFilterYear").text(tfilterstart);
  if(mfilterstart.length === 0){
    $("#CustFilterPic").text("ALL PIC");
  }else{
    $("#CustFilterPic").text(mfilterstart);
  }
  if(ngfilterstart.length === 0){
    $("#CustFilterNego").text("ALL Negosiator");
  }else{
    $("#CustFilterNego").text(ngfilterstart);
  }
  if(oprfilterstart.length === 0){
    $("#CustFilterOpr").text("ALL Operator");
  }else{
    $("#CustFilterOpr").text(oprfilterstart);
  }
  if(stpsfilterstart.length === 0){
    $("#CustFilterPssSts").text("ALL Status PSS");
  }else{
    $("#CustFilterPssSts").text(stpsfilterstart);
  }
  if(pgpsfilterstart.length === 0){
    $("#CustFilterPssProg").text("ALL Progress PSS");
    // console.log("NULL");
  }else{
    $("#CustFilterPssProg").text(pgpsfilterstart);
  }
  if(stfilterstart.length === 0){
    $("#CustFilterIhpSts").text("ALL Status IHP");
    // console.log("NULL");
  }else{
    $("#CustFilterIhpSts").text(stfilterstart);
  }
  if(pgfilterstart.length === 0){
    $("#CustFilterIhpProg").text("ALL Progress IHP");
  }else{
    $("#CustFilterIhpProg").text(pgfilterstart);
  }
  if(sctfilterstart.length === 0){
    $("#CustFilterSection").text("ALL Section");
  }else{
    $("#CustFilterSection").text(sctfilterstart);
  }

  var DTables = $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      // "<'left aligned three wide column NewBtn'>" +
      "<'left aligned eight wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned six wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      // {
      //   text: "250",
      //   action: function (e, dt, node, config) {
      //     $("#TableList").DataTable().page.len(250).draw();
      //   },
      // },
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    pageLength  : 10,
    paging      : true,
    scrollX     : true,
    scrollCollapse: true,
    scrollY     : '80vh',
    fixedColumns:   {
      leftColumns: 4
    },
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    
    columns: [
      {
        data: null,
        render: function (data) {
          
          if (data['id_item'] == "" || data['id_item'] == null) {

            return ``;
          } else {
            // return `<span class="bplink pscdetail" eid="${data[0]}"><i class='pscdetail list icon'></i></span>`;
            return `<span class="itemmpss" id_item="${data['id_item']}" id_pss="${data['id_pss']}"  data-tooltip="Detail Item PSS" data-inverted="" data-position="right center"><i class="tasks link circular blue icon "></i></span>`;
          }
        },
      },
      { data: 'negosiator' },
      // $col = array('','negosiator','status_item', 'progress_item','note_item','pss_no','date_psscreate','desc_itempss','vendor_mat_number','vendor','manufacture','chasis','qty_sample','qty_confirm','base_unit','eta_sample','eta_confirm','reff_material','pic','section_head','tahapihp','req_pinbl','no_ihp','tanggal_ihp','final_result','operator');
      { data: 'status_ps' },
      { data: 'progress_pss' },
      { data: 'status_item' },
      { data: 'progress_item' },
      { data: 'note_item' },
      {
        data: null,
        render: function (data) {
          
          if (data['pss_no'] == "" || data['pss_no'] == null) {

            return ``;
          } else {
            // return `<span class="bplink pscdetail" eid="${data[0]}"><i class='pscdetail list icon'></i></span>`;
            return `<span class="detailpss clicklink" id_pss="${data['id_pss']}"  data-tooltip="Detail Header PSS" data-inverted="" data-position="right center">${data['pss_no']}</span>`;
          }
        },
      },
      { data: 'date_psscreate' },
      { data: 'desc_itempss' },
      { data: 'vendor_mat_number' },
      { data: 'vendor' },
      { data: 'manufacture' },
      { data: 'chasis' },
      { data: 'qty_sample' },
      { data: 'qty_confirm' },
      { data: 'base_unit' },
      { data: 'eta_sample' },
      // { data: 'Chassis' },
      { data: 'eta_confirm' },
      { data: 'reff_material' },
      { data: 'pic' },
      { data: 'rnd_bagian' },
      { data: 'section_head' },
      { data: 'tahapihp' },
      { data: 'req_pinbl' },
      { data: 'no_ihp' },
      { data: 'tanggal_ihp' },
      { data: 'signed_date_desg' },
      { data: 'signed_date_ho' },
      { data: 'signed_date_nego' },
      { data: 'finished_date' },
      {
        data: null,
        render: function (data) {
          if (data['signed_date_ho'] == "" || data['signed_date_ho'] == null) {

            return ``;
          } else {
            var sign1 = moment(data['signed_date_desg']);
            var sign2 = moment(data['signed_date_ho']);
            var duration = moment.duration(sign2.diff(sign1));
            var d = moment(duration).format("D [day], H [hour and] m [min]");
            return duration.days() + " days, " + duration.hours() + " hours";
          }
        },
      },
      {
        data: null,
        render: function (data) {
          if (data['signed_date_nego'] == "" || data['signed_date_nego'] == null) {

            return ``;
          } else {
            var sign1 = moment(data['signed_date_ho']);
            var sign2 = moment(data['signed_date_nego']);
            var duration = moment.duration(sign2.diff(sign1));
            var d = moment(duration).format("D [day], H [hour and] m [min]");
            return duration.days() + " days, " + duration.hours() + " hours";
          }
        },
      },
      {
        data: null,
        render: function (data) {
          if (data['tanggal_ihp'] == "" || data['tanggal_ihp'] == null) {

            return ``;
          } else {
            var sign1 = moment(data['signed_date_nego']);
            var sign2 = moment(data['tanggal_ihp']);
            var duration = moment.duration(sign2.diff(sign1));
            var d = moment(duration).format("D [day], H [hour and] m [min]");
            return duration.days() + " days ";
          }
        },
      },
      {
        data: null,
        render: function (data) {
          if (data['finished_date'] == "" || data['finished_date'] == null) {

            return ``;
          } else {
            var sign1 = moment(data['tanggal_ihp']);
            var sign2 = moment(data['finished_date']);
            var duration = moment.duration(sign2.diff(sign1));
            return duration.days() + " days ";
          }
        },
      },
      { data: 'final_result' },
      { data: 'operator' },
      
    ],
    columnDefs: [
      { className: "collapsing", targets: [8] },
      { orderable: false, targets: [8] },
      ],

   createdRow: function (row, data, index) {

      $(row).find("td:eq(30)").css("border-right", "inset");
      $(row).find("td:eq(30)").css("background-color", "#b0d2ff");

      $(row).find("td:eq(31)").css("border-right", "inset");
      $(row).find("td:eq(31)").css("background-color", "#b0d2ff");

      $(row).find("td:eq(32)").css("border-right", "inset");
      $(row).find("td:eq(32)").css("background-color", "#b0d2ff");

      $(row).find("td:eq(33)").css("border-right", "inset");
      $(row).find("td:eq(33)").css("background-color", "#b0d2ff");
      //WARNA PROCCESS
      
    },

    ajax: {
      url: `${restlocpssihp}table_reportpss`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch : sfilterstart,
        FNama   : mfilterstart,
        FTahun   : tfilterstart,
        FStatus : stfilterstart,
        FProgress : pgfilterstart,
        FNego : ngfilterstart,
        FStatusPS : stpsfilterstart,
        FProgressPS : pgpsfilterstart,
        FOperator : oprfilterstart,
        FSect : sctfilterstart
      },

      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}

//Click Icon Edit item IHP
$("#TableList").on("click", ".itemmpss", function () {
  var pssid = $(this).attr("id_pss");
  var iditem = $(this).attr("id_item");
  $("#NegoUpload").val("");
  $(".windowdetailihp").modal("show");

  $.ajax({
    type: "POST",
    url: `${restlocpssopr}load_itemihpev`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: { iditem: iditem, idpss: pssid },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      console.log(obj["read_ihpev"]["status"]);

      if (obj["note_ihp"]["status"] == false) {
        $(".ihp-noteheader").hide()
      } else {
        $(".ihp-noteheader").show()
        $(".note-ihp-kembali").text(obj["note_ihp"][0]["note"])
      }

      if (obj["read_item"]["status"] == false) {
        var file = "<i>Belum ada spec yang diupload</i>";
      } else {
        var file =
          '<a target="_blank" href="./?link=filespecpss&f=' +
          obj["read_item"][0]["file_upload"] +
          '">' +
          obj["read_item"][0]["file_upload"] +
          "</a>";
      }

      if (isEmpty(obj["read_item"])) {
        console.log("Gagal load tabel, data kosong");
      } else if (obj["read_item"]) {
        if (obj["read_item"].status == false) {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data gagal diload !",
            "error"
          );
        } else {
          //console.log(obj["read_item"])
          if (obj["read_item"][0]["progress_item"] == "IHP KEMBALI") {
            $(".IHPKembaliArea").show();
          } else {
            $(".IHPKembaliArea").hide();
          }

          // $(".windowdetailihp").modal("show");
          $("#NegoNoIHP").text(obj["read_item"][0]["no_ihp"]);
          $("#NegoDateIHP").text(obj["read_item"][0]["tanggal_ihp"]);
          $("#NegoNoPSS").text(obj["read_item"][0]["ps_no"]);
          $("#NegoChassis").text(obj["read_item"][0]["chasis"]);
          $("#NegoType").text(obj["read_item"][0]["type"]);
          $("#NegoNegoName").text(obj["read_item"][0]["negosiator"]);
          $("#NegoCategory").text(obj["read_item"][0]["jenis_project"]);
          $("#NegoDesgName").text(obj["read_item"][0]["designer"]);
          $("#NegoTahap").text(obj["read_item"][0]["tahap"]);
          $("#NegoDescript").text(obj["read_item"][0]["description_item"]);
          $("#NegoVendorMatNum").text(
            obj["read_item"][0]["vendor_material_number"]
          );
          $("#NegoNoGudang").text(obj["read_item"][0]["no_gudang"]);
          $("#NegoVendor").text(obj["read_item"][0]["vendor"]);
          $("#NegoManufacture").text(obj["read_item"][0]["manufacture"]);
          $("#NegoMSCNote").text(obj["read_item"][0]["note_ihp"]);
          $("#NegoIHPKembali").text(obj["read_item"][0]["tanggal_ihp_kembali"]);
          $("#FinalResult").text(obj["read_item"][0]["final_result"]);

          $("#PSSidx").val(pssid);
          $("#IHPIdItem").val(iditem);
          $("#NegoFileSpec").html(file);

          
          if(obj["read_ihpev"]["status"] !== false){
            var stsel = obj["read_ihpev"][0]["status_electronic"];
            var stscy = obj["read_ihpev"][0]["status_cycle"];
            var stsme = obj["read_ihpev"][0]["status_mechanic"];
            var stsid = obj["read_ihpev"][0]["status_ind"];
            var stsso = obj["read_ihpev"][0]["status_software"];
            var stspc = obj["read_ihpev"][0]["status_pcb"];
            var stsmq = obj["read_ihpev"][0]["status_mqa"];
            var stsdq = obj["read_ihpev"][0]["status_dqa"];
            var stsat = obj["read_ihpev"][0]["status_autrans"];
            var stsot = obj["read_ihpev"][0]["status_others"];
            var stso1 = obj["read_ihpev"][0]["status_others1"];
            var stso2 = obj["read_ihpev"][0]["status_others2"];
  
            var docel = obj["read_ihpev"][0]["acuan_electronic"];
            var doccy = obj["read_ihpev"][0]["acuan_cycle"];
            var docme = obj["read_ihpev"][0]["acuan_mechanic"];
            var docid = obj["read_ihpev"][0]["acuan_ind"];
            var docso = obj["read_ihpev"][0]["acuan_software"];
            var docpc = obj["read_ihpev"][0]["acuan_pcb"];
            var docmq = obj["read_ihpev"][0]["acuan_mqa"];
            var docdq = obj["read_ihpev"][0]["acuan_dqa"];
            var docat = obj["read_ihpev"][0]["acuan_autrans"];
            var docot = obj["read_ihpev"][0]["acuan_others"];
            var doco1 = obj["read_ihpev"][0]["acuan_others1"];
            var doco2 = obj["read_ihpev"][0]["acuan_others2"];
  
            var lnkel = obj["read_ihpev"][0]["link_electronic"];
            var lnkcy = obj["read_ihpev"][0]["link_cycle"];
            var lnkme = obj["read_ihpev"][0]["link_mechanic"];
            var lnkid = obj["read_ihpev"][0]["link_ind"];
            var lnkso = obj["read_ihpev"][0]["link_software"];
            var lnkpc = obj["read_ihpev"][0]["link_pcb"];
            var lnkmq = obj["read_ihpev"][0]["link_mqa"];
            var lnkdq = obj["read_ihpev"][0]["link_dqa"];
            var lnkat = obj["read_ihpev"][0]["link_autrans"];
            var lnkot = obj["read_ihpev"][0]["link_others"];
            var lnko1 = obj["read_ihpev"][0]["link_others1"];
            var lnko2 = obj["read_ihpev"][0]["link_others2"];
  
            var picel = obj["read_ihpev"][0]["pic_confirm_electronic"];
            var piccy = obj["read_ihpev"][0]["pic_confirm_cycle"];
            var picme = obj["read_ihpev"][0]["pic_confirm_mechanic"];
            var picid = obj["read_ihpev"][0]["pic_confirm_ind"];
            var picso = obj["read_ihpev"][0]["pic_confirm_software"];
            var picpc = obj["read_ihpev"][0]["pic_confirm_pcb"];
            var picmq = obj["read_ihpev"][0]["pic_confirm_mqa"];
            var picdq = obj["read_ihpev"][0]["pic_confirm_dqa"];
            var picat = obj["read_ihpev"][0]["pic_confirm_autrans"];
            var picot = obj["read_ihpev"][0]["pic_confirm_others"];
            var pico1 = obj["read_ihpev"][0]["pic_confirm_others1"];
            var pico2 = obj["read_ihpev"][0]["pic_confirm_others2"];
  
            // if (lnkel) {
            //   var linkel =
            //     '<a target="_blank" href="' + lnkel + '">' + docel + "</a>";
            // } else {
            //   var linkel = lnkel;
            // }
            // if (lnkcy) {
            //   var linkcy =
            //     '<a target="_blank" href="' + lnkcy + '">' + doccy + "</a>";
            // } else {
            //   var linkcy = lnkcy;
            // }
            // if (lnkme) {
            //   var linkme =
            //     '<a target="_blank" href="' + lnkme + '">' + docme + "</a>";
            // } else {
            //   var linkme = lnkme;
            // }
            // if (lnkid) {
            //   var linkid =
            //     '<a target="_blank" href="' + lnkid + '">' + docid + "</a>";
            // } else {
            //   var linkid = lnkid;
            // }
            // if (lnkso) {
            //   var linkso =
            //     '<a target="_blank" href="' + lnkso + '">' + docso + "</a>";
            // } else {
            //   var linkso = lnkso;
            // }
            // if (lnkpc) {
            //   var linkpc =
            //     '<a target="_blank" href="' + lnkpc + '">' + docpc + "</a>";
            // } else {
            //   var linkpc = lnkpc;
            // }
            // if (lnkmq) {
            //   var linkmq =
            //     '<a target="_blank" href="' + lnkmq + '">' + docmq + "</a>";
            // } else {
            //   var linkmq = lnkmq;
            // }
            // if (lnkdq) {
            //   var linkdq =
            //     '<a target="_blank" href="' + lnkdq + '">' + docdq + "</a>";
            // } else {
            //   var linkdq = lnkdq;
            // }
            // if (lnkat) {
            //   var linkat =
            //     '<a target="_blank" href="' + lnkat + '">' + docat + "</a>";
            // } else {
            //   var linkat = lnkat;
            // }
            // if (lnkot) {
            //   var linkot =
            //     '<a target="_blank" href="' + lnkot + '">' + docot + "</a>";
            // } else {
            //   var linkot = lnkot;
            // }
            // if (lnko1) {
            //   var linko1 =
            //     '<a target="_blank" href="' + lnko1 + '">' + doco1 + "</a>";
            // } else {
            //   var linko1 = lnko1;
            // }
            // if (lnko2) {
            //   var linko2 =
            //     '<a target="_blank" href="' + lnko2 + '">' + doco2 + "</a>";
            // } else {
            //   var linko2 = lnko2;
            // }
  
            if (lnkel && lnkel!==null) {
              if(!docel){ var docel = "Dokumen Electronic"; }
              var linkel =
                '<a target="_blank" href="../RND_Upload/' + lnkel + '">' + ShortText(docel) + "</a>";
            } else {
              var linkel = ShortText(docel);
            }
  
            if (lnkcy) {
              if(!doccy){ var doccy = "Dokumen Energy Conversion"; }
              var linkcy =
                '<a target="_blank" href="../RND_Upload/' + lnkcy + '">' + ShortText(doccy) + "</a>";
            } else {
              var linkcy = ShortText(doccy);
            }
            if (lnkme) {
              if(!docme){ var docme = "Dokumen Mechanic"; }
              var linkme =
                '<a target="_blank" href="../RND_Upload/' + lnkme + '">' + ShortText(docme) + "</a>";
            } else {
              var linkme = ShortText(docme);
            }
            if (lnkid) {
              if(!docid){ var docid = "Dokumen Industrial Design"; }
              var linkid =
                '<a target="_blank" href="../RND_Upload/' + lnkid + '">' + ShortText(docid) + "</a>";
            } else {
              var linkid = ShortText(docid);
            }
            if (lnkso) {
              if(!docso){ var docso = "Dokumen Software"; }
              var linkso =
                '<a target="_blank" href="../RND_Upload/' + lnkso + '">' + ShortText(docso) + "</a>";
            } else {
              var linkso = ShortText(docso);
            }
            if (lnkpc) {
              if(!docpc){ var docpc = "Dokumen PCB"; }
              var linkpc =
                '<a target="_blank" href="../RND_Upload/' + lnkpc + '">' + ShortText(docpc) + "</a>";
            } else {
              var linkpc = ShortText(docpc);
            }
            if (lnkmq) {
              if(!docmq){ var docmq = "Dokumen MQA"; }
              var linkmq =
                '<a target="_blank" href="../RND_Upload/' + lnkmq + '">' + ShortText(docmq) + "</a>";
            } else {
              var linkmq = ShortText(docmq);
            }
            if (lnkdq) {
              if(!docdq){ var docdq = "Dokumen DQA"; }
              var linkdq =
                '<a target="_blank" href="../RND_Upload/' + lnkdq + '">' + ShortText(docdq) + "</a>";
            } else {
              var linkdq = ShortText(docdq);
            }
            if (lnkat) {
              if(!docat){ var docat = "Dokumen Autrans"; }
              var linkat =
                '<a target="_blank" href="../RND_Upload/' + lnkat + '">' + ShortText(docat) + "</a>";
            } else {
              var linkat = ShortText(docat);
            }
            if (lnkot) {
              if(!docot){ var docot = "Dokumen Others"; }
              var linkot =
                '<a target="_blank" href="../RND_Upload/' + lnkot + '">' + ShortText(docot) + "</a>";
            } else {
              var linkot = ShortText(docot);
            }
            if (lnko1) {
              if(!doco1){ var doco1 = "Dokumen Others 1"; }
              var linko1 =
                '<a target="_blank" href="../RND_Upload/' + lnko1 + '">' + ShortText(doco1) + "</a>";
            } else {
              var linko1 = ShortText(doco1);
            }
            if (lnko2) {
              if(!doco2){ var doco2 = "Dokumen Others 2"; }
              var linko2 =
                '<a target="_blank" href="../RND_Upload/' + lnko2 + '">' + ShortText(doco2) + "</a>";
            } else {
              var linko2 = ShortText(doco2);
            }
  
            $("#ElectResult").text(stsel);
            $("#HAResult").text(stscy);
            $("#MechResult").text(stsme);
            $("#IDeResult").text(stsid);
            $("#SoftResult").text(stsso);
            $("#PCBResult").text(stspc);
            $("#MQAResult").text(stsmq);
            $("#DQAResult").text(stsdq);
            $("#AuTResult").text(stsat);
            $("#OthResult").text(stsot);
            $("#Oth1Result").text(stso1);
            $("#Oth2Result").text(stso2);
  
            $("#ElectReff").html(linkel);
            $("#HAReff").html(linkcy);
            $("#MechReff").html(linkme);
            $("#IDReff").html(linkid);
            $("#SoftReff").html(linkso);
            $("#PCBReff").html(linkpc);
            $("#MQAReff").html(linkmq);
            $("#DQAReff").html(linkdq);
            $("#AuTReff").html(linkat);
            $("#OthReff").html(linkot);
            $("#Oth1Reff").html(linko1);
            $("#Oth2Reff").html(linko2);
  
            $("#ElectPIC").text(picel);
            $("#HAPIC").text(piccy);
            $("#MechPIC").text(picme);
            $("#IDePIC").text(picid);
            $("#SoftPIC").text(picso);
            $("#PCBPIC").text(picpc);
            $("#MQAPIC").text(picmq);
            $("#DQAPIC").text(picdq);
            $("#AuTPIC").text(picat);
            $("#OthPIC").text(picot);
            $("#Oth1PIC").text(pico1);
            $("#Oth2PIC").text(pico2);
          }
          
        }
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
});

//Click Icon Edit item IHP
$("#TableList").on("click", ".detailpss", function () {
  var pssid = $(this).attr("id_pss");
  $("#NegoUpload").val("");
  $(".windowdetailpss").modal("show");

  $.ajax({
    type: "POST",
    url: `${restlocpssihp}load_datapss`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {idpss: pssid },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      // console.log(obj["read_ihpev"]["status"]);
      if (obj.status == false) {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data gagal diload !",
          "error"
        );
      } else {
        
        // $(".windowdetailihp").modal("show");
        $("#NoPSS").text(obj[0]["ps_no"]);
        $("#TanggalPSS").text(obj[0]["created_date"]);
        $("#JenisProjectPSS").text(obj[0]["jenis_project"]);
        $("#ProductPSS").text(obj[0]["product"]);
        $("#ChassisPSS").text(obj[0]["chasis"]);
        $("#TypePSS").text(obj[0]["type"]);
        $("#ECNPSS").text(obj[0]["ecn_jo"]);
        $("#CFOPSS").text(obj[0]["cfo"]);
        $("#ReqPinPSS").text(obj[0]["req_pinbl"]);
        $("#QtyPSS").text(obj[0]["qty"]);
        $("#PICPSS").text(obj[0]["pic"]);
        $("#AdmPSS").text(obj[0]["pic_designer"]);
        $("#HeadofPSS").text(obj[0]["section_head"]);
        $("#NegoPSS").text(obj[0]["negosiator"]);
        $("#TitlePSS").text(obj[0]["judul_ps"]);

      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
});

$("#PrintIHPPDF").on("click", function (e) {
  var idpss = $("#PSSidx").val();
  var iditem = $("#IHPIdItem").val();
  $.redirect(
    "./?link=viewihppdf",
    { idpss: idpss, iditem: iditem },
    "POST",
    "_blank"
  );
});

//Back Close Modal
$("#NegoBack").on("click", function (e) {
  $(".windowdetailihp").modal("hide");
  $(".windowdetailpss").modal("hide");
});

$("#PSSBack").on("click", function (e) {
  $(".windowdetailihp").modal("hide");
  $(".windowdetailpss").modal("hide");
});

//Modal Window Control
$(".windowdetailihp").modal({
  autofocus: false,
});

//Modal Window Control
$(".windowdetailpss").modal({
  autofocus: false,
});


//Download xls base on filter
  $("#dwnldxls").on("click", function () {
    var iddownload= "DSG";
    var search   	= $('#fcari_report').val();
    var thnfilter = $('#fthn_reportpss').val();
    var picfilter = $('#fpic_reportpss').val();
    var prgfilter = $('#fprg_reportpss').val();
    var stsfilter = $('#fsts_reportpss').val();

    $.redirect(
      "./?link=mkgdwnldxls",
      { 
        id: iddownload,
        search: search, 
        thnfilter: thnfilter,
        picfilter: picfilter,
        prgfilter: prgfilter,
        stsfilter: stsfilter
      },
      "POST",
      "_blank"
    );
  });

  function ShortText(t){
    if(t){
      var lennamafile = t.length;
      return lennamafile > 40 ? t.substring(0, 40).concat('...') : t;
    } else {
      return '';
    }
  }

$(document).ready(function () {
  $("#tabpsslist").on("click", function () {
    window.location.href = "./?link=pss";
  });
  $("#tabihp").on("click", function () {
    window.location.href = "./?link=ihp";
  });
  $("#tabihpeval").on("click", function () {
    window.location.href = "./?link=ihpevaluation";
  });

  $('.CancelData').click(function(){
    $(".xwinaddnewpic").modal("hide");
    $(".xwinaddnewemailreceiver").modal("hide");
  });

  $("#DownloadReportingPSSExcel").on("click", function () {
    var iddownload= "PSSDESIGNER";
    var search = $("#fcari_report").val();
    var picfilter = $("#fpic_reportpss").val();
    var thnfilter = $("#fthn_reportpss").val();
    var stsfilter = $("#fsts_reportpss").val();
    var prgfilter = $("#fprg_reportpss").val();
    var ngfilter = $("#fnego_reportpss").val();
    var stspsfilter = $("#fstsps_reportpss").val();
    var pgpsfilter = $("#fprgps_reportpss").val();
    var oprfilter = $("#fopr_reportpss").val();
    var sctfilter = $("#fsect_reportpss").val();
      

    $.redirect(
      "./?link=pssreportdwnldxls",
      { 
        id: iddownload,
        search: search, 
        thnfilter: thnfilter,
        picfilter: picfilter,
        prgfilter: prgfilter,
        stsfilter: stsfilter,
        ngfilter: ngfilter,
        pgpsfilter: pgpsfilter,
        stspsfilter: stspsfilter,
        oprfilter : oprfilter,
        sctfilter : sctfilter
      }, 
      "POST",
      "_blank"
    );
  });
  
  //Load Table
  TableListFunc();

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_report").on("keyup", function () {
    var FilterCari = $("#fcari_report").val();
    var FilterNama = $("#fpic_reportpss").val();
    var FilterNego = $("#fnego_reportpss").val();
    var FilterOpr = $("#fopr_reportpss").val();
    var FilterTahun = $("#fthn_reportpss").val();
    var FilterStatus = $("#fsts_reportpss").val();
    var FilterProgress = $("#fprg_reportpss").val();
    var FilterStatusPS = $("#fstsps_reportpss").val();
    var FilterProgressPS = $("#fprgps_reportpss").val();
    var FilterSect = $("#fsect_reportpss").val();
    var FiterArry = [FilterCari, FilterNama, FilterTahun, FilterStatus, FilterProgress, FilterNego, FilterStatusPS, FilterProgressPS, FilterOpr,FilterSect];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterReportPSSRequest", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });


  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fpic_reportpss, #fthn_reportpss, #fsts_reportpss, #fprg_reportpss, #fnego_reportpss, #fstsps_reportpss, #fprgps_reportpss, #fopr_reportpss,#fsect_reportpss").on(
    "change",
    function () {
      var FilterCari = $("#fcari_report").val();
      var FilterNama = $("#fpic_reportpss").val();
      var FilterTahun = $("#fthn_reportpss").val();
      var FilterStatus = $("#fsts_reportpss").val();
      var FilterProgress = $("#fprg_reportpss").val();
      var FilterNego = $("#fnego_reportpss").val();
      var FilterOpr = $("#fopr_reportpss").val();
      var FilterStatusPS = $("#fstsps_reportpss").val();
      var FilterProgressPS = $("#fprgps_reportpss").val();
      var FilterSect = $("#fsect_reportpss").val();
      var FiterArry = [FilterCari, FilterNama, FilterTahun, FilterStatus, FilterProgress, FilterNego, FilterStatusPS, FilterProgressPS,FilterOpr,FilterSect];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterReportPSSRequest", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
      $("#CustFilterYear").text(FilterTahun);
      if(FilterNama.length === 0){
        $("#CustFilterPic").text("ALL PIC");
      }else{
        $("#CustFilterPic").text(FilterNama);
      }
      if(FilterNego.length === 0){
        $("#CustFilterNego").text("ALL Negosiator");
      }else{
        $("#CustFilterNego").text(FilterNego);
      }
      if(FilterOpr.length === 0){
        $("#CustFilterOpr").text("ALL Operator");
      }else{
        $("#CustFilterOpr").text(FilterOpr);
      }
      if(FilterStatusPS.length === 0){
        $("#CustFilterPssSts").text("ALL Status PSS");
      }else{
        $("#CustFilterPssSts").text(FilterStatusPS);
      }
      if(FilterProgressPS.length === 0){
        $("#CustFilterPssProg").text("ALL Progress PSS");
        // console.log("NULL");
      }else{
        $("#CustFilterPssProg").text(FilterProgressPS);
      }
      if(FilterStatus.length === 0){
        $("#CustFilterIhpSts").text("ALL Status IHP");
        // console.log("NULL");
      }else{
        $("#CustFilterIhpSts").text(FilterStatus);
      }
      if(FilterProgress.length === 0){
        $("#CustFilterIhpProg").text("ALL Progress IHP");
      }else{
        $("#CustFilterIhpProg").text(FilterProgress);
      }
      if(FilterSect.length === 0){
        $("#CustFilterSection").text("ALL Section");
      }else{
        $("#CustFilterSection").text(FilterSect);
      }
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#fcari_report").val("");
    // $("#fpic_reportpss").dropdown("clear");
    // $("#fsts_reportpss").dropdown("clear");
    // $("#fprg_reportpss").dropdown("clear");
    // $("#fstsps_reportpss").dropdown("clear");
    // $("#fprgps_reportpss").dropdown("clear");
    // $("#fnego_reportpss").dropdown("clear");
    // $("#fopr_reportpss").dropdown("clear");
    // $("#fthn_reportpss").dropdown("set selected", yearnow);
    // $("#fpic_reportpss").dropdown("set selected", "ALL");
    // $("#fsts_reportpss").dropdown("set selected", "ALL");
    // $("#fprg_reportpss").dropdown("set selected", "ALL");
    // $("#fstsps_reportpss").dropdown("set selected", "ALL");
    // $("#fprgps_reportpss").dropdown("set selected", "ALL");
    // $("#fnego_reportpss").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL",yearnow,"ALL", "ALL", "ALL", "ALL", "ALL", "ALL","ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterReportPSSRequest", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
    location.reload();
  });


});