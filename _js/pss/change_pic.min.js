$(".ui.dropdown").dropdown(); 
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorFinish= "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocean = decodeURIComponent(getCookie("restlocean"));
var restlocpss = decodeURIComponent(getCookie("restlocpss"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var pic   = $('#changepic').val();

if(pic != "-"){
  $('#EANRequestDiv').show();
  $('#EANList').show();
  $('#EANRequest').show();
}else{
  $('#EANList').hide();
  $('#EANRequestDiv').hide();
  $('#EANRequest').hide();
}

$('.InputDisable').hide();
$('.InputAlasan').hide();
// $("#CalTargetLunas").hide();
// $("#CalTargetPIN").hide();
// $('#EANList').DataTable().buttons().enable( false );
// TableListFunc(pic).hide();

$('#changepic').on('change', function(){

  var pic   = $('#changepic').val();
  var FilterCari = $("#fcari_ean").val();
      var FilterNama = $("#fmn_ean").val();
      var FilterStatus = $("#fsts_ean").val();
      var FiterArry = [FilterCari, FilterNama, FilterStatus, pic];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterEANRequest", JsonFilter, 5);
  // $('#EANList').DataTable().destroy();
  $('#EANRequestDiv').show();
  TableListFunc();
  $('#EANList').show();
  $('#EANRequest').show();
  $("#EANList").DataTable().page(0).draw();


});

function TableListFunc() {

  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();

  var json_str = getCookie('FilterEANRequest');
  var arr = JSON.parse(json_str);
  // console.log(json_str);
  if(json_str){
    var sfilter = arr[0];
    var mfilter = arr[1];
    var stfilter = arr[2];
    var stpic = arr[3];
  } else {
    var sfilter = "";
    var mfilter = "ALL";
    var stfilter = "ALL";
  }

  if (sfilter) {
    $("#fcari_ean").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (mfilter) {
    $("#fmn_ean").dropdown("set selected", mfilter);
    var mfilterstart = mfilter;
  } else {
    var mfilterstart = "ALL";
  }
  if (stfilter) {
    $("#fsts_ean").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    var stfilterstart = "ALL";
  }
  

  var FiterArry = [sfilterstart, mfilterstart, stfilterstart, stpic];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterEANRequest", JsonFilter, 5);

  var DTables = $("#EANList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[0, "desc"]],
    columns: [
      { data: 'ps_no' },
      { data: 'judul_ps' },
      // { data: 'GroupProduct' },
      { data: 'jenis_project' },
      { data: 'negosiator' },
      // { data: 'Chassis' },
      { data: 'pic' },
      { data: 'section_head' },
      { data: 'status_ps' },
      { data: 'progress' },
      { data: null,
        render: function (data) {
          if ((data['status_ps'] == "ACTIVE")) {
            return `<a eid="`+data['id_pss']+`" epic="`+stpic+`" class="ui small green label changePIC">Edit</a>`;
          }else {
            return ``;
          }
        },
      },
      
    ],
    columnDefs: [
      { className: "collapsing", targets: [8] },
      { orderable: false, targets: [8] },
      ],

   createdRow: function (row, data, index) {

      //WARNA PROCCESS
      if (data["RequestBy"] == Udecrypt) {
        $(row).find("td").css("color", ColorOwner);
      }

      //WARNA FINISH
      if (data["Status"] == "FINISH") {
        $(row).find("td").css("color", ColorFinish);
      }

      //WARNA CANCEL
      if (data["Status"] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }
      
    },

    ajax: {
      url: `${restlocpss}table_changepic`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        pic     : stpic,
        FSearch : sfilterstart,
        FNama   : mfilterstart,
        FStatus : stfilterstart,
      },

      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}

$("#EANList").on("click", ".EditEAN", function () {
  var IdNumE = $(this).attr("IdNumE");
  let encryption = new Encryption();
  var IdNumEnc = encryption.encrypt(IdNumE, NonceValue);
  window.location.href = "./?link=eanreqnew&i=" + IdNumEnc;
});

$("#EANList").on("click", ".SendReq", function () {
  var IdNum = $(this).attr("IdNum");
  if (IdNum){
    Swal.fire({
      title: "<h3>Kirim permintaan Barcode EAN?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}SendRequestEAN`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum  : IdNum,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              TableListFunc();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }

});

$("#EANList").on("click", ".ViewBarcode", function () {
  var IdNumV = $(this).attr("IdNumE");
  var EanCod = $(this).attr("EanCod");
  var EanTyp = $(this).attr("EanTyp");
  $(".xwinviewbarcode").modal("show");
  $('#ean_code').html('<img class="ui medium image" src="../RND_Upload/BarcodeEAN/'+EanCod+'"></img>');
  $('#ean_type').text(EanTyp);

});


$(document).ready(function () {

  $("#addnewean").on("click", function () {
    window.location.href = "./?link=eanreqnew";
  });

  $('#userguideean').on('click', function() {
    window.location.href = "./?link=guideean";
  });
  $("#addnewpss").on("click", function () {
    window.location.href = "./?link=pssheader";
  });
  $("#tabihp").on("click", function () {
    window.location.href = "./?link=ihp";
  });
  $("#tabihpeval").on("click", function () {
    window.location.href = "./?link=ihpevaluation";
  });
  $("#tabpssreport").on("click", function () {
    window.location.href = "./?link=reportingpss";
  });
  

  $('.CancelData').click(function(){
    $(".xwinviewbarcode").modal("hide");
  });

  //Load Table
  TableListFunc();

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_ean").on("keyup", function () {
    var FilterCari = $("#fcari_ean").val();
    var FilterNama = $("#fmn_ean").val();
    var FilterStatus = $("#fsts_ean").val();
    var pic = $("#fsts_ean").val();
    var FiterArry = [FilterCari, FilterNama, FilterStatus, pic];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterEANRequest", JsonFilter, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc();
    $("#EANList").DataTable().page(0).draw();
  });


  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fmn_ean, #fsts_ean").on(
    "change",
    function () {
      var FilterCari = $("#fcari_ean").val();
      var FilterNama = $("#fmn_ean").val();
      var FilterStatus = $("#fsts_ean").val();
      var pic = $("#changepic").val();
      // console.log(pic);
      var FiterArry = [FilterCari, FilterNama, FilterStatus, pic];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterEANRequest", JsonFilter, 5);
      TableListFunc();
      $("#EANList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#fcari_ean").val("");
    $("#fmn_ean").dropdown("set selected", "ALL");
    $("#fsts_ean").dropdown("set selected", "ALL");
    var pic = $("#changepic").val();
    var FiterArry = ["", "ALL", "ALL", pic];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterEANRequest", JsonFilter, 5);
    TableListFunc("", "ALL", "ALL", pic);
    $("#EANList").DataTable().page(0).draw();
  });

  // Open Modal Change PIC
$('#EANList').on("click", ".changePIC", function() {
  $('.ui.dropdown.fullsearch').dropdown( {fullTextSearch:'exact', sortSelect: true, match:'text'} );
  var eid = $(this).attr("eid");
  var epic = $(this).attr("epic");
  $("#editinputid").val(eid);
  $("#editinputpicbefore").val(epic);
  $("#PICBfr").text("Disable: "+epic);
  // $("#addcheckPIC").dropdown("set selected", "Disable User "+epic);
  $('.InputDisable').hide();
  $('.InputAlasan').hide();
  $('.ui.modal').modal('show');
  $("#changepics").dropdown("set selected", "-");
  $("#addcheckPIC").dropdown("set selected", "-");
  ChangePIC(eid);



});

$('#changepics').on('change', function() {
  var user    = $("#changepics").val();
  var pic    = $("#changepic").val();
  var vusrnm  = getCookie('usrnm');
  var vtoken  = getCookie('token');
          
  $.ajax({
    type  : "POST",
    url   : `${restlocpss}cek_changepic`,
    headers: {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      pic     : pic,
      user    : user
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      console.log(obj);
      if(isEmpty(obj)) {
        console.log('Gagal save DN Mechanical, data kosong');
      } else if(obj) {
        if (obj.status == false){
          $('.InputDisable').hide();
          $('.InputAlasan').hide();
        }  else {
          // $("#CalTargetPIN").show();
          $('.InputDisable').show();
        }
      } else {
        Swal.fire('Error','Error ?.','error')
      }
    },
    error: function(){
      //window.location.href = "./?link=loclogout";
      console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
    }
  });
});

$("#addcheckPIC").on("change", function () {
  var pin = $("#addcheckPIC").val();
  if (pin == "NO") {
    $('.InputAlasan').show();
  } else {
    $('.InputAlasan').hide();
  }
});

// Save Negosiator Note
$("#savenote").on("click", function() {
  var idpss = $("#editinputid").val();
  var picbefore = $("#changepic").val();
  var picafter = $("#changepics").val();
  var reason = $("#ReasonChange").val();
  var disable = $("#addcheckPIC").val();
  
  // console.log(changepic);
  $.ajax({
    url: `${restlocpss}change_picdesg`,
    type: "POST",
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      id_pss: idpss,
      picb : picbefore,
      pica : picafter,
      reason : reason,
      disable : disable
    },
    success: function (rsp) {
      var obj = JSON.parse(rsp);
      // console.log(obj);
          if (isEmpty(obj)) {
            console.log("Data Kosong");
          } else if (obj) {
            if (obj.status == false) {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "warning",
                showConfirmButton: false,
              });
            } else {
              Swal.fire({
                text: "Berhasil ganti PIC PSS.",
                icon: "success",
                showConfirmButton: true,
              }).then((result) => {
                if (result.value) {
                  $('.ui.modal').modal('hide');
                  $("#changepics").dropdown("clear");
                  $("#addcheckPIC").dropdown("clear");
                  $("#ReasonChange").val('');
                  location.reload();
                }
              });
            }
          } else {
            Swal.fire("Error", "Data Error ?.", "error");
          }
      
      
    },
    error: function () {
      // window.location.href = "./?link=loclogout";
      Swal.fire(
        "Error",
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
        "error"
      );
    },
  })
})

});