//Activate dropdown & tab
$(".ui.pssdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();
moment().format();

// Global Variable for Header Authorization
const NonceValue = "rdsystem2020";
const ColorOwner = "#00139f";
const ColorFinish = "#5d5d5d";
const ColorCancel = "#7c0000";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocpssihp = decodeURIComponent(getCookie("restlocpssihp"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Sdecrypt = Ucrypt.decrypt(EncS, NonceValue);
var SIHP = EncSIHP;

const ihpprogress_a = "PROCESS"; //POSISI DI OPERATOR
const ihpprogress_b = "IHP"; //POSISI DI OPERATOR SETELAH KLIK TOMBOL CREATE IHP
const ihpprogress_c = "PLACE-IN"; //OPERATOR KIRIM KE DESIGNER
const ihpprogress_d = "DESIGNER"; //DESIGNER CONFIRM
const ihpprogress_e = "REQ-APPROVAL"; //DESIGNER CLICK REQUEST SHD APPROVAL
const ihpprogress_f = "APPROVED"; //SHD APPROVED IHP
const ihpprogress_g = "-"; //STATUS FINISH-CLOSE
const ihpprogress_h = "IHP KEMBALI"; //IHP DIKEMBALIKAN KE OPERATOR MSC
const ihpprogress_i = "DONE"; //IHP SELESAI

function TableListFunc(FSearch, FYear, FIHP, FStatus) {
  console.log (FIHP);
  $("#IHPList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#IHPList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#IHPList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#IHPList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#IHPList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#IHPList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    scrollX     : true,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
    },
    order: [[1, "desc"]],
    columns: [
      {
        data: null,
        render: function (data, type, row) {
          if (data['no_ihp'] != "") {
            if (data['date_received']) {
              if (data['sign_name']) {
                return `<span class="editresult" idpss="${data['id_pss']}" iditem="${data['id_item']}" data-tooltip="View Detail IHP" data-inverted="" data-position="right center"><i class="tasks link circular icon "></i></span>`;

              } else {
                return `<span class="editresult" idpss="${data['id_pss']}" iditem="${data['id_item']}" data-tooltip="Edit IHP Evaluation" data-inverted="" data-position="right center"><i class="edit outline link circular teal icon "></i></span>`;
              }
            } else {
              return `<span class="confirmreceive" idpss="${data['id_pss']}" iditem="${data['id_item']}" data-tooltip="Konfirmasi IHP diterima" data-inverted="" data-position="right center"><i class="handshake outline circular violet icon link"></i></span>`;
            }
          } else {
            return "";
          }
        },
      },
      { data: 'tanggal_ihp' },
      {
        data: null,
        render: function (data, type, row) {
          if (data['note'] != "") {
            return `<div data-tooltip='${data['note']}' data-position='bottom left'><u>${data['no_ihp']}</div>`;
          } else {
            return data['no_ihp'];
          }
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          if (data['note'] != "") {
            return `<div data-tooltip='${data['note']}' data-position='bottom left'><u>${data['description_item']}</div>`;
          } else {
            return data['description_item'];
          }
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          if (data['file_upload'] != "") {
              return `<span class="viewspeclist" data-tooltip="View Spec - ${data['file_upload']}" data-inverted="" data-position="right center" spec="${data['file_upload']}" idpss="${data['id_pss']}" iditem="${data['id_item']}"><i class="file circular red icon link"></i></span>`;
          } else {
            return ``;
          }
        },
      },
      { data: 'vendor' },
      { data: 'vendor_material_number' },
      { data: 'product' },
      { data: 'chasis' },
      { data: 'type' },
      { data: 'qty_confirm' },
      { data: 'designer' },
      { data: 'checker' },
      { data: 'status_item' },
      { data: 'date_received' },
      {
        data: null,
        render: function (data, type, row) {
          if (data['status_result'] == "" || data['status_result'] == null) {
            return ``;
          } else {
            return `<i class="check icon"></i>`;
          }
        },
      },
    ],
    columnDefs: [
      { className: "center aligned", targets: [0, 4, 10, 13, 15] },
      { targets: [0], orderable: false },
      { targets: [1, 14],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YYYY');
          } else {
            return '';
          }
        }
      }
    ],
    createdRow: function (row, data, index) {

      //WARNA OWNER & STATUS ACTIVE/DRAFT
      if (data['checker'] == Udecrypt && data['status_item'] == "ACTIVE") {
        $(row).find("td").css("color", ColorOwner);
      }
    },

    ajax: {
      url: `${restlocpssihp}table_ihpevbag`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FYear: FYear,
        FIHP: FIHP,
        FStatus: FStatus,
        User: Udecrypt,
        Section: Sdecrypt,
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    },
  });
}


// //download spec
// $("#IHPList").on("click", ".downloadspec", function () {
//   var spec = $(this).attr("spec");
//   $.redirect(
//     "../RND_Upload/SpecOperator/"+spec,
//     { spec: spec},
//     "POST",
//     "_blank"
//   );
// });





$("#IHPList").on("click", ".viewspeclist", function () {
  $(".windowspecsupplier").modal("show");
  var idpss = $(this).attr("idpss");
  var iditem = $(this).attr("iditem");
  // var idpss = $("#PSSidx").val();
  // var iditem = $("#IHPidx").val();

  $.ajax({
    type: "POST",
    url: `${restlocpssihp}read_spec`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      idpss: idpss,
      iditem: iditem,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        console.log("Gagal load, data kosong");
        return false;
      } else if (obj) {

        if (obj.status == false) {
          $("#SpecList").empty();
        } else {
          jmlData = obj.length;
          $("#SpecList").empty();
          for (a = 0; a < jmlData; a++) {
            var filelink = "<a target='_blank' href='../RND_Upload/SpecOperator/"+obj[a]["file"]+"'>";
            var namafile = obj[a]["file"];

            if (obj[a]["note_spec"] == "" || obj[a]["note_spec"]==null){
              var note ="";
            } else {
              var note = obj[a]["note_spec"];
            }

            $("#TableSpecList").find("tbody").append(
                "<tr><td class='center'>" +
                  obj[a]["created_date"] +
                  "</td><td class='center'>" +
                  filelink+namafile +
                  "</a>" +
                  "</td><td class='center'>" +
                  note +
                  "</td></tr>"
              );
          }
        }
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
     // window.location.href = "./?link=loclogout";
      Swal.fire(
        "Error",
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
        "error"
      );
    },
  });
});




//Click Icon Edit item IHP
$("#IHPList").on("click", ".editresult", function () {
  var iditem = $(this).attr("iditem");
  var idpss = $(this).attr("idpss");
  $.redirect(
    "./?link=ihpevresult",
    {
      iditem: iditem,
      idpss: idpss,
    },
    "POST"
  );
});

//Click Confirm Receive
$("#IHPList").on("click", ".confirmreceive", function () {
  var idpss = $(this).attr("idpss");
  var iditem = $(this).attr("iditem");
  Swal.fire({
    title: "<h3>Terima dan Proses IHP ini ?</h3>",
    text:
      "Pastikan anda telah menerima material yang sesuai dengan No IHP ini.",
    icon: "question",
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type: "POST",
        url: `${restlocpssihp}confirm_ihp`,
        headers: {
          user: vusrnm,
          token: vtoken,
        },
        data: {
          iditem: iditem,
          idpss: idpss,
          section: Sdecrypt,
          user: Udecrypt,
          SIHP: SIHP,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(JSON.parse(response));
          if (obj.status == false) {
            Swal.fire(
              "Error",
              "Ada kendal di koneksi/database, data tidak tersimpan !",
              "error"
            );
          } else {
            Swal.fire({
              title: "Received !",
              timer: 1500,
              position: "top-end",
              icon: "success",
              showConfirmButton: false,
            });
            var sfi = getCookie("sfilihp");
            var tfi = getCookie("tfilihp");
            var ifi = getCookie("ifilihp");
            var stf = getCookie("stfilihp");
            TableListFunc(sfi, tfi, ifi, stf);
          }
        },
        error: function () {
          window.location.href = "./?link=loclogout";
          Swal.fire(
            "Error",
            "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
            "error"
          );
        },
      });
    }
  });
});

//RESPON KETIKA INPUT PENCARIAN DI KETIK
$("#filtercari").on("keyup", function () {
  var FilterCari = $("#filtercari").val();
  var FilterTahun = $("#filtertahun").val();
  var FilterIHP = $("#filterihp").val();
  var FilterStatus = $("#filterstatus").val();
  setCookie("sfilihp", FilterCari, 5);
  setCookie("tfilihp", FilterTahun, 5);
  setCookie("ifilihp", FilterIHP, 5);
  setCookie("stfilihp", FilterStatus, 5);
  $("#IHPList").DataTable().destroy();
  TableListFunc(FilterCari, FilterTahun, FilterIHP, FilterStatus);
});

//RESPON KETIKA FILTER TAHUN DI RUBAH
$("#filtertahun, #filterihp, #filterstatus").on("change", function () {
  var FilterCari = $("#filtercari").val();
  var FilterTahun = $("#filtertahun").val();
  var FilterIHP = $("#filterihp").val();
  var FilterStatus = $("#filterstatus").val();
  setCookie("sfilihp", FilterCari, 5);
  setCookie("tfilihp", FilterTahun, 5);
  setCookie("ifilihp", FilterIHP, 5);
  setCookie("stfilihp", FilterStatus, 5);
  $("#IHPList").DataTable().destroy();
  TableListFunc(FilterCari, FilterTahun, FilterIHP, FilterStatus);
});

//RESET FILTER
$(".resetfilter").on("click", function () {
  var d = new Date();
  var yearnow = d.getFullYear();
  $("#filtercari").val("");
  $("#filtertahun").dropdown("set selected", yearnow);
  $("#filterihp").dropdown("set selected", "ALL");
  $("#filterstatus").dropdown("set selected", "ALL");
  setCookie("sfilihp", "", 5);
  setCookie("tfilihp", yearnow, 5);
  setCookie("ifilihp", "ALL", 5);
  setCookie("stfilihp", "ALL", 5);
  $("#IHPList").DataTable().destroy();
  TableListFunc("", yearnow, "ALL", "ALL");
});

$(document).ready(function () {

  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();
  var sfilter = getCookie("sfilihp");
  var tfilter = getCookie("tfilihp");
  var ifilter = getCookie("ifilihp");
  var stfilter = getCookie("stfilihp");

  if (sfilter) {
    $("#filtercari").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    setCookie("sfilihp", "", 5);
    var sfilterstart = "";
  }
  if (tfilter) {
    $("#filtertahun").dropdown("set selected", tfilter);
    var tfilterstart = tfilter;
  } else {
    setCookie("tfilihp", yearnow, 5);
    var tfilterstart = yearnow;
  }
  if (ifilter) {
    $("#filterihp").dropdown("set selected", ifilter);
    var ifilterstart = ifilter;
  } else {
    setCookie("ifilihp", "ALL", 5);
    var ifilterstart = "ALL";
  }
  if (stfilter) {
    $("#filterstatus").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    setCookie("stfilihp", "ALL", 5);
    var stfilterstart = "ALL";
  }

  //Load Table
  // TableListFunc(sfilterstart, tfilterstart, ifilterstart, stfilterstart);
  if(LinkNoIHP){
    TableListFunc(LinkNoIHP, "ALL", "ALL", "ALL");
    $("#filtercari").val(LinkNoIHP);
    $("#filtertahun").dropdown("set selected", "ALL");
    $("#filterihp").dropdown("set selected", "ALL");
    $("#filterstatus").dropdown("set selected", "ALL");
  } else {
    TableListFunc(sfilterstart, tfilterstart, ifilterstart, stfilterstart);
  }

  $("#tabihp").on("click", function () {
    window.location.href = "./?link=ihp";
  });

  // Download XLS
  $("#dwnldxls").on('click', function() {
    var iddownload = "IHPCHECKER";
    var search = $('#filtercari').val();
    var thnfilter = $('#filtertahun').val();
    var ihpfilter = $('#filterihp').val();
    var stsfilter = $('#filterstatus').val();

    $.redirect(
      "./?link=ihpdwnldxls",
      {
        id: iddownload,
        section: EncSIHP,
        search: search,
        thnfilter: thnfilter,
        ihpfilter: ihpfilter,
        stsfilter: stsfilter
      },
      "POST",
      "_blank"
    )
  })
});
