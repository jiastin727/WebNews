//Const 
const NonceValue = "rdsystem2020";
const CancelPss = "#CancelSave";
const CancelPssSHD = "#CancelSHDSave";
const ReqFinish = "#ReqFinish";
const ReqClose = "#ReqClose";
const ReqWait2Active = "#Reqwait2active";
const ActivatedPss = "#activatepss";
const ToggleHeader = "#togleheader";
const ChangeNegosiator = "#HeaderNegosiator";
const CountCharLeft = "#EditItemDescription";
const CountCharLeft2 = "#AddSubItemDescription";
const SignDesigner = "#psssigndesigner";
const SignSecHead = "#psssignsechead";
const SignMSC = "#psssignmsc";

//Activate dropdown & tab
$(".ui.pssdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();
$(".changenego").dropdown({
  selectOnKeydown: false,
});
moment().format();

// Global Variable for Header Authorization
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocpss = decodeURIComponent(getCookie("restlocpss"));
var restlocpssneg = decodeURIComponent(getCookie("restlocpssneg"));
var filelocpss = decodeURIComponent(getCookie("filelocpss"));
var restlocpscxls = decodeURIComponent(getCookie("restlocpscxls"));

//Read Encryption Data Value
var EncValue = $("#EncValue").val();
let EDCrypt = new Encryption();
var ValuesCode = EDCrypt.decrypt(EncValue, NonceValue);
var Values = ValuesCode.split("|");
var Username = Values[0];
var StatusPSS = Values[1];
var StatusDelItem = Values[2];
var ResultSign = Values[3];
var EditingRole = Values[4];
var PSSID = Values[5];
var NoPSS = Values[6];
var StatusFinish = Values[7];

// Change Negosiator
$(ChangeNegosiator).on("change", function () {
  var idpss = PSSID;
  var nego = $(ChangeNegosiator).val();
  var user = Username;
  $.ajax({
    type: "POST",
    url: `${restlocpss}change_negosiator`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      idpss: idpss,
      nego: nego,
      user: user,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(JSON.parse(response));
      if (isEmpty(obj)) {
        console.log("Gagal Simpan mas brooo, data error");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "warning",
            showConfirmButton: false,
          });
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "success",
            showConfirmButton: false,
          });
        }
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
  //set focus on pss add item button
  $("#pssadditem").focus();
});

//Function Count Character left
$(CountCharLeft).keyup(function () {
  FCountCharLeft();
});
$(CountCharLeft2).keyup(function () {
  FCountCharLeft2();
});
//hide-show Char, Left
$(CountCharLeft).on("focus", function () {
  $("#charleft").show();
});
$(CountCharLeft).on("blur", function () {
  $("#charleft").hide();
});
$(CountCharLeft2).on("focus", function () {
  $("#charleft2").show();
});
$(CountCharLeft2).on("blur", function () {
  $("#charleft2").hide();
});
function FCountCharLeft() {
  var maxLength = 40;
  var textlen = maxLength - $(CountCharLeft).val().length;
  $(".char-count").text(textlen + "/40");
  if (textlen < 10) {
    $(".char-count").removeClass("grey").addClass("red");
  } else {
    $(".char-count").removeClass("red").addClass("grey");
  }
}
function FCountCharLeft2() {
  var maxLength = 40;
  var textlen2 = maxLength - $(CountCharLeft2).val().length;
  $(".char-count2").text(textlen2 + "/40");
  if (textlen2 < 10) {
    $(".char-count2").removeClass("grey").addClass("red");
  } else {
    $(".char-count2").removeClass("red").addClass("grey");
  }
}

//Function Remove Last comma
function removeLastComma(str) {
  return str.replace(/,(\s+)?$/, "");
}

//Datepicker
function DatePicker(IdTanggal) {
  var today = new Date();
  $(IdTanggal).calendar({
    type: "date",
    //monthFirst: false,
    //minDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return year + "-" + month + "-" + day;
      },
    },
  });
}

//Function Read Data Item PSS
function ReadItemPSSTable() {
  var idpss = PSSID;
  var user = Username;

  $.ajax({
    type: "POST",
    url: `${restlocpss}table_itempss`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      user: user,
      idpss: idpss,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        console.log("-Empty-");
        $("#ItemListPSStbody").empty();

        $(".changestspss").on("click", function (e) {
          $(".windowchangestatuspss").modal("show");
          $("#ReqFinish").addClass('disabled');
          $("#ReqClose").show();
          $("#cancelpss").show();
        });
        return false;

      } else if (obj) {
        jmlData = obj.length;
        $("#ItemListPSStbody").empty();
        var farr = [];

        if (StatusPSS == "CANCEL") {
          var actdelete = "";
          var delicon = "";
          var finishitem = "";
        } else {
          if (StatusDelItem) {
            var actdelete = "actdelete";
            var delicon = "iconcoloredit icon";
          } else {
            var actdelete = "";
            var delicon = "";
          }

          if (StatusFinish) {
            var finishitem = "finishitem";
            var delicon = "iconcoloredit icon";
          }else {
            var finishitem = "";
            var delicon = "";
          }
        }

        for (a = 0; a < jmlData; a++) {
          farr.push(obj[a]["status_item"]);
          if (
            ResultSign == 0 &&
            StatusPSS != "CANCEL" &&
            EditingRole == "editnegosiator"
          ) {
            if (obj[a]["no_itempss"] !== obj[a]["refer_noitem"]){
              var editicon = "<span class='actedit' id='"+obj[a]["id_item"]+"' data-tooltip='Edit Item' data-inverted='' data-position='top left'><i class='pencil alternate link circular teal icon'></i></span>";
            } else {
              // var editicon = "";
              var editicon ="<span class='actadditem' id='" +obj[a]["id_item"] +"' data-tooltip='Add new sub-item Negosiator' data-inverted='' data-position='top left'><i class='plus square outline link circular blue icon'></i></span>";

            }
            var icon = "";
            var tahap = obj[a]["tahap"];            
            var vendor = obj[a]["vendor"];

            if (tahap == null) {
            var  tahap = "";
            }
            if (vendor == null) {
              var  vendor = "";
              }

            if (obj[a]["no_itempss"] == obj[a]["refer_noitem"]) {
              var delitem = "";
              // var addplus ="<span class='actadditem' id='" +obj[a]["id_item"] +"' data-tooltip='Add new sub-item Negosiator' data-inverted='' data-position='top left'><i class='plus square outline link circular teal icon'></i></span>";
              var addplus ="";
              var subitem = "";

              if (obj[a]["no_ihp"] || obj[a]["no_ihp"] !== null) {
                var delitem = "";
                var finitem = "";
              } else {
                if(obj[a]["status_item"] == "FINISH"){
                  var finitem = "";
                }else{
                  if (obj[a]["no_itempss"] !== obj[a]["refer_noitem"]){
                    var finitem ="<span class='"+finishitem+"' nm='"+obj[a]["description_item"]+"' id='"+obj[a]["id_item"]+"' data-tooltip='Set Item to Finish' data-inverted='' data-position='top right'><i class='flag checkered circular teal icon "+finishitem+"' ></i></span>";
                  } else {
                    var finitem = "";
                  }
                }
              }

              // if (obj[a]["link_documents"] !== "") {
              //   var link = "<a target='_blank' href='" + obj[a]["link_documents"] +"'><i class='linkify icon'></i>";
              //   var upload = "";
              // } else if (obj[a]["file"] !== null && obj[a]["file"] !== "") {
              //   var link = "<a target='_blank' href='" +filelocpss +obj[a]["file"] +"'><i class='sticky note outline red outline icon'></i>";
              //   var upload ="<i class='actupload upload iconcoloredit icon' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"'></i>";
              // } else {
              //   var link = "<span class='nospecxxx '>";
              //   var upload ="<i class='actupload upload iconcoloredit icon' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"'></i>";
              // }

              if ((obj[a]["link_documents"] !== null && obj[a]["link_documents"] !== "") || (obj[a]["nama_file"] !== null && obj[a]["nama_file"] !== "")) {
                var link ="<span class='listspec' iditem='"+obj[a]["id_item"]+"'><i class='file outline red icon'></i></span>";
                // var upload ="<i class='actupload upload circular link teal icon' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"'></i>";
                if (obj[a]["no_itempss"] !== obj[a]["refer_noitem"]){
                  var upload ="<span class='actupload' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"' data-tooltip='Upload Spec/Drawing' data-inverted='' data-position='right center'><i class='upload link circular teal icon'></i></span>";
                } else {
                  var upload ="";
                }


              } else {
                var link = "";
                // var upload ="<i class='actupload upload circular link teal icon' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"'></i>";
                if (obj[a]["no_itempss"] !== obj[a]["refer_noitem"]){
                  var upload ="<span class='actupload' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"' data-tooltip='Upload Spec/Drawing' data-inverted='' data-position='right center'><i class='upload link circular teal icon'></i></span>";
                } else {
                  var upload ="";
                }

              }


            } else {
              var addplus = "<span class='subinfo'>SUB</span>";
              var subitem = "subitem";

              if (obj[a]["no_ihp"] || obj[a]["no_ihp"] !== null) {
                var delitem = "";
                var finitem = "";
              } else {
                if(obj[a]["status_item"] == "FINISH"){
                  var finitem = "";
                }else{
                  // var finitem ="<i class='flag checkered "+finishitem+" "+delicon+"' nm='"+obj[a]["description_item"]+"' id='"+obj[a]["id_item"]+"'></i>";

                  var finitem ="<span class='"+actdelete+"' nm='"+obj[a]["description_item"]+"' id='"+obj[a]["id_item"]+"' data-tooltip='Set Item to Finish' data-inverted='' data-position='top right'><i class='flag checkered circular teal icon "+finishitem+"' ></i></span>";

                }
                // var delitem ="<i class='trash red "+actdelete+" "+delicon+"' nm='"+obj[a]["description_item"]+"' id='"+obj[a]["id_item"]+"'></i>";

                var delitem ="<span class='"+actdelete+"' nm='"+obj[a]["description_item"]+"' id='"+obj[a]["id_item"]+"' data-tooltip='Hapus Item' data-inverted='' data-position='top right'><i class='trash circular red "+delicon+"' ></i></span>";

              }

              // if (obj[a]["link_documents"] !== "") {
              //   var link =
              //     "<a target='_blank' href='" +
              //     obj[a]["link_documents"] +
              //     "'><i class='linkify icon'></i>";
              //   var upload = "";
              // } else if (obj[a]["file"] !== null && obj[a]["file"] !== "") {
              //   var link =
              //     "<a class='subitema' target='_blank' href='" +
              //     filelocpss +
              //     obj[a]["file"] +
              //     "'><i class='sticky note outline red outline icon'></i>";
              //   var upload =
              //     "<i class='actupload upload iconcoloredit icon' namaitem='" +
              //     obj[a]["description_item"] +
              //     "' iditem='" +
              //     obj[a]["id_item"] +
              //     "'></i>";
              // } else {
              //   var link = "<span class='nospecxxx subitema'>";
              //   var upload =
              //     "<i class='actupload upload iconcoloredit icon' namaitem='" +
              //     obj[a]["description_item"] +
              //     "' iditem='" +
              //     obj[a]["id_item"] +
              //     "'></i>";
              // }


              if ((obj[a]["link_documents"] !== null && obj[a]["link_documents"] !== "") || (obj[a]["nama_file"] !== null && obj[a]["nama_file"] !== "")) {
                var link ="<span class='listspec' iditem='"+obj[a]["id_item"]+"'><i class='file outline red icon'></i></span>";
                // var upload ="";

              } else {
                var link = "";
                // var upload ="<span class='actupload' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"' data-tooltip='Upload Spec/Drawing' data-inverted='' data-position='right center'><i class='upload link circular teal icon'></i></span>";
            }
            
            var upload ="<span class='actupload' namaitem='" +obj[a]["description_item"] +"' iditem='" +obj[a]["id_item"] +"' data-tooltip='Upload Spec/Drawing' data-inverted='' data-position='right center'><i class='upload link circular teal icon'></i></span>";


            }


            if(((obj[a]["eta_confirm"]) !== null) && (obj[a]["qty_confirm"]) !==null) {
              if (obj[a]["nama_operator"]) {
                var oprn =
                  obj[a]["nama_operator"].length > 10
                    ? obj[a]["nama_operator"].substring(0, 10) + "..."
                    : obj[a]["nama_operator"];
                var oprname = "<a class='ui mini basic teal label selectopr' iditem='"+obj[a]["id_item"]+"' nmopr='"+obj[a]["nama_operator"]+"'>"+oprn+"</a>";
              } else {
                var oprname = "<a class='ui mini teal label selectopr' iditem='"+obj[a]["id_item"]+"' nmopr='"+obj[a]["nama_operator"]+"'>SELECT OPR</a>";
              }
            } else {
              var oprname = "";
            }



          } else {
            if (obj[a]["no_itempss"] !== obj[a]["refer_noitem"]) {
              var icon = "<i class='vertically flipped share grey icon '></i>";
              var subitem = "subitem";
            } else {
              var subitem = "";
              var icon = "";
            }

            // if (obj[a]["link_documents"] !== "") {
            //   var link =
            //     "<a  target='_blank' href='" +
            //     obj[a]["link_documents"] +
            //     "'><i class='linkify icon'></i>";
            //   //var upload = "a";
            // } else if (obj[a]["nama_file"] !== null && obj[a]["nama_file"] !== "") {
            //   var link =
            //     "<a  target='_blank' href='" +
            //     filelocpss +
            //     obj[a]["file"] +
            //     "'><i class='sticky note outline red outline icon'></i>";
            //   //var upload = "<i class='actupload upload iconcoloredit icon' namaitem='"+obj[a]["description_item"]+"' iditem='"+obj[a]["id_item"]+"'></i>";
            // } else {
            //   var link = "<span class='nospecxxx '>";
            //   //var upload = "<i class='actupload upload iconcoloredit icon' namaitem='"+obj[a]["description_item"]+"' iditem='"+obj[a]["id_item"]+"'></i>";
            // }

            if ((obj[a]["link_documents"] !== null && obj[a]["link_documents"] !== "") || (obj[a]["nama_file"] !== null && obj[a]["nama_file"] !== "")) {
              var link ="<span class='listspec' iditem='"+obj[a]["id_item"]+"'><i class='file outline red icon'></i></span>";
            } else {
              var link = "";
            }


            if(((obj[a]["eta_confirm"]) !== null) && (obj[a]["qty_confirm"]) !==null) {
              if (obj[a]["nama_operator"]) {
                var oprn =
                  obj[a]["nama_operator"].length > 10
                    ? obj[a]["nama_operator"].substring(0, 10) + "..."
                    : obj[a]["nama_operator"];
                var oprname = "<a class='ui mini basic green label'>"+oprn+"</a>";
              } else {
                var oprname = "";
              }
            } else {
              var oprname = "";
            }


            var editicon = "";
            // var editlink = "";
            var addplus = "";
            var upload = "";
            var delitem = "";
            var finitem = "";
          }

          var tahap = obj[a]["tahap"];
          var vendor = obj[a]["vendor"];

            if (tahap == null) {
            var  tahap = "";
            }

            if (vendor == null) {
              var  vendor = "";
              }

          if (obj[a]["req_pinbl"] == "LENGKAP") {
            var pin = "L";
          } else {
            var pin = obj[a]["req_pinbl"];
          }

          if (obj[a]["status_item"] == "CANCEL") {
            var disabledd = "disabled";
          } else if (obj[a]["status_item"] == "CLOSE") {
            var disabledd = "disabled";
          } else {
            var disabledd = "";
          }
          var note = obj[a]["note"];

//eta_confirm qty_confirm

        //   if(((obj[a]["eta_confirm"]) !== null) && (obj[a]["qty_confirm"]) !==null) {
        //   if (obj[a]["nama_operator"]) {
        //     var oprn =
        //       obj[a]["nama_operator"].length > 10
        //         ? obj[a]["nama_operator"].substring(0, 10) + "..."
        //         : obj[a]["nama_operator"];
        //     var oprname = "<a class='ui mini basic green label selectopr' iditem='"+obj[a]["id_item"]+"' nmopr='"+obj[a]["nama_operator"]+"'>"+oprn+"</a>";
        //   } else {
        //     var oprname = "<a class='ui mini green label selectopr' iditem='"+obj[a]["id_item"]+"' nmopr='"+obj[a]["nama_operator"]+"'>SELECT OPR</a>";
        //   }
        // } else {
        //   var oprname = "";
        // }
          
          if (obj[a]["status_item"] == null) {
            obj[a]["status_item"] = "";
          }



          $("#ItemListPSS")
            .find("tbody")
            .append(
              "<tr class='"+subitem +"' id='"+a+"'>"+
                "<td>"+editicon+"</td>"+
                // "<td><span class='actedit' id='"+obj[a]["id_item"]+"' data-tooltip='Edit Item' data-inverted='' data-position='top left'><i class='pencil alternate link circular teal icon'></i></span></td>"+
                "<td>"+addplus +"</td>"+
                "<td>"+icon+link+"</a>"+obj[a]["description_item"]+"</span>"+"</td>"+
                "<td class='"+disabledd+"'>"+upload+"</td>"+
                "<td class='"+disabledd+"' style='text-align: center;'>"+tahap+"</td>"+
                "<td class='"+disabledd+"'>"+obj[a]["status_item"]+"</td>"+
                "<td class='"+disabledd+"'>"+vendor+"</td>"+
                "<td class='"+disabledd+"'>"+obj[a]["vendor_material_number"]+"</td>"+
                "<td class='"+disabledd+"'>"+obj[a]["plant"]+"</td>"+
                "<td class='"+disabledd+"'>"+obj[a]["sloc"]+"</td>"+
                "<td class='"+disabledd+"'>"+obj[a]["qty_sample"]+" <sub>"+obj[a]["base_unit"]+"</sub></td>"+
                "<td class='"+disabledd+"'>"+moment(obj[a]["eta_sample"]).format('ddd, DD MMM YYYY')+"</td>"+
                "<td class='"+disabledd+"'>"+pin+"</td>"+
                "<td class='"+disabledd+"'>"+note+"</td>"+
                "<td class='"+disabledd+"'>"+oprname+"</td>"+
                "<td style='text-align: center;'>"+delitem+"</td>"+
                "<td style='text-align: center;'>"+finitem+"</td>"+
              "</tr>"
            );
        }
      }

      //cek untuk menentukan tombol request finish bisa ditampilkan atau tidak      
      if (farr.includes("CLOSE") || farr.includes("CANCEL") || farr.includes("ACTIVE") || farr.includes(null)){
        var inforeqfinish = "forbidden";
      } else {
        var inforeqfinish = "allowed";
      }
      DelItemPSSTable();
      FinishItemPSSTable();
      UploadSpec();
      EditItemPSSTable();
      AddNewItemPSSTable();
      SpecDrwList();
      SelectOpr();

      $(".changestspss").on("click", function (e) {
        $(".windowchangestatuspss").modal("show");
        console.log(inforeqfinish);
        if(inforeqfinish =="forbidden"){
          $("#ReqFinish").addClass('disabled');
          $("#ReqClose").show();
          $("#cancelpss").show();
        } else {
          $("#ReqFinish").removeClass('disabled');
          $("#ReqClose").hide();
          $("#cancelpss").hide();
        }
      });

    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
}

//Function Read All Data Item PSS untuk Show Detail
function ReadAllItem() {
  var idpss = PSSID;
  $.ajax({
    type: "POST",
    url: `${restlocpss}read_itempss`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: { idpss: idpss },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        console.log("Gagal load, data kosong");
        return false;
      } else if (obj) {
        jmlData = obj.length;
        $("#DetailItemData").empty();
        for (a = 0; a < jmlData; a++) {
          if (obj[a]["file"] !== null && obj[a]["file"] !== "") {
            var file = "<i class='check icon'></i>";
          } else {
            var file = "";
          }
          if (
            obj[a]["link_documents"] !== null &&
            obj[a]["link_documents"] !== ""
          ) {
            var linkdoc = "<i class='check icon'></i>";
          } else {
            var linkdoc = "";
          }
          $("#DetailItem")
            .find("tbody")
            .append(
              "<tr><td>" +
                obj[a]["description_item"] +
                "</td><td>" +
                obj[a]["vendor_material_number"] +
                "</td><td>" +
                obj[a]["plant"] +
                "</td><td>" +
                obj[a]["sloc"] +
                "</td><td>" +
                obj[a]["qty_sample"] +
                "</td><td>" +
                obj[a]["base_unit"] +
                "</td><td>" +
                obj[a]["eta_sample"] +
                //"</td><td>"+moment(obj[a]["eta_sample"]).format("DD/MM/YY")+
                "</td><td>" +
                obj[a]["reference_material"] +
                "</td><td>" +
                obj[a]["std_used"] +
                "</td><td>" +
                obj[a]["note"] +
                "</td><td>" +
                obj[a]["pic_vendor_inhouse"] +
                "</td><td>" +
                linkdoc +
                "</td><td>" +
                file +
                "</td><td>" +
                obj[a]["currency"] +
                "</td><td>" +
                obj[a]["target_price"] +
                "</td><td>" +
                obj[a]["lead_time_part"] +
                "</td></tr>"
            );
        }
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
}

//------v-----------------------------------------------------------------------------------------------------


//Function Spec/Drawing List
function SpecDrwList() {
  $(".listspec").on("click", function (e) {
    $(".windowdrwspec").modal("show");
    var iditem = $(this).attr("iditem");

    $.ajax({
      type: "POST",
      url: `${restlocpss}read_reportdrawing`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        iditem: iditem
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(response);
        if (isEmpty(obj)) {
          console.log("Gagal load, data kosong");
          return false;
        } else if (obj) {
          jmlData = obj.length;
          $("#SpecList").empty();
          for (a = 0; a < jmlData; a++) {
            
            if(obj[a]["link_documents"]!==null && obj[a]["link_documents"]){
              var iconlink = "<i class='linkify icon'></i>";
            } else {
              obj[a]["link_documents"] ="";
              var iconlink = "";
            }
            
            if (obj[a]["nama_file"]!==null && obj[a]["nama_file"]){
              var filename = obj[a]["nama_file"].replace("SpecDesigner/", "");
              var fname = filename.split('_');
              var filen = fname[2];
              var iconfile = "<i class='file outline red icon'></i>";
            } else {
              var filen = "";
              var iconfile = "";
            }
            
            $("#TableSpecList").find("tbody").append(
              "<tr><td>" +
                moment(obj[a]["created_date"]).format('ddd, DD MMM YYYY') +
                "</td><td class='center'><a href='"+obj[a]["link_documents"]+"' target='_blank'>" +iconlink+
                obj[a]["link_documents"] +
                "</td><td class='center'><a href='../RND_Upload/"+obj[a]["nama_file"]+"' target='_blank'>" +iconfile+
                filen +"</a>"+
                "</td><td class='center'>"+
                obj[a]["user"] +
                "</td></tr>"
            );
          }
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });


  });
}


//Function Select Operator
function SelectOpr() {
  $(".selectopr").on("click", function (e) {
    $(".windowselopr").modal("show");
    var iditem = $(this).attr("iditem");
    var nmopr = $(this).attr("nmopr");

    $("#EditItemOpr").dropdown("clear");
    $("#EditItemOpr").dropdown("set selected", nmopr);
    $("#EditIdItemReq").val(iditem);

  });
}



//Function Read All Data Item PSS
function ReadHistoryNego() {
  var idpss = PSSID;
  $.ajax({
    type: "POST",
    url: `${restlocpss}table_historynegosiator`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: { idpss: idpss },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      //console.log(obj);
      if (isEmpty(obj)) {
        console.log("Gagal load, data kosong");
        return false;
      } else if (obj) {
        jmlData = obj.length;
        $("#NegoChangeTable").empty();
        for (a = 0; a < jmlData; a++) {
          obj[0]["nego_semula"] = "";
          $("#NegoChangeList")
            .find("tbody")
            .append(
              "<tr><td>" +
                obj[a]["date"] +
                "</td><td class='center'>" +
                obj[a]["nego_semula"] +
                "</td><td class='center'>" +
                obj[a]["nego_menjadi"] +
                "</td><td class='center'>" +
                obj[a]["pic"] +
                "</td></tr>"
            );
        }
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
}


//Function Delete Item PSS
function DelItemPSSTable() {
  $(".actdelete").on("click", function (e) {
    var eid = $(this).attr("id");
    var enm = $(this).attr("nm");
    Swal.fire({
      title: "<h3>Remove Request Item</h3>",
      text: enm,
      icon: "warning",
      confirmButtonText: "Yes",
      showCancelButton: true,
      cancelButtonText: "Back",
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpss}delete_itempss`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            id_itempss: eid,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                title: "Deleted!",
                text: "Item yang anda maksud sudah dihapus dari database.",
                timer: 1500,
                position: "top-end",
                icon: "success",
                showConfirmButton: false,
              });
              ReadItemPSSTable();
            }
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            console.log(
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
            );
          },
        });
      }
    });
  });
}

//Function Finish Item PSS
function FinishItemPSSTable() {
  $(".finishitem").on("click", function (e) {
    var eid = $(this).attr("id");
    var enm = $(this).attr("nm");
    Swal.fire({
      title: "<h3>Finish Item</h3>",
      text: enm,
      icon: "warning",
      confirmButtonText: "Yes",
      showCancelButton: true,
      cancelButtonText: "Back",
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpss}finish_itempss`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            id_itempss: eid,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                title: "Finished!",
                text: "Item yang anda maksud sudah berhasil di Finish.",
                timer: 1500,
                position: "top-end",
                icon: "success",
                showConfirmButton: false,
              });
              ReadItemPSSTable();
            }
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            console.log(
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
            );
          },
        });
      }
    });
  });
}

function EditItemPSSTable() {
  $(".actedit").on("click", function (e) {
    var iditem = $(this).attr("id");

    $.ajax({
      type: "POST",
      url: `${restlocpssneg}edit_item`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: { iditem: iditem },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal load tabel, data kosong");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire(
              "Error",
              "Ada kendal di koneksi/database, data gagal diload !",
              "error"
            );
          } else {
            if (obj[0]["req_pinbl"] == "BL") {
              var pin = "PIN BELUM LENGKAP";
            } else {
              var pin = obj[0]["req_pinbl"];
            }

            if (obj[0]["target_pelunasan"] == "0000-00-00 00:00:00") {
              var tlun = "";
            } else {
              var tlun = obj[0]["target_pelunasan"];
            }

            if (obj[0]["target_pin"] == "0000-00-00 00:00:00") {
              var tpin = "";
            } else {
              var tpin = obj[0]["target_pin"];
            }

            if ((obj[0]["status_item"] == "ACTIVE") || (obj[0]["status_item"] == null)) {
              $('#CreateNewTahap').hide();
            } else {
              $('#CreateNewTahap').show();
            }

            $(".windowadditem").modal("show");
            $("#msgemailqty").text("");
            $("#TahapSample").text(obj[0]["tahap"]);
            $(".EditItemText").text("EDIT REQUEST ITEM");
            $("#EditIdItemReq").val(iditem);
            $("#EditItemDescription").val(obj[0]["description_item"]);
            $("#EditItemVendorMatNum").val(obj[0]["vendor_material_number"]);
            $("#EditItemPlant").val(obj[0]["plant"]);
            $("#EditItemQtySample").val(obj[0]["qty_sample"]);
            $("#EditItemETASample").val(obj[0]["eta_sample"]);
            $("#EditItemETAConfirm").val(obj[0]["eta_confirm"]);
            $("#EditItemSLoc").val(obj[0]["sloc"]);
            $("#EditItemBaseUnit").val(obj[0]["base_unit"]);
            $("#EditItemRefMaterial").val(obj[0]["reference_material"]);
            $("#EditItemNote").val(obj[0]["note"]);
            $("#EditItemQtyConfirm").val(obj[0]["qty_confirm"]);
            $("#EditItemPICVendorInHouse").val(obj[0]["pic_vendor_inhouse"]);
            $("#EditItemLinkDocument").val(obj[0]["link_documents"]);
            $("#EditItemPrice").val(obj[0]["target_price"]);
            $("#EditItemCurrency").dropdown("set selected", obj[0]["currency"]);
            $("#EditItemCharacteristic").dropdown("clear");
            $("#EditItemCharacteristic").dropdown(
              "set selected",
              obj[0]["lead_time_part"]
            );
            // $("#EditItemOpr").dropdown("clear");
            // $("#EditItemOpr").dropdown("set selected", obj[0]["nama_operator"]);
            $("#EditItemReqPIN").dropdown("clear");
            $("#EditItemReqPIN").dropdown("set selected", pin);
            $("#EditItemTargetLunas").val(tlun);
            $("#EditItemTargetPINECN").val(tpin);
            DatePicker("#CalETASample");
            DatePicker("#CalETAConfirm");
            DatePicker("#CalTargetLunas");
            DatePicker("#CalTargetPIN");
            FCountCharLeft();
            CreateNewTahap();

            var stsemail = obj[0]["sts_email"];
            var targetprice = obj[0]["target_price"];
            var a = Number(targetprice) + 0;
            var refmat = obj[0]["reference_material"];
            // var descriptitem = obj[0]["description_item"];
            // var etasample = obj[0]["eta_sample"];
            // var qtyconfirm = obj[0]["qty_confirm"];
            // var bu = obj[0]["base_unit"];
            // var etaconfirm = obj[0]["eta_confirm"];
            // console.log('stsemail:'+stsemail);
            // console.log('targetp:'+targetprice);
            // console.log('a:'+a);
            // console.log('refmat:'+refmat);
            // console.log('descriptitem:'+descriptitem);
            // console.log('etasample:'+etasample);
            // console.log('qtyconfirm:'+qtyconfirm);
            // console.log('bu:'+bu);
            // console.log('etaconfirm:'+etaconfirm);
            // if (
            //   obj[0]["description_item"] &&
            //   obj[0]["eta_sample"] &&
            //   obj[0]["qty_confirm"] !== null &&
            //   obj[0]["base_unit"] &&
            //   obj[0]["eta_confirm"] !== null &&
            //   stsemail == null
            // ) {
            //   if ((targetprice !== 0 && a !== 0) || refmat) {
            //     $(".SelectOpr").show(123);
            //   } else {
            //     $(".SelectOpr").hide(123);
            //   }
            // } else {
            //   $(".SelectOpr").hide(123);
            // }

            if (stsemail === "x") {
              $("#btnsaveoremail").html(
                "<div class='ui left input small'><button class='ui button teal savebtn small' id='SendEmailQty'><i class='envelope outline icon'></i>Email to Designer</button></div>"
              );
              $("#msgemailqty").html(
                "<i class='red small disabled exclamation triangle icon'></i> <i>Need to send email notification (qty confirm) to Designer</i>"
              );
              SendEmailQtytoDesigner();
            } else {
              $("#btnsaveoremail").html(
                "<div class='ui left input small savebuttonedit'><button class='ui button blue savebtn  small' id='EditItemButtonSave'><i class='save outline icon'></i>Save</button></div>"
              );
              $("#msgemailqty").html("");
              SaveItem();
            }

            // $(
            //   "#EditItemDescription, #EditItemETASample, #EditItemQtyConfirm, #EditItemBaseUnit, #EditItemETAConfirm, #EditItemRefMaterial, #EditItemPrice"
            // ).on("blur", function () {
            //   var a = $("#EditItemDescription").val();
            //   var b = $("#EditItemETASample").val();
            //   var c = $("#EditItemQtyConfirm").val();
            //   var s = $("#EditItemQtySample").val();
            //   var d = $("#EditItemBaseUnit").val();
            //   var e = $("#EditItemETAConfirm").val();
            //   var f = $("#EditItemRefMaterial").val();
            //   var g = $("#EditItemPrice").val();
            //   var z = Number(g) + 0;
            //   // console.log('c:'+c);
            //   // console.log('s:'+s);

            //   if (a && b && c && d && e && f) {
            //     if (c >= s - 1) {
            //       if ((g && z !== 0) || f) {
            //         $(".SelectOpr").show(123);
            //       } else {
            //         $(".SelectOpr").hide(123);
            //       }
            //     } else {
            //       $(".SelectOpr").hide(123);
            //     }
            //   } else {
            //     $(".SelectOpr").hide(123);
            //   }
            // });

            $("#EditItemReqPIN").on("change", function () {
              var pin = $("#EditItemReqPIN").val();
              if (pin == "BL") {
                $(".InputTarget").show(500, "linear");
                $("#EditItemTargetLunas").val(tlun);
                $("#EditItemTargetPINECN").val(tpin);
              } else {
                $(".InputTarget").hide(123);
                $("#EditItemTargetLunas").val("");
                $("#EditItemTargetPINECN").val("");
              }
            });
            var pin = $("#EditItemReqPIN").val();

            if (pin == "BL") {
              $(".InputTarget").show(500, "linear");
            } else {
              $(".InputTarget").hide(123);
            }

            //vendor autocomplete
            $(".ui.search.vendor").search({
              minCharacters: 1,
              apiSettings: {
                url: "2_psonline/_autocompleteDNSN.php?q={query}",
              },
              fields: {
                results: "data",
                title: "id",
                description: "desc",
              },
            });

            //baseunit autocomplete
            $(".ui.search.baseunit").search({
              minCharacters: 1,
              apiSettings: {
                url: "2_psonline/_autocompletebaseunit.php?q={query}",
              },
              fields: {
                results: "data",
                title: "sap",
                description: "description",
              },
            });

            //sloc autocomplete base-on plant
            $("#EditItemSLoc").focus(function () {
              var plant = $("#EditItemPlant").val();
              var splant = plant.toString();
              $(".ui.search.sloc").search({
                minCharacters: 1,
                apiSettings: {
                  url: "2_psonline/_autocompletesloc.php?q={query}&p=" + splant,
                },
                fields: {
                  results: "data",
                  title: "value",
                  description: "storage_location_name",
                },
              });
            });

            //ref-material autocomplete base-on plant
            $("#EditItemRefMaterial").focus(function () {
              var plant = $("#EditItemPlant").val();
              var splant = plant.toString();
              $(".ui.search.refmat").search({
                minCharacters: 2,
                apiSettings: {
                  url:
                    "2_psonline/_autocompletematerial.php?q={query}&p=" + splant,
                },
                fields: {
                  results: "data",
                  title: "MATNR",
                  description: "MAKTX"
                },
              });
            });

            //vendorinhouse autocomplete
            // $('.ui.search.vendorinhouse').search({
            //   minCharacters : 1,
            //   apiSettings   : {
            //     url: '2_psonline/_autocompletevendorname.php?q={query}'
            //   },
            //   fields: {
            //     results : 'data',
            //     title   : 'id',
            //     description : 'desc'
            //   },
            // });

            $("#EditItemPrice").number(true, 3);

            var day = $("#EditItemCharacteristic")
              .find(":selected")
              .attr("charday");
            $("#EditItemLeadTime").val(day);

            //Edit Characteristic Lead Time
            $("#EditItemCharacteristic").on("change", function (e) {
              var day = $("#EditItemCharacteristic")
                .find(":selected")
                .attr("charday");
              $("#EditItemLeadTime").val(day);
            });

            // var QtySampleConfirm = $("#EditItemQtyConfirm").val();
            // var EditItemOprName = $("#EditItemOpr").val();

            // if (QtySampleConfirm) {
            //   $(".EditItemOpr").removeClass("disabled").addClass("enable");
            //   $(".UpdateOperator").removeClass("disabled").addClass("enable");
            // } else {
            //   $(".EditItemOpr").removeClass("enable").addClass("disabled");
            //   $(".UpdateOperator").removeClass("enable").addClass("disabled");
            //   $("#EditItemOpr").dropdown("set selected", "-");
            // }

            //console.log(EditItemOprName);
            // if (EditItemOprName) {
            //   $(".UpdateOperator").removeClass("enable").addClass("disabled");
            // } else {
            //   $(".EditItemOpr").removeClass("disabled").addClass("enable");
            // }

            if (
              obj[0]["status_item"] == "CANCEL" ||
              obj[0]["status_item"] == "CLOSE"
            ) {
              $("#SendEmailQty").removeClass("enable").addClass("disabled");
              $("#EditItemButtonSave")
                .removeClass("enable")
                .addClass("disabled");
              //$("#UpdateOperator").removeClass("enable").addClass("disabled");
            } else {
              $("#SendEmailQty").removeClass("disabled").addClass("enable");
              $("#EditItemButtonSave")
                .removeClass("disabled")
                .addClass("enable");
              //$("#UpdateOperator").removeClass("disabled").addClass("enable");
            }
          }
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    });
  });
}

function AddNewItemPSSTable() {
  $(".actadditem").on("click", function (e) {
    var iditem = $(this).attr("id");

    $.ajax({
      type: "POST",
      url: `${restlocpssneg}edit_item`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: { iditem: iditem },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal load tabel, data kosong");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire(
              "Error",
              "Ada kendal di koneksi/database, data gagal diload !",
              "error"
            );
          } else {
            var plantss = obj[0]["plant"];
            var plantarray = plantss.split(",");
            $(".windowaddnewitem").modal("show");
            $("#IdItemAddSub").val(iditem);
            $("#AddSubItemRef").val(obj[0]["description_item"]);
            $("#AddSubItemDescription").val(obj[0]["description_item"]);
            $("#AddSubItemVendorMatNum").val(obj[0]["vendor_material_number"]);
            $("#AddSubItemPlant").dropdown("clear");
            $("#AddSubItemPlant").dropdown("set selected", plantarray);
            $("#AddSubItemQtySample").val(obj[0]["qty_sample"]);
            $("#AddSubItemETASample").val(obj[0]["eta_sample"]);
            $("#AddSubItemSLoc").val(obj[0]["sloc"]);
            $("#AddSubItemBaseUnit").val(obj[0]["base_unit"]);
            $("#AddSubItemRefMaterial").val(obj[0]["reference_material"]);
            $("#AddSubItemNote").val(obj[0]["note"]);
            $("#AddSubItemQtyConfirm").val(obj[0]["qty_confirm"]);
            $("#AddSubItemPICVendorInHouse").val(obj[0]["pic_vendor_inhouse"]);
            $("#AddSubItemLinkDocument").val(obj[0]["link_documents"]);
            $("#AddSubItemPrice").val(obj[0]["target_price"]);
            $("#AddSubItemCurrency").dropdown(
              "set selected",
              obj[0]["currency"]
            );
            $("#AddSubItemCharacteristic").dropdown("clear");
            $("#AddSubItemCharacteristic").dropdown(
              "set selected",
              obj[0]["lead_time_part"]
            );
            $("#AddSubItemOpr").dropdown("clear");
            $("#AddSubItemOpr").dropdown(
              "set selected",
              obj[0]["nama_operator"]
            );
            DatePicker("#CalETASample2");
            DatePicker("#CalETAConfirm2");

            FCountCharLeft();

            //vendor autocomplete
            $(".ui.search.vendor").search({
              minCharacters: 1,
              apiSettings: {
                url: "2_psonline/_autocompleteDNSN.php?q={query}",
              },
              fields: {
                results: "data",
                title: "id",
                description: "desc",
              },
            });

            //baseunit autocomplete
            $(".ui.search.baseunit").search({
              minCharacters: 1,
              apiSettings: {
                url: "2_psonline/_autocompletebaseunit.php?q={query}",
              },
              fields: {
                results: "data",
                title: "sap",
                description: "description",
              },
            });

            //sloc autocomplete base-on plant
            $("#AddSubItemSLoc").focus(function () {
              var plant = $("#AddSubItemPlant").val();
              var splant = plant.toString();
              $(".ui.search.sloc").search({
                minCharacters: 1,
                apiSettings: {
                  url: "2_psonline/_autocompletesloc.php?q={query}&p=" + splant,
                },
                fields: {
                  results: "data",
                  title: "value",
                  description: "storage_location_name",
                },
              });
            });

            //ref-material autocomplete base-on plant
            $("#AddSubItemRefMaterial").focus(function () {
              var plant = $("#AddSubItemPlant").val();
              var splant = plant.toString();
              $(".ui.search.refmat").search({
                minCharacters: 2,
                apiSettings: {
                  url:
                    "2_psonline/_autocompletematerial.php?q={query}&p=" + splant,
                },
                fields: {
                  results: "data",
                  title: "MATNR",
                  description: "MAKTX"
                },
              });
            });

            //vendorinhouse autocomplete
            // $('.ui.search.vendorinhouse').search({
            //   minCharacters : 1,
            //   apiSettings   : {
            //     url: '2_psonline/_autocompletevendorname.php?q={query}'
            //   },
            //   fields: {
            //     results : 'data',
            //     title   : 'id',
            //     description : 'desc'
            //   },
            // });

            $("#AddSubItemPrice").number(true, 3);

            var day = $("#AddSubItemCharacteristic")
              .find(":selected")
              .attr("charday");
            $("#AddSubItemLeadTime").val(day);

            //Add Characteristic Lead Time
            $("#AddSubItemCharacteristic").on("change", function (e) {
              var day = $("#AddSubItemCharacteristic")
                .find(":selected")
                .attr("charday");
              $("#AddSubItemLeadTime").val(day);
            });
          }
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });
}

//Function Create New Tahap Item PSS
function CreateNewTahap() {
  $("#CreateNewTahap").on("click", function (e) {
    var idpss = PSSID;
    var iditem = $("#EditIdItemReq").val();
    Swal.fire({
      title: "<h3>Create New Tahapan Sample?</h3>",
      //text  : enm,
      icon: "warning",
      confirmButtonText: "Yes",
      showCancelButton: true,
      cancelButtonText: "Back",
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpssneg}create_tahap`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            iditem: iditem,
            idpss: idpss,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                title: "Created!",
                text: "Item dengan tahapan baru sudah terbentuk.",
                timer: 1500,
                position: "center",
                icon: "success",
                showConfirmButton: false,
              });
              $(".windowadditem").modal("hide");
              ReadItemPSSTable();
            }
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            console.log(
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
            );
          },
        });
      }
    });
  });
}

//Send Email to Designer if Quantity Confirmed less than Qty Requsted
function SendEmailQtytoDesigner() {
  $("#SendEmailQty").on("click", function (e) {
    var idpss = PSSID;
    var iditem = $("#EditIdItemReq").val();
    var qtyconfirm = $("#EditItemQtyConfirm").val();
    Swal.fire({
      title: "<h3>Send Email to Designer</h3>",
      html:
        "Konfirmasi email ke Designer karena <br> Jumlah Sample yang di konfirmasi kurang dari permintaan.",
      confirmButtonText: "Yes",
      showCancelButton: true,
      cancelButtonText: "Back",
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpssneg}email_qtyconfirm`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            idpss: idpss,
            iditem: iditem,
            qtyconfirm: qtyconfirm,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                text: "Email sent",
                timer: 2000,
                toast: true,
                showConfirmButton: false,
              });
            }
            //$(".SelectOpr").show(123);
            $("#msgemailqty").text("");
            $("#btnsaveoremail").html(
              "<div class='ui left input small savebuttonedit'><button class='ui button blue savebtn small' id='EditItemButtonSave'><i class='save outline icon'></i>Save</button></div>"
            );
            SaveItem();
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            console.log(
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
            );
          },
        });
      }
    });
  });
}

//Fuction Save Edit Item
function SaveItem() {
  $("#EditItemButtonSave").on("click", function (e) {
    var psscat = "NEW";
    var pssid = PSSID;
    var iditem = $("#EditIdItemReq").val();
    var pssdesc = $("#EditItemDescription").val();
    var pssmatnum = $("#EditItemVendorMatNum").val();
    var pssplant = $("#EditItemPlant").val().toString();
    var pssqtyspl = $("#EditItemQtySample").val();
    var pssetaspl = $("#EditItemETASample").val();
    var psssloc = $("#EditItemSLoc").val();
    var pssbaseun = $("#EditItemBaseUnit").val();
    var pssrefmat = $("#EditItemRefMaterial").val();
    var pssnote = $("#EditItemNote").val();
    var psspicvih = $("#EditItemPICVendorInHouse").val();
    var psslink = $("#EditItemLinkDocument").val();
    var pssprice = $("#EditItemPrice").val();
    var psscurr = $("#EditItemCurrency").val();
    var psschar = $("#EditItemCharacteristic").val();
    var psspinbl = $("#EditItemReqPIN").val();
    var psstlun = $("#EditItemTargetLunas").val();
    var psstpin = $("#EditItemTargetPINECN").val();
    var pssetaconfirm = $("#EditItemETAConfirm").val();

    //if(iditem){
    var namares = "update_itempss";
    //} else {
    // var namares = "create_itempss";
    //}

    $.ajax({
      type: "POST",
      url: restlocpssneg + namares,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        pssid: pssid,
        iditem: iditem,
        psscat: psscat,
        pssdesc: pssdesc,
        pssmatnum: pssmatnum,
        pssplant: pssplant,
        pssqtyspl: pssqtyspl,
        pssetaspl: pssetaspl,
        psssloc: psssloc,
        pssbaseun: pssbaseun,
        pssrefmat: pssrefmat,
        pssnote: pssnote,
        psspicvih: psspicvih,
        psslink: psslink,
        pssprice: pssprice,
        psscurr: psscurr,
        psschar: psschar,
        psspinbl: psspinbl,
        psstlun: psstlun,
        psstpin: psstpin,
        pssetacon: pssetaconfirm,
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal Simpan mas brooo, data error");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            });
            $(".windowadditem").modal("hide");
            ReadItemPSSTable();
          }
        } else {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data tidak tersimpan !",
            "error"
          );
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });
}

//Update Nama Operator
$("#UpdateOperator").on("click", function (e) {
  var NamaOpr = $("#EditItemOpr").val();
  var iditem = $("#EditIdItemReq").val();
  $("#UpdateOperator").hide();
  Swal.fire({
    text: 'Diproses, untuk menghindari data terinput 2x, tombol OK di hidden,, jika selesai tombol OK akan muncul lagi..',
    timer: 3000,
    toast: true,
    showConfirmButton: false,
  });
  $.ajax({
    type: "POST",
    url: `${restlocpssneg}update_operator`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      iditem: iditem,
      namaopr: NamaOpr,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(JSON.parse(response));
      if (obj.status == false) {
        Swal.fire("", "error", "error");
      } else {
        Swal.fire({
          text: obj.message,
          timer: 3000,
          toast: true,
          showConfirmButton: false,
        });
      $("#UpdateOperator").show();

      }
      ReadItemPSSTable();
    $(".windowselopr").modal("hide");

    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
});

// Update  Qty Confirm
$("#EditItemQtyConfirm").on("change", function (e) {
  var QtySampleConfirm = $("#EditItemQtyConfirm").val();
  var qty_sample = $("#EditItemQtySample").val();
  var iditem = $("#EditIdItemReq").val();
  //$(".SelectOpr").hide(123);
  if (QtySampleConfirm) {
    if (QtySampleConfirm <= qty_sample - 1) {
      var msgemail =
        "Berhasil simpan, Tolong segera email designer karena jumlah sample yang datang kurang dari permintaan.";
      var stsemail = "x";
      $("#btnsaveoremail").html(
        "<div class='ui left input small'><button class='ui button teal savebtn small' id='SendEmailQty'><i class='envelope outline icon'></i>Email to Designer</button></div>"
      );
      $("#msgemailqty").html(
        "<i class='red small disabled exclamation triangle icon'></i> <i>Need to send email notification (qty confirm) to Designer</i>"
      );
      SendEmailQtytoDesigner();
      //$(".SelectOpr").hide(123);
    } else {
      var msgemail = "Berhasil simpan jumlah Sample (Qty Confirm)";
      var stsemail = null;
      $("#btnsaveoremail").html(
        "<div class='ui left input small savebuttonedit'><button class='ui button blue savebtn small' id='EditItemButtonSave'><i class='save outline icon'></i>Save</button></div>"
      );
      $("#msgemailqty").text("");
      SaveItem();
      //$(".SelectOpr").show(123);
    }
  } else {
    var msgemail = "Qty(Confirm) sudah kembali kosong.";
    var stsemail = null;
    //$(".SelectOpr").hide(123);
    SaveItem();
  }

  $.ajax({
    type: "POST",
    url: `${restlocpssneg}update_qtyconfirm`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      idpss: PSSID,
      iditem: iditem,
      qtyconfirm: QtySampleConfirm,
      stsemail: stsemail,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(JSON.parse(response));
      if (obj.status == false) {
        Swal.fire("", "error", "error");
      } else {
        Swal.fire({
          text: msgemail,
          timer: 3500,
          toast: true,
          showConfirmButton: false,
        });
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
});

//Function Upload File
function UploadSpec() {
  $(".actupload").on("click", function (e) {
    var idpss = PSSID;
    var iditem = $(this).attr("iditem");
    var namaitem = $(this).attr("namaitem");

    //$("#UploadedSpec").text("");
    $("#FileSpec").val("");
    $("#idpssupload").val(idpss);
    $("#iditemupload").val(iditem);
    $("#namaitem").html(`<i>${namaitem}`);
    $(".windowuploadspec").modal("show");

    // $.ajax({
    //   type: "POST",
    //   url: `${restlocpss}read_upload`,
    //   headers: {
    //     user: vusrnm,
    //     token: vtoken,
    //   },
    //   data: { iditem: iditem },
    //   cache: false,
    //   success: function (response) {
    //     var obj = JSON.parse(JSON.parse(response));
    //     if (isEmpty(obj)) {
    //       console.log("Gagal Load Data mas brooo, data error");
    //     } else if (obj) {
    //       if (obj.status == false) {
    //        // $("#UploadButtonDel").hide();
    //       } else {
    //         var filename = obj[0]["file"].replace("SpecDesigner/", "");
    //         //$("#UploadButtonDel").show();
    //         $("#NamaFile").val(filename);
    //         // $("#UploadedSpec").html(
    //         //   `<a target='_blank' href='${filelocpss}${obj[0]["file"]}'>${filename}</a>`
    //         // );
    //       }
    //     } else {
    //       Swal.fire(
    //         "Error",
    //         "Ada kendal di koneksi/database, data tidak tersimpan !",
    //         "error"
    //       );
    //     }
    //   },
    //   error: function () {
    //     window.location.href = "./?link=loclogout";
    //     Swal.fire(
    //       "Error",
    //       "Ada kendal di koneksi/database, data gagal diload !",
    //       "error"
    //     );
    //   },
    // });
  });
}

//Upload File item PSS
$("#UploadButtonSaveItem").on("click", function () {
  var file_data = $("#FileItem").prop("files")[0];
  var idpss = PSSID;
  var user = Username;
  var form_data = new FormData();
  form_data.append("import_excel", file_data);
  form_data.append("pssid", idpss);
  form_data.append("user", user);
  $.ajax({
    url: `${restlocpscxls}UploadExcelNegosiator`,
    dataType: "text",
    cache: false,
    contentType: false,
    processData: false,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: form_data,
    type: "post",
    success: function (response) {
      var obj = JSON.parse(JSON.parse(response));
      if (isEmpty(obj)) {
        console.log("Gagal Simpan mas brooo, data error");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "warning",
            showConfirmButton: false,
          });
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "success",
            showConfirmButton: false,
          });
        }
        ReadItemPSSTable();
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
      // window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
  $(".windowuploaditem").modal("hide");
});

//validasi mandatory input untuk reff material
$("#AddSubItemPrice").on("keyup", function () {
  var targetprice = $("#AddSubItemPrice").val();
  var a = Number(targetprice) + 0;
  if (targetprice && a !== 0) {
    $("#AddSubItemRefMaterial").removeClass("mandatoryclass");
  } else {
    $("#AddSubItemRefMaterial").addClass("mandatoryclass");
  }
});

//validasi mandatory input untuk reff material
$("#EditItemPrice").on("keyup", function () {
  var targetprice = $("#EditItemPrice").val();
  var a = Number(targetprice) + 0;
  if (targetprice && a !== 0) {
    $("#EditItemRefMaterial").removeClass("mandatoryclass");
  } else {
    $("#EditItemRefMaterial").addClass("mandatoryclass");
  }
});

//Upload File
$("#UploadButtonSave").on("click", function () {
  var file_data = $("#FileSpec").prop("files")[0];
  var namaitem = $("#namaitem").text();
  var link = $("#LinkSpec").val();
  var idpss = $("#idpssupload").val();
  var reqid = $("#iditemupload").val();
  var user = Username;
  var form_data = new FormData();
  form_data.append("file", file_data);
  form_data.append("namaitem", namaitem);
  form_data.append("link", link);
  form_data.append("idpss", idpss);
  form_data.append("reqid", reqid);
  form_data.append("user", user);
  $.ajax({
    //url: `${restlocpss}upload_spec`,
    url: `${restlocpssneg}save_drawing`,
    dataType: "text",
    cache: false,
    contentType: false,
    processData: false,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: form_data,
    type: "post",
    success: function (response) {
      console.log('1');
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        console.log("Gagal Simpan mas brooo, data error");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "warning",
            showConfirmButton: false,
          });
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: "success",
            showConfirmButton: false,
          });
        }
        ReadItemPSSTable(); 
        
      } else {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tersimpan !",
          "error"
        );
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      console.log(
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
      );
    },
  });
  $(".windowuploadspec").modal("hide");
});


// $("#UploadButtonSave").on("click", function () {
//   var file_data = $("#FileSpec").prop("files")[0];
//   var namaitem = $("#namaitem").text();
//   var idpss = $("#idpssupload").val();
//   var reqid = $("#iditemupload").val();
//   var user = Username;
//   var form_data = new FormData();
//   form_data.append("file", file_data);
//   form_data.append("namaitem", namaitem);
//   form_data.append("idpss", idpss);
//   form_data.append("reqid", reqid);
//   form_data.append("user", user);
//   $.ajax({
//     url: `${restlocpss}upload_spec`,
//     dataType: "text",
//     cache: false,
//     contentType: false,
//     processData: false,
//     headers: {
//       user: vusrnm,
//       token: vtoken,
//     },
//     data: form_data,
//     type: "post",
//     success: function (response) {
//       var obj = JSON.parse(JSON.parse(response));
//       if (isEmpty(obj)) {
//         console.log("Gagal Simpan mas brooo, data error");
//       } else if (obj) {
//         if (obj.status == false) {
//           Swal.fire({
//             text: obj.message,
//             timer: 1500,
//             icon: "warning",
//             showConfirmButton: false,
//           });
//         } else {
//           Swal.fire({
//             text: obj.message,
//             timer: 1500,
//             icon: "success",
//             showConfirmButton: false,
//           });
//         }
//         ReadItemPSSTable();
//       } else {
//         Swal.fire(
//           "Error",
//           "Ada kendal di koneksi/database, data tidak tersimpan !",
//           "error"
//         );
//       }
//     },
//     error: function () {
//       window.location.href = "./?link=loclogout";
//       console.log(
//         "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
//       );
//     },
//   });
//   $(".windowuploadspec").modal("hide");
// });

//Delete File Spec
$("#UploadButtonDel").on("click", function () {
  var namaitem = $("#namaitem").text();
  var iditem = $("#iditemupload").val();
  var namafile = $("#NamaFile").val();
  Swal.fire({
    title: "<h3>Hapus File Spec Item :</h3>",
    text: namaitem,
    icon: "warning",
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type: "POST",
        url: `${restlocpss}delete_spec`,
        headers: {
          user: vusrnm,
          token: vtoken,
        },
        data: {
          iditem: iditem,
          namafile: namafile,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(JSON.parse(response));
          if (obj.status == false) {
            Swal.fire(
              "Error",
              "Ada kendal di koneksi/database, data tidak tersimpan !",
              "error"
            );
          } else {
            Swal.fire({
              title: "Deleted!",
              text: "Spec yang anda maksud sudah dihapus dari database.",
              timer: 1500,
              position: "top-end",
              icon: "success",
              showConfirmButton: false,
            });
            ReadItemPSSTable();
          }
        },
        error: function () {
          window.location.href = "./?link=loclogout";
          Swal.fire(
            "Error",
            "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
            "error"
          );
        },
      });
    }
  });
  $(".windowuploadspec").modal("hide");
});

//Set Status PSS File Spec
$("#StsBtn").on("click", function () {
  var stspss = $("#SetStatusPSS").val();
  Swal.fire({
    title: "<h3>Set Status PSS to :</h3>",
    text: stspss,
    icon: "warning",
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type: "POST",
        url: `${restlocpssneg}update_statuspss`,
        headers: {
          user: vusrnm,
          token: vtoken,
        },
        data: {
          idpss: PSSID,
          stspss: stspss,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(JSON.parse(response));
          if (obj.status == false) {
            Swal.fire(
              "Error",
              "Ada kendal di koneksi/database, data tidak tersimpan !",
              "error"
            );
          } else {
            Swal.fire({
              text: "PSS sudah di rubah statusnya.",
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            });
            window.location.href = "./?link=pss";
          }
        },
        error: function () {
          window.location.href = "./?link=loclogout";
          Swal.fire(
            "Error",
            "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
            "error"
          );
        },
      });
    }
  });
});

function UploadItem(){
  $("#uploaditemnego").on("click", function (e) {
    $(".windowuploaditem").modal("show");
  });
}

function DownloadItem() {
  $('#downloaditemdesigner').on('click', function() {
    Swal.fire({
      title: "<h3>Download Item Designer</h3>",
      html: "Data yang di download berikut adalah item Designer.<br>Data ini bisa dilengkapi untuk kemudian di upload lagi menjadi data item Negosiator.<br>Jangan merubah baris 1 (baris headernya).<br>Untuk baris yang dibaca oleh sistem saat file excel tsb di-import adalah mulai baris ke 2<br>Input mandatory di tandai kolom warna kuning.<br>",
      confirmButtonText: "Download",
      showCancelButton: true,
      cancelButtonText: "Tutup",
    }).then((result) => {
      if (result.value) {
        var NamaFile = NoPSS.replace(/\//g, '');
        $.ajax({
          type    : "POST",
          url     : `${restlocpscxls}DownloadTemplateNegosiator`,
          headers: {
            user  : vusrnm,
            token : vtoken,
          },
          data: {
            idpss: PSSID,
          },
          cache: false,
          success: function (response){
            window.location.href = "../RND_Upload/PSS/Excel/"+NamaFile+".xlsx";
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });
}






//Load after Document Ready
$(document).ready(function () {
  ReadItemPSSTable();
  UploadItem();
  DownloadItem();

  //activate popup ms project description
  $(".descpopup").popup();

  //disable autocomplete
  $("input").attr("autocomplete", "off");

  //Input Number Only
  $("#EditItemQtySample").bind("keyup paste", function () {
    this.value = this.value.replace(/[^0-9]/g, "");
  });

  //Input Number Only
  $("#EditItemQtyConfirm").bind("keyup paste", function () {
    this.value = this.value.replace(/[^0-9]/g, "");
  });

  //Input Number Only
  $("#AddSubItemQtySample").bind("keyup paste", function () {
    this.value = this.value.replace(/[^0-9]/g, "");
  });

  //klik link PSS List ( PSS Home )
  $("#tabpsslist").on("click", function () {
    window.location.href = "./?link=pss";
  });

  $("#tabpssreport").on("click", function () {
    window.location.href = "./?link=reportingpss";
  });

  //klik back
  $("#HeaderButtonBack").on("click", function () {
    window.location.href = "./?link=pss";
  });

  //IHP List
  $("#tabihplist").on("click", function () {
    window.location.href = "./?link=ihpnegosiator";
  });

  $('.tabuserguide').on('click', function() {
    window.location.href = "./?link=guidepss";
  });
  $('.tabsuratgolive').on('click', function() {
    window.location.href = "./?link=golivepss";
  });
  $('.tabhasilmonitoring').on('click', function() {
    window.location.href = "./?link=monitorpss";
  });
  $('.tabversion').on('click', function() {
    window.location.href = "./?link=versionhistory&app=PSS";
  });
  $("#tabpssreport").on("click", function () {
    window.location.href = "./?link=reportingpss";
  });

  $("#HeaderEdit").on("click", function () {
    var eidpss = PSSID;
    var nonceValue = decodeURIComponent(getCookie("nonceValue"));
    let encryption = new Encryption();
    var eidpssENC = encryption.encrypt(eidpss, nonceValue);
    window.location.href = "./?link=pssheader&i=" + eidpssENC;
  });

  $("#AddSubItemButtonSave").on("click", function (e) {
    SaveSubItem();
  });

  //Show Detail
  $("#showallitem").on("click", function (e) {
    $(".windowdetailitem").modal("show");
    ReadAllItem();
  });

  //Show Negosiator
  $(".editpssnego").on("click", function (e) {
    $(".windownegosiator").modal("show");
    
    Master();
  });

  //Show History Negosiator
  $(".historynego").on("click", function (e) {
    $(".windowhistorynego").modal("show");
    ReadHistoryNego();
  });

  //Change Status PSS /// <-----------------------------------------------------------------------------------------
  // $(".changestspss").on("click", function (e) {
  //   $(".windowchangestatuspss").modal("show");
  //   console.log(inforeqfinish);
  //   //ReadHistoryNego();
  // });

  //Show Reason-CancelPSS Dialog
  $("#cancelpss").on("click", function (e) {
    $(".windowreason").modal("show");
  });

  //Back Close Modal Cancel Reason
  $("#CancelBack").on("click", function (e) {
    $(".windowreason").modal("hide");
  });

  //Back Close Modal Edit Item
  $(".CloseModal").on("click", function (e) {
    $("#EditItemReqPIN").dropdown("clear");
    $(".windowadditem").modal("hide");
    $(".windowaddnewitem").modal("hide");
    $(".windowchangestatuspss").modal("hide");
    $(".windowuploadspec").modal("hide");
    $(".windowreason").modal("hide");
    $(".windowdrwspec").modal("hide");
    $(".windowdetailitem").modal("hide");
    $(".windownegosiator").modal("hide");
    $(".windowhistorynego").modal("hide");
    $(".windowuploaditem").modal("hide");
  });
  
  $("#ChangePSSButtonBack").on("click", function (e) {
    $(".windowchangestatuspss").modal("hide");
  });

  //Back Close Modal Upload
  $("#UploadButtonBack").on("click", function (e) {
    $(".windowuploadspec").modal("hide");
  });

  // table negosiator
  var MTable = $("#Master").DataTable({
    dom:
      "<'ui grid'" +
      "<'row'" +
      "<'left aligned ten wide column'>" +
      "<'right aligned six wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned ten wide column'f>" +
      "<'right aligned six wide column'p>" +
      ">" +
      ">",
    stateSave: false,
    pageLength: 10,
    data: [],
    order: [[0, "asc"]],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Search..",
    },
    pagingType: "simple",
    columnDefs: [{ type: "natural", targets: 0 }],
    columns: [
      {
        data: null,
        render: function (data, type, row) {
          return (
            '<span class="actedit" enm="' +
            data["nama_negosiator"] +
            '">' +
            data["nama_negosiator"] +
            "</span>"
          );
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          return (
            '<span class="actedit" enm="' +
            data["nama_negosiator"] +
            '">' +
            data["job_handle"] +
            "</span>"
          );
        },
      },
    ],
  });

  //Function Read Master Negosiator
  function Master() {
    var vusrnm = getCookie("usrnm");
    var vtoken = getCookie("token");

    //Load Data Master Negosiator
    $.ajax({
      type: "POST",

      url: `${restlocpss}read_negosiator`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(response);
        if (isEmpty(obj)) {
          console.log("Gagal load tabel, data kosong");
        } else {
          //DRAW ARRAY KE DATATABLES
          MTable.clear();
          $.each(obj, function (index, value) {
            MTable.row.add(value);
          });
          MTable.draw();
        }
      },

      //JIKA ERROR TAMPILKAN PESAN ATAU LOGOUT
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  }

  $("#Master").on("click", ".actedit", function () {
    var enm = $(this).attr("enm");
    var epssid = PSSID;
    var user = Username;
    $("#HeaderNegosiator").val(enm);
    $.ajax({
      type: "POST",
      url: `${restlocpss}change_negosiator`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        idpss: epssid,
        nego: enm,
        user: user,
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal Simpan mas brooo, data error");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            });
            $("#psssignmsc").addClass("disabled");
            $(".windownegosiator").modal("hide");
            window.location.href = "./?link=pss";
          }
        } else {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data tidak tersimpan !",
            "error"
          );
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
    // $(".windownegosiator").modal('hide');
    // window.location.href = "./?link=pss";
  });

  //Sign PSS Designer
  $(SignDesigner).on("click", function (e) {
    var idpss = PSSID;
    var user = Username;

    $.ajax({
      type: "POST",
      url: `${restlocpss}sign_pssdesigner`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: { idpss: idpss, user: user },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal Sign mas brooo, koneksi error");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            });
            window.location.href = "./?link=pss";
          }
        } else {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data tidak tersimpan !",
            "error"
          );
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });

  //Sign PSS Head Of
  $(SignSecHead).on("click", function (e) {
    var idpss = PSSID;
    var user = Username;

    $.ajax({
      type: "POST",
      url: `${restlocpssshd}sign_psssectionhead`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: { idpss: idpss, user: user },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal Sign mas brooo, koneksi error");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            });
            window.location.href = "./?link=pss";
          }
        } else {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data tidak tersimpan !",
            "error"
          );
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });

  //Sign PSS Negosiator
  $(SignMSC).on("click", function (e) {
    var idpss = PSSID;
    var user = Username;

    $.ajax({
      type: "POST",
      url: `${restlocpssneg}sign_pssnegosiator`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: { idpss: idpss, user: user },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal Sign mas brooo, koneksi error");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            });
            window.location.href = "./?link=pss";
          }
        } else {
          Swal.fire(
            "Error",
            "Ada kendal di koneksi/database, data tidak tersimpan !",
            "error"
          );
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });

  //REQUST FINISH PSS ( by negosiator )
  $(ReqFinish).on("click", function (e) {
    var idpss = PSSID;
    var nopss = NoPSS;
    var user = Username;

    $.ajax({
      type: "POST",
      url: `${restlocpss}request_finish`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        idpss: idpss,
        nopss: nopss,
        user: user,
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal Request, data kosong");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            Swal.fire({
              text: "Status Finish PSS Requested",
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            }).then((result) => {
              if (result.value) {
                window.location.href = "./?link=pss";
              }
            });
          }
        } else {
          Swal.fire("Error", "Data Error ?.", "error");
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });


  //WAIT-FINISH TO ACTIVE ( by negosiator )
  $(ReqWait2Active).on("click", function (e) {
    var idpss = PSSID;
    var nopss = NoPSS;
    var user = Username;

    $.ajax({
      type: "POST",
      url: `${restlocpss}waittoactive`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        idpss: idpss,
        nopss: nopss,
        user: user,
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(response);
        if (isEmpty(obj)) {
          console.log("Gagal Request, data kosong");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            $(".windowchangestatuspss").modal("hide");
            window.location.href = "./?link=pss";
            Swal.fire({
              text: "Status berubah menjadi Active lagi",
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            });
          }
        } else {
          Swal.fire("Error", "Data Error ?.", "error");
        }
      },
      error: function () {
        // window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });

  //REQUST CLOSE PSS ( by negosiator )
  $(ReqClose).on("click", function (e) {
    var idpss = PSSID;
    var nopss = NoPSS;
    var user = Username;

    $.ajax({
      type: "POST",
      url: `${restlocpss}request_close`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        idpss: idpss,
        nopss: nopss,
        user: user,
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(JSON.parse(response));
        if (isEmpty(obj)) {
          console.log("Gagal Request, data kosong");
        } else if (obj) {
          if (obj.status == false) {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: "warning",
              showConfirmButton: false,
            });
          } else {
            Swal.fire({
              text: "Status Close PSS Requested",
              timer: 1500,
              icon: "success",
              showConfirmButton: false,
            }).then((result) => {
              if (result.value) {
                window.location.href = "./?link=pss";
              }
            });
          }
        } else {
          Swal.fire("Error", "Data Error ?.", "error");
        }
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        console.log(
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
        );
      },
    });
  });

  //Cancel PSS ( by negosiator )
  $(CancelPss).on("click", function (e) {
    var idpss = PSSID;
    var nopss = NoPSS;
    var user = Username;
    var jabatan = "NEGOSIATOR";
    var reason = $("#psscancelreason").val();

    Swal.fire({
      title: "<h3>CANCEL PSS Num: " + nopss + "</h3>",
      text: "Are you sure ?!",
      icon: "warning",
      confirmButtonText: "Yes",
      cancelButtonColor: "#8b9da4",
      cancelButtonText: "Back",
      showCancelButton: true,
      allowEnterKey: false,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocpss}cancel_pss`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            idpss: idpss,
            nopss: nopss,
            reason: reason,
            jabatan: jabatan,
            user: user,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(JSON.parse(response));
            if (isEmpty(obj)) {
              console.log("Gagal Cancel, data kosong");
            } else if (obj) {
              if (obj.status == false) {
                Swal.fire({
                  text: obj.message,
                  timer: 1500,
                  icon: "warning",
                  showConfirmButton: false,
                });
              } else {
                Swal.fire({
                  text: "PSS sudah berubah status menjadi CANCEL",
                  icon: "success",
                  showConfirmButton: true,
                }).then((result) => {
                  if (result.value) {
                    window.location.href = "./?link=pss";
                  }
                });
              }
            } else {
              Swal.fire("Error", "Data Error ?.", "error");
            }
          },
          error: function () {
            window.location.href = "./?link=loclogout";
            console.log(
              "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
            );
          },
        });
      }
    });
  });

  //Fuction Save AddSub Item
  function SaveSubItem() {
    var psscat = "NEW";
    var pssid = PSSID;
    var iditem = $("#IdItemAddSub").val();
    var pssdescreff = $("#AddSubItemRef").val();
    var pssdesc = $("#AddSubItemDescription").val();
    var pssmatnum = $("#AddSubItemVendorMatNum").val();
    var pssplant = $("#AddSubItemPlant").val().toString();
    var pssqtyspl = $("#AddSubItemQtySample").val();
    var pssetaspl = $("#AddSubItemETASample").val();
    var psssloc = $("#AddSubItemSLoc").val();
    var pssbaseun = $("#AddSubItemBaseUnit").val();
    var pssrefmat = $("#AddSubItemRefMaterial").val();
    var pssnote = $("#AddSubItemNote").val();
    var psspicvih = $("#AddSubItemPICVendorInHouse").val();
    var psslink = $("#AddSubItemLinkDocument").val();
    var pssprice = $("#AddSubItemPrice").val();
    var psscurr = $("#AddSubItemCurrency").val();
    var psschar = $("#AddSubItemCharacteristic").val();

    if (pssdesc == pssdescreff) {
      Swal.fire({
        title: "<h3>Deskripsi sama dengan Deskripsi reference !</h3>",
        text: "Lanjutkan ?",
        icon: "warning",
        confirmButtonText: "Ya",
        showCancelButton: true,
        cancelButtonText: "Back",
      }).then((result) => {
        if (result.value) {
          $.ajax({
            type: "POST",
            url: restlocpssneg + "create_subitempss",
            headers: {
              user: vusrnm,
              token: vtoken,
            },
            data: {
              pssid: pssid,
              iditem: iditem,
              psscat: psscat,
              pssdescreff: pssdescreff,
              pssdesc: pssdesc,
              pssmatnum: pssmatnum,
              pssplant: pssplant,
              pssqtyspl: pssqtyspl,
              pssetaspl: pssetaspl,
              psssloc: psssloc,
              pssbaseun: pssbaseun,
              pssrefmat: pssrefmat,
              pssnote: pssnote,
              psspicvih: psspicvih,
              psslink: psslink,
              pssprice: pssprice,
              psscurr: psscurr,
              psschar: psschar,
            },
            cache: false,
            success: function (response) {
              var obj = JSON.parse(JSON.parse(response));
              if (isEmpty(obj)) {
                console.log("Gagal Simpan mas brooo, data error");
              } else if (obj) {
                if (obj.status == false) {
                  Swal.fire({
                    text: obj.message,
                    timer: 1500,
                    icon: "warning",
                    showConfirmButton: false,
                  });
                } else {
                  Swal.fire({
                    text: obj.message,
                    timer: 1500,
                    icon: "success",
                    showConfirmButton: false,
                  });
                  $(".windowaddnewitem").modal("hide");
                  ReadItemPSSTable();
                }
              } else {
                Swal.fire(
                  "Error",
                  "Ada kendal di koneksi/database, data tidak tersimpan !",
                  "error"
                );
              }
            },
            error: function () {
              window.location.href = "./?link=loclogout";
              console.log(
                "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
              );
            },
          });
        }
      });
    } else {
      $.ajax({
        type: "POST",
        url: restlocpssneg + "create_subitempss",
        headers: {
          user: vusrnm,
          token: vtoken,
        },
        data: {
          pssid: pssid,
          iditem: iditem,
          psscat: psscat,
          pssdescreff: pssdescreff,
          pssdesc: pssdesc,
          pssmatnum: pssmatnum,
          pssplant: pssplant,
          pssqtyspl: pssqtyspl,
          pssetaspl: pssetaspl,
          psssloc: psssloc,
          pssbaseun: pssbaseun,
          pssrefmat: pssrefmat,
          pssnote: pssnote,
          psspicvih: psspicvih,
          psslink: psslink,
          pssprice: pssprice,
          psscurr: psscurr,
          psschar: psschar,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(JSON.parse(response));
          if (isEmpty(obj)) {
            console.log("Gagal Simpan mas brooo, data error");
          } else if (obj) {
            if (obj.status == false) {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "warning",
                showConfirmButton: false,
              });
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              $(".windowaddnewitem").modal("hide");
              ReadItemPSSTable();
            }
          } else {
            Swal.fire(
              "Error",
              "Ada kendal di koneksi/database, data tidak tersimpan !",
              "error"
            );
          }
        },
        error: function () {
          window.location.href = "./?link=loclogout";
          console.log(
            "Server tidak merespon, segera hubungi Administrator di ext. 3553 !"
          );
        },
      });
    }
  }
});

//Modal Window Control
$(".windowadditem").modal({
  //closable: false,
  autofocus: false,
});

$(".windowselopr").modal({
  //closable: false,
  autofocus: false,
});