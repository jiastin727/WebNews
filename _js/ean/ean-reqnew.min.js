$('.ui.dropdown').dropdown();
var restlocean = decodeURIComponent(getCookie("restlocean"));

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
const NonceValue = "rdsystem2020";
const LogoutProtect = false;


$(document).ready(function() {

  if(IdEditEAN){
    $('#EANGroupProduct').dropdown("clear");
    $('#EANGroupProduct').dropdown("set selected", GroupPrd);
  } else {
    $('#EANGroupProduct').dropdown("clear");
    IdEditEAN = "";
  }

  $('#tabEANReq').on('click', function() {
    window.location.href = "./?link=eanindex";
  });

  $('#HeaderButtonBack').on('click', function() {
    window.location.href = "./?link=eanindex";
  });
 
  // $('#userguideean').on('click', function() {
  //   window.location.href = "./?link=guideean";
  // });

  $('.tabuserguide').on('click', function() {
    window.location.href = "./?link=guideean";
  });
  $('.tabsuratgolive').on('click', function() {
    window.location.href = "./?link=goliveean";
  });
  $('.tabhasilmonitoring').on('click', function() {
    window.location.href = "./?link=monitorean";
  });
  $('.tabversion').on('click', function() {
    window.location.href = "./?link=versionhistory&app=EAN";
  });

  $("#EANBasic").on("input", function() {
    $('#EANSite').val('');
    $('#EANBrand').val('');
    $('#EANJenisProduct').val('');
    $('#EANProduct').val('');
  });

  $('#LoadTypeSupply').on('click', function() {
    LoadDataPTB();
    // LoadDataPTB();
  });

  function GetValue(a){
    if(a){
      return a;
    } else {
      return '';
    }
  }

  function LoadDataPTB(){
    var itype = $('#EANBasic').val();
    if(itype){
      $('.PTBInput').addClass('loading');
      $.ajax({
        type    : "POST",
        url     : `${restlocean}LoadDataTypeBasic`,
        headers : {
          user  : vusrnm,
          token : vtoken
        },
        data: {
          tbasic    : itype,
        },
        cache: false,
        success: function (response){
          var obj = JSON.parse(response);
          $('.PTBInput').removeClass('loading');
          jmlData = obj.data_typesupply.data.length;
          $("#BdyTypeSupplyList").empty();
          for (a = 0; a < jmlData; a++) {
            $("#TblTypeSupplyList").find("tbody").append(
              "<tr class='loaddatasite' st='"+obj.data_typesupply.data[a]["site"]+"' br='"+obj.data_typesupply.data[a]["brand"]+"' jn='"+obj.data_typesupply.data[a]["jenis_produk"]+"' pr='"+obj.data_typesupply.data[a]["produk"]+"' tb='"+obj.data_typesupply.data[a]["type_barang"]+"' ts='"+obj.data_typesupply.data[a]["type_supply"]+"'>"+
                "<td>"+obj.data_typesupply.data[a]["type_supply"]+"</td>"+
                "<td class='center'>"+obj.data_typesupply.data[a]["site"]+"</td>"+
                "<td class='center'>"+obj.data_typesupply.data[a]["brand"]+"</td>"+
                "<td class='center'>"+obj.data_typesupply.data[a]["jenis_produk"].toUpperCase()+"</td>"+
                "<td class='center'>"+obj.data_typesupply.data[a]["produk"]+"</td>"+
              "</tr>"
            );
          }
          LoadDataData();

          jmlDataTypeBarang = obj.data_type_barang.data.length;
          var TypeBarang = '';
          $("#EANTypeBarang").empty();
          for (b = 0; b < jmlDataTypeBarang; b++) {
            TypeBarang += obj.data_type_barang.data[b]['type_barang']+",";
            $('#EANTypeBarang').append('<option value="'+obj.data_type_barang.data[b]['type_barang']+'">'+obj.data_type_barang.data[b]['type_barang']+'</option>');
          }
          TypeBarang = TypeBarang.replace(/,\s*$/, "");

          var TypeBarangArry = TypeBarang.split(",");
          $("#EANTypeBarang").dropdown("clear");
          $("#EANTypeBarang").dropdown("set", TypeBarangArry);


        },
        error: function () {
          if (LogoutProtect){
            window.location.href = "./?link=loclogout";
          } else {
            Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
          }
        },
      });
    }
  }

  function LoadDataData(){
    $('.loaddatasite').on('click', function() {
      var site_a = $(this).attr('st');
      var bran_a = $(this).attr('br');
      var jnis_a = $(this).attr('jn');
      var prod_a = $(this).attr('pr');
      var tbrg_a = $(this).attr('tb');
      var tsup_a = $(this).attr('ts');
      $('#EANSite').val(GetValue(site_a));
      $('#EANBrand').val(GetValue(bran_a));
      $('#EANJenisProduct').val((GetValue(jnis_a)).toUpperCase());
      $('#EANProduct').val(GetValue(prod_a));
      $("#EANTypeBarang").dropdown("set selected", tbrg_a);
      $('#EANTypeSupply').val(GetValue(tsup_a));
    });
  }


  $('#HeaderButtonSave').on('click', function() {
    $.ajax({
      type    : "POST",
      url     : `${restlocean}CreateNewEAN`,
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        IdEAN         : IdEditEAN,
        EANSite       : $("#EANSite").val(),
        EANBrand      : $("#EANBrand").val(),
        EANBasic      : $("#EANBasic").val(),
        TypeEAN       : $("#TypeEAN").val(),
        EANJenisProduct : $("#EANJenisProduct").val(),
        EANProduct    : $("#EANProduct").val(),
        EANPL         : $("#EANPL").val(),
        EANTypeBarang : $("#EANTypeBarang").val().toString(),
        EANTypeSupply : $("#EANTypeSupply").val(),
        // $("#AddItemPlant").val().toString();
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          console.log('Gagal Simpan mas brooo, data kosong');
        } else if(obj) {
          if (obj.status == false){
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: 'warning',
              showConfirmButton: false
            })
          } else {
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: 'success',
              showConfirmButton: false
            })
            window.location.href = "./?link=eanindex";
          }
        } else {
          Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
        }
      },
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    });
  });

  //Delete EAN Request 
  $('#HeaderButtonDelete').on('click', function() {
    var idid = $('#EANIdEdit').val();

    Swal.fire({
      title: "<h3>Hapus Permintaan EAN Barcode ini ?</h3>",
      icon: "warning",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}Delete_EAN`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum    : idid,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'warning',
                showConfirmButton: false
              })
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'success',
                showConfirmButton: false
              });
              window.location.href = "./?link=eanindex";
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });

  });


  //Cancel EAN Request 
  $('#HeaderButtonCancel').on('click', function() {
    var idid = $('#EANIdEdit').val();

    Swal.fire({
      title: "<h3>Cancel Permintaan EAN Barcode ini ?</h3>",
      icon: "warning",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}Cancel_EAN`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum    : idid,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'warning',
                showConfirmButton: false
              })
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'success',
                showConfirmButton: false
              });
              window.location.href = "./?link=eanindex";
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });

  });


   //type basic autocomplete
   $(".ui.search.tbasic").search({
    minCharacters: 1,
    apiSettings: {
      url: "1_ean/_autocompletetypebasic.php?tbasic={query}",
    },
    fields: {
      results: "data",
      title: "type",
      // description: "desc",
    },
  });

  // $('.ui.dropdown.fullsearch').dropdown( {fullTextSearch:'exact', sortSelect: true, match:'text'} );




});

