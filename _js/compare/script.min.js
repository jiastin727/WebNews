var restloccompare = decodeURIComponent(getCookie("restloccompare"));

$(function () {

    $("#listData").click(function () {
        window.location.href = "./?link=compare";
    });

    $("#listCompare").click(function () {
        window.location.href = "./?link=compareTab";
    });

    $('#btnTemplate').on('click', function () {
        window.location.href = "./?link=templatecompare";
    });

    $('#userguidecompare').on('click', function () {
      window.location.href = "./?link=guidecompare";
    });
    $('.tabsuratgolive').on('click', function() {
      window.location.href = "./?link=golivecompare";
    });
    $('.tabhasilmonitoring').on('click', function() {
      window.location.href = "./?link=monitorcompare";
    });
    $('.tabversion').on('click', function() {
      window.location.href = "./?link=versionhistory&app=CCD";
    });

    var table = $("#table-data").DataTable({
        "bInfo": false,
        "dom": "<'ui stackable grid'" +
            "<'row'" +
            "<'left aligned eight wide column'f>" +
            "<'right aligned eight wide column'l>" +
            ">" +
            "<'row dt-table'" +
            "<'sixteen wide column'tr>" +
            ">" +
            "<'row'" +
            "<'right aligned sixteen wide column'p>" +
            ">" +
            ">",
        language: { search: "", searchPlaceholder: "Search.." },
        oLanguage: {
            sLengthMenu: "_MENU_",
        },
        "lengthMenu": [5, 10, 25, 50, 75, 100],
        "pageLength": 10,
        'ajax': { url: `${restloccompare}data`, dataSrc: '' },
        'rowId': 'id',
        'columns': [
            { 'data': 'id' },
            { 'data': 'file' },
            { 'data': 'kategori' },
            {
                'render': function (data, type, row, meta) {
                    return '<i class="edit outline actedit iconcoloredit icon" id="btnEdit" onclick="showUpdateModal(' + row.id + ')"></i><i class="trash alternate outline icon iconcolordelete" id="btnDelete" onclick="showDeleteModal(' + row.id + ')"></i>';
                }
            }
        ]
    });

    $('.ui.dropdown').dropdown();

    $("#btnNew").click(function () {
        $("#modal-add").modal('show');
    })

    $("#btnConfirmUpdate").click(function () {
        fileprop = $('#field-upload-file-update').prop("files")[0];
        kategori = $("#field-upload-kategori-update").val();
        var dataupload = new FormData();
        dataupload.append("file", fileprop);
        dataupload.append("ktg", kategori);
        if (kategori != "" && document.getElementById("field-upload-file-update").files.length != 0) {
            $.ajax({
                url: `${restloccompare}update/` + localStorage.getItem("update-id"),
                type: 'POST',
                processData: false,
                contentType: false,
                cache: false,
                data: dataupload,
                success: function (response) {
                    table.ajax.reload();
                    var obj = JSON.parse(response);
                    if (obj.status == false) {
                        Swal.fire({
                            text: obj.message,
                            timer: 1500,
                            icon: "warning",
                            showConfirmButton: false,
                        });
                    } else {
                        Swal.fire('<h3>Success</h3>', '', 'success');
                    }
                },
                error: function () {
                    if (LogoutProtect) {
                        window.location.href = "./?link=loclogout";
                    } else {
                        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
                    }
                }
            });
        }
        else {
            Swal.fire('<h3>Please Fill All Fields</h3>', '', 'error')
        }

        $("#modal-update").modal('hide');
    })

    $("#btnConfirmDelete").click(function () {
        $.ajax({
            url: `${restloccompare}delete/` + localStorage.getItem("delete-id"),
            type: 'POST',
            dataType: 'json',
            success: function () {
                console.log("SUCCESS");
                table.ajax.reload();
            }, error(jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            }
        });
        $("#modal-delete").modal('hide');
        Swal.fire('<h3>Deleted</h3>', '', 'success')
    });

    $("#btnSubmit").click(function () {
        Swal.fire('<h3>Compared</h3>', '', 'info');
    });

    $("#btnUpload").click(function () {
        $("#modal-upload").modal('show');
    });

    $("#btnUploadFile").click(function () {
        fileprop = $('#field-upload-file').prop("files")[0];
        kategori = $("#field-upload-kategori").val();

        var dataupload = new FormData();
        dataupload.append("file", fileprop);
        dataupload.append("ktg", kategori);

        $.ajax({
            url: `${restloccompare}addData`,
            type: 'POST',
            dataType: 'html',
            processData: false,
            contentType: false,
            cache: false,
            data: dataupload,
            success: function (response) {
                table.ajax.reload();
                var obj = JSON.parse(response);
                if (obj.status == false) {
                    Swal.fire({
                        text: obj.message,
                        timer: 1500,
                        icon: "warning",
                        showConfirmButton: false,
                    });
                } else {
                    Swal.fire('<h3>Success</h3>', '', 'success');
                }
            },
            error: function () {
                if (LogoutProtect) {
                    window.location.href = "./?link=loclogout";
                } else {
                    Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
                }
            }
        });
        $("#modal-upload").modal('hide');
    });

    var selectedFiles = null;
    var selectedExt = null;

    $("#btnCompare").click(function () {
        var ttlFile = $("#ttlFiles").find(":selected").val();
        var ktgFile = $("#ktgf").find(":selected").val();
        var rSelect1 = $("#select-1").find(":selected").val();
        var rSelect2 = $("#select-2").find(":selected").val();
        var rSelect3 = $("#select-3").find(":selected").val();
        var rSelect4 = $("#select-4").find(":selected").val();
        if (ktgFile == 1) {
            document.getElementById("dropdownWrap").style.display = "none";
            $(".header-compare").empty();
            var temp = '<tr><th scope="col">Omit</th> <th scope="col">Added</th><th scope="col"></th></tr>';
            $(".header-compare").html(temp);
        }
        else if (ktgFile == 0) {
            document.getElementById("dropdownWrap").style.display = "";
            $(".header-compare").empty();
            var temp = '<tr><th scope="col">Designator</th> <th scope="col">Status</th> <th scope="col">Details</th></tr>';
            $(".header-compare").html(temp);
        }
        const ext = rSelect1.split('.').pop();
        selectedExt = ext;
        if (ttlFile == 2) {
            if (rSelect1 == "" || rSelect2 == "") {
                Swal.fire('<h3>Please Choose Category and 2 Files to Compare</h3>', '', 'error');
            }
            else {
                $("#filterStatus").dropdown("set selected", "ALL");
                $("#container-table-result").show();
                const files = [rSelect1, rSelect2];
                selectedFiles = files;
                $("#table-result-data").DataTable().destroy();
                TableListFunc(searchFilterStart, statusFilterStart, ext, files);
                $("#table-compare").show();
            }
        }
        else if (ttlFile == 3) {
            if (rSelect1 == "" || rSelect2 == "" || rSelect3 == "") {
            }
            else {
                $("#filterStatus").dropdown("set selected", "ALL");
                $("#container-table-result").show();
                const files = [rSelect1, rSelect2, rSelect3];
                selectedFiles = files;
                $("#table-result-data").DataTable().destroy();
                TableListFunc(searchFilterStart, statusFilterStart, ext, files);
                $("#table-compare").show();
            }
        }
        else if (ttlFile == 4) {
            if (rSelect1 == "" || rSelect2 == "" || rSelect3 == "" || rSelect4 == "") {
                Swal.fire('<h3>Please Choose Category and  4 Files to Compare</h3>', '', 'error');
            }
            else {
                $("#filterStatus").dropdown("set selected", "ALL");
                $("#container-table-result").show();
                const files = [rSelect1, rSelect2, rSelect3, rSelect4];
                selectedFiles = files;
                $("#table-result-data").DataTable().destroy();
                TableListFunc(searchFilterStart, statusFilterStart, ext, files);
                $("#table-compare").show();
            }
        }
        else {
            Swal.fire('<h3>Please Choose Category and Total File to Compare</h3>', '', 'error');
        }
    });

    $("#btnDownloadExcel").click(function () {
        $.redirect(
            "./?link=downloadCompare",
            {},
            "POST",
            "_blank"
        )
    });

    // FILTER STUFF

    var json_str = getCookie('FilterCompare');
    var arr = JSON.parse(json_str);
    if (json_str) {
        var searchFilter = arr[0];
        var statusFilter = arr[1];
    }
    else {
        var searchFilter = "";
        var statusFilter = "ALL";
    }

    if (searchFilter) {
        $("#filterSearch").val(searchFilter);
        var searchFilterStart = searchFilter;
    } else {
        var searchFilterStart = "";
    }

    if (statusFilter) {
        $("#filterStatus").dropdown("set selected", statusFilter);
        var statusFilterStart = statusFilter;
    } else {
        var statusFilterStart = "ALL";
    }

    $("#filterSearch").on('keyup', function () {
        var fSearch = $("#filterSearch").val();
        var fStatus = $("#filterStatus").val();
        $("#table-result-data").DataTable().destroy();
        TableListFunc(fSearch, fStatus, selectedExt, selectedFiles);
    });

    $("#filterStatus").on("change", function () {
        var fSearch = $("#filterSearch").val();
        var fStatus = $("#filterStatus").val();
        $("#table-result-data").DataTable().destroy();
        TableListFunc(fSearch, fStatus, selectedExt, selectedFiles);
    });

    $(".resetfilter").on("click", function () {
        $("#filterSearch").val("");
        $("#filterStatus").dropdown("set selected", "ALL");
        $("#table-result-data").DataTable().destroy();
        TableListFunc("", "ALL", selectedExt, selectedFiles);
    });

    $("#btnDetail").click(function () {
        window.location.href = "./?link=detailsTab&i=" + selectedFiles;
    })

    $("#btnDownloadDetailExcel").click(function () {
        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
            return false;
        };
        var i = getUrlParameter('i');
        $.redirect(
            "./?link=downloadDetailCompare",
            {
                detailsData: i
            },
            "POST",
            "_blank"
        )
    });

    $('.tabular.menu .item').tab();
});

function showUpdateModal(id) {
    var filesUser = userFiles.split(", ");
    var flg = 0;
    for (let index = 0; index < filesUser.length; index++) {
        if(filesUser[index] == id){
            flg = 1;
            break;
        }
    }
    if (roleUser.indexOf("PCB-ADMIN") >= 0 || flg == 1) {
        $('#modal-update').modal("show");
    localStorage.setItem("update-id", id);
    }
    else {
        Swal.fire("Error", "Hanya Admin & Uploader dapat update data!", "error");
    }
}

function showDeleteModal(id) {
    var filesUser = userFiles.split(", ");
    var flg = 0;
    for (let index = 0; index < filesUser.length; index++) {
        if(filesUser[index] == id){
            flg = 1;
            break;
        }
    }
    if (roleUser.indexOf("PCB-ADMIN") >= 0 || flg == 1) {
        $('#modal-delete').modal("show");
        localStorage.setItem("delete-id", id);
    }
    else {
        Swal.fire("Error", "Hanya Admin & Uploader dapat menghapus data!", "error");
    }
}

function TableListFunc(fSearch, fStatus, ext, files) {
    if ($.fn.DataTable.isDataTable('#table-result-data')) {
        $("#table-result-data").DataTable().destroy();
    }
    $("#table-result-data tbody").empty();
    colComp = [
        { data: 'Designator' },
        { data: 'Status' },
        { data: 'Details' }
    ];
    colDrill = [
        { data: 'Omit' },
        { data: 'Added' }
    ];
    $.ajax({
        type: 'POST',
        data: {
            EXP: files,
            filterSearch: fSearch,
            filterStatus: fStatus
        },
        url: `${restloccompare}compareFile`,
        success: function (data) {
            data = JSON.parse(data);
            if (ext == 'xls' || ext == "xlsx") {
                columnsfix = colComp;
            }
            else {
                columnsfix = colDrill;
            }
            $("#table-result-data").DataTable({
                bInfo: false,
                paging: false,
                searching: false,
                stateSave: true,
                deferRender: true,
                orderClasses: false,
                destroy: true,
                data: data.data,
                columns: columnsfix,
                "language": {
                    "emptyTable": "Tidak Terdapat Perbedaan"
                },
                ajax: {
                    url: `${restloccompare}compareFile`,
                    type: "POST",
                    data: {
                        EXP: files,
                        filterSearch: fSearch,
                        filterStatus: fStatus
                    },
                    dataSrc: '',
                },
            });
        }
    });
}