const fungsilogout = false;
$('.ui.dropdown').dropdown({
    forceSelection:false
});
$(".menu .item").tab();

const NonceValue = "rdsystem2020";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocmds = decodeURIComponent(getCookie("restlocmdsdinamis"));
var btnstate=false;

// >>> FUNGSI MENJALANKAN FUNGSI KETIKA HALAMAN LOAD (READY)
$( document ).ready(function() {

    if(is_error){
        let btnstate=false;

    }else{
        console.log(json_general['isfile']);
        // const arr_general=JSON.parse(json_general);
        // console.log(arr_general);

        if(json_general['isfile']){
            // jika ada upload data
             btnstate=false;

            
            $(".ui.dropdown.dropdownjenis").dropdown().dropdown({
                showOnFocus: false,
                onChange: function(value){
                console.log(value);

                    if(value==="FILE"){
                
                        document.getElementById("container_input_data_upload").innerHTML = `
                        <div class="ui input fluid small" style="margin-bottom:5px;">
                            <input type="file" id="input_data_uplaod" class="mandatoryclass" inputtype="file">
                            
                        </div>
                        <a class="ui label labelwarning">
                            <i class="ui info icon"></i>
                            ukuran maksimal 10mb

                            </a>
                        `;
                    
                        btnstate=value;
                    }else if(value==='LINK'){
                        document.getElementById("container_input_data_upload").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_data_uplaod" class="mandatoryclass" type="text" id="2" inputtype="link" placeholder="Cantumkan lengkap beserta http:// atau https:// - nya.">
                        </div>
                        `;
                        btnstate=value;
                        // $("#btntxt").text("Gunakan Link");
                        
                        console.log($(this));

                    }else if(value==="FOLDER_SHARING"){
                        document.getElementById("container_input_data_upload").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_data_uplaod" class="mandatoryclass" type="text" inputtype="foldersharing" placeholder="alamat folder sharing1" value="file:\\\\">
                        </div>
                        `;
                        btnstate=value;
                    // $("#btntxt").text("Gunakan Link");
                        
                        // console.log($(this));

                    }else if(value===""){
                        $("#container_input_data_upload").html('');
                    }
                
                    console.log("btnstate->>"+btnstate);
                }

            });

        }else{
            // tidak ada sistem upload data

        }


        // untuk view datatable
        // cek apakah array kolom kosong atau tidak
        if(table_col.length>0){
            let datatable_column=[];

            view_datatable(table_col,id_sub,id_tab);
        }else{

            Swal.fire({
                title: 'data kolom kosong',
                icon: 'error',
                text: "",
                // showDenyButton: true,
                // showCancelButton: true,
                confirmButtonText: 'refresh',
                // denyButtonText: `tumpuk data lama`,
                // confirmButtonColor: '#21ba45',
                // confirmButtonColor: '#3085d6',
              }).then((result) => {
                
                if (result.isConfirmed) {
                    location.reload();
                }
            
              })
            
        }
        console.log(table_col.length);

    }

    
});





  // --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 4 FUNGSI UPLOAD FILE KETIKA TEKAN TOMBOL UPLOAD DATA

$('#tb_form_konten').on('click','#simpan_data_upload', function() {
    console.log($("#tb_form_konten").find("#td_simpan_data").html());
    
    $("#tb_form_konten").find("#td_simpan_data").html(`
        <button class="ui right floated loading small gray button" id="loading_simpan_data">
            simpan setting
        </button>
    `)
    // return false;
    if(is_admin){
        // merupakan admin --> bisa melakukan upload
        let dataupload = new FormData();
        let success_input=false;
        let success_data=false;
        let arr_field_col = {'wajib':[],'nonwajib':[]};
        if(jQuery.isEmptyObject(json_input_id)==false){
            // cek data array id input kosong atau tidak

            
            // MEMASUKKAN DATA INPUT UNTUK DIKIRIM
            for (var key in json_input_id) {
                // skip loop if the property is from prototype
                if (!json_input_id.hasOwnProperty(key)) continue;
            
                
                let id_input = json_input_id[key]; // array berisi id input
                if(key == "wajib"){
                    // ketika input adalah wajib (mandatory)
                    for( let key_id in id_input){

                        let id_in = id_input[key_id];


                        let field_value=$("#"+id_in).val();
                        if ($("#tb_form_konten").find("#"+id_in).length > 0) {
                            // cek field input ada atau tidak

                            // cek input mandatory kosong atau tidak
                            if(field_value!==""&&field_value!==null){
                                // jika input mandatory tidak kosong

                                let namadata=id_in.replace('id_','');
                                console.log(arr_field_col);
                                arr_field_col['wajib'].push(namadata);
                                
                                dataupload.append(namadata, field_value);
                                success_input=true;
                                
                            }else{

                                Swal.fire({
                                    title: "Ada input mandatory (warna kuning) yang kosong",
                                    text: "",
                                    icon: 'error',
                                    showCancelButton: false,
                                    confirmButtonText: 'Ya',
                                });
                                success_input=false;
                                break;
                            }

                        }else{
                            // error karena field tidak ada
                            Swal.fire({
                                title: "field dengan id :"+id_in+" tidak ditemukan",
                                text: "",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonText: 'Ya',
                            });
                            success_input=false;
                            break;
                        }
                        
                        

                    }

                }else{
                    // ketika input bukan wajib

                    for(let key_id in id_input){

                        let id_in = id_input[key_id];

                        if ($("#tb_form_konten").find("#"+id_in).length > 0) {

                            let field_value=$("#"+id_in).val();
                        
                            let namadata=id_in.replace('id_','');
                            arr_field_col['nonwajib'].push(namadata);
                            
                            dataupload.append(namadata, field_value);
                            success_input=true;
                            
                        }else{

                            // error karena field tidak ada
                            Swal.fire({
                                title: "field dengan id :"+id_in+" tidak ditemukan",
                                text: "",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonText: 'Ya',
                            });
                            success_input=false;
                            break;
                        }

                    }


                }

                // for (var prop in obj) {
                //     // skip loop if the property is from prototype
                //     if (!obj.hasOwnProperty(prop)) continue;
            
                //     // your code
                //     alert(prop + " = " + obj[prop]);
                // }
            }


            // jika ada upload data
            if(json_general['isfile']){

                if ($("#tb_form_konten").find(".dropdownjenis").length > 0) {

                    let val_drop_jenis= $(".dropdownjenis").dropdown("get value");
            
                    if(val_drop_jenis!=""||val_drop_jenis!=null){
                        // menggunakan upload data atau file --> cek revisi
                                if(btnstate=='FILE'){
                                    let fileupload = $('#input_data_uplaod').prop("files")[0];
                                    let linkfile="";
                                    dataupload.append("file", fileupload);
                                    dataupload.append("linkfile", linkfile);
                                    dataupload.append("jenis", btnstate);
                                    success_data=true;
                                }else if(btnstate==false){

                                    Swal.fire({
                                        title: "error--",
                                        text: "",
                                        icon: 'error',
                                        showCancelButton: false,
                                        confirmButtonText: 'ya',
                                    })
                                    success_data=false;
                                }else{
                                    let fileupload = "";
                                    let linkfile = $('#input_data_uplaod').val();

                                    if(linkfile!==""){
                                        dataupload.append("file", fileupload);
                                        dataupload.append("linkfile", linkfile);
                                        dataupload.append("jenis", btnstate);
                                        success_data=true;
                                    }else{

                                        Swal.fire({
                                            title: "data upload tidak boleh kosong",
                                            text: "",
                                            icon: 'error',
                                            showCancelButton: false,
                                            confirmButtonText: 'Ya',
                                        });
                                        success_data=false;
                                    }
                                    
                                }
                        }

                }else{

                    Swal.fire({
                        title: "error: dropdown jenis file tidak tersedia",
                        text: "refresh",
                        icon: 'error',
                        showCancelButton: false,
                        confirmButtonText: 'Ya',
                    });
                    success_data=false;
                }
            }else{

                success_data=true;
            }

            if(success_input&&success_data){
                $("#tb_form_konten").find("#td_simpan_data").html(`
                    <div class="ui right floated green labeled icon small button allowed" id="simpan_data_upload">
                        <i class="save icon"></i>Simpan Data
                    </div>
                `)
                console.log(json_general);  
                dataupload.append("arr_field_col", JSON.stringify(arr_field_col));
                dataupload.append("general", JSON.stringify(json_general));
                dataupload.append("id_sub", id_sub);
                dataupload.append("id_tab", id_tab);
                // ketika proses ambil value berhasil semua --> konenksi ajax
                $.ajax({
                    type: "POST",
                    url: `${restlocmds}create_data`,
                    processData: false,
                    contentType: false,
                    cache:false,
            
                    headers: {
                        user: vusrnm,
                        token: vtoken,
                    },
                        data:dataupload,
                        success: function (response){
                    var obj = JSON.parse(response);
                    console.log(obj);
                    if(isEmpty(obj)) {
                        Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
                        
                    
                    } else if(obj.status==false) {
                    // tableType();
                        
                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'error',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                    } else {

                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'success',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                        view_datatable(table_col,id_sub,id_tab);
                        clear_input_upload();
                    
                    }
                },
                error: function(){
                    if(fungsilogout){
            
                            window.location.href="./_logout.php";
                    }else{
                            console.log("error session")
                    }
                }
                });
            }else{
                $("#tb_form_konten").find("#td_simpan_data").html(`
                    <div class="ui right floated green labeled icon small button allowed" id="simpan_data_upload">
                        <i class="save icon"></i>Simpan Data
                    </div>
                `)
            }

            // test display formdata
            for (var pair of dataupload.entries()) {
                console.log(pair[0]+ ', ' + pair[1]); 
            }
            console.log(arr_field_col);




        }else{

            Swal.fire({
                title: "error: data id input kosong",
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
        }
        

    }

});

function clear_input_upload(){

    $("#container_input_data_upload").html('');
    $(".dropdownjenis").dropdown('restore defaults');
    for (var key in json_input_id) {
        // skip loop if the property is from prototype
        if (!json_input_id.hasOwnProperty(key)) continue;
        let id_input = json_input_id[key]; // array berisi id input
            // ketika input bukan wajib
            for(let key_id in id_input){
                let id_in = id_input[key_id];
                $("#"+id_in).val("");

        }
    }
    

}


// >>>> FUNGSI COPY TEXT KE CLIPBOARD (ALAMAT FOLDER SHARING)
// 
$(document).on('click','.copyalamat',function(){
    let btntext=$(this).attr('alamat');
    // navigator.clipboard.writeText(btntext).then(function() {
    //   console.log('Async: Copying to clipboard was successful!');
    // }, function(err) {
    //   console.error('Async: Could not copy text: ', err);
    // });
  
    var $temp = $("<input>");
      $("body").append($temp);
      $temp.val(btntext).select();
      document.execCommand("copy");
      
  
      Swal.fire({
        text: 'Alamat berhasil disalin (alamat: '+$temp.val()+')',
        timer: 2000,
        position: 'center',
        toast: true,
        showConfirmButton: false
        })
  
        $temp.remove();
  
  });
  // 
  // END OF FUNGSI COY
  // ==========================================================================