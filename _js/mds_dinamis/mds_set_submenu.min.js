const fungsilogout = false;
$('.ui.dropdown').dropdown({
    forceSelection:false
});
$(".menu .item").tab();

const NonceValue = "rdsystem2020";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocmds = decodeURIComponent(getCookie("restlocmdsdinamis"));
let searcval="";
// >>> FUNGSI MENJALANKAN FUNGSI KETIKA HALAMAN LOAD (READY)
$( document ).ready(function() {

    view_list_subtab(searcval);
});

// tombol tab
$("#mds_set_submenu").on("click", function(){

    window.location.href = "./?link=mdsd_direct&linkmds=mds_set_submenu";
})

$("#mds_role_setting").on("click", function(){

    window.location.href = "./?link=mdsd_direct&linkmds=mds_role_setting";
})

$("#mds_set_menu").on("click", function(){

    window.location.href = "./?link=mdsd_direct&linkmds=mds_set_menu";
})
 
$('.tabsuratgolive').on('click', function() {
  window.location.href = "./?link=golivemds";
});
$('.tabhasilmonitoring').on('click', function() {
  window.location.href = "./?link=monitormds";
});
$('.tabversion').on('click', function() {
  window.location.href = "./?link=versionhistory&app=MDS";
});

$('#tb_list_subtab').on('click','.edit_tab', function() {
    let iddata=$(this).attr("btnid");
    view_data_edit(iddata);
    view_list_role(iddata);
    $('.modal_edit').modal('show');
});

$('.closemodal_btn').on('click', function() {
    let namamodal=$(this).attr('modalname');
    $('.'+namamodal).modal('hide');
    // $('.uploaddvr').modal('hide');
});


$('#tb_list_subtab').on('click','.delete_tab', function() {

    
    // let nfile = $(this).attr("namafile");
    Swal.fire({
        title: '<h2>Hapus sub tab ini?</h2>',
        text: "DATA DIDALAM SUB TAB INI AKAN HILANG",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya'
        }).then((result) => {
            console.log(result);
            if(result.isConfirmed){
                let id_delete = $(this).attr("btnid");
                delete_sub(id_delete);
            }
            
        })
        // delete_data_main
    
    // $('.modal_edit').modal('show');
});


// >>> FUNGSI KLIK TOMBOL SIMPAN NAMA TAB DAN KETERANGAN 
$("#simpan_nama_subtab").on("click",function(){
    let nama_val=$("#nama_subtab_in").val();
    let id_tab=$("#drop_namatab").dropdown("get value");
    let keterangan_val=$("#keterangan_subtab_in").val();

    if(nama_val==null||nama_val==""){
        // JIKA NAMA VAL NULL ATAU KOSONG -> TOLAK
        

        Swal.fire({
            title: "Nama tab tidak boleh kosong",
            text: "",
            icon: 'error',
            showCancelButton: false,
            confirmButtonText: 'Ya',
        });

    }else if(id_tab==null||id_tab==""){

        Swal.fire({
            title: "pilih nama tab terlebih dahulu",
            text: "",
            icon: 'error',
            showCancelButton: false,
            confirmButtonText: 'Ya',
        });
    }else{

        simpan_nama_subtab(nama_val,id_tab,keterangan_val);

    }
});



// >>> FUNGSI UNTUK MENYIMPAN NAMA SUB TAB DAN KETERANGANNYA
function simpan_nama_subtab(namatab,id_tab,keterangan){


    $.ajax({
    type: "POST",
    url: `${restlocmds}create_subtab`,

    headers: {
        user: vusrnm,
        token: vtoken,
    },
    data:{
        namatab: namatab,
        keterangantab:keterangan,
        id_tab:id_tab,
    },
        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
                
                Swal.fire({
                    title: "Gagal menyimpan nama tab",
                    text: "",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
            
            
            } else if(obj.status==false) {
            // tableType();
                Swal.fire({
                    title: obj.message,
                    text: "",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
            
            } else {

                view_list_subtab("");
            
                Swal.fire({
                    title: 'berhasil menyimpan sub tab baru, tabel terbuat',
                    icon: 'success',
                    text: "klik refresh untuk melihat perubahan",
                    // showDenyButton: true,
                    // showCancelButton: true,
                    confirmButtonText: 'refresh',
                    // denyButtonText: `tumpuk data lama`,
                    // confirmButtonColor: '#21ba45',
                    // confirmButtonColor: '#3085d6',
                  }).then((result) => {
                    location.reload(); // force reload
                    if (result.isConfirmed) {
                        location.reload();
                    }
                
                  })

            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
    });


}




// >>> FUNGSI DATATABLE LIST TAB
function view_list_subtab(FSearch) {
        

    $('#tb_list_subtab').DataTable({

        dom: "<'ui stackable grid'" +
            "<'row'" +
            "<'left aligned ten wide column'>" +
            ">" +
            "<'row dt-table'" +
            "<'sixteen wide column'tr>" +
            ">" +
            "<'row'" +
            "<'left aligned eight wide column'B>" +
            "<'right aligned eight wide column'p>" +
            ">" +
            ">",

        buttons: 
        [
            {
                text: '10',
                action: function (e, dt, node, config) {
                    $('#tb_list_subtab').DataTable().page.len(10).draw();
                }
            },
            {
                text: '25',
                action: function (e, dt, node, config) {
                    $('#tb_list_subtab').DataTable().page.len(25).draw();
                }
            },
            {
                text: '50',
                action: function (e, dt, node, config) {
                    $('#tb_list_subtab').DataTable().page.len(50).draw();

                }
            },
            {
                text: '100',
                action: function (e, dt, node, config) {
                    $('#tb_list_subtab').DataTable().page.len(100).draw();

                }
            },
            // {
            //     text: '500',
            //     action: function (e, dt, node, config) {
            //         $('#tb_list_tab').DataTable().page.len(500).draw();
            //     }
            // },
            // {
            //     text: '1000',
            //     action: function (e, dt, node, config) {
            //         $('#tb_list_tab').DataTable().page.len(1000).draw();
            //     }
            // }
        ],


    destroy: true,
    stateSave: false,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],

    language: {
        sLengthMenu: "_MENU_",
        search: "",
        searchPlaceholder: "Search..",
        processing: '<i class="circle notch loading icon huge"></i>',
        emptyTable: 'tidak ada data yang ditampilkan',
    },

    order: [[0, "desc"]],

    columns: [
        
        { data  : 'nama_subtab' },
        { data  : 'namatab' },
        { data  : 'keterangan' },
        // { data  : 'namaroles' },
        { data  : null,
            render: function(data,row){

                    if(data['namaroles']=='' || data['namaroles']==null){

                        return `
                        semua user
                        `
                    }else{

                        return data['namaroles'];
                    }
            }
        },
        { data  : null,
            render: function(data,row){

                    if(data['created']=='FAILED'){

                        return `
                        <div class="ui red tiny label">
                        ERROR
                        </div>
                        `
                    }else if(data['created']=='SUCCESS'){

                        return `
                        <div class="ui green tiny label">
                        CREATED
                        </div>
                        `
                    }
            }
        },
        { data  : null,
            render: function(data,row){

                    //return `<i class="book icon editdata">`;

                    if(data['created']=='FAILED'    ){

                        return `<i class="ui trash icon iconcoloredit delete_tab" btnid="${data['id_subtab']}"></i></span>`;
                    }else if(data['created']=='SUCCESS'){

                        return `<span class='docicon' style='white-space: nowrap !important; word-spacing:5px !important;'><i class="ui edit outline icon iconcoloredit edit_tab" btnid="${data['id_subtab']}"></i>&nbsp;<i class="ui trash icon iconcoloredit delete_tab" btnid="${data['id_subtab']}"></i></span>`;
                    }

                    
                    //return '<i class="edit icon editdata" idedit="${data[0]}">
            }
            
        },

    ],

    


    
    ajax: {
        
        url     : `${restlocmds}table_subtab`,
        type    : 'POST',
        //PENTING!! error uncaught lenght
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        // data search
        data    : {
        // FStatus : FStatus,
        FSearch : FSearch,
        user    : userName1,
        },
        
        error: function(){
            if(fungsilogout){
    
                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        },

    },

    
    //STYLING KOLOM

    columnDefs: [
        { className: "center aligned", targets: [4] },
        // { className: "right aligned", targets: [5] },
        // {className : "collapsing", targets: [1,2,5,11,12]},
        // { "orderable": false, "targets": 13 },
    ],

// "columnDefs": [
//     { "orderable": false, "targets": 10 }
//   ],
    });
    

}
// END OF DATATABLE LIST NAMA TAB


// >>> FUNGSI HANDLER FILTER
function filter_handler_tb_tab(){

    searchval = $("#search_list_subtab").val();

    view_list_subtab(searchval);
}

// FILTER SEARCH
$('#search_list_subtab').keyup( function() {

    filter_handler_tb_tab();
})
// #### END OF FUNGSI FILTER HANDLER



//   FUNGSI MENAMPILKAN DATA YANG INGIN DIEDIT

// >>> FUNGSI MENGAMBIL DATA YANG INGIN DIUPDATE SESUAI ID
function view_data_edit (iddata){
    $("#stored_id_data").val(iddata);

    $("#tb_form_edit").find("#container_edit_data_sub").html(`
        <button class="ui right floated loading small gray button" id="loading_edit_data">
            simpan setting
        </button>
    `)

    $("#nama_sub_edit").val("");
    $("#keterangan_edit").val("");
    

    $(document).ready(function () {
        

        $.ajax({
            type: "POST",
            url: `${restlocmds}view_edit_sub`,

            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                iddata: iddata,

            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database!','error')
            
            } else if(obj.status==false) {

            Swal.fire({
                title: obj.message,
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
            
            $("#tb_form_edit").find("#container_edit_data_sub").html(`
                    <div class="ui right floated green labeled icon small disabled button" id="edit_data_sub" disabled>
                        <i class="save icon"></i>Edit Sub Tab
                    </div>
                `)

            // $('.modal_edit').modal('hide');
            
            
            } else {
                let datasub=obj.data;

                $("#tb_form_edit").find("#container_edit_data_sub").html(`
                    <div class="ui right floated green labeled icon small button" id="edit_data_sub" btnid="${datasub["id_subtab"]}">
                        <i class="save icon"></i>Edit Sub Tab
                    </div>
                `)

                $("#nama_sub_edit").val(datasub["nama_subtab"]);
                $("#keterangan_edit").val(datasub["keterangan"]);

            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });

            


        
        
    });


    }


    
// >>> FUNGSI MENAMPILKAN LIST ROLE PADA SUB TAB
function view_list_role (iddata){

    $("#td_list_roleuser").html("");

    $(document).ready(function () {
        

        $.ajax({
            type: "POST",
            url: `${restlocmds}view_list_role`,

            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                iddata: iddata,

            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database!','error')
            
            } else if(obj.status==false) {

            Swal.fire({
                title: obj.message,
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
            
            
            } else {
                let datasub=obj.data;

                if(datasub === "all"){
                    // sub tab bisa diakese semua role --> checkbox all role dicentang

                    $("#td_list_roleuser").html(`
                    tidak ada role khusus. sub tab bisa diakses semua user
                    
                    `).removeClass('except');
                }else{

                    let datarole = obj.data;
                    console.log(datarole);
                    let str_id=datarole['list_idsubrole'];
                    let arr_id = str_id.split(';|;');
                    let str_namarole=datarole['list_namarole'];
                    let arr_namarole = str_namarole.split(';|;');
                    
                    let html_tag="";

                    let banyakrole = arr_id.length;

                    for(let j=0;j<banyakrole;j++){

                        html_tag+=`
                        <a class="ui label label_rolekaryawan">
                            ${arr_namarole[j]}
                            <i class="delete icon deleterole" idsubrole="${arr_id[j]}"></i>
                        </a>
                        `

                    }

                    $("#td_list_roleuser").html(html_tag).addClass('except');
                    // $("#td_list_roleuser").html(html_tag)

                }
                console.log($("#tb_list_roleuser").find(".deleterole"));
            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });

            


        
        
    });


    }

$("#tb_list_roleuser").on("click",".deleterole",function(){
    let idsubrole=$(this).attr("idsubrole")
    let val_idsubs=$("#stored_id_data").val();
    if(idsubrole==""||idsubrole==null){
        Swal.fire({
            title: "id sub role kosong",
            text: "",
            icon: 'error',
            showCancelButton: false,
            confirmButtonText: 'Ya',
        });
    }else{

        Swal.fire({
        title: '<h2>Hapus role ini?</h2>',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya'
        }).then((result) => {
            console.log(result);
            if(result.isConfirmed){
                delete_subrole(idsubrole,val_idsubs);
            }
            
        })

        
    }
})



// >>> FUNGSI UNTUK MENYIMPAN NAMA TAB DAN KETERANGANNYA
function delete_subrole(idsubrole,idsubs){
    

    $.ajax({
    type: "POST",
    url: `${restlocmds}delete_subrole`,

    headers: {
        user: vusrnm,
        token: vtoken,
    },
    data:{
        idsubrole: idsubrole,
        idsub : idsubs,
    },
        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
                
                Swal.fire({
                    title: "Gagal menghapus data role",
                    text: "",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
            
            
            } else if(obj.status==false) {
            // tableType();
                Swal.fire({
                    title: obj.message,
                    text: "",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
            
            } else {
            
                Swal.fire({
                    title: obj.message,
                    text: "",
                    icon: 'success',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });

                view_list_role(idsubs)
                view_list_subtab(searcval)
            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
    });


}
// ################

    
// >>> FUNGSI KLIK TOMBOL TAMBAH ROLE KE TAB YANG DIPILIH
$("#simpan_subrole").on("click",function(){
    let val_idsub= $("#stored_id_data").val();
    let val_role=$("#drop_roles").dropdown('get value');
    

        if(val_idsub == "" || val_idsub==null){

            Swal.fire({
                title: "data sub tab kosong",
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });

        }else{
            if(val_role==null||val_role==""){
                // JIKA NAMA VAL NULL ATAU KOSONG -> TOLAK
        
                Swal.fire({
                    title: "pilih role yang ingin ditambahkan terlebih dahulu",
                    text: "",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
        
            }else{
        
                simpan_role_sub(val_role,val_idsub); // id karyawan , id role
        
            }
        }
        

    
});
// ##############



// >>> FUNGSI UNTUK MENYIMPAN NAMA TAB DAN KETERANGANNYA
function simpan_role_sub(idrole,id_sub){


    $.ajax({
    type: "POST",
    url: `${restlocmds}create_rolesub`,

    headers: {
        user: vusrnm,
        token: vtoken,
    },
    data:{
        idsub: id_sub,
        idrole: idrole,
    },
        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
                
                Swal.fire({
                    title: "Gagal menyimpan nama tab",
                    text: "",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
            
            
            } else if(obj.status==false) {
            // tableType();
                Swal.fire({
                    title: obj.message,
                    text: "",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
            
            } else {
            
                Swal.fire({
                    title: obj.message,
                    text: "",
                    icon: 'success',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });

                view_list_role(id_sub)
                view_list_subtab(searcval)
            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
    });


}
// ################
    
$('#tb_form_edit').on('click','#edit_data_sub', function() {
    // console.log($("#tb_form_edit").find("#container_edit_data_upload").html());
    
    $("#tb_form_edit").find("#container_edit_data_sub").html(`
        <button class="ui right floated loading small gray button" id="loading_edit_data">
            simpan setting
        </button>
    `)

    let id_edit = $("#stored_id_data").val();
    // return false;
    if(is_admin){
        // merupakan admin --> bisa melakukan update
        let val_namasub=$("#nama_sub_edit").val()
        let keterangan=$("#keterangan_edit").val()
        if(val_namasub!=="" || val_namasub !== null){
           
                $.ajax({
                    type: "POST",
                    url: `${restlocmds}update_sub`,
            
                    headers: {
                        user: vusrnm,
                        token: vtoken,
                    },
                    data:{
                        idsub:id_edit,
                        namasub:val_namasub,
                        keterangan:keterangan

                    },
                        success: function (response){
                    var obj = JSON.parse(response);
                    console.log(obj);
                    if(isEmpty(obj)) {
                        Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
                        
                    
                    } else if(obj.status==false) {

                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'error',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                        $("#tb_form_edit").find("#container_edit_data_sub").html(`
                            <div class="ui right floated green labeled icon small button" id="edit_data_sub" btnid="${id_edit}">
                                <i class="save icon"></i>Edit Sub Tab
                            </div>
                        `)

                        $('.modal_edit').modal('hide');

                    } else {

                        Swal.fire({
                            title: 'berhasil update data sub tab',
                            icon: 'success',
                            text: "klik refresh untuk melihat perubahan",
                            // showDenyButton: true,
                            // showCancelButton: true,
                            confirmButtonText: 'refresh',
                            // denyButtonText: `tumpuk data lama`,
                            // confirmButtonColor: '#21ba45',
                            // confirmButtonColor: '#3085d6',
                          }).then((result) => {
                            location.reload(); // force reload
                            if (result.isConfirmed) {
                                location.reload();
                            }
                        
                          })

                        $("#tb_form_edit").find("#container_edit_data_sub").html(`
                                <div class="ui right floated green labeled icon small button" id="edit_data_sub" btnid="${id_edit}">
                                    <i class="save icon"></i>Edit Sub Tab
                                </div>
                            `)

                        $('.modal_edit').modal('hide');

                        

                        view_list_subtab(searcval)
                    
                    }
                },
                error: function(){
                    if(fungsilogout){
            
                            window.location.href="./_logout.php";
                    }else{
                            console.log("error session")
                    }
                }
                });

        }else{

            Swal.fire({
                title: "Nama sub tab tidak boleh kosong",
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });

            $("#tb_form_edit").find("#container_edit_data_sub").html(`
                <div class="ui right floated green labeled icon small button" id="edit_data_sub" btnid="${id_edit}">
                    <i class="save icon"></i>Edit Sub Tab
                </div>
            `)
        }
        

    }else{
        console.log("not allowed")
    }

});


    // --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 5 HAPUS DATA UPLOAD (FILE, LINK, FOLDER SHARING)

function delete_sub(id_delete){
    

    $(document).ready(function () {
    
    
        $.ajax({
            type: "POST",
            url: `${restlocmds}delete_sub`,
    
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                idsub: id_delete,
                
                
            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
            
            
            } else if(obj.status==false) {
            // tableType();
            Swal.fire({
                title: obj.message,
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
            
            } else {
    
                // Swal.fire({
                //     title: obj.message,
                //     text: "",
                //     timer: 2500,
                //     icon: 'success',
                //     showCancelButton: false,
                //     showConfirmButton: false,
                //     // confirmButtonText: 'Ya',
                // });

                Swal.fire({
                    title: obj.message,
                    icon: 'success',
                    text: "klik refresh untuk melihat perubahan",
                    // showDenyButton: true,
                    // showCancelButton: true,
                    confirmButtonText: 'refresh',
                    // denyButtonText: `tumpuk data lama`,
                    // confirmButtonColor: '#21ba45',
                    // confirmButtonColor: '#3085d6',
                  }).then((result) => {
                    location.reload(); // force reload
                    if (result.isConfirmed) {
                        location.reload();
                    }
                
                  })

                // view_datatable(table_col,id_sub,id_tab,searchval);
                view_list_subtab(searcval)
            }
        },
        error: function(){
            if(fungsilogout){
    
                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });
    
    
    });
    
    }
    