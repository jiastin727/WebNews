const fungsilogout = false;
$('.ui.dropdown').dropdown({
    forceSelection:false
});
$(".menu .item").tab();

const NonceValue = "rdsystem2020";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocmds = decodeURIComponent(getCookie("restlocmdsdinamis"));
var btnstate=false;
var searchval="";

// >>> FUNGSI MENJALANKAN FUNGSI KETIKA HALAMAN LOAD (READY)
$( document ).ready(function() {

    if(is_error){
        let btnstate=false;

    }else{

        // tekan tombol edit data
        $('#tb_data_konten').on('click','.editdata', function() {
            let iddata=$(this).attr("btnid");
            view_data_edit(iddata);
            $('.modal_edit').modal('show');
        });

        $('#tb_data_konten').on('click','.infoitem', function() {
            let iddata=$(this).attr("btnid");
            view_data_info(iddata);
            $('.info_modal').modal('show');
        });

        $('#tb_form_edit').on('click','.deletefile', function() {

            let revisi = $(this).attr("rev");
            let nfile = $(this).attr("namafile");
            Swal.fire({
                title: '<h2>Hapus data mpl ini?</h2>',
                text: "DATA: "+nfile+" revisi: "+revisi,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya'
                }).then((result) => {
                    if(result.isConfirmed){
                    let idfile=$(this).attr("idfile");
                    delete_data_upload(idfile);
                    }
                })
            
            
            // $('.modal_edit').modal('show');
        });

        // FILTER SEARCH TABEL KONTEN
        $('#search_konten').keyup( function() {
        
            searchval=$('#search_konten').val();
            view_datatable(table_col,id_sub,id_tab,$('#search_konten').val());
        } );

        $('#tb_data_konten').on('click','.deletedata', function() {

            let judul = $(this).attr("judul");
            // let nfile = $(this).attr("namafile");
            Swal.fire({
                title: '<h2>Hapus data ini?</h2>',
                text: "DATA: "+judul,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya'
                }).then((result) => {
                    console.log(result);
                    if(result.isConfirmed){
                        let idkonten=$(this).attr("btnid");
                        delete_data_main(idkonten,judul);
                    }
                    
                })
            
            
            // $('.modal_edit').modal('show');
        });

        $('.closemodal_btn').on('click', function() {
            let namamodal=$(this).attr('modalname');
            $('.'+namamodal).modal('hide');
            // $('.uploaddvr').modal('hide');
        });


        console.log(json_general['isfile']);
        // const arr_general=JSON.parse(json_general);
        // console.log(arr_general);

        if(json_general['isfile']){
            // jika ada upload data
             btnstate=false;
             btnstate_edit=false;

            // memunculkan input ketika memilih jenis data yang ingin diupload
            $(".ui.dropdown.dropdownjenis").dropdown().dropdown({
                showOnFocus: false,
                onChange: function(value){
                console.log(value);

                    if(value==="FILE"){
                
                        document.getElementById("container_input_data_upload").innerHTML = `
                        <div class="ui input fluid small" style="margin-bottom:5px;">
                            <input type="file" id="input_data_uplaod" class="mandatoryclass" inputtype="file">
                            
                        </div>
                        <a class="ui label labelwarning">
                            <i class="ui info icon"></i>
                            ukuran maksimal 10mb

                            </a>
                        `;

                        document.getElementById("container_input_keterangan").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_keterangan" class="" type="text" inputtype="link" placeholder="keterangan">
                        </div>
                        `;
                    
                        btnstate=value;
                    }else if(value==='LINK'){
                        document.getElementById("container_input_data_upload").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_data_uplaod" class="mandatoryclass" type="text" id="2" inputtype="link" placeholder="Cantumkan lengkap beserta http:// atau https:// - nya.">
                        </div>
                        `;
                        btnstate=value;
                        // $("#btntxt").text("Gunakan Link");
                        document.getElementById("container_input_keterangan").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_keterangan" class="" type="text" inputtype="link" placeholder="keterangan">
                        </div>
                        `;
                        
                        console.log($(this));

                    }else if(value==="FOLDER_SHARING"){
                        document.getElementById("container_input_data_upload").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_data_uplaod" class="mandatoryclass" type="text" inputtype="foldersharing" placeholder="alamat folder sharing1" value="file:\\\\">
                        </div>
                        `;
                        btnstate=value;

                        document.getElementById("container_input_keterangan").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_keterangan" class="" type="text" inputtype="link" placeholder="keterangan">
                        </div>
                        `;
                    // $("#btntxt").text("Gunakan Link");
                        
                        // console.log($(this));

                    }else if(value===""){
                        $("#container_input_data_upload").html('');
                        $("#container_input_keterangan").html('');
                    }
                
                    console.log("btnstate->>"+btnstate);
                }

            });

            $(".ui.dropdown.dropdownjenis_edit").dropdown().dropdown({
                showOnFocus: false,
                onChange: function(value){
                console.log(value);

                    if(value==="FILE"){
                
                        document.getElementById("container_input_edit_upload").innerHTML = `
                        <div class="ui input fluid small" style="margin-bottom:5px;">
                            <input type="file" id="input_data_uplaod_edit" class="mandatoryclass" inputtype="file">
                            
                        </div>
                        <a class="ui label labelwarning">
                            <i class="ui info icon"></i>
                            ukuran maksimal 10mb

                            </a>
                        `;

                        document.getElementById("container_input_edit_keterangan").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_edit_keterangan" class="" type="text" inputtype="link" placeholder="keterangan">
                        </div>
                        `;
                    
                        btnstate_edit=value;
                    }else if(value==='LINK'){
                        document.getElementById("container_input_edit_upload").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_data_uplaod_edit" class="mandatoryclass" type="text" id="2" inputtype="link" placeholder="Cantumkan lengkap beserta http:// atau https:// - nya.">
                        </div>
                        `;
                        btnstate_edit=value;
                        // $("#btntxt").text("Gunakan Link");

                        document.getElementById("container_input_edit_keterangan").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_edit_keterangan" class="" type="text" inputtype="link" placeholder="keterangan">
                        </div>
                        `;
                        
                        console.log($(this));

                    }else if(value==="FOLDER_SHARING"){
                        document.getElementById("container_input_edit_upload").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_data_uplaod_edit" class="mandatoryclass" type="text" inputtype="foldersharing" placeholder="alamat folder sharing1" value="file:\\\\">
                        </div>
                        `;
                        btnstate_edit=value;
                    // $("#btntxt").text("Gunakan Link");
                        
                    document.getElementById("container_input_edit_keterangan").innerHTML = `
                        <div class="ui input fluid small">
                            <input id="input_edit_keterangan" class="" type="text" inputtype="link" placeholder="keterangan">
                        </div>
                        `;
                        // console.log($(this));

                    }else if(value===""){
                        $("#container_input_edit_upload").html('');
                        $("#container_input_edit_keterangan").html('');
                    }
                
                    console.log("btnstate_edit->>"+btnstate_edit);
                }

            });

        }else{
            // tidak ada sistem upload data

        }


        // untuk view datatable
        // cek apakah array kolom kosong atau tidak
        if(table_col.length>0){
            let datatable_column=[];

            view_datatable(table_col,id_sub,id_tab,"");
        }else{

            Swal.fire({
                title: 'data kolom kosong',
                icon: 'error',
                text: "",
                // showDenyButton: true,
                // showCancelButton: true,
                confirmButtonText: 'refresh',
                // denyButtonText: `tumpuk data lama`,
                // confirmButtonColor: '#21ba45',
                // confirmButtonColor: '#3085d6',
              }).then((result) => {
                
                if (result.isConfirmed) {
                    location.reload();
                }
            
              })
            
        }
        console.log(table_col.length);

    }

    

    
});

function id_translate(str_before){

    // spasi --> "_"
    // $str_after=str_replace(' ', '_', trim($str_before));
    // convert . ke |dot|
    let str_after=str_before.replaceAll('.', '-mds_dot-');

    return str_after;
}

function id_decode(str_before){

    // convert . ke
    let str_after=str_before.replaceAll('-mds_dot-', '.');

    return str_after;
}


function format_id(string_id){

    let formated = string_id.replace(/\./g , '\\\\.');
    return formated;
}


  // --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 4 FUNGSI UPLOAD FILE KETIKA TEKAN TOMBOL UPLOAD DATA

$('#tb_form_konten').on('click','#simpan_data_upload', function() {
    console.log($("#tb_form_konten").find("#td_simpan_data").html());
    
    $("#tb_form_konten").find("#td_simpan_data").html(`
        <button class="ui right floated loading small gray button" id="loading_simpan_data">
            simpan setting
        </button>
    `)
    // return false;
    if(is_admin){
        // merupakan admin --> bisa melakukan upload
        let dataupload = new FormData();
        let success_input=false;
        let success_data=false;
        let arr_field_col = {'wajib':[],'nonwajib':[]};
        if(jQuery.isEmptyObject(json_input_id)==false){
            // cek data array id input kosong atau tidak

            
            // MEMASUKKAN DATA INPUT UNTUK DIKIRIM
            loop_first_upload:
            for (var key in json_input_id) {
                // skip loop if the property is from prototype
                if (!json_input_id.hasOwnProperty(key)) continue;
            
                
                let id_input = json_input_id[key]; // array berisi id input
                if(key == "wajib"){
                    // ketika input adalah wajib (mandatory)
                    loop_wajib_upload:
                    for( let key_id in id_input){

                        let id_in = id_input[key_id];
                        let ada_field=document.getElementById(id_in);

                        // 
                        
                        if (ada_field) {
                            // cek field input ada atau tidak
                            let field_value=ada_field.value;
                            // cek input mandatory kosong atau tidak
                            if(field_value!==""&&field_value!==null){
                                // jika input mandatory tidak kosong

                                let namadata=id_in.replace('id_','');
                                console.log(arr_field_col);
                                arr_field_col['wajib'].push(namadata);
                                
                                dataupload.append(namadata, field_value);
                                success_input=true;
                                
                            }else{

                                Swal.fire({
                                    title: "Ada input mandatory (warna kuning) yang kosong",
                                    text: "",
                                    icon: 'error',
                                    showCancelButton: false,
                                    confirmButtonText: 'Ya',
                                });
                                success_input=false;
                                break loop_first_upload;
                            }

                        }else{
                            // error karena field tidak ada
                            Swal.fire({
                                title: "field dengan id :"+id_in+" tidak ditemukan",
                                text: "",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonText: 'Ya',
                            });
                            success_input=false;
                            break loop_first_upload;
                        }
                        
                        

                    }

                }else{
                    // ketika input bukan wajib
                    loop_nonwajib_upload:
                    for(let key_id in id_input){

                        let id_in = id_input[key_id];
                        let ada_field=document.getElementById(id_in);

                        // console.log("AAA");
                        // console.log(id_in);
                        // console.log($(`#${id_in}`).val());
                        if (ada_field) {

                            let field_value=ada_field.value;
                        
                            let namadata=id_in.replace('id_','');
                            arr_field_col['nonwajib'].push(namadata);
                            
                            dataupload.append(namadata, field_value);
                            success_input=true;
                            
                        }else{

                            // error karena field tidak ada
                            Swal.fire({
                                title: "field dengan id :"+id_in+" tidak ditemukan",
                                text: "",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonText: 'Ya',
                            });
                            success_input=false;
                            break loop_first_upload;
                        }

                    }


                }

                // for (var prop in obj) {
                //     // skip loop if the property is from prototype
                //     if (!obj.hasOwnProperty(prop)) continue;
            
                //     // your code
                //     alert(prop + " = " + obj[prop]);
                // }
            }


            // jika ada upload data
            if(json_general['isfile']){

                if ($("#tb_form_konten").find(".dropdownjenis").length > 0) {

                    let val_drop_jenis= $(".dropdownjenis").dropdown("get value");
            
                    if(val_drop_jenis!=""||val_drop_jenis!=null){
                        // menggunakan upload data atau file --> cek revisi
                                if(btnstate=='FILE'){
                                    let fileupload = $('#input_data_uplaod').prop("files")[0];
                                    let keterangan = $('#input_keterangan').val();
                                    let linkfile="";
                                    dataupload.append("file", fileupload);
                                    dataupload.append("linkfile", linkfile);
                                    dataupload.append("jenis", btnstate);
                                    dataupload.append("keterangan", keterangan);
                                    success_data=true;
                                }else if(btnstate==false){

                                    Swal.fire({
                                        title: "error--",
                                        text: "",
                                        icon: 'error',
                                        showCancelButton: false,
                                        confirmButtonText: 'ya',
                                    })
                                    success_data=false;
                                }else{
                                    let fileupload = "";
                                    let linkfile = $('#input_data_uplaod').val();
                                    let keterangan = $('#input_keterangan').val();

                                    if(linkfile!==""){
                                        dataupload.append("file", fileupload);
                                        dataupload.append("linkfile", linkfile);
                                        dataupload.append("jenis", btnstate);
                                        dataupload.append("keterangan", keterangan);
                                        success_data=true;
                                    }else{

                                        Swal.fire({
                                            title: "data upload tidak boleh kosong",
                                            text: "",
                                            icon: 'error',
                                            showCancelButton: false,
                                            confirmButtonText: 'Ya',
                                        });
                                        success_data=false;
                                    }
                                    
                                }
                        }else{

                            Swal.fire({
                                title: "pilih jenis data terlebih dahulu",
                                text: "refresh",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonText: 'Ya',
                            });
                            success_data=false;
                        }

                }else{

                    Swal.fire({
                        title: "error: dropdown jenis file tidak tersedia",
                        text: "refresh",
                        icon: 'error',
                        showCancelButton: false,
                        confirmButtonText: 'Ya',
                    });
                    success_data=false;
                }
            }else{

                success_data=true;
            }

            if(success_input&&success_data){
                $("#tb_form_konten").find("#td_simpan_data").html(`
                    <div class="ui right floated green labeled icon small button allowed" id="simpan_data_upload">
                        <i class="save icon"></i>Simpan Data
                    </div>
                `)
                console.log(json_general);  
                dataupload.append("arr_field_col", JSON.stringify(arr_field_col));
                dataupload.append("general", JSON.stringify(json_general));
                dataupload.append("id_sub", id_sub);
                dataupload.append("id_tab", id_tab);
                // ketika proses ambil value berhasil semua --> konenksi ajax
                $.ajax({
                    type: "POST",
                    url: `${restlocmds}create_data`,
                    processData: false,
                    contentType: false,
                    cache:false,
            
                    headers: {
                        user: vusrnm,
                        token: vtoken,
                    },
                        data:dataupload,
                        success: function (response){
                    var obj = JSON.parse(response);
                    console.log(obj);
                    if(isEmpty(obj)) {
                        Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
                        
                    
                    } else if(obj.status==false) {
                    // tableType();
                        
                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'error',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                    } else {

                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'success',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                        view_datatable(table_col,id_sub,id_tab,searchval);
                        clear_input_upload();
                    
                    }
                },
                error: function(){
                    if(fungsilogout){
            
                            window.location.href="./_logout.php";
                    }else{
                            console.log("error session")
                    }
                }
                });
            }else{
                $("#tb_form_konten").find("#td_simpan_data").html(`
                    <div class="ui right floated green labeled icon small button allowed" id="simpan_data_upload">
                        <i class="save icon"></i>Simpan Data
                    </div>
                `)
            }

            // test display formdata
            for (var pair of dataupload.entries()) {
                console.log(pair[0]+ ', ' + pair[1]); 
            }
            console.log(arr_field_col);




        }else{

            Swal.fire({
                title: "error: data id input kosong",
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
        }
        

    }

});

// fungsi untuk menghapus input ketika selesai uoload
function clear_input_upload(){

    $("#container_input_data_upload").html('');
    $("#container_input_keterangan").html('');
    $(".dropdownjenis").dropdown('restore defaults');
    for (var key in json_input_id) {
        // skip loop if the property is from prototype
        if (!json_input_id.hasOwnProperty(key)) continue;
        let id_input = json_input_id[key]; // array berisi id input
            // ketika input bukan wajib
            for(let key_id in id_input){
                let id_in = id_input[key_id];
                $("#"+id_in).val("");

        }
    }
    btnstate=false;

}



  // --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 4 FUNGSI UPLOAD FILE KETIKA TEKAN TOMBOL UPLOAD DATA

$('#tb_form_edit').on('click','#edit_data_upload', function() {
    console.log($("#tb_form_edit").find("#container_edit_data_upload").html());
    
    $("#tb_form_edit").find("#container_edit_data_upload").html(`
        <button class="ui right floated loading small gray button" id="loading_edit_data">
            simpan setting
        </button>
    `)

    let id_edit = $("#stored_id_data").val();
    // return false;
    if(is_admin){
        // merupakan admin --> bisa melakukan upload
        let dataupload = new FormData();
        let success_input=false;
        let success_data=false;
        let arr_field_col = {'wajib':[],'nonwajib':[]};
        if(jQuery.isEmptyObject(json_input_id_edit)==false){
            // cek data array id input kosong atau tidak

            
            // MEMASUKKAN DATA INPUT UNTUK DIKIRIM
            loop_first:
            for (var key in json_input_id_edit) {
                // skip loop if the property is from prototype
                if (!json_input_id_edit.hasOwnProperty(key)) continue;
            
                
                let id_input = json_input_id_edit[key]; // array berisi id input
                if(key == "wajib"){
                    // ketika input adalah wajib (mandatory)
                    loop_wajib:
                    for( let key_id in id_input){

                        let id_in = id_input[key_id];
                        let ada_field=document.getElementById(id_in);


                        
                        if (ada_field) {
                            // cek field input ada atau tidak
                            let field_value=ada_field.value;
                            // cek input mandatory kosong atau tidak
                            if(field_value!==""&&field_value!==null){
                                // jika input mandatory tidak kosong

                                let namadata=id_in.replace('id_edit_','');
                                console.log("adaaaa");
                                arr_field_col['wajib'].push(namadata);
                                
                                dataupload.append(namadata, field_value);
                                success_input=true;
                                
                            }else{

                                $("#tb_form_edit").find("#container_edit_data_upload").html(`
                                    <div class="ui right floated green labeled icon small button" id="edit_data_upload">
                                        <i class="save icon"></i>Edit Data
                                    </div>
                                `)

                                Swal.fire({
                                    title: "Ada input mandatory (warna kuning) yang kosong_",
                                    text: "",
                                    icon: 'error',
                                    showCancelButton: false,
                                    confirmButtonText: 'Ya',
                                });
                                // arr_field_col['wajib'].push(namadata);
                                console.log("kosonggg");
                                success_input=false;
                                break loop_first;
                            }

                        }else{

                            $("#tb_form_edit").find("#container_edit_data_upload").html(`
                                <div class="ui right floated green labeled icon small button" id="edit_data_upload">
                                    <i class="save icon"></i>Edit Data
                                </div>
                            `)
                            // error karena field tidak ada
                            Swal.fire({
                                title: "field dengan id :"+id_in+" tidak ditemukan",
                                text: "",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonText: 'Ya',
                            });
                            success_input=false;
                            break loop_first;
                        }
                        
                        

                    }

                }else{
                    // ketika input bukan wajib
                    loop_nonwajib:
                    for(let key_id in id_input){

                        let id_in = id_input[key_id];
                        let ada_field=document.getElementById(id_in);

                        if (ada_field) {

                            let field_value=ada_field.value;
                        
                            let namadata=id_in.replace('id_edit_','');
                            arr_field_col['nonwajib'].push(namadata);
                            
                            dataupload.append(namadata, field_value);
                            success_input=true;
                            
                        }else{

                            $("#tb_form_edit").find("#container_edit_data_upload").html(`
                                <div class="ui right floated green labeled icon small button" id="edit_data_upload">
                                    <i class="save icon"></i>Edit Data
                                </div>
                            `)

                            // error karena field tidak ada
                            Swal.fire({
                                title: "field dengan id :"+id_in+" tidak ditemukan",
                                text: "",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonText: 'Ya',
                            });
                            success_input=false;
                            break loop_first;
                        }

                    }


                }

                // for (var prop in obj) {
                //     // skip loop if the property is from prototype
                //     if (!obj.hasOwnProperty(prop)) continue;
            
                //     // your code
                //     alert(prop + " = " + obj[prop]);
                // }
            }

            console.log(success_input);
            if(success_input){
                $("#tb_form_konten").find("#td_simpan_data").html(`
                    <div class="ui right floated green labeled icon small button allowed" id="simpan_data_upload">
                        <i class="save icon"></i>Simpan Data
                    </div>
                `)

                console.log(json_general);  
                dataupload.append("arr_field_col", JSON.stringify(arr_field_col));
                dataupload.append("general", JSON.stringify(json_general));
                dataupload.append("id_sub", id_sub);
                dataupload.append("id_tab", id_tab);
                dataupload.append("iddata", id_edit);
                // ketika proses ambil value berhasil semua --> konenksi ajax
                $.ajax({
                    type: "POST",
                    url: `${restlocmds}update_data`,
                    processData: false,
                    contentType: false,
                    cache:false,
            
                    headers: {
                        user: vusrnm,
                        token: vtoken,
                    },
                        data:dataupload,
                        success: function (response){
                    var obj = JSON.parse(response);
                    console.log(obj);
                    if(isEmpty(obj)) {
                        Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
                        
                    
                    } else if(obj.status==false) {
                    // tableType();
                        
                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'error',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                        $("#tb_form_edit").find("#container_edit_data_upload").html(`
                            <div class="ui right floated green labeled icon small button" id="edit_data_upload">
                                <i class="save icon"></i>Edit Data
                            </div>
                        `)

                    } else {

                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'success',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                        view_datatable(table_col,id_sub,id_tab,searchval);
                        // clear_input_upload();
                        view_uploaded_data(id_edit)

                        $("#tb_form_edit").find("#container_edit_data_upload").html(`
                            <div class="ui right floated green labeled icon small button" id="edit_data_upload">
                                <i class="save icon"></i>Edit Data
                            </div>
                        `)
                    
                    }
                },
                error: function(){
                    if(fungsilogout){
            
                            window.location.href="./_logout.php";
                    }else{
                            console.log("error session")
                    }
                }
                });
            }else{
                $("#tb_form_konten").find("#td_simpan_data").html(`
                    <div class="ui right floated green labeled icon small button allowed" id="simpan_data_upload">
                        <i class="save icon"></i>Simpan Data
                    </div>
                `)
            }

            // test display formdata
            for (var pair of dataupload.entries()) {
                console.log(pair[0]+ ', ' + pair[1]); 
            }
            console.log(arr_field_col);




        }else{

            Swal.fire({
                title: "error: data id input kosong",
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });

            $("#tb_form_edit").find("#container_edit_data_upload").html(`
                <div class="ui right floated green labeled icon small button" id="edit_data_upload">
                    <i class="save icon"></i>Edit Data
                </div>
            `)
        }
        

    }

});


// >>>> FUNGSI COPY TEXT KE CLIPBOARD (ALAMAT FOLDER SHARING)
// 
$(document).on('click','.copyalamat',function(){
    let btntext=$(this).attr('alamat');
    // navigator.clipboard.writeText(btntext).then(function() {
    //   console.log('Async: Copying to clipboard was successful!');
    // }, function(err) {
    //   console.error('Async: Could not copy text: ', err);
    // });
  
    var $temp = $("<input>");
      $("body").append($temp);
      $temp.val(btntext).select();
      document.execCommand("copy");
      
  
      Swal.fire({
        text: 'Alamat berhasil disalin (alamat: '+$temp.val()+')',
        timer: 2000,
        position: 'center',
        toast: true,
        showConfirmButton: false
        })
  
        $temp.remove();
  
  });
  // 
  // END OF FUNGSI COY
  // ==========================================================================




//   FUNGSI MENAMPILKAN DATA YANG INGIN DIEDIT


// >>> FUNGSI MENGAMBIL DATA YANG INGIN DIUPDATE SESUAI ID
function view_data_edit (iddata){
    $("#stored_id_data").val(iddata);

    $(document).ready(function () {
        

        $.ajax({
            type: "POST",
            url: `${restlocmds}view_data_edit`,

            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                iddata: iddata,
                idsub: id_sub,
                idtab: id_tab,
                input_id : json_input_id,

            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database!','error')
            
            } else if(obj.status==false) {

            Swal.fire({
                title: obj.message,
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
            
            
            } else {

                console.log(obj.data['judul_data']);

                // MEMASUKKAN DATA INPUT yang diterima kedalam field yang sesuai
                    for (let key in json_input_id_edit) {
                        // skip loop if the property is from prototype
                        if (!json_input_id.hasOwnProperty(key)) continue;
                    
                        
                        let id_input = json_input_id_edit[key]; // array berisi id input
                        
                            for(let key_id in id_input){

                                let id_in = id_input[key_id];
                                let ada_field=document.getElementById(id_in);

                                if (ada_field) {

                                    var dataid = id_in.replace(/id_edit_/g,'');
                                    // $("#"+id_in).val(obj.data[`${dataid}`]);
                                    ada_field.setAttribute('value',obj.data[`${dataid}`]);
                                    
                                }else{

                                    // error karena field tidak ada
                                    Swal.fire({
                                        title: "field dengan id :"+id_in+" tidak ditemukan",
                                        text: "",
                                        icon: 'error',
                                        showCancelButton: false,
                                        confirmButtonText: 'Ya',
                                    });
                                    success_input=false;
                                    break;
                                }

                            }

                    }

                    if(obj.isfile){
                        //jika ada sistem upload data --> fungsi menampilkan data terupload
                        view_uploaded_data(iddata);
                    }

            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });

            


        
        
    });


    }


    
// >>> FUNGSI MENGAMBIL DATA YANG INGIN DITAMPILKAN
function view_data_info (iddata){
    // $("#stored_id_info").val(iddata);
    $("#container_info_data").html();

    $(document).ready(function () {
        

        $.ajax({
            type: "POST",
            url: `${restlocmds}view_data_edit`,

            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                iddata: iddata,
                idsub: id_sub,
                idtab: id_tab,
                input_id : json_input_id,

            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database!','error')
            
            } else if(obj.status==false) {

            Swal.fire({
                title: obj.message,
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
            
            
            } else {

                console.log(obj.data['judul_data']);
                console.log(json_input_id);
                let str_info=`<table class="ui small striped table single line historyupload_Info" width="100%">`;
                // MEMASUKKAN DATA INPUT yang diterima kedalam field yang sesuai
                    for (let key in json_input_id) {
                        // skip loop if the property is from prototype
                        if (!json_input_id.hasOwnProperty(key)) continue;
                    
                        
                        let id_input = json_input_id[key]; // array berisi id input
                        
                            for(let key_id in id_input){

                                let id_in = id_input[key_id];

                                

                                    var dataid = id_decode(id_in.replace(/id_/g,''));
                                    var dataid_ori = id_in.replace(/id_/g,'');
                                    $("#"+id_in).val(obj.data[`${dataid_ori}`]);
                                    let datavalue=obj.data[`${dataid_ori}`];
                                    str_info+=`
                                        <tr>
                                            <td width="30%" class="positive">${dataid.replace(/_/g, ' ')}</td>
                                            <td>${datavalue}</td>
                                        </tr>
                                    `;
                                    
                                
                                    
                                

                            }

                    }

                    str_info+=`</table>`;

                    $("#container_info_data").html(str_info);

                    if(obj.isfile){
                        //jika ada sistem upload data --> fungsi menampilkan data terupload
                        view_uploaded_data_info(iddata);
                    }

            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });

            


        
        
    });


    }


// --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 5 MENAMPILKAN LIST DATA YANG TELAH DIUPLOAD

function view_uploaded_data(iddata){
console.log("masuk")

$(document).ready(function () {


    $.ajax({
        type: "POST",
        url: `${restlocmds}view_uploaded_data`,

        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data:{
            iddata : iddata,
            idsub: id_sub,
            idtab: id_tab,
            
        },
            success: function (response){
        var obj = JSON.parse(response);
        console.log(obj);
        if(isEmpty(obj)) {
        Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
        
        
        } else if(obj.status==false) {
        // tableType();
        let strselector="#tablehistory"
        
        $(strselector).find('tbody').empty();

        $(strselector).find('tbody').append(`
            <tr>
                <td colspan='5' style="text-align:center; color:red;">
                error: tidak ada link/file tersimpan
                </td>

            </tr>
        `);
        
        } else {

        // SELECTOR TABEL HISTORY
        // KALAU MULTITYPE, TIAP HISTORY TABLE MEMILIKI KELAS SPESIFIK SESUAI TIPE
        let strselector="";
        
            strselector="#tablehistory";

        $(strselector).find('tbody').empty();
        var banyakhistory=obj['data'].length;

        for(var a=0;a<banyakhistory;a++){
            
            let islastfile=false;
            let islink=false;
            let string_data_history="";
            var jenisdata = obj['data'][a]['jenis_data'];
            console.log(jenisdata);
            var strpath="";
            if(jenisdata=="LINK"){

            islink=true;
            strpath=obj['data'][a]['path_file'];
            var namafile= obj['data'][a]['path_file'];

            }else if(jenisdata=="FILE"){

            islink=true;
            strpath=`../RND_Upload/`+obj['data'][a]['path_file'];
            // var namafile= obj[a]['file'].substring(obj[a]['file'].lastIndexOf('/') + 1);
            var namafile=obj['data'][a]['nama_file'];

            }else if(jenisdata=="FOLDER_SHARING"){
            
            islink=false;
            var namafile=obj['data'][a]['nama_file'];
            }

            console.log(namafile);

            // cek apakah merupakan revisi terakhir atau tidak
            console.log(obj['lastfile'][namafile]);
            if(obj['lastfile'][namafile][0]===obj['data'][a]['revisi']){
            islastfile=true;
            }else{
            islastfile=false;
            }

            if(islastfile){
            console.log("islast");
            var delbtn="<i class='trash deletefile iconcolorcross icon' directory='"+obj['data'][a]['path_file']+"' idproject='"+obj['data'][a]['id_table']+"' idfile='"+obj['data'][a]['id_data']+"' namafile='"+namafile+"' rev='"+obj['data'][a]['revisi']+"'></i>";
            }else{
            var delbtn="";
            }

            if(islink){

            string_data_history=`
                <a href="`+strpath+`" target='linktabhandler'>`+namafile+`</a>
            `

            }else{

            string_data_history=`
                <span class='text_history iconcoloredit copyalamat' alamat="`+namafile+`">`+namafile+`&nbsp; </span>
            `

            }

            // <button class="ui labeled icon tiny button copyalamat" alamat="`+namafile+`">
            //       <i class="copy outline icon"></i>
            //       copy
            //     </button>

        $(strselector).find('tbody').append(`
            <tr>
                <td style="text-align:center;">
                `+obj['data'][a]['date_modified']+`
                </td>

                <td style="text-align:center;" class='cuttext'>
                `+string_data_history+`
                </td>

                <td style="text-align:center;" width='10%'>
                `+obj['data'][a]['keterangan']+`
                </td>

                <td style="text-align:center;" width='10%'>
                `+obj['data'][a]['revisi']+`
                </td>
                
                <td style="text-align:center;" width='5%'>
                `+delbtn+`
                
                </td>
                
            </tr>
        `);
        
        }
        
        
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    }
    });


});

}



// --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 5 MENAMPILKAN LIST DATA YANG TELAH DIUPLOAD UNTUK INFO

function view_uploaded_data_info(iddata){
    console.log("masuk")
    
    $(document).ready(function () {
    
    
        $.ajax({
            type: "POST",
            url: `${restlocmds}view_uploaded_data`,
    
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                iddata : iddata,
                idsub: id_sub,
                idtab: id_tab,
                
            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
            let strselector="#tablehistory_info"
            $(strselector).find('tbody').empty();
            
            } else if(obj.status==false) {
            // tableType();
            let strselector="#tablehistory_info"
            
            $(strselector).find('tbody').empty();
    
            $(strselector).find('tbody').append(`
                <tr>
                    <td colspan='4' style="text-align:center; color:red;">
                    error: tidak ada link/file tersimpan
                    </td>
    
                </tr>
            `);
            
            } else {
    
            // SELECTOR TABEL HISTORY
            // KALAU MULTITYPE, TIAP HISTORY TABLE MEMILIKI KELAS SPESIFIK SESUAI TIPE
            let strselector="";
            
                strselector="#tablehistory_info";
    
            $(strselector).find('tbody').empty();
            var banyakhistory=obj['data'].length;
    
            for(var a=0;a<banyakhistory;a++){
                
                let islastfile=false;
                let islink=false;
                let string_data_history="";
                var jenisdata = obj['data'][a]['jenis_data'];
                console.log(jenisdata);
                var strpath="";
                if(jenisdata=="LINK"){
    
                islink=true;
                strpath=obj['data'][a]['path_file'];
                var namafile= obj['data'][a]['path_file'];
    
                }else if(jenisdata=="FILE"){
    
                islink=true;
                strpath=`../RND_Upload/`+obj['data'][a]['path_file'];
                // var namafile= obj[a]['file'].substring(obj[a]['file'].lastIndexOf('/') + 1);
                var namafile=obj['data'][a]['nama_file'];
    
                }else if(jenisdata=="FOLDER_SHARING"){
                
                islink=false;
                var namafile=obj['data'][a]['nama_file'];
                }
    
                console.log(namafile);
    
                // cek apakah merupakan revisi terakhir atau tidak
                console.log(obj['lastfile'][namafile]);
                if(obj['lastfile'][namafile][0]===obj['data'][a]['revisi']){
                islastfile=true;
                }else{
                islastfile=false;
                }
    
                if(islink){
    //<a href="`+strpath+`" target='linktabhandler'>`+namafile+`</a>
                string_data_history=`
                    
                    <a onclick="window.open('./?link=mdsviewpdf&pdf_file=../.././`+strpath+`', '_blank', 'location=no,height=570,width=1300,scrollbars=no,status=no');">`+namafile+`</a>
                `
    
                }else{
    
                string_data_history=`
                    <span class='text_history iconcoloredit copyalamat' alamat="`+namafile+`">`+namafile+`&nbsp; </span>
                `
    
                }
    
                // <button class="ui labeled icon tiny button copyalamat" alamat="`+namafile+`">
                //       <i class="copy outline icon"></i>
                //       copy
                //     </button>
    
            $(strselector).find('tbody').append(`
                <tr>
                    <td style="text-align:center;">
                    `+obj['data'][a]['date_modified']+`
                    </td>
    
                    <td style="text-align:center;" class='cuttext'>
                    `+string_data_history+`
                    </td>
    
                    <td style="text-align:center;" width='10%'>
                    `+obj['data'][a]['keterangan']+`
                    </td>
    
                    <td style="text-align:center;" width='10%'>
                    `+obj['data'][a]['revisi']+`
                    </td>
                    
                    
                </tr>
            `);
            
            }
            
            
            }
        },
        error: function(){
            if(fungsilogout){
    
                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });
    
    
    });
    
    }


  // --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 4 UPLOAD DATA

$('#tb_form_edit').on('click','#edit_upload_file', function() {
    console.log($("#tb_form_edit").find("#td_simpan_data").html());
    
    $("#tb_form_edit").find("#container_edit_upload").html(`
        <button class="ui right floated loading small gray button" id="loading_simpan_data">
            simpan setting
        </button>
    `)
    // return false;
    if(is_admin){
        // merupakan admin --> bisa melakukan upload
        let id_edit = $("#stored_id_data").val();
        let dataupload = new FormData();
        let success_input=false;
        let success_data=false;
        let arr_field_col = {'wajib':[],'nonwajib':[]};
        if(jQuery.isEmptyObject(json_input_id)==false){
            
            // jika ada upload data
            if(json_general['isfile']){

                if ($("#tb_form_edit").find(".dropdownjenis_edit").length > 0) {

                    let val_drop_jenis= $(".dropdownjenis_edit").dropdown("get value");
            
                    if(val_drop_jenis!=""||val_drop_jenis!=null){
                        // menggunakan upload data atau file --> cek revisi
                                if(btnstate_edit=='FILE'){
                                    let fileupload = $('#input_data_uplaod_edit').prop("files")[0];
                                    let keterangan = $('#input_edit_keterangan').val();
                                    let linkfile="";
                                    dataupload.append("file", fileupload);
                                    dataupload.append("linkfile", linkfile);
                                    dataupload.append("jenis", btnstate_edit);
                                    dataupload.append("keterangan", keterangan);
                                    success_data=true;
                                }else if(btnstate_edit==false){

                                    Swal.fire({
                                        title: "error: pilih jenis data terlebih dahulu",
                                        text: "",
                                        icon: 'error',
                                        showCancelButton: false,
                                        confirmButtonText: 'ya',
                                    })
                                    success_data=false;
                                }else{
                                    let fileupload = "";
                                    let linkfile = $('#input_data_uplaod_edit').val();
                                    let keterangan = $('#input_edit_keterangan').val();

                                    if(linkfile!==""){
                                        dataupload.append("file", fileupload);
                                        dataupload.append("linkfile", linkfile);
                                        dataupload.append("jenis", btnstate_edit);
                                        dataupload.append("keterangan", keterangan);
                                        success_data=true;
                                    }else{

                                        Swal.fire({
                                            title: "data upload tidak boleh kosong",
                                            text: "",
                                            icon: 'error',
                                            showCancelButton: false,
                                            confirmButtonText: 'Ya',
                                        });
                                        success_data=false;
                                    }
                                    
                                }
                        }

                }else{

                    Swal.fire({
                        title: "error: dropdown jenis file tidak tersedia",
                        text: "refresh",
                        icon: 'error',
                        showCancelButton: false,
                        confirmButtonText: 'Ya',
                    });
                    success_data=false;
                }
            }else{

                Swal.fire({
                    title: "error: sub tab ini tidak bisa upload data",
                    text: "refresh",
                    icon: 'error',
                    showCancelButton: false,
                    confirmButtonText: 'Ya',
                });
            }

            if(success_data){
                $("#tb_form_edit").find("#container_edit_upload").html(`
                    <div class="ui right floated green labeled icon small button" id="edit_upload_file">
                    <i class="upload icon"></i>Upload Data
                    </div>
                `)
                console.log(json_general);  
                dataupload.append("arr_field_col", JSON.stringify(arr_field_col));
                dataupload.append("general", JSON.stringify(json_general));
                dataupload.append("id_sub", id_sub);
                dataupload.append("id_tab", id_tab);
                dataupload.append("iddata", id_edit);
                // ketika proses ambil value berhasil semua --> konenksi ajax
                $.ajax({
                    type: "POST",
                    url: `${restlocmds}upload_data`,
                    processData: false,
                    contentType: false,
                    cache:false,
            
                    headers: {
                        user: vusrnm,
                        token: vtoken,
                    },
                        data:dataupload,
                        success: function (response){
                    var obj = JSON.parse(response);
                    console.log(obj);
                    if(isEmpty(obj)) {
                        Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
                        
                    
                    } else if(obj.status==false) {
                    // tableType();
                        
                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'error',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                    } else {

                        Swal.fire({
                            title: obj.message,
                            text: "",
                            icon: 'success',
                            showCancelButton: false,
                            confirmButtonText: 'Ya',
                        });

                        view_datatable(table_col,id_sub,id_tab,searchval);
                        view_uploaded_data(id_edit)
                        // clear_input_upload();
                        clear_upload_input();
                    
                    }
                },
                error: function(){
                    if(fungsilogout){
            
                            window.location.href="./_logout.php";
                    }else{
                            console.log("error session")
                    }
                }
                });
            }else{
                $("#tb_form_edit").find("#container_edit_upload").html(`
                    <div class="ui right floated green labeled icon small button" id="edit_upload_file">
                        <i class="upload icon"></i>Upload Data
                    </div>
                `)
            }

            // test display formdata
            for (var pair of dataupload.entries()) {
                console.log(pair[0]+ ', ' + pair[1]); 
            }
            console.log(arr_field_col);




        }else{

            Swal.fire({
                title: "error: data id input kosong",
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
        }
        

    }

});

// fungsi untuk menghapus input ketika selesai uoload
function clear_input_edit(){

    // $("#container_input_data_upload").html('');
    // $(".dropdownjenis").dropdown('restore defaults');
    for (var key in json_input_id_edit) {
        // skip loop if the property is from prototype
        if (!json_input_id.hasOwnProperty(key)) continue;
        let id_input = json_input_id[key]; // array berisi id input
            // ketika input bukan wajib
            for(let key_id in id_input){
                let id_in = id_input[key_id];
                $("#"+id_in).val("");

        }
    }
    

}

// fungsi untuk menghapus input ketika selesai uoload
function clear_upload_input(){

    $("#container_input_edit_upload").html('');
    $("#container_input_edit_keterangan").html('');
    $(".dropdownjenis_edit").dropdown('restore defaults');
    btnstate_edit=false;
    

}



// --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 5 HAPUS DATA UPLOAD (FILE, LINK, FOLDER SHARING)

function delete_data_upload(idfile){
    console.log("masuk")
    let id_edit = $("#stored_id_data").val();

    $(document).ready(function () {
    
    
        $.ajax({
            type: "POST",
            url: `${restlocmds}delete_uploaded_data`,
    
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                idfile : idfile,
                idsub: id_sub,
                idtab: id_tab,
                
            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
            
            
            } else if(obj.status==false) {
            // tableType();
            Swal.fire({
                title: obj.message,
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
            
            } else {
    
                Swal.fire({
                    title: obj.message,
                    text: "",
                    timer: 2500,
                    icon: 'success',
                    showCancelButton: false,
                    showConfirmButton: false,
                    // confirmButtonText: 'Ya',
                });

                view_uploaded_data(id_edit);
                view_datatable(table_col,id_sub,id_tab,searchval);
            }
        },
        error: function(){
            if(fungsilogout){
    
                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });
    
    
    });
    
    }
    


    // --------------------- KUMPULAN AJAX -------------------
// -----KUMPULAN AJAX 5 HAPUS DATA UPLOAD (FILE, LINK, FOLDER SHARING)

function delete_data_main(idmain,judul){
    

    $(document).ready(function () {
    
        if(id_anchor!=="" && id_anchor!==null){
        $.ajax({
            type: "POST",
            url: `${restlocmds}delete_data_main`,
    
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                idsub: id_sub,
                idtab: id_tab,
                idmain:idmain,
                judul:judul,
                id_anchor:id_anchor,
                
            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            Swal.fire('Error','Ada kendal di koneksi/database, data kosong','error');
            
            
            } else if(obj.status==false) {
            // tableType();
            Swal.fire({
                title: obj.message,
                text: "",
                icon: 'error',
                showCancelButton: false,
                confirmButtonText: 'Ya',
            });
            
            } else {
    
                Swal.fire({
                    title: obj.message,
                    text: "",
                    timer: 2500,
                    icon: 'success',
                    showCancelButton: false,
                    showConfirmButton: false,
                    // confirmButtonText: 'Ya',
                });

                view_datatable(table_col,id_sub,id_tab,searchval);
            }
        },
        error: function(){
            if(fungsilogout){
    
                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });
    
    }else{
        Swal.fire({
            title: "data id tidak lengkap",
            text: "",
            icon: 'error',
            showCancelButton: false,
            confirmButtonText: 'Ya',
        });
    }
    });
    
    }
    

    $('.menutab_click').on('click', function() {
        let idmenu_sub =  $(this).attr("idmenu_sub");
        let idmenu_tab =  $(this).attr("idmenu_tab");
        let namamenu =  $(this).attr("namamenu");
        window.location.href = `./?link=mdsd_direct&linkmds=mds_konten&tab=${idmenu_tab}&subtab=${idmenu_sub}&n=${namamenu}`;
    });
 
    $('.tabsuratgolive').on('click', function() {
      window.location.href = "./?link=golivemds";
    });
    $('.tabhasilmonitoring').on('click', function() {
      window.location.href = "./?link=monitormds";
    });
    $('.tabversion').on('click', function() {
      window.location.href = "./?link=versionhistory&app=MDS";
    });