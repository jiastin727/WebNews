//Activate dropdown & tab
$(".ui.pssdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const ColorOwner = "#00139f";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocvideonum = decodeURIComponent(getCookie("restlocvideonum"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
const LogoutProtect = false;

function LoadFamilyBrd(){
  var FSearch = $('#fcari_fam').val();
  var FSearch2 = $('#fcari_fam2').val();
  $.ajax({
    type: "POST",
    url: `${restlocvideonum}table_fam`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      FSearch: FSearch,
      FSearch2: FSearch2,
    },
    cache: false,
   
    success: function (response){
      var obj = JSON.parse(response);
      $("#FarmListBody").empty();
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        jmlData  = obj["data"].length;
        var cn = 0;
        for (a = 0; a < jmlData; a++) {
          cn++;
          var id_a  = obj['data'][a]['idid'];
          var cat_a = obj['data'][a]['cate'];
          var mod_a = obj['data'][a]['modl'];
          var img_a = obj['data'][a]['imag'];
          var not_a = obj['data'][a]['note'];
          var tyc_a = obj['data'][a]['typc'];
          var tys_a = obj['data'][a]['typs'];
          var chs_a = obj['data'][a]['chss'];
          var jml_i = obj['data'][a]['jmli'];
          var pic_a = obj['data'][a]['picc'];
          
          if(img_a ===""){
            var imgbrd = "<i>-- Belum Upload Foto Board --</i>";
          } else {
            var imgbrd = "<img height='140px' src='../RND_Upload/VideoDoc/_fileboard/"+img_a+"'>";
          }

          if(id_a % 2 == 0){ 
            var bgcol='#fdfdfd'; 
          } else {
            var bgcol='#efefef'; 
          }

          if ( pic_a.toUpperCase() == Udecrypt ) {
            var editlink_a = "<i class='edit outline editfam iconcoloredit icon' id='"+id_a+"'>";
          } else {
            var editlink_a = '';
          }

          if(cn == 1){
            $("#FamList").find("tbody").append(
              "<tr>"+
                "<td bgcolor='"+bgcol+"' rowspan='"+jml_i+"' class='center aligned' style='vertical-align: top;'>"+id_a+"</td>"+
                "<td bgcolor='"+bgcol+"' rowspan='"+jml_i+"' style='vertical-align: top;' class='collapsing'>"+cat_a+"</td>"+
                "<td bgcolor='"+bgcol+"' rowspan='"+jml_i+"' style='vertical-align: top;'>"+mod_a+"</td>"+
                "<td bgcolor='"+bgcol+"' class='center aligned' style='vertical-align: top;'>"+chs_a+"</td>"+
                "<td bgcolor='"+bgcol+"' class='collapsing' style='vertical-align: top;'>"+tyc_a+"</td>"+
                "<td bgcolor='"+bgcol+"' class='collapsing' style='vertical-align: top;'>"+tys_a+"</td>"+
                "<td bgcolor='"+bgcol+"' rowspan='"+jml_i+"' style='vertical-align: top;'>"+imgbrd+"</td>"+
                "<td bgcolor='"+bgcol+"' rowspan='"+jml_i+"' style='vertical-align: top;'>"+not_a+"</td>"+
                "<td bgcolor='"+bgcol+"' rowspan='"+jml_i+"' style='vertical-align: top;'>"+editlink_a+"</td>"+
              "</tr>"
            ); 
          } else {
            $("#FamList").find("tbody").append(
              "<tr>"+
                "<td bgcolor='"+bgcol+"' class='center aligned' style='vertical-align: top;'>"+chs_a+"</td>"+
                "<td bgcolor='"+bgcol+"' class='collapsing' style='vertical-align: top;'>"+tyc_a+"</td>"+
                "<td bgcolor='"+bgcol+"' class='collapsing' style='vertical-align: top;'>"+tys_a+"</td>"+
              "</tr>"
            ); 
          }
          if (cn == jml_i){
            var cn = 0;
          }

        }

      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }

    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },

  });

}


$(document).ready(function () {

  LoadFamilyBrd();

  $("#addnewfam").click(function(){
    $(".additem").modal({
      autofocus: false,
    }).modal('show');
    $('#inputchs').val('')
    $('#inputtype').val('')
    $('#inputdesc').val('')
  });

  $("#uploadfam").click(function(){
    var id   = $('#einputid').val();
    $("#uinputid").val(id);
    $(".uploaditem").modal('show');
    $(".edititem").modal('hide');
  });

  $("#addtype").click(function(){
    var id      = $('#einputid').val();
    $("#inputitemid").val(id);
    $(".addtype").modal('show');
    $(".edititem").modal('hide');
    $('#inputitemchs').val('');
    $('#inputitemtypec').val('');
    $('#inputitemtypes').val('');
  });

  $("#FamList").on("click", ".editfam", function () {
    var id  = $(this).attr("id");
    $.ajax({
      type: "POST",
      url: `${restlocvideonum}load_itemfam`,
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        id: id,
      },
      cache: false,
      success: function (response){
        $(".long.edititem").modal({
          autofocus: false,
        }).modal('show');
        var obj = JSON.parse(response);
        $("#TypeListBody").empty();
        if(isEmpty(obj)) {
          console.log('Gagal Simpan mas brooo, data kosong');
        } else if(obj) {
          var idid = obj['data'][0]['idid'];
          var cate = obj['data'][0]['cate'];
          var modl = obj['data'][0]['modl'];
          var note = obj['data'][0]['note'];
          var imag = obj['data'][0]['imag'];
          var traf = modl.slice(-1);
          if(imag ===""){
            imag="no-board.jpg"
          }
          if (traf == "1"){
            $("#einputtrafo").dropdown("set selected", "HORIZONTAL");
          } else {
            $("#einputtrafo").dropdown("set selected", "VERTICAL");
          }
          $("#einputcategory").dropdown("set selected", cate);
          $("#einputnote").val(note);
          $("#einputid").val(idid);
          $("#einputimage").html("<img src='../RND_Upload/VideoDoc/_fileboard/"+imag+"'>");

          jmlData  = obj["data"].length;
          for (a = 0; a < jmlData; a++) {
            var id_a  = obj['data'][a]['idpr'];
            var tyc_a = obj['data'][a]['typc'];
            var tys_a = obj['data'][a]['typs'];
            var chs_a = obj['data'][a]['chss'];
            if(chs_a !==""){
              $("#TypeList").find("tbody").append(
                "<tr>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'>"+chs_a+"</td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+tyc_a+"</td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+tys_a+"</td>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'><i class='trash red deleteitem icon' id='"+id_a+"' ty='"+tyc_a+"'></td>"+
                "</tr>"
              ); 
            } else {
              $("#TypeList").find("tbody").append(
                "<tr>"+
                  "<td colspan='4' class='center aligned' style='vertical-align: top;'>BELUM ADA DATA</td>"+
                "</tr>"
              ); 
            }
          }
  
        } else {
          Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
        }
        DelItem();
  
      },
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
  
    });

    window.setTimeout(function() {
      $('.long.edititem.modal').modal('refresh');
    },1000);

  });


  $("#FamList").on("click", ".viewdoc", function () {
    var num = $(this).attr("num").replaceAll("/", ".");
    var rev = $(this).attr("rev");
    var ext = $(this).attr("ext");
    window.open("../RND_Upload/VideoDoc/FAM_"+num+rev+"."+ext, "_blank");
  });

  $("#tabtmpb").click(function(){
    window.location.href = "./?link=vidindex";
  });
  $("#tabta").click(function(){
    window.location.href = "./?link=vidindex&sub=TA";
  });
  $("#tabsercom").click(function(){
    window.location.href = "./?link=vidindex&sub=SC";
  });
  $("#tabcpv").click(function(){
    window.location.href = "./?link=vidindex&sub=CPV";
  });
  $("#tabdrr").click(function(){
    window.location.href = "./?link=vidindex&sub=DRR";
  });
  $("#tabfamily").click(function(){
    window.location.href = "./?link=vidindex&sub=FAM";
  });
  $("#tabsetting").click(function(){
    window.location.href = "./?link=vidindex&sub=SET";
  });


});

//SAVE NEW FAM
$('#savedata').on('click', function(e){
  var icate = $('#inputcategory').val();
  var itraf = $('#inputtrafo').val();
  var inote = $('#inputnote').val();
  $.ajax({
    type: "POST",
    url: `${restlocvideonum}create_fam`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      icate     : icate,
      itraf     : itraf,
      inote     : inote,
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            title: 'Berhasil',
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          })
        }
        LoadFamilyBrd();

      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});


//SAVE EDIT FAM
$('#saveedit').on('click', function(e){
  var iid   = $('#einputid').val();
  var icate = $('#einputcategory').val();
  var itraf = $('#einputtrafo').val();
  var inote = $('#einputnote').val();
  $.ajax({
    type: "POST",
    url: `${restlocvideonum}update_fam`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      iid       : iid,
      icate     : icate,
      itraf     : itraf,
      inote     : inote,
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          })
        }
        $(".edititem").modal('hide');
        LoadFamilyBrd();

      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});


//SAVE NEW ITEM
$('#savetype').on('click', function(e){
  var iid  = $('#inputitemid').val();
  var ichs = $('#inputitemchs').val();
  var ityc = $('#inputitemtypec').val();
  var itys = $('#inputitemtypes').val();
  $.ajax({
    type: "POST",
    url: `${restlocvideonum}save_item`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      iid      : iid,
      ichs     : ichs,
      ityc     : ityc,
      itys     : itys,
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            title: 'Berhasil',
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          })
          $(".addtype").modal('hide');
          LoadFamilyBrd();
        }

      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});


//DELETE ITEM
function DelItem(){
$('.deleteitem').on('click', function(e){
  var id  = $(this).attr("id");
  var ty  = $(this).attr("ty");

  Swal.fire({
    title: '<h3>Hapus Type '+ty+'?</h3>',
    icon: 'info',
    confirmButtonText: 'Ya',
    showCancelButton: true
  }).then((result) => {
    if (result.value) {
      $(".edititem").modal('hide');
      $.ajax({
        type: "POST",
        url: `${restlocvideonum}delete_itemfam`,
        headers : {
          user  : vusrnm,
          token : vtoken
        },
        data: {
          id   : id
        },
        cache: false,
        success: function (response){
          var obj = JSON.parse(response);
          if(isEmpty(obj)) {
            Swal.fire('Error','Server error, Data mungkin bermasalah !','error');
          } else if (obj.code == "error"){
            Swal.fire('',obj.message,'error');
          } else {
            Swal.fire('Berhasil','Item berhasil dihapus.','success');
            LoadFamilyBrd();
          }
        },
        error: function(){
          Swal.fire('Error','Server tidak merespon, segera hubungi Webmaster !','error')
        }
      });
    }
  })

});
}

// Upload FAM Foto Board
$("#saveupload").on("click", function () {
  var file_data = $("#uinputfile").prop("files")[0];
  var idfam     = $('#uinputid').val();
  var form_data = new FormData();
  form_data.append("file", file_data);
  form_data.append("idfam", idfam);
  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `${restlocvideonum}upload_fam`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire({
          text: obj.message,
          timer: 1500,
          icon: "warning",
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          text: "Uploaded !",
          timer: 2000,
          toast: true,
          showConfirmButton: false,
        });
        LoadFamilyBrd();
        $(".uploaditem").modal("hide");
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});


$(".canceldata").click(function(){
  $(".additem").modal('hide');
  $(".addtype").modal('hide');
  $(".edititem").modal('hide');
  $(".uploaditem").modal('hide');
  // $('#inputchs').val('')
  // $('#inputtype').val('')
  // $('#inputdesc').val('')
});


//RESPON KETIKA INPUT PENCARIAN DI KETIK
$("#fcari_fam, #fcari_fam2").on("keyup", function () {
  var FilterCari = $("#fcari_fam").val();
  var FilterCari2 = $("#fcari_fam2").val();
  LoadFamilyBrd(FilterCari, FilterCari2);
});

