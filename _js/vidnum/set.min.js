//Activate dropdown & tab
$(".ui.pssdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const ColorOwner = "#00139f";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocvideonum = decodeURIComponent(getCookie("restlocvideonum"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
const LogoutProtect = false;

function TableListFunc(FSearch) {
  $("#SettingList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned eight wide column'B>" +
      "<'right aligned eight wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#SettingList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#SettingList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#SettingList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#SettingList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#SettingList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Search..",
      processing: '<i class="circle notch loading icon huge"></i>',
    },
    order: [[0, "desc"]],
    columns: [
      { data: null,
        render: function (data, type, row) {
            return parseInt(data['idid']).toString(16).toUpperCase();
        },
      },
      { data: 'chas' },
      { data: 'typs' },
      { data: 'sfgg' },
      { data: 'pnel' },
      { data: 'lbar' },
      { data: 'tcon' },
      { data: 'rom' },
      { data: null,
        render: function (data, type, row) {
          if(data['vess']){
            var ss = "<a class='item dwnloaddoc' id='"+data['idid']+"' je='S' nm='"+data['vess']+"'><i class='green cloud download icon'></i> Sound_"+data['vess']+"</a>";
          } else {
            var ss = "<a class='disabled item'><i class='cloud download icon'></i> Sound</a>";
          }
          if(data['vepi']){
            var sp = "<a class='item dwnloaddoc' id='"+data['idid']+"' je='P' nm='"+data['vepi']+"'><i class='green cloud download icon'></i> Picture_"+data['vepi']+"</a>";
          } else {
            var sp = "<a class='disabled item'><i class='cloud download icon'></i> Picture</a>";
          }
          if(data['veqm']){
            var sq = "<a class='item dwnloaddoc' id='"+data['idid']+"' je='Q' nm='"+data['veqm']+"'><i class='green cloud download icon'></i> QualityMap_"+data['veqm']+"</a>";
          } else {
            var sq = "<a class='disabled item'><i class='cloud download icon'></i> QualityMap</a>";
          }
          if(data['vegm']){
            var sg = "<a class='item dwnloaddoc' id='"+data['idid']+"' je='G' nm='"+data['vegm']+"'><i class='green cloud download icon'></i> Gamma_"+data['vegm']+"</a>";
          } else {
            var sg = "<a class='disabled item'><i class='cloud download icon'></i> Gamma</a>";
          }
          if(data['vesq']){
            var ssq = "<a class='item dwnloaddoc' id='"+data['idid']+"' je='SQ' nm='"+data['vesq']+"'><i class='green cloud download icon'></i> SmallQMap_"+data['vesq']+"</a>";
          } else {
            var ssq = "<a class='disabled item'><i class='cloud download icon'></i> SmallQMap</a>";
          }
          if(data['vetm']){
            var stm = "<a class='item dwnloaddoc' id='"+data['idid']+"' je='TM' nm='"+data['vetm']+"'><i class='green cloud download icon'></i> TMOMap_"+data['vetm']+"</a>";
          } else {
            var stm = "<a class='disabled item'><i class='cloud download icon'></i> TMOMap</a>";
          }
          return `
          <div class="ui divided selection list">
            ${ss}${sp}${sq}${sg}${ssq}${stm}
          </div>`;
        },
      },
      { data: 'note' },
      { data: null,
        render: function (data, type, row) {
          if ( Sect == 'VIDEO' && AppAuth ) {
            return `<i class="edit outline editsetting iconcoloredit icon" id="${data['idid']}">`;
          } else {
            return "";
          }
        },
      },
    ],
    columnDefs: [
      { className: "center aligned", targets: [0,9] },
      { className: "collapsing", targets: [0,1,2,7] },
      { orderable: false, targets: [3,4,5,6,7] },
    ],

    ajax: {
      url: `${restlocvideonum}table_setting`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
      },
      error: function () {
        // window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    },
  });

}


$(document).ready(function () {

  $("#addnewsetting").click(function(){
    $(".additem").modal('show');
    $('#inputchs').val('')
    $('#inputtype').val('')
    $('#inputnote').val('')
  });

  $(".uploadsetting").click(function(){
    var id   = $('#einputid').val();
    var label = $(this).attr('lb');
    var jns = $(this).attr('jns');
    $("#uinputid").val(id);
    $("#ujenis").val(jns);
    $(".uploaditem").modal('show');
    $(".edititem").modal('hide');
    $("#labelupload").text(label);
  });

  $("#SettingList").on("click", ".editsetting", function () {
    var id  = $(this).attr("id");
    $("#einputid").val(id);
    $(".edititem").modal({
      autofocus: false,
    }).modal('show');
    $.ajax({
      type: "POST",
      url: `${restlocvideonum}load_dataitem`,
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        id: id,
      },
      cache: false,
      success: function (response){
        $(".long.edititem").modal('show');
        $("#SSListBody").empty();
        $("#SPListBody").empty();
        $("#QMListBody").empty();
        $("#GMListBody").empty();
        $("#SQMListBody").empty();
        $("#TMMListBody").empty();
        var obj = JSON.parse(response);

        if(isEmpty(obj)) {
          console.log('Gagal Simpan mas brooo, data kosong');
        } else if(obj) {
          $('#einputid').val(obj['datachs'][0]['id']);
          $('#einputchs').val(obj['datachs'][0]['chassis']);
          $('#einputtype').val(obj['datachs'][0]['type_supply']);
          $('#einputnote').val(obj['datachs'][0]['note']);
          $('#einputsfg').val(obj['datachs'][0]['sfg']);
          $('#einputlbar').val(obj['datachs'][0]['ledbar']);
          $('#einputpnl').val(obj['datachs'][0]['panel']);
          $('#einputtcn').val(obj['datachs'][0]['tcon']);

          if (obj["datasound"] !== null){
            jmlData_a  = obj["datasound"].length;
            for (a = 0; a < jmlData_a; a++) {
              var id_a  = obj['datasound'][a]['id_ss'];
              var ver_a = obj['datasound'][a]['versi_ss'];
              var pic_a = obj['datasound'][a]['pic_ss'];
              // var fil_a = obj['datasound'][a]['file_ss'];
              if ( pic_a == Udecrypt ) {
                var linkdel_a = "<i class='trash red deleteitem icon' id='"+id_a+"' ve='"+ver_a+"' je='sound' j2='ss'>";
              } else {
                var linkdel_a = "";
              }

              $("#SSList").find("tbody").append(
                "<tr>"+
                  "<td class='left aligned' style='vertical-align: top;'><span class='dwnloaddoc' id='"+id+"' je='S' nm='"+ver_a+"'>"+ver_a+"</span></td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+pic_a+"</td>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'>"+linkdel_a+"</td>"+
                "</tr>"
              ); 
            }
          }

          if (obj["datapicture"] !== null){
            jmlData_b  = obj["datapicture"].length;
            for (b = 0; b < jmlData_b; b++) {
              var id_b  = obj['datapicture'][b]['id_pi'];
              var ver_b = obj['datapicture'][b]['versi_pi'];
              var pic_b = obj['datapicture'][b]['pic_pi'];
              if ( pic_b == Udecrypt ) {
                var linkdel_b = "<i class='trash red deleteitem icon' id='"+id_b+"' ve='"+ver_b+"' je='picture' j2='pi'>";
              } else {
                var linkdel_b = "";
              }
              $("#SPList").find("tbody").append(
                "<tr>"+
                  "<td class='left aligned' style='vertical-align: top;'><span class='dwnloaddoc' id='"+id+"' je='P' nm='"+ver_b+"'>"+ver_b+"</span></td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+pic_b+"</td>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'>"+linkdel_b+"</td>"+
                "</tr>"
              ); 
            }
          }

          if (obj["dataqmap"] !== null){
            jmlData_c  = obj["dataqmap"].length;
            for (c = 0; c < jmlData_c; c++) {
              var id_c  = obj['dataqmap'][c]['id_qm'];
              var ver_c = obj['dataqmap'][c]['versi_qm'];
              var pic_c = obj['dataqmap'][c]['pic_qm'];
              if ( pic_c == Udecrypt ) {
                var linkdel_c = "<i class='trash red deleteitem icon' id='"+id_c+"' ve='"+ver_c+"' je='qmap' j2='qm'>";
              } else {
                var linkdel_c = "";
              }
              $("#QMList").find("tbody").append(
                "<tr>"+
                  "<td class='left aligned' style='vertical-align: top;'><span class='dwnloaddoc' id='"+id+"' je='Q' nm='"+ver_c+"'>"+ver_c+"</span></td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+pic_c+"</td>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'>"+linkdel_c+"</td>"+
                "</tr>"
              ); 
            }
          }

          if (obj["datagamma"] !== null){
            jmlData_d  = obj["datagamma"].length;
            for (d = 0; d < jmlData_d; d++) {
              var id_d  = obj['datagamma'][d]['id_gm'];
              var ver_d = obj['datagamma'][d]['versi_gm'];
              var pic_d = obj['datagamma'][d]['pic_gm'];
              if ( pic_d == Udecrypt ) {
                var linkdel_d = "<i class='trash red deleteitem icon' id='"+id_d+"' ve='"+ver_d+"' je='gamma' j2='gm'>";
              } else {
                var linkdel_d = "";
              }
              $("#GMList").find("tbody").append(
                "<tr>"+
                  "<td class='left aligned' style='vertical-align: top;'><span class='dwnloaddoc' id='"+id+"' je='G' nm='"+ver_d+"'>"+ver_d+"</span></td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+pic_d+"</td>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'>"+linkdel_d+"</td>"+
                "</tr>"
              ); 
            }
          }

          if (obj["datasmallqm"] !== null){
            jmlData_d  = obj["datasmallqm"].length;
            for (d = 0; d < jmlData_d; d++) {
              var id_d  = obj['datasmallqm'][d]['id_sq'];
              var ver_d = obj['datasmallqm'][d]['versi_sq'];
              var pic_d = obj['datasmallqm'][d]['pic_sq'];
              if ( pic_d == Udecrypt ) {
                var linkdel_d = "<i class='trash red deleteitem icon' id='"+id_d+"' ve='"+ver_d+"' je='smallqm' j2='sq'>";
              } else {
                var linkdel_d = "";
              }
              $("#SQMList").find("tbody").append(
                "<tr>"+
                  "<td class='left aligned' style='vertical-align: top;'><span class='dwnloaddoc' id='"+id+"' je='SQ' nm='"+ver_d+"'>"+ver_d+"</span></td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+pic_d+"</td>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'>"+linkdel_d+"</td>"+
                "</tr>"
              ); 
            }
          }

          if (obj["datatm"] !== null){
            jmlData_d  = obj["datatm"].length;
            for (d = 0; d < jmlData_d; d++) {
              var id_d  = obj['datatm'][d]['id_tm'];
              var ver_d = obj['datatm'][d]['versi_tm'];
              var pic_d = obj['datatm'][d]['pic_tm'];
              if ( pic_d == Udecrypt ) {
                var linkdel_d = "<i class='trash red deleteitem icon' id='"+id_d+"' ve='"+ver_d+"' je='tmo' j2='tm'>";
              } else {
                var linkdel_d = "";
              }
              $("#TMMList").find("tbody").append(
                "<tr>"+
                  "<td class='left aligned' style='vertical-align: top;'><span class='dwnloaddoc' id='"+id+"' je='TM' nm='"+ver_d+"'>"+ver_d+"</span></td>"+
                  "<td class='collapsing' style='vertical-align: top;'>"+pic_d+"</td>"+
                  "<td width='10px' class='center aligned' style='vertical-align: top;'>"+linkdel_d+"</td>"+
                "</tr>"
              ); 
            }
          }

        } else {
          Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
        }
      
        DelItem();
  
      },
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
  
    });
  });


  $("#SettingList").on("click", ".viewdoc", function () {
    var num = $(this).attr("num").replaceAll("/", ".");
    var rev = $(this).attr("rev");
    var ext = $(this).attr("ext");
    window.open("../RND_Upload/VideoDoc/TMPB_"+num+rev+"."+ext, "_blank");
  });

  $("#tabtmpb").click(function(){
    window.location.href = "./?link=vidindex";
  });
  $("#tabta").click(function(){
    window.location.href = "./?link=vidindex&sub=TA";
  });
  $("#tabsercom").click(function(){
    window.location.href = "./?link=vidindex&sub=SC";
  });
  $("#tabcpv").click(function(){
    window.location.href = "./?link=vidindex&sub=CPV";
  });
  $("#tabdrr").click(function(){
    window.location.href = "./?link=vidindex&sub=DRR";
  });
  $("#tabfamily").click(function(){
    window.location.href = "./?link=vidindex&sub=FAM";
  });
  $("#tabsetting").click(function(){
    window.location.href = "./?link=vidindex&sub=SET";
  });


});

//SAVE NEW 
$('#savedata').on('click', function(e){
  var ichss = $('#inputchs').val();
  var itype = $('#inputtype').val();
  var inote = $('#inputnote').val();
  $.ajax({
    type: "POST",
    url: `${restlocvideonum}create_setting`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      ichss     : ichss,
      itype     : itype,
      inote     : inote,
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            text: "Saved !",
            timer: 2000,
            toast: true,
            showConfirmButton: false,
          })
        }
        $(".additem").modal('hide');
        var json_str = getCookie('FilterSetting');
        var arr = JSON.parse(json_str);
        if(json_str){
          var sfilter = arr[0];
        } else {
          var sfilter = "";
        }
        TableListFunc( sfilter);

      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});


//SAVE EDIT SETTING
$('#saveedit').on('click', function(e){
  var iid   = $('#einputid').val();
  var ichss = $('#einputchs').val();
  var itype = $('#einputtype').val();
  var inote = $('#einputnote').val();
  var iromm = $('#einputrom').val();
  var isfgg = $('#einputsfg').val();
  var ipnel = $('#einputpnl').val();
  var ilbar = $('#einputlbar').val();
  var itcon = $('#einputtcn').val();
  $.ajax({
    type: "POST",
    url: `${restlocvideonum}update_setting`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      iid       : iid,
      ichss     : ichss,
      itype     : itype,
      inote     : inote,
      iromm     : iromm,
      isfgg     : isfgg,
      ipnel     : ipnel,
      ilbar     : ilbar,
      itcon     : itcon,
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            text: "Updated !",
            timer: 2000,
            toast: true,
            showConfirmButton: false,
          })
        }
        $(".edititem").modal('hide');
        var json_str = getCookie('FilterSetting');
        var arr = JSON.parse(json_str);
        if(json_str){
          var sfilter = arr[0];
        } else {
          var sfilter = "";
        }
        TableListFunc( sfilter);

      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});



// Upload Dokumen
$(".saveupload").on("click", function () {
  var file_data = $("#uinputfile").prop("files")[0];
  var idsetting = $('#uinputid').val();
  var jenis     = $('#ujenis').val();
  var form_data = new FormData();
  form_data.append("file", file_data);
  form_data.append("idsetting", idsetting);
  form_data.append("jenis", jenis);
  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `${restlocvideonum}upload_setting`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire({
          text: obj.message,
          timer: 1500,
          icon: "warning",
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          text: "Uploaded !",
          timer: 2000,
          toast: true,
          showConfirmButton: false,
        });
        var d = new Date();
        var yearnow = d.getFullYear();
        var json_str = getCookie('FilterSetting');
        var arr = JSON.parse(json_str);
        if(json_str){
          var sfilter = arr[0];
          var tfilter = arr[1];
          var mfilter = arr[2];
        } else {
          var sfilter = "";
          var tfilter = yearnow;
          var mfilter = "ALL";
        }
        TableListFunc( sfilter, tfilter, mfilter);
        $(".uploaditem").modal("hide");
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});


$(".canceldata").click(function(){
  $(".additem").modal('hide');
  $(".edititem").modal('hide');
  $(".uploaditem").modal('hide');
  $('#inputchs').val('')
  $('#inputtype').val('')
  $('#inputnote').val('')
});


//DELETE ITEM
function DelItem(){
  $('.deleteitem').on('click', function(e){
    var id  = $(this).attr("id");
    var ver = $(this).attr("ve");
    var jns = $(this).attr("je");
    var j2  = $(this).attr("j2");

  
    Swal.fire({
      title: '<h3>Hapus Versi '+ver+'?</h3>',
      icon: 'info',
      confirmButtonText: 'Ya',
      showCancelButton: true
    }).then((result) => {
      if (result.value) {
        $(".edititem").modal('hide');
        $.ajax({
          type: "POST",
          url: `${restlocvideonum}delete_itemsetting`,
          headers : {
            user  : vusrnm,
            token : vtoken
          },
          data: {
            id   : id,
            j2   : j2,
            jns  : jns
          },
          cache: false,
          success: function (response){
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              Swal.fire('Error','Server error, Data mungkin bermasalah !','error');
            } else if (obj.code == "error"){
              Swal.fire('',obj.message,'error');
            } else {
              Swal.fire('Berhasil','Item berhasil dihapus.','success');
              $(".edititem").modal('hide');
              var json_str = getCookie('FilterSetting');
              var arr = JSON.parse(json_str);
              if(json_str){
                var sfilter = arr[0];
              } else {
                var sfilter = "";
              }
              TableListFunc( sfilter);
            }
          },
          error: function(){
            Swal.fire('Error','Server tidak merespon, segera hubungi Webmaster !','error')
          }
        });
      }
    })
  
  });

  $('.dwnloaddoc').on('click', function(e){
    var id   	= $(this).attr('id');
    var je   	= $(this).attr('je');
    var nm   	= $(this).attr('nm');

    $.redirect(
      "./?link=downloaddocvideo",
      { 
        id: id, 
        je: je,
        nm: nm,
      },
      "POST",
      "_blank"
    );
  });


  }




  //Download xls base on filter
  $("#SettingList").on("click", ".dwnloaddoc", function () {
    var id   	= $(this).attr('id');
    var je   	= $(this).attr('je');
    var nm   	= $(this).attr('nm');

    $.redirect(
      "./?link=downloaddocvideo",
      { 
        id: id, 
        je: je,
        nm: nm,
      },
      "POST",
      "_blank"
    );
  });


  
    
//Read Filter Cookies
var d = new Date();
var yearnow = d.getFullYear();

var json_str = getCookie('FilterSetting');
var arr = JSON.parse(json_str);
if(json_str){
  var sfilter = arr[0];
} else {
  var sfilter = "";
}

if (sfilter) {
  $("#fcari_setting").val(sfilter);
  var sfilterstart = sfilter;
} else {
  var sfilterstart = "";
}

var FiterArry = [sfilterstart];
var JsonFilter = JSON.stringify(FiterArry);
setCookie("FilterSetting", JsonFilter, 5);

//Load Table
TableListFunc( sfilterstart);

//RESPON KETIKA INPUT PENCARIAN DI KETIK
$("#fcari_setting").on("keyup", function () {
  var FilterCari = $("#fcari_setting").val();
  var FiterArry = [FilterCari];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterSetting", JsonFilter, 5);
  $("#SettingList").DataTable().destroy();
  TableListFunc(FilterCari);
});


