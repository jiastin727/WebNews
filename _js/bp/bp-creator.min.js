$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorRelease= "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocbp = decodeURIComponent(getCookie("restlocbp"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Jdecrypt = Ucrypt.decrypt(EncJ, NonceValue);

function TableListFunc(FSearch, FYear, FNama, FProgress, FStatus) {
  var DTables = $("#BPList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#BPList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#BPList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#BPList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#BPList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#BPList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[1, "desc"]],
    columns: [
      {
        data: null,
        render: function (data) {
          if (data['progress'] == "DONE" || data['status'] == "RELEASE") {

            return `<a href="../RND_Upload/BP/BPLengkap/${data['namaFile']}" target='_blank'><i class='file pdf red icon'></i></a>`;
          } else {
            // return `<span class="bplink pscdetail" eid="${data[0]}"><i class='pscdetail list icon'></i></span>`;
            return ``;
          }
        },
      },
      {
        data: null,
        render: function (data) {
          if (data['status'] !== "CANCEL") {
            return `<span class="editbp bplink" eid="${data[0]}">${data[1]}</span>`;
          } else {
            return `<span class="">${data[1]}</span>`;
          }

          
        },
      },
      { data: 'rev' },
      { data: 'disperindag' },
      { data: 'group_product' },
      { data: 'jenis_product' },
      { data: 'product' },
      { data: 'site' },
      { data: 'TypeSupply' },
      { data: 'note' },
      { data: 'sn' },
      { data: 'designer_bp' },
      { data: 'status' },
      { data: 'progress' },
      
    ],
    columnDefs: [
      { className: "center aligned", targets: [2] },
      { className: "collapsing", targets: [3,7,8] },
      { targets: [0,8], orderable: false },
      ],

   createdRow: function (row, data, index) {

      //WARNA OWNER & STATUS ACTIVE/DRAFT
      if (data["designer_bp"] == Udecrypt || data["head_dqa"] == Udecrypt) {
        $(row).find("td").css("color", ColorOwner);
      }

      // if ( (data["PICCycle"] == Udecrypt || data["PICElectronic"] == Udecrypt || data["PICID"] == Udecrypt || data["PICMD"] == Udecrypt || data["HeadGroupProduct"] == Udecrypt || data["ProjectOwner"] == Udecrypt ) && (data["status_sign"] == "NO")) {
      //   $(row).find("td").css("color", ColorSignNo);
      //   $(row).find("td").css("background-color", BgColorOwner);
      // }


      //WARNA FINISH & CLOSE
      if (data["status"] == "RELEASE") {
        $(row).find("td").css("color", ColorRelease);
      }

      //WARNA LOCK
      if (data["status"] == "LOCK") {
        $(row).find("td").css("color", ColorLock);
        $(row).find("td").css("background-color", BgColorLock);
      }
      
      //WARNA CANCEL
      if (data["status"] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }
      
    },

    ajax: {
      url: `${restlocbp}table_bp`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FYear: FYear,
        FNama: FNama,
        FProgress: FProgress,
        FStatus: FStatus,
      },
      
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}

function LoadDataEmail() {
  $.ajax({
    type: "POST",
    url: `${restlocbp}LoadDataEmail`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tampil !",
          "error"
        );
      } else {
        $("#TbSegmentBody").empty();
        jmlData  = obj['data'].length;
        for (a = 0; a < jmlData; a++) {
          $("#BPListEmail").find("tbody").append(
            "<tr>"+
              "<td>"+obj['data'][a]['nama']+"</td>"+
              "<td>"+obj['data'][a]['email']+"</td>"+
              "<td><span class='DelSegment' IdSeg='"+obj['data'][a]['id_emailreg']+"' NmSeg='"+obj['data'][a]['nama']+"'><i class='trash red link icon'></i></td>"+
            "</tr>"
          );   
        }
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
}

//Open Product Spec Content
$("#BPList").on("click", ".editbp", function () {
  var eid = $(this).attr("eid");
  let encryption = new Encryption();
  var eidENC = encryption.encrypt(eid, NonceValue);
  window.location.href = "./?link=bpcontent&i=" + eidENC;
});

//Download Product Spec Pdf
$("#BPList").on("click", ".downloadpdfbp", function () {
  var eidpdf = $(this).attr("eid");
  // $('<a href="./1_productspec/bppdf.php?id='+eidpdf+'" target="blank"></a>')[0].click(); 
  window.location.href = "./?link=viewbppdf&i=" + eidpdf;

});

//Download Product Spec Pdf
$("#BPList").on("click", ".pscdetail", function () {
  var eidpsc = $(this).attr("eid");
  let encryption = new Encryption();
  var eidpsce = encryption.encrypt(eidpsc, NonceValue);
  window.location.href = "./?link=bppscdetail&i=" + eidpsce;

});

$("#BPListEmail").on("click", ".DelSegment", function () {
  var IdSeg = $(this).attr("IdSeg");
  var NmSeg = $(this).attr("NmSeg");
  if (IdSeg){
    Swal.fire({
      title: "<h3>Hapus User "+NmSeg+" ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}DeleteUser`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdSeg  : IdSeg,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak terhapus !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              LoadDataEmail();
            }
          },
          error: function () {
            if (LogoutProtect){
              // window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }
});


$(document).ready(function () {

  LoadDataEmail();

   //Menampilkan modal window untuk menambahkan segment
  $('#addnewsegment').click(function(){
    $(".xwinaddnewsegment").modal({ autofocus: false }).modal("show");
    $("#NameSeg").val('');
    $("#DescSeg").val('');
  });
  //Add New Product Specification
  $("#addnewbp").on("click", function () {
    window.location.href = "./?link=bpheader";
  });

  $('#tabcompare').on('click', function() {
    window.location.href = "./?link=bpcompare";
  });

  $('#tabuserguide').on('click', function() {
    window.location.href = "./?link=guidebp";
  });
  $('.tabsuratgolive').on('click', function() {
    window.location.href = "./?link=golivembp";
  });
  $('.tabhasilmonitoring').on('click', function() {
    window.location.href = "./?link=monitormbp";
  });
  $('.tabversion').on('click', function() {
    window.location.href = "./?link=versionhistory&app=MBP";
  });
      
  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();

  var json_str = getCookie('FilterBPCreator');
  var arr = JSON.parse(json_str);
  if(json_str){
    var sfilter = arr[0];
    var tfilter = arr[1];
    var mfilter = arr[2];
    var pfilter = arr[3];
    var stfilter = arr[4];
  } else {
    var sfilter = "";
    var tfilter = yearnow;
    var mfilter = "ALL";
    var pfilter = "ALL";
    var stfilter = "ALL";
  }

  if (sfilter) {
    $("#fcari_bp").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (tfilter) {
    $("#fthn_bp").dropdown("set selected", tfilter);
    var tfilterstart = tfilter;
  } else {
    var tfilterstart = yearnow;
  }
  if (mfilter) {
    $("#fmn_bp").dropdown("set selected", mfilter);
    var mfilterstart = mfilter;
  } else {
    var mfilterstart = "ALL";
  }
  if (pfilter) {
    $("#fprg_bp").dropdown("set selected", pfilter);
    var pfilterstart = pfilter;
  } else {
    var pfilterstart = "ALL";
  }
  if (stfilter) {
    $("#fsts_bp").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    var stfilterstart = "ALL";
  }

  var FiterArry = [sfilterstart, tfilterstart, mfilterstart, pfilterstart, stfilterstart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterBPCreator", JsonFilter, 5);


  //Load Table
  TableListFunc( sfilterstart, tfilterstart, mfilterstart, pfilterstart, stfilterstart);

 
  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_bp").on("keyup", function () {
    var FilterCari = $("#fcari_bp").val();
    var FilterTahun = $("#fthn_bp").val();
    var FilterNama = $("#fmn_bp").val();
    var FilterProgress = $("#fprg_bp").val();
    var FilterStatus = $("#fsts_bp").val();
    var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterBPCreator", JsonFilter, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc(FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus);
    $("#BPList").DataTable().page(0).draw();
    
  });


  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fthn_bp, #fmn_bp, #fprg_bp, #fsts_bp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_bp").val();
      var FilterTahun = $("#fthn_bp").val();
      var FilterNama = $("#fmn_bp").val();
      var FilterProgress = $("#fprg_bp").val();
      var FilterStatus = $("#fsts_bp").val();
      var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterBPCreator", JsonFilter, 5);
      TableListFunc(FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus);
      // var table = $("#PSSList").DataTable();
      // var inff = table.page.info();
      // console.log(inff);
      $("#BPList").DataTable().page(0).draw();

    }
  );

  $('#SaveDataSegment').on('click', function() {
    $.ajax({
      type    : "POST",
      url     : `${restlocbp}AddNewEmail`,
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        NamePIC  : $("#NameReg").val(),
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          console.log('Gagal Simpan mas brooo, data kosong');
        } else if(obj) {
          if (obj.status == false){
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: 'warning',
              showConfirmButton: false
            });
          } else {
            Swal.fire({
              title: 'Berhasil',
              text: obj.message,
              timer: 1500,
              position: 'top-end',
              icon: 'success',
              showConfirmButton: false
            });
            LoadDataEmail();
            $(".xwinaddnewsegment").modal("hide");
          }
        } else {
          Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
        }
      },
      error: function () {
        if (LogoutProtect){
          // window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    });
  });

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#fcari_bp").val("");
    $("#fthn_bp").dropdown("set selected", yearnow);
    $("#fmn_bp").dropdown("set selected", "ALL");
    $("#fprg_bp").dropdown("set selected", "ALL");
    $("#fsts_bp").dropdown("set selected", "ALL");
    var FiterArry = ["", yearnow, "ALL", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterBPCreator", JsonFilter, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc("", yearnow, "ALL", "ALL", "ALL");
    $("#BPList").DataTable().page(0).draw();

  });

  $('#tabTimeline').on('click', function() { 
    window.location.href = "./?link=bptimeline";
  });

  $('#tabPSC').on('click', function() {
    window.location.href = "./?link=pscindex";
  });

  $('#tabMaster').on('click', function() {
    window.location.href = "./?link=bpmasterjumlahhalaman";
  });

});