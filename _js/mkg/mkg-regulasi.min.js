$(".ui.dropdown").dropdown(); 
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorFinish= "#505050";
const ColorDoneOS= "#999";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocean = decodeURIComponent(getCookie("restlocean"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Jdecrypt = Ucrypt.decrypt(EncJ, NonceValue);

function TableListFunc() {

  //Get isi cookies
  var json_str = getCookie('FilterEANRequest');
  var arr = JSON.parse(json_str);
  if(json_str){
    var sfilter   = arr[0];
    var mfilter   = arr[1];
    var stfilter  = arr[2];
  } else {
    var sfilter   = "";
    var mfilter   = "ALL";
    var stfilter  = "ALL";
  }
  if (sfilter) {
    $("#fcari_ean").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (mfilter) {
    $("#fmn_ean").dropdown("set selected", mfilter);
    var mfilterstart = mfilter;
  } else {
    var mfilterstart = "ALL";
  }
  if (stfilter) {
    $("#fsts_ean").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    var stfilterstart = "ALL";
  }

  //Simpan Cookies
  var FiterArry = [sfilterstart, mfilterstart, stfilterstart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterEANRequest", JsonFilter, 5);


  var DTables = $("#EANList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#EANList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[0, "desc"]],
    columns: [
      { data: null,
        render: function (data) {
          if (data['Id_EAN'] == "WAIT") {
            return ``;
          } else {
            return data['Id_EAN'];
          }
        },
      },
      { data: 'TypeEAN' },
      { data: 'JenisProduct' },
      { data: 'Product' },
      { data: 'Segname' },
      { data: 'TypeBarang' },
      { data: 'EANCode' },
      { data: 'RequestBy' },
      { data: 'PIC_EAN' },
      { data: 'Status' },
      { data: null,
        render: function (data) {
          if(Jdecrypt =="HEAD OF"){
            if ((data['Status'] == "ACTIVE") && (data['PIC_EAN'] == ""))  {
              return `<a IdNumE="`+data['id']+`" class="ui small green label EditEAN">Edit</a>`;
            } else if (data['Status'] == "ACTIVE")  {
              if(data['SendNotif'] == "N"){
                return `<a IdNumE="`+data['id']+`" class="ui small green label EditEAN">Edit</a><a IdNum="`+data['id']+`" class="ui small blue label SendNotif">Send Notif</a>`;
              } else {
                return `<a IdNumE="`+data['id']+`" class="ui small green label EditEAN">Edit</a><a IdNum="`+data['id']+`" class="ui small basic blue label SendNotif">Re-Send</a>`;
              }
            } else if (data['Status'] == "FINISH") {
              return `<a IdNumE="`+data['id']+`" EanCod="`+data['Barcode']+`" EanTyp="`+data['TypeEAN']+`" class="ui small label ViewBarcode">View Barcode</a>`;
            } else if (data['Status'] == "REQUEST") {
              return `<a IdNumC="`+data['id']+`" class="ui blue small label EANConfirm">Confirm</a><a IdNum="`+data['id']+`" class="ui small grey label Return">Return</a>`;
            } else {
              return ``;
            }
          } else {
            if ((data['Status'] == "ACTIVE") && (data['PIC_EAN'] == Udecrypt))  {
              if((data['EANCode'] !== "") && (data['Barcode'] !== "")) {
                return `<a IdNumE="`+data['id']+`" class="ui small green label EditEAN">Edit</a><a IdNum="`+data['id']+`" class="ui small blue label SetDone">Done</a>`;
              } else {
                return `<a IdNumE="`+data['id']+`" class="ui small green label EditEAN">Edit</a><a IdNum="`+data['id']+`" class="ui small grey label Return">Return</a>`;
              }
            } else if (data['Status'] == "FINISH") {
              // if(data['PIC_EAN'] == Udecrypt) {
              //   return `<i class="edit outline green link icon EditTBarang" IdNum="`+data['id']+`" TCtk="`+data['TypeBarang']+`"></i><a IdNumE="`+data['id']+`" EanCod="`+data['Barcode']+`" EanTyp="`+data['TypeEAN']+`" class="ui small label ViewBarcode">View Barcode</a>`;
              // } else {
                return `<a IdNumE="`+data['id']+`" EanCod="`+data['Barcode']+`" EanTyp="`+data['TypeEAN']+`" class="ui small label ViewBarcode">View Barcode</a>`;
              // }
            } else {
              return ``;
            }
          }

        },
      },
      
    ],
    columnDefs: [
      { className: "center aligned", targets: [0] },
      { className: "collapsing", targets: [10] },
      { orderable: false, targets: [10] },
      ],

   createdRow: function (row, data, index) {

      //WARNA PROCCESS
      if (data["PIC_EAN"] == Udecrypt) {
        $(row).find("td").css("color", ColorOwner);
      }

      //WARNA FINISH
      if (data["Status"] == "FINISH") {
        $(row).find("td").css("color", ColorFinish);
      }

      //WARNA CANCEL
      if (data["Status"] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }
      
    },

    ajax: {
      url: `${restlocean}table_eanregulasi`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch : sfilterstart,
        FNama   : mfilterstart,
        FStatus : stfilterstart,
      },
      
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}


function OSTableListFunc() {

  //Get isi cookies
  var json_str2 = getCookie('FilterOSEANRequest');
  var arr2 = JSON.parse(json_str2);
  if(json_str2){
    var sfilter2   = arr2[0];
    var stfilter2  = arr2[1];
  } else {
    var sfilter2   = "";
    var stfilter2  = "ALL";
  }
  if (sfilter2) {
    $("#fcari_ean2").val(sfilter2);
    var sfilterstart2 = sfilter2;
  } else {
    var sfilterstart2 = "";
  }
  if (stfilter2) {
    $("#fsts_ean").dropdown("set selected", stfilter2);
    var stfilterstart2 = stfilter2;
  } else {
    var stfilterstart2 = "ALL";
  }
  
  //Simpan Cookies
  var FiterArry2 = [sfilterstart2, stfilterstart2];
  var JsonFilter2 = JSON.stringify(FiterArry2);
  setCookie("FilterOSEANRequest", JsonFilter2, 5);


  var DTables2 = $("#OS_EANList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#OS_EANList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#OS_EANList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#OS_EANList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#OS_EANList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#OS_EANList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[0, "desc"]],
    columns: [
      { data: 'type_basic' },
      { data: 'type_supply' },
      // { data: 'jenis_product' },
      { data: null,
        render: function (data) {
          return data['jenis_product'].toUpperCase();
        },
      },
      { data: 'product' },
      { data: 'type_barang' },
      { data: 'ean_code' },
      { data: 'type_ean' },
      // { data: 'project_leader' },
      { data: 'status' },
      { data: null,
        render: function (data) {
          if ((data['status'] == "OUTSTANDING"))  {
              return `<a IdNum="`+data['id']+`" class="ui small blue label SetDoneOS">Done</a>`;
          } else {
              return ``;
          } 
        },
      },
      
    ],
    columnDefs: [
      { className: "center aligned", targets: [8] },
      { className: "collapsing", targets: [8] },
      { orderable: false, targets: [8] },
      ],
    createdRow: function (row, data, index) {
      //WARNA FINISH
      if (data["status"] == "FINISH") {
        $(row).find("td").css("color", ColorDoneOS);
      }
    },

    ajax: {
      url: `${restlocean}table_eanregulasi_os`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch : sfilterstart2,
        FStatus : stfilterstart2,
      },
      
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}

$("#EANList").on("click", ".EditEAN", function () {
  var IdNumE = $(this).attr("IdNumE");
  if(Jdecrypt =="HEAD OF"){
    $(".xwineditean").modal({ autofocus: false }).modal("show");
  } else {
    $(".xwinediteanPic").modal({ autofocus: false }).modal("show");
  }
  $.ajax({
    type: "POST",
    async: false,
    url: `${restlocean}LoadDataEAN`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      IdNum  : IdNumE,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tampil !",
          "error"
        );
      } else {
        $('.EditId').val(obj['data'][0]['id']);
        $('.EditNoEAN').text(obj['data'][0]['Id_EAN']);
        $('.EditTypeBasic').text(obj['data'][0]['TypeBasic']);
        $('.EditBrand').text(obj['data'][0]['Brand']);
        $('.EditTypeEAN').text(obj['data'][0]['TypeEAN']);
        $('.EditJenisPrd').text(obj['data'][0]['JenisProduct']);
        $('.EditProduct').text(obj['data'][0]['Product']);
        $('.EditSite').text(obj['data'][0]['Site']);
        $('.EditPL').text(obj['data'][0]['RequestBy']);
        $('.EditTypeBarang').html(obj['data'][0]['TypeBarang'].replace(/,/g, "<br>"));
        // $(".EditSegment").dropdown("clear");
        $(".EditSegment").dropdown("set selected", obj['data'][0]['Segname']);

        if(Jdecrypt =="HEAD OF"){
          $('.EditEANCode').text(obj['data'][0]['EANCode']);
          $(".EditAssignTo").dropdown("clear");
          $(".EditAssignTo").dropdown("set selected", obj['data'][0]['PIC_EAN']);
        } else {
          $('.EditEANCode').val(obj['data'][0]['EANCode']);
          $('.EditAssignTo').text(obj['data'][0]['PIC_EAN']);
        }
        if(obj['data'][0]['Barcode']){
          var randomnum = Math.floor((Math.random() * 10000) + 1);
          $('.EditBarcode').html('<img class="ui small image" src="../RND_Upload/BarcodeEAN/'+obj['data'][0]['Barcode']+'?r='+randomnum+'"></img>');
        } else {
          $('.EditBarcode').html('<i>Belum Upload Barcode</i>');
        }

      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
  // EditSegemntPIC();
});

$("#EANList").on("click", ".SendNotif", function () {
  var IdNum = $(this).attr("IdNum");
  if (IdNum){
    Swal.fire({
      title: "<h3>Kirim Notifikasi ke PIC bersangkutan?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}SendEmailNotif`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum  : IdNum,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              TableListFunc();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }

});


$("#EANList").on("click", ".Return", function () {
  var IdNum = $(this).attr("IdNum");
  $(".xwineanreturn").modal("show");
  $("#IdReturn").val(IdNum);
});

// $("#EANList").on("click", ".EditTBarang", function () {
//   var IdNum = $(this).attr("IdNum");
//   var TCtk = $(this).attr("TCtk");
//   $(".xwinedittypebarang").modal("show");
//   $("#IdEditTBarang").val(IdNum);
//   $("#ETypeBarang").val(TCtk);
// });




$("#EANList").on("click", ".EANConfirm", function () {
  var IdNum = $(this).attr("IdNumC");
  //xwineanreturn
  if (IdNum){
    Swal.fire({
      title: "<h3>Konfirmasi Permintaan Barcode EAN?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}ConfirmEAN`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum  : IdNum,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              TableListFunc();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }

});



$("#EANList").on("click", ".SetDone", function () {
  var IdNum = $(this).attr("IdNum");
  if (IdNum){
    Swal.fire({
      title: "<h3>Finish - Done ?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}FinishDoneEAN`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum  : IdNum,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak tersimpan !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              TableListFunc();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }

});


$("#OS_EANList").on("click", ".SetDoneOS", function () {
  var IdNum = $(this).attr("IdNum");
  if (IdNum){
    Swal.fire({
      title: "<h3>Finish - Done ?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}FinishDoneOS`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum  : IdNum,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire({
                text: obj.message,
                timer: 2500,
                icon: "error",
                showConfirmButton: false,
              });
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              TableListFunc();
              OSTableListFunc();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }

});

// 



$("#EANListSegment").on("click", ".DelSegment", function () {
  var IdSeg = $(this).attr("IdSeg");
  var NmSeg = $(this).attr("NmSeg");
  if (IdSeg){
    Swal.fire({
      title: "<h3>Hapus Segment "+NmSeg+" ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}DeleteSegemnt`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdSeg  : IdSeg,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak terhapus !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              LoadDataSegment();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }
});



$("#EANListPIC").on("click", ".DelPIC", function () {
  var IdPIC = $(this).attr("IdPIC");
  var NmPIC = $(this).attr("NmPIC");
  if (IdPIC){
    Swal.fire({
      title: "<h3>Hapus PIC: "+NmPIC+" ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}DeletePIC`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdPIC  : IdPIC,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak terhapus !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              LoadDataPIC();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }
});




$("#EANListEmailReceiver").on("click", ".DelEmailRec", function () {
  var IdEmailRec = $(this).attr("IdEmailRec");
  var NmEmailRec = $(this).attr("NmEmailRec");
  if (IdEmailRec){
    Swal.fire({
      title: "<h3>Hapus Email Receiver: "+NmEmailRec+" ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}DeleteEmailRec`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdPIC  : IdEmailRec,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire(
                "Error",
                "Ada kendal di koneksi/database, data tidak terhapus !",
                "error"
              );
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: "success",
                showConfirmButton: false,
              });
              LoadDataEmailReceiver();
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });
  }
});



$("#EANList").on("click", ".ViewBarcode", function () {
  var IdNumV = $(this).attr("IdNumE");
  var EanCod = $(this).attr("EanCod");
  var EanTyp = $(this).attr("EanTyp");
  $(".xwinviewbarcode").modal("show");
  $('#ean_code').html('<img class="ui medium image" src="../RND_Upload/BarcodeEAN/'+EanCod+'"></img>');
  $('#ean_type').text(EanTyp);

});




$("#SaveData").on("click", function () {
  var IdEAN = $('.EditId').val();
  $.ajax({
    type    : "POST",
    url     : `${restlocean}SaveEditEANReg`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      IdEAN   : IdEAN,
      Segmn   : $("#EditSegment").val(),
      Assig   : $("#EditAssignTo").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'success',
            showConfirmButton: false
          })
          TableListFunc();
          $(".xwineditean").modal("hide");
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
  
  
});




$(".BtnSaveReturn").on("click", function () {
  var IdEAN = $('#IdReturn').val();
  $.ajax({
    type    : "POST",
    url     : `${restlocean}ReturnEAN`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      IdEAN   : IdEAN,
      Reason  : $("#EanReason").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'success',
            showConfirmButton: false
          })
          TableListFunc();
          $(".xwineanreturn").modal("hide");

        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
  
  
});




$(".BtnSaveTypeBarang").on("click", function () {
  var IdEAN = $('#IdEditTBarang').val();
  $.ajax({
    type    : "POST",
    url     : `${restlocean}EditTypeBarang`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      IdEAN   : IdEAN,
      TBarang  : $("#ETypeBarang").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          })
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'success',
            showConfirmButton: false
          })
          TableListFunc();
          $(".xwinedittypebarang").modal("hide");
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
  
  
});


$('#SaveDataEmail').on('click', function() {
  $.ajax({
    type    : "POST",
    url     : `${restlocean}AddNewEmailReceive`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      NamePIC  : $("#NamePICEmail").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            title: 'Berhasil',
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          });
          LoadDataEmailReceiver(); 
          $(".xwinaddnewemailreceiver").modal("hide");
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});

$("#EditSegmentPIC").on("change", function () {
  var IdEAN = $('.EditId').val();
  $.ajax({
    type    : "POST",
    url     : `${restlocean}SaveSegmentChange`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      IdEAN   : IdEAN,
      EANSegm : $("#EditSegmentPIC").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          });
          TableListFunc();
        } else if (obj.status == null){
          //do nothing, show nothing ..
        } else {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'success',
            showConfirmButton: false
          });
          TableListFunc();
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});

function LoadDataSegment() {
  $.ajax({
    type: "POST",
    url: `${restlocean}LoadDataSegment`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tampil !",
          "error"
        );
      } else {
        $("#TbSegmentBody").empty();
        jmlData  = obj['data'].length;
        for (a = 0; a < jmlData; a++) {
          $("#EANListSegment").find("tbody").append(
            "<tr>"+
              "<td>"+obj['data'][a]['NameSeg']+"</td>"+
              "<td>"+obj['data'][a]['DescSeg']+"</td>"+
              "<td><span class='DelSegment' IdSeg='"+obj['data'][a]['IdSeg']+"' NmSeg='"+obj['data'][a]['NameSeg']+"'><i class='trash red link icon'></i></td>"+
            "</tr>"
          );   
        }
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
}



function LoadDataPIC() {
  $.ajax({
    type: "POST",
    url: `${restlocean}LoadDataPIC`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tampil !",
          "error"
        );
      } else {
        $("#TbPICBody").empty();
        jmlData  = obj['data'].length;
        for (a = 0; a < jmlData; a++) {
          $("#EANListPIC").find("tbody").append(
            "<tr>"+
              "<td>"+obj['data'][a]['NamePic']+"</td>"+
              "<td><span class='DelPIC' IdPIC='"+obj['data'][a]['IdPic']+"' NmPIC='"+obj['data'][a]['NamePic']+"'><i class='trash red link icon'></i></td>"+
            "</tr>"
          );   
        }
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
}



function LoadDataEmailReceiver() {
  $.ajax({
    type: "POST",
    url: `${restlocean}LoadDataEmailReceiver`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire(
          "Error",
          "Ada kendal di koneksi/database, data tidak tampil !",
          "error"
        );
      } else {
        $("#TbEmailReceiverBody").empty();
        jmlData  = obj['data'].length;
        for (a = 0; a < jmlData; a++) {
          $("#EANListEmailReceiver").find("tbody").append(
            "<tr>"+
              "<td>"+obj['data'][a]['NameEmail']+"</td>"+
              "<td><span class='DelEmailRec' IdEmailRec='"+obj['data'][a]['IdEmail']+"' NmEmailRec='"+obj['data'][a]['NameEmail']+"'><i class='trash red link icon'></i></td>"+
            "</tr>"
          );   
        }
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
}




$('#SaveDataSegment').on('click', function() {
  $.ajax({
    type    : "POST",
    url     : `${restlocean}AddNewSegment`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      NameSeg  : $("#NameSeg").val(),
      DescSeg  : $("#DescSeg").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            title: 'Berhasil',
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          });
          LoadDataSegment();
          $(".xwinaddnewsegment").modal("hide");
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});



$('#SaveDataPIC').on('click', function() {
  $.ajax({
    type    : "POST",
    url     : `${restlocmkg}AddNewPIC`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      NamePIC  : $("#NamePIC").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            title: 'Berhasil',
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          });
          LoadDataPIC();
          $(".xwinaddnewpic").modal("hide");
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});



$('#SaveDataEmail').on('click', function() {
  $.ajax({
    type    : "POST",
    url     : `${restlocean}AddNewEmailReceive`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      NamePIC  : $("#NamePICEmail").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            title: 'Berhasil',
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          });
          LoadDataEmailReceiver(); 
          $(".xwinaddnewemailreceiver").modal("hide");
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});

//Upload Barcode EAN
$('.BtnUploadBarcode').on('click', function() {
  var IdEAN     = $('#IdUpload').val();
  var FileData  = $("#FileBarcode").prop("files")[0];
  var form_data  = new FormData();
  form_data.append("file", FileData);
  form_data.append("IdEAN", IdEAN);
  $.ajax({
    type    : "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url     : `${restlocean}UploadBarcode`,
    headers : {
      user  : vusrnm,
      token : vtoken
    },
    data    : form_data,
    cache   : false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Gagal Simpan mas brooo, data kosong');
      } else if(obj) {
        if (obj.status == false){
          Swal.fire({
            text: obj.message,
            timer: 1500,
            icon: 'warning',
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            title: 'Berhasil',
            text: obj.message,
            timer: 1500,
            position: 'top-end',
            icon: 'success',
            showConfirmButton: false
          });
          $(".xwinuploadbarcode").modal("hide");
          TableListFunc();
        }
      } else {
        Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
      }
    },
    error: function () {
      if (LogoutProtect){
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
      }
    },
  });
});


$("#syncnewean").on("click", function () {

  Swal.fire({
    title: "<h2>Syncronize EAN?</h2>",
    html: "<strong>Penting: </strong><br>Fasilitas ini berfungsi untuk <strong>menyelaraskan data yang ada di PTB dengan data di tabel EAN ini</strong>, ketika ada data tipe basic (tipe barang) yang telah di input di PTB untuk di daftarkan EAN-nya di SAP.<br>Setelah tombol <strong>YA</strong> ditekan maka tipe basic (tipe barang) otomatis muncul di halaman <strong>tagihan di DQA Regulasi</strong> untuk di inputkan ke SAP.",
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type: "GET",
        url: `${restlocean}sync/ptb/type-basic/all`,
        headers: {
          user: vusrnm,
          token: vtoken,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(response);
          if (obj.status == false) {
            Swal.fire(
              "Error",
              "Ada kendal di koneksi/database, data tidak tersimpan !",
              "error"
            );
          } else {
            Swal.fire({
              text: "Berhasil sinkronisasi data tabel EAN !",
              timer: 3500,
              icon: "success",
            });
            TableListFunc();
            OSTableListFunc();
          }
        },
        error: function () {
          if (LogoutProtect){
            window.location.href = "./?link=loclogout";
          } else {
            Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
          }
        },
      });
    }
  });

});



$(document).ready(function () {

  //Load data-data
  LoadDataSegment();
  LoadDataPIC();
  LoadDataEmailReceiver();
  TableListFunc();
  OSTableListFunc();
  
  //Menampilkan modal window untuk menambahkan segment
  $('#addnewsegment').click(function(){
    $(".xwinaddnewsegment").modal({ autofocus: false }).modal("show");
    $("#NameSeg").val('');
    $("#DescSeg").val('');
  });
  
  //Menampilkan modal window untuk menambahkan PIC yang memproses EAN Barcode Request
  $('#addnewpic').click(function(){
    $(".xwinaddnewpic").modal({ autofocus: false }).modal("show");
  });

  //Menampilkan modal window untuk menambahkan penerima email untuk permintaan EAB barcode yg baru
  $('#addnewemailreceiver').click(function(){
    $(".xwinaddnewemailreceiver").modal({ autofocus: false }).modal("show");
  });

  //Menampilkan User Guide EAN
  $('#userguidemkg').on('click', function() {
    window.location.href = "./?link=guidemkg";
  });
  $('#tabTimeline').on('click', function() { 
    window.location.href = "./?link=mkgtimeline";
  });
  $('#tabAppSetting').on('click', function() { 
    window.location.href = "./?link=mkgappsetting";
  });

  //Untuk menampilkan modal window ketika Upload Barcode di tekan
  $('#UploadBarcode').click(function(){
    var IdEANUpload = $('.EditId').val();
    $(".xwinuploadbarcode").modal({ autofocus: false }).modal("show");
    $("#IdUpload").val(IdEANUpload);
    $("#FileBarcode").val('');
  });

  //Hidden modal windows ketika tombol cancel/close di modal window manapun di klik
  $('.CancelData').click(function(){
    $(".xwinviewbarcode").modal("hide");
    $(".xwineditean").modal("hide");
    $(".xwinaddnewsegment").modal("hide");
    $(".xwinaddnewpic").modal("hide");
    $(".xwinediteanPic").modal("hide");
    $(".xwinuploadbarcode").modal("hide");
    $(".xwinaddnewemailreceiver").modal("hide");
    $(".xwineanreturn").modal("hide");
    $(".xwinedittypebarang").modal("hide");

  });

  //Fungsi untuk dropdown bisa fullsearch text dimanapun posisi nya, bisa awal tengah atau akhir.
  $('.ui.dropdown.fullsearch').dropdown( {fullTextSearch:'exact', sortSelect: true, match:'text'} );


  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_ean").on("keyup", function () {
    var FilterCari = $("#fcari_ean").val();
    var FilterNama = $("#fmn_ean").val();
    var FilterStatus = $("#fsts_ean").val();
    var FiterArry = [FilterCari, FilterNama, FilterStatus];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterEANRequest", JsonFilter, 5);
    $("#EANList").DataTable().destroy();
    TableListFunc();
    $("#EANList").DataTable().page(0).draw();
  });

  $("#fcari_ean2").on("keyup", function () {
    var FilterCari2 = $("#fcari_ean2").val();
    var FilterStatus2 = $("#fsts_ean2").val();
    var FiterArry2 = [FilterCari2, FilterStatus2];
    var JsonFilter2 = JSON.stringify(FiterArry2);
    setCookie("FilterOSEANRequest", JsonFilter2, 5);
    $("#OS_EANList").DataTable().destroy();
    OSTableListFunc();
    $("#OS_EANList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER STATUS DI RUBAH
  $("#fmn_ean, #fsts_ean").on(
    "change",
    function () {
      var FilterCari = $("#fcari_ean").val();
      var FilterNama = $("#fmn_ean").val();
      var FilterStatus = $("#fsts_ean").val();
      var FiterArry = [FilterCari, FilterNama, FilterStatus];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterEANRequest", JsonFilter, 5);
      TableListFunc();
      $("#EANList").DataTable().page(0).draw();
    }
  );

  $("#fsts_ean2").on(
    "change",
    function () {
      var FilterCari2 = $("#fcari_ean2").val();
      var FilterStatus2 = $("#fsts_ean2").val();
      var FiterArry2 = [FilterCari2, FilterStatus2];
      var JsonFilter2 = JSON.stringify(FiterArry2);
      setCookie("FilterOSEANRequest", JsonFilter2, 5);
      OSTableListFunc();
      $("#OS_EANList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#fcari_ean").val("");
    $("#fcari_ean2").val("");
    $("#fmn_ean").dropdown("set selected", "ALL");
    $("#fsts_ean").dropdown("set selected", "ALL");
    $("#fsts_ean2").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    var FiterArry2 = ["", "ALL"];
    var JsonFilter2 = JSON.stringify(FiterArry2);
    setCookie("FilterEANRequest", JsonFilter, 5);
    setCookie("FilterOSEANRequest", JsonFilter2, 5);
    $("#EANList").DataTable().destroy();
    $("#OS_EANList").DataTable().destroy();
    TableListFunc();
    OSTableListFunc();
    $("#EANList").DataTable().page(0).draw();
    $("#OS_EANList").DataTable().page(0).draw();
  });


});