$('.ui.dropdown').dropdown(); 
var restlocmkg = decodeURIComponent(getCookie("restlocmkg"));

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
const NonceValue = "rdsystem2020";
const LogoutProtect = false;


$(document).ready(function() {
  LoadTempBarangDemand();
  if(IdEdit){
    $('#MKGHeadofGroup').dropdown('set selected',GroupPrd);
    $('#MKGHeadofRegulasi').dropdown('set selected',HODqa);
    $('#MKGSite').dropdown('set selected',Site);
  } else {
    $('#EANGroupProduct').dropdown("clear");
    IdEdit = "";
  }

  $("#UploadType").on("click", function (e) {
    $(".xwinuploadtype").modal({ autofocus: false, closable : false }).modal("show");
  });

  $('.InputTarget').hide();
  $('#MKGSite').on('change', function() {
    var site = $('#MKGSite').val();
    if (site=="SKM"){
      $('.InputTarget').show(500,"linear");
      $('#MKGSKMNama').val(NamaSKM);
      $('#MKGSKMAlamat').val(AlamatSKM);
      $('#MKGSKMKontak').val(KontakSKM);
      $('#MKGSKMFax').val(FaxSKM);
    } else {
      $('.InputTarget').hide(500);
      $('#MKGSKMNama').val('');
      $('#MKGSKMAlamat').val('');
      $('#MKGSKMKontak').val('');
      $('#MKGSKMFax').val('');
    }
  });

  if (Site == "SKM") {
    $(".InputTarget").show(500, "linear");
  } else {
    $(".InputTarget").hide(123);
    $('#MKGSKMNama').val('');
    $('#MKGSKMAlamat').val('');
    $('#MKGSKMKontak').val('');
    $('#MKGSKMFax').val('');
  }

  $('#tabEANReq').on('click', function() {
    window.location.href = "./?link=mkgindex";
  });

  $('#tabMKG').on('click', function() {
    window.location.href = "./?link=mkgindex";
  });

  $('#DownloadTemplate').on('click', function() {
    $.ajax({
      type    : "GET",
      url     : `${restlocmkg}dummy-type`,
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            // IsResponseTrue(obj.message);
            window.location.href = '../RND_BackEnd/backend_mkg/template-type';
          }
        } else {
          Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
        }
      },
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    });
  });
  // $("#DownloadTemplate").on("click", function (e) {
  //   $.ajax({
  //     type    : "GET",
  //     url     : window.location.href = '../RND_BackEnd/backend_mkg/template-type',
  //     headers : {
  //       user  : vusrnm,
  //       token : vtoken
  //     },
  //   });
    
  // });

  $('#HeaderButtonBack').on('click', function() {
    window.location.href = "./?link=mkgindex";
  });

  $('#userguidemkg').on('click', function() {
    window.location.href = "./?link=guidemkg";
  });

  $(".CloseModal").on("click", function (e) {
    $(".xwinuploadtype").modal("hide");
  });

  $("#EANBasic").on("input", function() {
    $('#EANSite').val('');
    $('#EANBrand').val('');
    $('#EANJenisProduct').val('');
    $('#EANProduct').val('');
  });

  $('#LoadTypeSupply').on('click', function() {
    LoadDataPTB();
    // LoadDataPTB();
  });

  function GetValue(a){
    if(a){
      return a;
    } else {
      return '';
    }
  }




//Fuction Load Microsoft Project - Function RESt dari PSS
function LoadTempBarangDemand(){
  
  $('#TblBarangDemandList').find('tbody').empty();
  $.ajax({
    type: "POST",
    url: `${restlocmkg}read_temptypebarangdemand`,
    headers: {
      user  : vusrnm,
      token : vtoken
    },
    data: { usernames :vusrnm},
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
    // console.log(obj);
      if(isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if(obj) {
        if (obj.status == 'error8'){
          $('#TblBarangDemandList').find('tbody').append(
            "<tr><td width='400px'>&nbsp;"+
            "</td><td class='center' >"+
            "</td><td class='center'></td></tr>");
        } else {
          jmlData = obj.length;
          for(a = 0; a < jmlData; a++){
            $('#TblBarangDemandList').find('tbody').append(
            "<tr id='"+a+"'><td width='400px'>"+obj[a]["typeBarangDemand"]+
            "</td><td class='center' width='80px'>"+obj[a]["brand"]+
            "</td><td class='center' width='150px'>"+obj[a]["jenis_product"]+
            "</td><td class='center' width='150px'>"+obj[a]["product"]+
            "</td><td class='center' width='150px'>"+obj[a]["project_leader"]+
            "</td><td class='center'><i class='trash actdeleteprjid iconcoloredit icon' id='"+obj[a]["id_tempmkg"]+"'></i></td></tr>");
          } 
          
          //Hapus Project ID
          $('.actdeleteprjid').on('click', function(e){
            var IdTemp  = $(this).attr('id');
            $.ajax({
              type: "POST",
              url: `${restlocmkg}Delete_TempBarangDemand`,
              headers: {
                user  : vusrnm,
                token : vtoken
              },
              data: {
                IdTemp : IdTemp
              },
              cache: false,
              success: function (response){
                var obj = JSON.parse(response);
                if (obj.status == false){
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  LoadTempBarangDemand();
                }
              },
              error: function () {
                IsTimeOut(LogoutProtect);
              },
            });
          });
        }
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

  function LoadDataPTB(){
    var itype = $('#TypeBarangDemand').val();
    if(itype){
      $('.PTBInput').addClass('loading');
      $.ajax({
        type    : "POST",
        url     : `${restlocmkg}LoadDataTypeBarangDemand`,
        headers : {
          user  : vusrnm,
          token : vtoken
        },
        data: {
          tbarangdemand    : itype,
          usernames  : vusrnm,
        },
        cache: false,
        success: function (response){
          var obj = JSON.parse(response);
          if(obj.status == false){
            IsResponseFalse(obj.message);
          }
          LoadTempBarangDemand();
          $('#TypeBarangDemand').val('');
        },
        error: function () {
          if (LogoutProtect){
            window.location.href = "./?link=loclogout";
          } else {
            Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
          }
        },
      });
    }
  }

  //fungsi tampilkan kalender pop-up
  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide : true,
    weekStart: 1
  });
  
  function LoadDataData(){
    $('.loaddatasite').on('click', function() {
      var site_a = $(this).attr('st');
      var bran_a = $(this).attr('br');
      var jnis_a = $(this).attr('jn');
      var prod_a = $(this).attr('pr');
      var tbrg_a = $(this).attr('tb');
      var tsup_a = $(this).attr('ts');
      $('#EANSite').val(GetValue(site_a));
      $('#EANBrand').val(GetValue(bran_a));
      $('#EANJenisProduct').val((GetValue(jnis_a)).toUpperCase());
      $('#EANProduct').val(GetValue(prod_a));
      $("#EANTypeBarang").dropdown("set selected", tbrg_a);
      $('#EANTypeSupply').val(GetValue(tsup_a));
    });
  }

  $('#HeaderButtonSave').on('click', function() {
    $.ajax({
      type    : "POST",
      url     : `${restlocmkg}CreateNewMKG`,
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        IdMkg         : IdEdit,
        mkgsite       : $("#MKGSite").val(),
        mkgnama       : $("#MKGSKMNama").val(),
        mkgkontak     : $("#MKGSKMKontak").val(),
        mkgalamat     : $("#MKGSKMAlamat").val(),
        mkgfax        : $("#MKGSKMFax").val(),
        mkgtarget     : $("#MKGTargetPenyelesaian").val(),
        mkghog        : $("#MKGHeadofGroup").val(),
        mkghoreg      : $("#MKGHeadofRegulasi").val(),
        mkgnote       : $("#MKGNote").val(),
        mkguser       : vusrnm,
        mkgpic        : $("#MKGPIC").val(),
        mkgsection    : $("#MKGSection").val(),
        // $("#AddItemPlant").val().toString();
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            window.location.href = "./?link=mkgindex";
          }
        } else {
          Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
        }
      },
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    });
  });

  $("#SubmitUpload").on("click", function () {
    var file_data = $("#UploadFileXls").prop("files")[0];
    var form_data = new FormData();
    form_data.append("file", file_data);
    form_data.append("Username", vusrnm);
    $.ajax({
      type: "POST",
      dataType: "text",
      contentType: false,
      processData: false,
      url: `../RND_BackEnd/backend_mkg/upload-type`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: form_data,
      cache: false,
      success: function (response) {
        var obj = JSON.parse(response);
        if (obj.status == false) {
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          $(".xwinuploadtype").modal("hide");
          LoadTempBarangDemand();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });

  //Delete EAN Request 
  $('#HeaderButtonDelete').on('click', function() {
    var idid = $('#EANIdEdit').val();

    Swal.fire({
      title: "<h3>Hapus Permintaan EAN Barcode ini ?</h3>",
      icon: "warning",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}Delete_EAN`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum    : idid,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'warning',
                showConfirmButton: false
              })
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'success',
                showConfirmButton: false
              });
              window.location.href = "./?link=eanindex";
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });

  });


  //Cancel EAN Request 
  $('#HeaderButtonCancel').on('click', function() {
    var idid = $('#EANIdEdit').val();

    Swal.fire({
      title: "<h3>Cancel Permintaan EAN Barcode ini ?</h3>",
      icon: "warning",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url: `${restlocean}Cancel_EAN`,
          headers: {
            user: vusrnm,
            token: vtoken,
          },
          data: {
            IdNum    : idid,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'warning',
                showConfirmButton: false
              })
            } else {
              Swal.fire({
                text: obj.message,
                timer: 1500,
                icon: 'success',
                showConfirmButton: false
              });
              window.location.href = "./?link=eanindex";
            }
          },
          error: function () {
            if (LogoutProtect){
              window.location.href = "./?link=loclogout";
            } else {
              Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
            }
          },
        });
      }
    });

  });


   //type basic autocomplete
   $(".ui.search.tbasic").search({
    minCharacters: 1,
    apiSettings: {
      url: "1_mkg/_autocompletetypebasic.php?tbarangdemand={query}",
    },
    fields: {
      results: "data",
      title: "type_barang_demand",
      // description: "desc",
    },
    
  });

  // $('.ui.dropdown.fullsearch').dropdown( {fullTextSearch:'exact', sortSelect: true, match:'text'} );




});

