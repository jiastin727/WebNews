$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorFinish= "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocmkg = decodeURIComponent(getCookie("restlocmkg"));
var restlocswrelease = decodeURIComponent(getCookie("restlocswrelease"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);




function TableListFunc() {

  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();

  var json_str = getCookie('FilterSWReleaseRequest');
  var arr = JSON.parse(json_str);
  if(json_str){
    var sfilter = arr[0];
    var mfilter = arr[1];
    var tfilter = arr[2];
  } else {
    var sfilter = "";
    var mfilter = "ALL";
    var tfilter = yearnow;
  }

  if (sfilter) {
    $("#fcari_mkg").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (mfilter) {
    $("#fmn_mkg").dropdown("set selected", mfilter);
    var mfilterstart = mfilter;
  } else {
    var mfilterstart = "ALL";
  }
  if (tfilter) {
    $("#fthn_mkg").dropdown("set selected", tfilter);
    var tfilterstart = tfilter;
  } else {
    var tfilterstart = yearnow;
  }

  var FiterArry = [sfilterstart, mfilterstart, tfilterstart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterSWReleaseRequest", JsonFilter, 5);

  var DTables = $("#MKGList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#MKGList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#MKGList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#MKGList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#MKGList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#MKGList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[1, "desc"]],
    columns: [
      { data: null,
        render: function (data) {
          return `<span class="editmkg mkgnolink" eid="${data['id']}" data-tooltip="View Detail/Edit Project" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
        },
      },
      { data: 'date' },
      { data: 'type' },
      { data: 'chasis' },
      { data: 'rom' },
      { data: 'pic' },
      // { data: 'Chassis' },
      { data: null,
        render: function (data) {
          return `<span class="delrom" id="${data['id']}" rom = "${data['rom']}" data-tooltip="Delete Project" data-inverted="" data-position="left center"><i class="trash alternate link circular red icon "></i></span>`;
        },
      },
    ],
   createdRow: function (row, data, index) {

      //WARNA PROCCESS
      if (data["pic"] == Udecrypt) {
        $(row).find("td").css("color", ColorOwner);
      }

      
    },

    ajax: {
      url: `${restlocswrelease}table_project`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch : sfilterstart,
        FNama   : mfilterstart,
        FTahun   : tfilterstart
      },

      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}

//Open Product Spec Content
$("#MKGList").on("click", ".editmkg", function () {
  var eid = $(this).attr("eid");
  let encryption = new Encryption();
  var eidENC = encryption.encrypt(eid, NonceValue);
  window.location.href = "./?link=swvideoreqnew&i=" + eidENC;
});

$("#MKGList").on("click", ".delrom", function () {
  var id = $(this).attr("id");
  var rom = $(this).attr("rom");
  DeleteROM(id,rom);
});


function DeleteROM(Id,Nm){
  Swal.fire({
    html: "<h3>Hapus Status<br>- "+Nm+" -</h3>",
    confirmButtonText: "Ya",
    showCancelButton: true,
    backdrop: `rgba(123,0,0,0.3)`,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type    : "POST",
        url     : `${restlocswrelease}DeleteRom`,
        headers : {
          user  : vusrnm,
          token : vtoken
        },
        data    : {
          Id : Id,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(response);
          if(isEmpty(obj)) {
            IsResponseEmptyObj();
          } else if(obj) {
            if (obj.status == false){
              IsResponseFalse(obj.message);
            } else {
              IsResponseTrue(obj.message);
              TableListFunc();
            }
          } else {
            IsResponseErrorElse();
          }
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });
    }
  });
}


$("#MKGList").on("click", ".ViewBarcode", function () {
  var IdNumV = $(this).attr("IdNumE");
  var EanCod = $(this).attr("EanCod");
  var EanTyp = $(this).attr("EanTyp");
  $(".xwinviewbarcode").modal("show");
  $('#ean_code').html('<img class="ui medium image" src="../RND_Upload/BarcodeEAN/'+EanCod+'"></img>');
  $('#ean_type').text(EanTyp);

});


//Download xls base on filter
  $("#dwnldxls").on("click", function () {
    var iddownload= "DSG";
    var search   	= $('#fcari_mkg').val();
    var thnfilter = $('#fthn_mkg').val();
    var picfilter = $('#fmn_mkg').val();

    $.redirect(
      "./?link=mkgdwnldxls",
      { 
        id: iddownload,
        search: search, 
        thnfilter: thnfilter,
        picfilter: picfilter
      },
      "POST",
      "_blank"
    );
  });

$(document).ready(function () {
  $("#addnewproject").on("click", function () {
    window.location.href = "./?link=swvideoreqnew";
  });

  $('#userguidemkg').on('click', function() {
    window.location.href = "./?link=guidemkg";
  });

  $('#tabTimeline').on('click', function() { 
    window.location.href = "./?link=swtimeline";
  });

  $('#tabcreateproject').on('click', function() { 
    window.location.href = "./?link=swvideoindex";
  });

  $('#tabappsetting').on('click', function() { 
    window.location.href = "./?link=swappsetting";
  });

  $('#tabchangepic').on('click', function() { 
    window.location.href = "./?link=swchangepic";
  });

  $('.CancelData').click(function(){
    $(".xwinaddnewpic").modal("hide");
    $(".xwinaddnewemailreceiver").modal("hide");
  });

  
  //Load Table
  TableListFunc();

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mkg").on("keyup", function () {
    var FilterCari = $("#fcari_mkg").val();
    var FilterNama = $("#fmn_mkg").val();
    var FilterTahun = $("#fthn_mkg").val();
    var FiterArry = [FilterCari, FilterNama, FilterTahun];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSWReleaseRequest", JsonFilter, 5);
    $("#MKGList").DataTable().destroy();
    TableListFunc();
    $("#MKGList").DataTable().page(0).draw();
  });


  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fmn_mkg, #fthn_mkg, #fsts_mkg, #fprg_mkg").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mkg").val();
      var FilterNama = $("#fmn_mkg").val();
      var FilterTahun = $("#fthn_mkg").val();
      var FiterArry = [FilterCari, FilterNama, FilterTahun];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterSWReleaseRequest", JsonFilter, 5);
      TableListFunc();
      $("#MKGList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#fcari_mkg").val("");
    $("#fthn_mkg").dropdown("set selected", yearnow);
    $("#fmn_mkg").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", yearnow];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSWReleaseRequest", JsonFilter, 5);
    $("#MKGList").DataTable().destroy();
    TableListFunc("", "ALL", "ALL");
    $("#MKGList").DataTable().page(0).draw();
  });


});