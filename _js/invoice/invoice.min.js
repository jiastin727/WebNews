$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocinvoice = decodeURIComponent(getCookie("restlocinvoice"));
var d = new Date();
var day = d.getDate() + "";
var month = d.getMonth() + 1 + "";
if (day.length < 2) { day = "0" + day; }
if (month.length < 2) { month = "0" + month; }
var mdnow = month+day;
var enc = new Encryption();
var erl = enc.encrypt("1"+mdnow, NonceValue);

  function InvoiceFunc(FSearch,FYear){
    var d1 = enc.decrypt(EncR, NonceValue);
    var d2 = enc.decrypt(erl, NonceValue);
    $('#InvoiceList').DataTable({
      dom : "<'ui stackable grid'"+
            "<'row'"+
            "<'left aligned ten wide column'>"+
            ">"+
            "<'row dt-table'"+
            "<'sixteen wide column'tr>"+
            ">"+
            "<'row'"+
            "<'left aligned eight wide column'B>"+
            "<'right aligned eight wide column'p>"+
            ">"+
            ">",
      buttons: [
        {
          text: '10',
          action: function ( e, dt, node, config ) {
            $('#InvoiceList').DataTable().page.len( 10 ).draw();
          }
        },
        {
          text: '25',
          action: function ( e, dt, node, config ) {
            $('#InvoiceList').DataTable().page.len( 25 ).draw();
          }
        },
        {
          text: '50',
          action: function ( e, dt, node, config ) {
            $('#InvoiceList').DataTable().page.len( 50 ).draw();
          }
        },
        {
          text: '100',
          action: function ( e, dt, node, config ) {
            $('#InvoiceList').DataTable().page.len( 100 ).draw();
          }
        },
        {
          text: '500',
          action: function ( e, dt, node, config ) {
            $('#InvoiceList').DataTable().page.len( 500 ).draw();
          }
        },
        {
          text: '1000',
          action: function ( e, dt, node, config ) {
            $('#InvoiceList').DataTable().page.len( 1000 ).draw();
          }
        }
      ],
      destroy: true,
      stateSave: true,
      processing: true,
      deferRender: true,
      serverSide: true,
      orderClasses: false,
      pageLength: 10,
      data: [],
      language: {
        sLengthMenu: "_MENU_",
        search: "",
        searchPlaceholder: "Search..",
        processing: '<i class="circle notch loading icon huge"></i>',
      },
      order: [[0, "desc"]],
      columns: [
        { data    : 0 },
        { data    : 1 },
        { data    : 2 }, 
        { data    : 3 },
        { data    : null, 
          render    : function(data, type, row) { 
            if ((data[0]!="") && (d1 === d2)){
              return '<i class="edit outline actedit iconcoloredit icon" eid="'+data[0]+'"></i>';
            } else {
              return ''; 
            }
          }
        } 
      ],
      columnDefs: [{ className: "center aligned", targets: [4] }],
      ajax        : {
        url     : `${restlocinvoice}table_invoice`,
        type    : 'POST',
        headers : {
          user  : vusrnm,
          token : vtoken
        },
        data    : {
          FSearch : FSearch,
          FYear   : FYear,
        },
        error: function () {
      //window.location.href = "./?link=loclogout";
      Swal.fire(
        "Error",
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
        "error"
      );
    },
  }
  });
}


$(document).ready(function(){   

  $("#InvoiceList").on("click", ".actedit", function(){
    var eid = $(this).attr('eid');
    let encryption = new Encryption();
    var eidENC = encryption.encrypt(eid, NonceValue);
    window.location.href = "./?link=createinvoice&i="+eidENC;
  });

});

    
//Read Filter Cookies
var d = new Date();
var yearnow = d.getFullYear();
var sfilter = getCookie("sfilinvoice");
var tfilter = getCookie("tfilinvoice");
if (sfilter) {
  $("#searchfilter").val(sfilter);
  var sfilterstart = sfilter;
} else {
  setCookie("sfilinvoice", "", 5);
  var sfilterstart = "";
}
if (tfilter) {
  $("#filtertahun").dropdown("set selected", tfilter);
  var tfilterstart = tfilter;
} else {
  setCookie("tfilinvoice", yearnow, 5);
  var tfilterstart = yearnow;
}

InvoiceFunc(sfilterstart,tfilterstart);


//RESPON KETIKA INPUT PENCARIAN DI KETIK
$('#searchfilter').on('keyup', function() {
  var FilterCari   	= $('#searchfilter').val();
  var FilterTahun   = $('#filtertahun').val();
  setCookie('sfilinvoice',FilterCari,5);
  setCookie('tfilinvoice',FilterTahun,5);
  $('#InvoiceList').DataTable().destroy();
  InvoiceFunc(FilterCari,FilterTahun);
});

//RESPON KETIKA FILTER TAHUN DI RUBAH
$('#filtertahun').on('change', function() {
  var FilterCari   	= $('#searchfilter').val();
  var FilterTahun   = $('#filtertahun').val();
  setCookie('sfilinvoice',FilterCari,5);
  setCookie('tfilinvoice',FilterTahun,5);
  $('#InvoiceList').DataTable().destroy();
  InvoiceFunc(FilterCari,FilterTahun);
});

//RESET FILTER
$('.resetfilter').on('click', function() {
  var d = new Date();
  var yearnow = d.getFullYear();
  $('#searchfilter').val('');
  $('#filtertahun').dropdown('set selected',yearnow);
  setCookie('tfilinvoice',yearnow,5);
  setCookie('sfilinvoice','',5);
  $('#InvoiceList').DataTable().destroy();
  InvoiceFunc("", yearnow);
});

$('#tabbonlist').on('click', function() {
  window.location.href = "./?link=invoice";
});
$('#createinvoice').on('click', function() {
  window.location.href = "./?link=createinvoice";
});
$('#tabcreatebon').on('click', function() {
  window.location.href = "./?link=createinvoice";
});

//DOWNLOAD DATA ALL / SESUAI FILTER DAN SEARCHING
$('#dwnldxls').on('click', function() {
  var FilterTahun   = $('#filtertahun').val();
  var FilterCari   	= $('#searchfilter').val();
  window.location.href = "./?link=nidwnldxls&c=1&t="+FilterTahun+"&s="+FilterCari;
});




  $("#InvoiceAdd").click(function(){
    var vusrnm  = getCookie('usrnm');
    var vtoken  = getCookie('token');
    $.ajax({
      type: "POST",
      url     : `${restlocinvoice}create_invoice`,
      headers: {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        nomor: $('#invnom').val(),
        tanggal: $('#invtgl').val(),
        nama: $('#invnama').val().toUpperCase(),
        hitskm: $('#invhitskm').val(),
        keterangan: $('#invketerangan').val()
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(JSON.parse(response));
        if(isEmpty(obj)) {
          console.log('Gagal save Invoice, data kosong');
        } else if(obj) {
          if (obj.code == 'error1'){
            Swal.fire('Error','Ada kendala di koneksi/database, data tidak tersimpan !','error')
          }  else {
            Swal.fire({
              title: 'Berhasil',
              text: 'Invoice baru berhasil ditambahkan.',
              timer: 1500,
              position: 'top-end',
              icon: 'success',
              showConfirmButton: false
            })
            window.location.href = "./?link=invoice";
          }
        } else {
          Swal.fire('Error','Invoice Error ?.','error')
        }
      },
      error: function(){
        //window.location.href = "./?link=loclogout";
        console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
      }
    });
  });

  $('#tabinvoice').on('click', function() {
    window.location.href = "./?link=invoice";
  });
  $("#invoicecancel").on("click", function(){
    window.location.href = "./?link=invoice";
  });

  //SET TOKEN ARTEMIS
  $.ajax({
    type: "GET",
    url: "3_invoice/_artemis.php",
    cache: false,
    success: function (response){
      setCookie('atoken', response, 1/24);
    },
    error: function(){
      Swal.fire({
        text : `Server tidak merespon, segera hubungi Administrator di ext. 3553 !`
      })
    }
  });

  //nik autocomplete
  $("#invnama").focus(function(){
    $('#nama_autocomplete').search({
      minCharacters : 1,
      apiSettings   : {
        url: '3_invoice/_autocompletenama.php?q={query}'
      },
      fields: {
        results : 'data',
        title   : 'name',
        description : 'nik'
      }
    });
  });


$('#example1').calendar({
  type: 'date',
  monthFirst: false,
  formatter: {
    date: function (date, settings) {
      if (!date) return '';
      var day = date.getDate();
      var month = date.getMonth() + 1;
      var year = date.getFullYear();
      return year + '-' + month + '-' + day;
    }
  }
});