//Activate dropdown & tab
$(".ui.nosuratdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocnosurat = decodeURIComponent(getCookie("restlocnosurat"));
// let Ucrypt = new Encryption();
// var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);

//Save 
$(function(){
  $("#NoSuratButtonSave").click(function(){
    var vusrnm  = getCookie('usrnm');
    var vtoken  = getCookie('token');

    var jenis = $("#JenisNoSurat").val();
    var descr = $("#DeskripsiNoSurat").val();
    var notee = $("#NoteNoSurat").val();
    var picno = $("#PICNoSurat").val();
    var sectn = $("#BagianNoSurat").val();
    
    var idsurat  = $("#IdNoSurat").val();
    var nosurat  = $("#NoSurat").val();

    $.ajax({
      type    : "POST",
      url     : `${restlocnosurat}create_nosurat`,
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        jenis     : jenis,
        descr     : descr,
        notee     : notee,
        picno     : picno,
        sectn     : sectn,
        idsurat   : idsurat,
        nosurat   : nosurat
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(JSON.parse(response));
        console.log(obj);
        if(isEmpty(obj)) {
          console.log('Gagal Simpan mas brooo, data kosong');
        } else if(obj) {
          if (obj.status == false){
            Swal.fire({
              text: obj.message,
              timer: 1500,
              icon: 'warning',
              showConfirmButton: false
            })
          } else {
            Swal.fire({
              title: 'Berhasil',
              text: 'Data berhasil disimpan.',
              timer: 1500,
              icon: 'success',
              showConfirmButton: false
            })
            window.location.href = "./?link=nomorsuratrd";
          }
        } else {
          Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
        }
      },
      error: function(){
        window.location.href = "./?link=loclogout";
        console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
      }
    });
  });
});




$("#UploadNoSurat").on("click", function () {
  $(".windowreupload").modal("show");
});

$("#CloseWindowUpload").on("click", function () {
  $(".windowreupload").modal("hide");
});


$("#UploadFileNoSurat").on("click", function () {
  var file_data = $("#FileUpload").prop("files")[0];
  var fileName = file_data.name;
  var ftype = fileName.split('.').pop().toLowerCase();
  var idsrt  = $("#idsrt").val();
  var idfile = $("#idfile").val();
  var form_data = new FormData();

  form_data.append("file", file_data);
  form_data.append("idsrt", idsrt);
  form_data.append("idfile", idfile+"."+ftype);

  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `${restlocnosurat}upload_surat`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        Swal.fire({
          text: obj.message,
          timer: 1500,
          icon: "warning",
          showConfirmButton: false,
        });
      } else {
        Swal.fire({
          text: "Uploaded !",
          timer: 2000,
          toast: true,
          showConfirmButton: false,
        });
        $(".windowreupload").modal("hide");
        $("#FileNoSurat").text(idfile+"."+ftype);
      }
    },
    error: function () {
      window.location.href = "./?link=loclogout";
      Swal.fire(
        "Error",
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
        "error"
      );
    },
  });
});



$(document).ready(function() {

  $('#NoSuratButtonBack').on('click', function() {
    window.location.href = "./?link=nomorsuratrd";
  });

  $("#FileNoSurat").on("click",function () {
    var id = $("#FileNoSurat").text();
    window.open("../RND_Upload/DocSuratRD/"+id, "_blank");
  });

});