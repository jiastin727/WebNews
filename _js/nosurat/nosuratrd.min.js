//Activate dropdown & tab
$(".ui.pssdropdown").dropdown();
$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const ColorOwner = "#00139f";
const ColorSHD = "#3b81ff";
const ColorFinish = "#5d5d5d";
const ColorCancel = "#7c0000";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocnosurat = decodeURIComponent(getCookie("restlocnosurat"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);

function TableListFunc(FSearch, FYear, FNama, FBagian) {
  $("#NoSuratRD").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned eight wide column'B>" +
      "<'right aligned eight wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#NoSuratRD").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#NoSuratRD").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#NoSuratRD").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#NoSuratRD").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#NoSuratRD").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Search..",
      processing: '<i class="circle notch loading icon huge"></i>',
    },
    order: [[0, "desc"]],
    columns: [
      {
        data: null,
        render: function (data) {
          if (data[23] == "NO_DATA") {
            return data[23];
          } else {
            return data[0];
          }
        },
      },
      {
        data: null,
        render: function (data, type, row) {
          if (( data[6] == Udecrypt || data[3] == Sect)&& data[7] !==null ) {
            return `<i class="file outline red viewdoc icon" id="${data[8]}" fl="${data[7]}">`;
          } else if ( data[6] !== Udecrypt && data[7] !=="" ) {
            return `<i class="file outline grey icon">`;
          } else {
            return "";
          }
        },
      },
      { data: 1 },
      { data: 2 },
      { data: 3 },
      { data: 4 },
      { data: 5 },
      { data: 6 },
      {
        data: null,
        render: function (data, type, row) {
          if ( data[6] == Udecrypt ) {
            return `<i class="edit outline editsurat iconcoloredit icon" id="${data[8]}">`;
          } else {
            return "";
          }
        },
      },

    ],
    columnDefs: [{ className: "center aligned", targets: [0] }],

    createdRow: function (row, data, index) {
      //WARNA NULL / DATA TIDAK DITEMUKAN
      if (data[23] == "NO_DATA") {
        $(row).addClass("errorhilite");
      }

      // //WARNA OWNER & STATUS ACTIVE/DRAFT
      // if (
      //   (data[12] == Udecrypt || data[14] == Udecrypt) &&
      //   (data[18] == "ACTIVE" ||
      //     data[18] == "DRAFT" ||
      //     data[18] == "REQ-CLOSE" ||
      //     data[18] == "REQ-FINISH")
      // ) {
      //   $(row).find("td").css("color", ColorOwner);
      // }

      // //WARNA SECTIONHEAD
      // if (
      //   (data[17] == "HEAD OF" && data[12] == Udecrypt) ||
      //   (data[17] == "HEAD OF" && data[14] == Udecrypt)
      // ) {
      //   $(row).find("td").css("color", ColorSHD);
      // }

      // //WARNA FINISH & CLOSE
      // if (data[18] == "FINISH" || data[18] == "CLOSE") {
      //   $(row).find("td").css("color", ColorFinish);
      // }

      // //WARNA CANCEL
      // if (data[18] == "CANCEL") {
      //   $(row).find("td").css("color", ColorCancel);
      // }
    },

    ajax: {
      url: `${restlocnosurat}table_nosurat`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FYear: FYear,
        FNama: FNama,
        FBagian: FBagian
      },
      error: function () {
        window.location.href = "./?link=loclogout";
        Swal.fire(
          "Error",
          "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
          "error"
        );
      },
    },
  });

}


$(document).ready(function () {

  $("#addnewnosurat").on("click", function () {
    window.location.href = "./?link=regnosuratrd";
  });

  $("#NoSuratButtonBack").on("click", function () {
    window.location.href = "./?link=regnosuratrd";
  });

  $("#NoSuratRD").on("click", ".editsurat", function () {
    var id = $(this).attr("id");
    let encryption = new Encryption();
    var idenc = encryption.encrypt(id, NonceValue);
    window.location.href = "./?link=editsuratrd&i=" + idenc;
  });

  $("#NoSuratRD").on("click", ".viewdoc", function () {
    var id = $(this).attr("id");
    var fl = $(this).attr("fl");
    window.open("../RND_Upload/DocSuratRD/"+fl, "_blank");
  });

  //Download xls base on filter
  // $("#dwnldxls").on("click", function () {
  //   var iddownload= "PSSDESIGNER";
  //   var search   	= $('#filtercari').val();
  //   var thnfilter = $('#filtertahun').val();
  //   var picfilter = $('#filtermine').val();
  //   var prjfilter = $('#filterjenis').val();
  //   var prgfilter = $('#filterprogress').val();
  //   var stsfilter = $('#filterstatus').val();

  //   $.redirect(
  //     "./?link=pssdwnldxls",
  //     { 
  //       id: iddownload,
  //       search: search, 
  //       thnfilter: thnfilter,
  //       picfilter: picfilter,
  //       prjfilter: prjfilter,
  //       prgfilter: prgfilter,
  //       stsfilter: stsfilter
  //     },
  //     "POST",
  //     "_blank"
  //   );
  // });

});

//Function untuk copy ke clipboard
function copyToClipboard(element) {
  var $temp = $("<input>");
  $("body").append($temp);
  $temp.val($(element).text()).select();
  document.execCommand("copy");
  $temp.remove();
  console.log("copied");
  Swal.fire({
    text: "Item yang anda maksud sudah tersalin di clipboard",
    timer: 1500,
    position: "bottom-left",
    toast: true,
    showConfirmButton: false,
  });
}

//Read Filter Cookies
var d = new Date();
var yearnow = d.getFullYear();
var sfilter = getCookie("sfilpss");
var tfilter = getCookie("tfilpss");
var mfilter = getCookie("mfilpss");
var bfilter = getCookie("bfilpss");
if (sfilter) {
  $("#filtercari").val(sfilter);
  var sfilterstart = sfilter;
} else {
  setCookie("sfilpss", "", 5);
  var sfilterstart = "";
}
if (tfilter) {
  $("#filtertahun").dropdown("set selected", tfilter);
  var tfilterstart = tfilter;
} else {
  setCookie("tfilpss", yearnow, 5);
  var tfilterstart = yearnow;
}
if (mfilter) {
  $("#filtermine").dropdown("set selected", mfilter);
  var mfilterstart = mfilter;
} else {
  setCookie("mfilpss", "ALL", 5);
  var mfilterstart = "ALL";
}
if (bfilter) {
  $("#filterbagian").dropdown("set selected", bfilter);
  var bfilterstart = bfilter;
} else {
  setCookie("bfilpss", "ALL", 5);
  var bfilterstart = "ALL";
}

//Load Table
TableListFunc(
  sfilterstart,
  tfilterstart,
  mfilterstart,
  bfilterstart
);



//RESPON KETIKA INPUT PENCARIAN DI KETIK
$("#filtercari").on("keyup", function () {
  var FilterCari = $("#filtercari").val();
  var FilterTahun = $("#filtertahun").val();
  var FilterNama = $("#filtermine").val();
  var FilterBagian = $("#filterbagian").val();
  setCookie("sfilpss", FilterCari, 5);
  setCookie("tfilpss", FilterTahun, 5);
  setCookie("mfilpss", FilterNama, 5);
  setCookie("bfilpss", FilterBagian, 5);
  $("#NoSuratRD").DataTable().destroy();
  TableListFunc(
    FilterCari,
    FilterTahun,
    FilterNama,
    FilterBagian
  );
});

//RESPON KETIKA FILTER TAHUN DI RUBAH
$("#filtertahun, #filterbagian, #filtermine").on(
  "change",
  function () {
    var FilterCari = $("#filtercari").val();
    var FilterTahun = $("#filtertahun").val();
    var FilterNama = $("#filtermine").val();
    var FilterBagian = $("#filterbagian").val();
    setCookie("sfilpss", FilterCari, 5);
    setCookie("tfilpss", FilterTahun, 5);
    setCookie("mfilpss", FilterNama, 5);
    setCookie("bfilpss", FilterBagian, 5);
    $("#NoSuratRD").DataTable().destroy();
    TableListFunc(
      FilterCari,
      FilterTahun,
      FilterNama,
      FilterBagian
    );
  }
);

//RESET FILTER
$(".resetfilter").on("click", function () {
  var d = new Date();
  var yearnow = d.getFullYear();
  $("#filtercari").val("");
  $("#filtertahun").dropdown("set selected", yearnow);
  $("#filtermine").dropdown("set selected", "ALL");
  $("#filterbagian").dropdown("set selected", "ALL");
  setCookie("sfilpss", "", 5);
  setCookie("tfilpss", yearnow, 5);
  setCookie("mfilpss", "ALL", 5);
  setCookie("bfilpss", "ALL", 5);
  $("#NoSuratRD").DataTable().destroy();
  TableListFunc("", yearnow, "ALL", "ALL");
});
