
const LogoutProtect = false;

function TableListFunc() {

  var JsonFilter = getCookie('FilterMPPShipment');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var GroupF    = ArrayF[1];
    var VendorF     = ArrayF[2];
  } else {
    var SearchF   = "";
    var GroupF    = "ALL";
    var VendorF     = "ALL";
  }
8
  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (GroupF) {
    $("#fgroupship_mpp").dropdown("set selected", GroupF);
    var GroupFStart = GroupF;
  } else {
    var GroupFStart = "ALL";
  }
  if (VendorF) {
    $("#fvendor_mpp").dropdown("set selected", VendorF);
    var VendorFStart = VendorF;
  } else {
    var VendorFStart = "ALL";
  }

  var FiterArry = [SearchFStart, GroupFStart, VendorFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPShipment", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],        
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    ordering    : true,
    scrollCollapse: true,
    scrollY     : '50vh',
    fixedColumns:   {
      leftColumns: 4
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          if(DSect === 'MULTI SOURCING'){
            return `<span class="BtnAddItemGrup clicklink" eid="${data['id']}" grp="${data['group_shipment']}" grpid="${data['group_id']}" data-tooltip="Add Item Group" data-inverted="" data-position="right center"><i class="plus link circular blue icon "></i></span>`;
          } else {
            return '';
          }
        },
      },
      { data: null,
        render: function (data) {
          if(DSect === 'MULTI SOURCING' ){
            return `<span class="BtnEditShipment clicklink" eid="${data['id']}" grpid="${data['group_id']}" data-tooltip="Edit Item Shipment" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
          } else {
            return '';
          }
        },
      },
      { data  : 'group_id' },
      { data  : 'group_shipment' },
      { data  : 'shipcode' },
      { data  : 'wos' },
      // { data  : 'vendor' },
      { data: null,
        render: function (data) {
          return trimVendor(data['vendor']);
        },
      },
      { data  : 'dn' },
      { data  : 'port_destination' },
      { data  : 'target_etd_port' },
      { data  : 'target_eta_port' },
      { data  : 'actual_atd_port' },
      { data  : 'actual_ata_port' },
      { data  : 'commercial_invoice' },
      { data  : 'packing_list' },
      { data  : 'bl_awb' },
      { data  : 'coo' },
      { data  : 'certificate_coo' },
      { data  : 'statement_letter_coo' },
      { data  : 'dhl_awb_docs' },
      { data  : 'mulai_custom' },
      { data  : 'jalur' },
      { data  : 'release_custom' },
      { data  : 'etd_cikarang' },
      { data  : 'po_sample' },
      { data  : 'status' },
      { data  : 'note' },
    ],
    columnDefs: [
      {
        targets: [9,10,11,12,13,14,15,16,17,18,20,22,23],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('DD MMM YY');
          } else {
            return '';
          }
        }
      },
      {
        className: "right aligned",
        targets: [8,9,10,11,12,13,14,15,16,17,18,20,22,23]
      },
    ],
    createdRow: function (row, data, index) {

      //WARNA ACTIVE
      if (data['status'] == "ACTIVE" ) {
        $(row).find("td").css("color", ColorOwner);
      }

      //WARNA FINISH & CLOSE
      if (data['status'] == "FINISH" ) {
        $(row).find("td").css("color", ColorFinish);
      }

      //WARNA CANCEL
      if (data['status'] == "CANCEL" ) {
        $(row).find("td").css("color", ColorCancel);
      }
      
    },
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/shipment/load`,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch   : SearchFStart,
        FGroupShipment : GroupFStart,
        FVendor   : VendorFStart,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });
}

function trimVendor(s) {
  while (s.substr(0,1) == '0' && s.length>1) { s = s.substr(1,9999); }
  return s;
}


//edit shipment atau add new shipment
function SaveShipment(){
  $("#SaveDataShipment").on("click", function () {
    var idx = $("#IdShipment").val();
    var AddEditCompare  = $('#AddEditCompare').val();

    if(idx){

      $.ajax({
        type: "POST",
        url     : '../RND_BackEnd/backend_mpp/shipment/load-item/'+idx,
        headers: {
          user  : VUserName,
          token : VToken
        },
        cache: false,
        success: function (data){
          var obj = JSON.parse(data);

          var LoadNewItem = CryptoJS.MD5(obj.group_shipment+obj.shipcode+obj.vendor+obj.wos+obj.target_etd_port+obj.target_eta_port+obj.port_destination+obj.actual_atd_port+obj.actual_ata_port+obj.commercial_invoice+obj.packing_list+obj.bl_awb+obj.coo+obj.certificate_coo+obj.statement_letter_coo+obj.dhl_awb_docs+obj.mulai_custom+obj.jalur+obj.release_custom+obj.etd_cikarang+obj.po_sample+obj.note).toString();
    
          if (AddEditCompare !== LoadNewItem){

            IsResponseFalse('Gagal Simpan, karena data yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing di field yang dimaksud');
    
          } else {

            $.ajax({
              type    : "POST",
              url     : `../RND_BackEnd/backend_mpp/shipment/edit-item`,
              headers: {
                user  : VUserName,
                token : VToken
              },
              data: {
                id          : idx,
                username    : VUserName,
                group_id    :  $("#GroupId").val(),
                group_shipment  :  $("#GroupShipment").val().toUpperCase(),
                shipcode    : $("#ShipCode").val().toUpperCase(),
                vendor      : $("#Vendor").val().toUpperCase(),
                dn          : $("#DrawingNumber").val().toString(),
                wos         : $("#WOS").val().toUpperCase(),
                target_etd_port : $("#TargetETDPort").val(),
                target_eta_port : $("#TargetETAPort").val(),
                port_destination: $("#PortDestination").val().toUpperCase(),
                actual_atd_port : $("#ActualETDPort").val(),
                actual_ata_port : $("#ActualETAPort").val(),
                commercial_invoice  : $("#CommInv").val(),
                packing_list    : $("#Packing").val(),
                bl_awb          : $("#BLAWB").val(),
                coo             : $("#COO").val(),
                certificate_coo : $("#COOCert").val(),
                statement_letter_coo  : $("#COOStatment").val(),
                dhl_awb_docs    : $("#DHLQWBDocs").val().toUpperCase(),
                mulai_custom    : $("#MulaiCustom").val(),
                jalur           : $("#Jalur").val().toUpperCase(),
                release_custom  : $("#ReleaseCustom").val(),
                etd_cikarang    : $("#ETDCikarang").val(),
                po_sample       : $("#POSample").val().toUpperCase(),
                status          : $("#Status").val().toUpperCase(),
                note            : $("#Note").val().toUpperCase(),

              },
              cache: false,
              success: function (response){
                var obj = JSON.parse(response);
                if(isEmpty(obj)) {
                  IsResponseEmptyObj();
                } else if(obj) {
                  if (obj.status == false){
                    IsResponseFalse(obj.message);
                  } else {
                    IsResponseTrue(obj.message);
                    $(".WindowAddNewShipment").modal("hide");
                    $(".WindowAddItemGroup").modal("hide");
                    TableListFunc();
                  }
                } else {
                  IsResponseErrorElse();
                }
              },
              error: function () {
                IsTimeOut(LogoutProtect);
              },
            });

          }
    
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });

    } else {

      $.ajax({
        type    : "POST",
        url     : `../RND_BackEnd/backend_mpp/shipment/edit-item`,
        headers: {
          user  : VUserName,
          token : VToken
        },
        data: {
          id          : idx,
          // id_mpp      : IdMPP,
          username    : VUserName,
          group_id    :  $("#GroupId").val(),
          group_shipment  :  $("#GroupShipment").val().toUpperCase(),
          shipcode    : $("#ShipCode").val().toUpperCase(),
          vendor      : $("#Vendor").val().toUpperCase(),
          dn          : $("#DrawingNumber").val().toString(),
          wos         : $("#WOS").val().toUpperCase(),
          target_etd_port : $("#TargetETDPort").val(),
          target_eta_port : $("#TargetETAPort").val(),
          port_destination: $("#PortDestination").val().toUpperCase(),
          actual_atd_port : $("#ActualETDPort").val(),
          actual_ata_port : $("#ActualETAPort").val(),
          commercial_invoice  : $("#CommInv").val(),
          packing_list    : $("#Packing").val(),
          bl_awb          : $("#BLAWB").val(),
          coo             : $("#COO").val(),
          certificate_coo : $("#COOCert").val(),
          statement_letter_coo  : $("#COOStatment").val(),
          dhl_awb_docs    : $("#DHLQWBDocs").val().toUpperCase(),
          mulai_custom    : $("#MulaiCustom").val(),
          jalur           : $("#Jalur").val().toUpperCase(),
          release_custom  : $("#ReleaseCustom").val(),
          etd_cikarang    : $("#ETDCikarang").val(),
          po_sample       : $("#POSample").val().toUpperCase(),
          status          : "ACTIVE",
          note            : $("#Note").val().toUpperCase(),

        },
        cache: false,
        success: function (response){
          var obj = JSON.parse(response);
          if(isEmpty(obj)) {
            IsResponseEmptyObj();
          } else if(obj) {
            if (obj.status == false){
              IsResponseFalse(obj.message);
            } else {
              IsResponseTrue(obj.message);
              $(".WindowAddNewShipment").modal("hide");
              $(".WindowAddItemGroup").modal("hide");
              TableListFunc();
            }
          } else {
            IsResponseErrorElse();
          }
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });

    }




    



  });
}


function SaveACopy(){
  $("#SaveACopyDataShipment").on("click", function () {
    var idx = '';
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/shipment/edit-item`,
      headers: {
        user  : VUserName,
        token : VToken
      },
      data: {
        id          : idx,
        username    : VUserName,
        group_id    :  '',
        group_shipment  :  $("#GroupShipment").val().toUpperCase(),
        shipcode    : $("#ShipCode").val().toUpperCase(),
        vendor      : $("#Vendor").val().toUpperCase(),
        dn          : $("#DrawingNumber").val().toString(),
        wos         : $("#WOS").val().toUpperCase(),
        target_etd_port : $("#TargetETDPort").val(),
        target_eta_port : $("#TargetETAPort").val(),
        port_destination: $("#PortDestination").val().toUpperCase(),
        actual_atd_port : $("#ActualETDPort").val(),
        actual_ata_port : $("#ActualETAPort").val(),
        commercial_invoice  : $("#CommInv").val(),
        packing_list    : $("#Packing").val(),
        bl_awb          : $("#BLAWB").val(),
        coo             : $("#COO").val(),
        certificate_coo : $("#COOCert").val(),
        statement_letter_coo  : $("#COOStatment").val(),
        dhl_awb_docs    : $("#DHLQWBDocs").val().toUpperCase(),
        mulai_custom    : $("#MulaiCustom").val(),
        jalur           : $("#Jalur").val().toUpperCase(),
        release_custom  : $("#ReleaseCustom").val(),
        etd_cikarang    : $("#ETDCikarang").val(),
        po_sample       : $("#POSample").val().toUpperCase(),
        status          : $("#Status").val().toUpperCase(),
        note            : $("#Note").val().toUpperCase(),

      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            $(".WindowAddNewShipment").modal("hide");
            $(".WindowAddItemGroup").modal("hide");
            TableListFunc();
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });
}


//ADD NEW ITEM(CHILD) GROUP
function SaveAddItemGroupShipment(){
  $("#SaveDataItemGroup").on("click", function () {
    var idx = $("#IdShipment").val();
    var Groupid = $("#GroupIdItem").val();
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/shipment/edit-item`,
      headers: {
        user  : VUserName,
        token : VToken
      },
      data: {
        id          : idx,
        id_mpp      : IdMPP,
        username    : VUserName,
        group_id    : Groupid,
        group_shipment  :  $("#AddGroupShipment").val().toUpperCase(),
        shipcode    : $("#AddShipCode").val().toUpperCase(),
        vendor      : $("#AddVendor").val().toUpperCase(),
        dn          : $("#AddDrawingNumber").val().toString(),
        wos         : $("#AddWOS").val().toUpperCase(),
        target_etd_port : $("#AddTargetETDPort").val(),
        target_eta_port : $("#AddTargetETAPort").val(),
        port_destination: $("#AddPortDestination").val().toUpperCase(),
        actual_atd_port : $("#AddActualETDPort").val(),
        actual_ata_port : $("#AddActualETAPort").val(),
        commercial_invoice  : $("#AddCommInv").val(),
        packing_list    : $("#AddPacking").val(),
        bl_awb          : $("#AddBLAWB").val(),
        coo             : $("#AddCOO").val(),
        certificate_coo : $("#AddCOOCert").val(),
        statement_letter_coo  : $("#AddCOOStatment").val(),
        dhl_awb_docs    : $("#AddDHLQWBDocs").val().toUpperCase(),
        mulai_custom    : $("#AddMulaiCustom").val(),
        jalur           : $("#AddJalur").val().toUpperCase(),
        release_custom  : $("#AddReleaseCustom").val(),
        etd_cikarang    : $("#AddETDCikarang").val(),
        po_sample       : $("#AddPOSample").val().toUpperCase(),
        status          : $("#AddStatus").val().toUpperCase(),
        note            : $("#AddNote").val().toUpperCase(),

      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            $(".WindowAddNewShipment").modal("hide");
            $(".WindowAddItemGroup").modal("hide");
            TableListFunc();
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });
}




function LoadDataShipment(a){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/shipment/load-item/'+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      if(obj.dn){
        var DNArry = (obj.dn).split(",");
      } else {
        var DNArry = [];
      }
      $('#GroupId').val(obj.group_id);
      $('#GroupShipment').val(obj.group_shipment);
      $('#ShipCode').val(obj.shipcode);
      $('#Vendor').val(obj.vendor);
      $("#DrawingNumber").dropdown("clear");
      $("#DrawingNumber").dropdown("set selected", DNArry);
      $("#WOS").dropdown("clear");
      $("#WOS").dropdown("set selected", obj.wos);
      $('#TargetETDPort').val(obj.target_etd_port);
      $('#TargetETAPort').val(obj.target_eta_port);
      $('#PortDestination').val(obj.port_destination);
      $('#ActualETDPort').val(obj.actual_atd_port);
      $('#ActualETAPort').val(obj.actual_ata_port);
      $('#CommInv').val(obj.commercial_invoice);
      $('#Packing').val(obj.packing_list);
      $('#BLAWB').val(obj.bl_awb);
      $('#COO').val(obj.coo);
      $('#COOCert').val(obj.certificate_coo);
      $('#COOStatment').val(obj.statement_letter_coo);
      $('#DHLQWBDocs').val(obj.dhl_awb_docs);
      $('#MulaiCustom').val(obj.mulai_custom);
      $('#Note').val(obj.note);
      $('#ReleaseCustom').val(obj.release_custom);
      $('#ETDCikarang').val(obj.etd_cikarang);
      $('#POSample').val(obj.po_sample);
      $('#Jalur').val(obj.jalur);
      $('#IdShipment').val(obj.id);
      $('#Status').val(obj.status);

      $('#AddEditCompare').val(CryptoJS.MD5(obj.group_shipment+obj.shipcode+obj.vendor+obj.wos+obj.target_etd_port+obj.target_eta_port+obj.port_destination+obj.actual_atd_port+obj.actual_ata_port+obj.commercial_invoice+obj.packing_list+obj.bl_awb+obj.coo+obj.certificate_coo+obj.statement_letter_coo+obj.dhl_awb_docs+obj.mulai_custom+obj.jalur+obj.release_custom+obj.etd_cikarang+obj.po_sample+obj.note).toString());

      AutocompleteVendor();


    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


function AutocompleteVendor(){
  $(".ui.search.vendor").search({
    minCharacters: 3,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/master-material/search-vendor?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    }
  });
}


$(document).ready(function () {

  TableListFunc();
  SaveShipment();
  SaveACopy();
  SaveAddItemGroupShipment();

  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide: true,
    weekStart: 1
  });

  $("#TableList").on("click", ".BtnEditShipment", function(){
    var uid  = $(this).attr('eid');
    $(".WindowAddNewShipment").modal({ autofocus: false, closable : false, }).modal("show");
    LoadDataShipment(uid);
    $('.SaveACopyBtn').show();
  });

  $("#TableList").on("click", ".BtnAddItemGrup", function(){
    var uid  = $(this).attr('eid');
    var grp  = $(this).attr('grp');
    var grpid  = $(this).attr('grpid');
    $(".WindowAddItemGroup").modal({autofocus: false, closable : false, }).modal("show");
    $(".ClearField").val('');
    $("#AddWOS").dropdown("clear");
    $("#AddDrawingNumber").dropdown("clear");
    $('#AddGroupShipment').val(grp);
    $('#GroupIdItem').val(grpid);
  });

  $("#AddNewShipment").on("click", function () {
    $(".WindowAddNewShipment").modal({ autofocus: false, closable : false, }).modal("show");
    $(".ClearField").val('');
    $("#WOS").dropdown("clear");
    $("#DrawingNumber").dropdown("clear");
    AutocompleteVendor();
    $('.SaveACopyBtn').hide();
  });

  $(".CloseModal").on("click", function(){
    $(".WindowAddNewShipment").modal("hide");
    $(".WindowAddItemGroup").modal("hide");
  });

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterGroup = $("#fgroupship_mpp").val();
    var FilterVendor = $("#fvendor_mpp").val();
    var FiterArry = [FilterCari, FilterGroup, FilterVendor];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPShipment", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fgroupship_mpp, #fvendor_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterGroup = $("#fgroupship_mpp").val();
      var FilterVendor = $("#fvendor_mpp").val();
      var FiterArry = [FilterCari, FilterGroup, FilterVendor];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPShipment", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    $("#fcari_mpp").val("");
    $("#fgroupship_mpp").dropdown("set selected", "ALL");
    $("#fvendor_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPShipment", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });


});