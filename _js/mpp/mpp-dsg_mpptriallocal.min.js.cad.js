$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorRelease= "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var VUserName = getCookie("usrnm");
var VToken    = getCookie("token");
var RestLocMPP = decodeURIComponent(getCookie("restlocpsc"));
let Ucrypt    = new Encryption();
var DUser  = Ucrypt.decrypt(EUser, NonceValue);
var DJbtn  = Ucrypt.decrypt(EJbtn, NonceValue);
var DSect  = Ucrypt.decrypt(ESect, NonceValue);


function TableListFunc() {

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'>" +
      ">" +
      ">",
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    paging      : false,
    fixedColumns:   {
      leftColumns: 5
    },
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          return `<span class="BtnEditTrialLocal clicklink" eid="${data['id']}"><i class="tasks icon "></i></span>`;
        },
      },
      { data  : 'trial' },
      { data  : 'drawing_loc' },
      { data  : 'drawing_number' },
      { data  : 'description_dn' },
      { data  : 'sales_contract' },
      { data  : 'phj' },
      { data  : 'description_phj' },
      { data  : 'tonnage_spec' },
      { data  : 'tonnage_actual' },
      { data  : 'vendor_local' },
      { data  : 'est_qty' },
      { data  : 'second_process' },
      { data  : 'planning' },
      { data  : 'actual' },
      { data  : 'ihp' },
      { data  : 'note' }
    ],
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/load/`+IdMPP,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },

      error   : function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}



function DatePicker(IdTanggal) {
  var today = new Date();
  $(IdTanggal).calendar({
    type: "date",
    //monthFirst: false,
    //minDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return year + "-" + month + "-" + day;
      },
    },
  });
}



function LoadEditItemTrialLocal(a){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/load-item/`+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      $("#TahapTrialLocal").dropdown("clear");
      $("#TahapTrialLocal").dropdown("set selected",obj.trial);
      $('#DNTrialLoacal').val(obj.drawing_number);
      $('#DrwLocTrialLocal').val(obj.drawing_loc);
      $('#DescTrialLocal').val(obj.description_dn);
      $('#VendorTrialLocal').val(obj.vendor);
      $('#SCTrialLocal').val(obj.sales_contract);
      $('#PHJTrialLocal').val(obj.phj);
      $('#DescPHJTrialLocal').val(obj.description_phj);
      $('#TonnageSpecTrialLocal').val(obj.tonnage_spec);
      $('#TonnageActualTrialLocal').val(obj.tonnage_actual);
      $('#EstQtyTrialLocal').val(obj.est_qty);
      $('#2ndProcessTrialLocal').val(obj.second_process);
      $('#PlanningTrialLocal').val(obj.planning);
      $('#ActualTrialLocal').val(obj.actual);
      $("#IHPTrialLocal").dropdown("clear");
      $("#IHPTrialLocal").dropdown("set selected",obj.ihp);
      $('#NoteTrialLocal').val(obj.note);
      $('#IdTrialLocal').val(obj.id);
      AutocompleteDN();
      AutocompleteVendor();
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


function AutocompleteDN(){
  $(".ui.search.dn").search({
    minCharacters: 1,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/search-dn?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
    onSelect: function (response){
      $('#DrwLocTrialLocal').val(response.drawing_loc);
      $('#DescTrialLocal').val(response.desc);
      $('#SCTrialLocal').val(response.sales_contract);
    },
  });
}

function AutocompleteVendor(){
  $(".ui.search.vendor").search({
    minCharacters: 3,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/schedule-trial/trial-local/search-vendor?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    }
  });
}



$("#SaveAddEditTrialLocal").on("click", function (e) {
  $.ajax({
    type    : "POST",
    url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/edit-item`,
    headers : {
      user  : VUserName,
      token : VToken
    },
    data: {   
      id              : $("#IdTrialLocal").val(),
      id_mpp          : IdMPP,
      username        : VUserName,
      trial           : $("#TahapTrialLocal").val(),
      drawing_loc     : $("#DrwLocTrialLocal").val(),
      drawing_number  : $("#DNTrialLocal").val(),
      description_dn  : $("#DescTrialLocal").val(),
      sales_contract  : $("#SCTrialLocal").val(),
      phj             : $("#PHJTrialLocal").val(),
      description_phj : $("#DescPHJTrialLocal").val(),
      tonnage_spec    : $("#TonnageSpecTrialLocal").val(),
      tonnage_actual  : $("#TonnageActualTrialLocal").val(),
      vendor_local    : $("#VendorTrialLocal").val(),
      est_qty         : $("#EstQtyTrialLocal").val(),
      second_process  : $("#2ndProcessTrialLocal").val(),
      planning        : $("#PlanningTrialLocal").val(),
      actual          : $("#ActualTrialLocal").val(),
      ihp             : $("#IHPTrialLocal").val(),
      note            : $("#NoteTrialLocal").val(),
      localmaker      : "LOCAL"

    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if(obj) {
        if (obj.status == false){
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          $(".WindowAddEditItemTrialLocal").modal("hide");
          TableListFunc();
        }
      } else {
        IsResponseErrorElse();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});







$(document).ready(function () {

  TableListFunc();

  $("#AddNewTrial").on("click", function (e) {
    $(".WindowAddEditItemTrialLocal").modal({ autofocus: false, closable : false, }).modal("show");
    // DatePicker(".CalHeader");
    $("#IdTrialLocal").val('');
    $(".resetvalue").val('');
    $(".resetdropdown").dropdown("clear");
    AutocompleteDN();
    AutocompleteVendor();
  });

  $("#TableList").on("click", ".BtnEditTrialLocal", function(){
    var eid  = $(this).attr('eid');
    $(".WindowAddEditItemTrialLocal").modal({ autofocus: false, closable : false, }).modal("show");
    // DatePicker(".CalHeader");
    LoadEditItemTrialLocal(eid);
  });


  $(".CancelData").on("click", function(){
    $(".WindowAddEditItemTrialLocal").modal("hide");
  });
});