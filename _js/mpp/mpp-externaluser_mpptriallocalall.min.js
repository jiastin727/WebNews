
const LogoutProtect = false;

function TableListFunc() {
  var JsonFilter = getCookie('FilterSchTrialLocalAll');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF = ArrayF[0];
    var TahapF  = ArrayF[1];
    var SalesContractF = ArrayF[2];
  } else {
    var SearchF   = "";
    var TahapF    = "ALL";
    var SalesContractF = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahapF) {
    $("#ftahap_mpp").dropdown("set selected", TahapF);
    var TahapFStart = TahapF;
  } else {
    var TahapFStart = "ALL";
  }
  if (SalesContractF) {
    $("#fsales_mpp").dropdown("set selected", SalesContractF);
    var SalesContractFStart = SalesContractF;
  } else {
    var SalesContractFStart = "ALL";
  }

  var FiterArry = [SearchFStart, TahapFStart, SalesContractFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterSchTrialLocalAll", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'>" +
      ">" +
      ">",
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    paging      : false,
    fixedColumns:   {
      leftColumns: 4
    },
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data  : 'trial' },
      { data  : 'drawing_loc' },
      { data  : 'drawing_number' },
      { data  : 'description_dn' },
      { data  : 'sales_contract' },
      { data  : 'phj' },
      { data  : 'description_phj' },
      { data  : 'tonnage_spec' },
      { data  : 'tonnage_actual' },
      { data  : 'vendor_local' },
      { data  : 'est_qty' },
      { data  : 'second_process' },
      { data  : 'planning' },
      { data  : 'actual' },
      { data  : 'ihp' },
      { data  : 'note' }
    ],
    createdRow: function (row, data, index) {
      //WARNA FREEZE LEFT COLUMNS 
      $(row).find("td:eq(3)").css("border-right", "inset");
      $(row).find("td:eq(3)").css("border-right-color", ColorBorderFreeze);

      if (data['buat_ihp'] === "YES") {
        $(row).find("td").css("color", ColorTMakerIHP);
      }
      
    },
    columnDefs: [
      {
        targets: [12,13],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YY');
          } else {
            return '';
          }
        }
      },
      {
        className: "right aligned",
        targets: [12,13]
      },
    ],
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/load-all`,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch    : SearchFStart,
        FTahap     : TahapFStart,
        FSalesContract : SalesContractFStart,
      },      
      error   : function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}


$(document).ready(function () {

  TableListFunc();

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterTahap = $("#ftahap_mpp").val();
    var FilterSales = $("#fsales_mpp").val();
    var FiterArry = [FilterCari, FilterTahap, FilterSales];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialLocalAll", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#ftahap_mpp, #fsales_mpp, #fvendor_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterTahap = $("#ftahap_mpp").val();
      var FilterSales = $("#fsales_mpp").val();
      var FiterArry = [FilterCari, FilterTahap, FilterSales];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterSchTrialLocalAll", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    $("#fcari_mpp").val("");
    $("#ftahap_mpp").dropdown("set selected", "ALL");
    $("#fsales_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialLocalAll", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });

});