const LogoutProtect = false;
var restlocpscxls = decodeURIComponent(getCookie("restlocpscxls"));

var GetCookieAllDesMD = decodeURIComponent(getCookie("CooAllDesMD"));
var GetCookieHOMD = decodeURIComponent(getCookie("CooHOMD"));
var GetCookieNego = decodeURIComponent(getCookie("CooNego"));
var GetCookieOpr = decodeURIComponent(getCookie("CooOpr"));
var ArryAllDesMD   = GetCookieAllDesMD.split(", ");

function TableListFunc() {

  var JsonFilter = getCookie('FilterSchTrialMaker');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF = ArrayF[0];
    var TahapF  = ArrayF[1];
    var SalesContractF = ArrayF[2];
    var VendorF = ArrayF[3];
  } else {
    var SearchF   = "";
    var TahapF    = "ALL";
    var SalesContractF = "ALL";
    var VendorF = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahapF) {
    $("#ftahap_mpp").dropdown("set selected", TahapF);
    var TahapFStart = TahapF;
  } else {
    var TahapFStart = "ALL";
  }
  if (SalesContractF) {
    $("#fsales_mpp").dropdown("set selected", SalesContractF);
    var SalesContractFStart = SalesContractF;
  } else {
    var SalesContractFStart = "ALL";
  }
  if (VendorF) {
    $("#fvendor_mpp").dropdown("set selected", VendorF);
    var VendorFStart = VendorF;
  } else {
    var VendorFStart = "ALL";
  }
  

  var FiterArry = [SearchFStart, TahapFStart, SalesContractFStart, VendorFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterSchTrialMaker", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    ordering    : true,
    scrollCollapse: true,
    scrollY     : '50vh',
    fixedColumns:   {
      leftColumns: 5
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          if (ArryAllDesMD.includes(DUser) || GetCookieHOMD === DUser || GetCookieNego === DUser || GetCookieOpr === DUser){
            return `<span class="BtnEditTrialMaker clicklink" eid="${data['id']}" edesc="${data['description']}" data-tooltip="Edit Item Trial Maker" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
          } else {
            return '';
          }
        },
      },
      { data  : 'trial' },
      { data  : 'drawing_loc' },
      { data  : 'drawing_number' },
      { data  : 'description' },
      { data  : 'vendor' },
      { data  : 'sales_contract' },
      { data  : 'target_etd_sc' },
      { data  : 'target_eta_sc' },
      { data  : 'eta_mold_shipment_sc' },
      { data  : 'target_etd' },
      { data  : 'target_eta' },
      { data  : 'wos' },
      { data  : 'tracking_number' },
      { data  : 'actual_atd' },
      { data  : 'actual_ata' },
      { data  : 'actual_qty' },
      { data  : 'kebutuhan_qty' },
      { data  : 'uom' },
      { data  : 'buat_ihp' },
      { data  : 'result' },
      { data  : 'modification' },
      { data  : 'remark' },
    ],
    createdRow: function (row, data, index) {

      $(row).find("td:eq(4)").css("border-right", "inset");
      $(row).find("td:eq(4)").css("border-right-color", ColorBorderFreeze);

      if (data['buat_ihp'] === "YES") {
        $(row).find("td").css("color", ColorTMakerIHP);
      }
      if (data['result'] === "NOT OK") {
        $(row).find("td").css("background-color", BgColorTMakerNOT);
      }
      if (data['result'] === "OK") {
        $(row).find("td").css("background-color", BgColorTMakerOK);
      }
    },
    columnDefs: [
      {
        targets: [7,8,9,10,11,14,15],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YY');
          } else {
            return '';
          }
        }
      },
      {
        className: "right aligned",
        targets: [7,8,9,10,11,14,15,16,17]
      },
    ],
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/load/`+IdMPP,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch    : SearchFStart,
        FTahap     : TahapFStart,
        FSalesContract : SalesContractFStart,
        FVendor    : VendorFStart,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });
}


function TableListFuncDisabled() {

  var JsonFilter = getCookie('FilterSchTrialMaker');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF = ArrayF[0];
    var TahapF  = ArrayF[1];
    var SalesContractF = ArrayF[2];
    var VendorF = ArrayF[3];
  } else {
    var SearchF   = "";
    var TahapF    = "ALL";
    var SalesContractF = "ALL";
    var VendorF = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahapF) {
    $("#ftahap_mpp").dropdown("set selected", TahapF);
    var TahapFStart = TahapF;
  } else {
    var TahapFStart = "ALL";
  }
  if (SalesContractF) {
    $("#fsales_mpp").dropdown("set selected", SalesContractF);
    var SalesContractFStart = SalesContractF;
  } else {
    var SalesContractFStart = "ALL";
  }
  if (VendorF) {
    $("#fvendor_mpp").dropdown("set selected", VendorF);
    var VendorFStart = VendorF;
  } else {
    var VendorFStart = "ALL";
  }
  

  var FiterArry = [SearchFStart, TahapFStart, SalesContractFStart, VendorFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterSchTrialMaker", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX: true,
    ordering: true,
    scrollCollapse: true,
    scrollY: '50vh',
    fixedColumns:   {
      leftColumns: 5
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          return '';
        },
      },
      { data  : 'trial' },
      { data  : 'drawing_loc' },
      { data  : 'drawing_number' },
      { data  : 'description' },
      { data  : 'vendor' },
      { data  : 'sales_contract' },
      { data  : 'target_etd_sc' },
      { data  : 'target_eta_sc' },
      { data  : 'eta_mold_shipment_sc' },
      { data  : 'target_etd' },
      { data  : 'target_eta' },
      { data  : 'wos' },
      { data  : 'tracking_number' },
      { data  : 'actual_atd' },
      { data  : 'actual_ata' },
      { data  : 'actual_qty' },
      { data  : 'kebutuhan_qty' },
      { data  : 'uom' },
      { data  : 'buat_ihp' },
      { data  : 'result' },
      { data  : 'modification' },
      { data  : 'remark' },
    ],
    createdRow: function (row, data, index) {

      $(row).find("td:eq(4)").css("border-right", "inset");
      $(row).find("td:eq(4)").css("border-right-color", ColorBorderFreeze);

      if (data['buat_ihp'] === "YES") {
        $(row).find("td").css("color", ColorTMakerIHP);
      }
      if (data['result'] === "NOT OK") {
        $(row).find("td").css("background-color", BgColorTMakerNOT);
      }
      if (data['result'] === "OK") {
        $(row).find("td").css("background-color", BgColorTMakerOK);
      }
    },
    columnDefs: [
      {
        targets: [7,8],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('DD MMM YY');
          } else {
            return '';
          }
        }
      },
    ],
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/load/`+IdMPP,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });
}



function LoadEditItemTrialMaker(a){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/load-item/`+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      $("#TahapTrialMaker").dropdown("clear");
      $("#TahapTrialMaker").dropdown("set selected",obj.trial);

      $('#DNTrialMaker').val(obj.drawing_number);
      $('#DrwLocTrialMaker').val(obj.drawing_loc);
      $('#DescTrialMaker').val(obj.description);
      $('#VendorTrialMaker').val(obj.vendor);
      $('#SCTrialMaker').val(obj.sales_contract);
      $('#ETDSCTrialMaker').val(obj.target_etd_sc);
      $('#ETASCTrialMaker').val(obj.target_eta_sc);
      $('#ETAMoldTrialMaker').val(obj.eta_mold_shipment_sc);
      $('#TargetETDTrialMaker').val(obj.target_etd);
      $('#TargetETATrialMaker').val(obj.target_eta);

      $("#WOSTrialMaker").dropdown("clear");
      $("#WOSTrialMaker").dropdown("set selected",obj.wos);

      $('#TrackNumTrialMaker').val(obj.tracking_number);
      $('#ActualATDTrialMaker').val(obj.actual_atd);
      $('#ActualATATrialMaker').val(obj.actual_ata);
      $('#ActualQtyTrialMaker').val(obj.actual_qty);

      $("#ResultTrialMaker").dropdown("clear");
      $("#ResultTrialMaker").dropdown("set selected",obj.result);
      $("#ModifTrialMaker").dropdown("clear");
      $("#ModifTrialMaker").dropdown("set selected",obj.modification);
      $("#IHPTrialMaker").dropdown("clear");
      $("#IHPTrialMaker").dropdown("set selected",obj.buat_ihp);

      $('#RemarkTrialMaker').val(obj.remark);
      $('#IdTrialMaker').val(obj.id);

      $('#AddEditCompare').val(CryptoJS.MD5(obj.trial+obj.drawing_number+obj.target_etd_sc+obj.target_eta_sc+obj.eta_mold_shipment_sc+obj.target_etd+obj.target_eta+obj.wos+obj.tracking_number+obj.actual_atd+obj.actual_ata+obj.actual_qty+obj.result+obj.modification+obj.buat_ihp+obj.remark).toString());

      if(obj.trial !=='' && obj.drawing_number !==''){
        $(".CreateIHPField").show();
      } else {
        $(".CreateIHPField").hide();
      }

      AutocompleteDN();

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


function AutocompleteDN(){
  $(".ui.search.dn").search({
    minCharacters: 1,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/search-dn?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
    onSelect: function (response){
      $('#DrwLocTrialMaker').val(response.drawing_loc);
      $('#DescTrialMaker').val(response.desc);
      $('#VendorTrialMaker').val(response.manuf);
      $('#SCTrialMaker').val(response.sales_contract);
    },
  });
}


// Generate Trial Maker
$("#GenerateTrialMaker").on("click", function () {
  var targetetd_t1 = $("#TargetETD_T1").val();
  var targeteta_t1 = $("#TargetETA_T1").val();
  var etamold_t1   = $("#ETAMoldShipment_T1").val();
  var targetetd_t2 = $("#TargetETD_T2").val();
  var targeteta_t2 = $("#TargetETA_T2").val();
  var etamold_t2   = $("#ETAMoldShipment_T2").val();
  var targetetd_t3 = $("#TargetETD_T3").val();
  var targeteta_t3 = $("#TargetETA_T3").val();
  var etamold_t3   = $("#ETAMoldShipment_T3").val();
  var targetetd_tf = $("#TargetETD_TF").val();
  var targeteta_tf = $("#TargetETA_TF").val();
  var etamold_tf   = $("#ETAMoldShipment_TF").val();
  var salescontract= $("#NoSalesContract").val();

  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/generate-item`,
    headers : {
      user  : VUserName,
      token : VToken,
    },
    data: {   
      id_mpp   : IdMPP,
      username : VUserName,
      targetetd_t1 : targetetd_t1,
      targeteta_t1 : targeteta_t1,
      etamold_t1   : etamold_t1,
      targetetd_t2 : targetetd_t2,
      targeteta_t2 : targeteta_t2,
      etamold_t2   : etamold_t2,
      targetetd_t3 : targetetd_t3,
      targeteta_t3 : targeteta_t3,
      etamold_t3   : etamold_t3,
      targetetd_tf : targetetd_tf,
      targeteta_tf : targeteta_tf,
      etamold_tf   : etamold_tf,
      salescontract: salescontract,
      localmaker   : "MAKER"
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        IsResponseFalse(obj.message);
      } else {
        IsResponseTrue(obj.message);
        $(".WindowGenerateItemTrial").modal("hide");
        TableListFunc();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});



$("#SaveAddEditTrialMaker").on("click", function (e) {
  var AddEditCompare  = $('#AddEditCompare').val();
  var IdTrialMaker    = $("#IdTrialMaker").val();


  if(IdTrialMaker){
    //Jika Edit Item Trial Maker Schedule
    $.ajax({
      type: "POST",
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/load-item/`+IdTrialMaker,
      headers: {
        user  : VUserName,
        token : VToken
      },
      cache: false,
      success: function (data){
        var obj = JSON.parse(data);
        var LoadNewItem = CryptoJS.MD5(obj.trial+obj.drawing_number+obj.target_etd_sc+obj.target_eta_sc+obj.eta_mold_shipment_sc+obj.target_etd+obj.target_eta+obj.wos+obj.tracking_number+obj.actual_atd+obj.actual_ata+obj.actual_qty+obj.result+obj.modification+obj.buat_ihp+obj.remark).toString();
        
        if (AddEditCompare !== LoadNewItem){

          IsResponseFalse('Gagal Simpan, karena data yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing di field yang dimaksud');

        } else {

          $.ajax({
            type    : "POST",
            url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/edit-item`,
            headers : {
              user  : VUserName,
              token : VToken
            },
            data: {   
              id            : $("#IdTrialMaker").val(),
              id_mpp        : IdMPP,
              username      : VUserName,
              trial         : $("#TahapTrialMaker").val(),
              drawing_loc   : $("#DrwLocTrialMaker").val(),
              drawing_number: $("#DNTrialMaker").val(),
              description   : $("#DescTrialMaker").val(),
              vendor        : $("#VendorTrialMaker").val(),
              sales_contract: $("#SCTrialMaker").val(),
              target_etd_sc : $("#ETDSCTrialMaker").val(),
              target_eta_sc : $("#ETASCTrialMaker").val(),
              eta_mold_shipment_sc : $("#ETAMoldTrialMaker").val(),
              target_etd    : $("#TargetETDTrialMaker").val(),
              target_eta    : $("#TargetETATrialMaker").val(),
              wos           : $("#WOSTrialMaker").val(),
              tracking_number : $("#TrackNumTrialMaker").val(),
              actual_atd    : $("#ActualATDTrialMaker").val(),
              actual_ata    : $("#ActualATATrialMaker").val(),
              actual_qty    : $("#ActualQtyTrialMaker").val(),
              uom           : "",
              result        : $("#ResultTrialMaker").val(),
              modification  : $("#ModifTrialMaker").val(),
              buat_ihp      : $("#IHPTrialMaker").val(),
              remark        : $("#RemarkTrialMaker").val(),
              localmaker    : "MAKER"
            },
            cache: false,
            success: function (response){
              var obj = JSON.parse(response);
              if(isEmpty(obj)) {
                IsResponseEmptyObj();
              } else if(obj) {
                if (obj.status == false){
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  $(".WindowAddEditItemTrialMaker").modal("hide");
                  TableListFunc();
                }
              } else {
                IsResponseErrorElse();
              }
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });

        }


      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });

  } else {

    //Jika Add New Item Trial Maker Schedule
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/edit-item`,
      headers : {
        user  : VUserName,
        token : VToken
      },
      data: {   
        id            : $("#IdTrialMaker").val(),
        id_mpp        : IdMPP,
        username      : VUserName,
        trial         : $("#TahapTrialMaker").val(),
        drawing_loc   : $("#DrwLocTrialMaker").val(),
        drawing_number: $("#DNTrialMaker").val(),
        description   : $("#DescTrialMaker").val(),
        vendor        : $("#VendorTrialMaker").val(),
        sales_contract: $("#SCTrialMaker").val(),
        target_etd_sc : $("#ETDSCTrialMaker").val(),
        target_eta_sc : $("#ETASCTrialMaker").val(),
        eta_mold_shipment_sc : $("#ETAMoldTrialMaker").val(),
        target_etd    : $("#TargetETDTrialMaker").val(),
        target_eta    : $("#TargetETATrialMaker").val(),
        wos           : $("#WOSTrialMaker").val(),
        tracking_number : $("#TrackNumTrialMaker").val(),
        actual_atd    : $("#ActualATDTrialMaker").val(),
        actual_ata    : $("#ActualATATrialMaker").val(),
        actual_qty    : $("#ActualQtyTrialMaker").val(),
        uom           : "",
        result        : $("#ResultTrialMaker").val(),
        modification  : $("#ModifTrialMaker").val(),
        buat_ihp      : $("#IHPTrialMaker").val(),
        remark        : $("#RemarkTrialMaker").val(),
        localmaker    : "MAKER"
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            $(".WindowAddEditItemTrialMaker").modal("hide");
            TableListFunc();
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });

  }


  
  
});


function LoadDataSign(){
  //Load Data Sign untuk proteksi ketika negosiator belum sign maka edit akan di tolak.
  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/sign/load/`+IdMPP,
    headers: {
      user: VUserName,
      token: VToken
    },
    cache: false,
    success: function (data) {
      var obj = JSON.parse(data);
      if(obj.DateSignNego !==null && obj.SignByNego !== null ){
        $('#FeaturesGenerateSchTrialItemMPP').html('<div class="ui small compact teal labeled icon button" id="GenerateItemTrial" data-tooltip="Generate trial maker schedules" data-position="bottom left" data-inverted=""><i class="plus icon"></i>Generate Trial SC</div>');

        $('#FeaturesAddSchTrialManual').html('<div class="ui small compact blue labeled icon button" id="AddNewTrial" data-tooltip="Add new item data trial" data-position="bottom left" data-inverted=""><i class="plus circle icon"></i>Add New Data Trial</div>');

        $('#FeaturesDownloadTrialMaker').html('<div class="ui small compact green labeled icon button" id="DownloadTrialMaker" data-tooltip="Unduh data Trial Maker" data-position="bottom left" data-inverted=""><i class="arrow down icon"></i>Schedule Trial Maker</div>');

        $('#FeaturesDownloadLabelDistribution').html('<div class="ui small compact olive labeled icon button" id="DownloadLabelDist" data-tooltip="Unduh daftar distribusi sample" data-position="bottom left" data-inverted=""><i class="arrow down icon"></i>Distribution Sample List</div>');

        $('#FeaturesDownloadLabelPacking').html('<div class="ui small compact olive labeled icon button" id="DownloadLabelPacking" data-tooltip="Unduh label packing sample" data-position="bottom left" data-inverted=""><i class="arrow down icon"></i>Label Packing</div>');

        TableListFunc();
      } else {
        $('#FeaturesGenerateSchTrialItemMPP').html('');
        $('#FeaturesAddSchTrialManual').html('');
        $('#FeaturesDownloadTrialMaker').html('');
        $('#FeaturesDownloadLabelDistribution').html('');
        $('#FeaturesDownloadLabelPacking').html('');
        TableListFuncDisabled();
      }

      $("#GenerateItemTrial").on("click", function (e) {
        $(".WindowGenerateItemTrial").modal({ autofocus: false, closable : false, }).modal("show");
      });
    
      $("#AddNewTrial").on("click", function (e) {
        $(".WindowAddEditItemTrialMaker").modal({ autofocus: false, closable : false, }).modal("show");
        $("#IdTrialMaker").val('');
        $(".resetvalue").val('');
        $(".resetdropdown").dropdown("clear");
        AutocompleteDN();
        $(".CreateIHPField").hide();
      });

      $("#DownloadLabelDist").on("click", function (e) {
        $(".WindowDownloadLabelDist").modal({ autofocus: false, closable : false, }).modal("show");
        

        $('.ui.search.nama').search({
            apiSettings: {
              url: '2_masterplasticpart/_autocompletenama.php?q={query}',
              beforeXHR: function (xhr) {
                xhr.setRequestHeader('user', VUserName);
                xhr.setRequestHeader('token', VToken);
                return xhr;
              },
            },
            fields: {
              results: 'data',
              title: 'name',
              description: 'nik'
            },
            minCharacters: 1
        });

        $.ajax({
          type: "GET",
          url: "2_masterplasticpart/_artemis.php",
          cache: false,
          success: function (response) {
            setCookie('atoken', response, 1 / 24);
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });

      });


      $("#DownloadLabelPacking").on("click", function (e) {
        $(".WindowDownloadLabelPacking").modal({ autofocus: false, closable : false, }).modal("show");
          
        LoadTabelLabelPacking();


        
      });


      $('.SelectDNNum').dropdown({
        // action: 'hide',
        onChange: function(value, text, $selectedItem) {
          console.log(value);
          $.ajax({
            type    : "POST",
            url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/label-packing`,
            headers : {
              user  : VUserName,
              token : VToken
            },
            data: {   
              id_dn          : value,
              drawing_number : text,
              id_mpp         : IdMPP,
              username       : VUserName,
            },
            cache: false,
            success: function (response){
              var obj = JSON.parse(response);
              if(isEmpty(obj)) {
                IsResponseEmptyObj();
              } else if(obj) {
                if (obj.status == false){
                  IsResponseFalse(obj.message);
                } else {
                  // IsResponseTrue(obj.message);
                  // $(".WindowAddEditItemTrialMaker").modal("hide");
                  // TableListFunc();
                  LoadTabelLabelPacking();
                }
              } else {
                IsResponseErrorElse();
              }
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });
        }
      });


      $('#SubmitDownloadLabelDist').on('click', function() {
        $.ajax({
          type    : "GET",
          url     : `${restlocpscxls}DownloadLabelSample`,
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {
            id: IdMPP,
            sales: $('#LabelDistSC').val(),
            mde: $('#NamaPICMDE').val(),
          },
          cache: false,
          success: function (response){
            window.location.href = "../RND_Upload/MPP/MppLabelDestribution_.xlsx";
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      });





      // Download XLS
      $('#DownloadTrialMaker').on('click', function () {
        $.redirect(
          "./?link=downloadmpptrialmaker",
          {
            id: IdMPP,
            search: $('#fcari_mpp').val(),
            tahap: $('#ftahap_mpp').val(),
            sales: $('#fsales_mpp').val(),
            vendor: $('#fvendor_mpp').val(),
          },
          "POST",
          "_blank"
        )
      })


    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


function LoadTabelLabelPacking(){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/load-label-packing/`+IdMPP,
    headers: {
      user: VUserName,
      token: VToken
    },
    cache: false,
    success: function (data) {
      var obj = JSON.parse(data);
      console.log(obj);
      $("#TblLabelPacking").empty();
      $("#TblLabelPacking").append(
        "<thead>"+
          "<tr>"+
            "<th><b>DN - Description - Vendor</b></th>"+
            "<th>MD</th>"+
            "<th>ID</th>"+
            "<th>PL</th>"+
            "<th>MSC</th>"+
            "<th>MDE</th>"+
            "<th></th>"+
          "</tr>"+
        "</thead>"+
        "<tbody>"
      );

      JmlDataA = obj.length;
          NewDataA = JmlDataA+1;
          for(var i=0; i<JmlDataA; i++){
            if(obj[i]['label_md']){
              var md = "<span class='CheckItem' chk='unchk' idx='"+obj[i]['id']+"' sec='label_md' ><i class='check square outline icon link'></i></span>";
            } else {
              var md = "<span class='CheckItem' chk='chk' idx='"+obj[i]['id']+"' sec='label_md' ><i class='square outline grey icon link'></i></span>";
            }
            if(obj[i]['label_id']){
              var id = "<span class='CheckItem' chk='unchk' idx='"+obj[i]['id']+"' sec='label_id' ><i class='check square outline icon link'></i></span>";
            } else {
              var id = "<span class='CheckItem' chk='chk' idx='"+obj[i]['id']+"' sec='label_id' ><i class='square outline grey icon link'></i></span>";
            }
            if(obj[i]['label_pl']){
              var pl = "<span class='CheckItem' chk='unchk' idx='"+obj[i]['id']+"' sec='label_pl' ><i class='check square outline icon link'></i></span>";
            } else {
              var pl = "<span class='CheckItem' chk='chk' idx='"+obj[i]['id']+"' sec='label_pl' ><i class='square outline grey icon link'></i></span>";
            }
            if(obj[i]['label_msc']){
              var msc = "<span class='CheckItem' chk='unchk' idx='"+obj[i]['id']+"' sec='label_msc' ><i class='check square outline icon link'></i></span>";
            } else {
              var msc = "<span class='CheckItem' chk='chk' idx='"+obj[i]['id']+"' sec='label_msc' ><i class='square outline grey icon link'></i></span>";
            }
            if(obj[i]['label_mde']){
              var mde = "<span class='CheckItem' chk='unchk' idx='"+obj[i]['id']+"' sec='label_mde' ><i class='check square outline icon link'></i></span>";
            } else {
              var mde = "<span class='CheckItem' chk='chk' idx='"+obj[i]['id']+"' sec='label_mde' ><i class='square outline grey icon link'></i></span>";
            }
            $("#TblLabelPacking").append(
              "<tr>"+
                "<td><b>"+obj[i]['drawing_number']+"</b><br>"+obj[i]['description']+" - "+obj[i]['vendor']+"</td>"+
                "<td class='center aligned'>"+md+"</td>"+
                "<td class='center aligned'>"+id+"</td>"+
                "<td class='center aligned'>"+pl+"</td>"+
                "<td class='center aligned'>"+msc+"</td>"+
                "<td class='center aligned'>"+mde+"</td>"+
                "<td class='center aligned'><span class='RemoveItem' idx='"+obj[i]['id']+"' ><i class='trash alternate outline red icon link'></i></span></td>"+
              "</tr>"
            );

          }

      $("#TblLabelPacking").append(
        "</tbody>"
      );


      $('.RemoveItem').on('click', function() {
        var idx = $(this).attr('idx');
        $.ajax({
          type    : "POST",
          url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/remove-label-packing`,
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {
            id_mpp: IdMPP,
            id_item: idx,
          },
          cache: false,
          success: function (response){
            LoadTabelLabelPacking();

          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      });

      $('.CheckItem').on('click', function() {
        var idx = $(this).attr('idx');
        var sec = $(this).attr('sec');
        var chk = $(this).attr('chk');
        $.ajax({
          type    : "POST",
          url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/check-uncheck-label`,
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {
            id_item: idx,
            sec: sec,
            chk: chk,
            username  : VUserName,
          },
          cache: false,
          success: function (response){
            LoadTabelLabelPacking();
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      });



    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}




$(document).ready(function () {

  LoadDataSign();

  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide: true,
    weekStart: 1
  });

  
  $("#TableList").on("click", ".BtnEditTrialMaker", function(){
    var eid  = $(this).attr('eid');
    $(".WindowAddEditItemTrialMaker").modal({ autofocus: false, closable : false, }).modal("show");
    LoadEditItemTrialMaker(eid);
    
  });


  $('#SubmitDownloadLabelPacking').on('click', function() {
    $.ajax({
      type    : "GET",
      url     : `${restlocpscxls}DownloadLabelPacking`,
      headers: {
        user  : VUserName,
        token : VToken
      },
      data: {
        id: IdMPP,
        tahap: $('#SelectTahap').val(),
      },
      cache: false,
      success: function (response){
        window.location.href = "../RND_Upload/MPP/MppLabelPacking_.xlsx";
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });




  $(".CloseModal").on("click", function(){
    $(".WindowAddEditItemTrialMaker").modal("hide");
    $(".WindowGenerateItemTrial").modal("hide");
    $(".WindowDownloadLabelDist").modal("hide");
    $(".WindowDownloadLabelPacking").modal("hide");
  });


  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterTahap = $("#ftahap_mpp").val();
    var FilterSales = $("#fsales_mpp").val();
    var FilterVendor = $("#fvendor_mpp").val();
    var FiterArry = [FilterCari, FilterTahap, FilterSales, FilterVendor];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialMaker", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#ftahap_mpp, #fsales_mpp, #fvendor_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterTahap = $("#ftahap_mpp").val();
      var FilterSales = $("#fsales_mpp").val();
      var FilterVendor = $("#fvendor_mpp").val();
      var FiterArry = [FilterCari, FilterTahap, FilterSales, FilterVendor];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterSchTrialMaker", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    $("#fcari_mpp").val("");
    $("#ftahap_mpp").dropdown("set selected", "ALL");
    $("#fsales_mpp").dropdown("set selected", "ALL");
    $("#fvendor_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialMaker", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", "ALL", "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });



  
});