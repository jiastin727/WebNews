
const LogoutProtect = false;
function TableListFunc() {

  var GetCookieAllPIC = decodeURIComponent(getCookie("CooAllPIC"));
  var ArryAllPIC   = GetCookieAllPIC.split(", ");
  var JsonFilter = getCookie('FilterMPPItem');
  var ArrayF = JSON.parse(JsonFilter);

  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var SalesContractF = ArrayF[1];
  } else {
    var SearchF   = "";
    var SalesContractF = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }

  if (SalesContractF) {
    $("#fsales_mpp").dropdown("set selected", SalesContractF);
    var SalesContractFStart = SalesContractF;
  } else {
    var SalesContractFStart = "ALL";
  }

  // var MPPFStart = "";

  var FiterArry = [SearchFStart, SalesContractFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPItem", JsonFilter, 5);

  $("#TableList").DataTable({
    dom: "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    scrollX: true,
    ordering: true,
    scrollCollapse: true,
    paging: true,
    scrollY: '50vh',
    scroller: {
      loadingIndicator: true
    },
    fixedColumns: {
      leftColumns: 4
    },
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      processing: '<i class="spinner loading icon huge"></i>',
      infoEmpty: "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [
      [0, "asc"]
    ],
    columns: [
      { data: null,
        name  : 'IdItemMPP',
        render: function (data) {
          if (ArryAllPIC.includes(DUser)){
            return `<span class="BtnEditItem clicklink" eid="${data['IdItemMPP']}" esc="${data['SalesContract']}" edesc="${data['Description']}" data-tooltip="Edit Item MPP" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
          } else {
            return '';
          }
        },
      },
      { data: null,
        name  : 'IdItemMPP',
        render: function (data) {
          if (ArryAllPIC.includes(DUser)){
            return `<span class="BtnEditColor clicklink" eid2="${data['IdItemMPP']}" edesc2="${data['Description']}" data-tooltip="Edit Material Color" data-inverted="" data-position="right center"><i class="tint circle link circular blue icon "></i></span>`;
          } else {
            return '';
          }
        }
      },
      { data: 'NoItem'},
      { data: null,
        name  : 'Description',
        render: function (data) {
          var arympp = data['NoItem'].split('-');
          var nompp = arympp[1] + '-' + arympp[2] + '-' + arympp[3];
     
          if ((nompp === "00-00-00" || data['Cavity'] === "INSERT") && (data['SecondaryProses'] === "-" || data['SecondaryProses'] === "" || data['SecondaryProses'] === null)) {
            return `<span data-tooltip="Secondary Proccess Item MPP ini belum terisi/tidak jelas" data-inverted="" data-position="right center"> <i class="exclamation triangle circle link circular red icon "></i></span> `+data['Description'];
          } else {
            return data['Description'];
          }
        }
      },
      { data: 'DrawingNum'},
      { data: 'DrawingLoc'},
      { data: 'Designer'},
      { data: null,
        name  : 'SalesContract',
        render: function (data) {
          return `<span class="DownloadSalesContract clicklink" nosurat="${data['SalesContract']}" data-tooltip="View Sales Contract" data-inverted="" data-position="right center">${data['SalesContract']}</span>`;
        }
      },
      { data: 'WbsProject'},
      { data: 'VendorName'},
      { data: 'VendorCode'},
      { data: 'Curr'},
      { data: 'Cavity'},
      { data: 'GateType'},
      { data: 'StdUsed'},
      { data: 'Resin'},
      { data: 'Brand'},
      { data: 'Grade'},
      { data: 'ResinMatNum'},
      { data: 'ResinMatDescript'},
      
      { data: 'ColorType' },
      { data: 'BasedResin'},
      { data: 'Color'},
      { data: 'ColorPercent'},
      { data: 'ColorMatNum'},
      { data: 'ColorMatDescrip'},
      { data: 'ColorVend'},
      { data: 'Tonnage'},
      { data: 'CycleTime'},
      { data: 'MoldSize'},
      { data: 'MoldWeight'},
      { data: 'MoldVolume'},
      { data: 'RunnerWeight'},
      { data: 'ProductWeight'},
      { data: 'TotalWeight'},
      { data: 'EstPrice'},
      { data: 'OptionalMesin'},
      { data: 'OptionalTools'},
      { data: 'SecondaryProses'},
      { data: 'AlokasiInjection'},
      { data: 'DrawingPackaging'},
      { data: 'DrawingPlasticPart'},
      { data: 'KirimSamplePartLocalInj'},
      { data: 'ETAKedatanganMold'},
      { data: 'CheckMold'},
      { data: 'LokasiCheckMold'},
      { data: 'ETASuppInject'},
      { data: null,
        name  : 'MCSFile',
        render: function (data) {
          if(data['MCSFile']){
            return `<span class="DownloadMCSFile clicklink" idmcs="${data['MoldCheckSheet']}" data-tooltip="Download MCS File" data-inverted="" data-position="right center">${data['MCSFile']}</span>`;
          } else {
            return ``;
          }
        }
      },
      { data: 'Remark'},
    ],
    columnDefs: [{
        className: "center aligned",
        targets: [0, 1, 2]
      },
      { orderable: false, targets: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39] }

    ],

    createdRow: function (row, data, index) {

      var arympp = data['NoItem'].split('-');
      var nompp = arympp[1] + '-' + arympp[2] + '-' + arympp[3];
      if (nompp === "00-00-00") {
        $(row).find("td").css("background-color", BgColor000000);
      }

      if (data['Cavity'] === "INSERT") {
        $(row).find("td").css("background-color", BgColorInsert);
      }
      
      if ( data['Diff'] !== 'null' && data['Diff'] !== null) {
        
        var CollIndex = ['col0','col1','icon_color','description','drawing_number','drawing_loc','designer','sales_contract','wbs_project','manuf','code','curr','cavity','gate_type','std_use','resin','brand','grade','resin_mat_num','resin_description','color_type','based_resin','color','color_percent','color_mat_num','color_mat_descript','color_vend','tonnage_ton','cycle_time_sec','mold_size_hvt_mm','mold_weight_kg','mold_volume_m3','runner','product','total_weight_shoot_g','est_price_rp','optional_mesin','optional_tools','secondary_process'];

        if (data['Diff'] === "*") {
          $(row).find("td").css("color", ColorAllDiff);
          $(row).find("td").css("font-weight", 'bold');
        } else {
          var AryDiff = data['Diff'].split(',');
          var LenDiff = AryDiff.length;
          for (let i = 0; i < LenDiff; i++) {
            var index = CollIndex.findIndex((col) => col === AryDiff[i]);
            $(row).find("td:eq("+index+")").css("color", ColorItemDiff);
            $(row).find("td:eq("+index+")").css("font-weight", 'bold');
            if(index>0){
              $(row).find("td:eq(2)").css("color", '#4800ff');
              $(row).find("td:eq(2)").css("font-weight", 'bold');
            }
          }
        }

      }

      if ((nompp === "00-00-00" || data['Cavity'] === "INSERT") && (data['SecondaryProses'] === "-" || data['SecondaryProses'] === "" || data['SecondaryProses'] === null)) {
        $(row).find("td").css("color", "#ff0000");
      }

    },

    ajax: {
      url: '../RND_BackEnd/backend_mpp/mpp/load-detail/' + IdMPP,
      type: "POST",
      headers: {
        user: VUserName,
        token: VToken,
      },
      data    : {
        FSearch   : SearchFStart,
        FSalesContract : SalesContractFStart,
      },

      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });

}

$('[data-toggle="datepicker"]').datepicker({
  format: 'yyyy-mm-dd',
  autoHide: true,
  weekStart: 1
});



//Function Load Data Header
function LoadDataHeaderMPP(a) {
  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/mpp/load-header/` + a,
    headers: {
      user: VUserName,
      token: VToken
    },
    cache: false,
    success: function (data) {
      var obj = JSON.parse(data);
      $('#HeaderNoMPP').text(obj.NoMPP + ' ' + obj.Rev);
      $('#HeaderTitle').text(obj.Title);
      $('#HeaderPrjId').text(obj.ProjectIDs);
      $("#HeaderJenisPrj").text(obj.JenisProject);
      $("#HeaderPrd").text(obj.Product);
      $("#HeaderChs").text(obj.Chassis);
      $("#HeaderCab").text(obj.Cabinet);
      $('#HeaderVendor').text(obj.Vendor);
      $('#HeaderEstKurs').text('1USD = '+obj.EstKurs+' IDR');
      $('#HeaderNote').text(obj.Note);
      $('#HeaderHOMD').text(obj.HeadOfMD);
      $('#HeaderHOID').text(obj.HeadOfID);
      $('#HeaderPL').text(obj.ProjectLeader);
      $('#HeaderNego').text(obj.Negotiator);
      $('#HeaderStatus').html('<sup>&nbsp;&nbsp;&nbsp;<div class="ui mini teal basic left pointing label">'+obj.Status+' - '+obj.Progres+'</div></sup>');

      $('#HeaderMDDes').text(obj.DesignerMD1 + '; ' + obj.DesignerMD2 + '; ' + obj.DesignerMD3 + '; ' + obj.DesignerMD4 + '; ' + obj.DesignerMD5+ '; ' + obj.DesignerMD6);
      $('#HeaderIDDes').text(obj.DesignerID1 + '; ' + obj.DesignerID2 + '; ' + obj.DesignerID3 + '; ' + obj.DesignerID4 + '; ' + obj.DesignerID5);

      if (typeof obj.DesignerMD6 == "undefined") {
        $('#HeaderMDDes').text(obj.DesignerMD1 + '; ' + obj.DesignerMD2 + '; ' + obj.DesignerMD3 + '; ' + obj.DesignerMD4 + '; ' + obj.DesignerMD5);
      }
      if (typeof obj.DesignerMD5 == "undefined") {
        $('#HeaderMDDes').text(obj.DesignerMD1 + '; ' + obj.DesignerMD2 + '; ' + obj.DesignerMD3 + '; ' + obj.DesignerMD4);
      }
      if (typeof obj.DesignerMD4 == "undefined") {
        $('#HeaderMDDes').text(obj.DesignerMD1 + '; ' + obj.DesignerMD2 + '; ' + obj.DesignerMD3);
      }
      if (typeof obj.DesignerMD3 == "undefined") {
        $('#HeaderMDDes').text(obj.DesignerMD1 + '; ' + obj.DesignerMD2);
      }
      if (typeof obj.DesignerMD2 == "undefined") {
        $('#HeaderMDDes').text(obj.DesignerMD1);
      }

      var CooAllDesID = obj.DesignerID1 + ', ' + obj.DesignerID2 + ', ' + obj.DesignerID3 + ', ' + obj.DesignerID4 + ', ' + obj.DesignerID5+ ', ' + obj.DesignerID6;
      if (typeof obj.DesignerID6 == "undefined") {
        $('#HeaderIDDes').text(obj.DesignerID1 + '; ' + obj.DesignerID2 + '; ' + obj.DesignerID3 + '; ' + obj.DesignerID4 + '; ' + obj.DesignerID5);
    }
      if (typeof obj.DesignerID5 == "undefined") {
        $('#HeaderIDDes').text(obj.DesignerID1 + '; ' + obj.DesignerID2 + '; ' + obj.DesignerID3 + '; ' + obj.DesignerID4);
      }
      if (typeof obj.DesignerID4 == "undefined") {
        $('#HeaderIDDes').text(obj.DesignerID1 + '; ' + obj.DesignerID2 + '; ' + obj.DesignerID3);
      }
      if (typeof obj.DesignerID3 == "undefined") {
        $('#HeaderIDDes').text(obj.DesignerID1 + '; ' + obj.DesignerID2);
      }
      if (typeof obj.DesignerID2 == "undefined") {
        $('#HeaderIDDes').text(obj.DesignerID1);
      }

      if((obj.Status == 'ACTIVE' && obj.Progres == 'PROCESS') || (obj.Status == 'DRAFT' && obj.Progres == 'DESIGNER')){
        $('#FeatureEditHeader').html('<div class="ui blue tiny compact labeled icon button" data-tooltip="Edit Header" data-inverted="" data-position="top left" id="EditHeader"><i class="bookmark icon"></i>Edit Header</div>');
        if(obj.Status == 'ACTIVE' && obj.Progres == 'PROCESS'){
            $('#FeatureReqRevisi').html('<div class="ui teal tiny compact labeled icon button" data-tooltip="Permintaan revisi MPP yang di tujukan ke Negosiator" data-position="top left" data-inverted="" id="ReqRev"><i class="external square alternate icon"></i>Request Revisi MPP</div>');
        } else {
          $('#FeatureReqRevisi').html('');
        }
      
      } else if(obj.Status == 'CANCEL' && obj.Progres == '-'){
        $('#FeatureEditHeader').html('');
        if(obj.Revisi == true){
          $('#FeatureReqRevisi').html('<div class="ui teal tiny compact labeled icon button" data-tooltip="Revisi MPP" data-position="top left" data-inverted="" id="RevisiMPP"><i class="window restore outline icon"></i>Revisi MPP</div>');
        } else {
          $('#FeatureReqRevisi').html('<div class="ui grey disabled tiny compact labeled icon button" ><i class="window restore outline icon"></i>Revisi MPP</div>');
        }
      } else {
        $('#FeatureEditHeader').html('<div class="ui blue tiny compact labeled icon button" data-tooltip="Diposisi seperti ini, edit header hanya diperbolehkan merubah note-nya saja" data-position="top left" data-inverted="" id="EditHeader"><i class="bookmark icon"></i>Edit Header\'s Note</div>');
        if(obj.Status == 'REQ-REVISI'){
          $('#FeatureReqRevisi').html('<div class="ui basic grey tiny compact labeled icon button" data-tooltip="Menunggu approval dari Negosiator untuk revisi MPP" data-position="top left" data-inverted="" ><i class="exclamation triangle icon"></i>Revisi MPP Requested</div>');
        } else {
          $('#FeatureReqRevisi').html('');
        }
      }

      if(obj.Status == 'REQ-REVISI'){
        $('#FeatureApproveRevisi').html('<div class="ui teal tiny compact labeled icon button" data-tooltip="Persetujuan permintaan revisi MPP dari PIC MPP (MD)" data-position="right center" data-inverted="" id="ApproveRev"><i class="check icon"></i>Approve Revisi MPP</div><br><sub><i>Note: Pastikan sebelum klik approve, data-data MPP yang akan di revisi yang sekiranya diperlukan bisa di download/ di-screenshoot terlebih dahulu untuk menghindari hilangnya beberapa informasi dari data-data yang bersifat penting tersebut.</i></sub>');
      } else {
        $('#FeatureApproveRevisi').html('<sup><i>Tidak ada permintaan revisi MPP</i></sup>');
      }

      $('#ReqRev').on('click', function () {
        Swal.fire({
          title: "<h3>Permintaan Revisi untuk MPP ini ke Negosiator?</h3>",
          confirmButtonText: "Ya",
          showCancelButton: true,
        }).then((result) => {
          if (result.value) {
            $.ajax({
              type    : "POST",
              url     : `../RND_BackEnd/backend_mpp/mpp/revise/request`,
              headers : {
                user  : VUserName,
                token : VToken
              },
              data: {   
                id_mpp: IdMPP,
                username : VUserName,
              },
              cache: false,
              success: function (response) {
                var obj = JSON.parse(response);
                if(isEmpty(obj)) {
                  IsResponseEmptyObj();
                } else if(obj) {
                  if (obj.status == false){
                    IsResponseFalse(obj.message);
                  } else {
                    IsResponseTrue(obj.message);
                    var EncId = Ucrypt.encrypt(IdMPP, NonceValue);
                    window.location.href = "./?link=mppindex&i=" + EncId;
                  }
                } else {
                  IsResponseErrorElse();
                }
              },
              error: function () {
                IsTimeOut(LogoutProtect);
              },
            });
          }
        });
      });

      $('#ApproveRev').on('click', function () {
        Swal.fire({
          title: "<h3>Approve Permintaan Revisi untuk MPP ini?</h3>",
          confirmButtonText: "Ya",
          showCancelButton: true,
        }).then((result) => {
          if (result.value) {
            $.ajax({
              type    : "POST",
              url     : `../RND_BackEnd/backend_mpp/mpp/revise/confirm`,
              headers : {
                user  : VUserName,
                token : VToken
              },
              data: {   
                id_mpp: IdMPP,
                username : VUserName,
              },
              cache: false,
              success: function (response) {
                var obj = JSON.parse(response);
                if(isEmpty(obj)) {
                  IsResponseEmptyObj();
                } else if(obj) {
                  if (obj.status == false){
                    IsResponseFalse(obj.message);
                  } else {
                    IsResponseTrue(obj.message);
                    var EncId = Ucrypt.encrypt(IdMPP, NonceValue);
                    window.location.href = "./?link=mppindex&i=" + EncId;
                  }
                } else {
                  IsResponseErrorElse();
                }
              },
              error: function () {
                IsTimeOut(LogoutProtect);
              },
            });
          }
        });
      });


      $('#RevisiMPP').on('click', function () {
        Swal.fire({
          title: "<h3>Revisi untuk MPP ini??</h3>",
          confirmButtonText: "Ya",
          showCancelButton: true,
        }).then((result) => {
          if (result.value) {
            $.ajax({
              type    : "POST",
              url     : `../RND_BackEnd/backend_mpp/mpp/revise`,
              headers : {
                user  : VUserName,
                token : VToken
              },
              data: {   
                id_mpp: IdMPP,
                username : VUserName,
              },
              cache: false,
              success: function (response) {
                var obj = JSON.parse(response);
                if(isEmpty(obj)) {
                  IsResponseEmptyObj();
                } else if(obj) {
                  if (obj.status == false){
                    IsResponseFalse(obj.message);
                  } else {
                    IsResponseTrue(obj.message);
                    var EncId = Ucrypt.encrypt(IdMPP, NonceValue);
                    window.location.href = "./?link=mppindex&i=" + EncId;
                  }
                } else {
                  IsResponseErrorElse();
                }
              },
              error: function () {
                IsTimeOut(LogoutProtect);
              },
            });
          }
        });
      });
      
      TableListFunc();

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


function LoadDataSignMPP(b) {
  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/sign/load/`+b,
    headers: {
      user: VUserName,
      token: VToken
    },
    cache: false,
    success: function (data) {
      var obj = JSON.parse(data);

      if(obj.DateSignMD1 ===null && obj.SignByMD1 === null ){
        $('#featureuploaditemmpp').html('<div class="ui  tiny compact primary labeled icon button" data-tooltip="Upload file item MPP" data-inverted="" data-position="right center" id="UploadItemMPP"><i class="cloud upload icon"></i> <span id="s">Upload Item MPP</span></div>');
        $('#featuredownloadtemplate').html('<div class="ui tiny compact teal labeled icon button" data-tooltip="Download file template" data-inverted="" data-position="right center" id="DownloadTempMPP"><i class="arrow down icon"></i> <span id="s">Download Template</span></div>');
      } else {
        $('#featureuploaditemmpp').html('');
        $('#featuredownloadtemplate').html('');
      }
      

      $('#EditHeader').on('click', function () {
        var EncId = Ucrypt.encrypt(IdMPP, NonceValue);
        window.location.href = "./?link=mppheader&i=" + EncId;
      });

      $("#UploadItemMPP").on("click", function (e) {
        $(".WindowUploadItemMPP").modal({ autofocus: false, closable : false }).modal("show");
      });

      $("#DownloadTempMPP").on("click", function (e) {
        window.location.href = '../RND_BackEnd/backend_mpp/download/template/mpp-detail';
      });

      

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

//Fuction Save Edit Item (MD)
function SaveEditItem() {

  var IdItemMPP = $("#EditIdItemMPP").val();
  var SalesContract = $("#EditSalesContract").val();
  var OptMesin = $("#EditOptMesin").val();
  var OptTools = $("#EditOptTools").val();
  var SecondPrc = $("#EditSecondPro").val();
  var AlokasiInject = $("#EditAlokasiInject").val();
  var Remark = $("#EditRemark").val();
  var FileMCS = "";
  var DrwPacking = $("#EditDrwPacking").val();
  var DrwPlasticPart = $("#EditDrwPlasticPart").val();
  var KirimSample = $("#EditKirimSample").val();
  var ETAMold = $("#EditETAKedatanganMold").val();
  var CekMold = $("#EditCekMold").val();
  var LocCekMold = $("#EditLokasiCekMold").val();
  var ETASuppInject = $("#EditETASuppInject").val();

  data = {
    IdMPP: IdMPP,
    SalesContract: SalesContract,
    IdItemMPP: IdItemMPP,
    OptMesin: OptMesin,
    OptTools: OptTools,
    SecondPrc: SecondPrc,
    AlokasiInject: AlokasiInject,
    Remark: Remark,
    FileMCS: FileMCS,
    DrwPacking: DrwPacking,
    DrwPlasticPart: DrwPlasticPart,
    KirimSample: KirimSample,
    ETAMold: ETAMold,
    CekMold: CekMold,
    LocCekMold: LocCekMold,
    ETASuppInject: ETASuppInject,
    Username: VUserName,
  };

  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/mpp/edit-detail-md`,
    headers: {
      user: VUserName,
      token: VToken
    },
    data: data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if (obj) {
        if (obj.status == false) {
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          $(".WindowEditItemMPP").modal("hide");
          TableListFunc();
        }
      } else {
        IsResponseErrorElse();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });

}

//Fuction Load Data Item MPP
function LoadDataItemMPP(idx,isc) {
  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/mpp/load-detail-item/` + idx,
    headers: {
      user: VUserName,
      token: VToken
    },
    cache: false,
    success: function (data) {
      var obj = JSON.parse(data);
      $('#EditOptMesin').val(obj.OptionalMesin);
      $('#EditOptTools').val(obj.OptionalTools);
      $('#EditAlokasiInject').val(obj.AlokasiInjection);
      $("#EditRemark").val(obj.Remark);
      // $("#EditDrwPacking").val(obj.DrawingPackaging);
      // $("#EditDrwPlasticPart").val(obj.DrawingPlasticPart);
      $('#EditKirimSample').val(obj.KirimSamplePartLocalInject);
      $('#EditETAKedatanganMold').val(obj.ETAKedatanganMold);
      $('#EditCekMold').val(obj.CheckMold);
      $('#EditLokasiCekMold').val(obj.LokasiCheckMold);
      $('#EditETASuppInject').val(obj.ETASupplierInject);
      $('#EditSecondPro').val(obj.SecondaryProses);
      $('#EditIdItemMPP').val(idx);
      $('#EditSalesContract').val(isc);
      $('#EditDrawingLoc').text(obj.DrawingLoc);
      $('#EditDrawingNum').text(obj.DrawingNum);
      $('#EditDescript').text(obj.Description);
      if(obj.DrawingPackaging === "0000-00-00"){
        $("#EditDrwPacking").val('');
      } else {
        $("#EditDrwPacking").val(obj.DrawingPackaging);
      }
      if(obj.DrawingPlasticPart === "0000-00-00"){
        $("#EditDrwPlasticPart").val('');
      } else {
        $("#EditDrwPlasticPart").val(obj.DrawingPlasticPart);
      }


      $.ajax({
        type: "POST",
        url: `../RND_BackEnd/backend_mpp/mpp/load-header/` + IdMPP,
        headers: {
          user: VUserName,
          token: VToken
        },
        cache: false,
        success: function (data) {
          var obj = JSON.parse(data);

          const ArryPICAll =[];
          ArryPICAll.push(obj.DesignerMD1,obj.DesignerID1,obj.HeadOfMD,obj.HeadOfID,);
          var ArryStatus = ['ACTIVE','DRAFT','REQ-CLOSE','REQ-FINISH'];

          console.log(obj.Progres);
          console.log($.inArray(DUser, ArryPICAll));

          if($.inArray(DUser, ArryPICAll) > -1) {

            if(obj.Status == 'DRAFT') {

              $('#FeatureEditColor').html('<div id="EditMaterialColor" class="ui small teal labeled icon small compact button" data-tooltip="Edit Material Color" data-inverted=""><i class="tint icon"></i> <span id="s">Edit Material Color</span></div>');

              $("#EditMaterialColor").on("click", function (e) {
                $(".WindowEditMaterialColor").modal({ autofocus: false, closable : false, }).modal("show");
                var idy = $('#EditIdItemMPP').val();
                LoadDataMaterialColor(idy);
                AutocompleteColorMatNum();
              });

            }  else {

              $('#FeatureEditColor').html('<div id="EditMaterialColor" class="ui small disabled labeled icon small compact button" data-tooltip="Edit Material Color" data-inverted=""><i class="tint icon"></i> <span id="s">Edit Material Color</span></div>');
              
            }

            $('#FeatureSaveEditedItem').html('<div id="SaveEditedItem" class="ui small blue labeled icon small compact button" data-tooltip="Simpan perubahan" data-inverted=""><i class="save icon"></i> <span id="s">Save Data</span></div>');

            $('#FeatureUploadMoldCS').html('<div id="UploadMoldCS" class="ui small blue labeled icon small compact button" data-tooltip="Upload Mold Check Sheet" data-inverted=""><i class="cloud upload icon"></i> <span id="s">Upload MCS</span></div>');

            $('#SaveEditedItem').on('click', function () {
              SaveEditItem();
            });

            $("#UploadMoldCS").on("click", function (e) {
              $(".WindowUploadMCS").modal({ autofocus: false, closable : false, }).modal("show");
              $("#IdxDetail").val(idx);
            });
            

          }  else {

            $('#FeatureSaveEditedItem').html('<div class="ui small disabled labeled icon small compact button" data-tooltip="Simpan perubahan" data-inverted=""><i class="save icon"></i> <span id="s">Save Data</span></div>');

            $('#FeatureEditColor').html('<div id="EditMaterialColor" class="ui small disabled labeled icon small compact button" data-tooltip="Edit Material Color" data-inverted=""><i class="tint icon"></i> <span id="s">Edit Material Color</span></div>');

            $('#FeatureUploadMoldCS').html('<div class="ui small disabled labeled icon small compact button" data-tooltip="Upload Mold Check Sheet" data-inverted=""><i class="cloud upload icon"></i> <span id="s">Upload MCS</span></div>');

          }

          

    
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });

      

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


//Fuction Load Data Item MPP Material Color
function LoadDataMaterialColor(idxa) {
  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/mpp/load-header/` + IdMPP,
    headers: {
      user: VUserName,
      token: VToken
    },
    cache: false,
    success: function (data) {
      var obj = JSON.parse(data);

      if(obj.Status !== 'DRAFT') {
        IsResponseFalse('Maaf, perubahan Material Color dalam tahap ini tidak diijinkan, karena MPP sudah berada di Negosiator.');
      }  else {
        $(".WindowEditMaterialColor").modal({ autofocus: false, closable : false, }).modal("show");
        AutocompleteColorMatNum();
        $.ajax({
          type: "POST",
          url: `../RND_BackEnd/backend_mpp/mpp/load-detail-item/` + idxa,
          headers: {
            user: VUserName,
            token: VToken
          },
          cache: false,
          success: function (data) {
            var obj = JSON.parse(data);
            $("#EditColMatNum").val(obj.ColorMatNum);
            $('#ColMatDesc').val(obj.ColorMatDescrip);
            $('#Color').val(obj.Color);
            $("#ColPerc").val(obj.ColorPercent);
            $("#ColVend").val(obj.ColorVend);
            $("#ColType").val(obj.ColorType);
            $("#BasedResin").val(obj.BasedResin);
            $('#EditIdItemMPP2').val(idxa);
            $('#EditDrawingLoc2').text(obj.DrawingLoc);
            $('#EditDrawingNum2').text(obj.DrawingNum);
            $('#EditDescript2').text(obj.Description);
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
  
}


//Fuction Save Edit Item Color Material (ID)
function SaveEditItemMatColor() {

  var IdItemMPP = $("#EditIdItemMPP2").val();
  var ColorMatNum = $("#EditColMatNum").val();
  var ColorMatDesc = $("#ColMatDesc").val();
  var Color = $("#Color").val();
  var ColorPercent = $("#ColPerc").val();
  var ColorVend = $("#ColVend").val();
  var ColorType = $("#ColType").val();
  var BasedResin = $("#BasedResin").val();

  data = {
    IdMPP: IdMPP,
    IdItemMPP: IdItemMPP,
    ColorMatNum: ColorMatNum,
    ColorMatDesc: ColorMatDesc,
    Color: Color,
    ColorPercent: ColorPercent,
    ColorVend: ColorVend,
    ColorType: ColorType,
    BasedResin: BasedResin,
    Username: VUserName,
  };

  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/mpp/edit-detail-id`,
    headers: {
      user: VUserName,
      token: VToken
    },
    data: data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if (obj) {
        if (obj.status == false) {
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          $(".WindowEditMaterialColor").modal("hide");
          TableListFunc();
        }
      } else {
        IsResponseErrorElse();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });

}


//Fuction Save Blank Item Color Material / delete material color
function SaveBlankItemMatColor() {

  $(".WindowEditMaterialColor").modal("hide");
  var IdItemMPP = $("#EditIdItemMPP2").val();
  var ColorMatNum = "-";
  var ColorMatDesc = "-";
  var Color = "-";
  var ColorPercent = "-";
  var ColorVend = "-";
  var ColorType = "-";
  var BasedResin = "-";

  data = {
    IdMPP: IdMPP,
    IdItemMPP: IdItemMPP,
    ColorMatNum: ColorMatNum,
    ColorMatDesc: ColorMatDesc,
    Color: Color,
    ColorPercent: ColorPercent,
    ColorVend: ColorVend,
    ColorType: ColorType,
    BasedResin: BasedResin,
    Username: VUserName,
  };

  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/mpp/edit-detail-id`,
    headers: {
      user: VUserName,
      token: VToken
    },
    data: data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if (obj) {
        if (obj.status == false) {
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          TableListFunc();
        }
      } else {
        IsResponseErrorElse();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });

}


function AutocompleteColorMatNum() {
  $(".ui.search.colormatnum").search({
    minCharacters: 1,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/mpp/search-material?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc_vend",
    },
    onSelect: function (response) {
      $('#ColMatDesc').val(response.desc);
      $('#Color').val(response.color);
      $('#ColPerc').val(response.color_percent);
      $('#ColVend').val(response.color_vendor);
      $('#ColType').val(response.mat_type);
      $('#BasedResin').val(response.based_resin);
    },
  });
}


// Upload Item MPP
$("#SubmitUpload").on("click", function () {
  var file_data = $("#UploadFileXls").prop("files")[0];
  var id_mpp = IdMPP;
  var form_data = new FormData();
  form_data.append("file", file_data);
  form_data.append("IdMPP", id_mpp);
  form_data.append("Username", VUserName);
  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `../RND_BackEnd/backend_mpp/mpp/upload-detail`,
    headers: {
      user: VUserName,
      token: VToken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        IsResponseFalse(obj.message);
      } else {
        IsResponseTrue(obj.message);
        $(".WindowUploadItemMPP").modal("hide");
        TableListFunc();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});


// Upload MCS
$("#SubmitUploadMCS").on("click", function () {
  var file_data = $("#UploadFileMCS").prop("files")[0];
  var id_mpp = IdMPP;
  var id_item = $("#IdxDetail").val();
  var form_data = new FormData();
  form_data.append("file", file_data);
  form_data.append("IdMPP", id_mpp);
  form_data.append("IdItem", id_item);
  form_data.append("Username", VUserName);
  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `../RND_BackEnd/backend_mpp/mpp/upload-mcs`,
    headers: {
      user: VUserName,
      token: VToken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        IsResponseFalse(obj.message);
      } else {
        IsResponseTrue(obj.message);
        $(".WindowUploadMCS").modal("hide");
        TableListFunc();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});



$(document).ready(function () {

  LoadDataHeaderMPP(IdMPP);
  LoadDataSignMPP(IdMPP);

  $("#TableList").on("click", ".BtnEditItem", function () {
    var idx = $(this).attr('eid');
    var isc = $(this).attr('esc');
    $(".WindowEditItemMPP").modal({ autofocus: false, closable : false, }).modal("show");
    LoadDataItemMPP(idx,isc);
  });

  

  $('#SaveMaterialColor').on('click', function () {
    SaveEditItemMatColor();
  });

  $('#DeleteMaterialColor').on('click', function () {
    Swal.fire({
      title: "<h3>Hapus material color item ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        SaveBlankItemMatColor();
      }
    });
  });

  $("#TableList").on("click", ".BtnEditColor", function () {
    var idx = $(this).attr('eid2');
    LoadDataMaterialColor(idx);
  });

  

  $("#SubmitEditNote").on("click", function () {
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/savenote`,
      headers: {
        user  : VUserName,
        token : VToken
      },
      data: {
        id_mpp      : IdMPP,
        username    : VUserName,
        note        : $("#NoteHeaderEdited").val()
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            $(".WindowEditHeaderNote").modal("hide");
            LoadDataHeaderMPP(IdMPP);
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });





  $("#TableList").on("click", ".DownloadSalesContract", function () {
    var nosurat= $(this).attr('nosurat');
    $.redirect(
      "./?link=downloadsc",
      { 
        nosurat: nosurat,
      },
      "POST",
      "_blank"
    );
  });

  $("#TableList").on("click", ".DownloadMCSFile", function () {
    var iddwn = $(this).attr('idmcs');
    var EncId = Ucrypt.encrypt(iddwn, NonceValue);
    window.location.href = "./?link=mppdownload&i=" + EncId;
  });



  $('#DownloadItemMPP').on('click', function () {
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_excel/downloaddetailitempp`,
      // headers: {
      //   user  : VUserName,
      //   token : VToken,
      // },
      data    : {
        IdMPP   : IdMPP,
      },
      cache: false,
      success: function (response){
        window.location.href = "../RND_Upload/MPP/DetailItemMPP.xlsx";
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });




  $(".CloseModal").on("click", function (e) {
    $(".WindowEditItemMPP").modal("hide");
    $(".WindowUploadItemMPP").modal("hide");
    $(".WindowEditMaterialColor").modal("hide");
    $(".WindowUploadMCS").modal("hide");
    // $(".WindowEditHeaderNote").modal("hide");
  });


  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#submitfilter").on("click", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterSales = $("#fsales_mpp").val();
    var FiterArry  = [FilterCari,FilterSales];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPItem", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fsales_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterSales = $("#fsales_mpp").val();
      var FiterArry = [FilterCari, FilterSales];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPItem", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

    //RESET FILTER
  $(".resetfilter").on("click", function () {
    $("#fcari_mpp").val("");
    $("#fsales_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["","ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPItem", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });


  


  // var CollIndexxx = ['col0','col1','description','drawing_number','drawing_loc','designer','sales_contract','wbs_project'];
  // var qwe = 'description,drawing_loc,designer,wbs_project';


  // var AryDiffxx = qwe.split(',');
  // var LenDiffxx = AryDiffxx.length;

  // for (let i = 0; i < LenDiffxx; i++) {
  //   var indexxx = CollIndexxx.findIndex((col) => col === AryDiffxx[i]);
  //   console.log(indexxx);
  // }






});