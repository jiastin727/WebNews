const LogoutProtect = false;
var GetCookieNego = decodeURIComponent(getCookie("CooNego"));
var GetCookieOpr  = decodeURIComponent(getCookie("CooOpr"));

function ReadAllItem() {

  $.ajax({
    type: "POST",
      url     : '../RND_BackEnd/backend_mpp/persiapan/load-header/'+IdMPP,
    dataType: "json",
    headers : {
      user  : VUserName,
      token : VToken,
    },
    data: { IdMPP: IdMPP },
    cache: false,
    success: function (response) {
      
      if (isEmpty(response)) {
        console.log("Gagal load, data kosong");
        return false;

      } else if (response) {

        JmlDataA = response.length;
        console.log(response.length);
        $("#TblPersiapan").empty();
        for (a = 0; a < JmlDataA; a++) {
          if (response[a]['id'] !== undefined){
            idh = response[a]['id'];
          } else {
            idh = 'null';
          }
          $("#TblPersiapan").append(
            "<table>"+
              "<tr>"+
                "<td width='45%' valign='top'>"+
                  "<table class='ui orange small striped table single line tb_headerdetail' >"+
                    "<tr>"+
                      "<td width='60%'><b>No Sales Contract</b></td>"+
                      "<td>: <b><span class='DownloadSalesContract' nosurat='"+response[a]['sales_contract']+"'>"+response[a]['sales_contract']+"</span></b></td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td width='60%'><b>Kirim List Kebutuhan ke Mold Maker</b></td>"+
                      "<td>: "+IsUndefinedMoment((response[a]['kirim_list']))+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>Jawaban List Kebutuhan dari Mold Maker</b></td>"+
                      "<td>: "+IsUndefinedMoment((response[a]['jawaban_list']))+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>Proses Buat IHB <i class='arrow right  icon'></i>PR <i class='arrow right  icon'></i>PO</b></td>"+
                      "<td>: "+IsUndefinedMoment((response[a]['proses_buat']))+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>Official PO Release ke Mold Maker</b></td>"+
                      "<td>: "+IsUndefinedMoment((response[a]['official_po_release']))+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>Kirim Final List Kebutuhan ke Distributor</b></td>"+
                      "<td>: "+IsUndefinedMoment((response[a]['kirim_final_list']))+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>PO Number</b></td>"+
                      "<td>: "+IsUndefined(response[a]['po_number'])+"</td>"+
                    "</tr>"+
                  "</table>"+
                "</td>"+

                "<td width='45%' valign='top'>"+
                  "<table class='ui orange small striped table single line tb_headerdetail' >"+
                    "<tr>"+
                      "<td width='20%'><b>Credit Note Material</b></td>"+
                      "<td>: "+IsUndefined(response[a]['ada_credit_note'])+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>Drawing Plastik</b></td>"+
                      "<td>: "+IsUndefined(response[a]['drawing_plastik'])+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>Drawing Packaging</b></td>"+
                      "<td>: "+IsUndefined(response[a]['drawing_packaging'])+"</td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td><b>Note</b></td>"+
                      "<td>: "+IsUndefined(response[a]['note'])+
                      "<input type='hidden' id='statusheader'></td>"+
                    "</tr>"+
                    "<tr>"+
                      "<td colspan='2' style='background-color: #f0f0f0;'>"+
                        "<span id='FeatureEditHeaderPersiapan"+a+"'></span>"+
                      "</td>"+
                    "</tr>"+
                  "</table>"+
                "</td>"+
              "</tr>"+
            "</table>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            
            "<div class=''>"+
              "<table id='TableList"+a+"' class='ui selectable striped small very compact table TableList' >"+
                "<thead>"+
                  "<tr>"+
                    "<th width='10px'></th>"+
                    "<th width='30px'>No</th>"+
                    "<th width='80px'>WOS</th>"+
                    "<th width='80px'>Tracking Number</th>"+
                    "<th width='100px'>Buat Remark untuk Kirim Material</th>"+
                    "<th width='80px'>Buat PMT untuk Kirim Material</th>"+
                    "<th width='80px'>Material Ready Kirim</th>"+
                    "<th width='80px'>Material Berangkat ke Hit Cikarang</th>"+
                    "<th width='80px'>Kirim Form Export ke Hit Jkt</th>"+
                    "<th width='80px'>Kirim Remark & Msds ke Hit Jkt</th>"+
                    "<th width='80px'>Kirim Letter of Confirmation ke Hit Jkt</th>"+
                    "<th width='100px'>ETD Material (IndPort)</th>"+
                    "<th width='80px'>ETA Material (DestPort)</th>"+
                    "<th width='80px'>Material Diterima Mold Maker</th>"+
                    "<th width='100px'>Nomor Reservasi Material</th>"+
                    "<th width='100px'>Kirim Sebagian Material</th>"+
                    "<th width='100px'>Sebagian Material Diterima Mold Maker</th>"+
                    "<th width='280px'>Note</th>"+
                  "</tr>"+
                "</thead>"+
                "<tbody></tbody>"+
              "</table>"+
            "</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<span id='FeaturesAddItemPersiapan"+a+"'></span><span id='FeaturesDownloadPersiapan"+a+"'></span>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"
          );
          TableListFunc(a,idh);

          if(DUser === GetCookieNego || DUser === GetCookieOpr ){
            if(idh !== 'null') {
              $('#FeaturesAddItemPersiapan'+a).html('<div class="ui small compact primary labeled icon button AddItemPersiapan" data-tooltip="Tambah item persiapan baru" data-inverted="" data-position="right center" id="AddNewPersiapan'+a+'" idheader='+idh+' ><i class="plus circle icon"></i> Add New</div>');

              $('#FeaturesDownloadPersiapan'+a).html('<div class="ui small compact green labeled icon button DownloadPersiapan" nosc="'+response[a]["sales_contract"]+'" idm="'+IdMPP+'" idh="'+idh+'" data-tooltip="Unduh data persiapan ini" data-inverted="" data-position="right center" id="DownloadPersiapan'+a+'" idheader='+idh+' ><i class="arrow down icon"></i> Download Data Persiapan</div>');
            } else {
              $('#FeaturesDownloadPersiapan'+a).html('');
              $('#FeaturesAddItemPersiapan'+a).html('');
            }

            $('#FeatureEditHeaderPersiapan'+a).html('<div class="ui mini compact teal labeled icon button EditHeaderPersiapan" id="EditHeader'+a+'" idheader='+idh+' scheader='+response[a]["sales_contract"]+' data-tooltip="Edit header persiapan No Sales Contract: '+response[a]['sales_contract']+'" data-inverted="" data-position="top left" idheader='+idh+' ><i class="pencil alternate icon"></i> Edit Header Persiapan</div>');
          } else {
            $('#FeaturesDownloadPersiapan'+a).html('');
            $('#FeaturesAddItemPersiapan'+a).html('');
            $('#FeatureEditHeaderPersiapan'+a).html('');
          }

          $.ajax({
            type: "POST",
            url: `../RND_BackEnd/backend_mpp/sign/load/`+IdMPP,
            headers: {
              user: VUserName,
              token: VToken
            },
            cache: false,
            success: function (data) {
              var obj = JSON.parse(data);
              if(obj.DateSignNego !==null && obj.SignByNego !== null ){
                $(".TableList").on("click", ".BtnEditPersiapan", function(){
                  var idx   = $(this).attr('eid');
                  var itbl  = $(this).attr('itbl');
                  var idhdr = $(this).attr('idhdr');
                  $(".WindowAddNewPersiapan").modal({ autofocus: false, closable : false, }).modal("show");
                  $('.ClearInput').val('');
                  LoadEditDetailPersiapan(idx,itbl,idhdr);
                });
                $(".AddItemPersiapan").on("click", function(){
                  var idheader  = $(this).attr('idheader');
                  $(".WindowAddNewPersiapan").modal({ autofocus: false, closable : false, }).modal("show");
                  $('.ClearInput').val('');
                  $("#PersiapanIdItem").val('');
                  $('#PersiapanIdHeader').val(idheader);
                });
                $(".EditHeaderPersiapan").on("click", function(){
                  var idheader  = $(this).attr('idheader');
                  var scheader  = $(this).attr('scheader');
                    $(".WindowEditHeaderPersiapan").modal({ autofocus: false, closable : false, }).modal("show");
                    $('.ClearInput').val('');
                    $("#HIdHeader").val('');
                    $("#HpersiapanSalesContract").val(scheader);
                    if(idheader !== 'null'){
                      LoadEditHeaderPersiapan(IdMPP,idheader);
                    } 
                    $('[data-toggle="datepicker"]').datepicker({
                      format: 'yyyy-mm-dd',
                      autoHide: true,
                      weekStart: 1
                    });
                });
    
              } else {
                $(".TableList").on("click", ".BtnEditPersiapan", function(){
                  IsResponseFalse('Negosiator belum sign-confirm, silakan sign dulu!');
                });

                $('.AddItemPersiapan').on('click', function() {
                  IsResponseFalse('Negosiator belum sign-confirm, silakan sign dulu!');
                });

                $('.EditHeaderPersiapan').on('click', function() {
                  IsResponseFalse('Negosiator belum sign-confirm, silakan sign dulu!');
                });
                
              }
    
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });

        }

        // Download XLS
        $('.DownloadPersiapan').on('click', function () {
          var NoSc = $(this).attr('nosc')
          var IdHd = $(this).attr('idh')
          var IdMp = $(this).attr('idm')
          $.redirect(
            "./?link=downloadmpppersiapan",
            {
              NoSc: NoSc,
              IdHd: IdHd,
              IdMp: IdMp,
            },
            "POST",
            "_blank"
          )
        })

      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });



}

function TableListFunc(indextabel,idheader) {
  
  $("#TableList"+indextabel).DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'>" +
      ">" +
      ">",
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    paging      : false,
    fixedColumns:   {
      leftColumns: 3
    },
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          if(GetCookieNego == DUser || GetCookieOpr == DUser){
            return `<span class="BtnEditPersiapan clicklink" eid="${data['Id']}" itbl="${indextabel}" idhdr="${idheader}" data-tooltip="Edit item persiapan" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
          } else {
            return '';
          }
        },
      },
      { data  : 'No' },
      { data  : 'WOS' },
      { data  : 'TrackingNumber' },
      { data  : 'BuatRemarkUntukKirimMaterial' },
      { data  : 'BuatPMTUntukKirimMaterial' },
      { data  : 'MaterialReadyKirim' },
      { data  : 'MaterialBerangkatKeHitCikarang' },
      { data  : 'KirimFormExportKeHitJkt' },
      { data  : 'KirimRemarkMsdsKeHitJkt' },
      { data  : 'KirimLetterOfConfirmationKeHitJkt' },
      { data  : 'ETDMaterialIndPort' },
      { data  : 'ETAMaterialDestPort' },
      { data  : 'MaterialDiterimaMoldMaker' },
      { data  : 'NomorReservasiMaterial' },
      { data  : 'KirimSebagianMaterial' },
      { data  : 'SebagianMaterialDiterimaMoldMaker' },
      { data  : 'Note' },
    ],
    columnDefs: [
      {
        targets: [4,5,6,7,8,9,10,11,12,13,15,16],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('DD MMM YY');
          } else {
            return '';
          }
        }
      },
      {
        className: "right aligned",
        targets: [4,5,6,7,8,9,10,11,12,13,15,16]
      },
    ],
    createdRow: function (row, data, index) {
      //WARNA FREEZE LEFT COLUMNS 
      $(row).find("td:eq(2)").css("border-right", "inset");
      $(row).find("td:eq(2)").css("border-right-color", ColorBorderFreeze);
    },
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/persiapan/load-detail/`+idheader,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
    
  });

  // $('#fcari_mpp'+indextabel).on( 'keyup', function () {
  //   var qw = $(this).val(); 
  //   // console.log(qw);
  //   DTables.search( this.value ).draw();
  // } );

}


// function TableListFuncDisabled() {
//   $("#TableList").DataTable({
//     dom:
//       "<'ui stackable grid'" +
//       "<'row'" +
//       "<'left aligned sixteen wide column'>" +
//       ">" +
//       "<'row dt-table'" +
//       "<'sixteen wide column'tr>" +
//       ">" +
//       "<'row'" +
//       "<'left aligned seven wide column'>" +
//       "<'left aligned two wide column'>" +
//       "<'right aligned seven wide column'>" +
//       ">" +
//       ">",
//     destroy     : true,
//     stateSave   : true,
//     processing  : true,
//     deferRender : true,
//     serverSide  : true,
//     orderClasses: false,
//     scrollX     : true,
//     scrollCollapse: true,
//     paging      : false,
//     fixedColumns:   {
//       leftColumns: 3
//     },
//     data        : [],
//     language    : {
    //   sLengthMenu : "_MENU_",
    //   search      : "",
    //   searchPlaceholder: "Pencarian..",
    //   processing  : '<i class="spinner loading icon huge"></i>',
    //   info        : "_START_ sampai _END_ dari _TOTAL_ total data",
    //   paginate    : {
    //     "first"   : "Awal",
    //     "last"    : "Akhir",
    //     "next"    : "<i class='chevron right icon'></i>",
    //     "previous": "<i class='chevron left icon'></i>"
    //   },
    //   infoEmpty   : "Tidak ada data",
    //   select  : {
    //     rows  : ""
    //   }
    // },
//     order     : [[1, "desc"]],
//     columns   : [
//       { data: null,
//         render: function (data) {
//           return '';
//         },
//       },
//       { data  : 'No' },
//       { data  : 'WOS' },
//       { data  : 'TrackingNumber' },
//       { data  : 'BuatRemarkUntukKirimMaterial' },
//       { data  : 'BuatPMTUntukKirimMaterial' },
//       { data  : 'MaterialReadyKirim' },
//       { data  : 'MaterialBerangkatKeHitCikarang' },
//       { data  : 'KirimFormExportKeHitJkt' },
//       { data  : 'KirimRemarkMsdsKeHitJkt' },
//       { data  : 'KirimLetterOfConfirmationKeHitJkt' },
//       { data  : 'ETDMaterialIndPort' },
//       { data  : 'ETAMaterialDestPort' },
//       { data  : 'MaterialDiterimaMoldMaker' },
//       { data  : 'NomorReservasiMaterial' },
//       { data  : 'KirimSebagianMaterial' },
//       { data  : 'SebagianMaterialDiterimaMoldMaker' },
//       { data  : 'Note' },
//     ],
//     ajax      : {
//       url     : `../RND_BackEnd/backend_mpp/persiapan/load-detail/`+IdMPP,
//       type    : "POST",
//       headers : {
//         user  : VUserName,
//         token : VToken,
//       },

//       error: function () {
//         IsTimeOut(LogoutProtect);
//       },
//     },
//   });
// }

// $('[data-toggle="datepicker"]').datepicker({
//   format: 'yyyy-mm-dd',
//   autoHide: true,
//   weekStart: 1
// });

// function LoadHeaderPersiapan(a){
//   $.ajax({
//     type: "POST",
//     url     : `../RND_BackEnd/backend_mpp/persiapan/load-header/`+a,
//     headers: {
//       user  : VUserName,
//       token : VToken
//     },
//     cache: false,
//     success: function (data){
//       var obj = JSON.parse(data);

//       if(isEmpty(obj)) {
//         IsResponseEmptyObj();
//       } else if(obj) {
//         if (obj.status == false){
//           $('#statusheader').val('false');
//         } else {
          
//           $('#statusheader').val('true');

//           if(obj.KirimListKebutuhanKeMoldMaker === null){
//             $('#KirimList').text('');
//           } else {
//             $('#KirimList').text(moment(obj.KirimListKebutuhanKeMoldMaker).format('DD MMMM YYYY'));
//           }

//           if(obj.JawabanListKebutuhanDariMoldMaker === null){
//             $('#JawabanList').text('');
//           } else {
//             $('#JawabanList').text(moment(obj.JawabanListKebutuhanDariMoldMaker).format('DD MMMM YYYY'));
//           }

//           if(obj.ProsesBuatIHBPRPO === null){
//             $('#ProsesIHB').text('');
//           } else {
//             $('#ProsesIHB').text(moment(obj.ProsesBuatIHBPRPO).format('DD MMMM YYYY'));
//           }

//           if(obj.OfficialPoReleaseKeMoldMaker === null){
//             $('#OfficialPORelease').text('');
//           } else {
//             $('#OfficialPORelease').text(moment(obj.OfficialPoReleaseKeMoldMaker).format('DD MMMM YYYY'));
//           }

//           if(obj.KirimFinalListKebutuhanKeDistributor === null){
//             $('#KirimFinal').text('');
//           } else {
//             $('#KirimFinal').text(moment(obj.KirimFinalListKebutuhanKeDistributor).format('DD MMMM YYYY'));
//           }

//           if(obj.UsulanModif === null){
//             $('#UsulModif').text('');
//           } else {
//             $('#UsulModif').text(moment(obj.UsulanModif).format('DD MMMM YYYY'));
//           }

//           $("#NoPO").text(obj.PONumber);
//           $("#CreditNote").text(obj.AdaCreditNoteMaterial);
//           $('#DrawingPlastic').text(obj.DrawingPlastik);
//           $('#DrawingPackaging').text(obj.DrawingPackaging);
//           $('#Note').text(obj.Note);

//         }
//       } else {
//         IsResponseErrorElse();
//       }


//       //Load Data Sign untuk proteksi ketika negosiator belum sign maka edit akan di tolak.
//       $.ajax({
//         type: "POST",
//         url: `../RND_BackEnd/backend_mpp/sign/load/`+IdMPP,
//         headers: {
//           user: VUserName,
//           token: VToken
//         },
//         cache: false,
//         success: function (data) {
//           var obj = JSON.parse(data);
//           if(obj.DateSignNego !==null && obj.SignByNego !== null ){
//             $("#EditHeader").on("click", function(){
//               $(".WindowEditHeaderPersiapan").modal({ autofocus: false, closable : false, }).modal("show");
//               $('.ClearInput').val('');
//               LoadEditHeaderPersiapan(IdMPP);
//             });

//             $('#FeaturesAddItemPersiapan').html('<div class="ui  small primary labeled icon button" data-tooltip="Tambah item persiapan baru" data-inverted="" data-position="right center" id="AddNewPersiapan"><i class="plus circle icon"></i> Add New</div>');
//             TableListFunc();

//           } else {
//             $('#EditHeader').on('click', function() {
//               IsResponseFalse('Negosiator belum sign-confirm, silakan sign dulu!');
//             });
//             $('#FeaturesAddItemPersiapan').html('');
//             TableListFuncDisabled();
//           }

//           $("#AddNewPersiapan").on("click", function(){
//             $(".WindowAddNewPersiapan").modal({ autofocus: false, closable : false, }).modal("show");
//             $('.ClearInput').val('');
//             $("#PersiapanIdItem").val('');
//           });

//         },
//         error: function () {
//           IsTimeOut(LogoutProtect);
//         },
//       });


//     },
//     error: function () {
//       IsTimeOut(LogoutProtect);
//     },
//   });
// }

function LoadEditHeaderPersiapan(id_mpp,idh){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/persiapan/load-header/`+id_mpp,
    dataType: "json",
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: { IdMPP: IdMPP },
    cache: false,
    success: function (response) {
      
      if (isEmpty(response)) {
        console.log("Gagal load, data kosong");
        return false;

      } else if (response) {
        JmlDataA = response.length;
        for (a = 0; a < JmlDataA; a++) {
          if (response[a]['id'] === idh){
            $('#HPersiapanKirimkeMM').val(response[a]['kirim_list']);
            $('#HListJawaban').val(response[a]['jawaban_list']);
            $('#HProsesIHB').val(response[a]['proses_buat']);
            $("#HOfficialPORelease").val(response[a]['official_po_release']);
            $("#HKirimFinal").val(response[a]['kirim_final_list']);
            $("#HPONumber").val(response[a]['po_number']);
            $('#HNote').val(response[a]['note']);
            $('#HIdHeader').val(idh);
            //SaveToHiddenInputCompare
            $('#HeaderCompare').val(CryptoJS.MD5(response[a]['kirim_list']+response[a]['jawaban_list']+response[a]['proses_buat']+response[a]['official_po_release']+response[a]['kirim_final_list']+response[a]['po_number']+response[a]['note']).toString());
          }
        }
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function LoadEditDetailPersiapan(a,indextable,idheader){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/persiapan/load-detail-item/`+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      $("#PersiapanWOS").dropdown("clear");
      $("#PersiapanWOS").dropdown("set selected",obj.WOS);
      $('#PersiapanTracNum').val(obj.TrackingNumber);
      $('#PersiapanRemark').val(obj.BuatRemarkUntukKirimMaterial);
      $('#PersiapanPMT').val(obj.BuatPMTUntukKirimMaterial);
      $('#PersiapanReadyKirim').val(obj.MaterialReadyKirim);
      $('#PersiapanCikarang').val(obj.MaterialBerangkatKeHitCikarang);
      $('#PersiapanFormExport').val(obj.KirimFormExportKeHitJkt);
      $('#PersiapanMsdsJkt').val(obj.KirimRemarkMsdsKeHitJkt);
      $('#PersiapanLoCJkt').val(obj.KirimLetterOfConfirmationKeHitJkt);
      $('#PersiapanETD').val(obj.ETDMaterialIndPort);
      $('#PersiapanETA').val(obj.ETAMaterialDestPort);
      $('#PersiapanMM').val(obj.MaterialDiterimaMoldMaker);
      $('#PersiapanNoReservasi').val(obj.NomorReservasiMaterial);
      $('#PersiapanKirimSebagian').val(obj.KirimSebagianMaterial);
      $('#PersiapanSebagianDiterima').val(obj.SebagianMaterialDiterimaMoldMaker);
      $('#PersiapanNote').val(obj.Note);
      $('#PersiapanIdItem').val(a);
      $('#PersiapanIndexTable').val(indextable);
      $('#PersiapanIdHeader').val(idheader);
      $('#AddEditCompare').val(CryptoJS.MD5(obj.WOS+obj.TrackingNumber+obj.BuatRemarkUntukKirimMaterial+obj.BuatPMTUntukKirimMaterial+obj.MaterialReadyKirim+obj.MaterialBerangkatKeHitCikarang+obj.KirimFormExportKeHitJkt+obj.KirimRemarkMsdsKeHitJkt+obj.KirimLetterOfConfirmationKeHitJkt+obj.ETDMaterialIndPort+obj.ETAMaterialDestPort+obj.MaterialDiterimaMoldMaker+obj.NomorReservasiMaterial+obj.KirimSebagianMaterial+obj.SebagianMaterialDiterimaMoldMaker+obj.Note).toString());
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


$("#SaveDataPersiapan").on("click", function (e) {
  var IdItem            = $("#PersiapanIdItem").val();
  var WOS               = $("#PersiapanWOS").val();
  var TrackingNumber    = $("#PersiapanTracNum").val();
  var BuatRemarkUntukKirimMaterial  = $("#PersiapanRemark").val();
  var BuatPMTUntukKirimMaterial     = $("#PersiapanPMT").val();
  var MaterialReadyKirim            = $("#PersiapanReadyKirim").val();
  var MaterialBerangkatKeHitCikarang= $("#PersiapanCikarang").val();
  var KirimFormExportKeHitJkt       = $("#PersiapanFormExport").val();
  var KirimRemarkMsdsKeHitJkt       = $("#PersiapanMsdsJkt").val();
  var KirimLetterOfConfirmationKeHitJkt = $("#PersiapanLoCJkt").val();
  var ETDMaterialIndPort            = $("#PersiapanETD").val();
  var ETAMaterialDestPort           = $("#PersiapanETA").val();
  var MaterialDiterimaMoldMaker     = $("#PersiapanMM").val();
  var NomorReservasiMaterial        = $("#PersiapanNoReservasi").val();
  var KirimSebagianMaterial         = $("#PersiapanKirimSebagian").val();
  var SebagianMaterialDiterimaMoldMaker = $("#PersiapanSebagianDiterima").val();
  var Note              = $("#PersiapanNote").val();
  var IndexTable        = $("#PersiapanIndexTable").val();
  var Idheader          = $("#PersiapanIdHeader").val();
  var AddEditCompare    = $('#AddEditCompare').val();
  

  if(IdItem){
    var saverestdetail = "edit-detail-item/"+IdItem;
    //LoadUlang-CekValueDataItemPersiapanTerbaru
    $.ajax({
      type: "POST",
      url     : `../RND_BackEnd/backend_mpp/persiapan/load-detail-item/`+IdItem,
      headers: {
        user  : VUserName,
        token : VToken
      },
      cache: false,
      success: function (data){
        var obj = JSON.parse(data);
        var LoadNewItem = CryptoJS.MD5(obj.WOS+obj.TrackingNumber+obj.BuatRemarkUntukKirimMaterial+obj.BuatPMTUntukKirimMaterial+obj.MaterialReadyKirim+obj.MaterialBerangkatKeHitCikarang+obj.KirimFormExportKeHitJkt+obj.KirimRemarkMsdsKeHitJkt+obj.KirimLetterOfConfirmationKeHitJkt+obj.ETDMaterialIndPort+obj.ETAMaterialDestPort+obj.MaterialDiterimaMoldMaker+obj.NomorReservasiMaterial+obj.KirimSebagianMaterial+obj.SebagianMaterialDiterimaMoldMaker+obj.Note).toString();

        // if (AddEditCompare !== LoadNewItem){

        //   IsResponseFalse('Gagal Simpan, karena data yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing di field yang dimaksud');

        // } else {

          // SaveDataItem_EditDataPersiapan
          if(Idheader === 'null'){
            var Idheader_x = '';
          } else {
            var Idheader_x = Idheader;
          }
        
          $.ajax({
            type    : "POST",
            url     : `../RND_BackEnd/backend_mpp/persiapan/`+saverestdetail,
            headers : {
              user  : VUserName,
              token : VToken
            },
            data: {   
              IdMpp   : IdMPP,
              WOS     : WOS,
              TrackingNumber                : TrackingNumber,
              BuatRemarkUntukKirimMaterial  : BuatRemarkUntukKirimMaterial,
              BuatPMTUntukKirimMaterial     : BuatPMTUntukKirimMaterial,
              MaterialReadyKirim            : MaterialReadyKirim,
              MaterialBerangkatKeHitCikarang: MaterialBerangkatKeHitCikarang,
              KirimFormExportKeHitJkt       : KirimFormExportKeHitJkt,
              KirimRemarkMsdsKeHitJkt       : KirimRemarkMsdsKeHitJkt,
              KirimLetterOfConfirmationKeHitJkt : KirimLetterOfConfirmationKeHitJkt,
              ETDMaterialIndPort            : ETDMaterialIndPort,
              ETAMaterialDestPort           : ETAMaterialDestPort,
              MaterialDiterimaMoldMaker     : MaterialDiterimaMoldMaker,
              NomorReservasiMaterial        : NomorReservasiMaterial,
              KirimSebagianMaterial         : KirimSebagianMaterial,
              SebagianMaterialDiterimaMoldMaker : SebagianMaterialDiterimaMoldMaker,
              Note      : Note,
              IdHeader  : Idheader_x,
              Username  : VUserName
            },
            cache: false,
            success: function (response){
              var obj = JSON.parse(response);
              if(isEmpty(obj)) {
                IsResponseEmptyObj();
              } else if(obj) {
                if (obj.status == false){
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  $(".WindowAddNewPersiapan").modal("hide");
                  // TableListFunc(IndexTable,Idheader);
                  ReadAllItem();
                }
              } else {
                IsResponseErrorElse();
              }
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });

        // }

      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });

  } else {
    var saverestdetail = "create-detail-item";

    if(Idheader === 'null'){
      var Idheader_x = '';
    } else {
      var Idheader_x = Idheader;
    }

    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/persiapan/`+saverestdetail,
      headers : {
        user  : VUserName,
        token : VToken
      },
      data: {   
        IdMpp   : IdMPP,
        WOS     : WOS,
        TrackingNumber                : TrackingNumber,
        BuatRemarkUntukKirimMaterial  : BuatRemarkUntukKirimMaterial,
        BuatPMTUntukKirimMaterial     : BuatPMTUntukKirimMaterial,
        MaterialReadyKirim            : MaterialReadyKirim,
        MaterialBerangkatKeHitCikarang: MaterialBerangkatKeHitCikarang,
        KirimFormExportKeHitJkt       : KirimFormExportKeHitJkt,
        KirimRemarkMsdsKeHitJkt       : KirimRemarkMsdsKeHitJkt,
        KirimLetterOfConfirmationKeHitJkt : KirimLetterOfConfirmationKeHitJkt,
        ETDMaterialIndPort            : ETDMaterialIndPort,
        ETAMaterialDestPort           : ETAMaterialDestPort,
        MaterialDiterimaMoldMaker     : MaterialDiterimaMoldMaker,
        NomorReservasiMaterial        : NomorReservasiMaterial,
        KirimSebagianMaterial         : KirimSebagianMaterial,
        SebagianMaterialDiterimaMoldMaker : SebagianMaterialDiterimaMoldMaker,
        Note      : Note,
        IdHeader  : Idheader_x,
        Username  : VUserName
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            $(".WindowAddNewPersiapan").modal("hide");
            // TableListFunc(IndexTable,Idheader);
            ReadAllItem();
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });

  }
});


$("#SaveHeaderPersiapan").click(function(){

  var KirimListKebutuhanKeMoldMaker     = $("#HPersiapanKirimkeMM").val();
  var JawabanListKebutuhanDariMoldMaker = $("#HListJawaban").val();
  var ProsesBuatIHBPRPO                 = $("#HProsesIHB").val();
  var OfficialPoReleaseKeMoldMaker      = $("#HOfficialPORelease").val();
  var KirimFinalListKebutuhanKeDistributor = $("#HKirimFinal").val();
  var PONumber                          = $("#HPONumber").val();
  var Note                              = $("#HNote").val();
  var IdHeader                          = $("#HIdHeader").val();
  var SalesContract                     = $("#HpersiapanSalesContract").val();
  //ReadCompareData
  var HeaderCompare    = $('#HeaderCompare').val();

  if(IdHeader){
    
    //LoadUlang-CekValueHeaderterbaru
    $.ajax({
      type: "POST",
      url     : `../RND_BackEnd/backend_mpp/persiapan/load-header/`+IdMPP,
      dataType: "json",
      headers: {
        user  : VUserName,
        token : VToken
      },
      data: { IdMPP: IdMPP },
      cache: false,
      success: function (response) {
        
        if (isEmpty(response)) {
          console.log("Gagal load, data kosong");
          return false;

        } else if (response) {
          JmlDataB = response.length;
          for (b = 0; b < JmlDataB; b++) {
            if (response[b]['id'] === IdHeader){
              
              var LoadNewHeader = CryptoJS.MD5(response[b]['kirim_list']+response[b]['jawaban_list']+response[b]['proses_buat']+response[b]['official_po_release']+response[b]['kirim_final_list']+response[b]['po_number']+response[b]['note']).toString();
             
              // if ( HeaderCompare !== LoadNewHeader){

              //   IsResponseFalse('Gagal Simpan, karena data yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing di field yang dimaksud');

              // } else {
                //SaveEditHeader
                $.ajax({
                  type    : "POST",
                  url     : `../RND_BackEnd/backend_mpp/persiapan/edit-header/`+IdHeader,
                  headers : {
                    user  : VUserName,
                    token : VToken
                  },
                  data: {   
                    KirimListKebutuhanKeMoldMaker       : KirimListKebutuhanKeMoldMaker,
                    JawabanListKebutuhanDariMoldMaker   : JawabanListKebutuhanDariMoldMaker,
                    ProsesBuatIHBPRPO                   : ProsesBuatIHBPRPO,
                    OfficialPoReleaseKeMoldMaker        : OfficialPoReleaseKeMoldMaker,
                    KirimFinalListKebutuhanKeDistributor: KirimFinalListKebutuhanKeDistributor,
                    PONumber                            : PONumber,
                    Note                                : Note,
                    Username                            : VUserName,
                    IdMPP                               : IdMPP,
                    SalesContract                       : SalesContract
                  },
                  cache: false,
                  success: function (response){
                    var obj = JSON.parse(response);
                    if(isEmpty(obj)) {
                      IsResponseEmptyObj();
                    } else if(obj) {
                      if (obj.status == false){
                        IsResponseFalse(obj.message);
                      } else {
                        IsResponseTrue(obj.message);
                        $(".WindowEditHeaderPersiapan").modal("hide");
                        ReadAllItem();
                      }
                    } else {
                      IsResponseErrorElse();
                    }
                  },
                  error: function () {
                    IsTimeOut(LogoutProtect);
                  },
                });
              // } 
            }
          }
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });

  } else {
    //SaveCreateHeaderPersiapan
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/persiapan/create-header`,
      headers : {
        user  : VUserName,
        token : VToken
      },
      data: {   
        KirimListKebutuhanKeMoldMaker       : KirimListKebutuhanKeMoldMaker,
        JawabanListKebutuhanDariMoldMaker   : JawabanListKebutuhanDariMoldMaker,
        ProsesBuatIHBPRPO                   : ProsesBuatIHBPRPO,
        OfficialPoReleaseKeMoldMaker        : OfficialPoReleaseKeMoldMaker,
        KirimFinalListKebutuhanKeDistributor: KirimFinalListKebutuhanKeDistributor,
        PONumber                            : PONumber,
        Note                                : Note,
        Username                            : VUserName,
        IdMPP                               : IdMPP,
        SalesContract                       : SalesContract
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse('Gagal Simpan, karena data yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing di field yang dimaksud');
          } else {
            IsResponseTrue(obj.message);
            $(".WindowEditHeaderPersiapan").modal("hide");
            ReadAllItem();
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  }
  
});



$(document).ready(function () {

  ReadAllItem();

  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide: true,
    weekStart: 1
  });

  $(".CloseModal").on("click", function (e) {
    $(".WindowEditHeaderPersiapan").modal("hide");
    $(".WindowAddNewPersiapan").modal("hide");
  });
 
});