const LogoutProtect = false;

var GetCookieNego = decodeURIComponent(getCookie("CooNego"));
var GetCookieOpr  = decodeURIComponent(getCookie("CooOpr"));
var restlocpscxls = decodeURIComponent(getCookie("restlocpscxls"));

function ReadAllItem() {

  // if(DUser === GetCookieNego || DUser === GetCookieOpr ){
  //   var linkkurs = "editkurs";
  //   var trItemKebutuhan = "trItemKebutuhan";
  //   var featuresmanagepallet = true;
  // } else {
    var linkkurs = "";
    var trItemKebutuhan = "";
    var featuresmanagepallet = true;
  // }

  $.ajax({
    type: "POST",
      url     : '../RND_BackEnd/backend_mpp/kebutuhan/final-material/load/'+IdMPP,
    dataType: "json",
    headers : {
      user  : VUserName,
      token : VToken,
    },
    data: { IdMPP: IdMPP },
    cache: false,
    success: function (response) {
      
      if (isEmpty(response)) {
        console.log("Gagal load, data kosong");
        return false;

      } else if (response) {

        JmlDataA = response.length;
        $("#TblSalesContract").empty();
        for (a = 0; a < JmlDataA; a++) {
          JmlDataB = response[a]['ItemMaterials'].length;
          
          $("#TblSalesContract").append(
            "<tr><td>"+   
              "<table class='ui orange small  very compact table'>"+
                "<tr class='trHeaderKebutuhan'>"+
                  "<td width='12%'>SALES CONTRACT</td>"+
                  "<td><b><span class='DownloadSalesContract' nosurat='"+response[a]['NoSalesContract']+"'>"+response[a]['NoSalesContract']+"</span></b></td>"+
                "</tr>"+
                "<tr class='trHeaderKebutuhan'>"+
                  "<td>MOLD MAKER</td>"+
                  "<td>"+response[a]['MoldMaker']+"</td>"+
                "</tr>"+
                "<tr class='trHeaderKebutuhan'>"+
                  "<td>KURS 1 USD</td>"+
                  "<td> <div class='ui grey label'>"+IsNullStrip($.number( response[a]['Kurs'], 0, '.', ',' ))+" IDR</div></td>"+
                "</tr>"+
                "<tr class='trHeaderKebutuhan'>"+
                  "<td>CURRENCY SC</td>"+
                  "<td>"+IsNullStrip(response[a]['CurrencySC'])+"</td>"+
                "</tr>"+
                
              "</table>"+
            "<div class=''>"+
              "<table id='TableList"+a+"' class='ui selectable striped small very compact table tablelist' >"+
                "<thead>"+
                  "<tr>"+
                    "<th width='10px'>&nbsp;</th>"+
                    "<th width='10px'>No</th>"+
                    "<th width='130px'>Material Number</th>"+
                    "<th width='250px'>Description</th>"+
                    "<th width='150px'>Part Number (P/N)</th>"+
                    "<th width='80px'>Material Type</th>"+
                    "<th width='80px' class='right aligned'>Qty Material (kg)</th>"+
                    "<th width='80px' class='right aligned'>Qty Send (kg)</th>"+
                    "<th width='80px' class='right aligned'>Qty Send Confirm (kg)</th>"+
                    "<th width='180px' class='right aligned'>Last Update Price</th>"+
                    "<th width='30px' class='center aligned'>Currency</th>"+
                    "<th width='30px' class='right aligned'>Unit Price /kg</th>"+
                    "<th width='80px' class='right aligned'>Total Amount<br><b>("+IsNullStrip(response[a]['CurrencySC'])+")</b></th>"+
                    "<th width='30px'>FOC</th>"+
                    "<th width='30px'>Credit Note</th>"+
                    "<th width='30px' class='center aligned'>DHL<br><br>(Expedisi)</th>"+
                    "<th width='30px' class='center aligned'>AIR<br><br>(Cikarang)</th>"+
                    "<th width='30px' class='center aligned'>SEA</th>"+
                    "<th width='30px'>&nbsp;</th>"+
                  "</tr>"+
                "</thead>");

                for (b = 0; b < JmlDataB; b++) {
                  resp = response[a]['ItemMaterials'][b];
                  if(resp['CreditNote'] ==='FOC'){
                    var CrNote = resp['CreditNote'];
                  } else {
                    var CrNote = $.number(resp['CreditNote'],2);
                  }
                  $("#TableList"+a).append(
                    "<tr class='"+trItemKebutuhan+"' scon='"+response[a]['NoSalesContract']+"' matn='"+resp['MaterialNum']+"' desc='"+resp['Description']+"' mtyp='"+resp['MaterialType']+"' qtys='"+resp['QtySend']+"' qtyc='"+resp['QtySendConfirm']+"' dhl='"+resp['DHL']+"' air='"+resp['AIR']+"' sea='"+resp['SEA']+"'>"+
                    "<td width='10px'>&nbsp;</td>"+
                    "<td width='10px' >"+resp['No']+"</td>"+
                    "<td width='80px' >"+resp['MaterialNum']+"</td>"+
                    "<td width='250px'>"+resp['Description']+"</td>"+
                    "<td width='250px'>"+resp['P/N']+"</td>"+
                    "<td width='80px' >"+resp['MaterialType']+"</td>"+
                    "<td width='80px' class='right aligned'>"+IsNullStrip(parseFloat(resp['TotalQtyMat']).toFixed(2))+"</td>"+
                    "<td width='80px' class='right aligned'>"+IsNullStrip($.number(resp['QtySend'],2))+"</td>"+
                    "<td width='80px' class='right aligned'>"+IsNullStrip($.number(resp['QtySendConfirm'],2))+"</td>"+
                    "<td width='180px'class='right aligned'>"+IsNullStrip(moment(resp['LastUpdatePrice']).format('ddd, DD MMM YYYY'))+"</td>"+
                    "<td width='30px' class='center aligned'>"+IsNullStrip(resp['Currency'])+"</td>"+
                    "<td width='30px' class='right aligned'>"+IsNullStrip($.number(resp['UnitPrice'],2))+"</td>"+
                    "<td width='80px' class='right aligned'>"+IsNullStrip($.number(resp['TotalAmount'],2))+"</td>"+
                    "<td width='30px' >"+IsNullStrip(resp['FOC'])+"</td>"+
                    "<td width='30px' >"+IsNullStrip(CrNote)+"</td>"+
                    "<td width='30px' class='right aligned'>"+IsNullStrip($.number(resp['DHL']))+"</td>"+
                    "<td width='30px' class='right aligned'>"+IsNullStrip($.number(resp['AIR']))+"</td>"+
                    "<td width='30px' class='right aligned'>"+IsNullStrip($.number(resp['SEA']))+"</td>"+
                    "<td width='30px' class='center aligned'></td>"+
                    "</tr>"
                  );
                }
                if (featuresmanagepallet){
                  $("#TableList"+a).append(
                    "<tr >"+
                      "<td colspan='8' style='text-align: left;'>"+
                      "<div class='ui small compact green labeled icon right aligned button DownloadBtn' nosc='"+response[a]['NoSalesContract']+"' resp='"+JSON.stringify(response[a])+"' data-tooltip='Unduh data Final Material' data-position='top left' data-inverted=''><i class='down arrow icon'></i>Download Tabel Final Material</div>"+
                      

                      "<div class='ui small compact green labeled icon right aligned button DownloadLabelBtn' nosc='"+response[a]['NoSalesContract']+"' resp='"+JSON.stringify(response[a])+"' data-tooltip='Unduh Label Final Material' data-position='right center' data-inverted=''><i class='down arrow icon'></i>Download Label</div>"+
                      "</td>"+

                      "<td colspan='11' style='text-align: right;'></td>"+
                    "</tr>"
                  );
                }

            $("#TblSalesContract").append(
              "</table>"+
            "</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "<div class='ui hidden divider'>&nbsp;</div>"+
            "</td></tr>"
            );
        }

        DownloadSalesContract();

       
        // Download Tabel Final Material
        $('.DownloadBtn').on('click', function () {
          var Resp = $(this).attr('resp')
          $.redirect(
            "./?link=downloadmppfinalmat",
            {
              resp: Resp,
            },
            "POST",
            "_blank"
          )
        })

        // Download Label Final Material
        $('.DownloadLabelBtn').on('click', function() {
          var Resp = $(this).attr('resp');
          var NoSc = $(this).attr('nosc');
          $.ajax({
            type    : "POST",
            url     : `${restlocpscxls}DownloadLabelFinalMaterial`,
            headers: {
              user  : VUserName,
              token : VToken
            },
            data: {
              nosc: NoSc,
              resp: Resp,
            },
            cache: false,
            success: function (response){
              window.location.href = "../RND_Upload/MPP/MppLabelFinalMaterial_.xlsx";
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });
        });
       
       

        $.ajax({
          type: "POST",
          url: `../RND_BackEnd/backend_mpp/sign/load/`+IdMPP,
          headers: {
            user: VUserName,
            token: VToken
          },
          cache: false,
          success: function (data) {
            var obj = JSON.parse(data);
      
            if(obj.DateSignNego !==null && obj.SignByNego !== null ){

              $('.trItemKebutuhan').on('click', function(event) {
                if (!event.ctrlKey) {
                  var matn = $(this).attr('matn');
                  var desc = $(this).attr('desc');
                  var scon = $(this).attr('scon');
                  var mtyp = $(this).attr('mtyp');
                  LoadFinalMaterialItem(scon,matn,desc,mtyp)
                }
              });
      
              $('.editkurs').on('click', function() {
                var kurs = $(this).attr('kurs');
                var sc   = $(this).attr('sc');
                $(".WindowEditKurs").modal({ autofocus: false, closable : false, }).modal("show");
                $('#KursPerSalesContract').val(IsNull(kurs));
                $('#NoSalesContract').val(IsNull(sc));
                $('#KursCompare').val(kurs);
                $('input.number').number( true, 0 );
              });

              LoadPalleting();
              UpdatePrice();
              UpdateAllPrice();

            } else {

              $('.trItemKebutuhan, .editkurs, .PalletingBtn').on('click', function() {
                IsResponseFalse('Negosiator belum sign-confirm, silakan sign dulu!');
              });

            }
      
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });

      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


function LoadFinalMaterialItem(sc,mn,de,mt){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/kebutuhan/final-material/load-item`,
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: { 
      SalesContract: sc,
      MaterialNumber: mn,
      Description: de,
      MaterialType: mt 
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      $(".WindowEditFinalMaterial").modal({ autofocus: false, closable : false, }).modal("show");
      $('#EditFinalMatn').text(IsNull(obj.MaterialNumber));
      $('#EditFinalDesc').text(IsNull(obj.Description));
      $('#EditFinalMtyp').text(IsNull(mt));
      $('#EditFinalQtyS').val(IsNull(obj.QtySend));
      $('#EditFinalQtyC').val(IsNull(obj.QtySendConfirm));
      $('#EditFinalDhl').val(IsNull(obj.DHL));
      $('#EditFinalAir').val(IsNull(obj.AIR));
      $('#EditFinalSea').val(IsNull(obj.SEA));
      $('#EditFinalSalesContract').val(IsNull(obj.SalesContract));
      $('#EditFinalTotalQtyMat').val(IsNull(obj.TotalQtyMat));
      $('#EditFinalFOC').dropdown('clear');
      $('#EditFinalFOC').dropdown('set selected',obj.FOC);
      $('input.number2').number( true, 2 );
      $('input.number').number( true, 0 );
      $('#ItemCompare').val(CryptoJS.MD5(obj.QtySend+obj.QtySendConfirm+obj.FOC+obj.DHL+obj.AIR+obj.SEA).toString());

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function DownloadSalesContract(){
  $(".DownloadSalesContract").on("click", function () {
    var nosurat= $(this).attr('nosurat');
    $.redirect(
      "./?link=downloadsc",
      { 
        nosurat: nosurat,
      },
      "POST",
      "_blank"
    );
  });
}



function LoadPalleting(){
  $(".PalletingBtn").on("click", function (e) {
    var nosc = $(this).attr('nosc');
    $('#NoSelesContractA').val(nosc);
    $(".WindowEditPallet").modal({ autofocus: false, closable : false, }).modal("show");
    LoadDetailPalleting(nosc);

    

  });
}


function UpdatePrice(){
  $(".BtnUpdateItemPrice").on("click", function (event) {
    if (event.ctrlKey) {
      var matn = $(this).attr('matn');
      var desc = $(this).attr('desc');
      var scon = $(this).attr('scon');
      var mtyp = $(this).attr('mtyp');

    Swal.fire({
      title: "<h3>Perbarui harga material ini ke harga terbaru?</h3>",
      html : "<b>"+matn+"</b><br>"+desc,
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type    : "POST",
          url     : `../RND_BackEnd/backend_mpp/kebutuhan/final-material/update-unit-price`,
          headers : {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id_mpp : IdMPP,
            material_num : matn,
            description : desc,
            sales_contract : scon,
            material_type : mtyp,
            username : VUserName,
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                ReadAllItem();
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });



    }
    
  });
}



function UpdateAllPrice(){
  $(".UpdateAllPrice").on("click", function (event) {
    if (event.ctrlKey) {
      var scon = $(this).attr('scon');
      Swal.fire({
        title: "<h3>Perbarui semua harga material di Sales Contract ini ke harga terbaru?</h3>",
        html : "<b>"+scon+"</b>",
        confirmButtonText: "Ya",
        showCancelButton: true,
      }).then((result) => {
        if (result.value) {
          $.ajax({
            type    : "POST",
            url     : `../RND_BackEnd/backend_mpp/updateallharga`,
            headers : {
              user  : VUserName,
              token : VToken
            },
            data: {   
              SalesContract : scon,
              Username : VUserName,
            },
            cache: false,
            success: function (response) {
              var obj = JSON.parse(response);
              if(isEmpty(obj)) {
                IsResponseEmptyObj();
              } else if(obj) {
                if (obj.status == false){
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  ReadAllItem();
                }
              } else {
                IsResponseErrorElse();
              }
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });
        }
      });

    }
    
  });
}


$("#ReloadData").on("click", function (e) {
  var nsc = $('#NoSelesContractA').val();
  LoadDetailPalleting(nsc);
});


$("#DelEmptyData").on("click", function (e) {
  var nsc = $('#NoSelesContractA').val();
  DeleteEmptyPallet(nsc);
});





function LoadDetailPalleting(noscdetail){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/kebutuhan/final-material/load/'+IdMPP,
    dataType: "json",
    headers : {
      user  : VUserName,
      token : VToken,
    },
    data: { IdMPP: IdMPP },
    cache: false,
    beforeSend: function(){
      Swal.fire({
        text: 'Re-counting and reload all data...',
        timer: 5000,
        showConfirmButton: false,
        allowOutsideClick: false
      });
    },
    success: function (response) {
      if (isEmpty(response)) {
        console.log("Gagal load, data kosong");
        return false;
      } else if (response) {

        JmlDataS = response.length;
        for (a = 0; a < JmlDataS; a++) {

          if (response[a]['NoSalesContract'] === noscdetail){
            JmlDataB = response[a]['ItemMaterials'].length;
            $("#TblPallet").empty();
            
            //cetak header tabel
            $("#TblPallet").append(
              "<tr>");
            $("#TblPallet").append(
              "<th width='200px' class='collapsing left aligned' style='background-color: #ebebff;'>Material Number</th>"+ 
              "<th width='400px' class='collapsing left aligned' style='background-color: #ebebff;'>Material Description</th>"+
              "<th width='100px' class='collapsing left aligned' style='background-color: #ebebff;'>Sisa AIR</th>"+ 
              "<th width='100px' class='collapsing left aligned' style='background-color: #ebebff;'>Sisa SEA</th>");

            for (var j = 1; j < 31; ++j) {
            $("#TblPallet").append(
              "<th class='collapsing right aligned' style='background-color: #ebebff;'>Pallet "+j+"</th>");
            } 
            $("#TblPallet").append(
                "<th width='100px' class='collapsing right aligned'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>"+ 
              "</tr>");

            var QtyActAir = [];
            var QtyActSea = [];
            for (b = 0; b < JmlDataB; b++) {
              var MatNumm = response[a]['ItemMaterials'][b]['MaterialNum'];
              var Descc = response[a]['ItemMaterials'][b]['Description'];
              var NoSaless = response[a]['NoSalesContract'];
              var QAir = response[a]['ItemMaterials'][b]['AIR'];
              var QSea = response[a]['ItemMaterials'][b]['SEA'];
              QtyActAir[b] = response[a]['ItemMaterials'][b]['AIR'];
              QtyActSea[b] = response[a]['ItemMaterials'][b]['SEA'];
              

              if (b%2 == 0){
                var bgcol ="#ffffff;";
              } else {
                var bgcol ="#f3f3ff;";
              }

              $.ajax({
                type: "POST",
                url     : '../RND_BackEnd/backend_mpp/kebutuhan/final-material/load-pallet',
                async   : false,
                dataType: "json",
                headers : {
                  user  : VUserName,
                  token : VToken,
                },
                data: { 
                  SalesContract: NoSaless,
                  MaterialNumber: MatNumm,
                  Description: Descc,
                },
                cache: false,
                success: function (responseC) {
                  if (isEmpty(responseC)) {
                    console.log("Gagal load, data kosong");
                    return false;
                  } else if (responseC) {
                    // console.log('b:'+b);
                    if (responseC.status == false){
                      if(b === 0){
                        $("#TblPallet").append(
                          "<tr>");
                        $("#TblPallet").append(
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>");
                        for (var f = 1; f < 31; ++f) {
                          $("#TblPallet").append(
                          "<td class='collapsing right aligned' style='background-color: #ebebff;>"+
                            "<div class='ui left input small '>"+
                              "<select class='ui dropdown SelPallet' id='SelPallet"+f+"' >"+
                              "<option value='-'>-</option>"+
                              "<option value='AIR' data-valu='AIR' data-scon='"+NoSaless+"' data-palnum='"+f+"'>AIR</option>"+
                              "<option value='SEA' data-valu='SEA' data-scon='"+NoSaless+"' data-palnum='"+f+"'>SEA</option>"+
                              "</select>"+
                            "</div>"+
                          "</td>");
                        }
                      }
                      $("#TblPallet").append(
                        "<tr>");
                        $("#TblPallet").append(
                          "<td class='collapsing left aligned' style='background-color: "+bgcol+"'>"+MatNumm+"</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: "+bgcol+"'>"+Descc+"</td>"+
                          "<td class='collapsing right aligned' style='background-color: "+bgcol+"'><span id='SisaAirr"+b+"'></span></td>"+
                          "<td class='collapsing right aligned' style='background-color: "+bgcol+"'><span id='SisaSeaa"+b+"'></span></td>");
                          for (var g = 1; g < 31; ++g) { 
                            $("#TblPallet").append(
                              "<td class='collapsing right aligned' style='background-color: "+bgcol+"'><input type='text' class='number inputqtypallet inpal"+g+"'  idp='"+g+"'  matp='"+MatNumm+"' desp='"+Descc+"' value=''></td>");
                          }
                        $("#TblPallet").append(
                        "</tr>"
                      );
                      $('input.number').number( true, 0, ',', '' );

                    } else {
                      if(b === 0){
                        $("#TblPallet").append(
                          "<tr>");
                        $("#TblPallet").append(
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: #ebebff;'>&nbsp;</td>");
                        for (var f = 1; f < 31; ++f) {
                          $("#TblPallet").append(
                          "<td class='collapsing right aligned' style='background-color: #ebebff;'>"+
                            "<div class='ui left input small '>"+
                              "<select class='ui dropdown SelPallet' id='SelPallet"+f+"' >"+
                              "<option value='-'>-</option>"+
                              "<option value='AIR' data-valu='AIR' data-scon='"+NoSaless+"' data-palnum='"+f+"'>AIR</option>"+
                              "<option value='SEA' data-valu='SEA' data-scon='"+NoSaless+"' data-palnum='"+f+"'>SEA</option>"+
                              "</select>"+
                            "</div>"+
                          "</td>");
                        }
                      }

                        // $('#SelPallet').dropdown('clear');
                        for (var e = 1; e < 31; ++e) {
                          // console.log(responseC[e-1]['pallet_type']);
                          if(responseC[e-1]['pallet_type'] !== null){
                            $('#SelPallet'+e).dropdown('clear');
                            $('#SelPallet'+e).dropdown('set selected',responseC[e-1]['pallet_type']);
                          }
                        }
                      

                      $("#TblPallet").append(
                        "<tr style='background-color: #f2f2ff;'>");
                      $("#TblPallet").append(
                          "<td class='collapsing left aligned' style='background-color: "+bgcol+"'>"+MatNumm+"</td>"+ 
                          "<td class='collapsing left aligned' style='background-color: "+bgcol+"'>"+Descc+"</td>"+
                          "<td class='collapsing right aligned' style='background-color: "+bgcol+"'><span id='SisaAirr"+b+"'></span></td>"+
                          "<td class='collapsing right aligned' style='background-color: "+bgcol+"'><span id='SisaSeaa"+b+"'></span></td>");

                      for (var h = 1; h < 31; ++h) {
                        if(responseC[h-1]['pallet_type']==="AIR"){
                          var typepall = 'inrowair'+b;
                        } else if(responseC[h-1]['pallet_type']==="SEA"){
                          var typepall = 'inrowsea'+b;
                        } else{
                          var typepall = '';
                        }
                        $("#TblPallet").append(
                          "<td class='collapsing right aligned' style='background-color: "+bgcol+"'><input type='text' class='number inputqtypallet "+typepall+" inpal"+h+"' idp='"+h+"'  matp='"+MatNumm+"' desp='"+Descc+"' value='"+IsNotNullZero(responseC[h-1]['pallet_qty'])+"'></td>");
                      }
                      $("#TblPallet").append(
                        "</tr>"
                      );
                      $('input.number').number( true, 0, ',', '' );

                    }
                  }
                }
              });
            }

            $("#TblPallet").append(
              "<tr>");
            $("#TblPallet").append(
              "<th width='200px' class='collapsing left aligned'></th>"+ 
              "<th width='400px' class='collapsing right aligned'></th>"+
              "<th width='100px' class='collapsing right aligned'></th>"+ 
              "<th width='100px' class='collapsing right aligned'>Total Qty</th>"); 
            for (var d = 1; d < 31; ++d) {
              $("#TblPallet").append(
                "<th class='collapsing right aligned'><span id=qpal"+d+"></span></th>");  
            }
            $("#TblPallet").append(
            "</tr>");

            var qtypal = [];
            for (var q = 0; q < 31; ++q) {
              qtypal[q] = 0;
            }

            for (var w = 0; w < 31; ++w) {
              $('.inpal'+w).each(function(){ qtypal[w] += parseInt(IsNullZero(this.value)); });
              $('#qpal'+w).text(IsNotNullZero(qtypal[w]));              
            }

            var qtyrowair = [];
            var qtyrowsea = [];
            for (k = 0; k < JmlDataB; k++) {
              qtyrowair[k] = 0;
              qtyrowsea[k] = 0;
            }

            for (m = 0; m < JmlDataB; m++) {
              $('.inrowair'+m).each(function(){ qtyrowair[m] += parseInt(IsNullZero(this.value)); });
              $('.inrowsea'+m).each(function(){ qtyrowsea[m] += parseInt(IsNullZero(this.value)); });
              var SisaAir = IsNullZero(QtyActAir[m])-qtyrowair[m];
              var SisaSea = IsNullZero(QtyActSea[m])-qtyrowsea[m];
              // console.log('sisa air: '+SisaAir);
              // console.log('sisa sea: '+SisaSea);
              $('#SisaAirr'+m).text(IsNotNullZero(SisaAir));   
              $('#SisaSeaa'+m).text(IsNotNullZero(SisaSea));   
              // console.log('air: '+qtyrowair[m]+' - Act:'+IsNullZero(QtyActAir[m]));
              // console.log('sea: '+qtyrowsea[m]+' - Act:'+IsNullZero(QtyActSea[m]));
            }
            $(".SelPallet").on('change',function(e){
              var Valu = $('option:selected', this).data("valu");
              var Snum = $('option:selected', this).data("palnum");
              var SCon = $('option:selected', this).data("scon");

              $.ajax({
                type: "POST",
                url: `../RND_BackEnd/backend_mpp/kebutuhan/final-material/edit-pallet/type`,
                headers: {
                  user: VUserName,
                  token: VToken
                },
                cache: false,
                data: {
                  IdMPP: IdMPP,
                  SalesContract: SCon,
                  PalletNo: Snum,
                  PalletType: Valu,
                  Username: VUserName
                },
                success: function (data) {
                  // var obj = JSON.parse(data);
                  if(isEmpty(data)) {
                    IsResponseEmptyObj();
                  } else if(data) {
                    if (data == 'true'){
                      Swal.fire({
                        text: 'data updated!',
                        timer: 1000,
                        showConfirmButton: false,
                        toast: true,
                        position: 'bottom',
                      });
                      LoadDetailPalleting(SCon);
                      
                    }
                  } else {
                    IsResponseErrorElse();
                  }
            
                },
                error: function () {
                  IsTimeOut(LogoutProtect);
                },
              });
            



            });

            $(".inputqtypallet").on('change',function(e){
              var qtyp = $(this).val();
              var idp = $(this).attr('idp');
              var typep = $('#SelPallet'+idp).val();
              var matp = $(this).attr('matp');
              var desp = $(this).attr('desp');
              
              if(typep ==='-' || typep ==='' || typep === null || typep === 'null' ){
                Swal.fire({
                  text: 'Tentukan dulu Jenis Expedisinya ( SEA/AIR )!',
                  timer: 2000,
                  showConfirmButton: false,
                  toast: true
                });
              } else {
                if( qtyp < 0){
                  Swal.fire({
                    text: 'Pengisian qty tidak boleh minus!',
                    timer: 2000,
                    showConfirmButton: false,
                    toast: true
                  });
                } else {

                  var qtypal = [];
                  for (var q = 0; q < 31; ++q) {
                    qtypal[q] = 0;
                  }

                  for (var w = 0; w < 31; ++w) {
                    $('.inpal'+w).each(function(){ qtypal[w] += parseInt(IsNullZero(this.value)); });
                    $('#qpal'+w).text(IsNotNullZero(qtypal[w]));              
                  }

                  var qtyrowair = [];
                  var qtyrowsea = [];
                  for (k = 0; k < JmlDataB; k++) {
                    qtyrowair[k] = 0;
                    qtyrowsea[k] = 0;
                  }

                  for (m = 0; m < JmlDataB; m++) {
                    $('.inrowair'+m).each(function(){ qtyrowair[m] += parseInt(IsNullZero(this.value)); });
                    $('.inrowsea'+m).each(function(){ qtyrowsea[m] += parseInt(IsNullZero(this.value)); });
                    var SisaAir = IsNullZero(QtyActAir[m])-qtyrowair[m];
                    var SisaSea = IsNullZero(QtyActSea[m])-qtyrowsea[m];
                    // console.log('sisa air: '+SisaAir);
                    // console.log('sisa sea: '+SisaSea);
                    $('#SisaAirr'+m).text(IsNotNullZero(SisaAir));   
                    $('#SisaSeaa'+m).text(IsNotNullZero(SisaSea)); 
                  }
                
                  $.ajax({
                    type: "POST",
                    url: `../RND_BackEnd/backend_mpp/kebutuhan/final-material/edit-pallet`,
                    headers: {
                      user: VUserName,
                      token: VToken
                    },
                    cache: false,
                    data: {
                      IdMPP: IdMPP,
                      SalesContract: NoSaless,
                      MaterialNumber: matp,
                      Description: desp,
                      PalletNo: idp,
                      PalletType: typep,
                      PalletQty: qtyp,
                      Username: VUserName
                    },
                    success: function (data) {
                      var obj = JSON.parse(data);
                      if(isEmpty(obj)) {
                        IsResponseEmptyObj();
                      } else if(obj) {
                        if (obj.status == false){
                          IsResponseFalse(obj.message);
                        } else {
                          Swal.fire({
                            text: 'data updated!',
                            timer: 1000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'bottom',
                          });
                          
                        }
                      } else {
                        IsResponseErrorElse();
                      }
                
                    },
                    error: function () {
                      IsTimeOut(LogoutProtect);
                    },
                  });
                }

              }
              
            })
          }
        }
      
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });

}

function DeleteEmptyPallet(noscdetail){
  Swal.fire({
    title: "<h3>Hapus Empty Pallet?</h3>",
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type: "POST",
        url     : '../RND_BackEnd/backend_mpp/kebutuhan/final-material/delete-pallet',
        headers: {
          user  : VUserName,
          token : VToken
        },
        data: { sales_contract: noscdetail },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(response);
          if(isEmpty(obj)) {
            IsResponseEmptyObj();
          } else if(obj) {
            if (obj.status == false){
              IsResponseFalse(obj.message);
            } else {
              IsResponseTrue(obj.message);
              LoadDetailPalleting(noscdetail);
            }
          } else {
            IsResponseErrorElse();
          }
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });
    }
  });
}



$(document).ready(function () {

  ReadAllItem();



  //Save Kurs Sales Contract
  $("#SaveKurs").on("click", function () {
    var Kurs = $("#KursPerSalesContract").val();
    var Sc   = $("#NoSalesContract").val();
    var KursComp = $("#KursCompare").val();

    //load data updated kurs 
    $.ajax({
      type: "POST",
        url     : '../RND_BackEnd/backend_mpp/kebutuhan/final-material/load/'+IdMPP,
      dataType: "json",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data: { IdMPP: IdMPP },
      cache: false,
      success: function (response) {
        
        if (isEmpty(response)) {
          console.log("Gagal load, data kosong");
          return false;
    
        } else if (response) {
          JmlDataA = response.length;
          for (a = 0; a < JmlDataA; a++) {
            if(response[a]['NoSalesContract'] === Sc){

              if(IsNull(KursComp) !== IsNull(response[a]['Kurs'])){
                IsResponseFalse('Gagal Simpan, karena Kurs yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing Kurs yang dimaksud.');

              } else {

                $.ajax({
                  type    : "POST",
                  url     : `../RND_BackEnd/backend_mpp/kebutuhan/final-material/edit-kurs` ,
                  headers : {
                    user  : VUserName,
                    token : VToken
                  },
                  data: {   
                    Kurs          : Kurs,
                    SalesContract : Sc,
                    IdMPP         : IdMPP,
                    Username      : VUserName
                  },
                  cache: false,
                  success: function (response){
                    var obj = JSON.parse(response);
                    if(isEmpty(obj)) {
                      IsResponseEmptyObj();
                    } else if(obj) {
                      if (obj.status == false){
                        IsResponseFalse(obj.message);
                      } else {
                        IsResponseTrue(obj.message);
                        $(".WindowEditKurs").modal("hide");
                        ReadAllItem();
                      }
                    } else {
                      IsResponseErrorElse();
                    }
                  },
                  error: function () {
                    IsTimeOut(LogoutProtect);
                  },
                });

              }
            }
          }
    
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });

  });
  


  $("#SaveFinalMaterial").on("click", function (e) {
    var SalesContract  = $("#EditFinalSalesContract").val();
    var MaterialNumber = $("#EditFinalMatn").text();
    var Description    = $("#EditFinalDesc").text();
    var MaterialType   = $("#EditFinalMtyp").text();
    var TotalQtyMat    = $("#EditFinalTotalQtyMat").val();
    var QtySend        = $("#EditFinalQtyS").val();
    var QtySendConfirm = $("#EditFinalQtyC").val();
    var FOC            = $("#EditFinalFOC").val();
    var DHL   = $("#EditFinalDhl").val();
    var AIR   = $("#EditFinalAir").val();
    var SEA   = $("#EditFinalSea").val();
    var SEA   = $("#EditFinalSea").val();
    var ItemCompare    = $('#ItemCompare').val();

    $.ajax({
      type: "POST",
      url     : `../RND_BackEnd/backend_mpp/kebutuhan/final-material/load-item`,
      headers: {
        user  : VUserName,
        token : VToken
      },
      data: { 
        SalesContract: SalesContract,
        MaterialNumber: MaterialNumber,
        Description: Description,
        MaterialType: MaterialType 
      },
      cache: false,
      success: function (data){
        var obj = JSON.parse(data);
        var LoadNewItem = CryptoJS.MD5(obj.QtySend+obj.QtySendConfirm+obj.FOC+obj.DHL+obj.AIR+obj.SEA).toString();
        if(LoadNewItem !== ItemCompare){
          
          IsResponseFalse('Gagal Simpan, karena data yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing di field yang dimaksud');

        } else {

          $.ajax({
            type    : "POST",
            url     : `../RND_BackEnd/backend_mpp/kebutuhan/final-material/edit-item`,
            headers : {
              user  : VUserName,
              token : VToken
            },
            data: {   
              IdMPP         : IdMPP,
              SalesContract : SalesContract,
              MaterialNumber: MaterialNumber,
              Description   : Description,
              MaterialType  : MaterialType,
              TotalQtyMat   : TotalQtyMat,
              QtySend       : QtySend,
              QtySendConfirm: QtySendConfirm,
              FOC : FOC,
              DHL : DHL,
              AIR : AIR,
              SEA : SEA,
              Username     : VUserName
            },
            cache: false,
            success: function (response){
              var obj = JSON.parse(response);
              if(isEmpty(obj)) {
                IsResponseEmptyObj();
              } else if(obj) {
                if (obj.status == false){
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  $(".WindowEditFinalMaterial").modal("hide");
                  ReadAllItem();
                }
              } else {
                IsResponseErrorElse();
              }
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });

        }
  
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });


    
  });






  $(".CloseModal").on("click", function (e) {
    $(".WindowEditFinalMaterial").modal("hide");
    $(".WindowEditKurs").modal("hide");
    $(".WindowEditPallet").modal("hide");
  });

 
});