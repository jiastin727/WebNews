$('.ui.dropdown.Fin').dropdown({
  direction : 'upward'
});

const LogoutProtect = false;

var GetCookieHOMD = decodeURIComponent(getCookie("CooHOMD"));

function TableListFunc() {

  var NewDate = new Date();
  var YearNow = NewDate.getFullYear();

  var JsonFilter = getCookie('FilterMPPIHPList');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var TahunF    = ArrayF[1];
    var NamaF     = ArrayF[2];
    var StatusF   = ArrayF[3];
    var ProgressF = ArrayF[4];
  } else {
    var SearchF   = "";
    var TahunF    = YearNow;
    var NamaF     = "ALL";
    var StatusF   = "ALL";
    var ProgressF = "ALL";
  }

  if (SearchF) {
    $("#fcari_ihpmpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahunF) {
    $("#fthn_ihpmpp").dropdown("set selected", TahunF);
    var TahunFStart = TahunF;
  } else {
    var TahunFStart = YearNow;
  }
  if (NamaF) {
    $("#fmn_ihpmpp").dropdown("set selected", NamaF);
    var NamaFStart = NamaF;
  } else {
    var NamaFStart = "ALL";
  }
  if (StatusF) {
    $("#fsts_ihpmpp").dropdown("set selected", StatusF);
    var StatusFStart = StatusF;
  } else {
    var StatusFStart = "ALL";
  }

  if (ProgressF) {
    $("#fprog_ihpmpp").dropdown("set selected", ProgressF);
    var ProgressFStart = ProgressF;
  } else {
    var ProgressFStart = "ALL";
  }


  var FiterArry = [SearchFStart, TahunFStart, NamaFStart, StatusFStart, ProgressFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPIHPList", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    fixedColumns:   {
      leftColumns: 3
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          if(data['head_of'] === DUser){
            return `<span class="BtnEditIHP" eid="${data['id']}" thp="${data['tahap']}" lkm="${data['localmaker']}" data-tooltip="Edit, View Detail & Final Result IHP" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
          } else {
            return `<span class="BtnEditIHP" eid="${data['id']}" thp="${data['tahap']}" lkm="${data['localmaker']}" data-tooltip="View Detail & Final Result IHP" data-inverted="" data-position="right center"><i class="eye link circular blue icon "></i></span>`;
          }
        },
      },
      { data  : 'no_ihp' },
      { data  : 'description' },
      { data  : 'drawing_number' },
      // { data  : 'vendor' },
      { data: null,
        render: function (data) {
          return trimVendor(data['vendor']);
        },
      },
      { data  : 'manufacture' },
      { data  : 'jenis_project' },
      { data  : 'chassis' },
      { data: null,
        render: function (data) {
          return data['tahap']+' / '+data['localmaker'];
        },
      },
      { data  : 'designer' },
      { data  : 'head_of' },
      { data  : 'negotiator' },
      { data  : 'sourcing_operator' },
      { data  : 'created_at' },
      { data  : 'final_result' },
      { data  : 'status' },
      { data  : 'progress' },

    ],

    createdRow: function (row, data, index) {

      //WARNA OWNER & PLACE IN
      if (data['designer'] === DUser && data['progress'] === "PLACEIN") {
        $(row).find("td").css("color", ColorIHPPlacein);
      }

      //WARNA OWNER & PROCCES
      if (data['designer'] === DUser && data['progress'] === "PROCCES") {
        $(row).find("td").css("color", ColorIHPProcess);
      }

      if (data['head_of'] == DUser && data['progress'] == "APPROVED") {
        $(row).find("td").css("background-color", BgColorIHPApproved);
        $(row).find("td").css("color", ColorIHPApproved);
      }

      if (data['progress'] == "MSC OPR") {
        $(row).find("td").css("color", ColorIHPMscOpr);
      }

      if (data['final_result'] == "NOT OK") {
        $(row).find("td:eq(14)").css("color", ColorIHPNOT);
      }

      //WARNA FINISH & CLOSE
      if (
        data['status'] == "FINISH" ||
        data['status'] == "CLOSE"
      ) {
        $(row).find("td").css("color", ColorIHPFinish);
      }

      //WARNA CANCEL
      if (data['status'] == "CANCEL") {
        $(row).find("td").css("color", ColorIHPCancel);
      }

      //WARNA REQUEST APPROVAL SHD
      if (
        data['progress'] == "REQ-APPROVAL" ||
        data['progress'] == "REQ-CLOSE" ||
        data['progress'] == "REQ-CANCEL"
      ) {
        $(row).find("td").css("color", ColorIHPNeedApprove);
        $(row).find("td").css("background-color", BgColorIHPNeedApprove);
      }
    },


    ajax      : {
      url     : '../RND_BackEnd/backend_mpp/ihp/load/designer',
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch   : SearchFStart,
        FYear     : TahunFStart,
        FNama     : NamaFStart,
        FStatus   : StatusFStart,
        FProg     : ProgressFStart,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });
}

function trimVendor(s) {
  while (s.substr(0,1) == '0' && s.length>1) { s = s.substr(1,9999); }
  return s;
}

function DatePicker(IdTanggal) {
  var today = new Date();
  $(IdTanggal).calendar({
    type: "date",
    //monthFirst: false,
    //minDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return year + "-" + month + "-" + day;
      },
    },
  });
}

function DesignerConfirm(){
  $("#BtnDesignerConfirm").on("click", function () {
    var id_ihp = $("#DetailIdIHP").val();
    var thp_ihp = $("#DetailTahap").val();
    var lkm_ihp = $("#DetailLocalMaker").val();
    Swal.fire({
      title: "<h3>Confirmation</h3>",
      text: 'Terima IHP dan Sample Material ini?',
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type    : "POST",
          url     : `../RND_BackEnd/backend_mpp/ihp/confirm-designer`,
          headers : {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id       : id_ihp,
            username : VUserName,
            tahap    : thp_ihp,
            localmaker : lkm_ihp
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                TableListFunc();
                LoadDetailIHP(id_ihp,thp_ihp,lkm_ihp);
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });
}

function LoadDistribusiList(a,Thp,lkm){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/ihp/distribution/list/`+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    data : {
      tahap: Thp,
      localmaker : lkm
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);

      $('#Sec01').text(obj[0].pic_bagian);
      $('#Pic01').text(obj[0].pic_nama);
      $('#Qty01').text(obj[0].qty);
      $('#Not01').text(obj[0].note);
      $('#Edt01').html('<span class="EditDistribution" data-tooltip="Edit PIC section MD" data-inverted="" data-position="left center" sect="'+obj[0].pic_bagian+'" picx="'+obj[0].pic_nama+'" qtyx="'+obj[0].qty+'" notx="'+obj[0].note+'" idihpx="'+a+'" ThpIHP="'+Thp+'" LkmIHP="'+lkm+'"><i class="pencil alternate link  blue icon "></i></span>');
      if(obj[0].pic_nama){
        if(obj[0].tgl_kirim_distribusi){
          $('#Snd01').html('<span class="BtnSendNotif" data-tooltip="Kirim ulang notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[0].pic_bagian+'" picx="'+obj[0].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link violet icon "></i></span>');
        } else {
          $('#Snd01').html('<span class="BtnSendNotif" data-tooltip="Kirim notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[0].pic_bagian+'" picx="'+obj[0].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link blue icon "></i></span>');
        }
      } else {
        $('#Snd01').text('');
      }

      $('#Sec02').text(obj[1].pic_bagian);
      $('#Pic02').text(obj[1].pic_nama);
      $('#Qty02').text(obj[1].qty);
      $('#Not02').text(obj[1].note);
      $('#Edt02').html('<span class="EditDistribution" data-tooltip="Edit PIC section ID" data-inverted="" data-position="left center" sect="'+obj[1].pic_bagian+'" picx="'+obj[1].pic_nama+'" qtyx="'+obj[1].qty+'" notx="'+obj[1].note+'" idihpx="'+a+'" ThpIHP="'+Thp+'" LkmIHP="'+lkm+'"><i class="pencil alternate link  blue icon "></i></span>');
      if(obj[1].pic_nama){
        if(obj[1].tgl_kirim_distribusi){
          $('#Snd02').html('<span class="BtnSendNotif" data-tooltip="Kirim notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[1].pic_bagian+'" picx="'+obj[1].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link blue icon "></i></span>');
        } else {
          $('#Snd02').html('<span class="BtnSendNotif" data-tooltip="Kirim notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[1].pic_bagian+'" picx="'+obj[1].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link blue icon "></i></span>');
        }
      } else {
        $('#Snd02').text('');
      }

      $('#Sec03').text(obj[2].pic_bagian);
      $('#Pic03').text(obj[2].pic_nama);
      $('#Qty03').text(obj[2].qty);
      $('#Not03').text(obj[2].note);
      $('#Edt03').html('<span class="EditDistribution" data-tooltip="Edit PIC section DQA" data-inverted="" data-position="left center" sect="'+obj[2].pic_bagian+'" picx="'+obj[2].pic_nama+'" qtyx="'+obj[2].qty+'" notx="'+obj[2].note+'" idihpx="'+a+'" ThpIHP="'+Thp+'" LkmIHP="'+lkm+'"><i class="pencil alternate link  blue icon "></i></span>');
      if(obj[2].pic_nama){
        if(obj[2].tgl_kirim_distribusi){
          $('#Snd03').html('<span class="BtnSendNotif" data-tooltip="Kirim notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[2].pic_bagian+'" picx="'+obj[2].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link blue icon "></i></span>');
        } else {
          $('#Snd03').html('<span class="BtnSendNotif" data-tooltip="Kirim notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[2].pic_bagian+'" picx="'+obj[2].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link blue icon "></i></span>');
        }
      } else {
        $('#Snd03').text('');
      }
      
      $('#Sec04').text(obj[3].pic_bagian);
      $('#Pic04').text(obj[3].pic_nama);
      $('#Qty04').text(obj[3].qty);
      $('#Not04').text(obj[3].note);
      $('#Edt04').html('<span class="EditDistribution" data-tooltip="Edit PIC section Others" data-inverted="" data-position="left center" sect="'+obj[3].pic_bagian+'" picx="'+obj[3].pic_nama+'" qtyx="'+obj[3].qty+'" notx="'+obj[3].note+'" idihpx="'+a+'" ThpIHP="'+Thp+'" LkmIHP="'+lkm+'"><i class="pencil alternate link  blue icon "></i></span>');
      if(obj[3].pic_nama){
        if(obj[3].tgl_kirim_distribusi){
          $('#Snd04').html('<span class="BtnSendNotif" data-tooltip="Kirim notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[3].pic_bagian+'" picx="'+obj[3].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link blue icon "></i></span>');
        } else {
          $('#Snd04').html('<span class="BtnSendNotif" data-tooltip="Kirim notifikasi IHP" data-inverted="" data-position="left center" sect="'+obj[3].pic_bagian+'" picx="'+obj[3].pic_nama+'" idihpx="'+a+'" Thp="'+Thp+'" LkmIHP="'+lkm+'"><i class="paper plane link blue icon "></i></span>');
        }
      } else {
        $('#Snd04').text('');
      }

      $(".EditDistribution").on("click", function () {
        var section = $(this).attr('sect');
        var picx = $(this).attr('picx');
        var qtyx = $(this).attr('qtyx');
        var notx = $(this).attr('notx');
        var idihpx = $(this).attr('idihpx');
        var thpihp = $(this).attr('ThpIHP');
        var lkmihp = $(this).attr('LkmIHP');
        $(".WindowEditDistribusiIHP").modal({ autofocus: false, closable : false, }).modal("show");
        $("#IdIHPTahap").val(thpihp);
        LoadDistributeTo(section,picx,qtyx,notx,idihpx,thpihp,lkmihp);
      });


      $(".BtnSendNotif").on("click", function () {
        var section = $(this).attr('sect');
        var picx = $(this).attr('picx');
        var idihpx = $(this).attr('idihpx');
        var Thp = $(this).attr('Thp');
        var lkmihp = $(this).attr('LkmIHP');
        SendNotif(section,picx,idihpx,Thp,lkmihp);
      });



    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function LoadDistribusiListInfo(a,Thp,lkm){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/ihp/distribution/list/`+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    data : {
      tahap: Thp,
      localmaker : lkm
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);

      $('#Sec01').text(obj[0].pic_bagian);
      $('#Pic01').text(obj[0].pic_nama);
      $('#Qty01').text(obj[0].qty);
      $('#Not01').text(obj[0].note);
      $('#Edt01').html('');
      $('#Snd01').text('');

      $('#Sec02').text(obj[1].pic_bagian);
      $('#Pic02').text(obj[1].pic_nama);
      $('#Qty02').text(obj[1].qty);
      $('#Not02').text(obj[1].note);
      $('#Edt02').html('');
      $('#Snd02').text('');

      $('#Sec03').text(obj[2].pic_bagian);
      $('#Pic03').text(obj[2].pic_nama);
      $('#Qty03').text(obj[2].qty);
      $('#Not03').text(obj[2].note);
      $('#Edt03').html('');
      $('#Snd03').text('');
      
      $('#Sec04').text(obj[3].pic_bagian);
      $('#Pic04').text(obj[3].pic_nama);
      $('#Qty04').text(obj[3].qty);
      $('#Not04').text(obj[3].note);
      $('#Edt04').html('');
      $('#Snd04').text('');
      


    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function LoadDetailIHP(a,b,c){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/ihp/load-item/'+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: {   
      tahap : b,
      localmaker : c
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      var tglihpkembali = moment(obj.tgl_ihp_kembali, "YYYY-MM-DD");
      var tglcurrent = moment().startOf('day');
      if(tglihpkembali.diff(tglcurrent, 'days') < 0){
        var targetstatus = '( '+tglihpkembali.from(tglcurrent)+' )';
      } else {
        var targetstatus = '( '+moment.duration(tglihpkembali.diff(tglcurrent)).asDays()+' days left )';
      }
      $('#DetailNoIHP').text(obj.no_ihp);
      $('#DetailNoMPP').text(obj.no_mpp);
      $('#DetailDate').text(moment(obj.created_at).format('ddd, DD MMM YYYY'));
      $('#DetailPICIHP').text(obj.designer);
      $('#DetailDesc').text(obj.description);
      $('#DetailHeadOf').text(obj.head_of);
      // $('#DetailVendor').html(obj.vendor+' / '+obj.vendorTerm+'<br>'+obj.vendorName);
      $('#DetailVendor').html(obj.vendor);
      $('#DetailNoGudang').text(obj.reff_pin);
      $('#DetailDrawingLoc').text(obj.drawing_loc);
      $('#DetailNego').text(obj.negotiator);
      $('#DetailNoDN').text(obj.drawing_number);
      $('#DetailOperator').text(obj.sourcing_operator);
      $('#DetailJenisPrj').text(obj.jenis_project);
      $('#DetailChs').text(obj.chassis);
      $('#DetailTahap').text(obj.tahap);
      $('#DetailQty').text(obj.qty_sample);
      $('#DetailBaseUnit').text(obj.base_unit);
      $('#DetailTarget').text(moment(obj.tgl_ihp_kembali).format('ddd, DD MMM YYYY'));
      $('#TargetLeft').text(targetstatus);
      $('#DetailNote').text(obj.msc_note);
      $('#DetailIdIHP').val(obj.id);
      $('#IdIHPLocalMaker').val(c);

      if(obj.head_of == DUser){  
        if(obj.status ==="ACTIVE" && obj.progress ==="PLACEIN"){
          $('#AreaDistribusiIHP').hide();
          $('#BtnDesignerConfirm').show();
          $('#BtnDesignerConfirm').removeClass('disabled');
          $('#BtnFinalResult').addClass('disabled');
          $('#BtnLabelMaterial').show();
        } else if(obj.status ==="ACTIVE" && (obj.progress ==="REQ-APPROVAL" || obj.progress ==="REQ-CLOSE" || obj.progress ==="REQ-CANCEL" || obj.progress ==="APPROVED" || obj.progress ==="MSC OPR" || obj.progress ==="IHP KEMBALI")){
          $('#AreaDistribusiIHP').hide();
          $('#BtnDesignerConfirm').hide();
          $('#BtnDesignerConfirm').addClass('disabled');
          $('#BtnFinalResult').removeClass('disabled');
          $('#BtnLabelMaterial').show();
          if(obj.progress ==="APPROVED" || obj.progress ==="MSC OPR" || obj.progress ==="IHP KEMBALI"){
            $('#BtnLabelAcc').show();
          } else {
            $('#BtnLabelAcc').hide();
          }
        } else if(obj.status ==="ACTIVE" && obj.progress ==="MD OPR"){
          $('#AreaDistribusiIHP').hide();
          $('#BtnDesignerConfirm').hide();
          $('#BtnDesignerConfirm').addClass('disabled');
          $('#BtnFinalResult').removeClass('disabled');
          $('#BtnLabelAcc').show();
          $('#BtnLabelMaterial').show();
        } else if((obj.status ==="CANCEL" || obj.status ==="CLOSE" || obj.status ==="FINISH") ){
          $('#AreaDistribusiIHP').hide();
          $('#BtnDesignerConfirm').addClass('disabled');
          $('#BtnFinalResult').removeClass('disabled');
          if(obj.status ==="FINISH"){
            $('#BtnLabelAcc').show();
          } else {
            $('#BtnLabelAcc').hide();
          }
        } else {
          if(obj.status ==="ACTIVE"){
            $('#AreaDistribusiIHP').show();
            LoadDistribusiList(obj.id,obj.tahap,c);
            $('#BtnDesignerConfirm').show();
            $('#BtnDesignerConfirm').addClass('disabled');
            $('#BtnFinalResult').removeClass('disabled');
            $('#BtnLabelAcc').hide();
            $('#BtnLabelMaterial').show();
          } else {
            $('#AreaDistribusiIHP').show();
            LoadDistribusiListInfo(obj.id,obj.tahap,c);
            $('#BtnDesignerConfirm').hide();
            $('#BtnDesignerConfirm').addClass('disabled');
            $('#BtnFinalResult').removeClass('disabled');
            $('#BtnLabelAcc').hide();
            $('#BtnLabelMaterial').hide();
          }
        }
      }else {
        if(obj.status ==="ACTIVE" && obj.progress ==="PLACEIN"){
          $('#AreaDistribusiIHP').hide();
          $('#BtnDesignerConfirm').hide();
          $('#BtnLabelAcc').hide();
          $('#BtnLabelMaterial').hide();
          $('#BtnFinalResult').addClass('disabled');
        } else  {
          $('#AreaDistribusiIHP').hide();
          $('#BtnDesignerConfirm').hide();
          $('#BtnLabelAcc').hide();
          $('#BtnLabelMaterial').hide();
          $('#BtnFinalResult').removeClass('disabled');
        }
      }

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function LoadDistributeTo(sect,pic,qty,note,idihp,Thp,Lkm){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/ihp/distribution/checker',
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: {   
      ihp_section  : sect,
      tahap  : Thp,
      localmaker : Lkm
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      jmlData = obj.length;
      $("#PICDistribution").empty();
      $("#PICDistribution").dropdown("clear");
      $("#PICDistribution").append(
        '<option value="" selected></option>'
      );
      for (a = 0; a < jmlData; a++) {
        if(pic === obj[a]){
        $("#PICDistribution").append(
          '<option value="'+obj[a]+'" selected>'+obj[a]+'</option>'
        );
        } else {
          $("#PICDistribution").append(
            '<option value="'+obj[a]+'">'+obj[a]+'</option>'
          );
        }
      }
      $("#SectionIHPChecker").text(sect);
      $('#QtyDistribution').val(qty);
      $('#NoteDistribution').val(note);
      $('#IdIHPDistribution').val(idihp);

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function SavePICDistribution(){

  $("#BtnSaveDistribution").on("click", function () {
    var id_ihp = $('#IdIHPDistribution').val();
    var Thp = $('#IdIHPTahap').val();
    var Lkm = $('#IdIHPLocalMaker').val();
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/ihp/distribution/edit`,
      headers : {
        user  : VUserName,
        token : VToken
      },
      data: {   
        id_ihp    : id_ihp,
        username  : VUserName,
        pic_nama  : $('#PICDistribution').val(),
        pic_bagian: $("#SectionIHPChecker").text(),
        qty       : $('#QtyDistribution').val(),
        note      : $('#NoteDistribution').val(),
        tahap     : Thp,
        localmaker : Lkm
      },
      cache: false,
      success: function (response) {
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            $(".WindowEditDistribusiIHP").modal("hide");
            $(".WindowAddEditIHP").modal({ autofocus: false, closable : false, }).modal("show");
            LoadDetailIHP(id_ihp,Thp);
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });

  });
}

function DeletePICDistribution(){
  $("#BtnDeleteDistribution").on("click", function () {
    Swal.fire({
      title: "<h3>Hapus PIC ini dari Distribusi IHP?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({

          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });
}

function SendNotif(sect,pic,idihp,thp,lkm){
  Swal.fire({
    title: "<h3>Kirim notifikasi email ke PIC Checker?</h3>",
    text: pic,
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type: "POST",
        url     : '../RND_BackEnd/backend_mpp/ihp/distribution/send',
        headers: {
          user  : VUserName,
          token : VToken
        },
        data: {   
          id_ihp    : idihp,
          username  : VUserName,
          pic_bagian: sect,
          tahap     : thp,
          localmaker : lkm
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(response);
          if(isEmpty(obj)) {
            IsResponseEmptyObj();
          } else if(obj) {
            if (obj.status == false){
              IsResponseFalse(obj.message);
            } else {
              IsResponseTrue(obj.message);
            }
          } else {
            IsResponseErrorElse();
          }
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });
    }
  });
}


function LoadFinalResult(a,b,c,d,e){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/ihp/final-result/load/'+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: {
      tahap : d,
      localmaker : e
    },
    cache: false,
    success: function (response){
      
      var obj = JSON.parse(response);
      var cond='';

      if (obj.status == false){
        $('#FinalResultNoIHP').text(b);
        $('#FinalResultDesc').text(c);
        $("#AreaJudgementIHP").hide();
        
        // FinalResultJudge
        $("#BtnSignFinalResult").addClass('disabled');
        $("#BtnCancelAllRequest").addClass('disabled');
        $("#TblIHPFinalResult").empty();
        $("#TblIHPFinalResult").append(
          "<thead>"+
            "<tr>"+
              "<th width='150px'><b>Section</b></th>"+
              "<th width='250px'><b>Test Result/Status</b></th>"+
              "<th width='200px'><b>Ref.Docs/Files</b></th>"+
              "<th width='200px'><b>PIC Checker</b></th>"+
              "<th width='100px'><b>Signed Date</b></th>"+
            "</tr>"+
          "</thead>"+
          "<tbody>"+"<tr>"+
          "<td colspan='5'><i>Belum ada hasil evaluasi sama sekali.<br>Kondisi seperti ini IHP tidak dapat di-sign.<br>Silakan lakukan pengisian minimal 1 hasil IHP evaluation.</i></td>"+
          "</tr>"+"</tbody>"
        );

      } else {

        $('#FinalResultNoIHP').text(obj['ihp'].no_ihp);
        $('#FinalResultDesc').text(obj['ihp'].description);
        $('#FinalResultJudgeHeader').text(obj['ihp'].final_result);
        // $("#AreaJudgementIHP").show();
        $("#FinalResultJudge").dropdown("clear");
        $("#FinalResultJudge").dropdown("set selected", obj['ihp'].final_result);
        $("#BtnSignFinalResult").removeClass('disabled');
        $("#BtnCancelAllRequest").removeClass('disabled');
        $("#TblIHPFinalResult").empty();
        $("#TblIHPFinalResult").append(
          "<thead>"+
            "<tr>"+
              "<th width='150px'><b>Section</b></th>"+
              "<th width='250px'><b>Test Result/Status</b></th>"+
              "<th width='200px'><b>Ref.Docs/Files</b></th>"+
              "<th width='200px'><b>PIC Checker</b></th>"+
              "<th width='100px'><b>Signed Date</b></th>"+
            "</tr>"+
          "</thead>"+
          "<tbody>"
        );

        // console.log(obj['ihp'].progress);

        if(obj['ihp'].head_of == DUser){ 
          $(".ApprovalArea").show();
          if(obj['ihp'].status !== "ACTIVE"){
            if(obj['ihp'].status === "REQ-APPROVE"){
              $("#BtnSignFinalResult").removeClass('disabled');
              $("#BtnRequestClose").addClass('disabled grey');
              $("#BtnRequestCancel").addClass('disabled grey');
              $("#BtnRequestClose").removeClass('orange');
              $("#BtnRequestCancel").removeClass('red');
              $("#BtnCancelAllRequest").removeClass('disabled');
              $("#AreaJudgementIHP").show();
            } else if(obj['ihp'].status === "REQ-CLOSE"){
              $("#BtnSignFinalResult").addClass('disabled grey');
              $("#BtnRequestClose").removeClass('disabled');
              $("#BtnRequestCancel").addClass('disabled grey');
              $("#BtnSignFinalResult").removeClass('teal');
              $("#BtnRequestCancel").removeClass('red');
              $("#BtnCancelAllRequest").removeClass('disabled');
              $("#AreaJudgementIHP").show();
            } else if(obj['ihp'].status === "REQ-CANCEL"){
              $("#BtnSignFinalResult").addClass('disabled grey');
              $("#BtnRequestClose").addClass('disabled grey');
              $("#BtnRequestCancel").removeClass('disabled');
              $("#BtnSignFinalResult").removeClass('teal');
              $("#BtnRequestClose").removeClass('orange');
              $("#BtnCancelAllRequest").removeClass('disabled');
              $("#AreaJudgementIHP").show();
            } else {
              $("#BtnSignFinalResult").addClass('disabled grey');
              $("#BtnCancelAllRequest").addClass('disabled grey');
              $("#BtnRequestClose").addClass('disabled grey');
              $("#BtnRequestCancel").addClass('disabled grey');
              $("#BtnSignFinalResult").removeClass('teal');
              $("#BtnRequestClose").removeClass('orange');
              $("#BtnRequestCancel").removeClass('red');
              $("#AreaJudgementIHP").hide();
            }
          } else {
            if(obj['ihp'].progress === "MD OPR"){
              $("#BtnSignFinalResult").addClass('disabled grey');
              $("#BtnCancelAllRequest").addClass('disabled grey');
              $("#BtnRequestClose").addClass('disabled grey');
              $("#BtnRequestCancel").addClass('disabled grey');
              $("#BtnSignFinalResult").removeClass('teal');
              $("#BtnRequestClose").removeClass('orange');
              $("#BtnRequestCancel").removeClass('red');
              $("#AreaJudgementIHP").hide();
            } else {
              $("#BtnSignFinalResult").removeClass('disabled grey');
              $("#BtnCancelAllRequest").removeClass('disabled grey');
              $("#BtnRequestClose").removeClass('disabled grey');
              $("#BtnRequestCancel").removeClass('disabled grey');
              $("#BtnSignFinalResult").addClass('teal');
              $("#BtnRequestClose").addClass('orange');
              $("#BtnRequestCancel").addClass('red');
              $("#AreaJudgementIHP").show();
            }
          }
        } else {
          $(".ApprovalArea").hide();
        }

        if (typeof obj['result']['MECHANIC'] !== 'undefined'){
          JmlDataA = obj['result']['MECHANIC'].length;
          for(var i=0; i<JmlDataA; i++){
            if (i===0){
              var cond = "first";
              var sect = "MECHANIC";
            } else {
              var cond = "last";
              var sect = "";
            }
            if(obj['result']['MECHANIC'][i]['date_sign']){
              const ArryMD = obj['result']['MECHANIC'][i]['date_sign'].split(" ");
              var Signdate = ArryMD[0];
              var ToolTip = "data-tooltip='"+IsNull(obj['result']['MECHANIC'][i]['date_sign'])+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['MECHANIC'][i]['download_id']){
              if(obj['result']['MECHANIC'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['MECHANIC'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['MECHANIC'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['MECHANIC'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['MECHANIC'][i]['report_doc'];
            }

            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['MECHANIC'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['MECHANIC'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "</tr>"
            );
          }
        } else {
          $("#TblIHPFinalResult").append(
            "<tr>"+
            "<td class='ihpfinalresultcellfirst'><b>MECHANIC</b></td>"+
            "<td colspan='4'></td>"+
            "</tr>"
          );
        }

        if (typeof obj['result']['INDUSTRIAL DESIGN'] !== 'undefined'){
          JmlDataB = obj['result']['INDUSTRIAL DESIGN'].length;
          for(var i=0; i<JmlDataB; i++){
            if (i===0){
              var cond = "first";
              var sect = "INDUSTRIAL DESIGN";
            } else {
              var cond = "last";
              var sect = "";
            }
            if(obj['result']['INDUSTRIAL DESIGN'][i]['date_sign']){
              const ArryMD = obj['result']['INDUSTRIAL DESIGN'][i]['date_sign'].split(" ");
              var Signdate = ArryMD[0];
              var ToolTip = "data-tooltip='"+IsNull(obj['result']['INDUSTRIAL DESIGN'][i]['date_sign'])+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['INDUSTRIAL DESIGN'][i]['download_id']){
              if(obj['result']['INDUSTRIAL DESIGN'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['INDUSTRIAL DESIGN'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['INDUSTRIAL DESIGN'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['INDUSTRIAL DESIGN'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['INDUSTRIAL DESIGN'][i]['report_doc'];
            }

            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['INDUSTRIAL DESIGN'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['INDUSTRIAL DESIGN'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "</tr>"
            );
          }
        } else {
          $("#TblIHPFinalResult").append(
            "<tr>"+
            "<td class='ihpfinalresultcellfirst'><b>INDUSTRIAL DESIGN</b></td>"+
            "<td colspan='4'></td>"+
            "</tr>"
          );
        }


        if (typeof obj['result']['DQA'] !== 'undefined'){
          JmlDataC = obj['result']['DQA'].length;
          for(var i=0; i<JmlDataC; i++){
            if (i===0){
              var cond = "first";
              var sect = "DQA";
            } else {
              var cond = "last";
              var sect = "";
            }
            if(obj['result']['DQA'][i]['date_sign']){
              const ArryMD = obj['result']['DQA'][i]['date_sign'].split(" ");
              var Signdate = ArryMD[0];
              var ToolTip = "data-tooltip='"+IsNull(obj['result']['DQA'][i]['date_sign'])+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['DQA'][i]['download_id']){
              if(obj['result']['DQA'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['DQA'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['DQA'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['DQA'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['DQA'][i]['report_doc'];
            }

            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['DQA'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['DQA'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "</tr>"
            );
          }
        } else {
          $("#TblIHPFinalResult").append(
            "<tr>"+
            "<td class='ihpfinalresultcellfirst'><b>DQA</b></td>"+
            "<td colspan='4'></td>"+
            "</tr>"
          );
        }

        if (typeof obj['result']['OTHER'] !== 'undefined'){
          JmlDataD = obj['result']['OTHER'].length;
          for(var i=0; i<JmlDataD; i++){
            if (i===0){
              var cond = "first";
              var sect = "OTHER";
            } else {
              var cond = "last";
              var sect = "";
            }
            if(obj['result']['OTHER'][i]['date_sign']){
              const ArryMD = obj['result']['OTHER'][i]['date_sign'].split(" ");
              var Signdate = ArryMD[0];
              var ToolTip = "data-tooltip='"+IsNull(obj['result']['OTHER'][i]['date_sign'])+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['OTHER'][i]['download_id']){
              if(obj['result']['OTHER'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['OTHER'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['OTHER'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['OTHER'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['OTHER'][i]['report_doc'];
            }

            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['OTHER'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['OTHER'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "</tr>"
            );
          }
        } else {
          $("#TblIHPFinalResult").append(
            "<tr>"+
            "<td class='ihpfinalresultcellfirst'><b>OTHER</b></td>"+
            "<td colspan='4'></td>"+
            "</tr>"
          );
        }

        $("#TblIHPFinalResult").append(
          "</tbody>"
        );
      }


      if(obj['ihp'].head_of == DUser && obj['ihp'].status == 'ACTIVE'){
        if(obj['ihp'].progress === 'DESIGNER'){
          $(".AreaResult").hide();
          $(".ApprovalArea").hide();
          $(".NoteApprovalArea").show();
          $("#infoihp").text('IHP masih dalam proses check oleh designer dan checker terkait');
          $("#InfoReason").html('');

        } else if(obj['ihp'].progress == 'REQ-APPROVAL') {

          $(".AreaResult").show();
          $(".ApprovalArea").show();
          $(".NoteApprovalArea").hide();
          $("#infoihp").text('');
          $("#BtnRequestClose").removeClass('orange');
          $("#BtnRequestCancel").removeClass('red');
          $("#BtnRequestClose").addClass('disabled');
          $("#BtnRequestCancel").addClass('disabled');
          $("#InfoReason").html('');
         
        } else if(obj['ihp'].progress == 'REQ-CLOSE' || obj['ihp'].progress == 'REQ-CANCEL') {

          $(".AreaResult").hide();
          $(".AreaButton").show();
          $(".NoteApprovalArea").hide();
          $("#infoihp").text('');
          $("#BtnSignFinalResult").removeClass('teal');
          $("#BtnSignFinalResult").addClass('disabled');
          $("#InfoReason").html('<div class="ui small warning message"><div class="header">Alasan '+obj['ihp'].progress+':</div>'+obj['statusihp'][0].reason_close_cancel+'</div>');

          if(obj['ihp'].progress == 'REQ-CLOSE'){
            $("#BtnRequestClose").removeClass('disabled');
            $("#BtnRequestCancel").addClass('disabled');
          }
          if(obj['ihp'].progress == 'REQ-CANCEL'){
            $("#BtnRequestClose").addClass('disabled');
            $("#BtnRequestCancel").removeClass('disabled');
          }
         
        } else if(obj['ihp'].progress == 'APPROVED' || obj['ihp'].progress == 'MSC OPR') {

          $(".AreaResult").hide();
          $(".ApprovalArea").hide();
          $(".NoteApprovalArea").show();
          $("#infoihp").text('IHP ini sudah di Approve oleh Head of');
          $("#InfoReason").html('');
         
        } else if(obj['ihp'].progress == 'IHP KEMBALI') {

          $(".AreaResult").hide();
          $(".ApprovalArea").hide();
          $(".NoteApprovalArea").show();
          $("#infoihp").text('IHP ini sudah di Approve oleh Head of dan sudah kembali ke MSC Operator');
          $("#InfoReason").html('');
         
        }

      } else if(obj['ihp'].head_of == DUser && (obj['ihp'].status == 'CLOSE' || obj['ihp'].status == 'CANCEL')){ 
        $(".ApprovalArea").hide();
        $(".NoteApprovalArea").show();
        $("#infoihp").text('IHP ini telah di Close/Cancel dan telah disetujui oleh Head of yang bersangkutan');
        
      } else if(obj['ihp'].head_of == DUser && obj['ihp'].status == 'ACTIVE'){ 
        $(".ApprovalArea").hide();
        $(".NoteApprovalArea").show();
        if(obj['ihp'].progress === 'DESIGNER'){
          $("#infoihp").text('IHP masih dalam proses check oleh designer dan checker terkait');
        } else if(obj['ihp'].progress == 'REQ-APPROVAL') {
          $("#infoihp").text('IHP masih dalam proses Approval oleh Head of');
        } else if(obj['ihp'].progress == 'APPROVED' || obj['ihp'].progress == 'MSC OPR') {
          $("#infoihp").text('IHP ini sudah di Approve oleh Head of');
        }
      }


      $(".DownloadDoc").on("click", function () {
        var iddwn = $(this).attr('iddwn');
        // window.open('../RND_BackEnd/backend_mpp/download/'+iddwn);
        var EncId = Ucrypt.encrypt(iddwn, NonceValue);
        window.location.href = "./?link=mppdownload&i=" + EncId;
        // $.ajax({
        //   url      : '../RND_BackEnd/backend_mpp/download/'+iddwn,
        //   // dataType : "jsonp",
        //   headers  : { "Content-Type":"application/json","Accept": "application/json","Authorization": "Basic bG9naW5tYW5hZ2VtZW50OmV5SmphWEJvWlhKMFpYaDBJam9pTlNzNE1uUkVkV2RCZDJKek1teHRaakJTUXpaUFVUMDlJaXdpYVhZaU9pSXdPV1UxWWpjd01tRTVPRFk0Wm1JeU4yTmxaVGxrWW1Zd05tUXlPVGxtWVNJc0luTmhiSFFpT2lJeU5URmhPREZtWldSak1HRTRNekV4WVdVd05EYzRZVFZqWVRNeE9UQTJNU0lzSW1sMFpYSmhkR2x2Ym5NaU9qazVPWDA9" },
        //   type      : 'GET',
        //   contentType: "application/json; charset=UTF-8",
        //   beforeSend: function (xhr) {
        //     xhr.setRequestHeader('user', VUserName);
        //     xhr.setRequestHeader('token', VToken);
        //     return xhr;
        //   },
        //   success : function (data) {
        //     console.log(data);
        //     window.open(data)
        //   },
        //   error : function (data, errorThrown) {
        //     alert(3);
        //   }
        // });
      });









      
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function DesignerSignIHP(a,b,c){
  $("#BtnSignFinalResult").on("click", function () {
    Swal.fire({
      title: "<h3>Sign Approve IHP ini?</h3>",
      // text: "Setelah klik sign maka IHP akan dicek dan proses approval Head Of bersangkutan.",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        var final_result  = $("#FinalResultJudge").val();
        $.ajax({
          type: "POST",
          url     : '../RND_BackEnd/backend_mpp/ihp/approve/head-of',
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id          : a,
            username    : VUserName,
            final_result: final_result,
            tahap       : b,
            localmaker : c
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                TableListFunc();
                $(".WindowFinalResult").modal("hide");
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });

  $("#BtnCancelAllRequest").on("click", function () {
    Swal.fire({
      title: "<h3>Batalkan permintaan Sign Approve/Close/Cancel dari Designer?</h3>",
      // text: "Setelah klik sign maka IHP akan dicek dan proses approval Head Of bersangkutan.",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        var final_result  = $("#FinalResultJudge").val();
        $.ajax({
          type: "POST",
          url     : '../RND_BackEnd/backend_mpp/ihp/unapprove/head-of',
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id          : a,
            username    : VUserName,
            final_result: final_result,
            tahap       : b,
            localmaker  : c
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                TableListFunc();
                $(".WindowFinalResult").modal("hide");
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });
}

function RequestClose(a){
  $("#BtnSaveRequestClose").on("click", function () {
    var reason = $('#CloseReason').val();
    var thp_ihp = $("#DetailTahap").text();
    var lkm_ihp = $("#DetailLocalMaker").val();
    Swal.fire({
      title: "<h3>Approve Close IHP ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url     : '../RND_BackEnd/backend_mpp/ihp/request-close-cancel',
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {   
            username    : VUserName,
            tahap       : thp_ihp,
            localmaker  : lkm_ihp
            // reason      : reason
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                $(".WindowRequestClose").modal("hide");
                TableListFunc();
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });
}

function RequestCancel(a){
  $("#BtnSaveRequestCancel").on("click", function () {
    var reason = $('#CancelReason').val();
    var thp_ihp = $("#DetailTahap").text();
    var lkm_ihp = $("#DetailLocalMaker").val();
    Swal.fire({
      title: "<h3>Approve Cancel IHP ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url     : '../RND_BackEnd/backend_mpp/ihp/request-close-cancel',
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id          : a,
            type        : "cancel",
            username    : VUserName,
            reason      : reason,
            tahap       : thp_ihp,
            localmaker  : lkm_ihp

          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                $(".WindowRequestCancel").modal("hide");
                TableListFunc();
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });
}


//Print Label Acc
$("#BtnLabelAcc").on("click", function (e) {
  var idihp= $("#DetailIdIHP").val();
  (async () => {
    const { value: cetak } = await Swal.fire({
      html: "<h3>Jumlah cetak Label Acc</h3>",
      input: "select",
      inputOptions: {
        "1": "1",
        "2": "2",
        "3": "3",
        "4": "4",
      },
      showCancelButton: true,
    });
    if (cetak) {
      //menggunakan plugin tambahan redirect
      $.redirect(
        "./?link=cetaklabelaccmpp",
        { jumlah: cetak, idihp: idihp },
        "POST",
        "_blank"
      );
    }
  })();
});

$(document).ready(function () {

  TableListFunc();
  
  DesignerConfirm();
  SavePICDistribution();
  DeletePICDistribution();

  $("#BtnFinalResult").on("click", function () {
    var idihp = $('#DetailIdIHP').val();
    var noihp = $('#DetailNoIHP').text();
    var desc = $('#DetailDesc').text();
    var Thp = $('#DetailTahap').text();
    var Lkm = $('#IdIHPLocalMaker').val();
    $(".WindowFinalResult").modal({ autofocus: false, closable : false, }).modal("show");
    LoadFinalResult(idihp,noihp,desc,Thp,Lkm);
    DesignerSignIHP(idihp,Thp,Lkm);
  });


  $("#BtnRequestClose").on("click", function () {
    var idihp = $('#DetailIdIHP').val();
    var thp_ihp = $("#DetailTahap").text();
    var Lkm = $('#IdIHPLocalMaker').val();

    // $(".WindowRequestClose").modal({ autofocus: false, closable : false, }).modal("show");
    // $('#CloseReason').val('');
    // RequestClose(idihp);

    Swal.fire({
      title: "<h3>Approve Close IHP ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url     : '../RND_BackEnd/backend_mpp/ihp/close-cancel',
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id          : idihp,
            type        : "close",
            username    : VUserName,
            tahap       : thp_ihp,
            localmaker  : Lkm
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                $(".WindowRequestClose").modal("hide");
                $(".WindowRequestCancel").modal("hide");
                $(".WindowFinalResult").modal("hide");
                TableListFunc();
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });


  });

  $("#BtnRequestCancel").on("click", function () {
    var idihp = $('#DetailIdIHP').val();
    var thp_ihp = $("#DetailTahap").text();
    var lkm_ihp = $("#DetailLocalMaker").val();

    // $(".WindowRequestCancel").modal({ autofocus: false}).modal("show");
    // $('#CancelReason').val('');
    // RequestCancel(idihp);

    Swal.fire({
      title: "<h3>Approve Cancel IHP ini?</h3>",
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type: "POST",
          url     : '../RND_BackEnd/backend_mpp/ihp/close-cancel',
          headers: {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id          : idihp,
            type        : "cancel",
            username    : VUserName,
            tahap       : thp_ihp,
            localmaker  : lkm_ihp

          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                $(".WindowRequestClose").modal("hide");
                $(".WindowRequestCancel").modal("hide");
                $(".WindowFinalResult").modal("hide");
                TableListFunc();
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });


  });

  $("#TableList").on("click", ".BtnEditIHP", function(){
    var eid  = $(this).attr('eid');
    var thp  = $(this).attr('thp');
    var lkm  = $(this).attr('lkm');
    $(".WindowAddEditIHP").modal({ autofocus: false, closable : false, }).modal("show");
    LoadDetailIHP(eid,thp,lkm);
  });

  $(".CloseModal").on("click", function(){
    $(".WindowAddEditIHP").modal("hide");
    $(".WindowEditDistribusiIHP").modal("hide");
    $(".WindowFinalResult").modal("hide");
    $(".WindowRequestClose").modal("hide");
    $(".WindowRequestCancel").modal("hide");
  });

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_ihpmpp").on("keyup", function () {
    var FilterCari = $("#fcari_ihpmpp").val();
    var FilterTahun = $("#fthn_ihpmpp").val();
    var FilterNama = $("#fmn_ihpmpp").val();
    var FilterStatus = $("#fsts_ihpmpp").val();
    var FilterProg = $("#fprog_ihpmpp").val();
    var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterStatus, FilterProg];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPIHPList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fthn_ihpmpp, #fmn_ihpmpp, #fsts_ihpmpp, #fprog_ihpmpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_ihpmpp").val();
      var FilterTahun = $("#fthn_ihpmpp").val();
      var FilterNama = $("#fmn_ihpmpp").val();
      var FilterStatus = $("#fsts_ihpmpp").val();
      var FilterProg = $("#fprog_ihpmpp").val();
      var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterStatus, FilterProg];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPIHPList", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var YearNow = d.getFullYear();
    $("#fcari_ihpmpp").val("");
    $("#fthn_ihpmpp").dropdown("set selected", YearNow);
    $("#fmn_ihpmpp").dropdown("set selected", "ALL");
    $("#fsts_ihpmpp").dropdown("set selected", "ALL");
    $("#fprog_ihpmpp").dropdown("set selected", "ALL");
    var FiterArry = ["", YearNow, "ALL", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPIHPList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", YearNow, "ALL", "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });



});