$(".ui.dropdown").dropdown();
$(".menu .item").tab();
const LogoutProtect = false;

function TableListFunc() {

  var NewDate = new Date();
  var YearNow = NewDate.getFullYear();

  var JsonFilter = getCookie('FilterMPPList');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var TahunF    = ArrayF[1];
    var NamaF     = ArrayF[2];
    var ProgressF = ArrayF[3];
    var StatusF   = ArrayF[4];
  } else {
    var SearchF   = "";
    var TahunF    = YearNow;
    var NamaF     = "ALL";
    var ProgressF = "ALL";
    var StatusF   = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahunF) {
    $("#fthn_mpp").dropdown("set selected", TahunF);
    var TahunFStart = TahunF;
  } else {
    var TahunFStart = YearNow;
  }
  if (NamaF) {
    $("#fmn_mpp").dropdown("set selected", NamaF);
    var NamaFStart = NamaF;
  } else {
    var NamaFStart = "ALL";
  }
  if (ProgressF) {
    $("#fprg_mpp").dropdown("set selected", ProgressF);
    var ProgressFStart = ProgressF;
  } else {
    var ProgressFStart = "ALL";
  }
  if (StatusF) {
    $("#fsts_mpp").dropdown("set selected", StatusF);
    var StatusFStart = StatusF;
  } else {
    var StatusFStart = "ALL";
  }

  var FiterArry = [SearchFStart, TahunFStart, NamaFStart, ProgressFStart, StatusFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPList", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned three wide column NewBtn'>" +
      "<'right aligned ten wide column'B>" +
      "<'right aligned three wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    pageLength  : 10,
    paging      : true,
    scrollX     : true,
    scrollCollapse: true,
    scrollY     : '60vh',
    fixedColumns:   {
      leftColumns: 4
    },
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        name  : 'id',
        render: function (data) {
          const ArryPicMPP = data['designer_md'].split(", ");
          if(ArryPicMPP[0] === DUser){
            return `<span class="itemmpp" id="${data['id']}" upic="${ArryPicMPP[0]}" data-tooltip="- Click: Detail Item MPP &nbsp;&nbsp;- Shift+Click: Edit Header MPP" data-inverted="" data-position="right center"><i class="tasks link circular blue icon "></i></span>`;
          } else {
            return `<span class="itemmpp" id="${data['id']}" upic="${ArryPicMPP[0]}" data-tooltip="Detail Item MPP" data-inverted="" data-position="right center"><i class="tasks link circular blue icon "></i></span>`;
          }
        },
      },
      { data  : 'no_mpp' },
      { data  : 'rev' },
      { data  : null,
        name  : 'title',
        render: function (data) {
          if(data['note'] === ''){
            return `<span data-tooltip="-- tidak ada note yang dicantumkan --" data-position="left center">`+data['title']+`</span>`;
          } else {
            return `<span data-tooltip="Note: ${data['note']}" data-position="left center">`+data['title']+`</span>`;
          }
        },
      },
      { data  : 'created_date' },
      { data  : 'projects_id',
          render: function ( data, type, row ) {
            if (data){
              return data.replace(/\,/g, ",<br>");
            } else {
              return '';
            }
          }
      },
      { data  : 'target_mp',
          render: function ( data, type, row ) {
            if (data){
              return data.replace(/\,/g, ",<br>");
            } else {
              return '';
            }
          }
      },
      { data  : 'jenis_project' },
      { data  : 'product' },
      { data  : 'chassis' },
      { data  : 'cabinet' },
      { data  : 'sales_contract',
          render: function ( data, type, row ) {
            if (data){
              return data.replace(/\,/g, "<br>");
            } else {
              return '';
            }
          }
      },
      { data  : 'vendor',
          render: function ( data, type, row ) {
            if (data){
              return data.replace(/\,/g, ",<br>");
            } else {
              return '';
            }
          }
      },
      { data  : 'wbs_project',
          render: function ( data, type, row ) {
            if (data){
              return data.replace(/\,/g, ",<br>");
            } else {
              return '';
            }
          }
      },
      { data  : null,
        name  : 'designer_md',
        render: function (data) {
          return data['designer_md'].replace(/\,/g, ",<br>")+',<br>'+data['head_of_md'];
        },
      },
      { data  : null,
        name  : 'designer_id',
        render: function (data) {
          return data['designer_id'].replace(/\,/g, ",<br>")+',<br>'+data['head_of_id'];
        },
      },
      { data  : 'project_leader' },
      { data  : 'negotiator' },
      { data  : 'status' },
      { data  : 'progress' },
    ],
    columnDefs: [
      { className : "center aligned", targets: [1] },
      { className : "collapsing", targets: [2,6,7] },
    ],

    createdRow: function (row, data, index) {

      //WARNA FREEZE LEFT COLUMNS 
      $(row).find("td:eq(3)").css("border-right", "inset");
      $(row).find("td:eq(3)").css("border-right-color", ColorBorderFreeze);
      
      //WARNA OWNER & STATUS ACTIVE/DRAFT 
      const ArryMD = data['designer_md'].split(", ");
      const ArryID = data['designer_id'].split(", ");
      const ArryPICAll = ArryMD.concat(ArryID);
      ArryPICAll.push(data['head_of_id'],data['head_of_md'],data['project_leader'],data['negotiator']);
      var ArryStatus = ['ACTIVE','DRAFT','REQ-CLOSE','REQ-FINISH','MPP-REJECT','MPP-RETURN'];
      
      if (($.inArray(DUser, ArryPICAll) > -1) && ($.inArray(data['status'], ArryStatus) > -1)) {
        $(row).find("td").css("color", ColorOwner);
        //WARNA MPP-REJECT/RETURN
        if (data['status'] == "MPP-REJECT" || data['status'] == "MPP-RETURN") {
          $(row).find("td").css("color", ColorRejectReturn);
        }
      }
      
      //WARNA FINISH & CLOSE
      if (data['status'] == "FINISH" || data['status'] == "CLOSE") {
        $(row).find("td").css("color", ColorFinish);
      }

      //WARNA REQUEST REVISI
      if (data['status'] == "REQ-REVISI") {
        $(row).find("td").css("background-color", BgColorReqRev);
        $(row).find("td").css("color", ColorReqRev);
      }

      //WARNA CANCEL
      if (data['status'] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }
    },
    ajax : {
      url     : `${RestLocMPP}mpp/list`,
      type    : "GET",    
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch   : SearchFStart,
        FYear     : TahunFStart,
        FNama     : NamaFStart,
        FProgress : ProgressFStart,
        FStatus   : StatusFStart,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });

}


$(document).ready(function () {

  TableListFunc();

  if(DSect ==='MECHANICAL DESIGN+PROTOTYPE'){
    $('div.NewBtn').html('<div class="ui large left floated primary compact labeled icon button" id="addnewmpp" data-tooltip="Buat header MPP baru" data-inverted="" data-position="right center"><i class="plus circle icon"></i> <span id="s">Create New</span>');
  } else {
    $('div.NewBtn').html('');
  }

  $("#addnewmpp").on("click", function () {
    window.location.href = "./?link=mppheader";
  });

  $("#TableList").on("click", ".itemmpp", function(event){
    var uid  = $(this).attr('id');
    var upic = $(this).attr('upic');
    if(upic === DUser){
      if (event.shiftKey) {
        $.ajax({
          type: "POST",
          url: `${RestLocMPP}sign/load/`+uid,
          headers: {
            user: VUserName,
            token: VToken
          },
          cache: false,
          success: function (data) {
            var obj = JSON.parse(data);
            if(obj.DateSignMD1 ===null && obj.SignByMD1 === null ){
              if(DUser === obj.DesignerMD1){
                var EncId = Ucrypt.encrypt(uid, NonceValue);
                window.location.href = "./?link=mppheader&i="+EncId;
              } else {
                IsResponseFalse2('Maaf, anda tidak berhak edit header MPP ini.');
              }
            } else {
              IsResponseFalse2('Maaf, MPP sudah anda sign sehingga tidak dimungkinkan untuk di edit lagi.');
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      } else {
        var EncId = Ucrypt.encrypt(uid, NonceValue);
        window.location.href = "./?link=itemmpp&i="+EncId;
      }
    } else {
      var EncId = Ucrypt.encrypt(uid, NonceValue);
      window.location.href = "./?link=itemmpp&i="+EncId;
    }
  });
 

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterTahun = $("#fthn_mpp").val();
    var FilterNama = $("#fmn_mpp").val();
    var FilterProgress = $("#fprg_mpp").val();
    var FilterStatus = $("#fsts_mpp").val();
    var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fthn_mpp, #fmn_mpp, #fprg_mpp, #fsts_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterTahun = $("#fthn_mpp").val();
      var FilterNama = $("#fmn_mpp").val();
      var FilterProgress = $("#fprg_mpp").val();
      var FilterStatus = $("#fsts_mpp").val();
      var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPList", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var YearNow = d.getFullYear();
    $("#fcari_mpp").val("");
    $("#fthn_mpp").dropdown("set selected", YearNow);
    $("#fmn_mpp").dropdown("set selected", "ALL");
    $("#fprg_mpp").dropdown("set selected", "ALL");
    $("#fsts_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", YearNow, "ALL", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", YearNow, "ALL", "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });

});