const LogoutProtect = false;

function TableListFunc() {

  var NewDate = new Date();
  var YearNow = NewDate.getFullYear();

  var JsonFilter = getCookie('FilterMPPIHP');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var TahunF    = ArrayF[1];
    var StatusF   = ArrayF[2];
  } else {
    var SearchF   = "";
    var TahunF    = YearNow;
    var StatusF   = "ALL";
  }

  if (SearchF) {
    $("#fcari_ihpmpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahunF) {
    $("#fthn_ihpmpp").dropdown("set selected", TahunF);
    var TahunFStart = TahunF;
  } else {
    var TahunFStart = YearNow;
  }
  if (StatusF) {
    $("#fsts_ihpmpp").dropdown("set selected", StatusF);
    var StatusFStart = StatusF;
  } else {
    var StatusFStart = "ALL";
  }

  var FiterArry = [SearchFStart, TahunFStart, StatusFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPIHP", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    fixedColumns:   {
      leftColumns: 3
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          if(data['status'] == "ACTIVE"){
            if(data['tgl_confirm']){
              return `<span class="BtnEditEvalIHP" eid="${data['id']}" thp="${data['tahap']}" lmk="${data['localmaker']}" data-tooltip="Edit IHP Evaluation" data-inverted="" data-position="right center"><i class="pencil alternate circle link circular blue icon "></i></span>`;
            } else {
              return `<span class="BtnConfirmEvalIHP" eid="${data['id_dist']}" data-tooltip="Confirm IHP Evaluation" data-inverted="" data-position="right center"><i class="check circle link circular teal icon "></i></span>`;
            }
          } else {
            return '';
          }
        },
      },
      { data  : 'no_ihp' },
      { data  : 'description' },
      { data  : 'drawing_number' },
      // { data  : 'vendor' },
      { data: null,
        render: function (data) {
          return trimVendor(data['vendor']);
        },
      },
      { data  : 'jenis_project' },
      { data  : 'chassis' },
      { data: null,
        render: function (data) {
          return data['tahap']+' / '+data['localmaker'];
        },
      },
      { data  : 'qty' },
      { data  : 'created_at' },
      { data  : 'designer_note' },
      { data  : 'status' },
      { data  : 'progress' },
      
    ],
    createdRow: function (row, data, index) {

      //WARNA FREEZE LEFT COLUMNS 
      $(row).find("td:eq(2)").css("border-right", "inset");
      $(row).find("td:eq(2)").css("border-right-color", ColorBorderFreeze);

      if (data['progress'] !== "DESIGNER") {
        $(row).find("td").css("color", ColorIHPFinish);
      }


    },

    columnDefs: [
      {
        targets: [9],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YY');
          } else {
            return '';
          }
        }
      },
      // {
      //   className: "right aligned",
      //   targets: [13]
      // },
    ],
   
    ajax      : {
      url     : '../RND_BackEnd/backend_mpp/ihp-evaluation/load',
      type    : "POST",
      headers: {
        user  : VUserName,
        token : VToken
      },
      data: {
        username: VUserName,
        FSearch   : SearchFStart,
        FYear     : TahunFStart,
        FStatus   : StatusFStart,
      },
      error   : function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}

function trimVendor(s) {
  while (s.substr(0,1) == '0' && s.length>1) { s = s.substr(1,9999); }
  return s;
}

function ConfirmEvalIHP(a){
  Swal.fire({
    title: "<h3>Konfirmasi permintaan evaluasi IHP ini?</h3>",
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({

        type    : "POST",
        url     : `../RND_BackEnd/backend_mpp/ihp-evaluation/checker-confirm`,
        headers : {
          user  : VUserName,
          token : VToken
        },
        data: {   
          id       : a,
          username : VUserName,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(response);
          if(isEmpty(obj)) {
            IsResponseEmptyObj();
          } else if(obj) {
            if (obj.status == false){
              IsResponseFalse(obj.message);
            } else {
              IsResponseTrue(obj.message);
              TableListFunc();
            }
          } else {
            IsResponseErrorElse();
          }
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });
    }
  });

}


function LoadFinalResult(a,b,c){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/ihp/final-result/load/'+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: {
      tahap : b,
      localmaker : c
    },
    cache: false,
    success: function (response){
      
      var obj = JSON.parse(response);
      var cond='';

      if (obj.status == false){
        $("#TblIHPFinalResult").empty();
        $("#TblIHPFinalResult").append(
          "<thead>"+
            "<tr>"+
              "<th width='150px'><b>Section</b></th>"+
              "<th width='250px'><b>Test Result/Status</b></th>"+
              "<th width='200px'><b>Ref.Docs/Files</b></th>"+
              "<th width='200px'><b>PIC Checker</b></th>"+
              "<th width='100px'><b>Signed Date</b></th>"+
              "<th width='40px'><b>Actions</b></th>"+
            "</tr>"+
          "</thead>"+
          "<tbody>"+"<tr>"+
          "<td colspan='6'><i>Data untuk IHP Evaluation ini tidak ditemukan di database IHP. Silakan cek ulang.</i></td>"+
          "</tr>"+"</tbody>"
        );
        $(".DetailIHP").text('');


      } else {

        var tglihpkembali = moment(obj['ihp'].tgl_ihp_kembali, "YYYY-MM-DD");
        var tglcurrent = moment().startOf('day');
        if(tglihpkembali.diff(tglcurrent, 'days') < 0){
          var targetstatus = '( '+tglihpkembali.from(tglcurrent)+' )';
        } else {
          var targetstatus = '( '+moment.duration(tglihpkembali.diff(tglcurrent)).asDays()+' days left )';
        }

        $('#DetailNoIHP').text(obj['ihp'].no_ihp);
        $('#DetailNoMPP').text(obj['ihp'].no_mpp);
        $('#DetailDate').text(moment(obj['ihp'].created_at).format('ddd, DD MMM YYYY'));
        $('#DetailDesc').text(obj['ihp'].description);
        $('#DetailVendor').html(obj['ihp'].vendor+' / '+obj['ihp'].vendorTerm+'<br>'+obj['ihp'].vendorName);
        $('#DetailNoDN').text(obj['ihp'].drawing_number);
        $('#DetailNoGudang').text(obj['ihp'].reff_pin);
        $('#DetailQty').text(obj['ihp'].qty_sample);
        $('#DetailNote').text(obj['ihp'].msc_note);
        $('#DetailJenisPrj').text(obj['ihp'].jenis_project);
        $('#DetailChs').text(obj['ihp'].chassis);
        $('#DetailTahap').text(obj['ihp'].tahap);
        $('#DetailPICIHP').text(obj['ihp'].pic_mpp);
        $('#DetailHeadOf').text(obj['ihp'].head_of);
        $('#DetailNego').text(obj['ihp'].negotiator);
        $('#DetailOperator').text(obj['ihp'].sourcing_operator);
        $('#DetailTarget').text(moment(obj.tgl_ihp_kembali).format('ddd, DD MMM YYYY'));
        $('#TargetLeft').text(targetstatus);
        $('#DetailDrawingLoc').text(obj['ihp'].drawing_loc);
        var id_ihpx = obj['ihp'].id;

        $("#TblIHPFinalResult").empty();
        $("#TblIHPFinalResult").append(
          "<thead>"+
            "<tr>"+
              "<th width='170px'><b>Section</b></th>"+
              "<th width='250px'><b>Test Result/Status</b></th>"+
              "<th width='200px'><b>Ref.Docs/Files</b></th>"+
              "<th width='200px'><b>PIC Checker</b></th>"+
              "<th width='120px'><b>Signed Date</b></th>"+
              "<th width='40px'><b>Actions</b></th>"+
            "</tr>"+
          "</thead>"+
          "<tbody>"
        );

        if (typeof obj['result']['MECHANIC'] !== 'undefined'){
          JmlDataA = obj['result']['MECHANIC'].length;
          NewDataA = JmlDataA+1;
          for(var i=0; i<JmlDataA; i++){
            if (i===0){
              var cond = "first";
              var sect = "MECHANIC";
            } else {
              var cond = "last";
              var sect = "";
            }
            if(DSect == "MECHANICAL DESIGN+PROTOTYPE" && obj['ihp'].progress==='DESIGNER'){
              if(i<JmlDataA-1){
                if(obj['result']['MECHANIC'][i]['bagian'] === obj['result']['MECHANIC'][i+1]['bagian']){
                  var BtnEdit ="";
                } else {
                  if(obj['result']['MECHANIC'][i]['date_sign']){
                    var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='MECHANIC' Thp='"+b+"'  Lmk='"+c+"' addidincre='"+NewDataA+"' addpic='"+obj['result']['MECHANIC'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                  } else {
                    var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['MECHANIC'][i]['id']+"' sect='MECHANIC' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['MECHANIC'][i]['id']+"' sect='MECHANIC' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='top right'>EDIT</a>";
                  }
                }
              } else {
                if(obj['result']['MECHANIC'][i]['date_sign']){
                  var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='MECHANIC' Thp='"+b+"' Lmk='"+c+"' addidincre='"+NewDataA+"' addpic='"+obj['result']['MECHANIC'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                } else {
                  var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['MECHANIC'][i]['id']+"' sect='MECHANIC' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['MECHANIC'][i]['id']+"' sect='MECHANIC' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='top right'>EDIT</a>";
                }
              }
            } else {
              var BtnEdit ="";
            }

            if(obj['result']['MECHANIC'][i]['date_sign']){
              const ArryMD = obj['result']['MECHANIC'][i]['date_sign'].split(" ");
              var Signdate = moment(ArryMD[0]).format('ddd, DD MMM YYYY');
              var ToolTip = "data-tooltip='"+IsNull(moment(obj['result']['MECHANIC'][i]['date_sign']).format('ddd, DD MMM YYYY HH:mm:ss'))+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['MECHANIC'][i]['download_id']){
              if(obj['result']['MECHANIC'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['MECHANIC'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['MECHANIC'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['MECHANIC'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['MECHANIC'][i]['report_doc'];
            }

            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['MECHANIC'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['MECHANIC'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "<td class='collapsing'>"+BtnEdit+"</td>"+
              "</tr>"
            );
          }
        } else {
          if(DSect == "MECHANICAL DESIGN+PROTOTYPE" && obj['ihp'].progress==='DESIGNER'){
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>MECHANIC</b></td>"+
              "<td colspan='4'></td>"+
              "<td><a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='MECHANIC' Thp='"+b+"' Lmk='"+c+"' addidincre='1' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a></td>"+
              "</tr>"
            );
          } else {
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>MECHANIC</b></td>"+
              "<td colspan='4'></td>"+
              "<td></td>"+
              "</tr>"
            );
          }
        }

        if (typeof obj['result']['INDUSTRIAL DESIGN'] !== 'undefined'){
          JmlDataB = obj['result']['INDUSTRIAL DESIGN'].length;
          NewDataB = JmlDataB+1;
          for(var i=0; i<JmlDataB; i++){
            if (i===0){
              var cond = "first";
              var sect = "INDUSTRIAL DESIGN";
            } else {
              var cond = "last";
              var sect = "";
            }
            if(DSect == "INDUSTRIAL DESIGN" && obj['ihp'].progress==='DESIGNER'){
              if(i<JmlDataB-1){
                if(obj['result']['INDUSTRIAL DESIGN'][i]['bagian'] === obj['result']['INDUSTRIAL DESIGN'][i+1]['bagian']){
                  var BtnEdit ="";
                } else {
                  if(obj['result']['INDUSTRIAL DESIGN'][i]['date_sign']){
                    var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='INDUSTRIAL DESIGN' Thp='"+b+"' Lmk='"+c+"' addidincre='"+NewDataB+"' addpic='"+obj['result']['INDUSTRIAL DESIGN'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                  } else {
                    var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['INDUSTRIAL DESIGN'][i]['id']+"' sect='INDUSTRIAL DESIGN' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['INDUSTRIAL DESIGN'][i]['id']+"' sect='INDUSTRIAL DESIGN' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='left center'>EDIT</a>";
                  }
                }
              } else {
                if(obj['result']['INDUSTRIAL DESIGN'][i]['date_sign']){
                  var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='INDUSTRIAL DESIGN' Thp='"+b+"' Lmk='"+c+"' addidincre='"+NewDataB+"' addpic='"+obj['result']['INDUSTRIAL DESIGN'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                } else {
                  var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['INDUSTRIAL DESIGN'][i]['id']+"' sect='INDUSTRIAL DESIGN' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['INDUSTRIAL DESIGN'][i]['id']+"' sect='INDUSTRIAL DESIGN' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='left center'>EDIT</a>";
                }
              }
            } else {
              var BtnEdit ="";
            }

            if(obj['result']['INDUSTRIAL DESIGN'][i]['date_sign']){
              const ArryID = obj['result']['INDUSTRIAL DESIGN'][i]['date_sign'].split(" ");
              var Signdate = moment(ArryID[0]).format('ddd, DD MMM YYYY');
              var ToolTip = "data-tooltip='"+IsNull(moment(obj['result']['INDUSTRIAL DESIGN'][i]['date_sign']).format('ddd, DD MMM YYYY HH:mm:ss'))+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['INDUSTRIAL DESIGN'][i]['download_id']){
              if(obj['result']['INDUSTRIAL DESIGN'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['INDUSTRIAL DESIGN'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['INDUSTRIAL DESIGN'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['INDUSTRIAL DESIGN'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['INDUSTRIAL DESIGN'][i]['report_doc'];
            }


            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['INDUSTRIAL DESIGN'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['INDUSTRIAL DESIGN'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "<td class='collapsing'>"+BtnEdit+"</td>"+
              "</tr>"
            );
          }
        } else {
          if(DSect == "INDUSTRIAL DESIGN" && obj['ihp'].progress==='DESIGNER'){
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>INDUSTRIAL DESIGN</b></td>"+
              "<td colspan='4'></td>"+
              "<td><a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='INDUSTRIAL DESIGN' Thp='"+b+"' Lmk='"+c+"' addidincre='1' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a></td>"+
              "</tr>"
            );
          } else {
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>INDUSTRIAL DESIGN</b></td>"+
              "<td colspan='4'></td>"+
              "<td></td>"+
              "</tr>"
            );
          }
        }

        if (typeof obj['result']['DQA'] !== 'undefined'){
          JmlDataC = obj['result']['DQA'].length;
          NewDataC = JmlDataC+1;
          for(var i=0; i<JmlDataC; i++){
            if (i===0){
              var cond = "first";
              var sect = "DQA";
            } else {
              var cond = "last";
              var sect = "";
            }
 
            if(DSect == "DQA" && obj['ihp'].progress==='DESIGNER'){
              if(i<JmlDataC-1){
                if(obj['result']['DQA'][i]['bagian'] === obj['result']['DQA'][i+1]['bagian']){
                  var BtnEdit ="";
                } else {
                  if(obj['result']['DQA'][i]['date_sign']){
                    var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='DQA' Thp='"+b+"' Lmk='"+c+"' addidincre='"+NewDataC+"' addpic='"+obj['result']['DQA'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                  } else {
                    var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['DQA'][i]['id']+"' sect='DQA' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['DQA'][i]['id']+"' sect='DQA' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='left center'>EDIT</a>";
                  }
                }
              } else {
                if(obj['result']['DQA'][i]['date_sign']){
                  var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='DQA' Thp='"+b+"' Lmk='"+c+"' addidincre='"+NewDataC+"' addpic='"+obj['result']['DQA'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                } else {
                  var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['DQA'][i]['id']+"' sect='DQA' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['DQA'][i]['id']+"' sect='DQA' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='left center'>EDIT</a>";
                }
              }
            } else {
              var BtnEdit ="";
            }

            if(obj['result']['DQA'][i]['date_sign']){
              const ArryDQ = obj['result']['DQA'][i]['date_sign'].split(" ");
              var Signdate = moment(ArryDQ[0]).format('ddd, DD MMM YYYY');
              var ToolTip = "data-tooltip='"+IsNull(moment(obj['result']['DQA'][i]['date_sign']).format('ddd, DD MMM YYYY HH:mm:ss'))+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['DQA'][i]['download_id']){
              if(obj['result']['DQA'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['DQA'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['DQA'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['DQA'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['DQA'][i]['report_doc'];
            }

            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['DQA'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['DQA'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "<td class='collapsing'>"+BtnEdit+"</td>"+
              "</tr>"
            );
          }
        } else {
          if(DSect == "DQA" && obj['ihp'].progress==='DESIGNER'){
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>DQA</b></td>"+
              "<td colspan='4'></td>"+
              "<td><a class='ui mini teal label BtnAddNewReport'  addid='"+id_ihpx+"' addsect='DQA' Thp='"+b+"' Lmk='"+c+"' addidincre='1' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a></td>"+
              "</tr>"
            );
          } else {
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>DQA</b></td>"+
              "<td colspan='4'></td>"+
              "<td></td>"+
              "</tr>"
            );
          }
        }

        if (typeof obj['result']['OTHER'] !== 'undefined'){
          JmlDataD = obj['result']['OTHER'].length;
          NewDataD = JmlDataD+1;
          for(var i=0; i<JmlDataD; i++){
            if (i===0){
              var cond = "first";
              var sect = "OTHER";
            } else {
              var cond = "last";
              var sect = "";
            }

            if(DSect == "OTHER"){
              if(i<JmlDataD-1){
                if(obj['result']['OTHER'][i]['bagian'] === obj['result']['OTHER'][i+1]['bagian']){
                  var BtnEdit ="";
                } else {
                  if(obj['result']['OTHER'][i]['date_sign']){
                    var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='OTHER' Thp='"+b+"' Lmk='"+c+"' addidincre='"+NewDataD+"' addpic='"+obj['result']['OTHER'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                  } else {
                    var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['OTHER'][i]['id']+"' sect='OTHER' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['OTHER'][i]['id']+"' sect='OTHER' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='left center'>EDIT</a>";
                  }
                }
              } else {
                if(obj['result']['OTHER'][i]['date_sign']){
                  var BtnEdit ="<a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='OTHER' Thp='"+b+"' Lmk='"+c+"' addidincre='"+NewDataD+"' addpic='"+obj['result']['OTHER'][i]['pic_checker']+"' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a>";
                } else {
                  var BtnEdit ="<a class='ui mini green label BtnSignReport' eid='"+id_ihpx+"' iditem='"+obj['result']['OTHER'][i]['id']+"' sect='OTHER' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Sign report' data-inverted='' data-position='top left'>SIGN</a><a class='ui mini blue label BtnEditReport' eid='"+id_ihpx+"' iditem='"+obj['result']['OTHER'][i]['id']+"' sect='OTHER' Thp='"+b+"' Lmk='"+c+"' data-tooltip='Edit report' data-inverted='' data-position='left center'>EDIT</a>";
                }
              }
            } else {
              var BtnEdit ="";
            }

            if(obj['result']['OTHER'][i]['date_sign']){
              const ArryDQ = obj['result']['OTHER'][i]['date_sign'].split(" ");
              var Signdate = moment(ArryDQ[0]).format('ddd, DD MMM YYYY');
              var ToolTip = "data-tooltip='"+IsNull(moment(obj['result']['OTHER'][i]['date_sign']).format('ddd, DD MMM YYYY HH:mm:ss'))+"' data-position='left center'";
            } else {
              var Signdate = '';
              var ToolTip = '';
            }

            if(obj['result']['OTHER'][i]['download_id']){
              if(obj['result']['OTHER'][i]['report_doc']){
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['OTHER'][i]['download_id']+"'><i class='download link icon'></i></span>"+obj['result']['OTHER'][i]['report_doc'];
              } else {
                var Doc = "<span class='DownloadDoc' iddwn='"+obj['result']['OTHER'][i]['download_id']+"'><i class='download link icon'></i> Link Report</span>";
              }
            } else {
              var Doc = obj['result']['OTHER'][i]['report_doc'];
            }


            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcell"+cond+"'><b>"+sect+"</b></td>"+
              "<td>"+obj['result']['OTHER'][i]['result']+"</td>"+
              "<td>"+Doc+"</td>"+
              "<td>"+obj['result']['OTHER'][i]['pic_checker']+"</td>"+
              "<td "+ToolTip+">"+Signdate+"</td>"+
              "<td class='collapsing'>"+BtnEdit+"</td>"+
              "</tr>"
            );
          }
        } else {
          if(DSect == "OTHER" && obj['ihp'].progress==='DESIGNER'){
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>OTHER</b></td>"+
              "<td colspan='4'></td>"+
              "<td><a class='ui mini teal label BtnAddNewReport' addid='"+id_ihpx+"' addsect='OTHER' Thp='"+b+"' Lmk='"+c+"' addidincre='1' data-tooltip='Add new report' data-inverted='' data-position='left center'>ADD</a></td>"+
              "</tr>"
            );
          } else {
            $("#TblIHPFinalResult").append(
              "<tr>"+
              "<td class='ihpfinalresultcellfirst'><b>OTHER</b></td>"+
              "<td colspan='4'></td>"+
              "<td></td>"+
              "</tr>"
            );
          }
        }

        $("#TblIHPFinalResult").append(
          "</tbody>"
        );


        $(".BtnAddNewReport").on("click", function(){
          $(".WindowAddNewReport").modal({ autofocus: false, closable : false, }).modal("show");
          var IncNum = $(this).attr('addidincre');
          var PICChecker = $(this).attr('addpic');
          var IdIhp = $(this).attr('addid');
          var Section = $(this).attr('addsect');
          var Thp = $(this).attr('Thp');
          var Lmk = $(this).attr('Lmk');
          $("#IncNum").val(IncNum);
          $("#PICChecker").val(PICChecker);
          $("#IdIhp").val(IdIhp);
          $("#Section").val(Section);
          $("#Tahap").val(Thp);
          $("#LocalMaker").val(Lmk);
          console.log("1. "+Lmk);
        });

        $(".BtnEditReport").on("click", function(){
          $('.ResetInput').val('');
          $(".WindowEditReport").modal({ autofocus: false, closable : false, }).modal("show");
          var id_ihpx = $(this).attr('eid');
          var id_item = $(this).attr('iditem');
          var thp_item = $(this).attr('Thp');
          var sect = $(this).attr('sect');
          // var tahap = $(this).attr('Thp');
          var Lkm = $(this).attr('Lmk');
          LoadDetailReport(id_ihpx,sect,id_item,thp_item,Lkm);
        });

        $(".DownloadDoc").on("click", function () {
          var iddwn = $(this).attr('iddwn');
          // window.open('../RND_BackEnd/backend_mpp/download/'+iddwn);
          var EncId = Ucrypt.encrypt(iddwn, NonceValue);
          window.location.href = "./?link=mppdownload&i=" + EncId;
        });

        $(".BtnSignReport").on("click", function () {
          var id_item = $(this).attr('iditem');
          var idihp = $(this).attr('eid');
          var Thpihp = $(this).attr('Thp');
          var LocMaker = $(this).attr('Lmk');
          $.ajax({
            type: "POST",
            url     : '../RND_BackEnd/backend_mpp/ihp-evaluation/sign-result',
            headers: {
              user  : VUserName,
              token : VToken
            },
            data: {   
              id        : id_item,
              username  : VUserName,
              tahap     : Thpihp,
              localmaker: LocMaker
            },
            cache: false,
            success: function (response) {
              var obj = JSON.parse(response);
              if(isEmpty(obj)) {
                IsResponseEmptyObj();
              } else if(obj) {
                if (obj.status == false){
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  LoadFinalResult(idihp,Thpihp,LocMaker)
                }
              } else {
                IsResponseErrorElse();
              }
            },
            error: function () {
              IsTimeOut(LogoutProtect);
            },
          });
        });

        

      }
      
    },

    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


function LoadDetailReport(id,sect,iditem,thp,lm){
  $.ajax({
    type    : "POST",
    url     : `../RND_BackEnd/backend_mpp/ihp/final-result/load/`+id,
    headers : {
      user  : VUserName,
      token : VToken
    },
    data: {
      tahap : thp,
      localmaker : lm
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if(obj) {
        if (obj.status == false){
          IsResponseFalse(obj.message);
        } else {
          var len = obj['result'][sect].length;
          var pic_checker = obj['result'][sect][len-1]['pic_checker']
          $('#EditReportResult').val(obj['result'][sect][len-1]['result']);
          $('#EditReportNoDoc').val(obj['result'][sect][len-1]['report_doc']);
          $('#EditReportIdItem').val(iditem);
          $('#EditIncNum').val(len);
          $('#EditPICChecker').val(pic_checker);
          $('#EditIdIhp').val(id);
          $('#EditSection').val(sect);
          $('#EditTahap').val(thp);
          $('#EditLocalMaker').val(lm);
        }
      } else {
        IsResponseErrorElse();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}


$("#BtnSaveEditResult").on("click", function () {
  var file_data = $("#EditReportFile").prop("files")[0];
  var report    = $('#EditReportNoDoc').val();
  var result    = $('#EditReportResult').val();
  var id_ihp    = $('#EditIdIhp').val();
  var thp_ihp   = $('#EditTahap').val();
  var local_maker = $('#EditLocalMaker').val();
  var sect    = $('#EditSection').val();
  var id      = $('#EditIncNum').val();
  var pic     = $('#EditPICChecker').val();

  var form_data = new FormData();
  form_data.append("id_ihp", id_ihp);
  form_data.append("bagian", sect);
  form_data.append("no", id);
  form_data.append("report_doc", report);
  form_data.append("result", result);
  form_data.append("tahap", thp_ihp);
  form_data.append("localmaker", local_maker);
  form_data.append("username", VUserName);
  if(file_data){
    form_data.append("file", file_data);
  }
  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `../RND_BackEnd/backend_mpp/ihp-evaluation/edit-result`,
    headers : {
      user  : VUserName,
      token : VToken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        IsResponseFalse(obj.message);
      } else {
        IsResponseTrue(obj.message);
        $(".WindowEditReport").modal("hide");
        $(".WindowAddEditIHP").modal("show");
        LoadFinalResult(id_ihp,thp_ihp,local_maker);
        TableListFunc();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});

$("#BtnSaveAddResult").on("click", function () {
  var file_data = $("#AddReportFile").prop("files")[0];
  var report    = $('#AddReportNoDoc').val();
  var result    = $('#AddReportResult').val();
  var id        = $('#IncNum').val();
  var pic       = $('#PICChecker').val();
  var id_ihp    = $('#IdIhp').val();
  var sect      = $('#Section').val();
  var tahap     = $('#Tahap').val();
  var local_maker = $('#LocalMaker').val();
  var form_data = new FormData();
  console.log(local_maker);
  form_data.append("id_ihp", id_ihp);
  form_data.append("bagian", sect);
  form_data.append("no", id);
  form_data.append("report_doc", report);
  form_data.append("result", result);
  // form_data.append("pic_checker", pic);
  form_data.append("tahap", tahap);
  form_data.append("localmaker", local_maker);
  form_data.append("username", VUserName);
  if(file_data){
    form_data.append("file", file_data);
  }
  $.ajax({
    type: "POST",
    dataType: "text",
    contentType: false,
    processData: false,
    url: `../RND_BackEnd/backend_mpp/ihp-evaluation/edit-result`,
    headers : {
      user  : VUserName,
      token : VToken,
    },
    data: form_data,
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (obj.status == false) {
        IsResponseFalse(obj.message);
      } else {
        IsResponseTrue(obj.message);
        $(".WindowAddNewReport").modal("hide");
        $(".WindowAddEditIHP").modal("show");
        LoadFinalResult(id_ihp,tahap,local_maker);
        TableListFunc();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});

$("#BtnDeleteResult").on("click", function () {
  var id_ihp    = $('#EditIdIhp').val();
  var sect      = $('#EditSection').val();
  var id        = $('#EditIncNum').val();

  Swal.fire({
    title: "<h3>Hapus Report ini?</h3>",
    text: "Setelah klik Ya maka report akan dihapus dan tidak bisa dikembalikan lagi.",
    confirmButtonText: "Ya",
    showCancelButton: true,
  }).then((result) => {
    if (result.value) {
      $.ajax({
        type: "POST",
        url     : '../RND_BackEnd/backend_mpp/ihp-evaluation/delete-result',
        headers: {
          user  : VUserName,
          token : VToken
        },
        data: {   
          id_ihp: id_ihp,
          bagian: sect,
          no: id,
          username    : VUserName,
        },
        cache: false,
        success: function (response) {
          var obj = JSON.parse(response);
          if(isEmpty(obj)) {
            IsResponseEmptyObj();
          } else if(obj) {
            if (obj.status == false){
              IsResponseFalse(obj.message);
            } else {
              IsResponseTrue(obj.message);
              $(".WindowEditReport").modal("hide");
              TableListFunc();
            }
          } else {
            IsResponseErrorElse();
          }
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });
    }
  });
});



$(document).ready(function () {

  TableListFunc();

  $("#TableList").on("click", ".BtnEditEvalIHP", function(){
    var idihp = $(this).attr('eid');
    var thpihp = $(this).attr('thp');
    var lclmkr = $(this).attr('lmk');
    $(".WindowAddEditIHP").modal({ autofocus: false, closable : false, }).modal("show");
    LoadFinalResult(idihp,thpihp,lclmkr);

  });

  $("#TableList").on("click", ".BtnConfirmEvalIHP", function(){
    var eid  = $(this).attr('eid');
    ConfirmEvalIHP(eid);
  });


  $(".CloseModal").on("click", function(){
    $(".WindowAddEditIHP").modal("hide");
    $(".WindowAddNewReport").modal("hide");
    $(".WindowEditReport").modal("hide");
  });


  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_ihpmpp").on("keyup", function () {
    var FilterCari = $("#fcari_ihpmpp").val();
    var FilterTahun = $("#fthn_ihpmpp").val();
    var FilterStatus = $("#fsts_ihpmpp").val();
    var FiterArry = [FilterCari, FilterTahun, FilterStatus];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPIHP", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fthn_ihpmpp, #fsts_ihpmpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_ihpmpp").val();
      var FilterTahun = $("#fthn_ihpmpp").val();
      var FilterStatus = $("#fsts_ihpmpp").val();
      var FiterArry = [FilterCari, FilterTahun, FilterStatus];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPIHP", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var YearNow = d.getFullYear();
    $("#fcari_ihpmpp").val("");
    $("#fthn_ihpmpp").dropdown("set selected", YearNow);
    $("#fsts_ihpmpp").dropdown("set selected", "ALL");
    var FiterArry = ["", YearNow, "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPIHP", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

});