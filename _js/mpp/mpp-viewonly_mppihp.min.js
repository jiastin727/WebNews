$('.ui.dropdown.Fin').dropdown({
  direction : 'upward'
});

const LogoutProtect = false;

var GetCookiePICMPP = decodeURIComponent(getCookie("CooPICMPP"));

function TableListFunc() {

  var NewDate = new Date();
  var YearNow = NewDate.getFullYear();

  var JsonFilter = getCookie('FilterMPPIHPList');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var TahunF    = ArrayF[1];
    var NamaF     = "ALL";
    var StatusF   = ArrayF[3];
  } else {
    var SearchF   = "";
    var TahunF    = YearNow;
    var NamaF     = "ALL";
    var StatusF   = "ALL";
  }

  if (SearchF) {
    $("#fcari_ihpmpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahunF) {
    $("#fthn_ihpmpp").dropdown("set selected", TahunF);
    var TahunFStart = TahunF;
  } else {
    var TahunFStart = YearNow;
  }
  if (NamaF) {
    $("#fmn_ihpmpp").dropdown("set selected", NamaF);
    var NamaFStart = NamaF;
  } else {
    var NamaFStart = "ALL";
  }
  if (StatusF) {
    $("#fsts_ihpmpp").dropdown("set selected", StatusF);
    var StatusFStart = StatusF;
  } else {
    var StatusFStart = "ALL";
  }


  var FiterArry = [SearchFStart, TahunFStart, NamaFStart, StatusFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPIHPList", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],      
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    fixedColumns:   {
      leftColumns: 3
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        name  : 'id',
        render: function (data) {
         
          return `<span class="BtnEditIHP" eid="${data['id']}" thp="${data['tahap']}" lkm="${data['localmaker']}" data-tooltip="Edit IHP" data-inverted="" data-position="right center"><i class="tasks link circular blue icon "></i></span>`;
          
        },
      },
      { data  : 'no_ihp' },
      { data  : 'description' },
      { data  : 'drawing_number' },
      // { data  : 'vendor' },
      { data: null,
        render: function (data) {
          return trimVendor(data['vendor']);
        },
      },
      { data  : 'manufacture' },
      { data  : 'reff_pin' },
      { data  : 'jenis_project' },
      { data  : 'chassis' },
      { data: null,
        render: function (data) {
          return data['tahap']+' / '+data['localmaker'];
        },
      },
      { data  : 'pic_mpp' },
      { data  : 'head_of' },
      { data  : 'negotiator' },
      { data  : 'sourcing_operator' },
      { data  : 'created_at' },
      { data  : 'final_result' },
      { data  : 'status' },
      { data  : 'progress' },

    ],

    createdRow: function (row, data, index) {

      //WARNA OWNER & PLACE IN
      if (data['progress'] === "PLACEIN") {
        $(row).find("td").css("color", ColorIHPPlacein);
      }

      if (data['progress'] === "APPROVED") {
        $(row).find("td").css("color", ColorOwner);
      }

      //WARNA FINISH & CLOSE
      if (
        data['status'] == "FINISH" ||
        data['status'] == "CLOSE" ||
        data['progress'] == "IHP" ||
        data['progress'] == "IHP KEMBALI"
      ) {
        $(row).find("td").css("color", ColorFinish);
      }

      //WARNA CANCEL
      if (data['status'] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }

      //WARNA REQUEST APPROVAL SHD
      if (
        data['status'] == "REQ-APPROVE" ||
        data['status'] == "REQ-CLOSE" ||
        data['status'] == "REQ-CANCEL"
      ) {
        $(row).addClass("needapprove");
      }
    },
    
    ajax      : {
      url     : '../RND_BackEnd/backend_mpp/ihp/load/designer',
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch   : SearchFStart,
        FYear     : TahunFStart,
        FNama     : NamaFStart,
        FStatus   : StatusFStart,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });
}

function trimVendor(s) {
  while (s.substr(0,1) == '0' && s.length>1) { s = s.substr(1,9999); }
  return s;
}

function MDOprConfirm(){
  $("#BtnMDOprConfirm").on("click", function () {
    var id_ihp = $("#DetailIdIHP").val();
    var thp_ihp = $("#DetailTahap").text();
    var lkm_ihp = $("#DetailLkmIHP").val();
    Swal.fire({
      title: "<h3><i class='exclamation disabled large triangle icon'></i></h3>",
      text: 'Terima IHP dan Sample Material ini?',
      confirmButtonText: "Ya",
      showCancelButton: true,
    }).then((result) => {
      if (result.value) {
        $.ajax({
          type    : "POST",
          url     : `../RND_BackEnd/backend_mpp/ihp/confirm-mdoperator`,
          headers : {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id_ihp   : id_ihp,
            username : VUserName,
            tahap    : thp_ihp,
            localmaker : lkm_ihp
          },
          cache: false,
          success: function (response) {
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                TableListFunc();
                LoadDetailIHP(id_ihp,thp_ihp,lkm_ihp);
                $(".WindowAddEditIHP").modal("hide");
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      }
    });
  });
}


function LoadDetailIHP(a,b,c){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/ihp/load-item/'+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: {   
      tahap : b,
      localmaker : c
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      var tglihpkembali = moment(obj.tgl_ihp_kembali, "YYYY-MM-DD");
      var tglcurrent = moment().startOf('day');
      if(tglihpkembali.diff(tglcurrent, 'days') < 0){
        var targetstatus = '( '+tglihpkembali.from(tglcurrent)+' )';
      } else {
        var targetstatus = '( '+moment.duration(tglihpkembali.diff(tglcurrent)).asDays()+' days left )';
      }
      $('#DetailNoIHP').text(obj.no_ihp);
      $('#DetailNoMPP').text(obj.no_mpp);
      $('#DetailDate').text(obj.created_at);
      $('#DetailPICIHP').text(obj.pic_mpp);
      $('#DetailDesc').text(obj.description);
      $('#DetailNoGudang').text(obj.reff_pin);
      $('#DetailHeadOf').text(obj.head_of);
      $('#DetailVendor').text(obj.vendor);
      $('#DetailDrawingLoc').text(obj.drawing_loc);
      $('#DetailNego').text(obj.negotiator);
      $('#DetailNoDN').text(obj.drawing_number);
      $('#DetailOperator').text(obj.sourcing_operator);
      $('#DetailJenisPrj').text(obj.jenis_project);
      $('#DetailFinalResult').text(obj.final_result);
      $('#DetailChs').text(obj.chassis);
      $('#DetailTahap').text(obj.tahap);
      $('#DetailQty').text(obj.qty_sample);
      $('#DetailTarget').text(moment(obj.tgl_ihp_kembali).format('ddd, DD MMM YYYY'));
      $('#TargetLeft').text(targetstatus);
      $('#DetailNote').text(obj.msc_note);
      $('#DetailIdIHP').val(obj.id);
      $('#TanggalInputSample').text(obj.tanggal_input_sample);
      $('#TanggalInputSpec').text(obj.tanggal_input_spec);
      $('#DetailLkmIHP').val(c);

      if(obj.status ==="ACTIVE" && obj.progress ==="PLACEIN"){
        $('#BtnMDOprConfirm').show();
        $('#BtnSave').show();
        $('#BtnMDOprConfirm').removeClass('disabled');
        $('#BtnSave').addClass('disabled');
        $('#FeatureIHPReturn').html('');
      } else if(obj.status ==="ACTIVE" && obj.progress ==="APPROVED"){
        $('#BtnMDOprConfirm').show();
        $('#BtnSave').show();
        $('#BtnMDOprConfirm').addClass('disabled');
        $('#BtnSave').removeClass('disabled');
        
        if(IsNotNullZero(obj.tanggal_input_sample) !=="" && IsNotNullZero(obj.tanggal_input_spec) !==""){
          $('#FeatureIHPReturn').html('<div id="BtnIHPReturn" class="ui teal small compact button right floated" data-tooltip="IHP dikembalikan ke MSC Operator" data-inverted="" data-position="top right">IHP Return</div>');
        } else {
          $('#FeatureIHPReturn').html('');
        }

      } else {
        $('#BtnMDOprConfirm').hide();
        $('#BtnSave').hide();
        $('#FeatureIHPReturn').html('');
      }

      IHPReturn();

    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}



$(document).ready(function () {

  TableListFunc();

  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide: true,
    weekStart: 1
  });


  $("#TableList").on("click", ".BtnEditIHP", function(){
    var eid  = $(this).attr('eid');
    var thp  = $(this).attr('thp');
    var lkm  = $(this).attr('lkm');
    $(".WindowAddEditIHP").modal({ autofocus: false, closable : false, }).modal("show");
    LoadDetailIHP(eid,thp,lkm);
  });

  $(".CloseModal").on("click", function(){
    $(".WindowAddEditIHP").modal("hide");
  });

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_ihpmpp").on("keyup", function () {
    var FilterCari = $("#fcari_ihpmpp").val();
    var FilterTahun = $("#fthn_ihpmpp").val();
    var FilterNama = $("#fmn_ihpmpp").val();
    var FilterStatus = $("#fsts_ihpmpp").val();
    var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterStatus];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPIHPList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fthn_ihpmpp, #fmn_ihpmpp, #fsts_ihpmpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_ihpmpp").val();
      var FilterTahun = $("#fthn_ihpmpp").val();
      var FilterNama = $("#fmn_ihpmpp").val();
      var FilterStatus = $("#fsts_ihpmpp").val();
      var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterStatus];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPIHPList", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var YearNow = d.getFullYear();
    $("#fcari_ihpmpp").val("");
    $("#fthn_ihpmpp").dropdown("set selected", YearNow);
    $("#fmn_ihpmpp").dropdown("set selected", "ALL");
    $("#fsts_ihpmpp").dropdown("set selected", "ALL");
    var FiterArry = ["", YearNow, "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPIHPList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", YearNow, "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });



});