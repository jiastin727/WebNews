
const LogoutProtect = false;

var GetCookieAllDesMD = decodeURIComponent(getCookie("CooAllDesMD"));
var GetCookieHOMD = decodeURIComponent(getCookie("CooHOMD"));
var GetCookieNego = decodeURIComponent(getCookie("CooNego"));
var GetCookieOpr = decodeURIComponent(getCookie("CooOpr"));
var ArryAllDesMD   = GetCookieAllDesMD.split(", ");

function TableListFunc() {

  var JsonFilter = getCookie('FilterSchTrialLocal');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF = ArrayF[0];
    var TahapF  = ArrayF[1];
    var SalesContractF = ArrayF[2];
  } else {
    var SearchF   = "";
    var TahapF    = "ALL";
    var SalesContractF = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahapF) {
    $("#ftahap_mpp").dropdown("set selected", TahapF);
    var TahapFStart = TahapF;
  } else {
    var TahapFStart = "ALL";
  }
  if (SalesContractF) {
    $("#fsales_mpp").dropdown("set selected", SalesContractF);
    var SalesContractFStart = SalesContractF;
  } else {
    var SalesContractFStart = "ALL";
  }


  var FiterArry = [SearchFStart, TahapFStart, SalesContractFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterSchTrialLocal", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'>" +
      ">" +
      ">",
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    paging      : false,
    fixedColumns:   {
      leftColumns: 5
    },
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          return `<span class="BtnEditTrialLocal clicklink" eid="${data['id']}" data-tooltip="Edit Item Trial Local" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
        },
      },
      { data  : 'trial' },
      { data  : 'drawing_loc' },
      { data  : 'drawing_number' },
      { data  : 'description_dn' },
      { data  : 'sales_contract' },
      { data  : 'phj' },
      { data  : 'description_phj' },
      { data  : 'tonnage_spec' },
      { data  : 'tonnage_actual' },
      { data  : 'vendor_local' },
      { data  : 'est_qty' },
      { data  : 'second_process' },
      { data  : 'planning' },
      { data  : 'actual' },
      { data  : 'ihp' },
      { data  : 'note' }
    ],
    createdRow: function (row, data, index) {
      //WARNA FREEZE LEFT COLUMNS 
      $(row).find("td:eq(4)").css("border-right", "inset");
      $(row).find("td:eq(4)").css("border-right-color", ColorBorderFreeze);

      if (data['buat_ihp'] === "YES") {
        $(row).find("td").css("color", ColorTMakerIHP);
      }
      
    },
    columnDefs: [
      {
        targets: [13,14],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YY');
          } else {
            return '';
          }
        }
      },
      {
        className: "right aligned",
        targets: [13,14]
      },
    ],
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/load/`+IdMPP,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch    : SearchFStart,
        FTahap     : TahapFStart,
        FSalesContract : SalesContractFStart,
      },
      error   : function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}



function LoadEditItemTrialLocal(a){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/load-item/`+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      $("#TahapTrialLocal").dropdown("clear");
      $("#TahapTrialLocal").dropdown("set selected",obj.trial);
      $('#DNTrialLocal').val(obj.drawing_number);
      $('#DrwLocTrialLocal').val(obj.drawing_loc);
      $('#DescTrialLocal').val(obj.description_dn);
      $('#VendorTrialLocal').val(obj.vendor);
      $('#SCTrialLocal').val(obj.sales_contract);
      $('#PHJTrialLocal').val(obj.phj);
      $('#DescPHJTrialLocal').val(obj.description_phj);
      $('#TonnageSpecTrialLocal').val(obj.tonnage_spec);
      $('#TonnageActualTrialLocal').val(obj.tonnage_actual);
      $('#EstQtyTrialLocal').val(obj.est_qty);
      $('#2ndProcessTrialLocal').val(obj.second_process);
      $('#PlanningTrialLocal').val(obj.planning);
      $('#ActualTrialLocal').val(obj.actual);
      $("#IHPTrialLocal").dropdown("clear");
      $("#IHPTrialLocal").dropdown("set selected",obj.ihp);
      $('#NoteTrialLocal').val(obj.note);
      $('#IdTrialLocal').val(obj.id);

      $('#AddEditCompare').val(CryptoJS.MD5(obj.trial+obj.drawing_number+obj.phj+obj.description_phj+obj.tonnage_spec+obj.tonnage_actual+obj.vendor+obj.est_qty+obj.second_process+obj.planning+obj.actual+obj.ihp+obj.note).toString());

      if(obj.trial !=='' && obj.drawing_number !==''){
        $(".CreateIHPField").show();
      } else {
        $(".CreateIHPField").hide();
      }

      AutocompleteDN();
      AutocompleteVendor();
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function AutocompleteDN(){
  $(".ui.search.dn").search({
    minCharacters: 1,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/search-dn?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    },
    onSelect: function (response){
      $('#DrwLocTrialLocal').val(response.drawing_loc);
      $('#DescTrialLocal').val(response.desc);
      $('#SCTrialLocal').val(response.sales_contract);
      $('#TonnageSpecTrialLocal').val(response.tonnage_ton);
    },
  });
}

function AutocompleteVendor(){
  $(".ui.search.vendor").search({
    minCharacters: 3,
    apiSettings: {
      // url: '../RND_BackEnd/backend_mpp/schedule-trial/trial-local/search-vendor?q={query}',
      url: '../RND_BackEnd/backend_mpp/master-material/search-vendor?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    }
  });
}

$("#SaveAddEditTrialLocal").on("click", function (e) {

  var AddEditCompare  = $('#AddEditCompare').val();
  var IdTrialMaker    = $("#IdTrialLocal").val();
  
  // $.ajax({
  //   type: "POST",
  //   url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/load-item/`+IdTrialMaker,
  //   headers: {
  //     user  : VUserName,
  //     token : VToken
  //   },
  //   cache: false,
  //   success: function (data){
  //     var obj = JSON.parse(data);
  //     var LoadNewItem = CryptoJS.MD5(obj.trial+obj.drawing_number+obj.phj+obj.description_phj+obj.tonnage_spec+obj.tonnage_actual+obj.vendor+obj.est_qty+obj.second_process+obj.planning+obj.actual+obj.ihp+obj.note).toString();

  //     if (AddEditCompare !== LoadNewItem){

  //       IsResponseFalse('Gagal Simpan, karena data yang anda edit sudah ada perubahan terbaru oleh rekan lain. Silakan Refresh halaman dan ulangi editing di field yang dimaksud');

  //     } else {

        $.ajax({
          type    : "POST",
          url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-local/edit-item`,
          headers : {
            user  : VUserName,
            token : VToken
          },
          data: {   
            id              : $("#IdTrialLocal").val(),
            id_mpp          : IdMPP,
            username        : VUserName,
            trial           : $("#TahapTrialLocal").val(),
            drawing_loc     : $("#DrwLocTrialLocal").val(),
            drawing_number  : $("#DNTrialLocal").val(),
            description_dn  : $("#DescTrialLocal").val(),
            sales_contract  : $("#SCTrialLocal").val(),
            phj             : $("#PHJTrialLocal").val(),
            description_phj : $("#DescPHJTrialLocal").val(),
            tonnage_spec    : $("#TonnageSpecTrialLocal").val(),
            tonnage_actual  : $("#TonnageActualTrialLocal").val(),
            vendor_local    : $("#VendorTrialLocal").val(),
            est_qty         : $("#EstQtyTrialLocal").val(),
            second_process  : $("#2ndProcessTrialLocal").val(),
            planning        : $("#PlanningTrialLocal").val(),
            actual          : $("#ActualTrialLocal").val(),
            ihp             : $("#IHPTrialLocal").val(),
            note            : $("#NoteTrialLocal").val(),
            localmaker      : "LOCAL"
          },
          cache: false,
          success: function (response){
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              IsResponseEmptyObj();
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                $(".WindowAddEditItemTrialLocal").modal("hide");
                TableListFunc();
              }
            } else {
              IsResponseErrorElse();
            }
          },
          error: function () {
            IsTimeOut(LogoutProtect);
          },
        });
      // }
    
  //   },
  //   error: function () {
  //     IsTimeOut(LogoutProtect);
  //   },
  // });

 
});


function LoadDataSign(){
  //Load Data Sign untuk proteksi ketika negosiator belum sign maka edit akan di tolak.
  $.ajax({
    type: "POST",
    url: `../RND_BackEnd/backend_mpp/sign/load/`+IdMPP,
    headers: {
      user: VUserName,
      token: VToken
    },
    cache: false,
    success: function (data) {
      var obj = JSON.parse(data);
      if(obj.DateSignNego !==null && obj.SignByNego !== null ){
        $('#FeaturesAddSchTrialx').html('<div class="ui small compact blue labeled icon button" id="AddNewTrial" data-tooltip="Add new item data trial" data-position="top left" data-inverted=""><i class="plus circle icon"></i>Add New Item Data Trial</div>');
        TableListFunc();
      } else {
        $('#FeaturesAddSchTrialx').html('');
        TableListFunc();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

$(document).ready(function () {

  LoadDataSign();

  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide: true,
    weekStart: 1
  });

  $("#AddNewTrial").on("click", function (e) {
    $(".WindowAddEditItemTrialLocal").modal({ autofocus: false, closable : false, }).modal("show");
    $("#IdTrialLocal").val('');
    $(".resetvalue").val('');
    $(".resetdropdown").dropdown("clear");
    AutocompleteDN();
    AutocompleteVendor();
    $(".CreateIHPField").hide();
  });

  $("#TableList").on("click", ".BtnEditTrialLocal", function(){
    var eid  = $(this).attr('eid');
    $(".WindowAddEditItemTrialLocal").modal({ autofocus: false, closable : false, }).modal("show");
    LoadEditItemTrialLocal(eid);
  });

  $(".CloseModal").on("click", function(){
    $(".WindowAddEditItemTrialLocal").modal("hide");
  });

  
  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterTahap = $("#ftahap_mpp").val();
    var FilterSales = $("#fsales_mpp").val();
    var FiterArry = [FilterCari, FilterTahap, FilterSales];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialLocal", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#ftahap_mpp, #fsales_mpp, #fvendor_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterTahap = $("#ftahap_mpp").val();
      var FilterSales = $("#fsales_mpp").val();
      var FiterArry = [FilterCari, FilterTahap, FilterSales];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterSchTrialLocal", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    $("#fcari_mpp").val("");
    $("#ftahap_mpp").dropdown("set selected", "ALL");
    $("#fsales_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialLocal", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });


});