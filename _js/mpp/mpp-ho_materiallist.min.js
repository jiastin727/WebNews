const LogoutProtect = false;

function TableListFunc() {

  var JsonFilter = getCookie('FilterMPPMaterialList');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var MatTypeF  = ArrayF[1];
  } else {
    var SearchF   = "";
    var MatTypeF  = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (MatTypeF) {
    $("#fmaterialtype_mpp").dropdown("set selected", MatTypeF);
    var MatTypeFStart = MatTypeF;
  } else {
    var MatTypeFStart = "ALL";
  }
  

  var FiterArry = [SearchFStart, MatTypeFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPMaterialList", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],     
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    scrollCollapse: true,
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          return `<span class="BtnEditMat clicklink" eid="${data['Id']}" data-tooltip="Edit Material" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
        },
      },
      { data  : 'MaterialNum' },
      { data  : 'Description' },
      { data  : 'VendorMatNum' },
      { data  : 'MaterialType' },
      { data  : 'Color' },
      { data  : 'ColorPercent' },
      { data  : 'BasedResin' },
      { data  : 'ColorVendor' },
      { data  : 'Price' },
      { data  : 'Currency' },
      { data  : 'UpdatePrice' },
      // { data: null,
      //   render: function (data) {
      //     return `<span class="BtnHistoryPrice" eid="${data['Id']}" mnum="${data['MaterialNum']}" mdes="${data['Description']}"  data-tooltip="Last update price, klik untuk melihat history" data-inverted="" data-position="right center">${data['UpdatePrice']}</span>`;
      //   },
      // },
      { data  : 'Note' },
    ],
    columnDefs: [
      { render: function ( data, type, row ) {
        if(row['Currency'] !== 'IDR'){
          return data ? $.number(data,2,',','.') : '';//$.number
        } else {
          return data ? $.number(data,0,',','.') : '';//$.number
        }
        },
        targets: [ 9 ]  
      },
      {
        targets: [11],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            
            return momentObj.format('DD MMM YYYY');
            
          } else {
            return '';
          }
        }
      },
      {
        className: "center aligned",
        targets: [10,11]
      },
      {
        className: "right aligned",
        targets: [9]
      },
    ],
   
    ajax      : {
      url     : `../RND_BackEnd/backend_mpp/master-material/load-list`,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch   : SearchFStart,
        FMaterialType : MatTypeFStart,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });
}


$("#SaveAddNewMaterial").click(function(){

  var MatNumber   = $("#AddMatNumber").val();
  var Descript    = $("#AddDescript").val();
  var VendorMat   = $("#AddVendorMat").val();
  var MatType     = $("#AddMatType").val();
  var Color       = $("#AddColor").val();
  var ColorPersen = $("#AddColorPersen").val();
  var ColorVendor = $("#AddColorVendor").val();
  var BasedResin  = $("#AddbasedResin").val();
  var Price       = $("#AddPrice").val();
  var Currency    = $("#AddCurrency").val();
  var Note        = $("#AddNote").val();

  $.ajax({
    type    : "POST",
    url     : `../RND_BackEnd/backend_mpp/master-material/create-material`,
    headers : {
      user  : VUserName,
      token : VToken
    },
    data: {
      MaterialNum  : MatNumber,
      Description  : Descript,
      VendorMatNum : VendorMat,
      MaterialType : MatType,
      Color        : Color,
      ColorPercent : ColorPersen,
      ColorVendor  : ColorVendor,
      BasedResin   : BasedResin,
      Price        : Price,
      Currency     : Currency,
      Note         : Note,
      Username     : VUserName
        },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if(obj) {
        if (obj.status == false){
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          $(".WindowAddNew").modal("hide");
          TableListFunc();
        }
      } else {
        IsResponseErrorElse();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});



function SaveEditmaterial(){
  $("#SaveEditNewMaterial").click(function(){
    var Id          = $("#EditId").val();
    var MatNumber   = $("#EditMatNumber").val();
    var Descript    = $("#EditDescript").val();
    var VendorMat   = $("#EditVendorMat").val();
    var MatType     = $("#EditMatType").val();
    var Color       = $("#EditColor").val();
    var ColorPersen = $("#EditColorPersen").val();
    var ColorVendor = $("#EditColorVendor").val();
    var BasedResin  = $("#EditBasedResin").val();
    var Price       = $("#EditPrice").val();
    var Currency    = $("#EditCurrency").val();
    var Note        = $("#EditNote").val();
    $.ajax({
      type    : "POST",
      url     : `../RND_BackEnd/backend_mpp/master-material/edit-material`,
      headers : {
        user  : VUserName,
        token : VToken
      },
      data: {
        Id  : Id,
        MaterialNum  : MatNumber,
        Description  : Descript,
        VendorMatNum : VendorMat,
        MaterialType : MatType,
        Color        : Color,
        ColorPercent : ColorPersen,
        ColorVendor  : ColorVendor,
        BasedResin   : BasedResin,
        Price        : Price,
        Currency     : Currency,
        Note         : Note,
        Username     : VUserName
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(response);
        if(isEmpty(obj)) {
          IsResponseEmptyObj();
        } else if(obj) {
          if (obj.status == false){
            IsResponseFalse(obj.message);
          } else {
            IsResponseTrue(obj.message);
            $(".WindowEdit").modal("hide");
            TableListFunc();
          }
        } else {
          IsResponseErrorElse();
        }
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });
}


function LoadDataMaterial(idx){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/master-material/load-item/`+idx,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      $('#EditId').val(obj.Id);
      $('#EditMatNumber').val(obj.MaterialNum);
      $('#EditDescript').val(obj.Description);
      $('#EditVendorMat').val(obj.VendorMatNum);
      $('#EditColor').val(obj.Color);
      $('#EditColorPersen').val(obj.ColorPercent);
      $('#EditColorVendor').val(obj.ColorVendor);
      $('#EditBasedResin').val(obj.BasedResin);
      $('#EditPrice').val(obj.Price);
      $('#EditNote').val(obj.Note);
      $('#EditUpdateprice').text(obj.UpdatePrice);

      $("#EditCurrency").dropdown("clear");
      $("#EditCurrency").dropdown("set selected",obj.Currency);

      // $('#EditCurrency').text(obj.Currency);
      $("#EditMatType").dropdown("clear");
      $("#EditMatType").dropdown("set selected",obj.MaterialType);
      
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });

}


function LoadhistoryPrice(idx){
  $.ajax({
    type: "POST",
    url     : `../RND_BackEnd/backend_mpp/master-material/load-history/`+idx,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      JmlDataA = obj.length;
      $("#TbodyHistPrice").empty();
      console.log(JmlDataA);
      for (a = 0; a < JmlDataA; a++) {
        $("#TbodyHistPrice").append(
          "<tr><td>"+
          obj[a]['Timestamp']+"</td><td class='center aligned'>"+
          obj[a]['Currency']+"</td><td class='right aligned'>"+
          obj[a]['Price']+"</td><td>"+
          obj[a]['UpdatedBy']+"</td><tr>"
        )
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });

}

function AutocompleteMaterial(){
  $(".ui.search.matnum").search({
    minCharacters: 1,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/master-material/search-material?q={query}',
      method: 'POST',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "material",
      description: "plan_desc",
    },
    onSelect: function (response){
      // console.log(response.material);
      $.ajax({
        type: "POST",
        url     : `../RND_BackEnd/backend_mpp/master-material/sap-data`,
        headers: {
          user  : VUserName,
          token : VToken
        },
        data: {
          material_num  : response.material,
        },
        cache: false,
        success: function (data){
          var obj = JSON.parse(data);
          $('#AddDescript').val(obj.mat_desc);
          $('#AddVendorMat').val(obj.vendor_mat_num);
          $('#AddPrice').val(obj.price);
          // $('#AddCurrency').text(obj.currency);
          $("#AddCurrency").dropdown("clear");
          $("#AddCurrency").dropdown("set selected",obj.currency);
          $('#AddlastUpdatePrice').text(obj.price_update);
          
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });

    },
  });
}


function AutocompleteVendor(){
  $(".ui.search.vendor").search({
    minCharacters: 3,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/master-material/search-vendor?q={query}',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "id",
      description: "desc",
    }
  });
}

function AutocompleteMaterialEdit(){
  $(".ui.search.matnum2").search({
    minCharacters: 1,
    apiSettings: {
      url: '../RND_BackEnd/backend_mpp/master-material/search-material?q={query}',
      method: 'POST',
      beforeXHR: function (xhr) {
        xhr.setRequestHeader('user', VUserName);
        xhr.setRequestHeader('token', VToken);
        return xhr;
      },
    },
    fields: {
      results: "data",
      title: "material",
      description: "plan_desc",
    },
    onSelect: function (response){
      $.ajax({
        type: "POST",
        url     : `../RND_BackEnd/backend_mpp/master-material/sap-data`,
        headers: {
          user  : VUserName,
          token : VToken
        },
        data: {
          material_num  : response.material,
        },
        cache: false,
        success: function (data){
          var obj = JSON.parse(data);
          $('#EditDescript').val(obj.mat_desc);
          $('#EditVendorMat').val(obj.vendor_mat_num);
          $('#EditPrice').val(obj.price);
          $("#EditCurrency").dropdown("clear");
          $("#EditCurrency").dropdown("set selected",obj.currency);
          $('#EditUpdateprice').text(obj.price_update);
          $('#EditColorVendor').val(obj.color_vendor);
        },
        error: function () {
          IsTimeOut(LogoutProtect);
        },
      });
    },
  });
}


$(document).ready(function () {

  TableListFunc();
  SaveEditmaterial();

  $("#AddNewMaterial").on("click", function(){
    $(".WindowAddNew").modal({ autofocus: false, closable : false, }).modal("show");
    $(".resetvalue").val('');
    AutocompleteMaterial();
    AutocompleteVendor();
  });


  $("#SyncMaterial").on("click", function(){
    $.ajax({
      type: "GET",
      url     : `../RND_BackEnd/backend_mpp/master-material/update-data`,
      headers: {
        user  : VUserName,
        token : VToken
      },
      cache: false,
      beforeSend: function(){
        Swal.fire({
          text: 'Syncronize price with SAP data...',
          // timer: 20000,
          showConfirmButton: false,
          allowOutsideClick: false
        });
      },
      success: function (data){
        IsResponseTrue("Done");
        TableListFunc();
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });


  $("#TableList").on("click", ".BtnEditMat", function(){
    var idx = $(this).attr('eid');
    $(".WindowEdit").modal({ autofocus: false, closable : false, }).modal("show");
    LoadDataMaterial(idx);
    AutocompleteMaterialEdit();
    AutocompleteVendor();
  });


  $("#TableList").on("click", ".BtnHistoryPrice", function(){
    var idx = $(this).attr('eid');
    var mnum = $(this).attr('mnum');
    var mdes = $(this).attr('mdes');
    $(".WindowHistoryPrice").modal({ autofocus: false, closable : false, }).modal("show");
    LoadhistoryPrice(idx);
    $('#HistMatNum').text(mnum);
    $('#HistMatDes').text(mdes);
  });

  $(".CloseModal").on("click", function(){
    $(".WindowAddNew").modal("hide");
    $(".WindowEdit").modal("hide");
    $(".WindowHistoryPrice").modal("hide");
  });

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterMatType = $("#fmaterialtype_mpp").val();
    var FiterArry = [FilterCari, FilterMatType];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPMaterialList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fmaterialtype_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterMatType = $("#fmaterialtype_mpp").val();
      var FiterArry = [FilterCari, FilterMatType];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPMaterialList", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    $("#fcari_mpp").val("");
    $("#fmaterialtype_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPMaterialList", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });

});