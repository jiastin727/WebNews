const LogoutProtect = false;

function TableListFunc() {

  var JsonFilter = getCookie('FilterSchTrialMakerAll');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF = ArrayF[0];
    var TahapF  = ArrayF[1];
    var SalesContractF = ArrayF[2];
    var VendorF = ArrayF[3];
  } else {
    var SearchF   = "";
    var TahapF    = "ALL";
    var SalesContractF = "ALL";
    var VendorF = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahapF) {
    $("#ftahap_mpp").dropdown("set selected", TahapF);
    var TahapFStart = TahapF;
  } else {
    var TahapFStart = "ALL";
  }
  if (SalesContractF) {
    $("#fsales_mpp").dropdown("set selected", SalesContractF);
    var SalesContractFStart = SalesContractF;
  } else {
    var SalesContractFStart = "ALL";
  }
  if (VendorF) {
    $("#fvendor_mpp").dropdown("set selected", VendorF);
    var VendorFStart = VendorF;
  } else {
    var VendorFStart = "ALL";
  }
  

  var FiterArry = [SearchFStart, TahapFStart, SalesContractFStart, VendorFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterSchTrialMakerAll", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
      buttons: [
        {
          text: "10",
          action: function (e, dt, node, config) {
            $("#TableList").DataTable().page.len(10).draw();
          },
        },
        {
          text: "25",
          action: function (e, dt, node, config) {
            $("#TableList").DataTable().page.len(25).draw();
          },
        },
        {
          text: "50",
          action: function (e, dt, node, config) {
            $("#TableList").DataTable().page.len(50).draw();
          },
        },
        {
          text: "100",
          action: function (e, dt, node, config) {
            $("#TableList").DataTable().page.len(100).draw();
          },
        },
        {
          text: "1000",
          action: function (e, dt, node, config) {
            $("#TableList").DataTable().page.len(1000).draw();
          },
        },
      ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    ordering    : true,
    scrollCollapse: true,
    scrollY     : '50vh',
    fixedColumns:   {
      leftColumns: 4
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data  : 'trial' },
      { data  : 'drawing_loc' },
      { data  : 'drawing_number' },
      { data  : 'description' },
      { data  : 'vendor' },
      { data  : 'sales_contract' },
      { data  : 'target_etd_sc' },
      { data  : 'target_eta_sc' },
      { data  : 'target_etd' },
      { data  : 'target_eta' },
      { data  : 'wos' },
      { data  : 'tracking_number' },
      { data  : 'actual_atd' },
      { data  : 'actual_ata' },
      { data  : 'uom' },
      { data  : 'buat_ihp' },
      { data  : 'result' },
      { data  : 'modification' },
      { data  : 'remark' },
    ],
    createdRow: function (row, data, index) {
      //WARNA FREEZE LEFT COLUMNS 
      // $(row).find("td:eq(3)").css("border-right", "inset");
      // $(row).find("td:eq(3)").css("border-right-color", ColorBorderFreeze);

      if (data['buat_ihp'] === "YES") {
        $(row).find("td").css("color", ColorTMakerIHP);
      }
      if (data['result'] === "NOT OK") {
        $(row).find("td").css("background-color", BgColorTMakerNOT);
      }
      if (data['result'] === "OK") {
        $(row).find("td").css("background-color", BgColorTMakerOK);
      }
    },
    columnDefs: [
      {
        targets: [6,7,8,9,12,13],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YY');
          } else {
            return '';
          }
        }
      },
      {
        className: "right aligned",
        targets: [6,7,8,9,12,13]
      },
    ],
    ajax      : {
      // url     : `${RestLocMPP}table_psc`,
      url     : `../RND_BackEnd/backend_mpp/schedule-trial/trial-maker/load-all`,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch    : SearchFStart,
        FTahap     : TahapFStart,
        FSalesContract : SalesContractFStart,
        FVendor    : VendorFStart,
      },
      error   : function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}


function DatePicker(IdTanggal) {
  var today = new Date();
  $(IdTanggal).calendar({
    type: "date",
    //monthFirst: false,
    //minDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return year + "-" + month + "-" + day;
      },
    },
  });
}

$(document).ready(function () {

  TableListFunc();

  $("#UploadItemTrial").on("click", function (e) {
    $(".WindowUploadItemTrial").modal({ autofocus: false, closable : false, }).modal("show");
  });

  $("#AddNewTrial").on("click", function (e) {
    $(".WindowAddEditItemTrialMaker").modal({ autofocus: false, closable : false, }).modal("show");
    // DatePicker(".CalHeader");
  });

  $("#TableList").on("click", ".BtnEditKebutuhan", function(){
    // var uid  = $(this).attr('id');
    $(".WindowAddEditItemTrialMaker").modal({ autofocus: false, closable : false, }).modal("show");
    // DatePicker(".CalHeader");

  });

  $(".CancelData").on("click", function(){
    $(".WindowAddEditIHP").modal("hide");
  });

  
  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterTahap = $("#ftahap_mpp").val();
    var FilterSales = $("#fsales_mpp").val();
    var FilterVendor = $("#fvendor_mpp").val();
    var FiterArry = [FilterCari, FilterTahap, FilterSales, FilterVendor];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialMakerAll", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#ftahap_mpp, #fsales_mpp, #fvendor_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterTahap = $("#ftahap_mpp").val();
      var FilterSales = $("#fsales_mpp").val();
      var FilterVendor = $("#fvendor_mpp").val();
      var FiterArry = [FilterCari, FilterTahap, FilterSales, FilterVendor];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterSchTrialMakerAll", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    $("#fcari_mpp").val("");
    $("#ftahap_mpp").dropdown("set selected", "ALL");
    $("#fsales_mpp").dropdown("set selected", "ALL");
    $("#fvendor_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterSchTrialMakerAll", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", "ALL", "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });

});