const LogoutProtect = false;

var GetCookiePICMPP = decodeURIComponent(getCookie("CooPICMPP"));
var GetCookieHOMD = decodeURIComponent(getCookie("CooHOMD"));

function TableListFunc() {
  var NewDate = new Date();
  var YearNow = NewDate.getFullYear();

  var JsonFilter = getCookie('FilterMPPAppMaker');
  var ArrayF = JSON.parse(JsonFilter);
  if(JsonFilter){
    var SearchF   = ArrayF[0];
    var TahunF    = ArrayF[1];
    var NamaF     = ArrayF[2];
    var SalesContractF = ArrayF[3];
  } else {
    var SearchF   = "";
    var TahunF    = YearNow;
    var NamaF     = "ALL";
    var SalesContractF = "ALL";
  }

  if (SearchF) {
    $("#fcari_mpp").val(SearchF);
    var SearchFStart = SearchF;
  } else {
    var SearchFStart = "";
  }
  if (TahunF) {
    $("#fthn_mpp").dropdown("set selected", TahunF);
    var TahunFStart = TahunF;
  } else {
    var TahunFStart = YearNow;
  }
  if (NamaF) {
    $("#fmn_mpp").dropdown("set selected", NamaF);
    var NamaFStart = NamaF;
  } else {
    var NamaFStart = "ALL";
  }
  if (SalesContractF) {
    $("#fsales_mpp").dropdown("set selected", SalesContractF);
    var SalesContractFStart = SalesContractF;
  } else {
    var SalesContractFStart = "ALL";
  }
  

  var FiterArry = [SearchFStart, TahunFStart, NamaFStart, SalesContractFStart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterMPPAppMaker", JsonFilter, 5);

  $("#TableList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#TableList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    scrollX     : true,
    ordering    : false,
    scrollCollapse: true,
    scrollY     : '50vh',
    fixedColumns:   {
      leftColumns: 3
    },
    pageLength  : 10,
    data        : [],
    language    : {
      sLengthMenu : "_MENU_",
      search      : "",
      searchPlaceholder: "Pencarian..",
      processing  : '<i class="spinner loading icon huge"></i>',
      info        : "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate    : {
        "first"   : "Awal",
        "last"    : "Akhir",
        "next"    : "<i class='chevron right icon'></i>",
        "previous": "<i class='chevron left icon'></i>"
      },
      infoEmpty   : "Tidak ada data",
      select  : {
        rows  : ""
      }
    },
    order     : [[1, "desc"]],
    columns   : [
      { data: null,
        render: function (data) {
          if(GetCookiePICMPP === DUser || GetCookieHOMD == DUser){
            return `<span class="BtnEditAppMold clicklink" eid="${data['id_item_mpp']}" data-tooltip="Edit data approval mold" data-inverted="" data-position="right center"><i class="pencil alternate link circular blue icon "></i></span>`;
          } else {
            return '';
          }
        },
      },
      { data  : 'drawing_loc' },
      { data  : 'description' },
      { data  : 'mold_maker' },
      { data  : 'designer' },
      { data  : 'pic_app_rd' },
      { data  : 'pic_app_mde' },
      { data  : 't1_sc' },
      { data  : 't2_sc' },
      { data  : 't3_sc' },
      { data  : 'm_ship_sc' },
      { data  : 'tn_dep_sc' },
      { data  : 'tn_dep_act' },
      { data  : 'tn_date' },
      { data  : 'max_stay' },
      { data  : 'act_acc' },
      { data  : 'proj_acc' },
      { data  : 'lt_modif' },
      { data  : 'explain_modif' },
      { data: null,
        render: function (data) {
          if(data['act_acc'] !== null){
            return data['over_acc_sc'];
          } else {
            return ``;
          }
        },
      },
      { data  : 'cause' }
    ],
    createdRow: function (row, data, index) {
      $(row).find("td:eq(2)").css("border-right", "inset");
      $(row).find("td:eq(2)").css("border-right-color", ColorBorderFreeze);
    },
    columnDefs: [
      {
        targets: [7,8,9,10,13,15,16],
        render: function (data, type, row) {
          var dateObj = new Date(data);
          var momentObj = moment(dateObj);
          if (data){
            return momentObj.format('ddd, DD MMM YY');
          } else {
            return '';
          }
        }
      },
      { className : "center aligned", targets: [11,12,14,17,19] },
      { className : "collapsing", targets: [2,4,5,6,7,8,9,10,13,15,16] },
      {
        className: "right aligned",
        targets: [13,14]
      },
    ],
    ajax      : {
      url     : '../RND_BackEnd/backend_mpp/approval-report/approval-maker/load/'+IdMPP,
      type    : "POST",
      headers : {
        user  : VUserName,
        token : VToken,
      },
      data    : {
        FSearch   : SearchFStart,
        FYear     : TahunFStart,
        FNama     : NamaFStart,
        FSalesContract : SalesContractFStart,
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    },
  });
}

// function DatePicker(IdTanggal) {
//   var today = new Date();
//   $(IdTanggal).calendar({
//     type: "date",
//     //monthFirst: false,
//     //minDate: new Date(today.getFullYear(), today.getMonth(), today.getDate()),
//     formatter: {
//       date: function (date, settings) {
//         if (!date) return "";
//         var day = date.getDate() + "";
//         if (day.length < 2) {
//           day = "0" + day;
//         }
//         var month = date.getMonth() + 1 + "";
//         if (month.length < 2) {
//           month = "0" + month;
//         }
//         var year = date.getFullYear();
//         return year + "-" + month + "-" + day;
//       },
//     },
//   });
// }

function LoadDetailAppMoldMaker(a){
  $.ajax({
    type: "POST",
    url     : '../RND_BackEnd/backend_mpp/approval-report/approval-maker/load-item/'+a,
    headers: {
      user  : VUserName,
      token : VToken
    },
    cache: false,
    success: function (data){
      var obj = JSON.parse(data);
      $(".WindowEditAppMoldMaker").modal({ autofocus: false }).modal("show");
      LoadDataHRIS();

      $("#MPICAppRD").dropdown("clear");
      $("#MPICAppMDE").dropdown("clear");
      if(obj.pic_app_rd){   
        $('#MPICAppRD')
        .find('option')
        .remove()
        .end()
        .append('<option selected value="'+obj.pic_app_rd+'">'+obj.pic_app_rd+'</option>')
        .val(obj.pic_app_rd);
      }

      if(obj.pic_app_mde){   
        $('#MPICAppMDE')
        .find('option')
        .remove()
        .end()
        .append('<option selected value="'+obj.pic_app_mde+'">'+obj.pic_app_mde+'</option>')
        .val(obj.pic_app_mde);
      }
      
      $('#MDrawingLoc').text(obj.drawing_loc);
      $('#MDescription').text(obj.description);
      $('#MMoldMaker').text(obj.mold_maker);
      $('#MDesigner').text(obj.designer);
      $("#MT1SalesContract").text(obj.t1_sc);
      $("#MT2SalesContract").text(obj.t2_sc);
      $('#MT3SalesContract').text (obj.t3_sc);
      $('#MMShipSC').text(obj.m_ship_sc);
      $('#MTNDepSC').val(obj.tn_dep_sc);
      $('#MActualTNDep').val(obj.tn_dep_act);
      $('#MActualTNDate').val(obj.tn_date);
      $('#MActAcc').val(obj.act_acc);
      $('#MProjAcc').val(obj.proj_acc);
      $('#MLTModif').val(obj.lt_modif);
      $('#MExplainModif').val(obj.explain_modif);
      $('#MCause').val(obj.cause);
      $('#MId').val(obj.id_item_mpp);
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function SaveEditItem() {
  $.ajax({
    type    : "POST",
    url     : '../RND_BackEnd/backend_mpp/approval-report/approval-maker/edit-item',
    headers: {
      user  : VUserName,
      token : VToken
    },
    data: {
      id_item_mpp : $("#MId").val(),
      id_mpp      : IdMPP,
      username    : VUserName,
      drawing_loc : $("#MDrawingLoc").text(),
      pic_app_rd  : $("#MPICAppRD").val().toUpperCase(),
      pic_app_mde : $("#MPICAppMDE").val().toUpperCase(),
      tn_dep_sc   : $("#MTNDepSC").val(),
      tn_dep_act  : $("#MActualTNDep").val(),
      tn_date     : $("#MActualTNDate").val(),
      act_acc     : $("#MActAcc").val(),
      proj_acc    : $("#MProjAcc").val(),
      lt_modif    : $("#MLTModif").val(),
      explain_modif : $("#MExplainModif").val(),
      cause       : $("#MCause").val(),
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if(obj) {
        if (obj.status == false){
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          $(".WindowEditAppMoldMaker").modal("hide");
          TableListFunc();
        }
      } else {
        IsResponseErrorElse();
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}



function LoadDataHRIS() {

  $('.ui.search.dropdown.nama').dropdown({
    apiSettings: {
      url: '2_masterplasticpart/_autocompletenama_app.php?q={query}'
    },
    fields: {
      remoteValues : 'results',
      name         : 'name',
      value        : 'name'
    },
    filterRemoteData : false,
    saveRemoteData : true,
    clearable : true
  });

  $.ajax({
    type: "GET",
    url: "2_masterplasticpart/_artemis.php",
    cache: false,
    success: function (response) {
      setCookie('atoken', response, 1 / 24);
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

$(document).ready(function () {

  TableListFunc();
  $('.ui.dropdown.fullsearch').dropdown( {fullTextSearch:'exact', sortSelect: true, match:'text'} );

  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide: true,
    weekStart: 1
  });

  $("#TableList").on("click", ".BtnEditAppMold", function(){
    var eid  = $(this).attr('eid');
    LoadDetailAppMoldMaker(eid);
  });
 
  $('#SaveData').on('click', function() {
    SaveEditItem();
  });

  $(".CloseModal").on("click", function(){
    $(".WindowEditAppMoldMaker").modal("hide");
  });


  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_mpp").on("keyup", function () {
    var FilterCari = $("#fcari_mpp").val();
    var FilterTahun = $("#fthn_mpp").val();
    var FilterNama = $("#fmn_mpp").val();
    var FilterSales = $("#fsales_mpp").val();
    var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterSales];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPAppMaker", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc();
    $("#TableList").DataTable().page(0).draw();
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fthn_mpp, #fmn_mpp, #fsales_mpp").on(
    "change",
    function () {
      var FilterCari = $("#fcari_mpp").val();
      var FilterTahun = $("#fthn_mpp").val();
      var FilterNama = $("#fmn_mpp").val();
      var FilterSales = $("#fsales_mpp").val();
      var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterSales];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterMPPAppMaker", JsonFilter, 5);
      TableListFunc();
      $("#TableList").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var YearNow = d.getFullYear();
    $("#fcari_mpp").val("");
    $("#fthn_mpp").dropdown("set selected", YearNow);
    $("#fmn_mpp").dropdown("set selected", "ALL");
    $("#fsales_mpp").dropdown("set selected", "ALL");
    var FiterArry = ["", YearNow, "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterMPPAppMaker", JsonFilter, 5);
    $("#TableList").DataTable().destroy();
    TableListFunc("", YearNow, "ALL", "ALL");
    $("#TableList").DataTable().page(0).draw();
  });

});