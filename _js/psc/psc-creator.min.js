$(".ui.dropdown").dropdown();
$(".menu .item").tab(); 

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorRelease= "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocpsc = decodeURIComponent(getCookie("restlocpsc"));
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Jdecrypt = Ucrypt.decrypt(EncJ, NonceValue);

function TableListFunc(FSearch, FYear, FNama, FProgress, FStatus, FJenis) {
  var DTables = $("#PSCList").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#PSCList").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#PSCList").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#PSCList").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#PSCList").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#PSCList").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[1, "desc"]],
    columns: [
      { data: null,
        render: function (data) {
          if (data["PICCycle"] == Udecrypt || data["PICElectronic"] == Udecrypt || data["PICID"] == Udecrypt || data["PICMD"] == Udecrypt || data["HeadGroupProduct"] == Udecrypt || data["ProjectOwner"] == Udecrypt ) {
            if (data["Status"] !== "CANCEL" && data["Status"] !== "RELEASE") {
              return `<span class="editpsc psclink" eid="${data['id_psc']}" data-tooltip="Edit Product Spec" data-inverted="" data-position="right center"><i class="edit link circular teal icon "></i></span>`;
            } else {
              return `<span class="editpsc psclink" eid="${data['id_psc']}" data-tooltip="View Detail Product Spec" data-inverted="" data-position="right center"><i class="tasks link circular grey icon "></i></span>`;
            }
          } else {
            return `<span class="editpsc psclink" eid="${data['id_psc']}" data-tooltip="View Detail Product Spec" data-inverted="" data-position="right center"><i class="tasks link circular grey icon "></i></span>`;
          }
        },
      },
      { data: "no_psc" },
      { data: "Rev" },
      { data: null,
        render: function (data) {
          if ((data["Progres"] == "DONE" || data["Status"] == "RELEASE") && (Jdecrypt =="PROJECT LEADER" || Jdecrypt =="HEAD OF" || Jdecrypt =="HEAD OF GROUP")) {
            return `<span class="psclink downloadpdfpsc" eid="${data['id_psc']}" data-tooltip="Download Product Spec Release - PDF" data-inverted="" data-position="right center"><i class="download link circular teal icon "></i></span>`;
          } else {
            return ``;
          }
        },
      },
      { data: "GroupProduk" },
      { data: "JenisProduk" },
      { data: "Produk" },
      { data: "Chs" },
      { data: "TypeSupply" },
      { data: "TypeDemand" },
      { data: "Cabinet" },
      { data: "ProjectOwner" },
      { data: "Status" },
      { data: "Progres" },
    ],
    columnDefs: [
      { className: "center aligned", targets: [3] },
      { className: "collapsing", targets: [4,8,9] },
      { targets: [0,3], orderable: false },
      ],

   createdRow: function (row, data, index) {

      //WARNA OWNER & STATUS ACTIVE/DRAFT
      if (data["PICCycle"] == Udecrypt || data["PICElectronic"] == Udecrypt || data["PICID"] == Udecrypt || data["PICMD"] == Udecrypt || data["HeadGroupProduct"] == Udecrypt || data["ProjectOwner"] == Udecrypt ) {
        $(row).find("td").css("color", ColorOwner);
      }

      if ( (data["PICCycle"] == Udecrypt || data["PICElectronic"] == Udecrypt || data["PICID"] == Udecrypt || data["PICMD"] == Udecrypt || data["HeadGroupProduct"] == Udecrypt || data["ProjectOwner"] == Udecrypt ) && (data["status_sign"] == "NO")) {
        $(row).find("td").css("color", ColorSignNo);
        $(row).find("td").css("background-color", BgColorOwner);
      }

      //WARNA FINISH & CLOSE
      if (data["Progres"] == "DONE" || data["Status"] == "RELEASE") {
        $(row).find("td").css("color", ColorRelease);
      }

      //WARNA LOCK
      if (data["Status"] == "LOCK") {
        $(row).find("td").css("color", ColorLock);
        $(row).find("td").css("background-color", BgColorLock);
      }
      
      //WARNA CANCEL
      if (data["Status"] == "CANCEL") {
        $(row).find("td").css("color", ColorCancel);
      }
      
    },

    ajax: {
      url: `${restlocpsc}table_psc`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FSearch,
        FYear: FYear,
        FNama: FNama,
        FProgress: FProgress,
        FStatus: FStatus,
        FJenis: FJenis,
      },
      
      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}

//Open Product Spec Content
$("#PSCList").on("click", ".editpsc", function () {
  var eid = $(this).attr("eid");
  let encryption = new Encryption();
  var eidENC = encryption.encrypt(eid, NonceValue);
  window.location.href = "./?link=psccontent&i=" + eidENC;
});

//Download Product Spec Pdf
$("#PSCList").on("click", ".downloadpdfpsc", function () {
  var eidpdf = $(this).attr("eid");
  // $('<a href="./1_productspec/pscpdf.php?id='+eidpdf+'" target="blank"></a>')[0].click(); 
  window.location.href = "./?link=viewpscpdf&i=" + eidpdf;

});



$(document).ready(function () {


  //Add New Product Specification
  $("#addnewpsc").on("click", function () {
    window.location.href = "./?link=pscheader";
  });

  $('#tabcompare').on('click', function() {
    window.location.href = "./?link=psccompare";
  });

  $('#tabchangepic').on('click', function() {
    window.location.href = "./?link=pscchangepic";
  });

  $('#tabbp').on('click', function() {
    window.location.href = "./?link=bpindex";
  });

  $('.tabuserguide').on('click', function() {
    window.location.href = "./?link=guidepsc";
  });
  $('.tabsuratgolive').on('click', function() {
    window.location.href = "./?link=golivepsc";
  });
  $('.tabhasilmonitoring').on('click', function() {
    window.location.href = "./?link=monitorpsc";
  });
  $('.tabversion').on('click', function() {
    window.location.href = "./?link=versionhistory&app=PSC";
  });
      
  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();

  var json_str = getCookie('FilterPSCCreator');
  var arr = JSON.parse(json_str);
  if(json_str){
    var sfilter = arr[0];
    var tfilter = arr[1];
    var mfilter = arr[2];
    var pfilter = arr[3];
    var stfilter = arr[4];
    var jfilter = arr[5];
  } else {
    var sfilter = "";
    var tfilter = yearnow;
    var mfilter = "ALL";
    var pfilter = "ALL";
    var stfilter = "ALL";
    var jfilter = "ALL";
  }

  if (sfilter) {
    $("#fcari_psc").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (tfilter) {
    $("#fthn_psc").dropdown("set selected", tfilter);
    var tfilterstart = tfilter;
  } else {
    var tfilterstart = yearnow;
  }
  if (mfilter) {
    $("#fmn_psc").dropdown("set selected", mfilter);
    var mfilterstart = mfilter;
  } else {
    var mfilterstart = "ALL";
  }
  if (pfilter) {
    $("#fprg_psc").dropdown("set selected", pfilter);
    var pfilterstart = pfilter;
  } else {
    var pfilterstart = "ALL";
  }
  if (stfilter) {
    $("#fsts_psc").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    var stfilterstart = "ALL";
  }
  if (jfilter) {
    $("#fjenisprd_psc").dropdown("set selected", jfilter);
    var jfilterstart = jfilter;
  } else {
    var jfilterstart = "";
  }
  // console.log(jfilterstart);

  var FiterArry = [sfilterstart, tfilterstart, mfilterstart, pfilterstart, stfilterstart, jfilterstart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterPSCCreator", JsonFilter, 5);


  //Load Table
  TableListFunc( sfilterstart, tfilterstart, mfilterstart, pfilterstart, stfilterstart, jfilterstart);

 
  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_psc").on("keyup", function () {
    var FilterCari = $("#fcari_psc").val();
    var FilterTahun = $("#fthn_psc").val();
    var FilterNama = $("#fmn_psc").val();
    var FilterJenisPrd = $("#fjenisprd_psc").val();
    var FilterProgress = $("#fprg_psc").val();
    var FilterStatus = $("#fsts_psc").val();
    var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus, FilterJenisPrd];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterPSCCreator", JsonFilter, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc(FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus, FilterJenisPrd);
    $("#PSCList").DataTable().page(0).draw();
    
  });


  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fthn_psc, #fmn_psc, #fjenisprd_psc, #fprg_psc, #fsts_psc").on(
    "change",
    function () {
      var FilterCari = $("#fcari_psc").val();
      var FilterTahun = $("#fthn_psc").val();
      var FilterNama = $("#fmn_psc").val();
      var FilterJenisPrd = $("#fjenisprd_psc").val();
      var FilterProgress = $("#fprg_psc").val();
      var FilterStatus = $("#fsts_psc").val();
      var FiterArry = [FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus, FilterJenisPrd];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterPSCCreator", JsonFilter, 5);
      TableListFunc(FilterCari, FilterTahun, FilterNama, FilterProgress, FilterStatus, FilterJenisPrd);
      // var table = $("#PSSList").DataTable();
      // var inff = table.page.info();
      // console.log(inff);
      $("#PSCList").DataTable().page(0).draw();

    }
  );


  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#fcari_psc").val("");
    $("#fthn_psc").dropdown("set selected", yearnow);
    $("#fmn_psc").dropdown("set selected", "ALL");
    $("#fjenisprd_psc").dropdown("set selected", "ALL");
    $("#fprg_psc").dropdown("set selected", "ALL");
    $("#fsts_psc").dropdown("set selected", "ALL");
    var FiterArry = ["", yearnow, "ALL", "ALL", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterPSCCreator", JsonFilter, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc("", yearnow, "ALL", "ALL", "ALL", "ALL");
    $("#PSCList").DataTable().page(0).draw();

  });


});