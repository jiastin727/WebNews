$(".ui.dropdown").dropdown();
$(".menu .item").tab(); 

// Global Variable
const NonceValue = "rdsystem2020";
const LogoutProtect = false;

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocpsc = decodeURIComponent(getCookie("restlocpsc"));
var restlocpss = decodeURIComponent(getCookie("restlocpss"));

let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var pic    = $('#changepic').val();

$('#changepic').on('change', function(){
  var pic        = $('#changepic').val();
  var FilterCari = $("#fcari_psc").val();
  var FilterNama = $("#fmn_psc").val();
  var FilterStatus = $("#fsts_psc").val();
  var FiterArry  = [FilterCari, FilterNama, FilterStatus, pic];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterChangePICPSC", JsonFilter, 5);
  TableListFunc();
  $("#PSCChangePIC").DataTable().page(0).draw();
});


function TableListFunc() {

  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();

  var json_str = getCookie('FilterChangePICPSC');
  var arr = JSON.parse(json_str);

  if(json_str){
    var sfilter = arr[0];
    var mfilter = arr[1];
    var stfilter = arr[2];
    var stpic = arr[3];
  } else {
    var sfilter = "";
    var mfilter = "ALL";
    var stfilter = "ALL";
    var stpic = "ALL";
  }

  if (sfilter) {
    $("#fcari_psc").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (mfilter) {
    $("#fmn_psc").dropdown("set selected", mfilter);
    var mfilterstart = mfilter;
  } else {
    var mfilterstart = "ALL";
  }
  if (stfilter) {
    $("#fsts_psc").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    var stfilterstart = "ALL";
  }

  if (stpic) {
    $("#changepic").dropdown("set selected", stpic);
    var picfilterstart = stpic;
  } else {
    var picfilterstart = "ALL";
  }
  

  var FiterArry = [sfilterstart, mfilterstart, stfilterstart, picfilterstart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterChangePICPSC", JsonFilter, 5);

  var DTables = $("#PSCChangePIC").DataTable({
    dom:
      "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [
      {
        text: "10",
        action: function (e, dt, node, config) {
          $("#PSCChangePIC").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#PSCChangePIC").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#PSCChangePIC").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#PSCChangePIC").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#PSCChangePIC").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first":      "Awal",
        "last":       "Akhir",
        "next":       "Berikutnya",
        "previous":   "Sebelumnya"
      },
      infoEmpty:      "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [[1, "desc"]],
    columns: [
      { data: null,
        render: function (data) {
          if ((data['Status'] !== "RELEASE") && (data['Status'] !== "CANCEL")) {
            return `<span class="changePIC psclink" eid="${data['id_psc']}" epic="${data['ProjectOwner']}" allpic="${data['HO_CYCLE']}|${data['PICCycle']}|${data['HO_HARDWARE']}|${data['PICElectronic']}|${data['HO_MECH']}|${data['PICMD']}|${data['HO_ID']}|${data['PICID']}|${data['PICSW']}" data-tooltip="Change PIC Product Spec" data-inverted="" data-position="right center"><i class="edit link circular teal icon "></i></span>`;
          } else {
            return ``;
          }
        },
      },
      { data: null,
        render: function (data) {
          return data['no_psc']+' '+data['Rev'];
        },
      },
      { data: null,
        render: function (data) {
          return data['JenisProduk']+' - '+data['Produk'];
        },
      },
      { data: 'Chs' },
      { data: 'TypeSupply' },
      { data: 'PICCycle' },
      { data: 'PICElectronic' },
      { data: 'PICMD' },
      { data: 'PICID' },
      { data: 'PICSW' },
      { data: 'ProjectOwner' },
      { data: 'Status' },
      { data: 'Progres' },
      
    ],
    columnDefs: [
      { className: "collapsing", targets: [1] },
      { orderable: false, targets: [0] },
      ],

    ajax: {
      url: `${restlocpsc}table_changepic`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        pic       : picfilterstart,
        FSearch   : sfilterstart,
        FProgress : mfilterstart,
        FStatus   : stfilterstart,
      },

      error: function () {
        if (LogoutProtect){
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
        }
      },
    },
  });
}


$(document).ready(function () {

  $("#tabPSCList").on("click", function () {
    window.location.href = "./?link=pscindex";
  });
  $("#tabcompare").on("click", function () {
    window.location.href = "./?link=psccompare";
  });
  $("#tabchangepic").on("click", function () {
    window.location.href = "./?link=pscchangepic";
  });

  $('.tabuserguide').on('click', function() {
    window.location.href = "./?link=guidepsc";
  });
  $('.tabsuratgolive').on('click', function() {
    window.location.href = "./?link=golivepsc";
  });
  $('.tabhasilmonitoring').on('click', function() {
    window.location.href = "./?link=monitorpsc";
  });
  $('.tabversion').on('click', function() {
    window.location.href = "./?link=versionhistory&app=PSC";
  });

  $('.CloseModal').click(function(){
    $(".windowchangepic").modal("hide");
  });

  //Load Table
  TableListFunc();

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#fcari_psc").on("keyup", function () {
    var FilterCari = $("#fcari_psc").val();
    var FilterNama = $("#fmn_psc").val();
    var FilterStatus = $("#fsts_psc").val();
    var pic = $("#fsts_psc").val();
    var FiterArry = [FilterCari, FilterNama, FilterStatus, pic];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterChangePICPSC", JsonFilter, 5);
    $("#PSSList").DataTable().destroy();
    TableListFunc();
    $("#PSCChangePIC").DataTable().page(0).draw();
  });


  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#fmn_psc, #fsts_psc").on(
    "change",
    function () {
      var FilterCari = $("#fcari_psc").val();
      var FilterNama = $("#fmn_psc").val();
      var FilterStatus = $("#fsts_psc").val();
      var pic = $("#changepic").val();
      var FiterArry = [FilterCari, FilterNama, FilterStatus, pic];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterChangePICPSC", JsonFilter, 5);
      TableListFunc();
      $("#PSCChangePIC").DataTable().page(0).draw();
    }
  );

  //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#fcari_psc").val("");
    $("#fmn_psc").dropdown("set selected", "ALL");
    $("#fsts_psc").dropdown("set selected", "ALL");
    $("#changepic").dropdown("set selected", "-");
    var pic = $("#changepic").val();
    var FiterArry = ["", "ALL", "ALL", "-"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterChangePICPSC", JsonFilter, 5);
    TableListFunc("", "ALL", "ALL", "-");
    $("#PSCChangePIC").DataTable().page(0).draw();
  });

  // Open Modal Change PIC
$('#PSCChangePIC').on("click", ".changePIC", function() {
  $('.ui.dropdown.fullsearch').dropdown( {fullTextSearch:'exact', sortSelect: true, match:'text'} );
  var eid = $(this).attr("eid");
  var epic = $(this).attr("epic");
  var allpic = $(this).attr("allpic");
  var arypic = allpic.split("|");
  $("#editinputid").val(eid);
  $("#picbefore").val(epic);
  $("#editinputpicbefore").val(epic);
  $("#PICBfr").text(epic+" is Disable?");
  $('.InputDisable').hide();
  $('.InputAlasan').hide();
  $('.windowchangepic').modal('show');
  $("#changepics").dropdown("set selected", "-");
  $("#addcheckPIC").dropdown("set selected", "-");
  $("#PICHOCY").text(arypic[0]);
  $("#PICDESCY").text(arypic[1]);
  $("#PICHOEL").text(arypic[2]);
  $("#PICDESEL").text(arypic[3]);
  $("#PICHOMD").text(arypic[4]);
  $("#PICDESMD").text(arypic[5]);
  $("#PICHOID").text(arypic[6]);
  $("#PICDESID").text(arypic[7]);
  $("#PICDESSW").text(arypic[8]);

  if(arypic[0] && arypic[0] !=="-" && arypic[0] !=="null"){
    $("#IdHoCy").show();
  } else {
    $("#IdHoCy").hide();
  }

  if(arypic[1] && arypic[1] !=="-" && arypic[1] !=="null"){
    $("#IdDeCy").show();
  } else {
    $("#IdDeCy").hide();
  }

  if(arypic[2] && arypic[2] !=="-" && arypic[2] !=="null"){
    $("#IdHoEl").show();
  } else {
    $("#IdHoEl").hide();
  }

  if(arypic[3] && arypic[3] !=="-" && arypic[3] !=="null"){
    $("#IdDeEl").show();
  } else {
    $("#IdDeEl").hide();
  }

  if(arypic[4] && arypic[4] !=="-" && arypic[4] !=="null"){
    $("#IdHoMd").show();
  } else {
    $("#IdHoMd").hide();
  }

  if(arypic[5] && arypic[5] !=="-" && arypic[5] !=="null"){
    $("#IdDeMd").show();
  } else {
    $("#IdDeMd").hide();
  }

  if(arypic[6] && arypic[6] !=="-" && arypic[6] !=="null"){
    $("#IdHoId").show();
  } else {
    $("#IdHoId").hide();
  }

  if(arypic[7] && arypic[7] !=="-" && arypic[7] !=="null"){
    $("#IdDeId").show();
  } else {
    $("#IdDeId").hide();
  }

  if(arypic[8] && arypic[8] !=="-" && arypic[8] !=="null"){
    $("#IdDeSo").show();
  } else {
    $("#IdDeSo").hide();
  }



});

$('#changepics').on('change', function() {
  var user    = $("#changepics").val();
  var pic    = $("#changepic").val();
  var vusrnm  = getCookie('usrnm');
  var vtoken  = getCookie('token');
          
  $.ajax({
    type  : "POST",
    url   : `${restlocpss}cek_changepic`,
    headers: {
      user  : vusrnm,
      token : vtoken
    },
    data: {
      pic     : pic,
      user    : user
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(response);
      if(isEmpty(obj)) {
        console.log('Fail, Data Kosong');
      } else if(obj) {
        if (obj.status == false){
          $('.InputDisable').hide();
          $('.InputAlasan').hide();
        }  else {
          $('.InputDisable').show();
        }
      } else {
        Swal.fire('Error','Error ?.','error')
      }
    },
    error: function(){
      //window.location.href = "./?link=loclogout";
      console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
    }
  });
});

$("#addcheckPIC").on("change", function () {
  var cek = $("#addcheckPIC").val();
  if (cek == "NO") {
    $('.InputAlasan').show();
  } else {
    $('.InputAlasan').hide();
  }
});

$("#SaveChangePIC").on("click", function() {
  var idpsc = $("#editinputid").val();
  var picbefore = $("#picbefore").val();
  var picafter = $("#changepics").val();
  var reason = $("#ReasonChange").val();
  var disable = $("#addcheckPIC").val();
  
  $.ajax({
    url: `${restlocpsc}change_picpl`,
    type: "POST",
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      id_psc: idpsc,
      picb : picbefore,
      pica : picafter,
      reason  : reason,
      disable : disable
    },
    success: function (rsp) {
      var obj = JSON.parse(rsp);
      if (isEmpty(obj)) {
        console.log("Data Kosong");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            showConfirmButton: false,
          });
        } else {
          Swal.fire({
            text: "Berhasil ganti PIC (Project Leader) PSC.",
            icon: "success",
            showConfirmButton: true,
          }).then((result) => {
            if (result.value) {
              $('.ui.modal').modal('hide');
              $("#changepics").dropdown("clear");
              $("#addcheckPIC").dropdown("clear");
              $("#ReasonChange").val('');
              location.reload();
            }
          });
        }
      } else {
        Swal.fire("Error", "Data Error ?.", "error");
      }
    },
    error: function () {
      // window.location.href = "./?link=loclogout";
      Swal.fire(
        "Error",
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
        "error"
      );
    },
  })
});

$("#SaveChangePICAll").on("click", function() {
  var idpsc = $("#editinputid").val();
    
  $.ajax({
    url: `${restlocpsc}change_pichodesigner`,
    type: "POST",
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      id_psc: idpsc,
      CyDesBefore : $("#PICDESCY").text(),
      CyDesAfter  : $("#PICDESCY2").val(),
      CyHoBefore  : $("#PICHOCY").text(),
      CyHoAfter   : $("#PICHOCY2").val(),

      ElDesBefore : $("#PICDESEL").text(),
      ElDesAfter  : $("#PICDESEL2").val(),
      ElHoBefore  : $("#PICHOEL").text(),
      ElHoAfter   : $("#PICHOEL2").val(),

      MdDesBefore : $("#PICDESMD").text(),
      MdDesAfter  : $("#PICDESMD2").val(),
      MdHoBefore  : $("#PICHOMD").text(),
      MdHoAfter   : $("#PICHOMD2").val(),

      IdDesBefore : $("#PICDESID").text(),
      IdDesAfter  : $("#PICDESID2").val(),
      IdHoBefore  : $("#PICHOID").text(),
      IdHoAfter   : $("#PICHOID2").val(),

      SwDesBefore : $("#PICDESSW").text(),
      SwDesAfter  : $("#PICDESSW2").val(),
      
    },
    success: function (rsp) {
      var obj = JSON.parse(rsp);
      if (isEmpty(obj)) {
        console.log("Data Kosong");
      } else if (obj) {
        if (obj.status == false) {
          Swal.fire({
            text: obj.message,
            timer: 1500,
            showConfirmButton: false,
          });
        } else {
          Swal.fire({
            text: "Berhasil ganti PIC PSC.",
            icon: "success",
            showConfirmButton: true,
          }).then((result) => {
            if (result.value) {
              $('.ui.modal').modal('hide');
              $(".fullsearch").dropdown("clear");
              location.reload();
            }
          });
        }
      } else {
        Swal.fire("Error", "Data Error ?.", "error");
      }
    },
    error: function () {
      // window.location.href = "./?link=loclogout";
      Swal.fire(
        "Error",
        "Server tidak merespon, segera hubungi Administrator di ext. 3553 !",
        "error"
      );
    },
  })
})

});