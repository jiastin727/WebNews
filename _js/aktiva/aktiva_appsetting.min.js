const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo = "#00139f";
const ColorOwner = "#00139f";
const BgColorOwner = "#eff0ff";
const ColorRelease = "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var restlocactiva = decodeURIComponent(getCookie("restlocactiva"));
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Jdecrypt = Ucrypt.decrypt(EncJ, NonceValue);
// var Sdecrypt = Ucrypt.decrypt(EncS, NonceValue);

function LoadKalibrasi() {
    $('#tbBagKalibrasi').find('tbody').empty();
    $.ajax({
        type: "POST",
        url: `${restlocactiva}readPICKalibrasi`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: Udecrypt
        },
        cache: false,
        success: function (response) {
            var obj = JSON.parse(response);
            // console.log(obj);
            if (isEmpty(obj)) {
                IsResponseEmptyObj();
            } else if (obj) {
                if (obj.status == 'error8') {
                    $('#tbBagKalibrasi').find('tbody').append(
                        "<tr><td width='400px'>&nbsp;" +
                        "</td><td class='center' >" +
                        "</td><td class='center'></td></tr>");
                } else {
                    jmlData = obj.length;
                    for (a = 0; a < jmlData; a++) {
                        $('#tbBagKalibrasi').find('tbody').append(
                            "<tr id='" + a + "'><td width='400px'>" + obj[a]["nama_pic"] +
                            "</td><td class='center' data-tooltip='Hapus PIC Kalibrasi' data-inverted='' data-variation='basic'><i class='trash actdeleteprjid iconcolordelete icon' id='" + obj[a]["id_pic_kalibrasi"] + "'></i></td></tr>");
                    }
                    //Hapus Project ID
                    $('.actdeleteprjid').on('click', function (e) {
                        var idPIC = $(this).attr('id');
                        $.ajax({
                            type: "POST",
                            url: `${restlocactiva}deletePICKalibrasi`,
                            headers: {
                                user: vusrnm,
                                token: vtoken
                            },
                            data: {
                                idPIC: idPIC,
                                req_by : Udecrypt
                            },
                            cache: false,
                            success: function (response) {
                                var obj = JSON.parse(response);
                                if (obj.status == false) {
                                    IsResponseFalse(obj.message);
                                } else {
                                    IsResponseTrue(obj.message);
                                    LoadKalibrasi();
                                    // if (id_mutasi === "create_mutasi") {
                                    //     LoadKalibrasi();
                                    // } else if (id_mutasi === "edit_mutasi") {
                                    //     LoadKalibrasi();
                                    // }
                                }
                            },
                            error: function () {
                                IsTimeOut(LogoutProtect);
                            },
                        });
                    });
                }
            }
        },
        error: function () {
            IsTimeOut(LogoutProtect);
        },
    });
}

function LoadFinance() {
    $('#tbBagFinance').find('tbody').empty();
    $.ajax({
        type: "POST",
        url: `${restlocactiva}readPICFinance`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: Udecrypt
        },
        cache: false,
        success: function (response) {
            var obj = JSON.parse(response);
            // console.log(obj);
            if (isEmpty(obj)) {
                IsResponseEmptyObj();
            } else if (obj) {
                if (obj.status == 'error8') {
                    $('#tbBagFinance').find('tbody').append(
                        "<tr><td width='400px'>&nbsp;" +
                        "</td><td class='center' >" +
                        "</td><td class='center'></td></tr>");
                } else {
                    jmlData = obj.length;
                    for (a = 0; a < jmlData; a++) {
                        $('#tbBagFinance').find('tbody').append(
                            "<tr id='" + a + "'><td width='400px'>" + obj[a]["nama_pic"] +
                            "</td><td class='center' data-tooltip='Hapus PIC Finance'  data-inverted='' data-variation='basic'><i class='trash actdeleteprjid iconcolordelete icon' id='" + obj[a]["id_pic_finance"] + "'></i></td></tr>");
                    }
                    //Hapus Project ID
                    $('.actdeleteprjid').on('click', function (e) {
                        var idPIC = $(this).attr('id');
                        $.ajax({
                            type: "POST",
                            url: `${restlocactiva}deletePICFinance`,
                            headers: {
                                user: vusrnm,
                                token: vtoken
                            },
                            data: {
                                idPIC: idPIC,
                                req_by : Udecrypt
                            },
                            cache: false,
                            success: function (response) {
                                var obj = JSON.parse(response);
                                if (obj.status == false) {
                                    IsResponseFalse(obj.message);
                                } else {
                                    IsResponseTrue(obj.message);
                                    LoadFinance();
                                    // if (id_mutasi === "create_mutasi") {
                                    //     LoadKalibrasi();
                                    // } else if (id_mutasi === "edit_mutasi") {
                                    //     LoadKalibrasi();
                                    // }
                                }
                            },
                            error: function () {
                                IsTimeOut(LogoutProtect);
                            },
                        });
                    });
                }
            }
        },
        error: function () {
            IsTimeOut(LogoutProtect);
        },
    });
}

function LoadCostCenter() {
    $('#tbBagCostCenter').find('tbody').empty();
    $.ajax({
        type: "POST",
        url: `${restlocactiva}readPICCostCenter`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: Udecrypt
        },
        cache: false,
        success: function (response) {
            var obj = JSON.parse(response);
            // console.log(obj);
            if (isEmpty(obj)) {
                IsResponseEmptyObj();
            } else if (obj) {
                if (obj.status == 'error8') {
                    $('#tbBagCostCenter').find('tbody').append(
                        "<tr><td width='400px'>&nbsp;" +
                        "</td><td class='center' >" +
                        "</td><td class='center'></td></tr>");
                } else {
                    jmlData = obj.length;
                    for (a = 0; a < jmlData; a++) {
                        $('#tbBagCostCenter').find('tbody').append(
                            "<tr id='" + a + "'><td width='400px'>" + obj[a]["nama_pic"] +
                            "</td><td width='400px'>" + obj[a]["cost_center"] +
                            "</td><td class='center' data-tooltip='Hapus Admin Cost Center' data-inverted='' data-variation='basic'><i class='trash actdeleteprjid iconcolordelete icon' id='" + obj[a]["id_pic_costcenter"] + "'></i></td></tr>");
                    }
                    //Hapus Project ID
                    $('.actdeleteprjid').on('click', function (e) {
                        var idPIC = $(this).attr('id');
                        $.ajax({
                            type: "POST",
                            url: `${restlocactiva}deletePICCostCenter`,
                            headers: {
                                user: vusrnm,
                                token: vtoken
                            },
                            data: {
                                idPIC: idPIC,
                                req_by : Udecrypt
                            },
                            cache: false,
                            success: function (response) {
                                var obj = JSON.parse(response);
                                if (obj.status == false) {
                                    IsResponseFalse(obj.message);
                                } else {
                                    IsResponseTrue(obj.message);
                                    LoadCostCenter();
                                    // if (id_mutasi === "create_mutasi") {
                                    //     LoadKalibrasi();
                                    // } else if (id_mutasi === "edit_mutasi") {
                                    //     LoadKalibrasi();
                                    // }
                                }
                            },
                            error: function () {
                                IsTimeOut(LogoutProtect);
                            },
                        });
                    });
                }
            }
        },
        error: function () {
            IsTimeOut(LogoutProtect);
        },
    });
}

function LoadAdmin() {
    $('#tbBagAdmin').find('tbody').empty();
    $.ajax({
        type: "POST",
        url: `${restlocactiva}readPICAdmin`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: Udecrypt
        },
        cache: false,
        success: function (response) {
            var obj = JSON.parse(response);
            // console.log(obj);
            if (isEmpty(obj)) {
                IsResponseEmptyObj();
            } else if (obj) {
                if (obj.status == 'error8') {
                    $('#tbBagAdmin').find('tbody').append(
                        "<tr><td width='400px'>&nbsp;" +
                        "</td><td class='center' >" +
                        "</td><td class='center'></td></tr>");
                } else {
                    jmlData = obj.length;
                    for (a = 0; a < jmlData; a++) {
                        $('#tbBagAdmin').find('tbody').append(
                            "<tr id='" + a + "'><td width='400px'>" + obj[a]["nama_pic"] +
                            "</td><td class='center' data-tooltip='Hapus PIC Admin' data-inverted='' data-variation='basic'><i class='trash actdeleteprjid iconcolordelete icon' id='" + obj[a]["id_pic_admin"] + "'></i></td></tr>");
                    }
                    //Hapus Project ID
                    $('.actdeleteprjid').on('click', function (e) {
                        var idPIC = $(this).attr('id');
                        $.ajax({
                            type: "POST",
                            url: `${restlocactiva}deletePICAdmin`,
                            headers: {
                                user: vusrnm,
                                token: vtoken
                            },
                            data: {
                                idPIC: idPIC,
                                req_by : Udecrypt
                            },
                            cache: false,
                            success: function (response) {
                                var obj = JSON.parse(response);
                                if (obj.status == false) {
                                    IsResponseFalse(obj.message);
                                } else {
                                    IsResponseTrue(obj.message);
                                    LoadAdmin();
                                    // if (id_mutasi === "create_mutasi") {
                                    //     LoadKalibrasi();
                                    // } else if (id_mutasi === "edit_mutasi") {
                                    //     LoadKalibrasi();
                                    // }
                                }
                            },
                            error: function () {
                                IsTimeOut(LogoutProtect);
                            },
                        });
                    });
                }
            }
        },
        error: function () {
            IsTimeOut(LogoutProtect);
        },
    });
}

function LoadDept() {
    $('#tbDept').find('tbody').empty();
    $.ajax({
        type: "POST",
        url: `${restlocactiva}readDept`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: Udecrypt
        },
        cache: false,
        success: function (response) {
            var obj = JSON.parse(response);
            // console.log(obj);
            if (isEmpty(obj)) {
                IsResponseEmptyObj();
            } else if (obj) {
                if (obj.status == 'error8') {
                    $('#tbDept').find('tbody').append(
                        "<tr><td width='400px'>&nbsp;" +
                        "</td><td class='center' >" +
                        "</td><td class='center'></td></tr>");
                } else {
                    jmlData = obj.length;
                    for (a = 0; a < jmlData; a++) {
                        $('#tbDept').find('tbody').append(
                            "<tr id='" + a + "'><td width='400px'>" + obj[a]["dept"] +
                            "</td><td class='center' data-tooltip='Hapus Dept' data-inverted='' data-variation='basic'><i class='trash actdeleteprjid iconcolordelete icon' id='" + obj[a]["id_dept"] + "'></i></td></tr>");
                    }
                    //Hapus Project ID
                    $('.actdeleteprjid').on('click', function (e) {
                        var id_dept = $(this).attr('id');
                        $.ajax({
                            type: "POST",
                            url: `${restlocactiva}deleteDept`,
                            headers: {
                                user: vusrnm,
                                token: vtoken
                            },
                            data: {
                                iddept: id_dept,
                                req_by : Udecrypt
                            },
                            cache: false,
                            success: function (response) {
                                var obj = JSON.parse(response);
                                if (obj.status == false) {
                                    IsResponseFalse(obj.message);
                                } else {
                                    IsResponseTrue(obj.message);
                                    LoadDept();
                                    // if (id_mutasi === "create_mutasi") {
                                    //     LoadKalibrasi();
                                    // } else if (id_mutasi === "edit_mutasi") {
                                    //     LoadKalibrasi();
                                    // }
                                }
                            },
                            error: function () {
                                IsTimeOut(LogoutProtect);
                            },
                        });
                    });
                }
            }
        },
        error: function () {
            IsTimeOut(LogoutProtect);
        },
    });
}

$('#btnSaveKalibrasi').click(function () {
    var nikPIC = $("#NIKPICKal").val();
    var pic = $("#inputPICKal").val();
    var emailPIC = $("#EmailPICKal").val();
    console.log(nikPIC);
    $.ajax({
        type: 'POST',
        url: `${restlocactiva}addPICKalibrasi`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: pic,
            nikPIC : nikPIC,
            emailPIC : emailPIC,
            req_by : Udecrypt
        },
        success: function (response) {
            var obj = JSON.parse(response);
            console.log(obj.status);
            if (obj.status == false) {
                IsResponseFalse(obj.message);
            } else {
                IsResponseTrue(obj.message);
                LoadKalibrasi();
                $('.xwinaddnewpickal').modal('hide');
            }
            
        }
    });
});

$('#btnSaveFinance').click(function () {
    var nikPIC = $("#NIKPICFinance").val();
    var pic = $("#inputPICFinance").val();
    var emailPIC = $("#EmailPICFinance").val();
    $.ajax({
        type: 'POST',
        url: `${restlocactiva}addPICFinance`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: pic,
            nikPIC : nikPIC,
            emailPIC : emailPIC,
            req_by : Udecrypt
        },
        success: function (response){
            var obj = JSON.parse(response);
            if(isEmpty(obj)) {
              console.log('Gagal Simpan mas brooo, data kosong');
            } else if(obj) {
              if (obj.status == false){
                IsResponseFalse(obj.message);
              } else {
                IsResponseTrue(obj.message);
                LoadFinance();
                $(".xwinaddnewpicfin").modal("hide");
              }
            } else {
              Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
            }
          },
    });
});

$('#btnSaveAdminCC').click(function () {
    // var nikPIC = $("#NIKPICCostCenter").val();
    var pic = $("#inputPICCostCenter").val();
    // var emailPIC = $("#EmailPICCostCenter").val();
    var cc = $("#adminCC").val();
    $.ajax({
        type: 'POST',
        url: `${restlocactiva}addPICCostCenter`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: pic,
            // nikPIC : nikPIC,
            // emailPIC : emailPIC,
            cc : cc,
            req_by : Udecrypt
        },
        success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
                IsResponseFalse(obj.message);
            } else {
                IsResponseTrue(obj.message);
                LoadCostCenter();
                $('.xwinaddnewcc').modal('hide');
            }
            
        }
    });
});

$('#btnSaveAdmin').click(function () {
    var pic = $("#adminPIC").val();
    $.ajax({
        type: 'POST',
        url: `${restlocactiva}addPICAdmin`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            pic: pic,
            req_by : Udecrypt
        },
        success: function (response) {
            var obj = JSON.parse(response);
            if (obj.status == false) {
                IsResponseFalse(obj.message);
            } else {
                IsResponseTrue(obj.message);
                LoadAdmin();
                $('.xwinaddnewpicadmin').modal('hide');
            }
            
        }
    });
});

$('#btnSaveDept').click(function () {
    var dept = $("#inputDept").val();
    $.ajax({
        type: 'POST',
        url: `${restlocactiva}addDept`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            dept: dept,
            req_by : Udecrypt
        },
        success: function (response) {
            var obj = JSON.parse(response);
            console.log(obj.status);
            if (obj.status == false) {
                IsResponseFalse(obj.message);
            } else {
                IsResponseTrue(obj.message);
                LoadDept();
                $('.xwinaddnewdept').modal('hide');
            }
            
        }
    });
});

$(function () {

    LoadKalibrasi();
    LoadFinance();
    LoadCostCenter();
    LoadAdmin();
    LoadDept();

    $('#btnAddKalibrasi').click(function () {
        $('.xwinaddnewpickal').modal('show');
        $("#inputPICKal").val('');
    });

    $('#btnAddFinance').click(function () {
        $('.xwinaddnewpicfin').modal('show');
        $("#inputPICFinance").val('');
    });

    $('#btnAddDept').click(function () {
        $('.xwinaddnewdept').modal('show');
        $("#inputDept").val('');
    });

    $('#btnAddAdmin').click(function () {
        $('.xwinaddnewpicadmin').modal('show');
    });

    

    $('#adminCC')
        .dropdown({
            fullTextSearch: true
        });

    $('#btnAddCostCenter').click(function () {
        $('.xwinaddnewcc').modal('show');
        $("#inputPICCostCenter").val('');
        $("#adminCC").dropdown("clear");;
    });

    $('.CloseModal').click(function () {
        $(".ui.modal").modal("hide");
    });

    $('.ui.search.appset')
        .search({
            apiSettings: {
                url: '3_aktiva/_autocompletenik.php?q={query}'
            },
            fields: {
                results: 'data',
                title: 'name',
                description: 'nik'
            },
            minCharacters: 1,
            onSelect: function (response) {
                $('#NIKPICKal').val(response.nik);
                $('#EmailPICKal').val(response.email);
                $('#NIKPICFinance').val(response.nik);
                $('#EmailPICFinance').val(response.email);
                $('#NIKPICCostCenter').val(response.nik);
                $('#EmailPICCostCenter').val(response.email);
                $('#NIKPICAdmin').val(response.nik);
                $('#EmailPICAdmin').val(response.email);
                $('#BagianPICAdmin').val(response.ou_desc);
            },
        });

    $.ajax({
        type: "GET",
        url: "3_aktiva/_artemis.php",
        cache: false,
        success: function (response) {
            setCookie('atoken', response, 1 / 24);
        },
        error: function () {
            if (fungsilogout) {
                // window.location.href = "./_logout.php";
            } else {
                console.log("error session")
            }
        }
    });

    $('.ui.dropdown').dropdown();

});