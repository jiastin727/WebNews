const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo = "#00139f";
const ColorOwner = "#00139f";
const BgColorOwner = "#eff0ff";
const ColorRelease = "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var restlocactiva = decodeURIComponent(getCookie("restlocactiva"));
var restlocpscxls = decodeURIComponent(getCookie("restlocpscxls"));
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Jdecrypt = Ucrypt.decrypt(EncJ, NonceValue);

if (id_mutasi === "create_mutasi") {
  LoadTempAktivaMutasi();
}

if(id_mutasi === "edit_mutasi"){
  LoadTempAktivaEditMutasi();
}

//Fuction Load Temp Aktiva
function LoadTempAktivaMutasi() {

  $('#tbTempMutasi').find('tbody').empty();
  $.ajax({
    type: "POST",
    url: `${restlocactiva}read_tempactivamutasi`,
    headers: {
      user: vusrnm,
      token: vtoken
    },
    data: {
      pic: Udecrypt
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      // console.log(obj);
      if (isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if (obj) {
        if (obj.status == 'error8') {
          $('#tbTempMutasi').find('tbody').append(
            "<tr><td width='400px'>&nbsp;" +
            "</td><td class='center' >" +
            "</td><td class='center'></td></tr>");
        } else {
          jmlData = obj.length;
          for (a = 0; a < jmlData; a++) {
            $('#tbTempMutasi').find('tbody').append(
              "<tr id='" + a + "'><td class='center'><i class='trash actdeleteprjid iconcoloredit icon' id='" + obj[a]["id_temp"] + "'></i></td>" +
              "<td width='400px'>" + obj[a]["nomor_aktiva"] +
              "</td><td class='center' width='80px'>" + obj[a]["material_number"] +
              "</td><td class='center' width='150px'>" + obj[a]["description"] +
              "</td><td class='center' width='150px'>" + obj[a]["merk"] +
              "</td><td class='center' width='150px'>" + obj[a]["vendor_material_number"] +
              "</td><td class='center' width='150px'>" + obj[a]["pic_baru"] +
              "</td></tr>");
          }

          //Hapus Project ID
          $('.actdeleteprjid').on('click', function (e) {
            var IdTemp = $(this).attr('id');
            $.ajax({
              type: "POST",
              url: `${restlocactiva}Delete_TempAktivaMutasi`,
              headers: {
                user: vusrnm,
                token: vtoken
              },
              data: {
                IdTemp: IdTemp
              },
              cache: false,
              success: function (response) {
                var obj = JSON.parse(response);
                if (obj.status == false) {
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  LoadTempAktivaMutasi();
                }
              },
              error: function () {
                IsTimeOut(LogoutProtect);
              },
            });
          });
        }
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function LoadTempAktivaEditMutasi() {
  $('#tbTempEditMutasi').find('tbody').empty();
  $.ajax({
    type: "POST",
    url: `${restlocactiva}read_tempeditMutasi`,
    headers: {
      user: vusrnm,
      token: vtoken
    },
    data: {
      pic: Udecrypt,
      noMutasi: no_mutasi
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      // console.log(obj);
      if (isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if (obj) {
        if (obj.status == 'error8') {
          $('#tbTempMutasi').find('tbody').append(
            "<tr><td width='400px'>&nbsp;" +
            "</td><td class='center' >" +
            "</td><td class='center'></td></tr>");
        } else {
          jmlData = obj.length;
          for (a = 0; a < jmlData; a++) {
            $('#tbTempEditMutasi').find('tbody').append(
              "<tr id='" + a + "'><td class='center'><i class='trash actdeleteprjid iconcoloredit icon' id='" + obj[a]["id_temp"] + "'></i></td>" +
              "<td width='400px'>" + obj[a]["nomor_aktiva"] +
              "</td><td class='center' width='80px'>" + obj[a]["material_number"] +
              "</td><td class='center' width='150px'>" + obj[a]["description"] +
              "</td><td class='center' width='150px'>" + obj[a]["merk"] +
              "</td><td class='center' width='150px'>" + obj[a]["vendor_material_number"] +
              "</td><td class='center' width='150px'>" + obj[a]["pic_baru"] +
              "</td></tr>");
          }

          //Hapus Project ID
          $('.actdeleteprjid').on('click', function (e) {
            var IdTemp = $(this).attr('id');
            $.ajax({
              type: "POST",
              url: `${restlocactiva}Delete_TempAktivaMutasi`,
              headers: {
                user: vusrnm,
                token: vtoken
              },
              data: {
                IdTemp: IdTemp
              },
              cache: false,
              success: function (response) {
                var obj = JSON.parse(response);
                if (obj.status == false) {
                  IsResponseFalse(obj.message);
                } else {
                  IsResponseTrue(obj.message);
                  LoadTempAktivaEditMutasi();
                }
              },
              error: function () {
                IsTimeOut(LogoutProtect);
              },
            });
          });
        }
      }
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
}

function TableListFunc(FilterCariMutasi, FilterPICMutasi, FilterStatusMutasi, FilterProgressMutasi) {
  var DTables = $("#tableListMutasi").DataTable({
    dom: "<'ui stackable grid'" +
      "<'row'" +
      "<'left aligned sixteen wide column'>" +
      ">" +
      "<'row dt-table'" +
      "<'sixteen wide column'tr>" +
      ">" +
      "<'row'" +
      "<'left aligned seven wide column'B>" +
      "<'left aligned two wide column'i>" +
      "<'right aligned seven wide column'p>" +
      ">" +
      ">",
    buttons: [{
        text: "10",
        action: function (e, dt, node, config) {
          $("#tableListMutasi").DataTable().page.len(10).draw();
        },
      },
      {
        text: "25",
        action: function (e, dt, node, config) {
          $("#tableListMutasi").DataTable().page.len(25).draw();
        },
      },
      {
        text: "50",
        action: function (e, dt, node, config) {
          $("#tableListMutasi").DataTable().page.len(50).draw();
        },
      },
      {
        text: "100",
        action: function (e, dt, node, config) {
          $("#tableListMutasi").DataTable().page.len(100).draw();
        },
      },
      {
        text: "1000",
        action: function (e, dt, node, config) {
          $("#tableListMutasi").DataTable().page.len(1000).draw();
        },
      },
    ],
    destroy: true,
    stateSave: true,
    processing: true,
    deferRender: true,
    serverSide: true,
    orderClasses: false,
    pageLength: 10,
    data: [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Pencarian..",
      processing: '<i class="circle notch loading icon huge"></i>',
      info: "_START_ sampai _END_ dari _TOTAL_ total data",
      paginate: {
        "first": "Awal",
        "last": "Akhir",
        "next": "Berikutnya",
        "previous": "Sebelumnya"
      },
      infoEmpty: "Tidak ada data",
      select: {
        rows: ""
      }
    },
    order: [
      [2, "desc"]
    ],
    columns: [{
        data: 'material_number'
      },
      {
        data: 'description'
      },
      {
        data: 'merk'
      },
      {
        data: 'vendor_material_number'
      },
      {
        data: 'no_seri'
      },
      {
        data: 'vendor'
      },
      {
        data: 'pic_baru'
      },
      {
        data: 'detail_status'
      },
      {
        data: 'detail_progress'
      },

    ],
    columnDefs: [{
        className: "center aligned",
        targets: [2]
      },
      {
        className: "collapsing",
        targets: [3, 7, 8]
      },
      {
        targets: [7, 8],
        orderable: false
      },
    ],

    createdRow: function (row, data, index) {

      //WARNA OWNER & STATUS ACTIVE/DRAFT
      if (data["peminta"] == Udecrypt) {
        $(row).find("td").css("color", ColorOwner);
      }

    },

    ajax: {
      url: `${restlocactiva}getListMutasi`,
      type: "POST",
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        FSearch: FilterCariMutasi,
        FNama: FilterPICMutasi,
        FStatus: FilterStatusMutasi,
        FProgress: FilterProgressMutasi,
      },

      error: function () {
        if (LogoutProtect) {
          window.location.href = "./?link=loclogout";
        } else {
          Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
        }
      },
    },
  });
}

$("#tableListMutasi").on("click", ".btnAddData", function () {
  var eid = $(this).attr("eid");
  // let encryption = new Encryption();
  var eidENC = Ucrypt.encrypt(eid, NonceValue);
  window.location.href = "./?link=aktivaAddItem&i=" + eidENC;
});

$('#createTempMutasi').on('click', function () {
  data = [{
    inputNoAktivaMutasi: $("#inputNoAktivaMutasi").val(),
    inputNIKMutasi: $("#inputNIKMutasi").val(),
    inputNamaMutasi: $("#inputNamaMutasi").val(),
    inputDeptMutasi: $("#inputDeptMutasi").val(),
    pic: Udecrypt,
  }, ];
  $.ajax({
    type: "POST",
    url: `${restlocactiva}CreateTempMutasi`,
    headers: {
      user: vusrnm,
      token: vtoken
    },
    data: {
      data: data
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if (obj) {
        if (obj.status === false) {
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          // window.location.href = "./?link=aktiva";
          LoadTempAktivaMutasi();
        }
      } else {
        Swal.fire('Error', 'Ada kendal di koneksi/database, data tidak tersimpan !', 'error')
      }
    },
    error: function () {
      if (LogoutProtect) {
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
      }
    },
  });
});

$('#btnInsertMutasi').on('click', function () {
  data = [{
    inputNoAktivaMutasi: $("#inputNoAktivaMutasi").val(),
    inputNIKMutasi: $("#inputNIKMutasi").val(),
    inputNamaMutasi: $("#inputNamaMutasi").val(),
    inputDeptMutasi: $("#inputDeptMutasi").val(),
    inputNotesMutasi: $("#inputNotesMutasi").val(),
    inputPICAktiva: $("#inputPICAktiva").val(),
    inputDeptAktiva: $("#inputDeptAktiva").val(),
    inputNIKAktiva: $("#inputNIKAktiva").val(),
    pic: Udecrypt,
  }, ];
  $.ajax({
    type: "POST",
    url: `${restlocactiva}CreateMutasi`,
    headers: {
      user: vusrnm,
      token: vtoken
    },
    data: {
      data: data
    },
    cache: false,
    success: function (response) {
      var obj = JSON.parse(response);
      if (isEmpty(obj)) {
        IsResponseEmptyObj();
      } else if (obj) {
        if (obj.status == false) {
          IsResponseFalse(obj.message);
        } else {
          IsResponseTrue(obj.message);
          // window.location.href = "./?link=aktiva";
          LoadTempAktivaMutasi();
        }
      } else {
        Swal.fire('Error', 'Ada kendal di koneksi/database, data tidak tersimpan !', 'error')
      }
    },
    error: function () {
      if (LogoutProtect) {
        window.location.href = "./?link=loclogout";
      } else {
        Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
      }
    },
  });
});

$('#btnCreateMutasi').click(function () {
  window.location.href = "./?link=aktivaCreateMutasi";
});

$('#dwnldxlsmutasi').on('click', function () {
  var FilterCariMutasi = $("#FilterCariMutasi").val();
  var FilterPICMutasi = $("#FilterPICMutasi").val();
  var FilterStatusMutasi = $("#FilterStatusMutasi").val();
  var FilterProgressMutasi = $("#FilterProgressMutasi").val();
  $.ajax({
    type: "GET",
    url: `${restlocpscxls}DownloadExcelListMutasi`,
    headers: {
      user: vusrnm,
      token: vtoken,
    },
    data: {
      FSearch: FilterCariMutasi,
      FNama: FilterPICMutasi,
      FStatus: FilterStatusMutasi,
      FProgress: FilterProgressMutasi,
    },
    cache: false,
    success: function (response) {
      window.location.href = "../RND_Upload/Aktiva/Excel/ListItemMutasi.xlsx";
    },
    error: function () {
      IsTimeOut(LogoutProtect);
    },
  });
});


$(document).ready(function () {


  $("#signApprovalWO").click(function () {
    window.location.href = "./?link=aktivaSignApprovalWriteoff";
  });

  $('#btnAddManual').click(function () {
    window.location.href = "./?link=aktivaKeyIn";
  });

  $('#btnBackEditMutasi').click(function(){
    console.log("Tes");
  })

  $('#btnCancelAdd').click(function () {
    window.location.href = "./?link=aktiva";
  });


  //Read Filter Cookies
  var d = new Date();
  var yearnow = d.getFullYear();

  var json_str = getCookie('FilterListMutasiActiva');
  var arr = JSON.parse(json_str);
  if (json_str) {
    var sfilter = arr[0];
    var pfilter = arr[1];
    var stfilter = arr[2];
    var pgfilter = arr[3];
  } else {
    var sfilter = "";
    var pfilter = "ALL";
    var stfilter = "ALL";
    var pgfilter = "ALL";
  }

  if (sfilter) {
    $("#FilterCariMutasi").val(sfilter);
    var sfilterstart = sfilter;
  } else {
    var sfilterstart = "";
  }
  if (pfilter) {
    $("#FilterPICMutasi").dropdown("set selected", pfilter);
    var pfilterstart = pfilter;
  } else {
    var pfilterstart = "ALL";
  }
  if (stfilter) {
    $("#FilterStatusMutasi").dropdown("set selected", stfilter);
    var stfilterstart = stfilter;
  } else {
    var stfilterstart = "ALL";
  }
  if (pgfilter) {
    $("#FilterProgressMutasi").dropdown("set selected", pgfilter);
    var pgfilterstart = pgfilter;
  } else {
    var pgfilterstart = "ALL";
  }

  var FiterArry = [sfilterstart, pfilterstart, stfilterstart, pgfilterstart];
  var JsonFilter = JSON.stringify(FiterArry);
  setCookie("FilterListMutasiActiva", JsonFilter, 5);

  TableListFunc(sfilterstart, pfilterstart, stfilterstart, pgfilterstart);

  $("#addnewmutasi").on("click", function () {
    window.location.href = "./?link=aktivaKeyIn";
  });

  $("#tableListItem").on("click", ".signItemAdd", function () {
    var eid = $(this).attr("eid");
    window.location.href = "./?link=aktivaSignAdd&n=" + eid;
  });

  $('[data-toggle="datepicker"]').datepicker({
    format: 'yyyy-mm-dd',
    autoHide: true,
    weekStart: 1
  });

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $("#FilterCariMutasi").on("keyup", function () {
    var FilterCariMutasi = $("#FilterCariMutasi").val();
    var FilterPICMutasi = $("#FilterPICMutasi").val();
    var FilterStatusMutasi = $("#FilterStatusMutasi").val();
    var FilterProgressMutasi = $("#FilterProgressMutasi").val();
    var FiterArry = [FilterCariMutasi, FilterPICMutasi, FilterStatusMutasi, FilterProgressMutasi];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterListMutasiActiva", JsonFilter, 5);
    $("#tableListMutasi").DataTable().destroy();
    TableListFunc(FilterCariMutasi, FilterPICMutasi, FilterStatusMutasi, FilterProgressMutasi);
    $("#tableListMutasi").DataTable().page(0).draw();

  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $("#FilterPICMutasi, #FilterStatusMutasi, #FilterProgressMutasi").on(
    "change",
    function () {
      var FilterCariMutasi = $("#FilterCariMutasi").val();
      var FilterPICMutasi = $("#FilterPICMutasi").val();
      var FilterStatusMutasi = $("#FilterStatusMutasi").val();
      var FilterProgressMutasi = $("#FilterProgressMutasi").val();
      var FiterArry = [FilterCariMutasi, FilterPICMutasi, FilterStatusMutasi, FilterProgressMutasi];
      var JsonFilter = JSON.stringify(FiterArry);
      setCookie("FilterListMutasiActiva", JsonFilter, 5);
      TableListFunc(FilterCariMutasi, FilterPICMutasi, FilterStatusMutasi, FilterProgressMutasi);
      // var table = $("#PSSList").DataTable();
      // var inff = table.page.info();
      // console.log(inff);
      $("#tableListMutasi").DataTable().page(0).draw();

    }
  );

  // //RESET FILTER
  $(".resetfilter").on("click", function () {
    var d = new Date();
    var yearnow = d.getFullYear();
    $("#FilterCariMutasi").val("");
    $("#FilterPICMutasi").dropdown("set selected", "ALL");
    $("#FilterStatusMutasi").dropdown("set selected", "ALL");
    $("#FilterProgressMutasi").dropdown("set selected", "ALL");
    var FiterArry = ["", "ALL", "ALL", "ALL"];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterListMutasiActiva", JsonFilter, 5);
    $("#tableListMutasi").DataTable().destroy();
    TableListFunc("", "ALL", "ALL", "ALL");
    $("#tableListMutasi").DataTable().page(0).draw();

  });

  // $("#FilterPICMutasi").on('change', function(){
  //     var pic = document.getElementById("FilterPICMutasi").value;
  //     var jenis = document.getElementById("filterJenis").value;
  //     TableListFunc(pic, jenis);
  // });

  // $("#filterJenis").on('change', function(){
  //     var pic = document.getElementById("FilterPICMutasi").value;
  //     var jenis = document.getElementById("filterJenis").value;
  //     TableListFunc(pic, jenis);
  // });

  $('.ui.dropdown').dropdown();

  var typeM = 'm'
  //baseunit autocomplete
  $('.nmrAktivaMutasi')
    .search({
      apiSettings: {
        url: '3_aktiva/_autocompletenoaktiva.php?q={query}&ty=' + typeM
      },
      fields: {
        results: 'data',
        title: 'nomor_aktiva',
      },
      minCharacters: 1,
      onSelect: function (response) {
        console.log(response.nik);
        $('#inputPICAktiva').val(response.peminta);
        $('#inputNIKAktiva').val(response.nik);
        $('#inputDeptAktiva').val(response.department);
        // LoadDataHRIS();
      },
    });

  $('.ui.search.nama')
    .search({
      apiSettings: {
        url: '3_aktiva/_autocompletenik.php?q={query}'
      },
      fields: {
        results: 'data',
        title: 'name',
        description: 'nik'
      },
      minCharacters: 1,
      onSelect: function (response) {
        console.log(response.name);
        $('#inputNIKMutasi').val(response.nik);
        $('#inputNamaMutasi').val(response.name);
        $('#inputDeptMutasi').val(response.department);
        // LoadDataHRIS();
      },
    });

  $.ajax({
    type: "GET",
    url: "3_aktiva/_artemis.php",
    cache: false,
    success: function (response) {
      setCookie('atoken', response, 1 / 24);
    },
    // error: function () {
    //     if (fungsilogout) {

    //         window.location.href = "./_logout.php";
    //     } else {
    //         console.log("error session")
    //     }
    // }
  });

  $('#inputNoAktivaMutasi').keyup(function (event) {
    if (event.keyCode == 13) {
      loadDataMutasi();
    }
  });




});