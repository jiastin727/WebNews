const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo = "#00139f";
const ColorOwner = "#00139f";
const BgColorOwner = "#e0ffd7";
const ColorRelease = "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var restlocactiva = decodeURIComponent(getCookie("restlocactiva"));
var restlocpscxls = decodeURIComponent(getCookie("restlocpscxls"));
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Jdecrypt = Ucrypt.decrypt(EncJ, NonceValue);

if (id_writeoff) {

    LoadDataAktiva(id_writeoff);

}

function LoadDataHRIS() {
    var itype = $('#NIKAktiva').val();
    console.log(itype);
    if (itype) {
        $('.NIKInput').addClass('loading');
        $.ajax({
            type: "POST",
            url: `${restlocactiva}datahris`,
            headers: {
                user: vusrnm,
                token: vtoken
            },
            data: {
                nik: itype,
            },
            cache: false,
            success: function (response) {
                var obj = JSON.parse(response);
                if (response.length > 3) {
                    var nm = obj.name;
                    var dept = obj.department;
                    var bag = obj.ou_desc;
                    $('.NIKInput').removeClass('loading');
                    $('#PICAktiva').val(GetValuePTB(nm));
                    $('#NamaHistoryAktiva').val(GetValuePTB(nm));
                    $('#BagianAktiva').val(GetValuePTB(bag));
                    $('#BagHistoryAktiva').val(GetValuePTB(bag));
                    $('#DeptAktiva').val(GetValuePTB(dept));
                    $('#DeptHistoryAktiva').val(GetValuePTB(dept));

                } else {

                    $('.NIKInput').removeClass('loading');
                    $('#PICAktiva').val('-');
                    $('#BagianAktiva').val('-');
                    Swal.fire({
                        text: "Data tidak ditemukan di Database PTB !",
                        timer: 3000,
                        toast: true,
                        showConfirmButton: false,
                    });
                }
            },
            error: function () {
                if (LogoutProtect) {
                    window.location.href = "./?link=loclogout";
                } else {
                    Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
                }
            },
        });
    }
}

$('#NIKAktiva').keyup(function (event) {
    if (event.keyCode == 13) {
        LoadDataHRIS();
    }
});

$('#NIKAktiva').on('blur', function () {
    LoadDataHRIS();
});

function GetValuePTB(a) {
    if (a) {
        return a;
    } else {
        return '-';
    }
}

function LoadDataAktiva(a) {
    $.ajax({
        type: "POST",
        url: `${restlocactiva}aktiva/load-aktiva/` + a,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        cache: false,
        success: function (data) {
            var obj = JSON.parse(data);
            $("#MerkAktiva").val();
            $("#DescAktiva").val(obj.description);
            $("#NoEquipAktiva").val();
            $("#NoAssetAktiva").val(obj.asset + obj.subnumber);
            $("#adminCC").val();
            $("#MatNumAktiva").val(obj.material_number);
            $("#NIKAktiva").val();
            $("#PlantAktiva").val();
            $("#PICAktiva").val();
            $("#VendorAktiva").val(obj.vendor);
            $("#VendorMatNumAktiva").val(obj.vendor_material_number);
            $("#NamaHistoryAktiva").val();
            $("#NoSeriAktiva").val();
            $("#BagHistoryAktiva").val();
            $("#JumlahAktiva").val(obj.qty);
            $("#golonganItem").val();
            $("#BaseUnitAktiva").val(obj.satuan);
            $("#statusBarang").val();
            $("#kodeStatus").val();
            $("#NOGRAktiva").val(obj.gr);
            $("#DateGRAktiva").val(obj.tgl_gr);
            $("#DateStatusAktiva").val();
            $("#PriceAktiva").val(obj.harga);
            $("#kalibrasiItem").val();
            $("#BuktiAktiva").val();
            $("#matauang").dropdown("set selected", obj.currency);
            $("#NoteAktiva").val();
            $("#GRYearAktiva").val(obj.gr_year);
            $("#GRLineAktiva").val(obj.gr_line);

        },
        error: function () {
            IsTimeOut(LogoutProtect);
        }
    });
}


function TableListFunc(FilterCariWO, FilterPICWO, FilterStatusWO, FilterProgressWO,FilterTahunWO) {
    var DTables = $("#tableApprovalWO").DataTable({
        dom: "<'ui stackable grid'" +
            "<'row'" +
            "<'left aligned sixteen wide column'>" +
            ">" +
            "<'row dt-table'" +
            "<'sixteen wide column'tr>" +
            ">" +
            "<'row'" +
            "<'left aligned seven wide column'B>" +
            "<'left aligned two wide column'i>" +
            "<'right aligned seven wide column'p>" +
            ">" +
            ">",
        buttons: [{
                text: "10",
                action: function (e, dt, node, config) {
                    $("#tableApprovalWO").DataTable().page.len(10).draw();
                },
            },
            {
                text: "25",
                action: function (e, dt, node, config) {
                    $("#tableApprovalWO").DataTable().page.len(25).draw();
                },
            },
            {
                text: "50",
                action: function (e, dt, node, config) {
                    $("#tableApprovalWO").DataTable().page.len(50).draw();
                },
            },
            {
                text: "100",
                action: function (e, dt, node, config) {
                    $("#tableApprovalWO").DataTable().page.len(100).draw();
                },
            },
            {
                text: "1000",
                action: function (e, dt, node, config) {
                    $("#tableApprovalWO").DataTable().page.len(1000).draw();
                },
            },
        ],
        destroy: true,
        stateSave: true,
        processing: true,
        deferRender: true,
        serverSide: true,
        orderClasses: false,
        pageLength: 10,
        data: [],
        language: {
            sLengthMenu: "_MENU_",
            search: "",
            searchPlaceholder: "Pencarian..",
            processing: '<i class="circle notch loading icon huge"></i>',
            info: "_START_ sampai _END_ dari _TOTAL_ total data",
            paginate: {
                "first": "Awal",
                "last": "Akhir",
                "next": "Berikutnya",
                "previous": "Sebelumnya"
            },
            infoEmpty: "Tidak ada data",
            select: {
                rows: ""
            }
        },
        order: [
            [1, "desc"]
        ],
        columns: [{
                data: null,
                render: function (data) {
                    return `<span class="btnpdf" data-tooltip = "Download PDF Write Off" data-inverted="" data-variation="basic" eid="${data['id']}"><i class="file pdf circular iconcolordelete icon"></i></span>`;
                },
            },
            {
                data: null,
                render: function (data) {
                    return `<span class="signItemAdd" data-tooltip = "Sign dan Detail Approval Write Off" data-inverted="" data-variation="basic" eid="${data['id']}">${data['no_writeoff']}</span>`;
                },
            },
            {
                data: 'nmr_aktiva'
            },
            {
                data: 'descItem'
            },
            {
                data: 'peminta'
            },
            {
                data: 'notes'
            },
            {
                data: 'detail_status'
            },
            {
                data: 'detail_progress'
            },

        ],
        columnDefs: [
              {
                className: "center aligned",
                targets: [0]
              },
            //   {
            //     className: "collapsing",
            //     targets: [3, 7, 8]
            //   },
            {
                targets: [0],
                orderable: false
            },
        ],

        createdRow: function (row, data, index) {

            //WARNA OWNER & STATUS ACTIVE/DRAFT
            if (data["peminta"] == Udecrypt) {
                $(row).find("td").css("color", ColorOwner);
            }
            
            if (data["detail_status"] == "FINISH") {
                $(row).find("td").css("color", ColorRelease);
              }

            if (data["peminta"] == Udecrypt && data['detail_status'] == "FINISH") {
                $(row).find("td").css("background-color", BgColorOwner);
              }

            if (data["head_of_pic"] == Udecrypt) {
                $(row).find("td").css("color", ColorLock);
            }

        },

        ajax: {
            url: `${restlocactiva}getApprovalWriteOff`,
            type: "POST",
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data: {
                FSearch: FilterCariWO,
                FNama: FilterPICWO,
                FStatus: FilterStatusWO,
                FProgress: FilterProgressWO,
                FTahun: FilterTahunWO
            },

            error: function () {
                if (LogoutProtect) {
                    window.location.href = "./?link=loclogout";
                } else {
                    Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
                }
            },
        },
    });
}

$("#tableApprovalWO").on("click", ".btnAddData", function () {
    var eid = $(this).attr("eid");
    // let encryption = new Encryption();
    var eidENC = Ucrypt.encrypt(eid, NonceValue);
    window.location.href = "./?link=aktivaAddItem&i=" + eidENC;
});

$("#tableApprovalWO").on("click", ".btnpdf", function () {
    var noWO = $(this).attr("eid");
    var no_wo = Ucrypt.encrypt(noWO, NonceValue);
    $('<a href="./?link=viewwopdf&i='+no_wo+'" target="blank"></a>')[0].click(); 
    // window.location.href = "./?link=viewwopdf&i=" + no_wo;
    
});

$('#btnAddtoDB').on('click', function () {
    data = [{
        // IdMkg         : IdEdit,
        JnsAct: $("#JenisAktiva").val(),
        MrkAct: $("#MerkAktiva").val(),
        DscAct: $("#DescAktiva").val(),
        EqpAct: $("#NoEquipAktiva").val(),
        AstAct: $("#NoAssetAktiva").val(),
        CstAct: $("#adminCC").val(),
        MatAct: $("#MatNumAktiva").val(),
        NikAct: $("#NIKAktiva").val(),
        Plant: $("#PlantAktiva").val(),
        user: Udecrypt,
        PicAct: $("#PICAktiva").val(),
        DeptAct: $("#DeptAktiva").val(),
        VendAct: $("#VendorAktiva").val(),
        VMatAct: $("#VendorMatNumAktiva").val(),
        NamHAct: $("#NamaHistoryAktiva").val(),
        DeptHAct: $("#DeptHistoryAktiva").val(),
        SeriAct: $("#NoSeriAktiva").val(),
        BagHAct: $("#BagHistoryAktiva").val(),
        JmlAct: $("#JumlahAktiva").val(),
        GolAct: $("#golonganItem").val(),
        BaseAct: $("#BaseUnitAktiva").val(),
        StBrAct: $("#statusBarang").val(),
        KDStAct: $("#kodeStatus").val(),
        NoGRAct: $("#NOGRAktiva").val(),
        DtGrAct: $("#DateGRAktiva").val(),
        GRyrAct: $("#GRYearAktiva").val(),
        PrceAct: $("#PriceAktiva").val(),
        KalbAct: $("#kalibrasiItem").val(),
        GRLnAct: $("#GRLineAktiva").val(),
        CurrAct: $("#matauang").val(),
        NoteAct: $("#NoteAktiva").val(),
    }, ];
    $.ajax({
        type: "POST",
        url: `${restlocactiva}CreateItemManual`,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            data: data
        },
        cache: false,
        success: function (response) {
            var obj = JSON.parse(response);
            if (isEmpty(obj)) {
                IsResponseEmptyObj();
            } else if (obj) {
                if (obj.status == false) {
                    IsResponseFalse(obj.message);
                } else {
                    IsResponseTrue(obj.message);
                    window.location.href = "./?link=aktiva";
                }
            } else {
                Swal.fire('Error', 'Ada kendal di koneksi/database, data tidak tersimpan !', 'error')
            }
        },
        error: function () {
            if (LogoutProtect) {
                window.location.href = "./?link=loclogout";
            } else {
                Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
            }
        },
    });
});

$("#HeaderButtonEdit").click(function () {
    data = [{
        // IdMkg         : IdEdit,
        JnsAct: $("#JenisAktiva").val(),
        MrkAct: $("#MerkAktiva").val(),
        DscAct: $("#DescAktiva").val(),
        EqpAct: $("#NoEquipAktiva").val(),
        AstAct: $("#NoAssetAktiva").val(),
        CstAct: $("#adminCC").val(),
        MatAct: $("#MatNumAktiva").val(),
        NikAct: $("#NIKAktiva").val(),
        Plant: $("#PlantAktiva").val(),
        user: Udecrypt,
        PicAct: $("#PICAktiva").val(),
        DeptAct: $("#DeptAktiva").val(),
        VendAct: $("#VendorAktiva").val(),
        VMatAct: $("#VendorMatNumAktiva").val(),
        NamHAct: $("#NamaHistoryAktiva").val(),
        DeptHAct: $("#DeptHistoryAktiva").val(),
        SeriAct: $("#NoSeriAktiva").val(),
        BagHAct: $("#BagHistoryAktiva").val(),
        JmlAct: $("#JumlahAktiva").val(),
        GolAct: $("#golonganItem").val(),
        BaseAct: $("#BaseUnitAktiva").val(),
        StBrAct: $("#statusBarang").val(),
        KDStAct: $("#kodeStatus").val(),
        NoGRAct: $("#NOGRAktiva").val(),
        DtGrAct: $("#DateGRAktiva").val(),
        GRyrAct: $("#GRYearAktiva").val(),
        PrceAct: $("#PriceAktiva").val(),
        KalbAct: $("#kalibrasiItem").val(),
        GRLnAct: $("#GRLineAktiva").val(),
        CurrAct: $("#matauang").val(),
        NoteAct: $("#NoteAktiva").val(),
    }, ];
    console.log(data);
    $.ajax({
        type: "POST",
        url: `${restlocactiva}CreateItemMutasi/` + id_writeoff,
        headers: {
            user: vusrnm,
            token: vtoken
        },
        data: {
            data: data
        },
        cache: false,
        success: function (response) {
            var obj = JSON.parse(response);
            if (isEmpty(obj)) {
                IsResponseEmptyObj();
            } else if (obj) {
                if (obj.status == false) {
                    IsResponseFalse(obj.message);
                } else {
                    IsResponseTrue(obj.message);
                    window.location.href = "./?link=aktiva";
                }
            } else {
                Swal.fire('Error', 'Ada kendal di koneksi/database, data tidak tersimpan !', 'error')
            }
        },
        error: function () {
            if (LogoutProtect) {
                window.location.href = "./?link=loclogout";
            } else {
                Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !", "error");
            }
        },
    });
});

$('#btnDownloadExcelWriteoff').on('click', function () {
    var FilterCariWO = $("#FilterCariWO").val();
    var FilterPICWO = $("#FilterPICWO").val();
    var FilterStatusWO = $("#FilterStatusWO").val();
    var FilterProgressWO = $("#FilterProgressWO").val();
    var FilterTahunWO = $("#fthn_wo").val();
    $.ajax({
        type: "GET",
        url: `${restlocpscxls}DownloadExcelWriteoff`,
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: {
            FSearch: FilterCariWO,
            FNama: FilterPICWO,
            FStatus: FilterStatusWO,
            FProgress: FilterProgressWO,
            FTahun : FilterTahunWO
        },
        cache: false,
        success: function (response) {
            window.location.href = "../RND_Upload/Aktiva/Excel/ListItemWriteoff.xlsx";
        },
        error: function () {
            IsTimeOut(LogoutProtect);
        },
    });
});


$(document).ready(function () {

    $("#signApprovalWO").click(function () {
        window.location.href = "./?link=aktivaSignApprovalWriteoff";
    });

    $('#btnCreateWriteoff').click(function () {
        window.location.href = "./?link=aktivaCreateWriteoff";
    });


    $('#btnCancelAdd').click(function () {
        window.location.href = "./?link=aktiva";
    });


    //Read Filter Cookies
    var d = new Date();
    var yearnow = d.getFullYear();

    var json_str = getCookie('FilterWoActiva');
    var arr = JSON.parse(json_str);
    if (json_str) {
        var sfilter = arr[0];
        var pfilter = arr[1];
        var stfilter = arr[2];
        var pgfilter = arr[3];
        var thfilter = arr[4];
    } else {
        var sfilter = "";
        var pfilter = Udecrypt;
        var stfilter = "ALL";
        var pgfilter = "ALL";
        var thfilter = "ALL";
    }

    if (sfilter) {
        $("#FilterCariWO").val(sfilter);
        var sfilterstart = sfilter;
    } else {
        var sfilterstart = "";
    }
    if (pfilter) {
        $("#FilterPICWO").dropdown("set selected", pfilter);
        var pfilterstart = pfilter;
    } else {
        var pfilterstart = Udecrypt;
    }
    if (stfilter) {
        $("#FilterStatusWO").dropdown("set selected", stfilter);
        var stfilterstart = stfilter;
    } else {
        var stfilterstart = "ALL";
    }
    if (pgfilter) {
        $("#FilterProgressWO").dropdown("set selected", pgfilter);
        var pgfilterstart = pgfilter;
    } else {
        var pgfilterstart = "ALL";
    }
    if (thfilter) {
        $("#fthn_wo").dropdown("set selected", thfilter);
        var thfilterstart = thfilter;
    } else {
        var thfilterstart = "ALL";
    }

    var FiterArry = [sfilterstart, pfilterstart, stfilterstart, pgfilterstart,thfilterstart];
    var JsonFilter = JSON.stringify(FiterArry);
    setCookie("FilterWoActiva", JsonFilter, 5);

    TableListFunc(sfilterstart, pfilterstart, stfilterstart, pgfilterstart,thfilterstart);

    $("#addnewmutasi").on("click", function () {
        window.location.href = "./?link=aktivaKeyIn";
    });

    $("#tableApprovalWO").on("click", ".signItemAdd", function () {
        var eid = $(this).attr("eid");
        // let encryption = new Encryption();
        var wo = Ucrypt.encrypt(eid, NonceValue);
        window.location.href = "./?link=aktivaSignApprovalWriteoff&n=" + wo;
    });

    $('[data-toggle="datepicker"]').datepicker({
        format: 'yyyy-mm-dd',
        autoHide: true,
        weekStart: 1
    });

    //RESPON KETIKA INPUT PENCARIAN DI KETIK
    $("#FilterCariWO").on("keyup", function () {
        var FilterCariWO = $("#FilterCariWO").val();
        var FilterPICWO = $("#FilterPICWO").val();
        var FilterStatusWO = $("#FilterStatusWO").val();
        var FilterProgressWO = $("#FilterProgressWO").val();
        var FilterTahunWO = $("#fthn_wo").val();
        var FiterArry = [FilterCariWO, FilterPICWO, FilterStatusWO, FilterProgressWO,FilterTahunWO];
        var JsonFilter = JSON.stringify(FiterArry);
        setCookie("FilterWoActiva", JsonFilter, 5);
        $("#tableApprovalWO").DataTable().destroy();
        TableListFunc(FilterCariWO, FilterPICWO, FilterStatusWO, FilterProgressWO,FilterTahunWO);
        $("#tableApprovalWO").DataTable().page(0).draw();

    });

    //RESPON KETIKA FILTER TAHUN DI RUBAH
    $("#FilterPICWO, #FilterStatusWO, #FilterProgressWO, #fthn_wo").on(
        "change",
        function () {
            var FilterCariWO = $("#FilterCariWO").val();
            var FilterPICWO = $("#FilterPICWO").val();
            var FilterStatusWO = $("#FilterStatusWO").val();
            var FilterProgressWO = $("#FilterProgressWO").val();
            var FilterTahunWO = $("#fthn_wo").val();
            var FiterArry = [FilterCariWO, FilterPICWO, FilterStatusWO, FilterProgressWO,FilterTahunWO];
            var JsonFilter = JSON.stringify(FiterArry);
            setCookie("FilterWoActiva", JsonFilter, 5);
            TableListFunc(FilterCariWO, FilterPICWO, FilterStatusWO, FilterProgressWO,FilterTahunWO);
            // var table = $("#PSSList").DataTable();
            // var inff = table.page.info();
            // console.log(inff);
            $("#tableApprovalWO").DataTable().page(0).draw();

        }
    );

    // //RESET FILTER
    $(".resetfilter").on("click", function () {
        var d = new Date();
        var yearnow = d.getFullYear();
        $("#FilterCariWO").val("");
        $("#FilterPICWO").dropdown("set selected", Udecrypt);
        $("#FilterStatusWO").dropdown("set selected", "ALL");
        $("#FilterProgressWO").dropdown("set selected", "ALL");
        $("#fthn_wo").dropdown("set selected", yearnow);
        var FiterArry = ["", Udecrypt, "ALL", "ALL",yearnow];
        var JsonFilter = JSON.stringify(FiterArry);
        setCookie("FilterWoActiva", JsonFilter, 5);
        $("#tableApprovalWO").DataTable().destroy();
        TableListFunc("", Udecrypt, "ALL", "ALL",yearnow);
        $("#tableApprovalWO").DataTable().page(0).draw();

    });

    // $("#FilterPICWO").on('change', function(){
    //     var pic = document.getElementById("FilterPICWO").value;
    //     var jenis = document.getElementById("filterJenis").value;
    //     TableListFunc(pic, jenis);
    // });

    // $("#filterJenis").on('change', function(){
    //     var pic = document.getElementById("FilterPICWO").value;
    //     var jenis = document.getElementById("filterJenis").value;
    //     TableListFunc(pic, jenis);
    // });

    $('.ui.dropdown').dropdown();

    $('.nmrAktivaMutasi')
        .search({
            apiSettings: {
                url: '3_aktiva/_autocompletenoaktiva.php?q={query}'
            },
            fields: {
                results: 'data',
                title: 'nomor_aktiva',
            },
            minCharacters: 1
        });

    $('.ui.search.nama')
        .search({
            apiSettings: {
                url: '3_aktiva/_autocompletenik.php?q={query}'
            },
            fields: {
                results: 'data',
                title: 'name',
                description: 'nik'
            },
            minCharacters: 1
        });

    $.ajax({
        type: "GET",
        url: "3_aktiva/_artemis.php",
        cache: false,
        success: function (response) {
            setCookie('atoken', response, 1 / 24);
        },
        // error: function () {
        //     if (fungsilogout) {

        //         window.location.href = "./_logout.php";
        //     } else {
        //         console.log("error session")
        //     }
        // }
    });

    $('#inputNoAktivaMutasi').keyup(function (event) {
        if (event.keyCode == 13) {
            loadDataMutasi();
        }
    });



});