

const NonceValue = "rdsystem2020";
const LogoutProtect = false;

const ColorSignNo  = "#00139f";
const ColorOwner  = "#00139f";
const BgColorOwner  = "#eff0ff";
const ColorRelease= "#505050";
const ColorCancel = "#be0000";
const ColorLock = "#860954";
const BgColorLock = "#f3ebeb";

var restlocactiva = decodeURIComponent(getCookie("restlocactiva"));
var restlocpscxls = decodeURIComponent(getCookie("restlocpscxls"));
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
let Ucrypt = new Encryption();
var Udecrypt = Ucrypt.decrypt(EncU, NonceValue);
var Jdecrypt = Ucrypt.decrypt(EncJ, NonceValue);

// console.log(Udecrypt);/

function TableListFunc(FilterCariItem,FilterPICItem, FilterJenisItem, FilterStatusItem, FilterProgressItem,FilterTahunItem) {
    var DTables = $("#tableListItem").DataTable({
      dom:
        "<'ui stackable grid'" +
        "<'row'" +
        "<'left aligned sixteen wide column'>" +
        ">" +
        "<'row dt-table'" +
        "<'sixteen wide column'tr>" +
        ">" +
        "<'row'" +
        "<'left aligned seven wide column'B>" +
        "<'left aligned two wide column'i>" +
        "<'right aligned seven wide column'p>" +
        ">" +
        ">",
      buttons: [
        {
          text: "10",
          action: function (e, dt, node, config) {
            $("#tableListItem").DataTable().page.len(10).draw();
          },
        },
        {
          text: "25",
          action: function (e, dt, node, config) {
            $("#tableListItem").DataTable().page.len(25).draw();
          },
        },
        {
          text: "50",
          action: function (e, dt, node, config) {
            $("#tableListItem").DataTable().page.len(50).draw();
          },
        },
        {
          text: "100",
          action: function (e, dt, node, config) {
            $("#tableListItem").DataTable().page.len(100).draw();
          },
        },
        {
          text: "1000",
          action: function (e, dt, node, config) {
            $("#tableListItem").DataTable().page.len(1000).draw();
          },
        },
      ],
      destroy: true,
      stateSave: true,
      processing: true,
      deferRender: true,
      serverSide: true,
      orderClasses: false,
      pageLength: 10,
      data: [],
      language: {
        sLengthMenu: "_MENU_",
        search: "",
        searchPlaceholder: "Pencarian..",
        processing: '<i class="circle notch loading icon huge"></i>',
        info: "_START_ sampai _END_ dari _TOTAL_ total data",
        paginate: {
          "first":      "Awal",
          "last":       "Akhir",
          "next":       "Berikutnya",
          "previous":   "Sebelumnya"
        },
        infoEmpty:      "Tidak ada data",
        select: {
          rows: ""
        }
      },
      order: [[1, "desc"]],
      columns: [
        {
          data: null,
          render: function (data) {
            return `<span class="btnexcel"  data-tooltip='Perubahan Kalibrasi Instrument' data-inverted='' data-variation='basic' eid="${data['id']}" eno="${data['nmr_aktiva']}"><i class="file excel circular iconcoloredit icon"></i></span>`;
          },
        },
        { data: 'create_date' },
        {
          data: null,
          render: function (data) {
            return `<span class="signItemAdd" data-tooltip='Sign Aktiva dan Detail Aktiva' eid = "${data['id']}">${data['nmr_aktiva']}</span>`;
          },
        },
        { data: 'jenis' },
        { data: 'kalibrasi' },
        { data: 'material_number' },
        { data: 'description' },
        { data: 'peminta' },
        { data: 'cost_center' },
        { data: 'vendor' },
        { data: 'status' },
        { data: 'progress' },
        // { data: 'qty' },
        // { data: 'currency' },
        // { data: 'harga' },
        // { data: 'asset' },
        // { data: 'peminta' },
        
      ],
      columnDefs: [
        { className: "center aligned", targets: [1,3] },
        { className: "collapsing", targets: [4,8,9] },
        // { targets: [7,8], orderable: false },
        ],
  
     createdRow: function (row, data, index) {
  
        //WARNA OWNER & STATUS ACTIVE/DRAFT
        if (data["peminta"] == Udecrypt) {
          $(row).find("td").css("color", ColorOwner);
        }
  
      },
  
      ajax: {
        url: `${restlocactiva}getListItemSign`,
        type: "POST",
        headers: {
          user: vusrnm,
          token: vtoken,
        },
        data: {
          FSearch: FilterCariItem,
          FNama: FilterPICItem,
          FJenis: FilterJenisItem,
          FSts: FilterStatusItem,
          FProg: FilterProgressItem,
          FThn : FilterTahunItem
        },
        
        error: function () {
          if (LogoutProtect){
            window.location.href = "./?link=loclogout";
          } else {
            Swal.fire("Error", "Server tidak merespon, segera hubungi Administrator di ext. 3553 !","error" );
          }
        },
      },
    });
  }

  $('#dwnldxls').on('click', function() {
    var FilterCariItem = $("#fcariitemsign").val();
    var FilterPICItem = $("#filterPICItemsign").val();
    var FilterJenisItem = $("#filterJenisItemsign").val();
    var FilterStatusItem = $("#filterStatusItemsign").val();
    var FilterProgressItem = $("#filterProgressItemsign").val();
    var FilterTahunItem = $("#fthn_aktsign").val();
    $.ajax({
      type    : "GET",
      url     : `${restlocpscxls}DownloadExcelListItem`,
      headers: {
          user: vusrnm,
          token: vtoken,
      },
      data: {
        FSearch: FilterCariItem,
        FNama: FilterPICItem,
        FJenis: FilterJenisItem,
        FSts: FilterStatusItem,
        FProg: FilterProgressItem,
        FThn: FilterTahunItem
      },
      cache: false,
      success: function (response){
        window.location.href = "../RND_Upload/Aktiva/Excel/ListItemAktiva.xlsx";
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });

  $("#tableListItem").on("click", ".btnexcel", function () {
    var no_ak = $(this).attr("eid");
    var no_akt = $(this).attr("eno");
    var no_aktiva = Ucrypt.encrypt(no_ak, NonceValue);
    // $('<a href="./1_productspec/pscpdf.php?id='+eidpdf+'" target="blank"></a>')[0].click(); 
    $.ajax({
      type: "GET",
      url: `${restlocpscxls}DownloadExcelAktivaKal`,
      headers: {
        user: vusrnm,
        token: vtoken,
      },
      data: {
        no_aktiva : no_aktiva,
      },
      cache: false,
      success: function (response) {
        window.location.href = "../RND_Upload/Aktiva/Excel/Pendaftaran Kalibrasi Instrument "+no_akt+".xlsx";
      },
      error: function () {
        IsTimeOut(LogoutProtect);
      },
    });
  });


  $(document).ready(function () {

    $('#btnCancelAdd').click(function () {
        window.location.href = "./?link=aktiva";
    });

    $('#btnUpdateItem').click(function () {
        window.location.href = "./?link=aktivaListItem";
    });

    $('#btnEditHeaderAdd').click(function () {
        window.location.href = "./?link=aktivaEditItem";
    });

    $('#btnUploadAddPDF').click(function () {
        $('.xwinuploadaddpdf').modal('show');
    });

    $('.btnSign').click(function () {
        $('.xwinaddheadof').modal('show');
    });

    $('.CancelData').click(function () {
        $(".ui.modal").modal("hide");
    });

        //Read Filter Cookies
        var d = new Date();
        var yearnow = d.getFullYear();
    
        var json_str = getCookie('FilterItemActivaSign');
        var arr = JSON.parse(json_str);
        if(json_str){
            var sfilter = arr[0];
            var pfilter = arr[1];
            var jfilter = arr[2];
            var stfilter = arr[3];
            var pgfilter = arr[4];
            var thfilter = arr[5];
            // console.log(json_str);
        } else {
            var sfilter = "";
            var pfilter = Udecrypt;
            var jfilter = "ALL";
            var stfilter = "ALL";
            var pgfilter = "ALL";
            var thfilter = "ALL";
        }
        if (sfilter) {
            $("#fcariitemsign").val(sfilter);
            var sfilterstart = sfilter;
        } else {
            var sfilterstart = "";
        }
        if (pfilter) {
            $("#filterPICItemsign").dropdown("set selected", pfilter);
            var pfilterstart = pfilter;
        } else {
            var pfilterstart = Udecrypt;
        }
        if (jfilter) {
            $("#filterJenisItemsign").dropdown("set selected", jfilter);
            var jfilterstart = jfilter;
        } else {
            var jfilterstart = "ALL";
        }
        if (stfilter) {
          $("#filterStatusItemsign").dropdown("set selected", stfilter);
          var stfilterstart = stfilter;
        } else {
            var stfilterstart = "ALL";
        }
        if (pgfilter) {
          $("#filterProgressItemsign").dropdown("set selected", pgfilter);
          var pgfilterstart = pgfilter;
        } else {
            var pgfilterstart = "ALL";
        }
        if (thfilter) {
          $("#fthn_aktsign").dropdown("set selected", thfilter);
          var thfilterstart = thfilter;
        } else {
          var thfilterstart = "ALL";
        }
    
        var FiterArry = [sfilterstart, pfilterstart, jfilterstart,stfilterstart, pgfilterstart,thfilterstart];
        // console.log(FiterArry);
        var JsonFilter = JSON.stringify(FiterArry);
        setCookie("FilterItemActivaSign", JsonFilter, 5);
    
        TableListFunc(sfilterstart, pfilterstart, jfilterstart,stfilterstart, pgfilterstart,thfilterstart);

    
    //RESPON KETIKA INPUT PENCARIAN DI KETIK
    $("#fcariitemsign").on("keyup", function () {
        var FilterCariItem = $("#fcariitemsign").val();
        var FilterPICItem = $("#filterPICItemsign").val();
        var FilterJenisItem = $("#filterJenisItemsign").val();
        var FilterStatusItem = $("#filterStatusItemsign").val();
        var FilterProgressItem = $("#filterProgressItemsign").val();
        var FilterTahunItem = $("#fthn_aktsign").val();
        var FiterArry = [FilterCariItem,FilterPICItem, FilterJenisItem, FilterStatusItem, FilterProgressItem,FilterTahunItem];
        var JsonFilter = JSON.stringify(FiterArry);
        setCookie("FilterItemActivaSign", JsonFilter, 5);
        $("#tableListItem").DataTable().destroy();
        TableListFunc(FilterCariItem,FilterPICItem, FilterJenisItem, FilterStatusItem, FilterProgressItem,FilterTahunItem);
        $("#tableListItem").DataTable().page(0).draw();
        
    });

    //RESPON KETIKA FILTER TAHUN DI RUBAH
    $("#filterPICItemsign, #filterJenisItemsign, #filterStatusItemsign, #filterProgressItemsign, #fthn_aktsign").on(
        "change",
        function () {
        var FilterCariItem = $("#fcariitemsign").val();
        var FilterPICItem = $("#filterPICItemsign").val();
        var FilterJenisItem = $("#filterJenisItemsign").val();
        var FilterStatusItem = $("#filterStatusItemsign").val();
        var FilterProgressItem = $("#filterProgressItemsign").val();
        var FilterTahunItem = $("#fthn_aktsign").val();
        var FiterArry = [FilterCariItem,FilterPICItem, FilterJenisItem, FilterStatusItem, FilterProgressItem,FilterTahunItem];
        var JsonFilter = JSON.stringify(FiterArry);
        setCookie("FilterItemActivaSign", JsonFilter, 5);
        TableListFunc(FilterCariItem,FilterPICItem, FilterJenisItem, FilterStatusItem, FilterProgressItem,FilterTahunItem);
        // var table = $("#PSSList").DataTable();
        // var inff = table.page.info();
        // console.log(inff);
        $("#tableListItem").DataTable().page(0).draw();

        }
    );

    // //RESET FILTER
    $(".resetfilter").on("click", function () {
        var d = new Date();
        var yearnow = d.getFullYear();
        $("#fcariitemsign").val("");
        $("#filterPICItemsign").dropdown("set selected", Udecrypt);
        $("#filterJenisItemsign").dropdown("set selected", "ALL");
        $("#filterStatusItemsign").dropdown("set selected", "ALL");
        $("#filterProgressItemsign").dropdown("set selected", "ALL");
        $("#fthn_aktsign").dropdown("set selected", yearnow);
        var FiterArry = ["", Udecrypt, "ALL", "ALL", "ALL",yearnow];
        var JsonFilter = JSON.stringify(FiterArry);
        setCookie("FilterItemActivaSign", JsonFilter, 5);
        $("#tableListItem").DataTable().destroy();
        TableListFunc("", Udecrypt, "ALL", "ALL", "ALL",yearnow);
        $("#tableListItem").DataTable().page(0).draw();

    });

    $("#tableListItem").on("click", ".signItemAdd", function () {
        var eid = $(this).attr("eid");
        let encryption = new Encryption();
        var eidENC = encryption.encrypt(eid, NonceValue);
        window.location.href = "./?link=aktivaSignAdd&n=" + eidENC;
    });

    $('[data-toggle="datepicker"]').datepicker({
        format: 'yyyy-mm-dd',
        autoHide: true,
        weekStart: 1
    });

    $('.ui.search.nama')
        .search({
            apiSettings: {
                url: '3_aktiva/_autocompletenama.php?q={query}'
            },
            fields: {
                results: 'data',
                title: 'name',
                description: 'nik'
            },
            minCharacters: 1
        });

    $.ajax({
        type: "GET",
        url: "3_aktiva/_artemis.php",
        cache: false,
        success: function (response) {
            setCookie('atoken', response, 1 / 24);
        },
        error: function () {
            if (fungsilogout) {

                window.location.href = "./_logout.php";
            } else {
                console.log("error session")
            }
        }
    });

    $('.ui.dropdown').dropdown();

});