$(".ui.dropdown").dropdown();
$(".menu .item").tab();
//OPT
// moment().format();
const fungsilogout=true;

$(".ui.calendar")
  .calendar()
;


const NonceValue = "rdsystem2020";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");

var restlocbonkasdlnegeri = decodeURIComponent(getCookie("restlocbonkasdlnegeri"));
console.log(restlocbonkasdlnegeri);
var d = new Date();
var day = d.getDate() + "";
var month = d.getMonth() + 1 + "";
if (day.length < 2) {
    day = "0" + day;
}
if (month.length < 2) {
    month = "0" + month;
}
var mdnow = month + day;
var enc = new Encryption();
var erl = enc.encrypt("1" + mdnow, NonceValue);

//GET DATA TANGGAL HARI INI
var day = new Date();
tahunsekarang = day.getFullYear();

new AutoNumeric('#nominal',{
    currencySymbol: "Rp. ",
    decimalCharacter: ",",
    digitGroupSeparator: ".",
    decimalPlaces: "0",
}

);

new AutoNumeric('#biayaku',{
    currencySymbol: "Rp. ",
    decimalCharacter: ",",
    digitGroupSeparator: ".",
    decimalPlaces: "0",
}

);

new AutoNumeric('#totalall',{
    currencySymbol: "Rp. ",
    decimalCharacter: ",",
    digitGroupSeparator: ".",
    decimalPlaces: "0",
}

);

//-----------------KLIK TAB LAIN-------------------
$('#lrnegeriitem').on('click', function() {
    window.location.href = "./?link=rekeningtf";
});

$('#detailbtnback').on('click', function() {
    window.location.href = "./?link=rekeningtf";
});


loadlistdetail();
var idbaris;
var tgltransferval;
var tgltugasval;
var tgldueval;
var tglselesaival1;
var tglcreatedat;
var tglcreatedat1;
var lusername;
var idrval;
var biayakuval;
var rawValue;
var rawValue2;
var rawValue3;
var selesaitemp ="";
var terangtemp="";
var createddate;



//------------------LOAD DATA DETAIL DAN MENAMPILKAN DI TABEL --------------------
function loadlistdetail(){

    lusername    =  getCookie('usrnm');
    // $('#detaildlnegeri').find('tbody').empty();
    console.log("load list")
    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/table_transfer1",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: {idtransfer :idbon},
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                console.log("dataada");

                // mengubah format tanggal
                if(obj[0]["tanggal_transfer"]){
                    var dateAr = obj[0]["tanggal_transfer"].split('-');
                    var dateconvert = dateAr[2] + '-' + dateAr[1] + '-' + dateAr[0];
                    }
                    // tgltransferval=obj[0]["tanggal_transfer"];
                    tgltransferval=dateconvert;

                if(obj[0]["due_date"]){
                    var dateAr2 = obj[0]["due_date"].split('-');
                    var dateconvert2 = dateAr2[2] + '-' + dateAr2[1] + '-' + dateAr2[0];
                    }else{
                      var  dateconvert2="";
                    }
                    // tgldueval=obj[0]["due_date"];
                    tgldueval=dateconvert2;

                if(obj[0]["tanggalPenyelesaian"]){
                    var dateAr3 = obj[0]["tanggalPenyelesaian"].split('-');
                    var dateconvert3 = dateAr3[2] + '-' + dateAr3[1] + '-' + dateAr3[0];
                    }else{
                        dateconvert3="";
                    }

                    // tglselesaival1=obj[0]["tanggalPenyelesaian"];
                    tglselesaival1=dateconvert3;
                //mendapatkan value dari RP. .....
                idrval=obj[0]["nominal"];
                biayakuval=obj[0]["biaya_ku"];
                var totalval1=obj[0]["total_all"]


                if(idrval!="" || idrval!=null){
                rawValue = idrval.replace(/[^\d\-]+/g, '');
                }else{
                    rawValue=0;
                };

                
                if(biayakuval=="" || biayakuval==null){
                    rawValue2=0;

                }else{
                    console.log(biayakuval)
                    rawValue2 = biayakuval.replace(/[^\d\-]+/g, '');
                    
                };

                if(totalval1=="" || totalval1==null){
                    rawValue3=0;

                }else{
                    // console.log(biayakuval)
                    rawValue3 = totalval1.replace(/[^\d\-]+/g, '');
                    
                };


                jmlData = obj.length;
                console.log(jmlData);
                idbaris=obj[0][0];
                tglcreatedat=obj[0]["created_at"];
                var from1 = tglcreatedat.split(' ')[0];
                // console.log(obj[0]["nik"]);
                var from2 = from1.split('-');
                tglcreatedat1 = from2[0] + '-' + from2[1] + '-' + from2[2];
                createddate=new Date(obj[0]["created_at"]);
                $("#bontxt").text(obj[0]["no_bon"]);
                $("#namatxt").html(""+obj[0]["atas_nama"]+"");
                $("#niktxt").html(""+obj[0]["nik"]+"");
                $("#nobuktitxt").text(obj[0]["no_bukti"]);
                $("#suppliertxt").html(obj[0]["nama_supplier"]);
                $("#gunatxt").html(obj[0]["guna_membayar"]);
                $("#planttxt").html(obj[0]["plant"]);
                $("#tgltftxt").text(dateconvert);
                $("#usertxt").text(obj[0]["username"]);
                $("#viabanktxt").text(obj[0]["via_bank"]);
                $("#namabanktxt").html(obj[0]["nama_bank"]);
                $("#cabangtxt").html(obj[0]["cabang_kota"]);
                $("#norektxt").html(obj[0]["no_rekening"]);
                $("#atasnamatxt").html(obj[0]["atas_nama"]);
                $("#nominaltxt").text(obj[0]["nominal"]);
                $("#biayakutxt").text(obj[0]["biaya_ku"]); 
                $("#totaltxt").text(obj[0]["total_all"]);
                $("#namaterangtxt").text(obj[0]["nama_terang"]);
                $("#departementtxt").text(obj[0]["kepala_departement"]);
                // $("#tglberangkattxt").text(dateconvert4);
                $("#duedatetxt").text(dateconvert2);
                // $("#tglambiltxt").text(dateconvert);
                $("#tglselesaitxt").text(dateconvert3);
                $("#keterangantxt").text(obj[0]["keterangan"]);
                $("#statustxt").text(obj[0]["status"]);
                // $("#niktxt").html(""+obj[0][4]+"");
                if($("#statustxt").text()==="Confirm" || $("#statustxt").text()==="CONFIRM" ){
                    console.log("true");
                $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon" id="editslsbtn"></i>');
                $("#edit_due").html('<i class="edit outline editbtn iconcoloredit icon " id="editduebtn"></i>');
                $("#edit_namaterang").html('<i class="edit outline editbtn iconcoloredit icon" id="editnmbtn"></i>');
                $("#detailrekeningtf #confirmbtn").addClass("hidden");
                }else if($("#statustxt").text()==="Close" || $("#statustxt").text()==="CLOSE"){

                    $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon " id="editslsbtn"></i>');
                    $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon hidden" style="display:none" id="editslsbtn"></i>');  
                    $("#edit_due").html('<i class="edit outline editbtn iconcoloredit icon" style="display:none" id="editduebtn"></i>');
                    $("#edit_namaterang").html('<i class="edit outline editbtn iconcoloredit icon hidden" style="display:none" id="editnmbtn"></i>');     
                }else{
                    
                    $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon hidden" style="display:none" id="editslsbtn"></i>');  
                    $("#edit_namaterang").html('<i class="edit outline editbtn iconcoloredit icon hidden" style="display:none" id="editnmbtn"></i>');  
                    // $("editslsbtn").hide();
                }
                    

                
                $("#edit_keterangan").html('<i class="edit outline editbtn iconcoloredit icon" id="editketeranganbtn"></i>');
                statuswarna();
                
        }
    }
    


});
}


// //---------------- FUNGSI SEARCH NAMA

function datakedua(){
        
    // document.getElementById("nama_penerima").value ="";
    var query="";
    console.log("di kedua")
    console.log(query +"dua");

    $('.namaauto').search({
    minCharacters : 1,
    apiSettings   : {
        url: '3_invoice/_autocompletenama.php?q={query}'
    },
    fields: {
        results : 'data',
        title   : 'name',
        description : 'nik'
    },
    onSelect: function(result, response) {
        nikval =result.nik;
        namaval = result.name;
        // listpenyusun();
        
    }       
    });
    

}

//-------------------TOMBOL EDIT DATA DETAIL------------------------
$("#detailrekeningtf").on("click","#detailbtnedit",function(){

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/delete_pecahdatatf",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: {user: userName1},
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);

            if (obj.message == false){
                Swal.fire('Error',obj.error,'error')
            }  else {
                
                $.ajax({
                    type: "POST",
                    url: "../RND_BackEnd/backend_project_bonkas/create_pecahdatatf",
                    headers: {
                        user: vusrnm,
                        token: vtoken,
                    },
                    data: {idtransfer :idbon,
                    user: userName1},
                    cache:false,
            
                    success: function (response){
                        var obj = JSON.parse(response);
                        if (obj.message == false){
                            Swal.fire('Error',obj.error,'error')
                        }  else {
                            console.log("berhasil");
                            loadlistbank();
                        }
                    },
                    error: function(){
                        if(fungsilogout){
        
                            window.location.href="./_logout.php";
                        }else{
                            console.log("error session")
                        }
                    },
                    
                })
            }
        },
    
    })

    

    var costval=$("#costtxt").text();
    
    // console.log("done");

    $(".editmodal")
        .modal({blurring: false, closable: true})
        .modal("show");
        datepick();
        datakedua();
        console.log(rawValue3);
        $('#tanggaltf').calendar('set date', tgltransferval);
        // const an = AutoNumeric.getAutoNumericElement('#nominal');
        // console.log(an);
        $("#nik_pembuat").val($("#niktxt").html());
        $("#nik_pembuat").prop("disabled",true);
        $("#nobukti").val($("#nobuktitxt").text());
        $("#supplier").val($("#suppliertxt").text());
        $("#guna_membayar").val($("#gunatxt").text());
        $("#via_bank").val($("#viabanktxt").text());
        $("#nama_penerima1").val($("#namaterangtxt").text());
        $("#nama_penerima2").val($("#departementtxt").text());
        var plantval=$("#planttxt").text();
        $("#plant").dropdown("set selected", plantval );
        $("#tgl_tf").val(tgltransferval);
        AutoNumeric.getAutoNumericElement(document.getElementById('nominal')).set(rawValue);
        AutoNumeric.getAutoNumericElement(document.getElementById('biayaku')).set(rawValue2);
        AutoNumeric.getAutoNumericElement(document.getElementById('totalall')).set(rawValue3);
        // $("#biayaku").val($("#biayakutxt").text());
        


    
})

//--------------------TAMPIL DATA TEMP BANK-------------------------
function loadlistbank(){

    var lusername    =  getCookie('usrnm');
    $('#tb_bank').find('tbody').empty();
    
    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/table_bank",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { user :userName1},
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
                
            }else {
                console.log("dataada");
                jmlData = obj.length;
                console.log(jmlData);
                
                for(b = 0; b < jmlData; b++){
                $('#tb_bank').find('tbody').append(
                "<tr id='"+b+"'><td>"+obj[b]["atas_nama"]+
                "</td><td class='center'>"+obj[b]["nama_bank"]+
                "</td><td class='center'>"+obj[b]["cabang_bank"]+
                "</td><td class='center'>"+obj[b]["nomor_rekening"]+
                "</td><td class='center'><i class='trash deletebank iconcoloredit icon' atasnama='"+obj[b]["atas_nama"]+"' delid='"+obj[b]["id_bank"]+"' namabank='"+obj[b]["nama_bank"]+"'cabangbank='"+obj[b]["cabang_bank"]+"'nomorbank='"+obj[b]["nomor_rekening"]+"'></i></td></tr>");
                

                $('.deletebank').on('click',function(e){
                    var atasnama= $(this).attr('atasnama');
                    var idbank= $(this).attr('delid');
                    var namabank= $(this).attr('namabank');
                    var cabangbank= $(this).attr('cabang_bank');
                    var norek = $(this).attr('nomorbank');
                
                Swal.fire({
                    title: '<h2>Hapus data ini?</h2>',
                    text: "atas nama: "+atasnama+", nama bank: "+namabank+", cabang: "+cabangbank+", norek: "+norek,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya'
                    }).then((result) => {
                    if (result.value) {
                        //REST CALON DNPENYUSUN
                        $.ajax({
                        type: "POST",
                        url: "../RND_BackEnd/backend_project_bonkas/delete_bank",
                        headers: {
                            user: vusrnm,
                            token: vtoken,
                        },
                        data: {
                            idbank : idbank,
                            
                        },
                        cache: false,
                        success: function (response){
                            var obj = JSON.parse(response);
                            if (obj.code == 'error9'){
                            Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
                            } else if (obj.code == 'error10'){
                            Swal.fire('Error','Item yang dimaksud tidak ada !','error')
                            }  else {
                            loadlistbank();
                            }
                        },
                        error: function(){
                            if(fungsilogout){
            
                                window.location.href="./_logout.php";
                            }else{
                                console.log("error session")
                            }
                        },
                        });
                    }
                    })
                
                
                });
            }

        }
    }
    


});


}


//------------------- SIMPAN SAVE DATA EDIT --------------------

$('#saverekeningtf').on('click', function() {

    editdatalr();

})


function editdatalr(){
    var eusername="";

    var idrval=$('#nominal').val();
    var biayakuval=$('#biayaku').val();


    if(idrval!="" || idrval!=null){
    var rawValue = idrval.replace(/[^\d\-]+/g, '');
    }else{
       var rawValue=0;
    };

    
    if(biayakuval=="" || biayakuval==null){
       var rawValue2=0;

    }else{
        console.log(biayakuval)
        var rawValue2 = biayakuval.replace(/[^\d\-]+/g, '');
        
    };

    var totalval = Number(rawValue2) + Number(rawValue);
    AutoNumeric.getAutoNumericElement(document.getElementById('totalall')).set(totalval);
    console.log($('#totalall').val());

    var tanggaltf=$('#tgl_tf').val();
    if(tanggaltf!=""){
    var datearr= tanggaltf.split('-');
    var dateconvert= datearr[2] + '-' + datearr[1] + '-' + datearr[0];
    }else{
     var dateconvert="";
    }
    
    $(document).ready(function () {

            $.ajax({


                type: "POST",
                url: `${restlocbonkasdlnegeri}create_transfer`,
                headers: {
                    user: vusrnm,
                    token: vtoken,
                },
                data:{
                nik : $("#niktxt").html(),
                nobukti : $('#nobukti').val(),
                namasupplier : $('#supplier').val(),
                gunamembayar:$("#guna_membayar").val(),
                tgltrf:dateconvert,
                viabank:$('#via_bank').val(),
                nominal:$('#nominal').val(),
                biayaku:$('#biayaku').val(),
                totalall:$('#totalall').val(),
                plant:$('#plant').val(),
                namaterang:$('#nama_penerima1').val(),
                namadept:$('#nama_penerima2').val(),
                idtransfer : idbaris,
                user: userName1,
                cekrole : cekrole,
                
                
                },


                success: function(response){
                    
                    var obj = JSON.parse(response);
                    console.log(obj);
                    if(obj.status==false){
                        if(obj.code=="error14"){

                            Swal.fire({
                                icon:"error",
                                title:obj.message,
                                
                                confirmButtonText: 'Ya'
                            }).then((result) => {
                                if (result.value) {
                                    $(".editmodal")
                                    .modal({blurring: false})
                                    .modal("hide");

                                    loadlistdetail();

                                }
                            });
                        }else{
                    Swal.fire(
                        "Error",
                        obj.message,
                        "error"
                    );
                }
                }else{
                    Swal.fire(
                        'berhasil',
                        obj.message,
                        'success'
                    )
                    //loadlistpenerima();

                $('#nobukti').val('');
                $("#supplier").val('');
                $("#guna_membayar").val('');
                $("#tgl_tf").val('');
                $("#lama_tugas").val('');
                $('#via_bank').val('');
                $('#namabank').val('');
                $('#cabangbank').val('');
                $('#atas_nama').val('');
                $('#norek').val('');
                $('#biayaku').val('');
                
                AutoNumeric.getAutoNumericElement(document.getElementById('nominal')).set(0);
                loadlistdetail()
            $(".editmodal")
                .modal({blurring: false})
                .modal("hide");

                
                }
                },
                error: function(){
                    if(fungsilogout){
    
                        window.location.href="./_logout.php";
                    }else{
                        console.log("error session")
                    }
                },

            });

            

            

    
});    

}



//-------------- TOMBOL SAVE DATA BANK ------------------
$('#savebank').on('click', function() {

    var namabankval = $("#namabank").val();
    var cabangval = $("#cabangbank").val();
    var atasnamaval = $("#atas_nama").val();
    var norekval = $("#norek").val();
    
    listbank(namabankval, cabangval, atasnamaval, norekval);

})

//-----------------------------SAVE BANK KE TEMP---------------------------

function listbank(namabank,cabang,atasnama,norek){
        
    $(document).ready(function () {
    var lnamabank = namabank;
    var lcabang = cabang;
    var latasnama = atasnama;
    var lnorek =norek;
    console.log(cabang)
    var lusernames = getCookie('usrnm');
    console.log(lusernames);

        $.ajax({
            type: "POST",
            url: "../RND_BackEnd/backend_project_bonkas/create_bank",

            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                namabank : lnamabank,
                cabangbank : lcabang,
                atasnama : latasnama,
                norek : lnorek,
                user : userName1
            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            console.log('Gagal save, data kosong');
            
            } else if(obj) {
            if (obj.status == false){
                Swal.fire('Error',obj.message,'error')
            }  else if (obj.code == 'error11'){
                Swal.fire('Error','data kosong','error')
            }  else {
                Swal.fire({
                text: 'Item berhasil ditambahkan',
                timer: 2000,
                position: 'top-right',
                toast: true,
                showConfirmButton: false
                })
                loadlistbank();
                $('#nominal_asing').val('');
                
            }
            
            } else {
            Swal.fire('Error','','error')
            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        },
        });
        
    });
    
}



//---------------TOMBOL LAYANAN PDF-----------------
$("#detailpdfbtn").on("click", function (e) {
    $.redirect(
    "./?link=rekeningtfpdf",
    { iditem: idbaris},
    "POST",
    "_blank"
);
});

//--------------------------------KONDISI STATUS------------------
function statuswarna(){

    if($("#statustxt").text()=="Close" || $("#statustxt").text()=="CLOSE"){
        $("#edit_status").html('<button class="ui red label" id="unsignbtn" >Unsign</button>')
        console.log($("#statustxt").text())
        $("#statustxt").css("color","red");
        $("#detailbtnedit").addClass("disabled");

    }else if($("#statustxt").text()=="Confirm" || $("#statustxt").text()=="CONFIRM"){
        if(cekrole=='user'){
            $("#detailbtnedit").addClass("disabled");      

        }

        $("#statustxt").css("color","green");
    }else{
        $("#detailbtnedit").removeClass("disabled");
        $("#edit_status").html('<button class="ui green label" id="confirmbtn" >Confirm</button>')
    }
}

//---------------------- FUNGSI CEK STATUS -----------------------
function cekstatus(){

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/update_cektrf",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idtransfer : idbaris,
            
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal konek');
                
            }else {
                statuswarna();
                loadlistdetail();
                
        }
    }
    
});

}

//-----------------KLIK EDIT KETERANGAN----------------
$("#detailrekeningtf").on("click","#editketeranganbtn", function(){

    console.log("tombol keterabgan");

    var setketerangan=  $("#keterangantxt").text();
    console.log(setketerangan);
    //store data baris
    $(".keteranganmodal")
    .modal({blurring: false, closable: false})
    .modal("show");
    if(setketerangan!=""){
                    $("#tbketerangan #judulket").text("EDIT");
                    $("#keterangantxt1").val(setketerangan);
    }

})

//------------------------------KLIK BACK KETERANGAN
$("#tbketerangan").on("click","#selesaibtnback", function(){

    $(".keteranganmodal")
                    .modal("hide");
})

//------------------KLIK SET EDIT KETERANGAN---------------
$("#tbketerangan").on("click","#selesaibtnset", function(){

    console.log("tombol set");

    var setketerangansave=  $("#keterangantxt1").val();

    //console.log(settanggalselesai);

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/update_keterangantransfer",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idtransfer : idbaris,
            keterangan: $("#keterangantxt1").val(),
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                // Swal.fire({
                //     text: 'keterangan tersimpan',
                //     target: '#detaillrnegeri',
                //     customClass: {
                //     container: 'position-absolute'
                //     },
                //     toast: true,
                //     position: 'center'
                // })

                Swal.fire({
                    text: 'keterangan tersimpan',
                    timer: 2500,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                })
                
                loadlistdetail();
                
                $(".keteranganmodal")
                    .modal({blurring: false})
                    .modal("hide");
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    },
    
});
    // $("#keterangantxt").text(setketerangansave);
    
})

//--------------------- STATUS DAN DUE DATE --------------------------

$("#detailrekeningtf").on("click","#confirmbtn", function(){

    $(".duemodal")
        .modal({blurring: false, closable: false})
        .modal("show");
        datepick();
        console.log(tgldueval);

    // $("#tgl_due").val(tgldueval);
    $('#tanggaldue').calendar('set date', tgldueval);

})

$("#tbduedate").on("click","#duebtnback", function(){

    $("#tgl_due").val("");
    $(".duemodal")
        .modal({blurring: false})
        .modal("hide");


})

//------------ SAVE TANGGAL DUE DATE & UPDATE STATUS ----------------

$("#tbduedate").on("click","#duebtnset", function(){
    tanggaldue=$('#tgl_due').val();
    var datearr= tanggaldue.split('-');
        var dateconvert= datearr[2] + '-' + datearr[1] + '-' + datearr[0];
    
    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/update_statustrf",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idtransfer : idbaris,
            duedate: dateconvert,
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                // Swal.fire({
                //     text: 'data confirm',
                //     target: '#detailrekeningtf',
                //     customClass: {
                //     container: 'position-absolute'
                //     },
                //     toast: true,
                //     position: 'center'
                // })

                Swal.fire({
                    text: 'data CONFIRM',
                    timer: 3000,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                });
                
                loadlistdetail();
                statuswarna();
                $(".duemodal")
        .modal({blurring: false})
        .modal("hide");
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    },
    
});


})



//------------------- KLIK EDIT TANGGAL PENYELESAIAN ----------------------
$("#detailrekeningtf").on("click","#editslsbtn", function(){

    console.log("tombol tanggal");

    var tglselesaival = document.getElementById("tglselesaitxt").innerText;
    console.log(document.getElementById("tglselesaitxt").innerText);
    //store data baris
    $(".detailmodal")
                    .modal({blurring: false, closable: false})
                    .modal("show");
                    datepick();

    if(tglselesaival!=""){
        $("#tbtglselesai #judultgl").text("EDIT");
        // $("#tgl_selesai").val(tglselesaival1);
        $('#tanggalselesai').calendar('set date', tglselesaival1);
    }
    else{
        $("#tgl_selesai").val(selesaitemp);
        $('#tanggalselesai').calendar('set date', selesaitemp);
    }
})


//KLIK SET TANGGAL
$("#tbtglselesai").on("click","#selesaibtnset", function(){

    console.log("tombol set");
    selesaitemp=$("#tgl_selesai").val();
    var tanggalselesai=$('#tgl_selesai').val();
    var datearr= tanggalselesai.split('-');
    var dateconvert= datearr[2] + '-' + datearr[1] + '-' + datearr[0];

    var settanggalselesai=  $("#tgl_selesai").val();

    console.log(settanggalselesai);

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/update_tglpenyelesaiantransfer",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idtransfer :idbaris,
            tglpenyelesaian : dateconvert,
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                console.log("dataada");
                jmlData = obj.length;
                console.log(jmlData);
                // Swal.fire({
                //     text: 'tanggal selesai tersimpan - Status: close',
                //     target: '#detailrekeningtf',
                //     customClass: {
                //     container: 'position-absolute'
                //     },
                //     toast: true,
                //     position: 'center'
                // })

                Swal.fire({
                    text: 'tanggal penyelesaian tersimpan, status: CLOSE',
                    timer: 3000,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                })
                cekstatus();
                
                
                $(".detailmodal")
                    .modal({blurring: false, closable: false})
                    .modal("hide");
                loadlistdetail();
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    },
    


});

})

//----------------------KLIK BACK TANGGAL
$("#tbtglselesai").on("click","#selesaibtnback", function(){

    console.log("tombol tanggal");
    //store data baris
    $(".detailmodal")
                    .modal("hide");
})



// --------------------- FUNGSI UNSIGN ------------------------------

$("#detailrekeningtf").on("click","#unsignbtn", function(){

    Swal.fire({
        title: '<h2>Unsign data ini?</h2>',
        text: "akan mengubah Status, Tanggal Penyelesaian",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya'
        }).then((result) => {
        if (result.value) {
            //REST CALON DNPENYUSUN
            $.ajax({
            type: "POST",
            url: "../RND_BackEnd/backend_project_bonkas/update_unsigntrf",
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data: {
                idtransfer :idbaris,
                
            },
            cache: false,
            success: function (response){
                var obj = JSON.parse(response);
                if (obj.message == false){
                    Swal.fire('Error',obj.error,'error')
                }  else {
                    
                    // Swal.fire({
                    //     text: 'data unsigned',
                    //     target: '#detailrekeningtf',
                    //     customClass: {
                    //     container: 'position-absolute'
                    //     },
                    //     toast: true,
                    //     position: 'center'
                    // })

                    Swal.fire({
                        text: 'Data UNSIGNED',
                        timer: 2500,
                        position: 'top-right',
                        toast: true,
                        showConfirmButton: false
                    })
                    
                    loadlistdetail  ();
                }
            },
            error: function(){
                if(fungsilogout){

                    window.location.href="./_logout.php";
                }else{
                    console.log("error session")
                }
            },
            });
        }
        })

})

$("#tbduedate").on("click","#duebtnback", function(){

    $("#tgl_due").val("");
    $(".duemodal")
        .modal({blurring: false})
        .modal("hide");


})

//---------------- TOMBOL DELETE DATA DETAIL --------------------

$("#detailbtndelete").on("click", function () {
        
    Swal.fire({
        title: '<h2>Hapus data ini?</h2>',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya'
        }).then((result) => {
        if (result.value) {
            //REST CALON DNPENYUSUN
            $.ajax({
            type: "POST",
            url: "../RND_BackEnd/backend_project_bonkas/delete_transfer",
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data: {
                idtransfer :idbaris,
                
            },
            cache: false,
            success: function (response){
                var obj = JSON.parse(response);
                if (obj.message == false){
                    Swal.fire('Error',obj.error,'error')
                }  else {
                    window.location.href = "./?link=rekeningtf";
                }
            },
            error: function(){
                if(fungsilogout){

                    window.location.href="./_logout.php";
                }else{
                    console.log("error session")
                }
            },
            });
        }
        })
});


//-----------------KLIK EDIT NAMA TERANG----------------
$("#detailrekeningtf").on("click","#editnmbtn", function(){

    console.log("tombol nama terang");

    var setnamaterang=  $("#namaterangtxt").text();
    
    // console.log(setketerangan);
    //store data baris
    $(".namaterangmodal")
    .modal({blurring: false, closable: false})
    .modal("show");
    
    if(setnamaterang!=""){
                    $("#tbnamaterang #judulterang").text("EDIT");
                    $("#namaterangtxt1").val(setnamaterang);
    }else
    {
        $("#namaterangtxt1").val(terangtemp);

    }
    

})

//------------------------------KLIK BACK NAMA TERANG
$("#tbnamaterang").on("click","#terangbtnback", function(){

    $(".namaterangmodal")
                    .modal("hide");
})

//------------------KLIK SET EDIT NAMA TERANG---------------
$("#tbnamaterang").on("click","#terangbtnset", function(){

    console.log("tombol set");
    terangtemp= $("#namaterangtxt1").val();
    var setketerangansave=  $("#namaterangtxt1").val();

    //console.log(settanggalselesai);

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/create_namaterangtrf",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idtransfer : idbaris,
            namaterang: $("#namaterangtxt1").val(),
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                // Swal.fire({
                //     text: 'keterangan tersimpan',
                //     target: '#detailrekeningtf',
                //     customClass: {
                //     container: 'position-absolute'
                //     },
                //     toast: true,
                //     position: 'center'
                // })

                Swal.fire({
                    text: 'Nama Terang Tersimpan',
                    timer: 2500,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                })
                cekstatus();
                
                
                $(".namaterangmodal")
                    .modal({blurring: false})
                    .modal("hide");

                    loadlistdetail();
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    },
    
});
    // $("#keterangantxt").text(setketerangansave);
    
})


//---------------- TOMBOL DELETE DATA DETAIL --------------------

$("#detailbtndelete").on("click", function () {
        
    Swal.fire({
        title: '<h2>Hapus data ini?</h2>',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya'
        }).then((result) => {
        if (result.value) {
            //REST CALON DNPENYUSUN
            $.ajax({
            type: "POST",
            url: "../RND_BackEnd/backend_project_bonkas/delete_transfer",
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data: {
                idtransfer :idbaris,
                
            },
            cache: false,
            success: function (response){
                var obj = JSON.parse(response);
                if (obj.message == false){
                    Swal.fire('Error',obj.error,'error')
                }  else {
                    window.location.href = "./?link=rekeningtf";
                }
            },
            error: function(){
                if(fungsilogout){

                    window.location.href="./_logout.php";
                }else{
                    console.log("error session")
                }
            },
            
            });
        }
        })
});


//----------------- DELETE TEMP KETIKA USER MENEKAN BACK BROWSER ----------------------
function tempdelete(){

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/delete_pecahdatatf",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: {user: userName1},
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);

            if (obj.message == false){
                Swal.fire('Error',obj.error,'error')
            }  else {
                
            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        },
    
    })
}


jQuery(document).ready(function($) {
    const url = new URL(window.location);
    if (window.history && window.history.pushState) {
        console.log(window.history);
      window.history.pushState({}, null, url);
  
      $(window).on('popstate', function() {
        tempdelete();
        history.back();
      });
  
    }
  });

  // -------------------- BACK BUTTON EDIT DATA----------------
$('#tfbuttonback').on('click', function() {
    tempdelete();
   
    $(".editmodal")
    .modal({blurring: false})
    .modal("hide");
});

function datepick(){
        $('#tanggaltf').calendar({
            type: 'date',
            monthFirst: false,
            minDate : createddate,
            // initialDate:new Date(tgltugasval),
        formatter: {
        date: function (date, settings) {
            if (!date) return "";
            var day = date.getDate() + "";
            if (day.length < 2) {
            day = "0" + day;
            }
            var month = date.getMonth() + 1 + "";
            if (month.length < 2) {
            month = "0" + month;
            }
            var year = date.getFullYear();
            return day + "-" + month + "-" + year;
            // return year + "-" + month + "-" + day;
        }
    }
        });

        $('#tanggaldue').calendar({
            type: 'date',
            monthFirst: false,
            minDate : createddate,
            // initialDate:new Date(tgltugasval),
        formatter: {
        date: function (date, settings) {
            if (!date) return "";
            var day = date.getDate() + "";
            if (day.length < 2) {
            day = "0" + day;
            }
            var month = date.getMonth() + 1 + "";
            if (month.length < 2) {
            month = "0" + month;
            }
            var year = date.getFullYear();
            return day + "-" + month + "-" + year;
            // return year + "-" + month + "-" + day;
        }
    }
        });

        $('#tanggalselesai').calendar({
            type: 'date',
            monthFirst: false,
            // minDate : d,
            minDate : createddate,
        formatter: {
        date: function (date, settings) {
            if (!date) return "";
            var day = date.getDate() + "";
            if (day.length < 2) {
            day = "0" + day;
            }
            var month = date.getMonth() + 1 + "";
            if (month.length < 2) {
            month = "0" + month;
            }
            var year = date.getFullYear();
            return day + "-" + month + "-" + year;
            // return year + "-" + month + "-" + day;
        }
    }
        });
    
    }

    
        

        $('.ui.search.namaterang').search({
        minCharacters : 1,
        apiSettings   : {
            url: '3_invoice/_autocompletenama.php?q={query}'
        },
        fields: {
            results : 'data',
            title   : 'name',
            description : 'nik'
        },
        onSelect: function(result, response) {
            nikval =result.nik;
            namaval = result.name;
            
            
        }       
        });

        $('.iconclose').on('click', function() {

            // tesemail();
            tempdelete();
   
    $(".editmodal")
    .modal({blurring: false})
    .modal("hide");
        
        })
        
    
//KLIK EDIT TANGGAL DUE
$("#detailrekeningtf").on("click","#editduebtn", function(){

    

    // console.log("tombol tanggal due");

    // // var tgldueval = document.getElementById("tglduetxt").innerText;
    // console.log(document.getElementById("tglduetxt").innerText);
    // //store data baris
    // $(".duemodal")
    //     .modal({blurring: false, closable: false})
    //     .modal("show");

    //     datepick();
    //     console.log(tgldueval);

    // if(tgldueval!=""){
    //     $("#tbduedate #juduldue").text("EDIT");
    //      $('#tanggaldue').calendar('set date', tgldueval);
    // }
    // else{   
    //     $("#tgl_selesai").val(tanggaldue);
    // }

    $(".duemodal")
        .modal({blurring: false, closable: false})
        .modal("show");
        datepick();
        console.log(tgldueval);

    // $("#tgl_due").val(tgldueval);
    $('#tanggaldue').calendar('set date', tgldueval);
})

//----------- FUNGSI COPY KE CLIPBOARD

function copytxt(element) {
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val($(element).text()).select();
    document.execCommand("copy");
    $temp.remove();
  }







