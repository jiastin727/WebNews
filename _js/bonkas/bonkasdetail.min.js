 
$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocbonkas = decodeURIComponent(getCookie("restlocbonkas"));
var d = new Date();
var day = d.getDate() + "";
var month = d.getMonth() + 1 + "";
if (day.length < 2) { day = "0" + day; }
if (month.length < 2) { month = "0" + month; }
var mdnow = month+day;
var enc = new Encryption();
var erl = enc.encrypt("1"+mdnow, NonceValue);


function countPlaces(num) {
  var text = num.toString();
  var index = text.indexOf(".");
  return index == -1 ? 0 : (text.length - index - 1);
} 


  function BonKasViewList(FSearch,FYear){
    var d1 = enc.decrypt(EncR2, NonceValue);
    var d2 = enc.decrypt(erl, NonceValue);
    $('#BonKasList').DataTable({
      dom : "<'ui stackable grid'"+
            "<'row'"+
            "<'left aligned ten wide column'>"+
            ">"+
            "<'row dt-table'"+
            "<'sixteen wide column'tr>"+
            ">"+
            "<'row'"+
            "<'left aligned eight wide column'B>"+
            "<'right aligned eight wide column'p>"+
            ">"+
            ">",
      buttons: [
        {
            text: '10',
            action: function ( e, dt, node, config ) {
              $('#BonKasList').DataTable().page.len( 10 ).draw();
            }
        },
        {
            text: '25',
            action: function ( e, dt, node, config ) {
              $('#BonKasList').DataTable().page.len( 25 ).draw();
            }
        },
        {
            text: '50',
            action: function ( e, dt, node, config ) {
              $('#BonKasList').DataTable().page.len( 50 ).draw();

            }
        },
        {
            text: '100',
            action: function ( e, dt, node, config ) {
              $('#BonKasList').DataTable().page.len( 100 ).draw();

            }
        },
        {
            text: '500',
            action: function ( e, dt, node, config ) {
              $('#BonKasList').DataTable().page.len( 500 ).draw();
            }
        },
        {
            text: '1000',
            action: function ( e, dt, node, config ) {
              $('#BonKasList').DataTable().page.len( 1000 ).draw();
            }
        }
      ],
      destroy: true,
      stateSave: true,
      processing: true,
      deferRender: true,
      serverSide: true,
      orderClasses: false,
      pageLength: 10,
      data: [],
      language: {
        sLengthMenu: "_MENU_",
        search: "",
        searchPlaceholder: "Search..",
        processing: '<i class="circle notch loading icon huge"></i>',
      },
      order: [[0, "desc"]],
      columns: [
        { data    : 0 },
        { data    : 1 },
        { data    : null, 
          render: function(data, type, row) {
            if(data[2]){
              var cdp = countPlaces(data[2]);
              if (cdp == 2){
                return $.number( data[2], 2, ',', '.' );
              }
              if (cdp == 1){
                return $.number( data[2], 1, ',', '.' );
              }
              if (cdp == 0){
                return $.number( data[2], 0, ',', '.' );
              }
            } else {
              return '';
            }
          }
        }, 
        { data    : 3 }, 
        { data    : 4 }, 
        { data    : 6 }, 
        { data    : 9 }, 
        { data    : 10 }, 
        { data    : 11 },
        { data    : 12 },
        { data    : 13 },
        { data    : 14 },
        { data    : null, 
          render    : function(data, type, row) { 
            if ((data[0]!="") && (d1 === d2)){
              return '<i class="edit outline actedit iconcoloredit icon" eid="'+data[15]+'"></i>';
            } else {
              return ''; 
            }
          }
        },
        { data    : null, 
          render    : function(data, type, row) { 
            if ((data[0]!="") && (d1 === d2)){
              return '<i class="print actprint iconcoloredit icon" eid="'+data[0]+'"></i>';
            } else {
              return ''; 
            }
          }
        } 
      ],
      columnDefs: [{ className: "center aligned", targets: [7,12,13] }],
      ajax        : {
        url     : `${restlocbonkas}table_bonkas_detail`,
        type    : 'POST',
        headers : {
          user  : vusrnm,
          token : vtoken
        },
        data    : {
          FSearch : FSearch,
          FYear   : FYear,
        }
      },

    });

    //HANDLER UNTUK KLIK ICON EDIT
    $("#BonKasList").on("click", ".actedit", function(){
      var eid = $(this).attr('eid');
      //var nonceValue = '<?php echo $nonceValue; ?>';
      let encryption = new Encryption();
      var eidENC = encryption.encrypt(eid, NonceValue);
      window.location.href = "./?link=editbon&i="+eidENC;
    });

    //HANDLER UNTUK KLIK ICON PRINT
    $("#BonKasList").on("click", ".actprint", function(){
      Swal.fire({
        title: 'Pilih yang akan dicetak',
        showDenyButton: true,
        showCancelButton: true,
        showCloseButton: true,
        confirmButtonText: `Bon Kas`,
        denyButtonText: `Bukti Pengeluaran`,
        cancelButtonText: 'Semua'
      }).then((result) => {
        // var nonceValue = '<?php echo $nonceValue; ?>';
        let encryption = new Encryption();
        var eid = $(this).attr('eid');
        var eidENC = encryption.encrypt(eid, NonceValue);
        if (result.isConfirmed) {
          //window.location.href = "./?link=bkdwnldpdf&t=bk&i="+eidENC;
          $.redirect(
            "./?link=bkdwnldpdf",
            { t: "bk", i: eidENC },
            "POST",
            "_blank"
          );
        } else if (result.isDenied) {
          //window.location.href = "./?link=bkdwnldpdf&t=bp&i="+eidENC;
          $.redirect(
            "./?link=bkdwnldpdf",
            { t: "bp", i: eidENC },
            "POST",
            "_blank"
          );
        } else if (result.dismiss == Swal.DismissReason.cancel) {
          //window.location.href = "./?link=bkdwnldpdf&t=all&i="+eidENC;
          $.redirect(
            "./?link=bkdwnldpdf",
            { t: "all", i: eidENC },
            "POST",
            "_blank"
          );
        } else {

        } 
      })
    });

  }
  //Read Filter Cookies
  var d = new Date();
  var yearnow  = d.getFullYear();
  var sfilter2 = getCookie("sfilbonkas2");
  var tfilter2 = getCookie("tfilbonkas2");
  if (sfilter2) {
    $("#searchfilterbonkas").val(sfilter2);
    var sfilterstart2 = sfilter2;
  } else {
    setCookie("sfilbonkas2", "", 5);
    var sfilterstart2 = "";
  }
  if (tfilter2) {
    $("#filtertahunbonkas").dropdown("set selected", tfilter2);
    var tfilterstart2 = tfilter2;
  } else {
    setCookie("tfilbonkas2", yearnow, 5);
    var tfilterstart2 = yearnow;
  }

  //Load Table
  BonKasViewList(sfilterstart2,tfilterstart2);

  //RESPON KETIKA FILTER MODE DI RUBAH
  $('#filtermode').on('change', function() {
    var MOD_filter    = $('#filtermode').val();
    
    setCookie('mfilbonkas2',MOD_filter,5);
    
    if(MOD_filter === 'surat-tugas') {
      location.href = '/RND/?link=bonkas';
    }
    if(MOD_filter === 'bon-kas') {
      location.href = '/RND/?link=bonkasdetail';
    }
  });

  //RESPON KETIKA INPUT PENCARIAN DI KETIK
  $('#searchfilterbonkas').on('keyup', function() {
    var MOD_filter    = $('#filtermode').val();
    var FilterCari   	= $('#searchfilterbonkas').val();
    var FilterTahun   = $('#filtertahunbonkas').val();
    setCookie('mfilbonkas2',MOD_filter,5);
    setCookie('tfilbonkas2',FilterTahun,5);
    setCookie('sfilbonkas2',FilterCari,5);
    $('#BonKasList').DataTable().destroy();
    BonKasViewList(FilterCari,FilterTahun);
  });

  //RESPON KETIKA FILTER TAHUN DI RUBAH
  $('#filtertahunbonkas').on('change', function() {
    var MOD_filter    = $('#filtermode').val();
    var FilterTahun   = $('#filtertahunbonkas').val();
    var FilterCari   	= $('#searchfilterbonkas').val();
    setCookie('mfilbonkas2',MOD_filter,5);
    setCookie('tfilbonkas2',FilterTahun,5);
    setCookie('sfilbonkas2',FilterCari,5);
    $('#BonKasList').DataTable().destroy();
    BonKasViewList(FilterCari,FilterTahun);
  });

  //RESET FILTER
  $('.resetfilter').on('click', function() {
    var d = new Date();
    var yearnow = d.getFullYear();
    $('#searchfilterbonkas').val('');
    $('#filtertahunbonkas').dropdown('set selected',yearnow);
    setCookie('tfilbonkas2',yearnow,5);
    setCookie('sfilbonkas2','',5);
    $('#BonKasList').DataTable().destroy();
    BonKasViewList("", yearnow);
  });

    $('#tabbonlist').on('click', function() {
      window.location.href = "./?link=bonkas";
    });
    $('#createbonkas').on('click', function() {
      window.location.href = "./?link=createbon";
    });
    $('#tabcreatebon').on('click', function() {
      window.location.href = "./?link=createbon";
    });
    $('.tabuserguide').on('click', function() {
      window.location.href = "./?link=guidebonkas";
    });
    $('.tabsuratgolive').on('click', function() {
      window.location.href = "./?link=golivebonkas";
    });
    $('.tabhasilmonitoring').on('click', function() {
      window.location.href = "./?link=monitorbonkas";
    });
    $('.tabversion').on('click', function() {
      window.location.href = "./?link=versionhistory&app=BON";
    });

    //DOWNLOAD DATA ALL / SESUAI FILTER DAN SEARCHING
    $('#dwnldxls').on('click', function() {
      var FilterTahun   = $('#filtertahunbonkas').val();
      var FilterCari   	= $('#searchfilterbonkas').val();
      window.location.href = "./?link=bkdwnldxls&c=2&t="+FilterTahun+"&s="+FilterCari;
    });
