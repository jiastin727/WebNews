$(".ui.dropdown").dropdown();
$(".menu .item").tab();
const fungsilogout=true;
//OPT
// moment().format();

$(".ui.calendar")
  .calendar()
;


const NonceValue = "rdsystem2020";

var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");

var restlocbonkasdlnegeri = decodeURIComponent(getCookie("restlocbonkasdlnegeri"));

var d = new Date();
var day = d.getDate() + "";
var month = d.getMonth() + 1 + "";
if (day.length < 2) {
    day = "0" + day;
}
if (month.length < 2) {
    month = "0" + month;
}
var mdnow = month + day;
var enc = new Encryption();
var erl = enc.encrypt("1" + mdnow, NonceValue);

//GET DATA TANGGAL HARI INI
var day = new Date();
tahunsekarang = day.getFullYear();

new AutoNumeric('#nominal',{
    currencySymbol: "Rp. ",
    decimalCharacter: ",",
    digitGroupSeparator: ".",
    decimalPlaces: "0",
}
);
//KLIK TAB LAIN
$('#dlnegeriitem').on('click', function() {
    window.location.href = "./?link=dalamnegeri";
});

$('#detailbtnback').on('click', function() {
    window.location.href = "./?link=dalamnegeri";
});
console.log(d+"ini date")
loadlistpenerima();
var idbaris;
var tgluangval;
var tgltugasval;
var tgldueval;
var tglselesaival1;
var tglcreatedat;
var tglcreatedat1;
var selesaitemp ="";
var createddate;
var maxdateset;
function loadlistpenerima(){

    var lusername    =  getCookie('usrnm');
    // $('#detaildlnegeri').find('tbody').empty();
    console.log("load list")
    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/table_perjalanandlnegeri1",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { idperjalanandlnegeri :idbon},
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                console.log("dataada");

                if(obj[0]["ambil_uang"]){
                var dateAr = obj[0]["ambil_uang"].split('-');
                var dateconvert = dateAr[2] + '-' + dateAr[1] + '-' + dateAr[0];
                }
                // tgluangval=obj[0]["ambil_uang"];
                tgluangval=dateconvert;
                if(obj[0]["tanggal_tugas"]){
                    var dateAr1 = obj[0]["tanggal_tugas"].split('-');
                    var dateconvert1 = dateAr1[2] + '-' + dateAr1[1] + '-' + dateAr1[0];
                    }
                    // tgltugasval=obj[0]["tanggal_tugas"];
                    tgltugasval=dateconvert1;
                if(obj[0]["due_date"]){
                    var dateAr2 = obj[0]["due_date"].split('-');
                    var dateconvert2 = dateAr2[2] + '-' + dateAr2[1] + '-' + dateAr2[0];
                    }
                    // tgldueval=obj[0]["due_date"];
                    tgldueval=dateconvert2;
                if(obj[0]["tanggalPenyelesaian"]){
                    var dateAr3 = obj[0]["tanggalPenyelesaian"].split('-');
                    var dateconvert3 = dateAr3[2] + '-' + dateAr3[1] + '-' + dateAr3[0];
                    }else{

                        dateconvert3="";
                    }
                    tglselesaival1=obj[0]["tanggalPenyelesaian"];
                console.log(dateconvert);
                jmlData = obj.length;
                console.log(jmlData);
                idbaris=obj[0][0];
                tglcreatedat=obj[0]["created_at"];
                var from1 = tglcreatedat.split(' ')[0];
                console.log(from1);
                var from2 = from1.split('-');
                tglcreatedat1 = from2[0] + '-' + from2[1] + '-' + from2[2];
                createddate=new Date(obj[0]["created_at"]);
                console.log(createddate+"ini date2");
                $("#bontxt").text(obj[0][2]);
                $("#namatxt").html(""+obj[0][3]+"");
                $("#niktxt").html(""+obj[0][4]+"");
                $("#tujuantxt").text(obj[0][5]);
                $("#biayatxt").text(obj[0]["nominal"]);
                $("#kttujuantxt").text(obj[0]["kota_tujuan"]);
                $("#ptujuantxt").text(obj[0]["perusahaan_tujuan"]);
                $("#lamatxt").text(obj[0]["perkiraan_tugas"]);
                $("#planttxt").html(obj[0]["plant"]);
                $("#tglambiltxt").text(obj[0]["ambil_uang"]);
                $("#costtxt").text(obj[0]["cost_center"]);
                $("#kepaladepttxt").text(obj[0]["kepala_dept"]);
                $("#tgltugastxt").text(dateconvert1);
                $("#tglduetxt").text(dateconvert2);
                $("#tglambiltxt").text(dateconvert);
                $("#tglselesaitxt").text(dateconvert3);
                $("#keterangantxt").text(obj[0]["keterangan"]);
                $("#statustxt").text(obj[0]["status"]);
                $("#niktxt").html(""+obj[0][4]+"");
                if($("#statustxt").text()==="Confirm" || $("#statustxt").text()==="CONFIRM" ){
                    console.log("true");
                $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon " id="editslsbtn"></i>');
                $("#edit_due").html('<i class="edit outline editbtn iconcoloredit icon " id="editduebtn"></i>');
                $("#detaildlnegeri #confirmbtn").addClass("hidden");
                $("#edit_keterangan").html('<i class="edit outline editbtn iconcoloredit icon" id="editketeranganbtn"></i>');
                }else if($("#statustxt").text()==="Close" || $("#statustxt").text()==="CLOSE"){
                    $("#edit_keterangan").html('<i class="edit outline editbtn iconcoloredit icon" id="editketeranganbtn" </i>');
                    $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon " id="editslsbtn"></i>');
                    $("#edit_due").html('<i class="edit outline editbtn iconcoloredit icon" style="display:none" id="editduebtn"></i>');
                    $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon hidden" style="display:none" id="editslsbtn"></i>');  
                }else{
                $("#detailbtnedit").removeClass("hidden");
                $("#edit_keterangan").html('<i class="edit outline editbtn iconcoloredit icon" id="editketeranganbtn"></i>');
                $("#edit_penyelesaian").html('<i class="edit outline editbtn iconcoloredit icon hidden" style="display:none" id="editslsbtn"></i>');  
                }

                setTimeout(statuswarna, 100);
                console.log("di loadlist");
               
        }
    }
    


});

}





//KLIK EDIT TANGGAL
$("#detaildlnegeri").on("click","#editslsbtn", function(){

    

    console.log("tombol tanggal");

    var tglselesaival = document.getElementById("tglselesaitxt").innerText;
    console.log(document.getElementById("tglselesaitxt").innerText);
    //store data baris
    $(".detailmodal")
                    .modal({blurring: false, closable: false})
                    .modal("show");
    datepick();

    if(tglselesaival!=""){
        $("#tbtglselesai #judultgl").text("EDIT");
        $("#tgl_selesai").val(tglselesaival);
    }
    else{
        $("#tgl_selesai").val(selesaitemp);
    }
})

//KLIK EDIT TANGGAL DUE
$("#detaildlnegeri").on("click","#editduebtn", function(){

    

    console.log("tombol tanggal due");

    // var tgldueval = document.getElementById("tglduetxt").innerText;
    console.log(document.getElementById("tglduetxt").innerText);
    //store data baris
    $(".duemodal")
        .modal({blurring: false, closable: false})
        .modal("show");

        datepick();
        console.log(tgldueval);

    if(tgldueval!=""){
        $("#tbduedate #juduldue").text("EDIT");
         $('#tanggaldue').calendar('set date', tgldueval);
    }
    else{   
        $("#tgl_selesai").val(tanggaldue);
    }
})

//KLIK SET TANGGAL
$("#tbtglselesai").on("click","#selesaibtnset", function(){
    var tanggalselesai=$('#tgl_selesai').val();
    var datearr= tanggalselesai.split('-');
    var dateconvert= datearr[2] + '-' + datearr[1] + '-' + datearr[0];

    selesaitemp=$("#tgl_selesai").val();
    console.log("tombol set");

    // var settanggalselesai=  $("#tgl_selesai").val();

    console.log(tanggalselesai);  

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/update_tglpenyelesaiandalam",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idperjalanandlnegeri :idbaris,
            tglpenyelesaian : dateconvert,
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                console.log("dataada");
                jmlData = obj.length;
                console.log(jmlData);
                Swal.fire({
                    text: 'tanggal selesai tersimpan - Status: CLOSE',
                    timer: 3500,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                })
                
                statuswarna();

                $(".detailmodal")
                    .modal({blurring: false, closable: false})
                    .modal("hide");
                loadlistpenerima();
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    }
    


});

    // if(settanggalselesai==""){
    //     Swal.fire({
    //         text: 'tanggal belum terisi',
    //         target: '#tbtglselesai',
    //         customClass: {
    //         container: 'position-absolute'
    //         },
    //         toast: true,
    //         position: 'center'
    //     })


    // }else{
    
    // $("#tglselesaitxt").text(settanggalselesai);


    // $(".detailmodal")
    //                 .modal({blurring: false
    //                 })
    //                 .modal("hide");
    // }
})

//----------------------------KLIK BACK TANGGAL
$("#tbtglselesai").on("click","#selesaibtnback", function(){

    console.log("tombol tanggal");
    //store data baris
    $(".detailmodal")
                    .modal("hide");
})


//--------------------------------KLIK EDIT KETERANGAN
$("#detaildlnegeri").on("click","#editketeranganbtn", function(){

    console.log("tombol keterabgan");

    var setketerangan=  $("#keterangantxt").text();
    console.log(setketerangan);
    //store data baris
    $(".keteranganmodal")
    .modal({blurring: false, closable: false})
    .modal("show");
    if(setketerangan!=""){
                    $("#tbketerangan #judulket").text("EDIT");
                    $("#keterangantxt1").val(setketerangan);
    }

})

//------------------------------KLIK BACK KETERANGAN
$("#tbketerangan").on("click","#selesaibtnback", function(){

    $(".keteranganmodal")
                    .modal("hide");
})

//-----------------------------------KLIK SET EDIT KETERANGAN
$("#tbketerangan").on("click","#selesaibtnset", function(){

    console.log("tombol set");

    var setketerangansave=  $("#keterangantxt1").val();

    //console.log(settanggalselesai);

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/update_keterangan",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idperjalanandlnegeri : idbaris,
            keterangan: $("#keterangantxt1").val(),
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                Swal.fire({
                    text: 'keterangan tersimpan',
                    timer: 2000,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                })
                
                loadlistpenerima();
                
                $(".keteranganmodal")
                    .modal({blurring: false})
                    .modal("hide");
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    }
    
});
    // $("#keterangantxt").text(setketerangansave);
    
})

//--------------------------------KONDISI STATUS------------------
function statuswarna(){
    console.log(cekrole);
    console.log("di status warna");
    if($("#statustxt").text()=="Close" || $("#statustxt").text()=="CLOSE"){
        
        $("#edit_status").html('<button class="ui red label" id="unsignbtn" >Unsign</button>')
        console.log($("#statustxt").text())
        $("#statustxt").css("color","red");
        $("#detailbtnedit").addClass("disabled");
    }else if($("#statustxt").text()=="Confirm" || $("#statustxt").text()=="CONFIRM"){
        if(cekrole=='user'){
            $("#detailbtnedit").addClass("disabled");      

        }
        $("#statustxt").css("color","green");
    }else{
        $("#detailbtnedit").removeClass("disabled");
        $("#edit_status").html('<button class="ui green label" id="confirmbtn" >Confirm</button>')
    }
}

$("#detaildlnegeri").on("click","#confirmbtn", function(){

    $(".duemodal")
        .modal({blurring: false, closable: false})
        .modal("show");

        datepick();


})

$("#tbduedate").on("click","#duebtnback", function(){

    $("#tgl_due").val("");
    $(".duemodal")
        .modal({blurring: false})
        .modal("hide");


})



$("#tbduedate").on("click","#duebtnset", function(){
    tanggaldue=$('#tgl_due').val();
    var datearr= tanggaldue.split('-');
        var dateconvert= datearr[2] + '-' + datearr[1] + '-' + datearr[0];
    
    

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/update_status",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { 
            idperjalanandlnegeri : idbaris,
            duedate: dateconvert,
        },
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
            }else {
                Swal.fire({
                    text: 'data CONFIRM',
                    target: '#detaildlnegeri',
                    timer: 3000,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                })
                
                loadlistpenerima();
                statuswarna();
                $(".duemodal")
        .modal({blurring: false})
        .modal("hide");
        }
    },
    error: function(){
        if(fungsilogout){

            window.location.href="./_logout.php";
        }else{
            console.log("error session")
        }
    },
    
});


})

// --------------------- FUNGSI UNSIGN ------------------------------

$("#detaildlnegeri").on("click","#unsignbtn", function(){

    Swal.fire({
        title: '<h2>Unsign data ini?</h2>',
        text: "akan mengubah Status, Tanggal Penyelesaian",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya'
        }).then((result) => {
        if (result.value) {
            //REST CALON DNPENYUSUN
            $.ajax({
            type: "POST",
            url: "../RND_BackEnd/backend_project_bonkas/update_unsigndlnegeri",
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data: {
                idperjalanan :idbaris,
                
            },
            cache: false,
            success: function (response){
                var obj = JSON.parse(response);
                if (obj.message == false){
                    Swal.fire('Error',obj.error,'error')
                }  else {
                    
                    Swal.fire({
                        text: 'data UNSIGNED',
                        timer: 3000,
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false
                    })
                    
                    loadlistpenerima();
                    statuswarna();
                }
            },
            error: function(){
                if(fungsilogout){

                    window.location.href="./_logout.php";
                }else{
                    console.log("error session")
                }
            },
            });
        }
        })

})


//-------------------------TOMBOL EDIT DATA------------------------
$("#detaildlnegeri").on("click","#detailbtnedit",function(){

    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/delete_insertnamapenerima",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: {user: userName1},
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);

            if (obj.message == false){
                Swal.fire('Error',obj.error,'error')
            }  else {
                
                $.ajax({
                    type: "POST",
                    url: "../RND_BackEnd/backend_project_bonkas/create_insertpenerimatugas",
                    headers: {
                        user: vusrnm,
                        token: vtoken,
                    },
                    data: {idperjalanandlnegeri :idbon,
                    user: userName1},
                    cache:false,
            
                    success: function (response){
                        var obj = JSON.parse(response);
                        // console.log(obj);
                        if (obj.status == false){
                            console.log("data mata uang asing kosong");
                        }  else {
                            datakedua()
                            // idrval=obj.Nominal;
                            // rawValue = idrval.replace(/[^\d\-]+/g, '');
                            // AutoNumeric.getAutoNumericElement(document.getElementById('nominal')).set(rawValue);
                            loadlistnamatemp();
                        }
                    },
                    error: function(){
                        if(fungsilogout){
        
                            window.location.href="./_logout.php";
                        }else{
                            console.log("error session")
                        }
                    },
                    
                })
            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
    
    })
    
    var costval=$("#costtxt").text();
    

    $(".editmodal")
                    .modal({blurring: false, closable: true})
                    .modal("show");
                    datepick();
                    $('#tanggaltgs').calendar('set date', tgltugasval);
                    $('#tanggaluang').calendar('set date', tgluangval);
                    var nominalval= $("#biayatxt").text();
                    console.log(nominalval);

                    var rawValue = nominalval.replace(/[^\d\-]+/g, '');
                    var costval = $("#costtxt").text();
                    
                    var costval2=costval.substr(costval.indexOf(' ')+1);
                    console.log($("#costtxt").text());
                    // const an = AutoNumeric.getAutoNumericElement('#nominal');
                    // console.log(an);

                    $('#listnama').html($("#namatxt").html());
                    $('#listnik').html($("#niktxt").html());
                    $('#tujuan').val($("#tujuantxt").text());
                    var plantval=$("#planttxt").text();
                    $("#plant").dropdown("set selected", plantval );
                    AutoNumeric.getAutoNumericElement(document.getElementById('nominal')).set(rawValue);
                    $('#searchcost').val(costval2);
                    $('#kepala_dept').val($("#kepaladepttxt").text());
                    // console.log(nominalval);
                    // $('#costcenter').val('"'+costval+'"');
                    //console.log($('#costcenter').val())
                    // $('select option:contains("'+costval+'")').prop('selected',true);
                    // $('#costcenter [value=costval]').attr('selected','true')
                    // $('#nominal').val($("#biayatxt").text());
                    $('#kota_tujuan').val($("#kttujuantxt").text());
                    $('#perusahaan_tujuan').val($("#ptujuantxt").text());
                    // $('#tgl_tugas').val(tgltugasval);
                    console.log(tglcreatedat1+"<---- ini tanggal created");
                    document.getElementById("tgl_tugas").setAttribute("min", tglcreatedat1);
                    document.getElementById("tgl_uang").setAttribute("min", tglcreatedat1);
                    $('#lama_tugas').val($("#lamatxt").text());
                    // $('#tgl_uang').val(tgluangval);

})

$('#savedalamnegeri').on('click', function() {

    console.log($("#nominal").val())

    editdatadl();


})


function editdatadl(){
    var eusername="";
    console.log($("#tujuan").val());

    var tanggaltugas=$('#tgl_tugas').val();
    if(tanggaltugas!=""){
    var datearr= tanggaltugas.split('-');
    var dateconvert= datearr[2] + '-' + datearr[1] + '-' + datearr[0];
    }else{
        dateconvert="";
    }
    var tanggaluang1=$('#tgl_uang').val();
    if(tanggaluang1!=""){
    
    var datearr1= tanggaluang1.split('-');
    var dateconvert1= datearr1[2] + '-' + datearr1[1] + '-' + datearr1[0];
    }else{

        dateconvert1="";
    }
    
    $(document).ready(function () {

            $.ajax({


                type: "POST",
                url: `${restlocbonkasdlnegeri}create_perjalanan`,
                headers: {
                    user: vusrnm,
                    token: vtoken,
                },
                data:{
                    tujuantgs: $("#tujuan").val(),
                    nominal: $("#nominal").val(),
                    costcenter: $( "#searchcost").val(),
                    kotatuj: $("#kota_tujuan").val(),
                    tgltgs: dateconvert,
                    prshntjn: $("#perusahaan_tujuan").val(),
                    lamatgs: $("#lama_tugas").val(),
                    plant:$('#plant').val(),
                    kepala_dept:$('#kepala_dept').val(),
                    ambiluang: dateconvert1,
                    idperjalanandlnegeri: idbaris,
                    user: userName1,
                    cekrole : cekrole,

                },


                success: function(response){
                    
                    var obj = JSON.parse(response);
                    console.log(obj);
                    if(obj.status==false){
                        if(obj.code=="error14"){

                            Swal.fire({
                                icon:"error",
                                title:obj.message,
                                
                                confirmButtonText: 'Ya'
                            }).then((result) => {
                                if (result.value) {
                                    $(".editmodal")
                                    .modal({blurring: false})
                                    .modal("hide");

                                    loadlistpenerima();

                                }
                            });
                        }else{
                    Swal.fire(
                        "Error",
                        obj.message,
                        "error"
                    );
                }
                }else{
                    Swal.fire(
                        'berhasil',
                        obj.message,
                        'success'
                    )
                    //loadlistpenerima();

            $('#nama_penerima').val('');
            $('#costcenter').val('');
            $('#tujuan').val('');
            $('#nominal').val('');
            $('#kota_tujuan').val('');
            $('#perusahaan_tujuan').val('');
            $('#tgl_tugas').val('');
            $('#lama_tugas').val('');
            $('#tgl_uang').val('');
            AutoNumeric.getAutoNumericElement(document.getElementById('nominal')).set(0);
            loadlistpenerima();
            $(".editmodal")
                    .modal({blurring: false})
                    .modal("hide");
                }
                },
                error: function(){
                    if(fungsilogout){
    
                        window.location.href="./_logout.php";
                    }else{
                        console.log("error session")
                    }
                },

            });

            

            

    
});    

}

//--------------------- SEARCH COST CENTER ---------------------------------

$(".ui.search.costsearch").search({
    minCharacters: 1,
    apiSettings: {
    url: "3_bonkas/_autocompletecost.php?q={query}",
    },
    fields: {
    results: "data",
    title: "id" ,
    description: "desc",
    },

});
var valuecari2;
function isisearchcost(valuecari){
    console.log("masukfungsi");
    console.log(valuecari);
valuecari2=valuecari;
    $('#searchcost').val("");
    $('#searchcost').val(valuecari);
    console.log("masukfungsi22");
}


// ------------------------DATA DROPDOWN COST CENTER-------------------------
// function dropdowncost(droptxtval){
// $('#costcenter').ready( function(){
//     var list;
//     var jmldatadrop;
//         //console.log("dropdown clicked");
//         $.ajax({
//             type: "POST",
//             url:`${restlocbonkasdlnegeri}table_costcenter`,
//             //dataType: "json",
//             success: function (response) {

//                 var obj = JSON.parse(response);
//                 //console.log(obj.data);
//                 list=obj.data;
//                 jmldatadrop=list.length;
//                 //console.log(jmldatadrop+"ini jumlah data")
//                 //console.log(list);
//                 $("#costcenter").empty();
//                 $("#costcenter").append('<option value="">ALL</option>');
//                 //console.log("masuk1");
                
//                 for(a=0;a<jmldatadrop;a++){
//                     //console.log("masuk");
//                     $("#costcenter").append('<option value="'+list[a][0]+' '+list[a][1]+'">'+list[a][0]+' '+list[a][1]+'</option>');
//                 }
//                 //console.log(jmldatadrop+"ini jumlah dataaaaa");
//         var options = document.getElementById("costcenter").options;
//         //console.log("yang dicari="+droptxtval);
//         //console.log(options);
//         //console.log(options.length+"aaaaaaaaaaaaaaaaaaaa");
//                 for (var i = 0; i < options.length; i++) {
//                     //console.log(options[i].innerText);
//                 if (options[i].innerText == droptxtval) {
//                     options[i].selected = true;
//                     break;
//                 }
//                 }
//                 }


                
//         });
        
        

//     });

//     }

    //-------------------TEKAN DOWNLOAD PDF-------------------

    $("#detailpdfbtn").on("click", function (e) {
        $.redirect(
        "./?link=dlnegeripdf",
        { iditem: idbaris },
        "POST",
        "_blank"
    );
    });


    $("#Editbtnback").on("click", function () {
        
        $(".editmodal")
                    .modal({blurring: false})
                    .modal("hide");
        console.log($("#searchcost").val())
        deletenamatemp();
        loadlistpenerima();
    });

//---------------- TOMBOL DELETE DATA DETAIL --------------------

$("#detailbtndelete").on("click", function () {
        
    Swal.fire({
        title: '<h2>Hapus Data ini?</h2>',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya'
        }).then((result) => {
        if (result.value) {
            //REST CALON DNPENYUSUN
            $.ajax({
            type: "POST",
            url: "../RND_BackEnd/backend_project_bonkas/delete_perjalanandlnegeri",
            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data: {
                idperjalanandlnegeri :idbaris,
                
            },
            cache: false,
            success: function (response){
                var obj = JSON.parse(response);
                if (obj.message == false){
                    Swal.fire('Error',obj.error,'error')
                }  else {
                    window.location.href = "./?link=dalamnegeri";
                }
            },
            error: function(){
                if(fungsilogout){

                    window.location.href="./_logout.php";
                }else{
                    console.log("error session")
                }
            },
            });
        }
        })
});

function datepick(){
    $('#tanggaldue').calendar({
            type: 'date',
            monthFirst: false,
            // minDate : d,
        formatter: {
        date: function (date, settings) {
            if (!date) return "";
            var day = date.getDate() + "";
            if (day.length < 2) {
            day = "0" + day;
            }
            var month = date.getMonth() + 1 + "";
            if (month.length < 2) {
            month = "0" + month;
            }
            var year = date.getFullYear();
            return day + "-" + month + "-" + year;
            // return year + "-" + month + "-" + day;
        }
    }
        });

        $('#tanggalselesai').calendar({
            type: 'date',
            monthFirst: false,
            // minDate : d,
            minDate : createddate,
        formatter: {
        date: function (date, settings) {
            if (!date) return "";
            var day = date.getDate() + "";
            if (day.length < 2) {
            day = "0" + day;
            }
            var month = date.getMonth() + 1 + "";
            if (month.length < 2) {
            month = "0" + month;
            }
            var year = date.getFullYear();
            return day + "-" + month + "-" + year;
            // return year + "-" + month + "-" + day;
        }
    }
        });

        $('#tanggaltgs').calendar({
            type: 'date',
            monthFirst: false,
            // minDate : createddate,
            // initialDate:new Date(tgltugasval),

            onChange: function(date){
                maxdateset= date;
                tanggalcek();
                console.log(maxdateset+"<--ini max date");
                $('#tanggaluang').calendar('set date', undefined);
                // cekdate(date);
                
                
            },
        formatter: {
        date: function (date, settings) {
            if (!date) return "";
            var day = date.getDate() + "";
            if (day.length < 2) {
            day = "0" + day;
            }
            var month = date.getMonth() + 1 + "";
            if (month.length < 2) {
            month = "0" + month;
            }
            var year = date.getFullYear();
            return day + "-" + month + "-" + year;
            // return year + "-" + month + "-" + day;
        }
    }
        });

        
    
    }


    function datepickuang(){

        $('#tanggaluang').calendar({
            type: 'date',
            monthFirst: false,
            minDate : createddate,
            maxDate : maxdateset,
            // initialDate:new Date(tgltugasval),
        formatter: {
        date: function (date, settings) {
            if (!date) return "";
            var day = date.getDate() + "";
            if (day.length < 2) {
            day = "0" + day;
            }
            var month = date.getMonth() + 1 + "";
            if (month.length < 2) {
            month = "0" + month;
            }
            var year = date.getFullYear();
            return day + "-" + month + "-" + year;
            // return year + "-" + month + "-" + day;
        }
    }
        });
    }
    // --------------------TAMPIL DATA TEMP UANG--------------------------
function loadlistnamatemp(){

    var lusername    =  getCookie('usrnm');
    $('#tb_listnama').find('tbody').empty();
    
    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/table_namapenerima",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: { user :userName1},
        cache:false,

        success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(obj.status==false) {
                console.log('Gagal load tabel, data kosong');
                
                
            }else {
                console.log("dataada");
                jmlData = obj.length;
                console.log(jmlData);
                // idrval=obj[0]["nominal"];
                // console.log(idrval+"ini nominal");
                // console.log(idrval+"idr val didalam fungsi detailbtnedit");
                for(b = 0; b < jmlData; b++){
                    if(b===0){

                    $('#tb_listnama').find('tbody').append(
                        "<tr id='"+b+"'><td>"+obj[b]["nama_penerima"]+
                        "</td><td class='center' width='400px'>"+obj[b]["nik_penerima"]+
                        "</td><td class='center'></td></tr>");
                        
                    }
                
                else{
                $('#tb_listnama').find('tbody').append(
                "<tr id='"+b+"'><td>"+obj[b]["nama_penerima"]+
                "</td><td class='center' width='400px'>"+obj[b]["nik_penerima"]+
                "</td><td class='center'><i class='trash deletepenerima iconcoloredit icon' nmpenerima='"+obj[b]["nama_penerima"]+"' delid='"+obj[b]["id_namapenerima"]+"' delnik='"+obj[b]["nik_penerima"]+"'></i></td></tr>");
                }

                

                $('.deletepenerima').on('click',function(e){
                    var dnama= $(this).attr('nmpenerima');
                    var idnamapenerima1 = $(this).attr('delid');
                    var dnik= $(this).attr('delnik');
                Swal.fire({
                    title: '<h2>Hapus data ini?</h2>',
                    text: "DATA: "+dnik+" - "+dnama,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya'
                    }).then((result) => {
                    if (result.value) {
                        //REST CALON DNPENYUSUN
                        $.ajax({
                        type: "POST",
                        url: "../RND_BackEnd/backend_project_bonkas/delete_namapenerima",
                        headers: {
                            user: vusrnm,
                            token: vtoken,
                        },
                        data: {
                            idnamapenerima : idnamapenerima1,
                            
                        },
                        cache: false,
                        success: function (response){
                            var obj = JSON.parse(response);
                            if (obj.code == 'error9'){
                            Swal.fire('Error','Ada kendal di koneksi/database, data tidak tersimpan !','error')
                            } else if (obj.code == 'error10'){
                            Swal.fire('Error','Item yang dimaksud tidak ada !','error')
                            }  else {
                            loadlistnamatemp();
                            }
                        },
                        error: function(){
                            if(fungsilogout){
            
                                window.location.href="./_logout.php";
                            }else{
                                console.log("error session")
                            }
                        }
                        });
                    }
                    })
                
                
                });
            }

        }
    }
    


});


}

function deletenamatemp(){
    $.ajax({
        type: "POST",
        url: "../RND_BackEnd/backend_project_bonkas/delete_insertnamapenerima",
        headers: {
            user: vusrnm,
            token: vtoken,
        },
        data: {user: userName1},
        cache:false,
    
    })
}

//--------------- FUNGSI CLEAR DATA KETIKA MENEKAN TOMBOL BACK BROWSER
jQuery(document).ready(function($) {
    const url = new URL(window.location);
    if (window.history && window.history.pushState) {
        console.log(window.history);
      window.history.pushState({}, null, url);
  
      $(window).on('popstate', function() {
        deletenamatemp();
        history.back();
      });
  
    }
  });

  $('.ui.search.kepaladept')
        .search({
            apiSettings: {
                url: '3_aktiva/_autocompletenik.php?q={query}'
            },
            fields: {
                results: 'data',
                title: 'name',
                description: 'nik'
            },
            minCharacters: 1,
            onSelect: function (response) {
                $('#kepala_dept').val(response.name);
            },
        });


  function datakedua(){
        
    document.getElementById("nama_penerima").value ="";
    var query="";
    console.log("di kedua")
    console.log(query +"dua");

    $('#namaauto').search({
    minCharacters : 1,
    apiSettings   : {
        url: '3_invoice/_autocompletenama.php?q={query}'
    },
    fields: {
        results : 'data',
        title   : 'name',
        description : 'nik'
    },
    onSelect: function(result, response) {
        nikval =result.nik;
        namaval = result.name;
        listpenyusun();
        
    }       
    });
    

}

//-----------------------------SAVE DATA NAMA KE TEMP---------------------------

function listpenyusun(){
        
    console.log("sebelum="+namaval);
    $(document).ready(function () {
    var lnamaval=namaval;
    var lnikval=nikval;
    var lusernames = getCookie('usrnm');

        $.ajax({
            type: "POST",
            url: "../RND_BackEnd/backend_project_bonkas/create_namapenerima",

            headers: {
                user: vusrnm,
                token: vtoken,
            },
            data:{
                snama  : lnamaval,
                snik : lnikval,
                user   : userName1,
            },
                success: function (response){
            var obj = JSON.parse(response);
            console.log(obj);
            if(isEmpty(obj)) {
            console.log('Gagal save, data kosong');
            
            
            } else if(obj) {
            if (obj.status == false){
                Swal.fire('Error',obj.message,'error')
            }  else if (obj.code == 'error11'){
                Swal.fire('Error','data kosong','error')
            }  else {
                Swal.fire({
                text: 'Item berhasil ditambahkan',
                timer: 1000,
                position: 'top-right',
                toast: true,
                showConfirmButton: false
                })
                loadlistnamatemp();
                namaval="";
                nikval="";
                console.log("sesudah="+namaval);
                $('#nama_penerima').val('');
            }
            
            } else {
            Swal.fire('Error','','error')
            }
        },
        error: function(){
            if(fungsilogout){

                window.location.href="./_logout.php";
            }else{
                console.log("error session")
            }
        }
        });
        
    });
    
}

//-------------- CEK KONDISI TANGGAL APAKAH TANGGAL TUGAS SUDAH DIISI ATAU BELUM -----------------//

function tanggalcek(){

    

    if (maxdateset=="" || maxdateset==undefined){

        $("#tgl_uang").prop("disabled",true);
        document.getElementById("tgl_uang").placeholder = "input tgl tugas terlebih dahulu";
    }else{
        $("#tgl_uang").prop("disabled",false);
        document.getElementById("tgl_uang").placeholder = "date";
    }
    datepickuang();
}


//---------- FUNGSI COPY TEXT TO CLIPBOARD -------------

// function copytxt() {
//     /* Get the text field */
//     var copyText = $("#tujuantxt").val();
  
//     /* Select the text field */
//     // copyText.select();
//     copyText.setSelectionRange(0, 99999); /* For mobile devices */
  
//     /* Copy the text inside the text field */
//     document.execCommand("copy");
  
//     /* Alert the copied text */
//     alert("Copied the text: " + copyText.value);
//   }

function copytxt(element) {
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val($(element).text()).select();
    document.execCommand("copy");
    $temp.remove();
  }
  

  $('.iconclose').on('click', function() {


    $(".editmodal")
                    .modal({blurring: false})
                    .modal("hide");
        console.log($("#searchcost").val())
        deletenamatemp();
        loadlistpenerima();

})