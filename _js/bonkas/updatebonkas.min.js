$(".ui.dropdown").dropdown();
$(".menu .item").tab();

// Global Variable
const NonceValue = "rdsystem2020";
var vusrnm = getCookie("usrnm");
var vtoken = getCookie("token");
var restlocbonkas = decodeURIComponent(getCookie("restlocbonkas"));

$('span.number').number(true, 2,',', '.');

function countPlaces(num) {
  var text = num.toString();
  var index = text.indexOf(".");
  return index == -1 ? 0 : (text.length - index - 1);
} 

function BonkasHeaderFunc() {
  $.ajax({
    type: "GET",
    url     : `${restlocbonkas}bonkas_main/`+IdBon,
    headers: {
      user  : vusrnm,
      token : vtoken
    },
    cache: false,
    success: function (response){
      var obj = JSON.parse(JSON.parse(response));
      if (obj.code == 'error1'){
        Swal.fire('Error','Ada kendala di koneksi/database, data tidak terhapus !','error')
      }  else {
        var data = obj.message;
        var sdt = data.tgl_tugas.split("-");
        var newtgltugas = sdt[2]+"/"+sdt[1]+"/"+sdt[0];
        var sdk = data.tgl_bon_kas.split("-");
        var newtglbon = sdk[2]+"/"+sdk[1]+"/"+sdk[0];
        var sdd = data.due_date.split("-");
        var newduedate = sdd[2]+"/"+sdd[1]+"/"+sdd[0];
        $('#nomor_surat_tugas').val(data.no_surat_tugas);
        $('#nik').val(data.nik);
        $('#nama').val(data.nama);
        $('#bagian').val(data.bagian);
        $('#bagian').dropdown('set selected', data.bagian);
        $('.ui.bagian').addClass("disabled");
        $('#rekening').val(data.rekening);
        $('#tgl_tugas').val(newtgltugas);
        $('#lama_tugas').val(data.lama_tugas);
        $('#tgl_bon_kas').val(newtglbon);
        $('#due_date').val(newduedate);
        // $('#due_date').val(moment(data.due_date).format('DD/MM/YYYY'));
        $('#bayar_kepada').val(data.bayar_kpd);
        $('#keperluan').val(data.keperluan);
        $('#keterangan').val(data.keterangan.replace(/\\n/g, '\n'));
        $('#disetujui').val(data.disetujui);
        
        $('#tgl_tugas').on('blur', function() {
          if ($('#tgl_tugas').val() ==""){
            $('#tgl_tugas').val(newtgltugas);
          }
        });

        $('#tgl_bon_kas').on('blur', function() {
          if ($('#tgl_bon_kas').val() ==""){
            $('#tgl_bon_kas').val(newtglbon);
          }
        });

        $('#due_date').on('blur', function() {
          if ($('#due_date').val() ==""){
            $('#due_date').val(newduedate);
          }
        });

        // $('#due_date').on('focus', function() {
        //   // if ($('#due_date').val() ==""){
        //     $('#due_date').val(moment(data.due_date).format('YYYY-MM-DD'));
        //   // }
        // });

      }
    },
    error: function(){
      //window.location.href = "./?link=loclogout";
      console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
    }
  });
}

function BonkasItemFunc() {
  $('#BonkasItem').DataTable({
    dom : "<'ui stackable grid'"+
          "<'row'"+
          "<'left aligned ten wide column'>"+
          ">"+
          "<'row dt-table'"+
          "<'sixteen wide column'tr>"+
          ">"+
          "<'row'"+
          "<'left aligned eight wide column'B>"+
          "<'right aligned eight wide column'>"+
          ">"+
          ">",
    buttons: [
      {
        text: '10',
        action: function ( e, dt, node, config ) {
          $('#BonkasItem').DataTable().page.len( 10 ).draw();
        }
      },
      {
        text: '25',
        action: function ( e, dt, node, config ) {
          $('#BonkasItem').DataTable().page.len( 25 ).draw();
        }
      },
      {
        text: '50',
        action: function ( e, dt, node, config ) {
          $('#BonkasItem').DataTable().page.len( 50 ).draw();

        }
      },
      {
        text: '100',
        action: function ( e, dt, node, config ) {
          $('#BonkasItem').DataTable().page.len( 100 ).draw();

        }
      }
    ],
    destroy     : true,
    stateSave   : true,
    processing  : true,
    deferRender : true,
    serverSide  : true,
    orderClasses: false,
    pageLength  : 10,
    data        : [],
    language: {
      sLengthMenu: "_MENU_",
      search: "",
      searchPlaceholder: "Search..",
      processing: '<i class="circle notch loading icon huge"></i>',
    },
    columns     : [
      { data    : 0 },
      { data    : 1 },
      { data    : 2 },
      //  render: $.fn.dataTable.render.number( '.', ',', 2 ) },  //coba solusi add class
      //{ data    : 3 },
      { data    : null, 
        render: function(data, type, row) {
          if(data[4]){
            var cdp = countPlaces(data[3]);
            if (cdp == 2){
              return $.number( data[3], 2, ',', '.' );
            }
            if (cdp == 1){
              return $.number( data[3], 1, ',', '.' );
            }
            if (cdp == 0){
              return $.number( data[3], 0, ',', '.' );
            }
          } else {
            return '';
          }
        }
      },
      { data    : null, render: function(data, type, row) {
        if(data[4]){
          return data[4].toUpperCase();
        } else {
          return '';
        }
      }},
      { data    : null, render    : function(data, type, row) { 
          if (data[0]!=""){
            return '<i class="edit outline iconcoloredit icon actedit" title="edit" eid="'+data[5]+'"></i>';
          } else {
            return ''; 
          }
        }
      },
      { data    : null, render    : function(data, type, row) { 
        if (data[0]!=""){
          return '<i class="trash alternate outline icon iconcoloredit actdelete" title="delete" eid="'+data[5]+'" eno="'+data[1]+'"></i>';
        } else {
          return ''; 
        }
      }
    } 
    ],
    // createdRow: function (row, data, index) {
    //   // if (data[2] == "DATA TIDAK DITEMUKAN") {
    //     $('td', row).eq(3).addClass("number");
    //   // }

    // },
    "ajax"        : {
      url     : `${restlocbonkas}table_bonkas_item`,
      type    : 'POST',
      headers : {
        user  : vusrnm,
        token : vtoken
      },
      data    : {
        main_id: IdBon
      }
    },

  });

  var table = $('#BonkasItem').DataTable();
  $('#BonkasItem').DataTable().ajax.reload();

  //HANDLER UNTUK KLIK ICON EDIT
  $("#BonkasItem").on("click", ".actedit", function(){
    $(".windowadditem").modal('show');
    $('#id_item').val($(this).attr('eid'));
    $.ajax({
        type: "GET",
        url     : `${restlocbonkas}bonkas_detail/`+$(this).attr('eid'),
        headers: {
          user  : vusrnm,
          token : vtoken
        },
        cache: false,
        success: function (response){
          var obj = JSON.parse(JSON.parse(response));
          if (obj.code == 'error1'){
            Swal.fire('Error','Ada kendala di koneksi/database, data tidak terhapus !','error')
          }  else {
            var data = obj.message;
            $('#bonkas_row').show();
            $('#no_bonkas').val(data.no_bon_kas);
            $('#no_bonkas').prop('disabled', true);
            $('#currency').dropdown('set selected', data.currency);
            $('.dropdown').dropdown();
            $('.ui.currency').addClass("disabled");
            $('#nominal').val(data.nominal);
            $('#nominal').focus();
            $('#terbilang').val(data.terbilang.toUpperCase());
          }
        },
        error: function(){
          //window.location.href = "./?link=loclogout";
          console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
        }
      });
  });

  //HANDLER UNTUK KLIK ICON DELETE
  $("#BonkasItem").on("click", ".actdelete", function(){
    var eid = $(this).attr('eid');
    var vusrnm  = getCookie('usrnm');
    var vtoken  = getCookie('token');
    var nomor = $(this).attr('eno');
    var msg = 'Apakah anda yakin akan menghapus Bonkas item dengan nomor\n' + nomor;
    if(confirm(msg)) {
      $.ajax({
        type: "DELETE",
        url     : `${restlocbonkas}bonkas_detail/`+$(this).attr('eid'),
        headers: {
          user  : vusrnm,
          token : vtoken
        },
        cache: false,
        success: function (response){
          var obj = JSON.parse(JSON.parse(response));
          if (obj.code == 'error1'){
            Swal.fire('Error','Ada kendala di koneksi/database, data tidak terhapus !','error')
          }  else {
            Swal.fire({
              title: 'Berhasil',
              text: 'Bonkas Item berhasil dihapus.',
              timer: 1500,
              position: 'top-end',
              icon: 'success',
              showConfirmButton: false
            })
            $('.windowadditem').modal('hide');
            $('#BonkasItem').DataTable().ajax.reload();
          }
        },
        error: function(){
          //window.location.href = "./?link=loclogout";
          console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
        }
      });
    }
  });
}

function terbilangDesimal(num) {
  var numStr, roundNbr, decimals, tblgRound, tblgDec, tblg;
  numStr = num.toString().split(".");
  roundNbr = numStr[0];
  tblgRound = terbilang(roundNbr);
  tblg = tblgRound + ' ';
  tblgDec = '';
  if(numStr.length > 1) {
    ratio = numStr[1].split("");
    $.each(ratio, function(idx, el) {
      tblgDec += terbilang(el) + ' ';
    })
    tblg = tblgRound + ' Koma ' + tblgDec;
  }
  return tblg.toUpperCase();
}

$(document).ready(function() {

  $('.ui.dropdown').dropdown();
  $('.menu .item').tab();
  
  BonkasHeaderFunc();
  BonkasItemFunc();

  //SET TOKEN ARTEMIS
  $.ajax({
    type: "GET",
    url: "3_bonkas/_artemis.php",
    cache: false,
    success: function (response){
      setCookie('atoken', response, 1/24);
    },
    error: function(){
      Swal.fire({
        text : `Server tidak merespon, segera hubungi Administrator di ext. 3553 !`
      })
    }
  });

  $('#date1').calendar({
    type: 'date',
    monthFirst: false,
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return day + "/" + month + "/" + year;
        // return year + "-" + month + "-" + day;
      }
    }
  });

  $('#date2').calendar({
    type: 'date',
    monthFirst: false,
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return day + "/" + month + "/" + year;
        // return year + "-" + month + "-" + day;
      }
    }
  });

  $('#date3').calendar({
    type: 'date',
    monthFirst: false,
    formatter: {
      date: function (date, settings) {
        if (!date) return "";
        var day = date.getDate() + "";
        if (day.length < 2) {
          day = "0" + day;
        }
        var month = date.getMonth() + 1 + "";
        if (month.length < 2) {
          month = "0" + month;
        }
        var year = date.getFullYear();
        return day + "/" + month + "/" + year;
        // return year + "-" + month + "-" + day;
      }
    }
  });

  // $('#togleheader').on('click', function() {
  //   $('.Header2').transition({
  //     animation  : 'slide right',
  //     onComplete : function() {
  //       $('.Header1').toggle(400);
  //     }
  //   })
  // });

  $('#tabbonkas').on('click', function() {
    window.location.href = "./?link=bonkas";
  });

  $('#HeaderButtonBack').on('click', function() {
    window.location.href = "./?link=bonkas";
  });

  $('#bonkasadditem').on('click', function() {
    $(".windowadditem").modal('show');
    $('#bonkas_row').hide();
    $('.ui.currency').removeClass("disabled");
    $('#currency').dropdown('clear'); 
    $('#nominal').val('');
    $('#terbilang').val('');

    
  });

  $('.actedit').on('click', function() {
    $(".windowedititem").modal('show');

   
    
  });

  $('#nominal').on('focus click', function() {
    $(this)[0].setSelectionRange(0, 0);
  })

  $("#AddItemButtonSave").click(function() {
    var vusrnm  = getCookie('usrnm');
    var vtoken  = getCookie('token');
    $.ajax({
      type: "POST",
      url     : `${restlocbonkas}create_bonkas_detail`,
      headers: {
        user  : vusrnm,
        token : vtoken
      },
        data: {
          'bagian': $('#bagian').val(),
          'id': $('#id_item').val(),
          'main_id': IdBon,
          'no_bon_kas': $('#no_bonkas').val(),
          'curr': $('#currency').val(),
          'nominal': $('#nominal').val(),
          'terbilang': $('#terbilang').val(),
          'tgl_buat': '<?= date("Y-m-d H:i:s") ?>', 
          'dibuat_oleh': vusrnm
        },
      cache: false,
      success: function (response){
        var obj = JSON.parse(JSON.parse(response));
        if(isEmpty(obj)) {
          console.log('Gagal save Bonkas item, data kosong');
        } else if(obj) {
          if (obj.code == 'error1'){
            Swal.fire('Error','Ada kendala di koneksi/database, data tidak tersimpan !','error')
          }  else {
            Swal.fire({
              title: 'Berhasil',
              text: 'Bonkas Item berhasil disimpan.',
              timer: 1500,
              position: 'top-end',
              icon: 'success',
              showConfirmButton: false
            })
            $('.windowadditem').modal('hide');
            $('#BonkasItem').DataTable().ajax.reload();
          }
        } else {
          Swal.fire('Error','Bonkas Error ?.','error')
        }
      },
      error: function(){
        //window.location.href = "./?link=loclogout";
        console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
      }
    });
  });

  $('#AddItemButtonBack').click(function() {
    $('.windowadditem').modal('hide');
  });

  $("#HeaderButtonEdit").click(function() {
    var vusrnm  = getCookie('usrnm');
    var vtoken  = getCookie('token');
    $.ajax({
      type: "POST",
      url     : `${restlocbonkas}create_bonkas_main`,
      headers: {
        user  : vusrnm,
        token : vtoken
      },
      data: {
        id: IdBon,
        no_surat_tugas: $('#nomor_surat_tugas').val(),
        nik: $('#nik').val(),
        nama: $('#nama').val(),
        rekening: $('#rekening').val(),
        tgl_tugas: $('#tgl_tugas').val(),
        lama_tugas: $('#lama_tugas').val(),
        tgl_bon_kas: $('#tgl_bon_kas').val(),
        due_date: $('#due_date').val(),
        bayar_kpd: $('#bayar_kepada').val(),
        keperluan: $('#keperluan').val(),
        keterangan: $('#keterangan').val(),
        disetujui: $('#disetujui').val()
      },
      cache: false,
      success: function (response){
        var obj = JSON.parse(JSON.parse(response));
        if(isEmpty(obj)) {
          console.log('Gagal save Bonkas item, data kosong');
        } else if(obj) {
          if (obj.code == 'error1'){
            Swal.fire('Error','Ada kendala di koneksi/database, data tidak tersimpan !','error')
          }  else {
            Swal.fire({
              title: 'Berhasil',
              text: 'Bonkas Header berhasil diupdate.',
              timer: 1500,
              icon: 'success',
              showConfirmButton: false
            });
          }
        } else {
          Swal.fire('Error','Bonkas Error ?.','error');
        }
      },
      error: function(){
        //window.location.href = "./?link=loclogout";
        console.log('Server tidak merespon, segera hubungi Administrator di ext. 3553 !');
      }
    });
  });

  //nik autocomplete
  $("#nik").focus(function() {
    $('#nik_autocomplete').search({
      minCharacters : 1,
      apiSettings   : {
        url: '3_bonkas/_autocompletenik.php?q={query}'
      },
      fields: {
        results : 'data',
        title   : 'nik',
        description : 'name'
      },
      onSelect: function(result, response) {
        $('#nama').val(result.name);
      }
    });
  });

  //nama autocomplete
  $("#nama").focus(function() {
    $('#nama_autocomplete').search({
      minCharacters : 1,
      apiSettings   : {
        url: '3_bonkas/_autocompletenama.php?q={query}'
      },
      fields: {
        results : 'data',
        title   : 'name',
        description : 'nik'
      },
      onSelect: function(result, response) {
        $('#nik').val(result.nik);
      }
    });
  });

  $('#nominal').number(true, 2,',', '.');
  $('#nominal').change(function () { 
    if($('#nominal').val() == "") {
      return;
    }
   // var nominal = angkaTerbilang($('#nominal').val(), {decimal: ','});
    var nominal = angkaTerbilang($('#nominal').val());
    $('#terbilang').val(nominal.toUpperCase() +" "+$('#currency').val());
  });
})




























